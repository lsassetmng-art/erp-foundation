name: erp-foundation-ci

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  validate-and-generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Extract usecases
        run: |
          python tools/extract_usecases.py

      - name: Normalize with AI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python tools/normalize_with_ai.py

      - name: Attach schema with AI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python tools/attach_schema_with_ai.py

      - name: Generate usecases & DTOs
        run: |
          python tools/generate_usecases.py

      - name: Generate RPC tests
        run: |
          python tools/generate_rpc_tests.py

      - name: Generate schema validators
        run: |
          python tools/generate_rpc_validators.py

      - name: Generate negative tests
        run: |
          python tools/generate_rpc_negative_tests.py

      - name: Guard: company_id must not exist
        run: |
          if grep -R "company_id" app/src/main/java; then
            echo "ERROR: company_id detected"
            exit 1
          fi

      - name: Compile check (javac)
        run: |
          find app/src/main/java -name "*.java" > sources.txt
          javac @sources.txt
