--
-- PostgreSQL database dump
--

\restrict kg7gFL8fqjD6iWc31bE432m8smepZCsHb6HRL8ZVmdyvFcDaMlZcNoXF6yM7wxI



DROP EVENT TRIGGER IF EXISTS pgrst_drop_watch;
DROP EVENT TRIGGER IF EXISTS pgrst_ddl_watch;
DROP EVENT TRIGGER IF EXISTS issue_pg_net_access;
DROP EVENT TRIGGER IF EXISTS issue_pg_graphql_access;
DROP EVENT TRIGGER IF EXISTS issue_pg_cron_access;
DROP EVENT TRIGGER IF EXISTS issue_graphql_placeholder;
DROP PUBLICATION IF EXISTS supabase_realtime;
DROP POLICY IF EXISTS p_operation_log_owner ON system.operation_log;
DROP POLICY IF EXISTS p_loop_config_owner ON system.loop_config;
DROP POLICY IF EXISTS p_loop_config_open ON system.loop_config;
DROP POLICY IF EXISTS p_killswitch_read ON system.runtime_killswitch;
DROP POLICY IF EXISTS p_exec_run_request_owner ON system.exec_run_request;
DROP POLICY IF EXISTS p_exec_command_owner ON system.exec_command;
DROP POLICY IF EXISTS p_db_session_owner ON system.db_session;
DROP POLICY IF EXISTS p_ai_task_owner ON system.ai_task;
DROP POLICY IF EXISTS p_ai_signal_all ON system.ai_signal;
DROP POLICY IF EXISTS p_shipping_revision_company ON sales.shipping_revision;
DROP POLICY IF EXISTS p_sales_shipping_header_company_rls ON sales.shipping_header;
DROP POLICY IF EXISTS p_sales_shipping_header_company ON sales.shipping_header;
DROP POLICY IF EXISTS p_sales_sales_quotation_company_rls ON sales.sales_quotation;
DROP POLICY IF EXISTS p_sales_sales_quotation_company ON sales.sales_quotation;
DROP POLICY IF EXISTS p_sales_return_header_company_rls ON sales.return_header;
DROP POLICY IF EXISTS p_sales_return_header_company ON sales.return_header;
DROP POLICY IF EXISTS p_sales_order_header_company_rls ON sales.order_header;
DROP POLICY IF EXISTS p_sales_order_header_company ON sales.order_header;
DROP POLICY IF EXISTS p_sales_item_price_master_company_rls ON sales.item_price_master;
DROP POLICY IF EXISTS p_sales_item_price_master_company ON sales.item_price_master;
DROP POLICY IF EXISTS p_sales_item_company_rls ON sales.item;
DROP POLICY IF EXISTS p_sales_item_company ON sales.item;
DROP POLICY IF EXISTS p_sales_item_category_company_rls ON sales.item_category;
DROP POLICY IF EXISTS p_sales_item_category_company ON sales.item_category;
DROP POLICY IF EXISTS p_sales_invoice_pdf_company_rls ON sales.invoice_pdf;
DROP POLICY IF EXISTS p_sales_invoice_pdf_company ON sales.invoice_pdf;
DROP POLICY IF EXISTS p_sales_customer_company_rls ON sales.customer;
DROP POLICY IF EXISTS p_sales_customer_company ON sales.customer;
DROP POLICY IF EXISTS p_sales_billing_header_company_rls ON sales.billing_header;
DROP POLICY IF EXISTS p_sales_billing_header_company ON sales.billing_header;
DROP POLICY IF EXISTS p_quotation_order_link_company ON sales.quotation_order_link;
DROP POLICY IF EXISTS p_admin_bypass ON sales.shipping_header;
DROP POLICY IF EXISTS p_admin_bypass ON sales.sales_quotation;
DROP POLICY IF EXISTS p_admin_bypass ON sales.return_header;
DROP POLICY IF EXISTS p_admin_bypass ON sales.order_header;
DROP POLICY IF EXISTS p_admin_bypass ON sales.item_price_master;
DROP POLICY IF EXISTS p_admin_bypass ON sales.item_category;
DROP POLICY IF EXISTS p_admin_bypass ON sales.item;
DROP POLICY IF EXISTS p_admin_bypass ON sales.invoice_pdf;
DROP POLICY IF EXISTS p_admin_bypass ON sales.customer;
DROP POLICY IF EXISTS p_admin_bypass ON sales.billing_header;
DROP POLICY IF EXISTS p_purchase_supplier_master_company_rls ON purchase.supplier_master;
DROP POLICY IF EXISTS p_purchase_supplier_master_company ON purchase.supplier_master;
DROP POLICY IF EXISTS p_purchase_supplier_item_price_company_rls ON purchase.supplier_item_price;
DROP POLICY IF EXISTS p_purchase_supplier_item_price_company ON purchase.supplier_item_price;
DROP POLICY IF EXISTS p_purchase_purchase_three_way_match_company_rls ON purchase.purchase_three_way_match;
DROP POLICY IF EXISTS p_purchase_purchase_three_way_match_company ON purchase.purchase_three_way_match;
DROP POLICY IF EXISTS p_purchase_purchase_requisition_company_rls ON purchase.purchase_requisition;
DROP POLICY IF EXISTS p_purchase_purchase_requisition_company ON purchase.purchase_requisition;
DROP POLICY IF EXISTS p_purchase_purchase_receipt_company_rls ON purchase.purchase_receipt;
DROP POLICY IF EXISTS p_purchase_purchase_receipt_company ON purchase.purchase_receipt;
DROP POLICY IF EXISTS p_purchase_purchase_quotation_company_rls ON purchase.purchase_quotation;
DROP POLICY IF EXISTS p_purchase_purchase_quotation_company ON purchase.purchase_quotation;
DROP POLICY IF EXISTS p_purchase_purchase_order_header_company_rls ON purchase.purchase_order_header;
DROP POLICY IF EXISTS p_purchase_purchase_order_header_company ON purchase.purchase_order_header;
DROP POLICY IF EXISTS p_purchase_purchase_invoice_company_rls ON purchase.purchase_invoice;
DROP POLICY IF EXISTS p_purchase_purchase_invoice_company ON purchase.purchase_invoice;
DROP POLICY IF EXISTS p_admin_bypass ON purchase.supplier_master;
DROP POLICY IF EXISTS p_admin_bypass ON purchase.supplier_item_price;
DROP POLICY IF EXISTS p_admin_bypass ON purchase.purchase_three_way_match;
DROP POLICY IF EXISTS p_admin_bypass ON purchase.purchase_requisition;
DROP POLICY IF EXISTS p_admin_bypass ON purchase.purchase_receipt;
DROP POLICY IF EXISTS p_admin_bypass ON purchase.purchase_quotation;
DROP POLICY IF EXISTS p_admin_bypass ON purchase.purchase_order_header;
DROP POLICY IF EXISTS p_admin_bypass ON purchase.purchase_invoice;
DROP POLICY IF EXISTS p_ops_send_history_user ON ops.document_send_history;
DROP POLICY IF EXISTS p_ops_notification_owner ON ops.notification_outbox;
DROP POLICY IF EXISTS p_ops_job_result_owner ON ops.ops_job_result;
DROP POLICY IF EXISTS p_ops_job_queue_owner ON ops.ops_job_queue;
DROP POLICY IF EXISTS p_ops_document_file_user ON ops.document_file;
DROP POLICY IF EXISTS p_media_asset_owner ON media.asset;
DROP POLICY IF EXISTS p_media_asset_link_owner ON media.asset_link;
DROP POLICY IF EXISTS p_manufacturing_yield_metric_company_rls ON manufacturing.yield_metric;
DROP POLICY IF EXISTS p_manufacturing_yield_metric_company ON manufacturing.yield_metric;
DROP POLICY IF EXISTS p_manufacturing_work_order_company_rls ON manufacturing.work_order;
DROP POLICY IF EXISTS p_manufacturing_work_order_company ON manufacturing.work_order;
DROP POLICY IF EXISTS p_manufacturing_routing_header_company_rls ON manufacturing.routing_header;
DROP POLICY IF EXISTS p_manufacturing_routing_header_company ON manufacturing.routing_header;
DROP POLICY IF EXISTS p_manufacturing_process_master_company_rls ON manufacturing.process_master;
DROP POLICY IF EXISTS p_manufacturing_process_master_company ON manufacturing.process_master;
DROP POLICY IF EXISTS p_manufacturing_mrp_run_company_rls ON manufacturing.mrp_run;
DROP POLICY IF EXISTS p_manufacturing_mrp_run_company ON manufacturing.mrp_run;
DROP POLICY IF EXISTS p_manufacturing_mps_run_company_rls ON manufacturing.mps_run;
DROP POLICY IF EXISTS p_manufacturing_mps_run_company ON manufacturing.mps_run;
DROP POLICY IF EXISTS p_manufacturing_manufacturing_execution_company_rls ON manufacturing.manufacturing_execution;
DROP POLICY IF EXISTS p_manufacturing_manufacturing_execution_company ON manufacturing.manufacturing_execution;
DROP POLICY IF EXISTS p_manufacturing_manufacturing_cost_snapshot_company_rls ON manufacturing.manufacturing_cost_snapshot;
DROP POLICY IF EXISTS p_manufacturing_manufacturing_cost_snapshot_company ON manufacturing.manufacturing_cost_snapshot;
DROP POLICY IF EXISTS p_manufacturing_bom_header_company_rls ON manufacturing.bom_header;
DROP POLICY IF EXISTS p_manufacturing_bom_header_company ON manufacturing.bom_header;
DROP POLICY IF EXISTS p_admin_bypass ON manufacturing.yield_metric;
DROP POLICY IF EXISTS p_admin_bypass ON manufacturing.work_order;
DROP POLICY IF EXISTS p_admin_bypass ON manufacturing.routing_header;
DROP POLICY IF EXISTS p_admin_bypass ON manufacturing.process_master;
DROP POLICY IF EXISTS p_admin_bypass ON manufacturing.mrp_run;
DROP POLICY IF EXISTS p_admin_bypass ON manufacturing.mps_run;
DROP POLICY IF EXISTS p_admin_bypass ON manufacturing.manufacturing_execution;
DROP POLICY IF EXISTS p_admin_bypass ON manufacturing.manufacturing_cost_snapshot;
DROP POLICY IF EXISTS p_admin_bypass ON manufacturing.bom_header;
DROP POLICY IF EXISTS p_inventory_warehouse_company_rls ON inventory.warehouse;
DROP POLICY IF EXISTS p_inventory_warehouse_company ON inventory.warehouse;
DROP POLICY IF EXISTS p_inventory_storage_location_company_rls ON inventory.storage_location;
DROP POLICY IF EXISTS p_inventory_storage_location_company ON inventory.storage_location;
DROP POLICY IF EXISTS p_inventory_stocktaking_result_company_rls ON inventory.stocktaking_result;
DROP POLICY IF EXISTS p_inventory_stocktaking_result_company ON inventory.stocktaking_result;
DROP POLICY IF EXISTS p_inventory_stocktaking_plan_company_rls ON inventory.stocktaking_plan;
DROP POLICY IF EXISTS p_inventory_stocktaking_plan_company ON inventory.stocktaking_plan;
DROP POLICY IF EXISTS p_inventory_stock_transfer_header_company_rls ON inventory.stock_transfer_header;
DROP POLICY IF EXISTS p_inventory_stock_transfer_header_company ON inventory.stock_transfer_header;
DROP POLICY IF EXISTS p_inventory_stock_transaction_company_rls ON inventory.stock_transaction;
DROP POLICY IF EXISTS p_inventory_stock_transaction_company ON inventory.stock_transaction;
DROP POLICY IF EXISTS p_inventory_stock_reservation_company_rls ON inventory.stock_reservation;
DROP POLICY IF EXISTS p_inventory_stock_reservation_company ON inventory.stock_reservation;
DROP POLICY IF EXISTS p_inventory_stock_lot_company_rls ON inventory.stock_lot;
DROP POLICY IF EXISTS p_inventory_stock_lot_company ON inventory.stock_lot;
DROP POLICY IF EXISTS p_inventory_stock_lot_balance_company_rls ON inventory.stock_lot_balance;
DROP POLICY IF EXISTS p_inventory_stock_lot_balance_company ON inventory.stock_lot_balance;
DROP POLICY IF EXISTS p_inventory_stock_bin_company_rls ON inventory.stock_bin;
DROP POLICY IF EXISTS p_inventory_stock_bin_company ON inventory.stock_bin;
DROP POLICY IF EXISTS p_inventory_stock_balance_company_rls ON inventory.stock_balance;
DROP POLICY IF EXISTS p_inventory_stock_balance_company ON inventory.stock_balance;
DROP POLICY IF EXISTS p_inventory_inventory_valuation_company_rls ON inventory.inventory_valuation;
DROP POLICY IF EXISTS p_inventory_inventory_valuation_company ON inventory.inventory_valuation;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.warehouse;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.storage_location;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.stocktaking_result;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.stocktaking_plan;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.stock_transfer_header;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.stock_transaction;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.stock_reservation;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.stock_lot_balance;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.stock_lot;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.stock_bin;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.stock_balance;
DROP POLICY IF EXISTS p_admin_bypass ON inventory.inventory_valuation;
DROP POLICY IF EXISTS p_integration_siem_endpoint_company ON integration.siem_endpoint;
DROP POLICY IF EXISTS p_integration_siem_delivery_queue_company ON integration.siem_delivery_queue;
DROP POLICY IF EXISTS p_integration_integration_log_admin_bypass ON integration.integration_log;
DROP POLICY IF EXISTS p_integration_integration_job_admin_bypass ON integration.integration_job;
DROP POLICY IF EXISTS p_integration_external_system_company ON integration.external_system;
DROP POLICY IF EXISTS p_integration_external_system_admin_bypass ON integration.external_system;
DROP POLICY IF EXISTS p_integration_audit_export_queue_company ON integration.audit_export_queue;
DROP POLICY IF EXISTS p_integration_api_credential_admin_bypass ON integration.api_credential;
DROP POLICY IF EXISTS p_admin_bypass ON integration.siem_endpoint;
DROP POLICY IF EXISTS p_admin_bypass ON integration.siem_delivery_queue;
DROP POLICY IF EXISTS p_admin_bypass ON integration.external_system;
DROP POLICY IF EXISTS p_admin_bypass ON integration.audit_export_queue;
DROP POLICY IF EXISTS p_hr_payroll_run_company_rls ON hr.payroll_run;
DROP POLICY IF EXISTS p_hr_payroll_run_company ON hr.payroll_run;
DROP POLICY IF EXISTS p_hr_leave_request_company_rls ON hr.leave_request;
DROP POLICY IF EXISTS p_hr_leave_request_company ON hr.leave_request;
DROP POLICY IF EXISTS p_hr_hr_position_company_rls ON hr.hr_position;
DROP POLICY IF EXISTS p_hr_hr_position_company ON hr.hr_position;
DROP POLICY IF EXISTS p_hr_hr_department_company_rls ON hr.hr_department;
DROP POLICY IF EXISTS p_hr_hr_department_company ON hr.hr_department;
DROP POLICY IF EXISTS p_hr_employment_contract_company_rls ON hr.employment_contract;
DROP POLICY IF EXISTS p_hr_employment_contract_company ON hr.employment_contract;
DROP POLICY IF EXISTS p_hr_employee_company_rls ON hr.employee;
DROP POLICY IF EXISTS p_hr_employee_company ON hr.employee;
DROP POLICY IF EXISTS p_hr_attendance_log_company_rls ON hr.attendance_log;
DROP POLICY IF EXISTS p_hr_attendance_log_company ON hr.attendance_log;
DROP POLICY IF EXISTS p_admin_bypass ON hr.payroll_run;
DROP POLICY IF EXISTS p_admin_bypass ON hr.leave_request;
DROP POLICY IF EXISTS p_admin_bypass ON hr.hr_position;
DROP POLICY IF EXISTS p_admin_bypass ON hr.hr_department;
DROP POLICY IF EXISTS p_admin_bypass ON hr.employment_contract;
DROP POLICY IF EXISTS p_admin_bypass ON hr.employee;
DROP POLICY IF EXISTS p_admin_bypass ON hr.attendance_log;
DROP POLICY IF EXISTS p_pcq_update_admin ON governance.policy_change_queue;
DROP POLICY IF EXISTS p_pcq_select ON governance.policy_change_queue;
DROP POLICY IF EXISTS p_governance_document_category_admin_bypass ON governance.document_category;
DROP POLICY IF EXISTS p_governance_document_archive_company ON governance.document_archive;
DROP POLICY IF EXISTS p_governance_document_archive_admin_bypass ON governance.document_archive;
DROP POLICY IF EXISTS p_governance_contract_item_price_admin_bypass ON governance.contract_item_price;
DROP POLICY IF EXISTS p_governance_contract_header_company ON governance.contract_header;
DROP POLICY IF EXISTS p_governance_contract_header_admin_bypass ON governance.contract_header;
DROP POLICY IF EXISTS p_governance_business_rule_condition_admin_bypass ON governance.business_rule_condition;
DROP POLICY IF EXISTS p_governance_business_rule_company ON governance.business_rule;
DROP POLICY IF EXISTS p_governance_business_rule_admin_bypass ON governance.business_rule;
DROP POLICY IF EXISTS p_governance_business_rule_action_admin_bypass ON governance.business_rule_action;
DROP POLICY IF EXISTS p_admin_bypass ON governance.document_archive;
DROP POLICY IF EXISTS p_admin_bypass ON governance.contract_header;
DROP POLICY IF EXISTS p_admin_bypass ON governance.business_rule;
DROP POLICY IF EXISTS p_finance_payment_company_rls ON finance.payment;
DROP POLICY IF EXISTS p_finance_payment_company ON finance.payment;
DROP POLICY IF EXISTS p_finance_bank_account_company_rls ON finance.bank_account;
DROP POLICY IF EXISTS p_finance_bank_account_company ON finance.bank_account;
DROP POLICY IF EXISTS p_admin_bypass ON finance.payment;
DROP POLICY IF EXISTS p_admin_bypass ON finance.bank_account;
DROP POLICY IF EXISTS p_core_sync_queue_company_rls ON core.sync_queue;
DROP POLICY IF EXISTS p_core_sync_queue_company ON core.sync_queue;
DROP POLICY IF EXISTS p_core_status_history_company_rls ON core.status_history;
DROP POLICY IF EXISTS p_core_status_history_company ON core.status_history;
DROP POLICY IF EXISTS p_core_posting_profile_company_rls ON core.posting_profile;
DROP POLICY IF EXISTS p_core_posting_profile_company ON core.posting_profile;
DROP POLICY IF EXISTS p_core_permissions_company_rls ON core.permissions;
DROP POLICY IF EXISTS p_core_permissions_company ON core.permissions;
DROP POLICY IF EXISTS p_core_permission_groups_company_rls ON core.permission_groups;
DROP POLICY IF EXISTS p_core_permission_groups_company ON core.permission_groups;
DROP POLICY IF EXISTS p_core_journal_entries_company_rls ON core.journal_entries;
DROP POLICY IF EXISTS p_core_journal_entries_company ON core.journal_entries;
DROP POLICY IF EXISTS p_core_document_sequence_company_rls ON core.document_sequence;
DROP POLICY IF EXISTS p_core_document_sequence_company ON core.document_sequence;
DROP POLICY IF EXISTS p_core_company_users_company_rls ON core.company_users;
DROP POLICY IF EXISTS p_core_company_users_company ON core.company_users;
DROP POLICY IF EXISTS p_core_company_permission_company_rls ON core.company_permission;
DROP POLICY IF EXISTS p_core_company_permission_company ON core.company_permission;
DROP POLICY IF EXISTS p_core_company_license_company_rls ON core.company_license;
DROP POLICY IF EXISTS p_core_company_license_company ON core.company_license;
DROP POLICY IF EXISTS p_core_company_company_rls ON core.company;
DROP POLICY IF EXISTS p_core_company_company ON core.company;
DROP POLICY IF EXISTS p_core_audit_trail_company_rls ON core.audit_trail;
DROP POLICY IF EXISTS p_core_audit_trail_company ON core.audit_trail;
DROP POLICY IF EXISTS p_core_audit_trail_2026_07_company_rls ON core.audit_trail_2026_07;
DROP POLICY IF EXISTS p_core_audit_trail_2026_07_company ON core.audit_trail_2026_07;
DROP POLICY IF EXISTS p_core_audit_trail_2026_06_company_rls ON core.audit_trail_2026_06;
DROP POLICY IF EXISTS p_core_audit_trail_2026_06_company ON core.audit_trail_2026_06;
DROP POLICY IF EXISTS p_core_audit_trail_2026_05_company_rls ON core.audit_trail_2026_05;
DROP POLICY IF EXISTS p_core_audit_trail_2026_05_company ON core.audit_trail_2026_05;
DROP POLICY IF EXISTS p_core_audit_trail_2026_04_company_rls ON core.audit_trail_2026_04;
DROP POLICY IF EXISTS p_core_audit_trail_2026_04_company ON core.audit_trail_2026_04;
DROP POLICY IF EXISTS p_core_audit_trail_2026_03_company_rls ON core.audit_trail_2026_03;
DROP POLICY IF EXISTS p_core_audit_trail_2026_03_company ON core.audit_trail_2026_03;
DROP POLICY IF EXISTS p_core_audit_trail_2026_02_company_rls ON core.audit_trail_2026_02;
DROP POLICY IF EXISTS p_core_audit_trail_2026_02_company ON core.audit_trail_2026_02;
DROP POLICY IF EXISTS p_core_audit_trail_2026_01_company_rls ON core.audit_trail_2026_01;
DROP POLICY IF EXISTS p_core_audit_trail_2026_01_company ON core.audit_trail_2026_01;
DROP POLICY IF EXISTS p_core_audit_trail_2025_12_company_rls ON core.audit_trail_2025_12;
DROP POLICY IF EXISTS p_core_audit_trail_2025_12_company ON core.audit_trail_2025_12;
DROP POLICY IF EXISTS p_core_audit_impact_rule_company_rls ON core.audit_impact_rule;
DROP POLICY IF EXISTS p_core_audit_impact_rule_company ON core.audit_impact_rule;
DROP POLICY IF EXISTS p_core_audit_column_weight_company_rls ON core.audit_column_weight;
DROP POLICY IF EXISTS p_core_audit_column_weight_company ON core.audit_column_weight;
DROP POLICY IF EXISTS p_core_app_user_company_rls ON core.app_user;
DROP POLICY IF EXISTS p_core_app_user_company ON core.app_user;
DROP POLICY IF EXISTS p_core_accounts_company_rls ON core.accounts;
DROP POLICY IF EXISTS p_core_accounts_company ON core.accounts;
DROP POLICY IF EXISTS p_core_accounting_period_company_rls ON core.accounting_period;
DROP POLICY IF EXISTS p_core_accounting_period_company ON core.accounting_period;
DROP POLICY IF EXISTS p_audit_trail_read ON core.audit_trail;
DROP POLICY IF EXISTS p_admin_bypass ON core.sync_queue;
DROP POLICY IF EXISTS p_admin_bypass ON core.status_history;
DROP POLICY IF EXISTS p_admin_bypass ON core.posting_profile;
DROP POLICY IF EXISTS p_admin_bypass ON core.permissions;
DROP POLICY IF EXISTS p_admin_bypass ON core.permission_groups;
DROP POLICY IF EXISTS p_admin_bypass ON core.journal_entries;
DROP POLICY IF EXISTS p_admin_bypass ON core.document_sequence;
DROP POLICY IF EXISTS p_admin_bypass ON core.company_users;
DROP POLICY IF EXISTS p_admin_bypass ON core.company_permission;
DROP POLICY IF EXISTS p_admin_bypass ON core.company_license;
DROP POLICY IF EXISTS p_admin_bypass ON core.company;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_trail_2026_07;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_trail_2026_06;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_trail_2026_05;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_trail_2026_04;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_trail_2026_03;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_trail_2026_02;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_trail_2026_01;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_trail_2025_12;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_trail;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_impact_rule;
DROP POLICY IF EXISTS p_admin_bypass ON core.audit_column_weight;
DROP POLICY IF EXISTS p_admin_bypass ON core.app_user;
DROP POLICY IF EXISTS p_admin_bypass ON core.accounts;
DROP POLICY IF EXISTS p_admin_bypass ON core.accounting_period;
DROP POLICY IF EXISTS p_compliance_iso_standard_admin_bypass ON compliance.iso_standard;
DROP POLICY IF EXISTS p_compliance_iso_clause_admin_bypass ON compliance.iso_clause;
DROP POLICY IF EXISTS p_compliance_audit_issue_admin_bypass ON compliance.audit_issue;
DROP POLICY IF EXISTS p_compliance_audit_event_company ON compliance.audit_event;
DROP POLICY IF EXISTS p_compliance_audit_event_admin_bypass ON compliance.audit_event;
DROP POLICY IF EXISTS p_compliance_audit_action_admin_bypass ON compliance.audit_action;
DROP POLICY IF EXISTS p_admin_bypass ON compliance.audit_event;
DROP POLICY IF EXISTS p_ng_event_company ON audit.ng_event;
DROP POLICY IF EXISTS p_entity_status_history_company ON audit.entity_status_history;
DROP POLICY IF EXISTS p_audit_exec_audit_event_owner ON audit.exec_audit_event;
DROP POLICY IF EXISTS p_ar_update_approver ON audit.approval_request;
DROP POLICY IF EXISTS p_ar_select_company ON audit.approval_request;
DROP POLICY IF EXISTS p_ar_insert_company ON audit.approval_request;
DROP POLICY IF EXISTS p_approval_request_insert ON audit.approval_request;
DROP POLICY IF EXISTS p_approval_request_company ON audit.approval_request;
DROP POLICY IF EXISTS p_approval_request_approver_update ON audit.approval_request;
DROP POLICY IF EXISTS p_approval_log_company ON audit.approval_log;
DROP POLICY IF EXISTS p_al_select_company ON audit.approval_log;
DROP POLICY IF EXISTS p_al_insert_approver ON audit.approval_log;
DROP POLICY IF EXISTS p_judge_update_admin ON analytics.audit_alert_ai_judgement;
DROP POLICY IF EXISTS p_judge_select ON analytics.audit_alert_ai_judgement;
DROP POLICY IF EXISTS p_analytics_fact_metric_company ON analytics.fact_metric;
DROP POLICY IF EXISTS p_analytics_fact_metric_admin_bypass ON analytics.fact_metric;
ALTER TABLE IF EXISTS ONLY tenant.company_license DROP CONSTRAINT IF EXISTS company_license_license_code_fkey;
ALTER TABLE IF EXISTS ONLY tenant.company_license DROP CONSTRAINT IF EXISTS company_license_company_id_fkey;
ALTER TABLE IF EXISTS ONLY system.role_screen_permission DROP CONSTRAINT IF EXISTS role_screen_permission_screen_code_fkey;
ALTER TABLE IF EXISTS ONLY system.role_screen_permission DROP CONSTRAINT IF EXISTS role_screen_permission_role_code_fkey;
ALTER TABLE IF EXISTS ONLY system.operation_log DROP CONSTRAINT IF EXISTS operation_log_session_id_fkey;
ALTER TABLE IF EXISTS ONLY system.operation_log DROP CONSTRAINT IF EXISTS operation_log_screen_code_fkey;
ALTER TABLE IF EXISTS ONLY system.operation_log DROP CONSTRAINT IF EXISTS operation_log_role_code_fkey;
ALTER TABLE IF EXISTS ONLY system.operation_log DROP CONSTRAINT IF EXISTS operation_log_operation_type_fkey;
ALTER TABLE IF EXISTS ONLY system.notification_subscription DROP CONSTRAINT IF EXISTS notification_subscription_endpoint_code_fkey;
ALTER TABLE IF EXISTS ONLY system.loop_config DROP CONSTRAINT IF EXISTS loop_config_command_code_fkey;
ALTER TABLE IF EXISTS ONLY system.function_def DROP CONSTRAINT IF EXISTS function_def_module_code_fkey;
ALTER TABLE IF EXISTS ONLY system.business_ops_map DROP CONSTRAINT IF EXISTS fk_business_ops_document;
ALTER TABLE IF EXISTS ONLY system.exec_run_request DROP CONSTRAINT IF EXISTS exec_run_request_command_code_fkey;
ALTER TABLE IF EXISTS ONLY system.approval_step_def DROP CONSTRAINT IF EXISTS approval_step_def_approval_flow_code_fkey;
ALTER TABLE IF EXISTS ONLY system.approval_exec_map DROP CONSTRAINT IF EXISTS approval_exec_map_command_code_fkey;
ALTER TABLE IF EXISTS ONLY system.approval_action_log DROP CONSTRAINT IF EXISTS approval_action_log_approval_request_id_fkey;
ALTER TABLE IF EXISTS ONLY system.ai_task_run DROP CONSTRAINT IF EXISTS ai_task_run_task_id_fkey;
ALTER TABLE IF EXISTS ONLY system.ai_task DROP CONSTRAINT IF EXISTS ai_task_agent_code_fkey;
ALTER TABLE IF EXISTS ONLY system.action_approval_map DROP CONSTRAINT IF EXISTS action_approval_map_approval_flow_code_fkey;
ALTER TABLE IF EXISTS ONLY storage.vector_indexes DROP CONSTRAINT IF EXISTS vector_indexes_bucket_id_fkey;
ALTER TABLE IF EXISTS ONLY storage.s3_multipart_uploads_parts DROP CONSTRAINT IF EXISTS s3_multipart_uploads_parts_upload_id_fkey;
ALTER TABLE IF EXISTS ONLY storage.s3_multipart_uploads_parts DROP CONSTRAINT IF EXISTS s3_multipart_uploads_parts_bucket_id_fkey;
ALTER TABLE IF EXISTS ONLY storage.s3_multipart_uploads DROP CONSTRAINT IF EXISTS s3_multipart_uploads_bucket_id_fkey;
ALTER TABLE IF EXISTS ONLY storage.prefixes DROP CONSTRAINT IF EXISTS "prefixes_bucketId_fkey";
ALTER TABLE IF EXISTS ONLY storage.objects DROP CONSTRAINT IF EXISTS "objects_bucketId_fkey";
ALTER TABLE IF EXISTS ONLY sales.shipping_header DROP CONSTRAINT IF EXISTS shipping_header_order_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.shipping_header DROP CONSTRAINT IF EXISTS shipping_header_created_by_fkey;
ALTER TABLE IF EXISTS ONLY sales.shipping_header DROP CONSTRAINT IF EXISTS shipping_header_company_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.shipping_detail DROP CONSTRAINT IF EXISTS shipping_detail_shipping_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.shipping_detail DROP CONSTRAINT IF EXISTS shipping_detail_order_detail_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.shipping_detail DROP CONSTRAINT IF EXISTS shipping_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.sales_quotation_detail DROP CONSTRAINT IF EXISTS sales_quotation_detail_sales_quotation_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.sales_quotation_detail DROP CONSTRAINT IF EXISTS sales_quotation_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.sales_quotation DROP CONSTRAINT IF EXISTS sales_quotation_customer_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.sales_quotation DROP CONSTRAINT IF EXISTS sales_quotation_created_by_fkey;
ALTER TABLE IF EXISTS ONLY sales.sales_quotation DROP CONSTRAINT IF EXISTS sales_quotation_company_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.return_header DROP CONSTRAINT IF EXISTS return_header_created_by_fkey;
ALTER TABLE IF EXISTS ONLY sales.return_header DROP CONSTRAINT IF EXISTS return_header_company_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.return_header DROP CONSTRAINT IF EXISTS return_header_billing_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.return_detail DROP CONSTRAINT IF EXISTS return_detail_return_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.return_detail DROP CONSTRAINT IF EXISTS return_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.order_header DROP CONSTRAINT IF EXISTS order_header_customer_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.order_header DROP CONSTRAINT IF EXISTS order_header_created_by_fkey;
ALTER TABLE IF EXISTS ONLY sales.order_header DROP CONSTRAINT IF EXISTS order_header_company_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.order_detail DROP CONSTRAINT IF EXISTS order_detail_order_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.order_detail DROP CONSTRAINT IF EXISTS order_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.item_uom DROP CONSTRAINT IF EXISTS item_uom_uom_code_fkey;
ALTER TABLE IF EXISTS ONLY sales.item_uom DROP CONSTRAINT IF EXISTS item_uom_item_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.item_price_master DROP CONSTRAINT IF EXISTS item_price_master_item_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.item_price_master DROP CONSTRAINT IF EXISTS item_price_master_company_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.item DROP CONSTRAINT IF EXISTS item_item_category_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.item DROP CONSTRAINT IF EXISTS item_company_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.item_category DROP CONSTRAINT IF EXISTS item_category_parent_category_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.item_category DROP CONSTRAINT IF EXISTS item_category_company_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.invoice_pdf DROP CONSTRAINT IF EXISTS invoice_pdf_company_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.invoice_pdf DROP CONSTRAINT IF EXISTS invoice_pdf_billing_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.customer_payment_term DROP CONSTRAINT IF EXISTS customer_payment_term_payment_term_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.customer_payment_term DROP CONSTRAINT IF EXISTS customer_payment_term_payment_method_code_fkey;
ALTER TABLE IF EXISTS ONLY sales.customer_payment_term DROP CONSTRAINT IF EXISTS customer_payment_term_customer_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.customer_contact DROP CONSTRAINT IF EXISTS customer_contact_customer_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.customer DROP CONSTRAINT IF EXISTS customer_company_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.customer_address DROP CONSTRAINT IF EXISTS customer_address_customer_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.billing_header DROP CONSTRAINT IF EXISTS billing_header_customer_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.billing_header DROP CONSTRAINT IF EXISTS billing_header_created_by_fkey;
ALTER TABLE IF EXISTS ONLY sales.billing_header DROP CONSTRAINT IF EXISTS billing_header_company_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.billing_detail DROP CONSTRAINT IF EXISTS billing_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY sales.billing_detail DROP CONSTRAINT IF EXISTS billing_detail_billing_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_payment_term DROP CONSTRAINT IF EXISTS supplier_payment_term_supplier_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_payment_term DROP CONSTRAINT IF EXISTS supplier_payment_term_payment_term_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_payment_term DROP CONSTRAINT IF EXISTS supplier_payment_term_payment_method_code_fkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_master DROP CONSTRAINT IF EXISTS supplier_master_company_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_item_price DROP CONSTRAINT IF EXISTS supplier_item_price_supplier_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_item_price DROP CONSTRAINT IF EXISTS supplier_item_price_item_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_item_price DROP CONSTRAINT IF EXISTS supplier_item_price_company_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_contact DROP CONSTRAINT IF EXISTS supplier_contact_supplier_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_address DROP CONSTRAINT IF EXISTS supplier_address_supplier_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_three_way_match DROP CONSTRAINT IF EXISTS purchase_three_way_match_receipt_detail_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_three_way_match DROP CONSTRAINT IF EXISTS purchase_three_way_match_purchase_order_detail_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_three_way_match DROP CONSTRAINT IF EXISTS purchase_three_way_match_purchase_invoice_detail_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_three_way_match DROP CONSTRAINT IF EXISTS purchase_three_way_match_company_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_requisition DROP CONSTRAINT IF EXISTS purchase_requisition_requester_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_requisition_detail DROP CONSTRAINT IF EXISTS purchase_requisition_detail_purchase_requisition_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_requisition_detail DROP CONSTRAINT IF EXISTS purchase_requisition_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_requisition DROP CONSTRAINT IF EXISTS purchase_requisition_company_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_receipt DROP CONSTRAINT IF EXISTS purchase_receipt_warehouse_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_receipt DROP CONSTRAINT IF EXISTS purchase_receipt_purchase_order_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_receipt_detail DROP CONSTRAINT IF EXISTS purchase_receipt_detail_receipt_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_receipt_detail DROP CONSTRAINT IF EXISTS purchase_receipt_detail_purchase_order_detail_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_receipt_detail DROP CONSTRAINT IF EXISTS purchase_receipt_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_receipt DROP CONSTRAINT IF EXISTS purchase_receipt_company_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_quotation DROP CONSTRAINT IF EXISTS purchase_quotation_supplier_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_quotation_detail DROP CONSTRAINT IF EXISTS purchase_quotation_detail_purchase_quotation_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_quotation_detail DROP CONSTRAINT IF EXISTS purchase_quotation_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_quotation DROP CONSTRAINT IF EXISTS purchase_quotation_company_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_order_header DROP CONSTRAINT IF EXISTS purchase_order_header_supplier_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_order_header DROP CONSTRAINT IF EXISTS purchase_order_header_created_by_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_order_header DROP CONSTRAINT IF EXISTS purchase_order_header_company_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_order_detail DROP CONSTRAINT IF EXISTS purchase_order_detail_purchase_order_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_order_detail DROP CONSTRAINT IF EXISTS purchase_order_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_invoice DROP CONSTRAINT IF EXISTS purchase_invoice_supplier_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_invoice_detail DROP CONSTRAINT IF EXISTS purchase_invoice_detail_receipt_detail_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_invoice_detail DROP CONSTRAINT IF EXISTS purchase_invoice_detail_purchase_order_detail_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_invoice_detail DROP CONSTRAINT IF EXISTS purchase_invoice_detail_purchase_invoice_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_invoice_detail DROP CONSTRAINT IF EXISTS purchase_invoice_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_invoice DROP CONSTRAINT IF EXISTS purchase_invoice_company_id_fkey;
ALTER TABLE IF EXISTS ONLY ops.send_fee_master DROP CONSTRAINT IF EXISTS send_fee_master_resend_type_code_fkey;
ALTER TABLE IF EXISTS ONLY ops.send_fee_master DROP CONSTRAINT IF EXISTS send_fee_master_document_type_code_fkey;
ALTER TABLE IF EXISTS ONLY ops.ops_job_result DROP CONSTRAINT IF EXISTS ops_job_result_job_id_fkey;
ALTER TABLE IF EXISTS ONLY ops.ops_job_result DROP CONSTRAINT IF EXISTS fk_ops_job_result_job;
ALTER TABLE IF EXISTS ONLY ops.document_send_history DROP CONSTRAINT IF EXISTS document_send_history_resend_type_code_fkey;
ALTER TABLE IF EXISTS ONLY ops.document_send_history DROP CONSTRAINT IF EXISTS document_send_history_document_type_code_fkey;
ALTER TABLE IF EXISTS ONLY ops.document_send_history DROP CONSTRAINT IF EXISTS document_send_history_channel_code_fkey;
ALTER TABLE IF EXISTS ONLY ops.document_file DROP CONSTRAINT IF EXISTS document_file_document_type_code_fkey;
ALTER TABLE IF EXISTS ONLY notify.approval_action_log DROP CONSTRAINT IF EXISTS approval_action_log_approval_request_id_fkey;
ALTER TABLE IF EXISTS ONLY notify.ai_event DROP CONSTRAINT IF EXISTS ai_event_ai_rule_id_fkey;
ALTER TABLE IF EXISTS ONLY media.asset_link DROP CONSTRAINT IF EXISTS asset_link_asset_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.yield_metric DROP CONSTRAINT IF EXISTS yield_metric_process_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.yield_metric DROP CONSTRAINT IF EXISTS yield_metric_company_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.work_order DROP CONSTRAINT IF EXISTS work_order_warehouse_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.work_order DROP CONSTRAINT IF EXISTS work_order_routing_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.work_order DROP CONSTRAINT IF EXISTS work_order_item_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.work_order DROP CONSTRAINT IF EXISTS work_order_company_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.work_order DROP CONSTRAINT IF EXISTS work_order_bom_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.routing_operation DROP CONSTRAINT IF EXISTS routing_operation_routing_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.routing_operation DROP CONSTRAINT IF EXISTS routing_operation_process_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.routing_header DROP CONSTRAINT IF EXISTS routing_header_item_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.routing_header DROP CONSTRAINT IF EXISTS routing_header_company_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.process_master DROP CONSTRAINT IF EXISTS process_master_company_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mrp_run DROP CONSTRAINT IF EXISTS mrp_run_company_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mrp_requirement DROP CONSTRAINT IF EXISTS mrp_requirement_mrp_run_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mrp_requirement DROP CONSTRAINT IF EXISTS mrp_requirement_item_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mrp_allocation DROP CONSTRAINT IF EXISTS mrp_allocation_mrp_requirement_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mps_run DROP CONSTRAINT IF EXISTS mps_run_company_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mps_plan DROP CONSTRAINT IF EXISTS mps_plan_mps_run_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mps_plan DROP CONSTRAINT IF EXISTS mps_plan_item_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_execution DROP CONSTRAINT IF EXISTS manufacturing_execution_work_order_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_execution DROP CONSTRAINT IF EXISTS manufacturing_execution_warehouse_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_execution_detail DROP CONSTRAINT IF EXISTS manufacturing_execution_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_execution_detail DROP CONSTRAINT IF EXISTS manufacturing_execution_detail_execution_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_execution DROP CONSTRAINT IF EXISTS manufacturing_execution_company_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_cost_snapshot DROP CONSTRAINT IF EXISTS manufacturing_cost_snapshot_work_order_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_cost_snapshot DROP CONSTRAINT IF EXISTS manufacturing_cost_snapshot_company_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.bom_header DROP CONSTRAINT IF EXISTS bom_header_parent_item_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.bom_header DROP CONSTRAINT IF EXISTS bom_header_company_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.bom_detail DROP CONSTRAINT IF EXISTS bom_detail_component_item_id_fkey;
ALTER TABLE IF EXISTS ONLY manufacturing.bom_detail DROP CONSTRAINT IF EXISTS bom_detail_bom_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.warehouse DROP CONSTRAINT IF EXISTS warehouse_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.storage_location DROP CONSTRAINT IF EXISTS storage_location_warehouse_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.storage_location DROP CONSTRAINT IF EXISTS storage_location_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stocktaking_result DROP CONSTRAINT IF EXISTS stocktaking_result_stocktaking_plan_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stocktaking_result DROP CONSTRAINT IF EXISTS stocktaking_result_item_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stocktaking_result DROP CONSTRAINT IF EXISTS stocktaking_result_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stocktaking_result DROP CONSTRAINT IF EXISTS stocktaking_result_bin_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stocktaking_plan DROP CONSTRAINT IF EXISTS stocktaking_plan_warehouse_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stocktaking_plan DROP CONSTRAINT IF EXISTS stocktaking_plan_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_header DROP CONSTRAINT IF EXISTS stock_transfer_header_to_warehouse_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_header DROP CONSTRAINT IF EXISTS stock_transfer_header_requested_by_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_header DROP CONSTRAINT IF EXISTS stock_transfer_header_from_warehouse_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_header DROP CONSTRAINT IF EXISTS stock_transfer_header_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_header DROP CONSTRAINT IF EXISTS stock_transfer_header_approved_by_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_detail DROP CONSTRAINT IF EXISTS stock_transfer_detail_to_location_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_detail DROP CONSTRAINT IF EXISTS stock_transfer_detail_to_bin_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_detail DROP CONSTRAINT IF EXISTS stock_transfer_detail_stock_transfer_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_detail DROP CONSTRAINT IF EXISTS stock_transfer_detail_stock_lot_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_detail DROP CONSTRAINT IF EXISTS stock_transfer_detail_item_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_detail DROP CONSTRAINT IF EXISTS stock_transfer_detail_from_location_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_detail DROP CONSTRAINT IF EXISTS stock_transfer_detail_from_bin_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transaction DROP CONSTRAINT IF EXISTS stock_transaction_warehouse_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transaction DROP CONSTRAINT IF EXISTS stock_transaction_to_bin_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transaction DROP CONSTRAINT IF EXISTS stock_transaction_stock_lot_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transaction DROP CONSTRAINT IF EXISTS stock_transaction_item_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transaction DROP CONSTRAINT IF EXISTS stock_transaction_from_bin_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transaction DROP CONSTRAINT IF EXISTS stock_transaction_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_reservation DROP CONSTRAINT IF EXISTS stock_reservation_stock_lot_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_reservation DROP CONSTRAINT IF EXISTS stock_reservation_item_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_reservation DROP CONSTRAINT IF EXISTS stock_reservation_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot DROP CONSTRAINT IF EXISTS stock_lot_item_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot DROP CONSTRAINT IF EXISTS stock_lot_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot_balance DROP CONSTRAINT IF EXISTS stock_lot_balance_warehouse_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot_balance DROP CONSTRAINT IF EXISTS stock_lot_balance_stock_lot_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot_balance DROP CONSTRAINT IF EXISTS stock_lot_balance_location_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot_balance DROP CONSTRAINT IF EXISTS stock_lot_balance_item_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot_balance DROP CONSTRAINT IF EXISTS stock_lot_balance_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot_balance DROP CONSTRAINT IF EXISTS stock_lot_balance_bin_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_bin DROP CONSTRAINT IF EXISTS stock_bin_location_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_bin DROP CONSTRAINT IF EXISTS stock_bin_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_balance DROP CONSTRAINT IF EXISTS stock_balance_warehouse_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_balance DROP CONSTRAINT IF EXISTS stock_balance_location_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_balance DROP CONSTRAINT IF EXISTS stock_balance_item_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_balance DROP CONSTRAINT IF EXISTS stock_balance_company_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_balance DROP CONSTRAINT IF EXISTS stock_balance_bin_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.inventory_valuation DROP CONSTRAINT IF EXISTS inventory_valuation_item_id_fkey;
ALTER TABLE IF EXISTS ONLY inventory.inventory_valuation DROP CONSTRAINT IF EXISTS inventory_valuation_company_id_fkey;
ALTER TABLE IF EXISTS ONLY integration.siem_delivery_queue DROP CONSTRAINT IF EXISTS siem_delivery_queue_endpoint_id_fkey;
ALTER TABLE IF EXISTS ONLY integration.integration_log DROP CONSTRAINT IF EXISTS integration_log_integration_job_id_fkey;
ALTER TABLE IF EXISTS ONLY integration.integration_job DROP CONSTRAINT IF EXISTS integration_job_external_system_id_fkey;
ALTER TABLE IF EXISTS ONLY integration.external_system DROP CONSTRAINT IF EXISTS external_system_company_id_fkey;
ALTER TABLE IF EXISTS ONLY integration.api_credential DROP CONSTRAINT IF EXISTS api_credential_external_system_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.payroll_slip DROP CONSTRAINT IF EXISTS payroll_slip_payroll_run_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.payroll_slip DROP CONSTRAINT IF EXISTS payroll_slip_employee_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.payroll_run DROP CONSTRAINT IF EXISTS payroll_run_company_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.leave_request DROP CONSTRAINT IF EXISTS leave_request_leave_type_code_fkey;
ALTER TABLE IF EXISTS ONLY hr.leave_request DROP CONSTRAINT IF EXISTS leave_request_employee_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.leave_request DROP CONSTRAINT IF EXISTS leave_request_company_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.leave_request DROP CONSTRAINT IF EXISTS leave_request_approved_by_fkey;
ALTER TABLE IF EXISTS ONLY hr.hr_position DROP CONSTRAINT IF EXISTS hr_position_company_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.hr_department DROP CONSTRAINT IF EXISTS hr_department_company_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.employment_contract DROP CONSTRAINT IF EXISTS employment_contract_employee_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.employment_contract DROP CONSTRAINT IF EXISTS employment_contract_company_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.employee DROP CONSTRAINT IF EXISTS employee_position_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.employee DROP CONSTRAINT IF EXISTS employee_department_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.employee DROP CONSTRAINT IF EXISTS employee_company_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.attendance_log DROP CONSTRAINT IF EXISTS attendance_log_employee_id_fkey;
ALTER TABLE IF EXISTS ONLY hr.attendance_log DROP CONSTRAINT IF EXISTS attendance_log_company_id_fkey;
ALTER TABLE IF EXISTS ONLY governance.policy_change_queue DROP CONSTRAINT IF EXISTS policy_change_queue_source_alert_event_id_fkey;
ALTER TABLE IF EXISTS ONLY governance.document_archive DROP CONSTRAINT IF EXISTS document_archive_document_category_id_fkey;
ALTER TABLE IF EXISTS ONLY governance.document_archive DROP CONSTRAINT IF EXISTS document_archive_company_id_fkey;
ALTER TABLE IF EXISTS ONLY governance.contract_item_price DROP CONSTRAINT IF EXISTS contract_item_price_item_id_fkey;
ALTER TABLE IF EXISTS ONLY governance.contract_item_price DROP CONSTRAINT IF EXISTS contract_item_price_contract_id_fkey;
ALTER TABLE IF EXISTS ONLY governance.contract_header DROP CONSTRAINT IF EXISTS contract_header_company_id_fkey;
ALTER TABLE IF EXISTS ONLY governance.business_rule_condition DROP CONSTRAINT IF EXISTS business_rule_condition_business_rule_id_fkey;
ALTER TABLE IF EXISTS ONLY governance.business_rule DROP CONSTRAINT IF EXISTS business_rule_company_id_fkey;
ALTER TABLE IF EXISTS ONLY governance.business_rule_action DROP CONSTRAINT IF EXISTS business_rule_action_business_rule_id_fkey;
ALTER TABLE IF EXISTS ONLY finance.payment DROP CONSTRAINT IF EXISTS payment_company_id_fkey;
ALTER TABLE IF EXISTS ONLY finance.payment DROP CONSTRAINT IF EXISTS payment_bank_account_id_fkey;
ALTER TABLE IF EXISTS ONLY finance.payment_allocation DROP CONSTRAINT IF EXISTS payment_allocation_payment_id_fkey;
ALTER TABLE IF EXISTS ONLY finance.bank_statement_line DROP CONSTRAINT IF EXISTS bank_statement_line_bank_statement_id_fkey;
ALTER TABLE IF EXISTS ONLY finance.bank_statement_header DROP CONSTRAINT IF EXISTS bank_statement_header_bank_account_id_fkey;
ALTER TABLE IF EXISTS ONLY finance.bank_account DROP CONSTRAINT IF EXISTS bank_account_company_id_fkey;
ALTER TABLE IF EXISTS ONLY devops.codegen_artifact DROP CONSTRAINT IF EXISTS codegen_artifact_run_id_fkey;
ALTER TABLE IF EXISTS ONLY core.user_permissions DROP CONSTRAINT IF EXISTS user_permissions_user_id_fkey;
ALTER TABLE IF EXISTS ONLY core.user_permissions DROP CONSTRAINT IF EXISTS user_permissions_permission_id_fkey;
ALTER TABLE IF EXISTS ONLY core.uom_conversion DROP CONSTRAINT IF EXISTS uom_conversion_to_uom_code_fkey;
ALTER TABLE IF EXISTS ONLY core.uom_conversion DROP CONSTRAINT IF EXISTS uom_conversion_from_uom_code_fkey;
ALTER TABLE IF EXISTS ONLY core.status_history DROP CONSTRAINT IF EXISTS status_history_company_id_fkey;
ALTER TABLE IF EXISTS ONLY core.status_history DROP CONSTRAINT IF EXISTS status_history_changed_by_fkey;
ALTER TABLE IF EXISTS ONLY core.posting_profile DROP CONSTRAINT IF EXISTS posting_profile_debit_account_id_fkey;
ALTER TABLE IF EXISTS ONLY core.posting_profile DROP CONSTRAINT IF EXISTS posting_profile_credit_account_id_fkey;
ALTER TABLE IF EXISTS ONLY core.posting_profile DROP CONSTRAINT IF EXISTS posting_profile_company_id_fkey;
ALTER TABLE IF EXISTS ONLY core.permission_groups DROP CONSTRAINT IF EXISTS permission_groups_company_id_fkey;
ALTER TABLE IF EXISTS ONLY core.permission_group_permissions DROP CONSTRAINT IF EXISTS permission_group_permissions_permission_id_fkey;
ALTER TABLE IF EXISTS ONLY core.permission_group_permissions DROP CONSTRAINT IF EXISTS permission_group_permissions_group_id_fkey;
ALTER TABLE IF EXISTS ONLY core.login_history DROP CONSTRAINT IF EXISTS login_history_user_id_fkey;
ALTER TABLE IF EXISTS ONLY core.journal_source_link DROP CONSTRAINT IF EXISTS journal_source_link_journal_id_fkey;
ALTER TABLE IF EXISTS ONLY core.journal_lines DROP CONSTRAINT IF EXISTS journal_lines_journal_id_fkey;
ALTER TABLE IF EXISTS ONLY core.journal_lines DROP CONSTRAINT IF EXISTS journal_lines_account_id_fkey;
ALTER TABLE IF EXISTS ONLY core.journal_entries DROP CONSTRAINT IF EXISTS journal_entries_period_id_fkey;
ALTER TABLE IF EXISTS ONLY core.journal_entries DROP CONSTRAINT IF EXISTS journal_entries_created_by_fkey;
ALTER TABLE IF EXISTS ONLY core.journal_entries DROP CONSTRAINT IF EXISTS journal_entries_company_id_fkey;
ALTER TABLE IF EXISTS ONLY core.entity_attribute_value DROP CONSTRAINT IF EXISTS entity_attribute_value_attribute_def_id_fkey;
ALTER TABLE IF EXISTS ONLY core.document_sequence DROP CONSTRAINT IF EXISTS document_sequence_company_id_fkey;
ALTER TABLE IF EXISTS ONLY core.company_users DROP CONSTRAINT IF EXISTS company_users_user_id_fkey;
ALTER TABLE IF EXISTS ONLY core.company_users DROP CONSTRAINT IF EXISTS company_users_company_id_fkey;
ALTER TABLE IF EXISTS ONLY core.company_permission DROP CONSTRAINT IF EXISTS company_permission_company_id_fkey;
ALTER TABLE IF EXISTS ONLY core.company_license DROP CONSTRAINT IF EXISTS company_license_license_code_fkey;
ALTER TABLE IF EXISTS ONLY core.company_license DROP CONSTRAINT IF EXISTS company_license_company_id_fkey;
ALTER TABLE IF EXISTS ONLY core.app_user DROP CONSTRAINT IF EXISTS app_user_company_id_fkey;
ALTER TABLE IF EXISTS ONLY core.accounts DROP CONSTRAINT IF EXISTS accounts_company_id_fkey;
ALTER TABLE IF EXISTS ONLY core.accounting_period DROP CONSTRAINT IF EXISTS accounting_period_company_id_fkey;
ALTER TABLE IF EXISTS ONLY compliance.iso_clause DROP CONSTRAINT IF EXISTS iso_clause_iso_standard_id_fkey;
ALTER TABLE IF EXISTS ONLY compliance.audit_issue DROP CONSTRAINT IF EXISTS audit_issue_iso_clause_id_fkey;
ALTER TABLE IF EXISTS ONLY compliance.audit_issue DROP CONSTRAINT IF EXISTS audit_issue_audit_event_id_fkey;
ALTER TABLE IF EXISTS ONLY compliance.audit_event DROP CONSTRAINT IF EXISTS audit_event_iso_standard_id_fkey;
ALTER TABLE IF EXISTS ONLY compliance.audit_event DROP CONSTRAINT IF EXISTS audit_event_company_id_fkey;
ALTER TABLE IF EXISTS ONLY compliance.audit_action DROP CONSTRAINT IF EXISTS audit_action_owner_id_fkey;
ALTER TABLE IF EXISTS ONLY compliance.audit_action DROP CONSTRAINT IF EXISTS audit_action_audit_issue_id_fkey;
ALTER TABLE IF EXISTS ONLY billing.invoice_line DROP CONSTRAINT IF EXISTS invoice_line_invoice_id_fkey;
ALTER TABLE IF EXISTS ONLY billing.checkout_session DROP CONSTRAINT IF EXISTS checkout_session_invoice_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.sso_domains DROP CONSTRAINT IF EXISTS sso_domains_sso_provider_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.sessions DROP CONSTRAINT IF EXISTS sessions_user_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.sessions DROP CONSTRAINT IF EXISTS sessions_oauth_client_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.saml_relay_states DROP CONSTRAINT IF EXISTS saml_relay_states_sso_provider_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.saml_relay_states DROP CONSTRAINT IF EXISTS saml_relay_states_flow_state_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.saml_providers DROP CONSTRAINT IF EXISTS saml_providers_sso_provider_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.refresh_tokens DROP CONSTRAINT IF EXISTS refresh_tokens_session_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.one_time_tokens DROP CONSTRAINT IF EXISTS one_time_tokens_user_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.oauth_consents DROP CONSTRAINT IF EXISTS oauth_consents_user_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.oauth_consents DROP CONSTRAINT IF EXISTS oauth_consents_client_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.oauth_authorizations DROP CONSTRAINT IF EXISTS oauth_authorizations_user_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.oauth_authorizations DROP CONSTRAINT IF EXISTS oauth_authorizations_client_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.mfa_factors DROP CONSTRAINT IF EXISTS mfa_factors_user_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.mfa_challenges DROP CONSTRAINT IF EXISTS mfa_challenges_auth_factor_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.mfa_amr_claims DROP CONSTRAINT IF EXISTS mfa_amr_claims_session_id_fkey;
ALTER TABLE IF EXISTS ONLY auth.identities DROP CONSTRAINT IF EXISTS identities_user_id_fkey;
ALTER TABLE IF EXISTS ONLY audit.approval_log DROP CONSTRAINT IF EXISTS approval_log_approval_request_id_fkey;
ALTER TABLE IF EXISTS ONLY approval.saas_subscription DROP CONSTRAINT IF EXISTS saas_subscription_plan_code_fkey;
ALTER TABLE IF EXISTS ONLY approval.saas_company_map DROP CONSTRAINT IF EXISTS saas_company_map_subscription_id_fkey;
ALTER TABLE IF EXISTS ONLY approval.invoice_delivery_log DROP CONSTRAINT IF EXISTS invoice_delivery_log_invoice_id_fkey;
ALTER TABLE IF EXISTS ONLY approval.company_plan DROP CONSTRAINT IF EXISTS company_plan_plan_code_fkey;
ALTER TABLE IF EXISTS ONLY approval.billing_payment DROP CONSTRAINT IF EXISTS billing_payment_invoice_id_fkey;
ALTER TABLE IF EXISTS ONLY analytics.fact_metric DROP CONSTRAINT IF EXISTS fact_metric_company_id_fkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_alert_notification DROP CONSTRAINT IF EXISTS audit_alert_notification_alert_event_id_fkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_alert_event DROP CONSTRAINT IF EXISTS audit_alert_event_rule_id_fkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_alert_ai_judgement DROP CONSTRAINT IF EXISTS audit_alert_ai_judgement_alert_event_id_fkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_ai_llm_result DROP CONSTRAINT IF EXISTS audit_ai_llm_result_alert_event_id_fkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_ai_job DROP CONSTRAINT IF EXISTS audit_ai_job_alert_event_id_fkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_ai_feedback DROP CONSTRAINT IF EXISTS audit_ai_feedback_judgement_id_fkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_ai_feedback DROP CONSTRAINT IF EXISTS audit_ai_feedback_alert_event_id_fkey;
ALTER TABLE IF EXISTS ONLY accounting.paper_send_fee_journal DROP CONSTRAINT IF EXISTS paper_send_fee_journal_send_history_id_fkey;
DROP TRIGGER IF EXISTS trg_loop_config_updated_at ON system.loop_config;
DROP TRIGGER IF EXISTS trg_exec_run_notify ON system.exec_run_request;
DROP TRIGGER IF EXISTS trg_exec_request_audit_upd ON system.exec_run_request;
DROP TRIGGER IF EXISTS trg_exec_request_audit_ins ON system.exec_run_request;
DROP TRIGGER IF EXISTS trg_exec_command_updated_at ON system.exec_command;
DROP TRIGGER IF EXISTS update_objects_updated_at ON storage.objects;
DROP TRIGGER IF EXISTS prefixes_delete_hierarchy ON storage.prefixes;
DROP TRIGGER IF EXISTS prefixes_create_hierarchy ON storage.prefixes;
DROP TRIGGER IF EXISTS objects_update_create_prefix ON storage.objects;
DROP TRIGGER IF EXISTS objects_insert_create_prefix ON storage.objects;
DROP TRIGGER IF EXISTS objects_delete_delete_prefix ON storage.objects;
DROP TRIGGER IF EXISTS enforce_bucket_name_length_trigger ON storage.buckets;
DROP TRIGGER IF EXISTS trg_sales_sales_quotation_audit ON sales.sales_quotation;
DROP TRIGGER IF EXISTS trg_sales_item_category_audit ON sales.item_category;
DROP TRIGGER IF EXISTS trg_sales_item_audit ON sales.item;
DROP TRIGGER IF EXISTS trg_sales_invoice_pdf_audit ON sales.invoice_pdf;
DROP TRIGGER IF EXISTS trg_sales_customer_audit ON sales.customer;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.shipping_header;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.shipping_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.sales_quotation_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.sales_quotation;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.return_header;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.return_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.order_header;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.order_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.item_uom;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.item_price_master;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.item_category;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.item;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.invoice_pdf;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.customer_payment_term;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.customer_contact;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.customer_address;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.customer;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.billing_header;
DROP TRIGGER IF EXISTS trg_require_reason_code ON sales.billing_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.shipping_header;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.shipping_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.sales_quotation_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.sales_quotation;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.return_header;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.return_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.order_header;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.order_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.item_uom;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.item_price_master;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.item_category;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.item;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.invoice_pdf;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.customer_payment_term;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.customer_contact;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.customer_address;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.customer;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.billing_header;
DROP TRIGGER IF EXISTS trg_audit_iud ON sales.billing_detail;
DROP TRIGGER IF EXISTS tr_check_filters ON realtime.subscription;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.supplier_payment_term;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.supplier_master;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.supplier_item_price;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.supplier_contact;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.supplier_address;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_three_way_match;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_requisition_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_requisition;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_receipt_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_receipt;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_quotation_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_quotation;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_order_header;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_order_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_invoice_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON purchase.purchase_invoice;
DROP TRIGGER IF EXISTS trg_purchase_supplier_item_price_audit ON purchase.supplier_item_price;
DROP TRIGGER IF EXISTS trg_purchase_purchase_three_way_match_audit ON purchase.purchase_three_way_match;
DROP TRIGGER IF EXISTS trg_purchase_purchase_requisition_audit ON purchase.purchase_requisition;
DROP TRIGGER IF EXISTS trg_purchase_purchase_quotation_audit ON purchase.purchase_quotation;
DROP TRIGGER IF EXISTS trg_purchase_purchase_invoice_audit ON purchase.purchase_invoice;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.supplier_payment_term;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.supplier_master;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.supplier_item_price;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.supplier_contact;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.supplier_address;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_three_way_match;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_requisition_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_requisition;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_receipt_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_receipt;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_quotation_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_quotation;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_order_header;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_order_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_invoice_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON purchase.purchase_invoice;
DROP TRIGGER IF EXISTS trg_sales_shipping_detail_iud ON public.v_sales_shipping_detail;
DROP TRIGGER IF EXISTS trg_sales_sales_quotation_iud ON public.v_sales_sales_quotation;
DROP TRIGGER IF EXISTS trg_sales_sales_quotation_detail_iud ON public.v_sales_sales_quotation_detail;
DROP TRIGGER IF EXISTS trg_sales_return_detail_iud ON public.v_sales_return_detail;
DROP TRIGGER IF EXISTS trg_sales_order_detail_iud ON public.v_sales_order_detail;
DROP TRIGGER IF EXISTS trg_sales_item_uom_iud ON public.v_sales_item_uom;
DROP TRIGGER IF EXISTS trg_sales_item_iud ON public.v_sales_item;
DROP TRIGGER IF EXISTS trg_sales_item_category_iud ON public.v_sales_item_category;
DROP TRIGGER IF EXISTS trg_sales_invoice_pdf_iud ON public.v_sales_invoice_pdf;
DROP TRIGGER IF EXISTS trg_sales_customer_payment_term_iud ON public.v_sales_customer_payment_term;
DROP TRIGGER IF EXISTS trg_sales_customer_iud ON public.v_sales_customer;
DROP TRIGGER IF EXISTS trg_sales_customer_contact_iud ON public.v_sales_customer_contact;
DROP TRIGGER IF EXISTS trg_sales_customer_address_iud ON public.v_sales_customer_address;
DROP TRIGGER IF EXISTS trg_sales_billing_detail_iud ON public.v_sales_billing_detail;
DROP TRIGGER IF EXISTS trg_purchase_supplier_payment_term_iud ON public.v_purchase_supplier_payment_term;
DROP TRIGGER IF EXISTS trg_purchase_supplier_item_price_iud ON public.v_purchase_supplier_item_price;
DROP TRIGGER IF EXISTS trg_purchase_supplier_contact_iud ON public.v_purchase_supplier_contact;
DROP TRIGGER IF EXISTS trg_purchase_supplier_address_iud ON public.v_purchase_supplier_address;
DROP TRIGGER IF EXISTS trg_purchase_purchase_three_way_match_iud ON public.v_purchase_purchase_three_way_match;
DROP TRIGGER IF EXISTS trg_purchase_purchase_requisition_iud ON public.v_purchase_purchase_requisition;
DROP TRIGGER IF EXISTS trg_purchase_purchase_requisition_detail_iud ON public.v_purchase_purchase_requisition_detail;
DROP TRIGGER IF EXISTS trg_purchase_purchase_quotation_iud ON public.v_purchase_purchase_quotation;
DROP TRIGGER IF EXISTS trg_purchase_purchase_quotation_detail_iud ON public.v_purchase_purchase_quotation_detail;
DROP TRIGGER IF EXISTS trg_purchase_purchase_order_detail_iud ON public.v_purchase_purchase_order_detail;
DROP TRIGGER IF EXISTS trg_purchase_purchase_invoice_iud ON public.v_purchase_purchase_invoice;
DROP TRIGGER IF EXISTS trg_purchase_purchase_invoice_detail_iud ON public.v_purchase_purchase_invoice_detail;
DROP TRIGGER IF EXISTS trg_manufacturing_yield_metric_iud ON public.v_manufacturing_yield_metric;
DROP TRIGGER IF EXISTS trg_manufacturing_work_order_iud ON public.v_manufacturing_work_order;
DROP TRIGGER IF EXISTS trg_manufacturing_routing_operation_iud ON public.v_manufacturing_routing_operation;
DROP TRIGGER IF EXISTS trg_manufacturing_mrp_run_iud ON public.v_manufacturing_mrp_run;
DROP TRIGGER IF EXISTS trg_manufacturing_mrp_requirement_iud ON public.v_manufacturing_mrp_requirement;
DROP TRIGGER IF EXISTS trg_manufacturing_mrp_allocation_iud ON public.v_manufacturing_mrp_allocation;
DROP TRIGGER IF EXISTS trg_manufacturing_mps_run_iud ON public.v_manufacturing_mps_run;
DROP TRIGGER IF EXISTS trg_manufacturing_mps_plan_iud ON public.v_manufacturing_mps_plan;
DROP TRIGGER IF EXISTS trg_manufacturing_manufacturing_cost_snapshot_iud ON public.v_manufacturing_manufacturing_cost_snapshot;
DROP TRIGGER IF EXISTS trg_manufacturing_bom_detail_iud ON public.v_manufacturing_bom_detail;
DROP TRIGGER IF EXISTS trg_inventory_warehouse_iud ON public.v_inventory_warehouse;
DROP TRIGGER IF EXISTS trg_inventory_stocktaking_result_iud ON public.v_inventory_stocktaking_result;
DROP TRIGGER IF EXISTS trg_inventory_stocktaking_plan_iud ON public.v_inventory_stocktaking_plan;
DROP TRIGGER IF EXISTS trg_inventory_stock_transfer_detail_iud ON public.v_inventory_stock_transfer_detail;
DROP TRIGGER IF EXISTS trg_inventory_stock_reservation_iud ON public.v_inventory_stock_reservation;
DROP TRIGGER IF EXISTS trg_inventory_stock_lot_iud ON public.v_inventory_stock_lot;
DROP TRIGGER IF EXISTS trg_inventory_stock_lot_balance_iud ON public.v_inventory_stock_lot_balance;
DROP TRIGGER IF EXISTS trg_inventory_stock_balance_iud ON public.v_inventory_stock_balance;
DROP TRIGGER IF EXISTS trg_inventory_inventory_valuation_iud ON public.v_inventory_inventory_valuation;
DROP TRIGGER IF EXISTS trg_hr_payroll_slip_iud ON public.v_hr_payroll_slip;
DROP TRIGGER IF EXISTS trg_hr_payroll_run_iud ON public.v_hr_payroll_run;
DROP TRIGGER IF EXISTS trg_hr_leave_request_iud ON public.v_hr_leave_request;
DROP TRIGGER IF EXISTS trg_hr_employment_contract_iud ON public.v_hr_employment_contract;
DROP TRIGGER IF EXISTS trg_hr_employee_iud ON public.v_hr_employee;
DROP TRIGGER IF EXISTS trg_hr_attendance_log_iud ON public.v_hr_attendance_log;
DROP TRIGGER IF EXISTS trg_finance_payment_iud ON public.v_finance_payment;
DROP TRIGGER IF EXISTS trg_finance_payment_allocation_iud ON public.v_finance_payment_allocation;
DROP TRIGGER IF EXISTS trg_finance_bank_statement_line_iud ON public.v_finance_bank_statement_line;
DROP TRIGGER IF EXISTS trg_finance_bank_account_iud ON public.v_finance_bank_account;
DROP TRIGGER IF EXISTS trg_core_status_history_iud ON public.v_core_status_history;
DROP TRIGGER IF EXISTS trg_core_posting_profile_iud ON public.v_core_posting_profile;
DROP TRIGGER IF EXISTS trg_core_payment_term_iud ON public.v_core_payment_term;
DROP TRIGGER IF EXISTS trg_core_journal_source_link_iud ON public.v_core_journal_source_link;
DROP TRIGGER IF EXISTS trg_core_company_permission_iud ON public.v_core_company_permission;
DROP TRIGGER IF EXISTS trg_core_company_license_iud ON public.v_core_company_license;
DROP TRIGGER IF EXISTS trg_core_company_iud ON public.v_core_company;
DROP TRIGGER IF EXISTS trg_core_audit_trail_iud ON public.v_core_audit_trail;
DROP TRIGGER IF EXISTS trg_ops_job_queue_touch ON ops.ops_job_queue;
DROP TRIGGER IF EXISTS trg_enqueue_business_approval ON ops.business_event;
DROP TRIGGER IF EXISTS t_after_job_result ON ops.ops_job_result;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.yield_metric;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.work_order;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.routing_operation;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.routing_header;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.process_master;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.mrp_run;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.mrp_requirement;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.mrp_allocation;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.mps_run;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.mps_plan;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.manufacturing_execution_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.manufacturing_execution;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.manufacturing_cost_snapshot;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.bom_header;
DROP TRIGGER IF EXISTS trg_require_reason_code ON manufacturing.bom_detail;
DROP TRIGGER IF EXISTS trg_manufacturing_yield_metric_audit ON manufacturing.yield_metric;
DROP TRIGGER IF EXISTS trg_manufacturing_work_order_audit ON manufacturing.work_order;
DROP TRIGGER IF EXISTS trg_manufacturing_mrp_run_audit ON manufacturing.mrp_run;
DROP TRIGGER IF EXISTS trg_manufacturing_mps_run_audit ON manufacturing.mps_run;
DROP TRIGGER IF EXISTS trg_manufacturing_manufacturing_cost_snapshot_audit ON manufacturing.manufacturing_cost_snapshot;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.yield_metric;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.work_order;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.routing_operation;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.routing_header;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.process_master;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.mrp_run;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.mrp_requirement;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.mrp_allocation;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.mps_run;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.mps_plan;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.manufacturing_execution_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.manufacturing_execution;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.manufacturing_cost_snapshot;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.bom_header;
DROP TRIGGER IF EXISTS trg_audit_iud ON manufacturing.bom_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.warehouse;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.storage_location;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.stocktaking_result;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.stocktaking_plan;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.stock_transfer_header;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.stock_transfer_detail;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.stock_transaction;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.stock_reservation;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.stock_lot_balance;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.stock_lot;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.stock_bin;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.stock_balance;
DROP TRIGGER IF EXISTS trg_require_reason_code ON inventory.inventory_valuation;
DROP TRIGGER IF EXISTS trg_inventory_warehouse_audit ON inventory.warehouse;
DROP TRIGGER IF EXISTS trg_inventory_stocktaking_result_audit ON inventory.stocktaking_result;
DROP TRIGGER IF EXISTS trg_inventory_stocktaking_plan_audit ON inventory.stocktaking_plan;
DROP TRIGGER IF EXISTS trg_inventory_stock_reservation_audit ON inventory.stock_reservation;
DROP TRIGGER IF EXISTS trg_inventory_stock_lot_balance_audit ON inventory.stock_lot_balance;
DROP TRIGGER IF EXISTS trg_inventory_stock_lot_audit ON inventory.stock_lot;
DROP TRIGGER IF EXISTS trg_inventory_stock_balance_audit ON inventory.stock_balance;
DROP TRIGGER IF EXISTS trg_inventory_inventory_valuation_audit ON inventory.inventory_valuation;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.warehouse;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.storage_location;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.stocktaking_result;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.stocktaking_plan;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.stock_transfer_header;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.stock_transfer_detail;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.stock_transaction;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.stock_reservation;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.stock_lot_balance;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.stock_lot;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.stock_bin;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.stock_balance;
DROP TRIGGER IF EXISTS trg_audit_iud ON inventory.inventory_valuation;
DROP TRIGGER IF EXISTS trg_require_reason_code ON hr.payroll_slip;
DROP TRIGGER IF EXISTS trg_require_reason_code ON hr.payroll_run;
DROP TRIGGER IF EXISTS trg_require_reason_code ON hr.leave_type;
DROP TRIGGER IF EXISTS trg_require_reason_code ON hr.leave_request;
DROP TRIGGER IF EXISTS trg_require_reason_code ON hr.hr_position;
DROP TRIGGER IF EXISTS trg_require_reason_code ON hr.hr_department;
DROP TRIGGER IF EXISTS trg_require_reason_code ON hr.employment_contract;
DROP TRIGGER IF EXISTS trg_require_reason_code ON hr.employee;
DROP TRIGGER IF EXISTS trg_require_reason_code ON hr.attendance_log;
DROP TRIGGER IF EXISTS trg_hr_payroll_run_audit ON hr.payroll_run;
DROP TRIGGER IF EXISTS trg_hr_leave_request_audit ON hr.leave_request;
DROP TRIGGER IF EXISTS trg_hr_employment_contract_audit ON hr.employment_contract;
DROP TRIGGER IF EXISTS trg_hr_employee_audit ON hr.employee;
DROP TRIGGER IF EXISTS trg_hr_attendance_log_audit ON hr.attendance_log;
DROP TRIGGER IF EXISTS trg_audit_iud ON hr.payroll_slip;
DROP TRIGGER IF EXISTS trg_audit_iud ON hr.payroll_run;
DROP TRIGGER IF EXISTS trg_audit_iud ON hr.leave_type;
DROP TRIGGER IF EXISTS trg_audit_iud ON hr.leave_request;
DROP TRIGGER IF EXISTS trg_audit_iud ON hr.hr_position;
DROP TRIGGER IF EXISTS trg_audit_iud ON hr.hr_department;
DROP TRIGGER IF EXISTS trg_audit_iud ON hr.employment_contract;
DROP TRIGGER IF EXISTS trg_audit_iud ON hr.employee;
DROP TRIGGER IF EXISTS trg_audit_iud ON hr.attendance_log;
DROP TRIGGER IF EXISTS trg_require_reason_code ON finance.payment_allocation;
DROP TRIGGER IF EXISTS trg_require_reason_code ON finance.payment;
DROP TRIGGER IF EXISTS trg_require_reason_code ON finance.bank_statement_line;
DROP TRIGGER IF EXISTS trg_require_reason_code ON finance.bank_statement_header;
DROP TRIGGER IF EXISTS trg_require_reason_code ON finance.bank_account;
DROP TRIGGER IF EXISTS trg_finance_payment_audit ON finance.payment;
DROP TRIGGER IF EXISTS trg_finance_bank_account_audit ON finance.bank_account;
DROP TRIGGER IF EXISTS trg_audit_iud ON finance.payment_allocation;
DROP TRIGGER IF EXISTS trg_audit_iud ON finance.payment;
DROP TRIGGER IF EXISTS trg_audit_iud ON finance.bank_statement_line;
DROP TRIGGER IF EXISTS trg_audit_iud ON finance.bank_statement_header;
DROP TRIGGER IF EXISTS trg_audit_iud ON finance.bank_account;
DROP TRIGGER IF EXISTS trg_core_status_history_audit ON core.status_history;
DROP TRIGGER IF EXISTS trg_core_posting_profile_audit ON core.posting_profile;
DROP TRIGGER IF EXISTS trg_core_company_permission_audit ON core.company_permission;
DROP TRIGGER IF EXISTS trg_core_company_license_audit ON core.company_license;
DROP TRIGGER IF EXISTS trg_core_company_audit ON core.company;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.user_permissions;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.uom_conversion;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.uom;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.sync_queue;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.status_master;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.status_history;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.posting_profile;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.permissions;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.permission_groups;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.permission_group_permissions;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.payment_term;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.payment_method;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.login_history;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.license_master;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.journal_source_link;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.journal_lines;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.journal_entries;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.entity_attribute_value;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.entity_attribute_def;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.document_sequence;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.company_users;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.company_permission;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.company_license;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.company;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.audit_trail_2026_07;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.audit_trail_2026_06;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.audit_trail_2026_05;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.audit_trail_2026_04;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.audit_trail_2026_03;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.audit_trail_2026_02;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.audit_trail_2026_01;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.audit_trail_2025_12;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.audit_entity_pk_map;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.app_user;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.accounts;
DROP TRIGGER IF EXISTS trg_audit_iud ON core.accounting_period;
DROP TRIGGER IF EXISTS trg_enqueue_schema_ai_review ON ci.schema_change_request;
DROP TRIGGER IF EXISTS trg_audit_schema_change_transitions ON ci.schema_change_request;
DROP TRIGGER IF EXISTS trg_set_policy_and_severity ON audit.approval_request;
DROP TRIGGER IF EXISTS trg_policy_rollout_touch ON approval.policy_rollout;
DROP TRIGGER IF EXISTS trg_audit_alert_to_ai_event ON analytics.audit_alert_event;
DROP TRIGGER IF EXISTS trg_ai_job_apply_master ON analytics.ai_job;
DROP INDEX IF EXISTS system.ix_exec_run_request_pick;
DROP INDEX IF EXISTS system.ix_ai_task_pick;
DROP INDEX IF EXISTS system.ix_ai_signal_pick;
DROP INDEX IF EXISTS storage.vector_indexes_name_bucket_id_idx;
DROP INDEX IF EXISTS storage.objects_bucket_id_level_idx;
DROP INDEX IF EXISTS storage.name_prefix_search;
DROP INDEX IF EXISTS storage.idx_prefixes_lower_name;
DROP INDEX IF EXISTS storage.idx_objects_lower_name;
DROP INDEX IF EXISTS storage.idx_objects_bucket_id_name;
DROP INDEX IF EXISTS storage.idx_name_bucket_level_unique;
DROP INDEX IF EXISTS storage.idx_multipart_uploads_list;
DROP INDEX IF EXISTS storage.buckets_analytics_unique_name_idx;
DROP INDEX IF EXISTS storage.bucketid_objname;
DROP INDEX IF EXISTS storage.bname;
DROP INDEX IF EXISTS sales.idx_shipping_revision_shipping;
DROP INDEX IF EXISTS sales.idx_shipping_revision_company;
DROP INDEX IF EXISTS sales.idx_qol_company;
DROP INDEX IF EXISTS sales.idx_item_price_item;
DROP INDEX IF EXISTS sales.idx_customer_contact_customer;
DROP INDEX IF EXISTS sales.idx_customer_address_customer;
DROP INDEX IF EXISTS realtime.subscription_subscription_id_entity_filters_key;
DROP INDEX IF EXISTS realtime.messages_inserted_at_topic_index;
DROP INDEX IF EXISTS realtime.ix_realtime_subscription_entity;
DROP INDEX IF EXISTS purchase.idx_supplier_contact_supplier;
DROP INDEX IF EXISTS purchase.idx_supplier_address_supplier;
DROP INDEX IF EXISTS ops.ux_ops_send_idempotent;
DROP INDEX IF EXISTS ops.ix_ops_job_result_job_id;
DROP INDEX IF EXISTS ops.ix_ops_job_result_job;
DROP INDEX IF EXISTS ops.ix_ops_job_queue_pick;
DROP INDEX IF EXISTS ops.ix_ops_job_queue_locked;
DROP INDEX IF EXISTS ops.ix_ops_job_queue_business;
DROP INDEX IF EXISTS ops.ix_notification_pick;
DROP INDEX IF EXISTS ops.ix_notification_outbox_pick;
DROP INDEX IF EXISTS ops.idx_ops_job_pending;
DROP INDEX IF EXISTS notify.idx_notify_log_retry;
DROP INDEX IF EXISTS notify.idx_notify_log_created_at;
DROP INDEX IF EXISTS notify.idx_notify_log_company_status;
DROP INDEX IF EXISTS notify.idx_audit_trail_company_created;
DROP INDEX IF EXISTS notify.idx_audit_company_created;
DROP INDEX IF EXISTS notify.idx_approval_request_company_status;
DROP INDEX IF EXISTS notify.idx_approval_company_status;
DROP INDEX IF EXISTS notify.idx_ai_event_company_status;
DROP INDEX IF EXISTS media.ix_asset_link_primary;
DROP INDEX IF EXISTS media.ix_asset_link_entity_role;
DROP INDEX IF EXISTS inventory.idx_stock_tx_item_time;
DROP INDEX IF EXISTS integration.idx_siem_queue_status;
DROP INDEX IF EXISTS integration.idx_audit_export_queue_status;
DROP INDEX IF EXISTS core.idx_sync_queue_status;
DROP INDEX IF EXISTS core.idx_status_history_entity;
DROP INDEX IF EXISTS core.idx_audit_impact_rule_lookup;
DROP INDEX IF EXISTS core.idx_audit_trail_entity_time;
DROP INDEX IF EXISTS core.idx_audit_trail_entity;
DROP INDEX IF EXISTS core.idx_audit_trail_company_time;
DROP INDEX IF EXISTS core.idx_audit_trail_company_entity;
DROP INDEX IF EXISTS ci.uq_escalation_outbox_queued;
DROP INDEX IF EXISTS ci.idx_schema_ai_review_job_status;
DROP INDEX IF EXISTS ci.idx_ops_notification_pending;
DROP INDEX IF EXISTS billing.uq_invoice_retry_once;
DROP INDEX IF EXISTS billing.idx_invoice_send_audit_invoice;
DROP INDEX IF EXISTS billing.idx_checkout_invoice;
DROP INDEX IF EXISTS auth.users_is_anonymous_idx;
DROP INDEX IF EXISTS auth.users_instance_id_idx;
DROP INDEX IF EXISTS auth.users_instance_id_email_idx;
DROP INDEX IF EXISTS auth.users_email_partial_key;
DROP INDEX IF EXISTS auth.user_id_created_at_idx;
DROP INDEX IF EXISTS auth.unique_phone_factor_per_user;
DROP INDEX IF EXISTS auth.sso_providers_resource_id_pattern_idx;
DROP INDEX IF EXISTS auth.sso_providers_resource_id_idx;
DROP INDEX IF EXISTS auth.sso_domains_sso_provider_id_idx;
DROP INDEX IF EXISTS auth.sso_domains_domain_idx;
DROP INDEX IF EXISTS auth.sessions_user_id_idx;
DROP INDEX IF EXISTS auth.sessions_oauth_client_id_idx;
DROP INDEX IF EXISTS auth.sessions_not_after_idx;
DROP INDEX IF EXISTS auth.saml_relay_states_sso_provider_id_idx;
DROP INDEX IF EXISTS auth.saml_relay_states_for_email_idx;
DROP INDEX IF EXISTS auth.saml_relay_states_created_at_idx;
DROP INDEX IF EXISTS auth.saml_providers_sso_provider_id_idx;
DROP INDEX IF EXISTS auth.refresh_tokens_updated_at_idx;
DROP INDEX IF EXISTS auth.refresh_tokens_session_id_revoked_idx;
DROP INDEX IF EXISTS auth.refresh_tokens_parent_idx;
DROP INDEX IF EXISTS auth.refresh_tokens_instance_id_user_id_idx;
DROP INDEX IF EXISTS auth.refresh_tokens_instance_id_idx;
DROP INDEX IF EXISTS auth.recovery_token_idx;
DROP INDEX IF EXISTS auth.reauthentication_token_idx;
DROP INDEX IF EXISTS auth.one_time_tokens_user_id_token_type_key;
DROP INDEX IF EXISTS auth.one_time_tokens_token_hash_hash_idx;
DROP INDEX IF EXISTS auth.one_time_tokens_relates_to_hash_idx;
DROP INDEX IF EXISTS auth.oauth_consents_user_order_idx;
DROP INDEX IF EXISTS auth.oauth_consents_active_user_client_idx;
DROP INDEX IF EXISTS auth.oauth_consents_active_client_idx;
DROP INDEX IF EXISTS auth.oauth_clients_deleted_at_idx;
DROP INDEX IF EXISTS auth.oauth_auth_pending_exp_idx;
DROP INDEX IF EXISTS auth.mfa_factors_user_id_idx;
DROP INDEX IF EXISTS auth.mfa_factors_user_friendly_name_unique;
DROP INDEX IF EXISTS auth.mfa_challenge_created_at_idx;
DROP INDEX IF EXISTS auth.idx_user_id_auth_method;
DROP INDEX IF EXISTS auth.idx_oauth_client_states_created_at;
DROP INDEX IF EXISTS auth.idx_auth_code;
DROP INDEX IF EXISTS auth.identities_user_id_idx;
DROP INDEX IF EXISTS auth.identities_email_idx;
DROP INDEX IF EXISTS auth.flow_state_created_at_idx;
DROP INDEX IF EXISTS auth.factor_id_created_at_idx;
DROP INDEX IF EXISTS auth.email_change_token_new_idx;
DROP INDEX IF EXISTS auth.email_change_token_current_idx;
DROP INDEX IF EXISTS auth.confirmation_token_idx;
DROP INDEX IF EXISTS auth.audit_logs_instance_id_idx;
DROP INDEX IF EXISTS audit.ux_audit_event_unique;
DROP INDEX IF EXISTS audit.idx_ng_event_scope_severity;
DROP INDEX IF EXISTS audit.idx_ng_event_quarantined;
DROP INDEX IF EXISTS audit.idx_ng_event_event_key;
DROP INDEX IF EXISTS audit.idx_ng_event_company_time;
DROP INDEX IF EXISTS audit.idx_entity_status_history_entity;
DROP INDEX IF EXISTS audit.idx_entity_status_history_company;
DROP INDEX IF EXISTS audit.idx_approval_request_status;
DROP INDEX IF EXISTS audit.idx_approval_request_order;
DROP INDEX IF EXISTS audit.idx_approval_request_domain_entity;
DROP INDEX IF EXISTS audit.idx_approval_request_company;
DROP INDEX IF EXISTS audit.idx_approval_log_request;
DROP INDEX IF EXISTS approval.idx_saas_sub_company;
DROP INDEX IF EXISTS approval.idx_rework_open;
DROP INDEX IF EXISTS approval.idx_policy_eval_policy_time;
DROP INDEX IF EXISTS approval.idx_jsox_evidence_company_time;
DROP INDEX IF EXISTS approval.idx_invoice_delivery_invoice;
DROP INDEX IF EXISTS approval.idx_ai_prop_request;
DROP INDEX IF EXISTS analytics.ux_alert_event_dedupe;
DROP INDEX IF EXISTS analytics.ix_audit_alert_rule_company;
DROP INDEX IF EXISTS analytics.ix_alert_notification_status;
DROP INDEX IF EXISTS analytics.idx_notification_pending;
DROP INDEX IF EXISTS analytics.idx_fact_metric_lookup;
DROP INDEX IF EXISTS analytics.idx_ai_job_pending;
DROP INDEX IF EXISTS analytics.idx_ai_event_pending;
ALTER TABLE IF EXISTS ONLY tenant.license_master DROP CONSTRAINT IF EXISTS license_master_pkey;
ALTER TABLE IF EXISTS ONLY tenant.company DROP CONSTRAINT IF EXISTS company_pkey;
ALTER TABLE IF EXISTS ONLY tenant.company_license DROP CONSTRAINT IF EXISTS company_license_pkey;
ALTER TABLE IF EXISTS ONLY tenant.company DROP CONSTRAINT IF EXISTS company_company_code_key;
ALTER TABLE IF EXISTS ONLY system.screen_rule DROP CONSTRAINT IF EXISTS screen_rule_pkey;
ALTER TABLE IF EXISTS ONLY system.screen_master DROP CONSTRAINT IF EXISTS screen_master_pkey;
ALTER TABLE IF EXISTS ONLY system.screen_action_map DROP CONSTRAINT IF EXISTS screen_action_map_pkey;
ALTER TABLE IF EXISTS ONLY system.runtime_killswitch DROP CONSTRAINT IF EXISTS runtime_killswitch_pkey;
ALTER TABLE IF EXISTS ONLY system.role_screen_permission DROP CONSTRAINT IF EXISTS role_screen_permission_pkey;
ALTER TABLE IF EXISTS ONLY system.role_def DROP CONSTRAINT IF EXISTS role_def_pkey;
ALTER TABLE IF EXISTS ONLY system.operation_type_def DROP CONSTRAINT IF EXISTS operation_type_def_pkey;
ALTER TABLE IF EXISTS ONLY system.operation_log DROP CONSTRAINT IF EXISTS operation_log_pkey;
ALTER TABLE IF EXISTS ONLY system.notification_subscription DROP CONSTRAINT IF EXISTS notification_subscription_pkey;
ALTER TABLE IF EXISTS ONLY system.notification_endpoint DROP CONSTRAINT IF EXISTS notification_endpoint_pkey;
ALTER TABLE IF EXISTS ONLY system.module_def DROP CONSTRAINT IF EXISTS module_def_pkey;
ALTER TABLE IF EXISTS ONLY system.loop_tick_log DROP CONSTRAINT IF EXISTS loop_tick_log_pkey;
ALTER TABLE IF EXISTS ONLY system.loop_sla_stat DROP CONSTRAINT IF EXISTS loop_sla_stat_pkey;
ALTER TABLE IF EXISTS ONLY system.loop_config DROP CONSTRAINT IF EXISTS loop_config_pkey;
ALTER TABLE IF EXISTS ONLY system.loop_autotune_rule DROP CONSTRAINT IF EXISTS loop_autotune_rule_pkey;
ALTER TABLE IF EXISTS ONLY system.loop_autotune_rule DROP CONSTRAINT IF EXISTS loop_autotune_rule_loop_code_key;
ALTER TABLE IF EXISTS ONLY system.function_def DROP CONSTRAINT IF EXISTS function_def_pkey;
ALTER TABLE IF EXISTS ONLY system.exec_run_request DROP CONSTRAINT IF EXISTS exec_run_request_pkey;
ALTER TABLE IF EXISTS ONLY system.exec_command DROP CONSTRAINT IF EXISTS exec_command_pkey;
ALTER TABLE IF EXISTS ONLY system.db_session DROP CONSTRAINT IF EXISTS db_session_pkey;
ALTER TABLE IF EXISTS ONLY system.business_ops_map DROP CONSTRAINT IF EXISTS business_ops_map_pkey;
ALTER TABLE IF EXISTS ONLY system.business_finalize_event DROP CONSTRAINT IF EXISTS business_finalize_event_pkey;
ALTER TABLE IF EXISTS ONLY system.approval_step_def DROP CONSTRAINT IF EXISTS approval_step_def_pkey;
ALTER TABLE IF EXISTS ONLY system.approval_request DROP CONSTRAINT IF EXISTS approval_request_pkey;
ALTER TABLE IF EXISTS ONLY system.approval_flow_def DROP CONSTRAINT IF EXISTS approval_flow_def_pkey;
ALTER TABLE IF EXISTS ONLY system.approval_finalize_rule DROP CONSTRAINT IF EXISTS approval_finalize_rule_pkey;
ALTER TABLE IF EXISTS ONLY system.approval_exec_map DROP CONSTRAINT IF EXISTS approval_exec_map_pkey;
ALTER TABLE IF EXISTS ONLY system.approval_action_log DROP CONSTRAINT IF EXISTS approval_action_log_pkey;
ALTER TABLE IF EXISTS ONLY system.ai_task_run DROP CONSTRAINT IF EXISTS ai_task_run_pkey;
ALTER TABLE IF EXISTS ONLY system.ai_task DROP CONSTRAINT IF EXISTS ai_task_pkey;
ALTER TABLE IF EXISTS ONLY system.ai_signal DROP CONSTRAINT IF EXISTS ai_signal_pkey;
ALTER TABLE IF EXISTS ONLY system.ai_agent DROP CONSTRAINT IF EXISTS ai_agent_pkey;
ALTER TABLE IF EXISTS ONLY system.action_approval_map DROP CONSTRAINT IF EXISTS action_approval_map_pkey;
ALTER TABLE IF EXISTS ONLY storage.vector_indexes DROP CONSTRAINT IF EXISTS vector_indexes_pkey;
ALTER TABLE IF EXISTS ONLY storage.s3_multipart_uploads DROP CONSTRAINT IF EXISTS s3_multipart_uploads_pkey;
ALTER TABLE IF EXISTS ONLY storage.s3_multipart_uploads_parts DROP CONSTRAINT IF EXISTS s3_multipart_uploads_parts_pkey;
ALTER TABLE IF EXISTS ONLY storage.prefixes DROP CONSTRAINT IF EXISTS prefixes_pkey;
ALTER TABLE IF EXISTS ONLY storage.objects DROP CONSTRAINT IF EXISTS objects_pkey;
ALTER TABLE IF EXISTS ONLY storage.migrations DROP CONSTRAINT IF EXISTS migrations_pkey;
ALTER TABLE IF EXISTS ONLY storage.migrations DROP CONSTRAINT IF EXISTS migrations_name_key;
ALTER TABLE IF EXISTS ONLY storage.buckets_vectors DROP CONSTRAINT IF EXISTS buckets_vectors_pkey;
ALTER TABLE IF EXISTS ONLY storage.buckets DROP CONSTRAINT IF EXISTS buckets_pkey;
ALTER TABLE IF EXISTS ONLY storage.buckets_analytics DROP CONSTRAINT IF EXISTS buckets_analytics_pkey;
ALTER TABLE IF EXISTS ONLY sales.shipping_revision DROP CONSTRAINT IF EXISTS shipping_revision_shipping_id_revision_no_key;
ALTER TABLE IF EXISTS ONLY sales.shipping_revision DROP CONSTRAINT IF EXISTS shipping_revision_pkey;
ALTER TABLE IF EXISTS ONLY sales.shipping_header DROP CONSTRAINT IF EXISTS shipping_header_pkey;
ALTER TABLE IF EXISTS ONLY sales.shipping_header DROP CONSTRAINT IF EXISTS shipping_header_company_id_shipping_no_key;
ALTER TABLE IF EXISTS ONLY sales.shipping_detail DROP CONSTRAINT IF EXISTS shipping_detail_shipping_id_line_no_key;
ALTER TABLE IF EXISTS ONLY sales.shipping_detail DROP CONSTRAINT IF EXISTS shipping_detail_pkey;
ALTER TABLE IF EXISTS ONLY sales.sales_quotation DROP CONSTRAINT IF EXISTS sales_quotation_pkey;
ALTER TABLE IF EXISTS ONLY sales.sales_quotation_detail DROP CONSTRAINT IF EXISTS sales_quotation_detail_sales_quotation_id_line_no_key;
ALTER TABLE IF EXISTS ONLY sales.sales_quotation_detail DROP CONSTRAINT IF EXISTS sales_quotation_detail_pkey;
ALTER TABLE IF EXISTS ONLY sales.sales_quotation DROP CONSTRAINT IF EXISTS sales_quotation_company_id_quotation_no_key;
ALTER TABLE IF EXISTS ONLY sales.return_header DROP CONSTRAINT IF EXISTS return_header_pkey;
ALTER TABLE IF EXISTS ONLY sales.return_header DROP CONSTRAINT IF EXISTS return_header_company_id_return_no_key;
ALTER TABLE IF EXISTS ONLY sales.return_detail DROP CONSTRAINT IF EXISTS return_detail_return_id_line_no_key;
ALTER TABLE IF EXISTS ONLY sales.return_detail DROP CONSTRAINT IF EXISTS return_detail_pkey;
ALTER TABLE IF EXISTS ONLY sales.quotation_order_link DROP CONSTRAINT IF EXISTS quotation_order_link_quotation_id_order_id_key;
ALTER TABLE IF EXISTS ONLY sales.quotation_order_link DROP CONSTRAINT IF EXISTS quotation_order_link_pkey;
ALTER TABLE IF EXISTS ONLY sales.order_header DROP CONSTRAINT IF EXISTS order_header_pkey;
ALTER TABLE IF EXISTS ONLY sales.order_header DROP CONSTRAINT IF EXISTS order_header_company_id_order_no_key;
ALTER TABLE IF EXISTS ONLY sales.order_detail DROP CONSTRAINT IF EXISTS order_detail_pkey;
ALTER TABLE IF EXISTS ONLY sales.order_detail DROP CONSTRAINT IF EXISTS order_detail_order_id_line_no_key;
ALTER TABLE IF EXISTS ONLY sales.item_uom DROP CONSTRAINT IF EXISTS item_uom_pkey;
ALTER TABLE IF EXISTS ONLY sales.item_uom DROP CONSTRAINT IF EXISTS item_uom_item_id_uom_code_usage_type_key;
ALTER TABLE IF EXISTS ONLY sales.item_price_master DROP CONSTRAINT IF EXISTS item_price_master_pkey;
ALTER TABLE IF EXISTS ONLY sales.item DROP CONSTRAINT IF EXISTS item_pkey;
ALTER TABLE IF EXISTS ONLY sales.item DROP CONSTRAINT IF EXISTS item_company_id_item_code_key;
ALTER TABLE IF EXISTS ONLY sales.item_category DROP CONSTRAINT IF EXISTS item_category_pkey;
ALTER TABLE IF EXISTS ONLY sales.item_category DROP CONSTRAINT IF EXISTS item_category_company_id_category_code_key;
ALTER TABLE IF EXISTS ONLY sales.invoice_pdf DROP CONSTRAINT IF EXISTS invoice_pdf_pkey;
ALTER TABLE IF EXISTS ONLY sales.customer DROP CONSTRAINT IF EXISTS customer_pkey;
ALTER TABLE IF EXISTS ONLY sales.customer_payment_term DROP CONSTRAINT IF EXISTS customer_payment_term_pkey;
ALTER TABLE IF EXISTS ONLY sales.customer_payment_term DROP CONSTRAINT IF EXISTS customer_payment_term_customer_id_valid_from_key;
ALTER TABLE IF EXISTS ONLY sales.customer_contact DROP CONSTRAINT IF EXISTS customer_contact_pkey;
ALTER TABLE IF EXISTS ONLY sales.customer DROP CONSTRAINT IF EXISTS customer_company_id_customer_code_key;
ALTER TABLE IF EXISTS ONLY sales.customer_address DROP CONSTRAINT IF EXISTS customer_address_pkey;
ALTER TABLE IF EXISTS ONLY sales.billing_header DROP CONSTRAINT IF EXISTS billing_header_pkey;
ALTER TABLE IF EXISTS ONLY sales.billing_header DROP CONSTRAINT IF EXISTS billing_header_company_id_billing_no_key;
ALTER TABLE IF EXISTS ONLY sales.billing_detail DROP CONSTRAINT IF EXISTS billing_detail_pkey;
ALTER TABLE IF EXISTS ONLY sales.billing_detail DROP CONSTRAINT IF EXISTS billing_detail_billing_id_line_no_key;
ALTER TABLE IF EXISTS ONLY realtime.schema_migrations DROP CONSTRAINT IF EXISTS schema_migrations_pkey;
ALTER TABLE IF EXISTS ONLY realtime.subscription DROP CONSTRAINT IF EXISTS pk_subscription;
ALTER TABLE IF EXISTS ONLY realtime.messages DROP CONSTRAINT IF EXISTS messages_pkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_payment_term DROP CONSTRAINT IF EXISTS supplier_payment_term_supplier_id_valid_from_key;
ALTER TABLE IF EXISTS ONLY purchase.supplier_payment_term DROP CONSTRAINT IF EXISTS supplier_payment_term_pkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_master DROP CONSTRAINT IF EXISTS supplier_master_pkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_master DROP CONSTRAINT IF EXISTS supplier_master_company_id_supplier_code_key;
ALTER TABLE IF EXISTS ONLY purchase.supplier_item_price DROP CONSTRAINT IF EXISTS supplier_item_price_pkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_item_price DROP CONSTRAINT IF EXISTS supplier_item_price_company_id_supplier_id_item_id_valid_fr_key;
ALTER TABLE IF EXISTS ONLY purchase.supplier_contact DROP CONSTRAINT IF EXISTS supplier_contact_pkey;
ALTER TABLE IF EXISTS ONLY purchase.supplier_address DROP CONSTRAINT IF EXISTS supplier_address_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_three_way_match DROP CONSTRAINT IF EXISTS purchase_three_way_match_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_requisition DROP CONSTRAINT IF EXISTS purchase_requisition_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_requisition_detail DROP CONSTRAINT IF EXISTS purchase_requisition_detail_purchase_requisition_id_line_no_key;
ALTER TABLE IF EXISTS ONLY purchase.purchase_requisition_detail DROP CONSTRAINT IF EXISTS purchase_requisition_detail_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_requisition DROP CONSTRAINT IF EXISTS purchase_requisition_company_id_requisition_no_key;
ALTER TABLE IF EXISTS ONLY purchase.purchase_receipt DROP CONSTRAINT IF EXISTS purchase_receipt_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_receipt_detail DROP CONSTRAINT IF EXISTS purchase_receipt_detail_receipt_id_line_no_key;
ALTER TABLE IF EXISTS ONLY purchase.purchase_receipt_detail DROP CONSTRAINT IF EXISTS purchase_receipt_detail_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_quotation DROP CONSTRAINT IF EXISTS purchase_quotation_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_quotation_detail DROP CONSTRAINT IF EXISTS purchase_quotation_detail_purchase_quotation_id_line_no_key;
ALTER TABLE IF EXISTS ONLY purchase.purchase_quotation_detail DROP CONSTRAINT IF EXISTS purchase_quotation_detail_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_order_header DROP CONSTRAINT IF EXISTS purchase_order_header_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_order_header DROP CONSTRAINT IF EXISTS purchase_order_header_company_id_purchase_order_no_key;
ALTER TABLE IF EXISTS ONLY purchase.purchase_order_detail DROP CONSTRAINT IF EXISTS purchase_order_detail_purchase_order_id_line_no_key;
ALTER TABLE IF EXISTS ONLY purchase.purchase_order_detail DROP CONSTRAINT IF EXISTS purchase_order_detail_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_invoice DROP CONSTRAINT IF EXISTS purchase_invoice_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_invoice_detail DROP CONSTRAINT IF EXISTS purchase_invoice_detail_purchase_invoice_id_line_no_key;
ALTER TABLE IF EXISTS ONLY purchase.purchase_invoice_detail DROP CONSTRAINT IF EXISTS purchase_invoice_detail_pkey;
ALTER TABLE IF EXISTS ONLY purchase.purchase_invoice DROP CONSTRAINT IF EXISTS purchase_invoice_company_id_invoice_no_key;
ALTER TABLE IF EXISTS ONLY ops.send_fee_master DROP CONSTRAINT IF EXISTS send_fee_master_pkey;
ALTER TABLE IF EXISTS ONLY ops.send_fee_master DROP CONSTRAINT IF EXISTS send_fee_master_document_type_code_resend_type_code_key;
ALTER TABLE IF EXISTS ONLY ops.send_channel_master DROP CONSTRAINT IF EXISTS send_channel_master_pkey;
ALTER TABLE IF EXISTS ONLY ops.runtime_health DROP CONSTRAINT IF EXISTS runtime_health_pkey;
ALTER TABLE IF EXISTS ONLY ops.runtime_flag DROP CONSTRAINT IF EXISTS runtime_flag_pkey;
ALTER TABLE IF EXISTS ONLY ops.resend_type_master DROP CONSTRAINT IF EXISTS resend_type_master_pkey;
ALTER TABLE IF EXISTS ONLY ops.pdf_generate_queue DROP CONSTRAINT IF EXISTS pdf_generate_queue_pkey;
ALTER TABLE IF EXISTS ONLY ops.ops_job_result DROP CONSTRAINT IF EXISTS ops_job_result_pkey;
ALTER TABLE IF EXISTS ONLY ops.ops_job_queue DROP CONSTRAINT IF EXISTS ops_job_queue_pkey;
ALTER TABLE IF EXISTS ONLY ops.ops_idempotency DROP CONSTRAINT IF EXISTS ops_idempotency_pkey;
ALTER TABLE IF EXISTS ONLY ops.notification_outbox DROP CONSTRAINT IF EXISTS notification_outbox_pkey;
ALTER TABLE IF EXISTS ONLY ops.document_type_master DROP CONSTRAINT IF EXISTS document_type_master_pkey;
ALTER TABLE IF EXISTS ONLY ops.document_send_queue DROP CONSTRAINT IF EXISTS document_send_queue_pkey;
ALTER TABLE IF EXISTS ONLY ops.document_send_history DROP CONSTRAINT IF EXISTS document_send_history_pkey;
ALTER TABLE IF EXISTS ONLY ops.document_file DROP CONSTRAINT IF EXISTS document_file_pkey;
ALTER TABLE IF EXISTS ONLY ops.business_event DROP CONSTRAINT IF EXISTS business_event_pkey;
ALTER TABLE IF EXISTS ONLY ops.backup_log DROP CONSTRAINT IF EXISTS backup_log_pkey;
ALTER TABLE IF EXISTS ONLY ops.approval_rule DROP CONSTRAINT IF EXISTS approval_rule_pkey;
ALTER TABLE IF EXISTS ONLY ops.approval_rule DROP CONSTRAINT IF EXISTS approval_rule_domain_event_type_key;
ALTER TABLE IF EXISTS ONLY notify.notification_template DROP CONSTRAINT IF EXISTS notification_template_pkey;
ALTER TABLE IF EXISTS ONLY notify.notification_template DROP CONSTRAINT IF EXISTS notification_template_company_id_template_key_key;
ALTER TABLE IF EXISTS ONLY notify.notification_route DROP CONSTRAINT IF EXISTS notification_route_pkey;
ALTER TABLE IF EXISTS ONLY notify.notification_route DROP CONSTRAINT IF EXISTS notification_route_company_id_route_key_line_user_id_key;
ALTER TABLE IF EXISTS ONLY notify.notification_log DROP CONSTRAINT IF EXISTS notification_log_pkey;
ALTER TABLE IF EXISTS ONLY notify.audit_trail DROP CONSTRAINT IF EXISTS audit_trail_pkey;
ALTER TABLE IF EXISTS ONLY notify.approval_request DROP CONSTRAINT IF EXISTS approval_request_pkey;
ALTER TABLE IF EXISTS ONLY notify.approval_action_log DROP CONSTRAINT IF EXISTS approval_action_log_pkey;
ALTER TABLE IF EXISTS ONLY notify.ai_rule DROP CONSTRAINT IF EXISTS ai_rule_pkey;
ALTER TABLE IF EXISTS ONLY notify.ai_rule DROP CONSTRAINT IF EXISTS ai_rule_company_id_rule_key_key;
ALTER TABLE IF EXISTS ONLY notify.ai_event DROP CONSTRAINT IF EXISTS ai_event_pkey;
ALTER TABLE IF EXISTS ONLY media.asset DROP CONSTRAINT IF EXISTS asset_pkey;
ALTER TABLE IF EXISTS ONLY media.asset_link DROP CONSTRAINT IF EXISTS asset_link_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.yield_metric DROP CONSTRAINT IF EXISTS yield_metric_process_id_metric_date_key;
ALTER TABLE IF EXISTS ONLY manufacturing.yield_metric DROP CONSTRAINT IF EXISTS yield_metric_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.work_order DROP CONSTRAINT IF EXISTS work_order_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.work_order DROP CONSTRAINT IF EXISTS work_order_company_id_wo_no_key;
ALTER TABLE IF EXISTS ONLY manufacturing.routing_operation DROP CONSTRAINT IF EXISTS routing_operation_routing_id_operation_no_key;
ALTER TABLE IF EXISTS ONLY manufacturing.routing_operation DROP CONSTRAINT IF EXISTS routing_operation_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.routing_header DROP CONSTRAINT IF EXISTS routing_header_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.routing_header DROP CONSTRAINT IF EXISTS routing_header_company_id_item_id_version_key;
ALTER TABLE IF EXISTS ONLY manufacturing.process_master DROP CONSTRAINT IF EXISTS process_master_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.process_master DROP CONSTRAINT IF EXISTS process_master_company_id_process_code_key;
ALTER TABLE IF EXISTS ONLY manufacturing.mrp_run DROP CONSTRAINT IF EXISTS mrp_run_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mrp_requirement DROP CONSTRAINT IF EXISTS mrp_requirement_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mrp_allocation DROP CONSTRAINT IF EXISTS mrp_allocation_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mps_run DROP CONSTRAINT IF EXISTS mps_run_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.mps_plan DROP CONSTRAINT IF EXISTS mps_plan_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_execution DROP CONSTRAINT IF EXISTS manufacturing_execution_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_execution_detail DROP CONSTRAINT IF EXISTS manufacturing_execution_detail_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_cost_snapshot DROP CONSTRAINT IF EXISTS manufacturing_cost_snapshot_work_order_id_key;
ALTER TABLE IF EXISTS ONLY manufacturing.manufacturing_cost_snapshot DROP CONSTRAINT IF EXISTS manufacturing_cost_snapshot_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.bom_header DROP CONSTRAINT IF EXISTS bom_header_pkey;
ALTER TABLE IF EXISTS ONLY manufacturing.bom_header DROP CONSTRAINT IF EXISTS bom_header_company_id_parent_item_id_version_key;
ALTER TABLE IF EXISTS ONLY manufacturing.bom_detail DROP CONSTRAINT IF EXISTS bom_detail_pkey;
ALTER TABLE IF EXISTS ONLY inventory.warehouse DROP CONSTRAINT IF EXISTS warehouse_pkey;
ALTER TABLE IF EXISTS ONLY inventory.warehouse DROP CONSTRAINT IF EXISTS warehouse_company_id_warehouse_code_key;
ALTER TABLE IF EXISTS ONLY inventory.storage_location DROP CONSTRAINT IF EXISTS storage_location_pkey;
ALTER TABLE IF EXISTS ONLY inventory.storage_location DROP CONSTRAINT IF EXISTS storage_location_company_id_warehouse_id_location_code_key;
ALTER TABLE IF EXISTS ONLY inventory.stocktaking_result DROP CONSTRAINT IF EXISTS stocktaking_result_pkey;
ALTER TABLE IF EXISTS ONLY inventory.stocktaking_plan DROP CONSTRAINT IF EXISTS stocktaking_plan_pkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_header DROP CONSTRAINT IF EXISTS stock_transfer_header_pkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_header DROP CONSTRAINT IF EXISTS stock_transfer_header_company_id_transfer_no_key;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_detail DROP CONSTRAINT IF EXISTS stock_transfer_detail_stock_transfer_id_line_no_key;
ALTER TABLE IF EXISTS ONLY inventory.stock_transfer_detail DROP CONSTRAINT IF EXISTS stock_transfer_detail_pkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_transaction DROP CONSTRAINT IF EXISTS stock_transaction_pkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_reservation DROP CONSTRAINT IF EXISTS stock_reservation_pkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot DROP CONSTRAINT IF EXISTS stock_lot_pkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot DROP CONSTRAINT IF EXISTS stock_lot_company_id_item_id_lot_no_serial_no_key;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot_balance DROP CONSTRAINT IF EXISTS stock_lot_balance_pkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_lot_balance DROP CONSTRAINT IF EXISTS stock_lot_balance_company_id_bin_id_item_id_stock_lot_id_key;
ALTER TABLE IF EXISTS ONLY inventory.stock_bin DROP CONSTRAINT IF EXISTS stock_bin_pkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_bin DROP CONSTRAINT IF EXISTS stock_bin_company_id_location_id_bin_code_key;
ALTER TABLE IF EXISTS ONLY inventory.stock_balance DROP CONSTRAINT IF EXISTS stock_balance_pkey;
ALTER TABLE IF EXISTS ONLY inventory.stock_balance DROP CONSTRAINT IF EXISTS stock_balance_company_id_bin_id_item_id_key;
ALTER TABLE IF EXISTS ONLY inventory.inventory_valuation DROP CONSTRAINT IF EXISTS inventory_valuation_pkey;
ALTER TABLE IF EXISTS ONLY inventory.inventory_valuation DROP CONSTRAINT IF EXISTS inventory_valuation_company_id_item_id_valuation_date_key;
ALTER TABLE IF EXISTS ONLY integration.siem_endpoint DROP CONSTRAINT IF EXISTS siem_endpoint_pkey;
ALTER TABLE IF EXISTS ONLY integration.siem_delivery_queue DROP CONSTRAINT IF EXISTS siem_delivery_queue_pkey;
ALTER TABLE IF EXISTS ONLY integration.siem_delivery_queue DROP CONSTRAINT IF EXISTS siem_delivery_queue_endpoint_id_audit_trail_id_key;
ALTER TABLE IF EXISTS ONLY integration.integration_log DROP CONSTRAINT IF EXISTS integration_log_pkey;
ALTER TABLE IF EXISTS ONLY integration.integration_job DROP CONSTRAINT IF EXISTS integration_job_pkey;
ALTER TABLE IF EXISTS ONLY integration.external_system DROP CONSTRAINT IF EXISTS external_system_pkey;
ALTER TABLE IF EXISTS ONLY integration.external_system DROP CONSTRAINT IF EXISTS external_system_company_id_system_code_key;
ALTER TABLE IF EXISTS ONLY integration.audit_export_queue DROP CONSTRAINT IF EXISTS audit_export_queue_pkey;
ALTER TABLE IF EXISTS ONLY integration.api_credential DROP CONSTRAINT IF EXISTS api_credential_pkey;
ALTER TABLE IF EXISTS ONLY hr.payroll_slip DROP CONSTRAINT IF EXISTS payroll_slip_pkey;
ALTER TABLE IF EXISTS ONLY hr.payroll_slip DROP CONSTRAINT IF EXISTS payroll_slip_payroll_run_id_employee_id_key;
ALTER TABLE IF EXISTS ONLY hr.payroll_run DROP CONSTRAINT IF EXISTS payroll_run_pkey;
ALTER TABLE IF EXISTS ONLY hr.payroll_run DROP CONSTRAINT IF EXISTS payroll_run_company_id_pay_month_key;
ALTER TABLE IF EXISTS ONLY hr.leave_type DROP CONSTRAINT IF EXISTS leave_type_pkey;
ALTER TABLE IF EXISTS ONLY hr.leave_request DROP CONSTRAINT IF EXISTS leave_request_pkey;
ALTER TABLE IF EXISTS ONLY hr.hr_position DROP CONSTRAINT IF EXISTS hr_position_pkey;
ALTER TABLE IF EXISTS ONLY hr.hr_position DROP CONSTRAINT IF EXISTS hr_position_company_id_position_code_key;
ALTER TABLE IF EXISTS ONLY hr.hr_department DROP CONSTRAINT IF EXISTS hr_department_pkey;
ALTER TABLE IF EXISTS ONLY hr.hr_department DROP CONSTRAINT IF EXISTS hr_department_company_id_department_code_key;
ALTER TABLE IF EXISTS ONLY hr.employment_contract DROP CONSTRAINT IF EXISTS employment_contract_pkey;
ALTER TABLE IF EXISTS ONLY hr.employee DROP CONSTRAINT IF EXISTS employee_pkey;
ALTER TABLE IF EXISTS ONLY hr.employee DROP CONSTRAINT IF EXISTS employee_company_id_employee_code_key;
ALTER TABLE IF EXISTS ONLY hr.attendance_log DROP CONSTRAINT IF EXISTS attendance_log_pkey;
ALTER TABLE IF EXISTS ONLY hr.attendance_log DROP CONSTRAINT IF EXISTS attendance_log_company_id_employee_id_work_date_key;
ALTER TABLE IF EXISTS ONLY governance.policy_change_queue DROP CONSTRAINT IF EXISTS policy_change_queue_pkey;
ALTER TABLE IF EXISTS ONLY governance.document_category DROP CONSTRAINT IF EXISTS document_category_pkey;
ALTER TABLE IF EXISTS ONLY governance.document_category DROP CONSTRAINT IF EXISTS document_category_category_code_key;
ALTER TABLE IF EXISTS ONLY governance.document_archive DROP CONSTRAINT IF EXISTS document_archive_pkey;
ALTER TABLE IF EXISTS ONLY governance.contract_item_price DROP CONSTRAINT IF EXISTS contract_item_price_pkey;
ALTER TABLE IF EXISTS ONLY governance.contract_header DROP CONSTRAINT IF EXISTS contract_header_pkey;
ALTER TABLE IF EXISTS ONLY governance.business_rule DROP CONSTRAINT IF EXISTS business_rule_pkey;
ALTER TABLE IF EXISTS ONLY governance.business_rule_condition DROP CONSTRAINT IF EXISTS business_rule_condition_pkey;
ALTER TABLE IF EXISTS ONLY governance.business_rule DROP CONSTRAINT IF EXISTS business_rule_company_id_rule_code_key;
ALTER TABLE IF EXISTS ONLY governance.business_rule_action DROP CONSTRAINT IF EXISTS business_rule_action_pkey;
ALTER TABLE IF EXISTS ONLY finance.payment DROP CONSTRAINT IF EXISTS payment_pkey;
ALTER TABLE IF EXISTS ONLY finance.payment_allocation DROP CONSTRAINT IF EXISTS payment_allocation_pkey;
ALTER TABLE IF EXISTS ONLY finance.bank_statement_line DROP CONSTRAINT IF EXISTS bank_statement_line_pkey;
ALTER TABLE IF EXISTS ONLY finance.bank_statement_line DROP CONSTRAINT IF EXISTS bank_statement_line_bank_statement_id_line_no_key;
ALTER TABLE IF EXISTS ONLY finance.bank_statement_header DROP CONSTRAINT IF EXISTS bank_statement_header_pkey;
ALTER TABLE IF EXISTS ONLY finance.bank_statement_header DROP CONSTRAINT IF EXISTS bank_statement_header_bank_account_id_statement_date_key;
ALTER TABLE IF EXISTS ONLY finance.bank_account DROP CONSTRAINT IF EXISTS bank_account_pkey;
ALTER TABLE IF EXISTS ONLY devops.codegen_run DROP CONSTRAINT IF EXISTS codegen_run_pkey;
ALTER TABLE IF EXISTS ONLY devops.codegen_artifact DROP CONSTRAINT IF EXISTS codegen_artifact_pkey;
ALTER TABLE IF EXISTS ONLY core.user_permissions DROP CONSTRAINT IF EXISTS user_permissions_pkey;
ALTER TABLE IF EXISTS ONLY core.uom DROP CONSTRAINT IF EXISTS uom_pkey;
ALTER TABLE IF EXISTS ONLY core.uom_conversion DROP CONSTRAINT IF EXISTS uom_conversion_pkey;
ALTER TABLE IF EXISTS ONLY core.sync_queue DROP CONSTRAINT IF EXISTS sync_queue_pkey;
ALTER TABLE IF EXISTS ONLY core.status_master DROP CONSTRAINT IF EXISTS status_master_pkey;
ALTER TABLE IF EXISTS ONLY core.status_master DROP CONSTRAINT IF EXISTS status_master_entity_type_status_code_key;
ALTER TABLE IF EXISTS ONLY core.status_history DROP CONSTRAINT IF EXISTS status_history_pkey;
ALTER TABLE IF EXISTS ONLY core.reason_code_master DROP CONSTRAINT IF EXISTS reason_code_master_pkey;
ALTER TABLE IF EXISTS ONLY core.posting_profile DROP CONSTRAINT IF EXISTS posting_profile_pkey;
ALTER TABLE IF EXISTS ONLY core.posting_profile DROP CONSTRAINT IF EXISTS posting_profile_company_id_profile_code_key;
ALTER TABLE IF EXISTS ONLY core.permissions DROP CONSTRAINT IF EXISTS permissions_pkey;
ALTER TABLE IF EXISTS ONLY core.permissions DROP CONSTRAINT IF EXISTS permissions_company_id_code_key;
ALTER TABLE IF EXISTS ONLY core.permission_groups DROP CONSTRAINT IF EXISTS permission_groups_pkey;
ALTER TABLE IF EXISTS ONLY core.permission_groups DROP CONSTRAINT IF EXISTS permission_groups_company_id_group_code_key;
ALTER TABLE IF EXISTS ONLY core.permission_group_permissions DROP CONSTRAINT IF EXISTS permission_group_permissions_pkey;
ALTER TABLE IF EXISTS ONLY core.payment_term DROP CONSTRAINT IF EXISTS payment_term_term_code_key;
ALTER TABLE IF EXISTS ONLY core.payment_term DROP CONSTRAINT IF EXISTS payment_term_pkey;
ALTER TABLE IF EXISTS ONLY core.payment_method DROP CONSTRAINT IF EXISTS payment_method_pkey;
ALTER TABLE IF EXISTS ONLY core.login_history DROP CONSTRAINT IF EXISTS login_history_pkey;
ALTER TABLE IF EXISTS ONLY core.license_master DROP CONSTRAINT IF EXISTS license_master_pkey;
ALTER TABLE IF EXISTS ONLY core.journal_source_link DROP CONSTRAINT IF EXISTS journal_source_link_pkey;
ALTER TABLE IF EXISTS ONLY core.journal_source_link DROP CONSTRAINT IF EXISTS journal_source_link_journal_id_source_type_source_id_key;
ALTER TABLE IF EXISTS ONLY core.journal_lines DROP CONSTRAINT IF EXISTS journal_lines_pkey;
ALTER TABLE IF EXISTS ONLY core.journal_lines DROP CONSTRAINT IF EXISTS journal_lines_journal_id_line_no_key;
ALTER TABLE IF EXISTS ONLY core.journal_entries DROP CONSTRAINT IF EXISTS journal_entries_pkey;
ALTER TABLE IF EXISTS ONLY core.entity_attribute_value DROP CONSTRAINT IF EXISTS entity_attribute_value_pkey;
ALTER TABLE IF EXISTS ONLY core.entity_attribute_value DROP CONSTRAINT IF EXISTS entity_attribute_value_entity_type_entity_id_attribute_def__key;
ALTER TABLE IF EXISTS ONLY core.entity_attribute_def DROP CONSTRAINT IF EXISTS entity_attribute_def_pkey;
ALTER TABLE IF EXISTS ONLY core.entity_attribute_def DROP CONSTRAINT IF EXISTS entity_attribute_def_entity_type_attribute_code_key;
ALTER TABLE IF EXISTS ONLY core.document_sequence DROP CONSTRAINT IF EXISTS document_sequence_pkey;
ALTER TABLE IF EXISTS ONLY core.document_sequence DROP CONSTRAINT IF EXISTS document_sequence_company_id_doc_type_key;
ALTER TABLE IF EXISTS ONLY core.company_users DROP CONSTRAINT IF EXISTS company_users_pkey;
ALTER TABLE IF EXISTS ONLY core.company_users DROP CONSTRAINT IF EXISTS company_users_company_id_user_id_key;
ALTER TABLE IF EXISTS ONLY core.company DROP CONSTRAINT IF EXISTS company_pkey;
ALTER TABLE IF EXISTS ONLY core.company_permission DROP CONSTRAINT IF EXISTS company_permission_pkey;
ALTER TABLE IF EXISTS ONLY core.company_permission DROP CONSTRAINT IF EXISTS company_permission_company_id_permission_code_key;
ALTER TABLE IF EXISTS ONLY core.company_license DROP CONSTRAINT IF EXISTS company_license_pkey;
ALTER TABLE IF EXISTS ONLY core.company_license DROP CONSTRAINT IF EXISTS company_license_company_id_license_code_key;
ALTER TABLE IF EXISTS ONLY core.company DROP CONSTRAINT IF EXISTS company_company_code_key;
ALTER TABLE IF EXISTS ONLY core.audit_trail_2026_07 DROP CONSTRAINT IF EXISTS audit_trail_2026_07_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_trail_2026_06 DROP CONSTRAINT IF EXISTS audit_trail_2026_06_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_trail_2026_05 DROP CONSTRAINT IF EXISTS audit_trail_2026_05_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_trail_2026_04 DROP CONSTRAINT IF EXISTS audit_trail_2026_04_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_trail_2026_03 DROP CONSTRAINT IF EXISTS audit_trail_2026_03_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_trail_2026_02 DROP CONSTRAINT IF EXISTS audit_trail_2026_02_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_trail_2026_01 DROP CONSTRAINT IF EXISTS audit_trail_2026_01_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_trail_2025_12 DROP CONSTRAINT IF EXISTS audit_trail_2025_12_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_trail DROP CONSTRAINT IF EXISTS audit_trail_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_impact_rule DROP CONSTRAINT IF EXISTS audit_impact_rule_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_entity_pk_map DROP CONSTRAINT IF EXISTS audit_entity_pk_map_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_column_weight DROP CONSTRAINT IF EXISTS audit_column_weight_pkey;
ALTER TABLE IF EXISTS ONLY core.audit_column_weight DROP CONSTRAINT IF EXISTS audit_column_weight_company_id_entity_type_like_column_name_key;
ALTER TABLE IF EXISTS ONLY core.app_user DROP CONSTRAINT IF EXISTS app_user_pkey;
ALTER TABLE IF EXISTS ONLY core.app_user DROP CONSTRAINT IF EXISTS app_user_email_key;
ALTER TABLE IF EXISTS ONLY core.accounts DROP CONSTRAINT IF EXISTS accounts_pkey;
ALTER TABLE IF EXISTS ONLY core.accounts DROP CONSTRAINT IF EXISTS accounts_company_id_account_code_key;
ALTER TABLE IF EXISTS ONLY core.accounting_period DROP CONSTRAINT IF EXISTS accounting_period_pkey;
ALTER TABLE IF EXISTS ONLY core.accounting_period DROP CONSTRAINT IF EXISTS accounting_period_company_id_period_year_period_month_key;
ALTER TABLE IF EXISTS ONLY compliance.iso_standard DROP CONSTRAINT IF EXISTS iso_standard_pkey;
ALTER TABLE IF EXISTS ONLY compliance.iso_standard DROP CONSTRAINT IF EXISTS iso_standard_iso_code_key;
ALTER TABLE IF EXISTS ONLY compliance.iso_clause DROP CONSTRAINT IF EXISTS iso_clause_pkey;
ALTER TABLE IF EXISTS ONLY compliance.iso_clause DROP CONSTRAINT IF EXISTS iso_clause_iso_standard_id_clause_code_key;
ALTER TABLE IF EXISTS ONLY compliance.audit_issue DROP CONSTRAINT IF EXISTS audit_issue_pkey;
ALTER TABLE IF EXISTS ONLY compliance.audit_event DROP CONSTRAINT IF EXISTS audit_event_pkey;
ALTER TABLE IF EXISTS ONLY compliance.audit_action DROP CONSTRAINT IF EXISTS audit_action_pkey;
ALTER TABLE IF EXISTS ONLY ci.slack_interaction_log DROP CONSTRAINT IF EXISTS slack_interaction_log_pkey;
ALTER TABLE IF EXISTS ONLY ci.slack_approval_audit DROP CONSTRAINT IF EXISTS slack_approval_audit_pkey;
ALTER TABLE IF EXISTS ONLY ci.sla_escalation_policy DROP CONSTRAINT IF EXISTS sla_escalation_policy_pkey;
ALTER TABLE IF EXISTS ONLY ci.sla_escalation_policy DROP CONSTRAINT IF EXISTS sla_escalation_policy_domain_key;
ALTER TABLE IF EXISTS ONLY ci.schema_review_summary DROP CONSTRAINT IF EXISTS schema_review_summary_pkey;
ALTER TABLE IF EXISTS ONLY ci.schema_review_prompt_template DROP CONSTRAINT IF EXISTS schema_review_prompt_template_pkey;
ALTER TABLE IF EXISTS ONLY ci.schema_review_prompt_template DROP CONSTRAINT IF EXISTS schema_review_prompt_template_domain_schema_name_key;
ALTER TABLE IF EXISTS ONLY ci.schema_change_request DROP CONSTRAINT IF EXISTS schema_change_request_pkey;
ALTER TABLE IF EXISTS ONLY ci.schema_ai_review_job DROP CONSTRAINT IF EXISTS schema_ai_review_job_request_id_key;
ALTER TABLE IF EXISTS ONLY ci.schema_ai_review_job DROP CONSTRAINT IF EXISTS schema_ai_review_job_pkey;
ALTER TABLE IF EXISTS ONLY ci.ops_notification_queue DROP CONSTRAINT IF EXISTS ops_notification_queue_pkey;
ALTER TABLE IF EXISTS ONLY ci.kill_switch DROP CONSTRAINT IF EXISTS kill_switch_pkey;
ALTER TABLE IF EXISTS ONLY ci.json_schema_check_log DROP CONSTRAINT IF EXISTS json_schema_check_log_pkey;
ALTER TABLE IF EXISTS ONLY ci.escalation_outbox DROP CONSTRAINT IF EXISTS escalation_outbox_pkey;
ALTER TABLE IF EXISTS ONLY billing.issuer_profile DROP CONSTRAINT IF EXISTS issuer_profile_pkey;
ALTER TABLE IF EXISTS ONLY billing.invoice_template DROP CONSTRAINT IF EXISTS invoice_template_pkey;
ALTER TABLE IF EXISTS ONLY billing.invoice_send_retry DROP CONSTRAINT IF EXISTS invoice_send_retry_pkey;
ALTER TABLE IF EXISTS ONLY billing.invoice_send_audit DROP CONSTRAINT IF EXISTS invoice_send_audit_pkey;
ALTER TABLE IF EXISTS ONLY billing.invoice DROP CONSTRAINT IF EXISTS invoice_pkey;
ALTER TABLE IF EXISTS ONLY billing.invoice_line DROP CONSTRAINT IF EXISTS invoice_line_pkey;
ALTER TABLE IF EXISTS ONLY billing.customer_profile DROP CONSTRAINT IF EXISTS customer_profile_pkey;
ALTER TABLE IF EXISTS ONLY billing.checkout_session DROP CONSTRAINT IF EXISTS checkout_session_pkey;
ALTER TABLE IF EXISTS ONLY auth.users DROP CONSTRAINT IF EXISTS users_pkey;
ALTER TABLE IF EXISTS ONLY auth.users DROP CONSTRAINT IF EXISTS users_phone_key;
ALTER TABLE IF EXISTS ONLY auth.sso_providers DROP CONSTRAINT IF EXISTS sso_providers_pkey;
ALTER TABLE IF EXISTS ONLY auth.sso_domains DROP CONSTRAINT IF EXISTS sso_domains_pkey;
ALTER TABLE IF EXISTS ONLY auth.sessions DROP CONSTRAINT IF EXISTS sessions_pkey;
ALTER TABLE IF EXISTS ONLY auth.schema_migrations DROP CONSTRAINT IF EXISTS schema_migrations_pkey;
ALTER TABLE IF EXISTS ONLY auth.saml_relay_states DROP CONSTRAINT IF EXISTS saml_relay_states_pkey;
ALTER TABLE IF EXISTS ONLY auth.saml_providers DROP CONSTRAINT IF EXISTS saml_providers_pkey;
ALTER TABLE IF EXISTS ONLY auth.saml_providers DROP CONSTRAINT IF EXISTS saml_providers_entity_id_key;
ALTER TABLE IF EXISTS ONLY auth.refresh_tokens DROP CONSTRAINT IF EXISTS refresh_tokens_token_unique;
ALTER TABLE IF EXISTS ONLY auth.refresh_tokens DROP CONSTRAINT IF EXISTS refresh_tokens_pkey;
ALTER TABLE IF EXISTS ONLY auth.one_time_tokens DROP CONSTRAINT IF EXISTS one_time_tokens_pkey;
ALTER TABLE IF EXISTS ONLY auth.oauth_consents DROP CONSTRAINT IF EXISTS oauth_consents_user_client_unique;
ALTER TABLE IF EXISTS ONLY auth.oauth_consents DROP CONSTRAINT IF EXISTS oauth_consents_pkey;
ALTER TABLE IF EXISTS ONLY auth.oauth_clients DROP CONSTRAINT IF EXISTS oauth_clients_pkey;
ALTER TABLE IF EXISTS ONLY auth.oauth_client_states DROP CONSTRAINT IF EXISTS oauth_client_states_pkey;
ALTER TABLE IF EXISTS ONLY auth.oauth_authorizations DROP CONSTRAINT IF EXISTS oauth_authorizations_pkey;
ALTER TABLE IF EXISTS ONLY auth.oauth_authorizations DROP CONSTRAINT IF EXISTS oauth_authorizations_authorization_id_key;
ALTER TABLE IF EXISTS ONLY auth.oauth_authorizations DROP CONSTRAINT IF EXISTS oauth_authorizations_authorization_code_key;
ALTER TABLE IF EXISTS ONLY auth.mfa_factors DROP CONSTRAINT IF EXISTS mfa_factors_pkey;
ALTER TABLE IF EXISTS ONLY auth.mfa_factors DROP CONSTRAINT IF EXISTS mfa_factors_last_challenged_at_key;
ALTER TABLE IF EXISTS ONLY auth.mfa_challenges DROP CONSTRAINT IF EXISTS mfa_challenges_pkey;
ALTER TABLE IF EXISTS ONLY auth.mfa_amr_claims DROP CONSTRAINT IF EXISTS mfa_amr_claims_session_id_authentication_method_pkey;
ALTER TABLE IF EXISTS ONLY auth.instances DROP CONSTRAINT IF EXISTS instances_pkey;
ALTER TABLE IF EXISTS ONLY auth.identities DROP CONSTRAINT IF EXISTS identities_provider_id_provider_unique;
ALTER TABLE IF EXISTS ONLY auth.identities DROP CONSTRAINT IF EXISTS identities_pkey;
ALTER TABLE IF EXISTS ONLY auth.flow_state DROP CONSTRAINT IF EXISTS flow_state_pkey;
ALTER TABLE IF EXISTS ONLY auth.audit_log_entries DROP CONSTRAINT IF EXISTS audit_log_entries_pkey;
ALTER TABLE IF EXISTS ONLY auth.mfa_amr_claims DROP CONSTRAINT IF EXISTS amr_id_pk;
ALTER TABLE IF EXISTS ONLY audit.slack_interaction_log DROP CONSTRAINT IF EXISTS slack_interaction_log_pkey;
ALTER TABLE IF EXISTS ONLY audit.ops_audit_log DROP CONSTRAINT IF EXISTS ops_audit_log_pkey;
ALTER TABLE IF EXISTS ONLY audit.notification_channel DROP CONSTRAINT IF EXISTS notification_channel_pkey;
ALTER TABLE IF EXISTS ONLY audit.ng_event DROP CONSTRAINT IF EXISTS ng_event_pkey;
ALTER TABLE IF EXISTS ONLY audit.exec_audit_event DROP CONSTRAINT IF EXISTS exec_audit_event_pkey;
ALTER TABLE IF EXISTS ONLY audit.entity_status_history DROP CONSTRAINT IF EXISTS entity_status_history_pkey;
ALTER TABLE IF EXISTS ONLY audit.audit_trail_db DROP CONSTRAINT IF EXISTS audit_trail_db_pkey;
ALTER TABLE IF EXISTS ONLY audit.audit_target_table DROP CONSTRAINT IF EXISTS audit_target_table_pkey;
ALTER TABLE IF EXISTS ONLY audit.audit_reason_policy DROP CONSTRAINT IF EXISTS audit_reason_policy_pkey;
ALTER TABLE IF EXISTS ONLY audit.audit_event DROP CONSTRAINT IF EXISTS audit_event_pkey;
ALTER TABLE IF EXISTS ONLY audit.approval_request DROP CONSTRAINT IF EXISTS approval_request_pkey;
ALTER TABLE IF EXISTS ONLY audit.approval_reason_template DROP CONSTRAINT IF EXISTS approval_reason_template_pkey;
ALTER TABLE IF EXISTS ONLY audit.approval_notify_queue DROP CONSTRAINT IF EXISTS approval_notify_queue_pkey;
ALTER TABLE IF EXISTS ONLY audit.approval_log DROP CONSTRAINT IF EXISTS approval_log_pkey;
ALTER TABLE IF EXISTS ONLY approval.stripe_webhook_event DROP CONSTRAINT IF EXISTS stripe_webhook_event_pkey;
ALTER TABLE IF EXISTS ONLY approval.stripe_webhook_event DROP CONSTRAINT IF EXISTS stripe_webhook_event_event_id_key;
ALTER TABLE IF EXISTS ONLY approval.saas_usage_monthly DROP CONSTRAINT IF EXISTS saas_usage_monthly_pkey;
ALTER TABLE IF EXISTS ONLY approval.saas_usage_daily DROP CONSTRAINT IF EXISTS saas_usage_daily_pkey;
ALTER TABLE IF EXISTS ONLY approval.saas_subscription DROP CONSTRAINT IF EXISTS saas_subscription_pkey;
ALTER TABLE IF EXISTS ONLY approval.saas_plan DROP CONSTRAINT IF EXISTS saas_plan_pkey;
ALTER TABLE IF EXISTS ONLY approval.saas_plan_limit DROP CONSTRAINT IF EXISTS saas_plan_limit_pkey;
ALTER TABLE IF EXISTS ONLY approval.saas_company_map DROP CONSTRAINT IF EXISTS saas_company_map_pkey;
ALTER TABLE IF EXISTS ONLY approval.rework_task DROP CONSTRAINT IF EXISTS rework_task_pkey;
ALTER TABLE IF EXISTS ONLY approval.public_pricing DROP CONSTRAINT IF EXISTS public_pricing_pkey;
ALTER TABLE IF EXISTS ONLY approval.policy_rollout DROP CONSTRAINT IF EXISTS policy_rollout_pkey;
ALTER TABLE IF EXISTS ONLY approval.policy_rollout_log DROP CONSTRAINT IF EXISTS policy_rollout_log_pkey;
ALTER TABLE IF EXISTS ONLY approval.policy_eval_event DROP CONSTRAINT IF EXISTS policy_eval_event_pkey;
ALTER TABLE IF EXISTS ONLY approval.policy_auto_generated DROP CONSTRAINT IF EXISTS policy_auto_generated_pkey;
ALTER TABLE IF EXISTS ONLY approval.policy_activation_log DROP CONSTRAINT IF EXISTS policy_activation_log_pkey;
ALTER TABLE IF EXISTS ONLY approval.plan_master DROP CONSTRAINT IF EXISTS plan_master_pkey;
ALTER TABLE IF EXISTS ONLY approval.payment_provider DROP CONSTRAINT IF EXISTS payment_provider_pkey;
ALTER TABLE IF EXISTS ONLY approval.lp_copy_i18n DROP CONSTRAINT IF EXISTS lp_copy_i18n_pkey;
ALTER TABLE IF EXISTS ONLY approval.jsox_evidence_log DROP CONSTRAINT IF EXISTS jsox_evidence_log_pkey;
ALTER TABLE IF EXISTS ONLY approval.jsox_control DROP CONSTRAINT IF EXISTS jsox_control_pkey;
ALTER TABLE IF EXISTS ONLY approval.jsox_control DROP CONSTRAINT IF EXISTS jsox_control_control_code_key;
ALTER TABLE IF EXISTS ONLY approval.invoice_delivery_log DROP CONSTRAINT IF EXISTS invoice_delivery_log_pkey;
ALTER TABLE IF EXISTS ONLY approval.feature_flag DROP CONSTRAINT IF EXISTS feature_flag_pkey;
ALTER TABLE IF EXISTS ONLY approval.company_plan DROP CONSTRAINT IF EXISTS company_plan_pkey;
ALTER TABLE IF EXISTS ONLY approval.company_cost DROP CONSTRAINT IF EXISTS company_cost_pkey;
ALTER TABLE IF EXISTS ONLY approval.billing_payment DROP CONSTRAINT IF EXISTS billing_payment_pkey;
ALTER TABLE IF EXISTS ONLY approval.billing_invoice DROP CONSTRAINT IF EXISTS billing_invoice_pkey;
ALTER TABLE IF EXISTS ONLY approval.billing_customer DROP CONSTRAINT IF EXISTS billing_customer_pkey;
ALTER TABLE IF EXISTS ONLY approval.approver DROP CONSTRAINT IF EXISTS approver_pkey;
ALTER TABLE IF EXISTS ONLY approval.ai_improvement_proposal DROP CONSTRAINT IF EXISTS ai_improvement_proposal_pkey;
ALTER TABLE IF EXISTS ONLY analytics.sla_escalation_target DROP CONSTRAINT IF EXISTS sla_escalation_target_pkey;
ALTER TABLE IF EXISTS ONLY analytics.sla_definition DROP CONSTRAINT IF EXISTS sla_definition_pkey;
ALTER TABLE IF EXISTS ONLY analytics.sla_breach_event DROP CONSTRAINT IF EXISTS sla_breach_event_pkey;
ALTER TABLE IF EXISTS ONLY analytics.notification_queue DROP CONSTRAINT IF EXISTS notification_queue_pkey;
ALTER TABLE IF EXISTS ONLY analytics.fact_metric DROP CONSTRAINT IF EXISTS fact_metric_pkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_alert_rule DROP CONSTRAINT IF EXISTS audit_alert_rule_pkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_alert_notification DROP CONSTRAINT IF EXISTS audit_alert_notification_pkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_alert_event DROP CONSTRAINT IF EXISTS audit_alert_event_pkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_alert_ai_judgement DROP CONSTRAINT IF EXISTS audit_alert_ai_judgement_pkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_alert_ai_judgement DROP CONSTRAINT IF EXISTS audit_alert_ai_judgement_alert_event_id_key;
ALTER TABLE IF EXISTS ONLY analytics.audit_ai_llm_result DROP CONSTRAINT IF EXISTS audit_ai_llm_result_pkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_ai_job DROP CONSTRAINT IF EXISTS audit_ai_job_pkey;
ALTER TABLE IF EXISTS ONLY analytics.audit_ai_job DROP CONSTRAINT IF EXISTS audit_ai_job_alert_event_id_key;
ALTER TABLE IF EXISTS ONLY analytics.audit_ai_feedback DROP CONSTRAINT IF EXISTS audit_ai_feedback_pkey;
ALTER TABLE IF EXISTS ONLY analytics.ai_rate_limit DROP CONSTRAINT IF EXISTS ai_rate_limit_pkey;
ALTER TABLE IF EXISTS ONLY analytics.ai_module_manifest DROP CONSTRAINT IF EXISTS ai_module_manifest_pkey;
ALTER TABLE IF EXISTS ONLY analytics.ai_kill_switch DROP CONSTRAINT IF EXISTS ai_kill_switch_pkey;
ALTER TABLE IF EXISTS ONLY analytics.ai_job_type_master DROP CONSTRAINT IF EXISTS ai_job_type_master_pkey;
ALTER TABLE IF EXISTS ONLY analytics.ai_job DROP CONSTRAINT IF EXISTS ai_job_pkey;
ALTER TABLE IF EXISTS ONLY analytics.ai_insight_job DROP CONSTRAINT IF EXISTS ai_insight_job_pkey;
ALTER TABLE IF EXISTS ONLY analytics.ai_event DROP CONSTRAINT IF EXISTS ai_event_pkey;
ALTER TABLE IF EXISTS ONLY analytics.ai_apply_audit DROP CONSTRAINT IF EXISTS ai_apply_audit_pkey;
ALTER TABLE IF EXISTS ONLY accounting.paper_send_fee_journal DROP CONSTRAINT IF EXISTS paper_send_fee_journal_pkey;
ALTER TABLE IF EXISTS system.operation_log ALTER COLUMN operation_log_id DROP DEFAULT;
ALTER TABLE IF EXISTS system.loop_tick_log ALTER COLUMN tick_id DROP DEFAULT;
ALTER TABLE IF EXISTS system.loop_sla_stat ALTER COLUMN stat_id DROP DEFAULT;
ALTER TABLE IF EXISTS system.loop_autotune_rule ALTER COLUMN rule_id DROP DEFAULT;
ALTER TABLE IF EXISTS system.exec_run_request ALTER COLUMN request_id DROP DEFAULT;
ALTER TABLE IF EXISTS system.approval_request ALTER COLUMN approval_request_id DROP DEFAULT;
ALTER TABLE IF EXISTS system.approval_action_log ALTER COLUMN approval_action_id DROP DEFAULT;
ALTER TABLE IF EXISTS system.ai_task_run ALTER COLUMN run_id DROP DEFAULT;
ALTER TABLE IF EXISTS system.ai_task ALTER COLUMN task_id DROP DEFAULT;
ALTER TABLE IF EXISTS system.ai_signal ALTER COLUMN signal_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.shipping_revision ALTER COLUMN shipping_revision_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.shipping_header ALTER COLUMN shipping_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.shipping_detail ALTER COLUMN shipping_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.sales_quotation_detail ALTER COLUMN sales_quotation_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.sales_quotation ALTER COLUMN sales_quotation_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.return_header ALTER COLUMN return_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.return_detail ALTER COLUMN return_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.quotation_order_link ALTER COLUMN quotation_order_link_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.order_header ALTER COLUMN order_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.order_detail ALTER COLUMN order_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.item_uom ALTER COLUMN item_uom_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.item_price_master ALTER COLUMN item_price_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.item_category ALTER COLUMN item_category_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.item ALTER COLUMN item_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.invoice_pdf ALTER COLUMN invoice_pdf_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.customer_payment_term ALTER COLUMN customer_payment_term_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.customer_contact ALTER COLUMN customer_contact_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.customer_address ALTER COLUMN customer_address_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.customer ALTER COLUMN customer_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.billing_header ALTER COLUMN billing_id DROP DEFAULT;
ALTER TABLE IF EXISTS sales.billing_detail ALTER COLUMN billing_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.supplier_payment_term ALTER COLUMN supplier_payment_term_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.supplier_master ALTER COLUMN supplier_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.supplier_item_price ALTER COLUMN supplier_item_price_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.supplier_contact ALTER COLUMN supplier_contact_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.supplier_address ALTER COLUMN supplier_address_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_three_way_match ALTER COLUMN purchase_three_way_match_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_requisition_detail ALTER COLUMN purchase_requisition_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_requisition ALTER COLUMN purchase_requisition_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_receipt_detail ALTER COLUMN receipt_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_receipt ALTER COLUMN receipt_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_quotation_detail ALTER COLUMN purchase_quotation_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_quotation ALTER COLUMN purchase_quotation_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_order_header ALTER COLUMN purchase_order_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_order_detail ALTER COLUMN purchase_order_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_invoice_detail ALTER COLUMN purchase_invoice_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS purchase.purchase_invoice ALTER COLUMN purchase_invoice_id DROP DEFAULT;
ALTER TABLE IF EXISTS ops.send_fee_master ALTER COLUMN fee_id DROP DEFAULT;
ALTER TABLE IF EXISTS ops.pdf_generate_queue ALTER COLUMN queue_id DROP DEFAULT;
ALTER TABLE IF EXISTS ops.ops_job_queue ALTER COLUMN job_id DROP DEFAULT;
ALTER TABLE IF EXISTS ops.notification_outbox ALTER COLUMN notification_id DROP DEFAULT;
ALTER TABLE IF EXISTS ops.document_send_queue ALTER COLUMN send_queue_id DROP DEFAULT;
ALTER TABLE IF EXISTS ops.document_send_history ALTER COLUMN send_history_id DROP DEFAULT;
ALTER TABLE IF EXISTS ops.document_file ALTER COLUMN document_file_id DROP DEFAULT;
ALTER TABLE IF EXISTS notify.notification_template ALTER COLUMN template_id DROP DEFAULT;
ALTER TABLE IF EXISTS notify.notification_route ALTER COLUMN route_id DROP DEFAULT;
ALTER TABLE IF EXISTS notify.notification_log ALTER COLUMN notification_id DROP DEFAULT;
ALTER TABLE IF EXISTS notify.audit_trail ALTER COLUMN audit_id DROP DEFAULT;
ALTER TABLE IF EXISTS notify.approval_request ALTER COLUMN approval_request_id DROP DEFAULT;
ALTER TABLE IF EXISTS notify.approval_action_log ALTER COLUMN action_log_id DROP DEFAULT;
ALTER TABLE IF EXISTS notify.ai_rule ALTER COLUMN ai_rule_id DROP DEFAULT;
ALTER TABLE IF EXISTS notify.ai_event ALTER COLUMN ai_event_id DROP DEFAULT;
ALTER TABLE IF EXISTS media.asset ALTER COLUMN asset_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.yield_metric ALTER COLUMN yield_metric_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.work_order ALTER COLUMN work_order_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.routing_operation ALTER COLUMN routing_operation_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.routing_header ALTER COLUMN routing_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.process_master ALTER COLUMN process_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.mrp_run ALTER COLUMN mrp_run_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.mrp_requirement ALTER COLUMN mrp_requirement_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.mrp_allocation ALTER COLUMN mrp_allocation_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.mps_run ALTER COLUMN mps_run_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.mps_plan ALTER COLUMN mps_plan_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.manufacturing_execution_detail ALTER COLUMN execution_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.manufacturing_execution ALTER COLUMN execution_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.manufacturing_cost_snapshot ALTER COLUMN manufacturing_cost_snapshot_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.bom_header ALTER COLUMN bom_id DROP DEFAULT;
ALTER TABLE IF EXISTS manufacturing.bom_detail ALTER COLUMN bom_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.warehouse ALTER COLUMN warehouse_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.storage_location ALTER COLUMN location_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.stocktaking_result ALTER COLUMN stocktaking_result_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.stocktaking_plan ALTER COLUMN stocktaking_plan_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.stock_transfer_header ALTER COLUMN stock_transfer_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.stock_transfer_detail ALTER COLUMN stock_transfer_detail_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.stock_transaction ALTER COLUMN stock_tx_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.stock_reservation ALTER COLUMN stock_reservation_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.stock_lot_balance ALTER COLUMN stock_lot_balance_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.stock_lot ALTER COLUMN stock_lot_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.stock_bin ALTER COLUMN bin_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.stock_balance ALTER COLUMN stock_balance_id DROP DEFAULT;
ALTER TABLE IF EXISTS inventory.inventory_valuation ALTER COLUMN inventory_valuation_id DROP DEFAULT;
ALTER TABLE IF EXISTS integration.siem_endpoint ALTER COLUMN endpoint_id DROP DEFAULT;
ALTER TABLE IF EXISTS integration.siem_delivery_queue ALTER COLUMN delivery_id DROP DEFAULT;
ALTER TABLE IF EXISTS integration.integration_log ALTER COLUMN integration_log_id DROP DEFAULT;
ALTER TABLE IF EXISTS integration.integration_job ALTER COLUMN integration_job_id DROP DEFAULT;
ALTER TABLE IF EXISTS integration.external_system ALTER COLUMN external_system_id DROP DEFAULT;
ALTER TABLE IF EXISTS integration.audit_export_queue ALTER COLUMN export_id DROP DEFAULT;
ALTER TABLE IF EXISTS integration.api_credential ALTER COLUMN api_credential_id DROP DEFAULT;
ALTER TABLE IF EXISTS hr.payroll_slip ALTER COLUMN payroll_slip_id DROP DEFAULT;
ALTER TABLE IF EXISTS hr.payroll_run ALTER COLUMN payroll_run_id DROP DEFAULT;
ALTER TABLE IF EXISTS hr.leave_request ALTER COLUMN leave_request_id DROP DEFAULT;
ALTER TABLE IF EXISTS hr.hr_position ALTER COLUMN position_id DROP DEFAULT;
ALTER TABLE IF EXISTS hr.hr_department ALTER COLUMN department_id DROP DEFAULT;
ALTER TABLE IF EXISTS hr.employment_contract ALTER COLUMN employment_contract_id DROP DEFAULT;
ALTER TABLE IF EXISTS hr.employee ALTER COLUMN employee_id DROP DEFAULT;
ALTER TABLE IF EXISTS hr.attendance_log ALTER COLUMN attendance_log_id DROP DEFAULT;
ALTER TABLE IF EXISTS governance.policy_change_queue ALTER COLUMN policy_change_id DROP DEFAULT;
ALTER TABLE IF EXISTS governance.document_category ALTER COLUMN document_category_id DROP DEFAULT;
ALTER TABLE IF EXISTS governance.document_archive ALTER COLUMN document_archive_id DROP DEFAULT;
ALTER TABLE IF EXISTS governance.contract_item_price ALTER COLUMN contract_item_price_id DROP DEFAULT;
ALTER TABLE IF EXISTS governance.contract_header ALTER COLUMN contract_id DROP DEFAULT;
ALTER TABLE IF EXISTS governance.business_rule_condition ALTER COLUMN rule_condition_id DROP DEFAULT;
ALTER TABLE IF EXISTS governance.business_rule_action ALTER COLUMN rule_action_id DROP DEFAULT;
ALTER TABLE IF EXISTS governance.business_rule ALTER COLUMN business_rule_id DROP DEFAULT;
ALTER TABLE IF EXISTS finance.payment_allocation ALTER COLUMN payment_allocation_id DROP DEFAULT;
ALTER TABLE IF EXISTS finance.payment ALTER COLUMN payment_id DROP DEFAULT;
ALTER TABLE IF EXISTS finance.bank_statement_line ALTER COLUMN bank_statement_line_id DROP DEFAULT;
ALTER TABLE IF EXISTS finance.bank_statement_header ALTER COLUMN bank_statement_id DROP DEFAULT;
ALTER TABLE IF EXISTS finance.bank_account ALTER COLUMN bank_account_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.sync_queue ALTER COLUMN sync_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.status_master ALTER COLUMN status_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.status_history ALTER COLUMN status_history_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.posting_profile ALTER COLUMN posting_profile_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.permissions ALTER COLUMN permission_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.permission_groups ALTER COLUMN group_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.payment_term ALTER COLUMN payment_term_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.login_history ALTER COLUMN login_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.journal_source_link ALTER COLUMN journal_source_link_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.journal_lines ALTER COLUMN journal_line_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.journal_entries ALTER COLUMN journal_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.entity_attribute_value ALTER COLUMN attribute_value_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.entity_attribute_def ALTER COLUMN attribute_def_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.document_sequence ALTER COLUMN sequence_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.company_users ALTER COLUMN company_user_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.company_permission ALTER COLUMN company_permission_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.company_license ALTER COLUMN company_license_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.audit_trail ALTER COLUMN audit_trail_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.audit_impact_rule ALTER COLUMN rule_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.audit_column_weight ALTER COLUMN column_weight_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.accounts ALTER COLUMN account_id DROP DEFAULT;
ALTER TABLE IF EXISTS core.accounting_period ALTER COLUMN period_id DROP DEFAULT;
ALTER TABLE IF EXISTS compliance.iso_standard ALTER COLUMN iso_standard_id DROP DEFAULT;
ALTER TABLE IF EXISTS compliance.iso_clause ALTER COLUMN iso_clause_id DROP DEFAULT;
ALTER TABLE IF EXISTS compliance.audit_issue ALTER COLUMN audit_issue_id DROP DEFAULT;
ALTER TABLE IF EXISTS compliance.audit_event ALTER COLUMN audit_event_id DROP DEFAULT;
ALTER TABLE IF EXISTS compliance.audit_action ALTER COLUMN audit_action_id DROP DEFAULT;
ALTER TABLE IF EXISTS auth.refresh_tokens ALTER COLUMN id DROP DEFAULT;
ALTER TABLE IF EXISTS audit.ops_audit_log ALTER COLUMN audit_id DROP DEFAULT;
ALTER TABLE IF EXISTS audit.ng_event ALTER COLUMN ng_event_id DROP DEFAULT;
ALTER TABLE IF EXISTS audit.exec_audit_event ALTER COLUMN audit_event_id DROP DEFAULT;
ALTER TABLE IF EXISTS audit.entity_status_history ALTER COLUMN status_history_id DROP DEFAULT;
ALTER TABLE IF EXISTS audit.audit_trail_db ALTER COLUMN audit_trail_db_id DROP DEFAULT;
ALTER TABLE IF EXISTS audit.audit_event ALTER COLUMN audit_event_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.notification_queue ALTER COLUMN notification_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.fact_metric ALTER COLUMN fact_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.audit_alert_rule ALTER COLUMN rule_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.audit_alert_notification ALTER COLUMN notification_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.audit_alert_event ALTER COLUMN alert_event_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.audit_alert_ai_judgement ALTER COLUMN judgement_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.audit_ai_llm_result ALTER COLUMN llm_result_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.audit_ai_job ALTER COLUMN job_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.audit_ai_feedback ALTER COLUMN feedback_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.ai_job ALTER COLUMN ai_job_id DROP DEFAULT;
ALTER TABLE IF EXISTS analytics.ai_event ALTER COLUMN ai_event_id DROP DEFAULT;
ALTER TABLE IF EXISTS accounting.paper_send_fee_journal ALTER COLUMN journal_id DROP DEFAULT;
DROP TABLE IF EXISTS tenant.license_master;
DROP TABLE IF EXISTS tenant.company_license;
DROP VIEW IF EXISTS system.v_operation_log_audit;
DROP VIEW IF EXISTS system.v_loop_configs;
DROP VIEW IF EXISTS system.v_exec_run_recent;
DROP VIEW IF EXISTS system.v_exec_commands;
DROP VIEW IF EXISTS system.v_business_ops_ready;
DROP VIEW IF EXISTS system.v_business_ops_pipeline;
DROP TABLE IF EXISTS system.screen_rule;
DROP TABLE IF EXISTS system.screen_master;
DROP TABLE IF EXISTS system.screen_action_map;
DROP TABLE IF EXISTS system.runtime_killswitch;
DROP TABLE IF EXISTS system.role_screen_permission;
DROP TABLE IF EXISTS system.role_def;
DROP TABLE IF EXISTS system.operation_type_def;
DROP SEQUENCE IF EXISTS system.operation_log_operation_log_id_seq;
DROP TABLE IF EXISTS system.operation_log;
DROP TABLE IF EXISTS system.notification_subscription;
DROP TABLE IF EXISTS system.notification_endpoint;
DROP TABLE IF EXISTS system.module_def;
DROP SEQUENCE IF EXISTS system.loop_tick_log_tick_id_seq;
DROP TABLE IF EXISTS system.loop_tick_log;
DROP SEQUENCE IF EXISTS system.loop_sla_stat_stat_id_seq;
DROP TABLE IF EXISTS system.loop_sla_stat;
DROP TABLE IF EXISTS system.loop_config;
DROP SEQUENCE IF EXISTS system.loop_autotune_rule_rule_id_seq;
DROP TABLE IF EXISTS system.loop_autotune_rule;
DROP TABLE IF EXISTS system.function_def;
DROP SEQUENCE IF EXISTS system.exec_run_request_request_id_seq;
DROP TABLE IF EXISTS system.exec_run_request;
DROP TABLE IF EXISTS system.exec_command;
DROP TABLE IF EXISTS system.db_session;
DROP TABLE IF EXISTS system.business_ops_map;
DROP TABLE IF EXISTS system.business_finalize_event;
DROP TABLE IF EXISTS system.approval_step_def;
DROP SEQUENCE IF EXISTS system.approval_request_approval_request_id_seq;
DROP TABLE IF EXISTS system.approval_request;
DROP TABLE IF EXISTS system.approval_flow_def;
DROP TABLE IF EXISTS system.approval_finalize_rule;
DROP TABLE IF EXISTS system.approval_exec_map;
DROP SEQUENCE IF EXISTS system.approval_action_log_approval_action_id_seq;
DROP TABLE IF EXISTS system.approval_action_log;
DROP SEQUENCE IF EXISTS system.ai_task_task_id_seq;
DROP SEQUENCE IF EXISTS system.ai_task_run_run_id_seq;
DROP TABLE IF EXISTS system.ai_task_run;
DROP TABLE IF EXISTS system.ai_task;
DROP SEQUENCE IF EXISTS system.ai_signal_signal_id_seq;
DROP TABLE IF EXISTS system.ai_signal;
DROP TABLE IF EXISTS system.ai_agent;
DROP TABLE IF EXISTS system.action_approval_map;
DROP TABLE IF EXISTS storage.vector_indexes;
DROP TABLE IF EXISTS storage.s3_multipart_uploads_parts;
DROP TABLE IF EXISTS storage.s3_multipart_uploads;
DROP TABLE IF EXISTS storage.prefixes;
DROP TABLE IF EXISTS storage.objects;
DROP TABLE IF EXISTS storage.migrations;
DROP TABLE IF EXISTS storage.buckets_vectors;
DROP TABLE IF EXISTS storage.buckets_analytics;
DROP TABLE IF EXISTS storage.buckets;
DROP VIEW IF EXISTS sales.v_order_header_read;
DROP VIEW IF EXISTS sales.v_change_history;
DROP SEQUENCE IF EXISTS sales.shipping_revision_shipping_revision_id_seq;
DROP TABLE IF EXISTS sales.shipping_revision;
DROP SEQUENCE IF EXISTS sales.shipping_header_shipping_id_seq;
DROP SEQUENCE IF EXISTS sales.shipping_detail_shipping_detail_id_seq;
DROP SEQUENCE IF EXISTS sales.sales_quotation_sales_quotation_id_seq;
DROP SEQUENCE IF EXISTS sales.sales_quotation_detail_sales_quotation_detail_id_seq;
DROP SEQUENCE IF EXISTS sales.return_header_return_id_seq;
DROP SEQUENCE IF EXISTS sales.return_detail_return_detail_id_seq;
DROP SEQUENCE IF EXISTS sales.quotation_order_link_quotation_order_link_id_seq;
DROP TABLE IF EXISTS sales.quotation_order_link;
DROP SEQUENCE IF EXISTS sales.order_header_order_id_seq;
DROP SEQUENCE IF EXISTS sales.order_detail_order_detail_id_seq;
DROP SEQUENCE IF EXISTS sales.item_uom_item_uom_id_seq;
DROP SEQUENCE IF EXISTS sales.item_price_master_item_price_id_seq;
DROP SEQUENCE IF EXISTS sales.item_item_id_seq;
DROP SEQUENCE IF EXISTS sales.item_category_item_category_id_seq;
DROP SEQUENCE IF EXISTS sales.invoice_pdf_invoice_pdf_id_seq;
DROP SEQUENCE IF EXISTS sales.customer_payment_term_customer_payment_term_id_seq;
DROP SEQUENCE IF EXISTS sales.customer_customer_id_seq;
DROP SEQUENCE IF EXISTS sales.customer_contact_customer_contact_id_seq;
DROP SEQUENCE IF EXISTS sales.customer_address_customer_address_id_seq;
DROP SEQUENCE IF EXISTS sales.billing_header_billing_id_seq;
DROP SEQUENCE IF EXISTS sales.billing_detail_billing_detail_id_seq;
DROP TABLE IF EXISTS realtime.subscription;
DROP TABLE IF EXISTS realtime.schema_migrations;
DROP TABLE IF EXISTS realtime.messages;
DROP VIEW IF EXISTS purchase.v_change_history;
DROP SEQUENCE IF EXISTS purchase.supplier_payment_term_supplier_payment_term_id_seq;
DROP SEQUENCE IF EXISTS purchase.supplier_master_supplier_id_seq;
DROP SEQUENCE IF EXISTS purchase.supplier_item_price_supplier_item_price_id_seq;
DROP SEQUENCE IF EXISTS purchase.supplier_contact_supplier_contact_id_seq;
DROP SEQUENCE IF EXISTS purchase.supplier_address_supplier_address_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_three_way_match_purchase_three_way_match_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_requisition_purchase_requisition_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_requisition_detail_purchase_requisition_detail_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_receipt_receipt_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_receipt_detail_receipt_detail_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_quotation_purchase_quotation_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_quotation_detail_purchase_quotation_detail_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_order_header_purchase_order_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_order_detail_purchase_order_detail_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_invoice_purchase_invoice_id_seq;
DROP SEQUENCE IF EXISTS purchase.purchase_invoice_detail_purchase_invoice_detail_id_seq;
DROP VIEW IF EXISTS public.yield_metric;
DROP VIEW IF EXISTS public.work_order;
DROP VIEW IF EXISTS public.warehouse;
DROP VIEW IF EXISTS public.v_sales_shipping_detail;
DROP VIEW IF EXISTS public.v_sales_sales_quotation_detail;
DROP VIEW IF EXISTS public.v_sales_sales_quotation;
DROP VIEW IF EXISTS public.v_sales_return_detail;
DROP VIEW IF EXISTS public.v_sales_order_detail;
DROP VIEW IF EXISTS public.v_sales_item_uom;
DROP TABLE IF EXISTS sales.item_uom;
DROP VIEW IF EXISTS public.v_sales_item_category;
DROP VIEW IF EXISTS public.v_sales_item;
DROP VIEW IF EXISTS public.v_sales_invoice_pdf;
DROP VIEW IF EXISTS public.v_sales_customer_payment_term;
DROP TABLE IF EXISTS sales.customer_payment_term;
DROP VIEW IF EXISTS public.v_sales_customer_contact;
DROP TABLE IF EXISTS sales.customer_contact;
DROP VIEW IF EXISTS public.v_sales_customer_address;
DROP TABLE IF EXISTS sales.customer_address;
DROP VIEW IF EXISTS public.v_sales_customer;
DROP VIEW IF EXISTS public.v_sales_billing_detail;
DROP VIEW IF EXISTS public.v_rls_table_status;
DROP VIEW IF EXISTS public.v_purchase_supplier_payment_term;
DROP TABLE IF EXISTS purchase.supplier_payment_term;
DROP VIEW IF EXISTS public.v_purchase_supplier_item_price;
DROP VIEW IF EXISTS public.v_purchase_supplier_contact;
DROP TABLE IF EXISTS purchase.supplier_contact;
DROP VIEW IF EXISTS public.v_purchase_supplier_address;
DROP TABLE IF EXISTS purchase.supplier_address;
DROP VIEW IF EXISTS public.v_purchase_purchase_three_way_match;
DROP VIEW IF EXISTS public.v_purchase_purchase_requisition_detail;
DROP VIEW IF EXISTS public.v_purchase_purchase_requisition;
DROP VIEW IF EXISTS public.v_purchase_purchase_quotation_detail;
DROP VIEW IF EXISTS public.v_purchase_purchase_quotation;
DROP VIEW IF EXISTS public.v_purchase_purchase_order_detail;
DROP VIEW IF EXISTS public.v_purchase_purchase_invoice_detail;
DROP VIEW IF EXISTS public.v_purchase_purchase_invoice;
DROP VIEW IF EXISTS public.v_policy_update_candidate;
DROP VIEW IF EXISTS public.v_ng_reason_stats;
DROP VIEW IF EXISTS public.v_ng_event_list;
DROP VIEW IF EXISTS public.v_ng_event;
DROP VIEW IF EXISTS public.v_ng_daily_trend;
DROP VIEW IF EXISTS public.v_manufacturing_yield_metric;
DROP VIEW IF EXISTS public.v_manufacturing_work_order;
DROP VIEW IF EXISTS public.v_manufacturing_routing_operation;
DROP VIEW IF EXISTS public.v_manufacturing_mrp_run;
DROP VIEW IF EXISTS public.v_manufacturing_mrp_requirement;
DROP VIEW IF EXISTS public.v_manufacturing_mrp_allocation;
DROP VIEW IF EXISTS public.v_manufacturing_mps_run;
DROP VIEW IF EXISTS public.v_manufacturing_mps_plan;
DROP VIEW IF EXISTS public.v_manufacturing_manufacturing_cost_snapshot;
DROP VIEW IF EXISTS public.v_manufacturing_bom_detail;
DROP VIEW IF EXISTS public.v_inventory_warehouse;
DROP VIEW IF EXISTS public.v_inventory_stocktaking_result;
DROP VIEW IF EXISTS public.v_inventory_stocktaking_plan;
DROP VIEW IF EXISTS public.v_inventory_stock_transfer_detail;
DROP VIEW IF EXISTS public.v_inventory_stock_reservation;
DROP VIEW IF EXISTS public.v_inventory_stock_lot_balance;
DROP VIEW IF EXISTS public.v_inventory_stock_lot;
DROP VIEW IF EXISTS public.v_inventory_stock_balance;
DROP VIEW IF EXISTS public.v_inventory_inventory_valuation;
DROP VIEW IF EXISTS public.v_hr_payroll_slip;
DROP VIEW IF EXISTS public.v_hr_payroll_run;
DROP VIEW IF EXISTS public.v_hr_leave_request;
DROP VIEW IF EXISTS public.v_hr_employment_contract;
DROP VIEW IF EXISTS public.v_hr_employee;
DROP VIEW IF EXISTS public.v_hr_attendance_log;
DROP VIEW IF EXISTS public.v_finance_payment_allocation;
DROP VIEW IF EXISTS public.v_finance_payment;
DROP VIEW IF EXISTS public.v_finance_bank_statement_line;
DROP VIEW IF EXISTS public.v_finance_bank_account;
DROP VIEW IF EXISTS public.v_core_status_history;
DROP VIEW IF EXISTS public.v_core_posting_profile;
DROP VIEW IF EXISTS public.v_core_payment_term;
DROP VIEW IF EXISTS public.v_core_journal_source_link;
DROP VIEW IF EXISTS public.v_core_company_permission;
DROP VIEW IF EXISTS public.v_core_company_license;
DROP VIEW IF EXISTS public.v_core_company;
DROP VIEW IF EXISTS public.v_core_audit_trail;
DROP VIEW IF EXISTS public.v_audit_kpi_weekly;
DROP VIEW IF EXISTS public.v_audit_kpi_summary;
DROP VIEW IF EXISTS public.v_approval_request;
DROP VIEW IF EXISTS public.v_approval_log;
DROP VIEW IF EXISTS public.user_permissions;
DROP VIEW IF EXISTS public.sync_queue;
DROP VIEW IF EXISTS public.supplier_master;
DROP TABLE IF EXISTS purchase.supplier_master;
DROP VIEW IF EXISTS public.supplier_item_price;
DROP TABLE IF EXISTS purchase.supplier_item_price;
DROP VIEW IF EXISTS public.storage_location;
DROP VIEW IF EXISTS public.stocktaking_result;
DROP VIEW IF EXISTS public.stocktaking_plan;
DROP VIEW IF EXISTS public.stock_transaction;
DROP VIEW IF EXISTS public.stock_reservation;
DROP VIEW IF EXISTS public.stock_lot_balance;
DROP VIEW IF EXISTS public.stock_lot;
DROP VIEW IF EXISTS public.stock_bin;
DROP VIEW IF EXISTS public.stock_balance;
DROP VIEW IF EXISTS public.status_master;
DROP VIEW IF EXISTS public.status_history;
DROP VIEW IF EXISTS public.shipping_header;
DROP TABLE IF EXISTS sales.shipping_header;
DROP VIEW IF EXISTS public.shipping_detail;
DROP TABLE IF EXISTS sales.shipping_detail;
DROP VIEW IF EXISTS public.sales_quotation_detail;
DROP TABLE IF EXISTS sales.sales_quotation_detail;
DROP VIEW IF EXISTS public.sales_quotation;
DROP TABLE IF EXISTS sales.sales_quotation;
DROP VIEW IF EXISTS public.routing_operation;
DROP VIEW IF EXISTS public.routing_header;
DROP VIEW IF EXISTS public.return_header;
DROP TABLE IF EXISTS sales.return_header;
DROP VIEW IF EXISTS public.return_detail;
DROP TABLE IF EXISTS sales.return_detail;
DROP VIEW IF EXISTS public.purchase_three_way_match;
DROP TABLE IF EXISTS purchase.purchase_three_way_match;
DROP VIEW IF EXISTS public.purchase_requisition_detail;
DROP TABLE IF EXISTS purchase.purchase_requisition_detail;
DROP VIEW IF EXISTS public.purchase_requisition;
DROP TABLE IF EXISTS purchase.purchase_requisition;
DROP VIEW IF EXISTS public.purchase_receipt_detail;
DROP TABLE IF EXISTS purchase.purchase_receipt_detail;
DROP VIEW IF EXISTS public.purchase_receipt;
DROP TABLE IF EXISTS purchase.purchase_receipt;
DROP VIEW IF EXISTS public.purchase_quotation_detail;
DROP TABLE IF EXISTS purchase.purchase_quotation_detail;
DROP VIEW IF EXISTS public.purchase_quotation;
DROP TABLE IF EXISTS purchase.purchase_quotation;
DROP VIEW IF EXISTS public.purchase_order_header;
DROP TABLE IF EXISTS purchase.purchase_order_header;
DROP VIEW IF EXISTS public.purchase_order_detail;
DROP TABLE IF EXISTS purchase.purchase_order_detail;
DROP VIEW IF EXISTS public.purchase_invoice_detail;
DROP TABLE IF EXISTS purchase.purchase_invoice_detail;
DROP VIEW IF EXISTS public.purchase_invoice;
DROP TABLE IF EXISTS purchase.purchase_invoice;
DROP VIEW IF EXISTS public.process_master;
DROP VIEW IF EXISTS public.permissions;
DROP VIEW IF EXISTS public.permission_groups;
DROP VIEW IF EXISTS public.payroll_slip;
DROP VIEW IF EXISTS public.payroll_run;
DROP VIEW IF EXISTS public.payment;
DROP VIEW IF EXISTS public.order_header;
DROP VIEW IF EXISTS public.order_detail;
DROP VIEW IF EXISTS public.mrp_run;
DROP VIEW IF EXISTS public.mrp_requirement;
DROP VIEW IF EXISTS public.mrp_allocation;
DROP VIEW IF EXISTS public.mps_run;
DROP VIEW IF EXISTS public.mps_plan;
DROP VIEW IF EXISTS public.manufacturing_execution_detail;
DROP VIEW IF EXISTS public.manufacturing_execution;
DROP VIEW IF EXISTS public.manufacturing_cost_snapshot;
DROP VIEW IF EXISTS public.login_history;
DROP VIEW IF EXISTS public.license_master;
DROP VIEW IF EXISTS public.leave_type;
DROP VIEW IF EXISTS public.leave_request;
DROP VIEW IF EXISTS public.journal_lines;
DROP VIEW IF EXISTS public.journal_entries;
DROP VIEW IF EXISTS public.item_price_master;
DROP TABLE IF EXISTS sales.item_price_master;
DROP VIEW IF EXISTS public.item_category;
DROP TABLE IF EXISTS sales.item_category;
DROP VIEW IF EXISTS public.item;
DROP TABLE IF EXISTS sales.item;
DROP VIEW IF EXISTS public.invoice_pdf;
DROP TABLE IF EXISTS sales.invoice_pdf;
DROP VIEW IF EXISTS public.inventory_valuation;
DROP VIEW IF EXISTS public.hr_position;
DROP VIEW IF EXISTS public.hr_department;
DROP VIEW IF EXISTS public.employment_contract;
DROP VIEW IF EXISTS public.employee;
DROP VIEW IF EXISTS public.document_sequence;
DROP VIEW IF EXISTS public.customer;
DROP TABLE IF EXISTS sales.customer;
DROP VIEW IF EXISTS public.company_users;
DROP VIEW IF EXISTS public.company;
DROP VIEW IF EXISTS public.bom_header;
DROP VIEW IF EXISTS public.bom_detail;
DROP VIEW IF EXISTS public.billing_header;
DROP TABLE IF EXISTS sales.billing_header;
DROP VIEW IF EXISTS public.billing_detail;
DROP TABLE IF EXISTS sales.billing_detail;
DROP VIEW IF EXISTS public.attendance_log;
DROP VIEW IF EXISTS public.approval_request_with_url;
DROP VIEW IF EXISTS public.approval_completed_event;
DROP VIEW IF EXISTS public.app_user;
DROP VIEW IF EXISTS public.accounts;
DROP VIEW IF EXISTS public.accounting_period;
DROP VIEW IF EXISTS ops.v_shipping_package_photos;
DROP VIEW IF EXISTS ops.v_send_failed_alert;
DROP VIEW IF EXISTS ops.v_paper_send_cost_monthly;
DROP VIEW IF EXISTS ops.v_ops_job_result_latest;
DROP VIEW IF EXISTS ops.v_ops_job_recent;
DROP VIEW IF EXISTS ops.v_ops_job_queue_summary;
DROP VIEW IF EXISTS ops.v_ops_job_queue_stuck;
DROP VIEW IF EXISTS ops.v_ops_job_queue_open;
DROP VIEW IF EXISTS ops.v_ops_job_queue_failed;
DROP VIEW IF EXISTS ops.v_ops_job_metrics;
DROP VIEW IF EXISTS ops.v_document_send_fee_calc;
DROP VIEW IF EXISTS ops.v_dashboard_send_summary;
DROP SEQUENCE IF EXISTS ops.send_fee_master_fee_id_seq;
DROP TABLE IF EXISTS ops.send_fee_master;
DROP TABLE IF EXISTS ops.runtime_health;
DROP TABLE IF EXISTS ops.runtime_flag;
DROP TABLE IF EXISTS ops.resend_type_master;
DROP SEQUENCE IF EXISTS ops.pdf_generate_queue_queue_id_seq;
DROP TABLE IF EXISTS ops.pdf_generate_queue;
DROP TABLE IF EXISTS ops.ops_job_result;
DROP SEQUENCE IF EXISTS ops.ops_job_queue_job_id_seq;
DROP TABLE IF EXISTS ops.ops_idempotency;
DROP SEQUENCE IF EXISTS ops.notification_outbox_notification_id_seq;
DROP TABLE IF EXISTS ops.notification_outbox;
DROP TABLE IF EXISTS ops.document_type_master;
DROP SEQUENCE IF EXISTS ops.document_send_queue_send_queue_id_seq;
DROP TABLE IF EXISTS ops.document_send_queue;
DROP SEQUENCE IF EXISTS ops.document_send_history_send_history_id_seq;
DROP SEQUENCE IF EXISTS ops.document_file_document_file_id_seq;
DROP TABLE IF EXISTS ops.document_file;
DROP TABLE IF EXISTS ops.business_event;
DROP TABLE IF EXISTS ops.backup_log;
DROP TABLE IF EXISTS ops.approval_rule;
DROP VIEW IF EXISTS notify.v_audit_recent;
DROP SEQUENCE IF EXISTS notify.notification_template_template_id_seq;
DROP TABLE IF EXISTS notify.notification_template;
DROP SEQUENCE IF EXISTS notify.notification_route_route_id_seq;
DROP TABLE IF EXISTS notify.notification_route;
DROP SEQUENCE IF EXISTS notify.notification_log_notification_id_seq;
DROP TABLE IF EXISTS notify.notification_log;
DROP SEQUENCE IF EXISTS notify.audit_trail_audit_id_seq;
DROP TABLE IF EXISTS notify.audit_trail;
DROP SEQUENCE IF EXISTS notify.approval_request_approval_request_id_seq;
DROP TABLE IF EXISTS notify.approval_request;
DROP SEQUENCE IF EXISTS notify.approval_action_log_action_log_id_seq;
DROP TABLE IF EXISTS notify.approval_action_log;
DROP SEQUENCE IF EXISTS notify.ai_rule_ai_rule_id_seq;
DROP TABLE IF EXISTS notify.ai_rule;
DROP SEQUENCE IF EXISTS notify.ai_event_ai_event_id_seq;
DROP TABLE IF EXISTS notify.ai_event;
DROP VIEW IF EXISTS media.v_item_images;
DROP TABLE IF EXISTS media.asset_link;
DROP SEQUENCE IF EXISTS media.asset_asset_id_seq;
DROP TABLE IF EXISTS media.asset;
DROP SEQUENCE IF EXISTS manufacturing.yield_metric_yield_metric_id_seq;
DROP TABLE IF EXISTS manufacturing.yield_metric;
DROP SEQUENCE IF EXISTS manufacturing.work_order_work_order_id_seq;
DROP TABLE IF EXISTS manufacturing.work_order;
DROP SEQUENCE IF EXISTS manufacturing.routing_operation_routing_operation_id_seq;
DROP TABLE IF EXISTS manufacturing.routing_operation;
DROP SEQUENCE IF EXISTS manufacturing.routing_header_routing_id_seq;
DROP TABLE IF EXISTS manufacturing.routing_header;
DROP SEQUENCE IF EXISTS manufacturing.process_master_process_id_seq;
DROP TABLE IF EXISTS manufacturing.process_master;
DROP SEQUENCE IF EXISTS manufacturing.mrp_run_mrp_run_id_seq;
DROP TABLE IF EXISTS manufacturing.mrp_run;
DROP SEQUENCE IF EXISTS manufacturing.mrp_requirement_mrp_requirement_id_seq;
DROP TABLE IF EXISTS manufacturing.mrp_requirement;
DROP SEQUENCE IF EXISTS manufacturing.mrp_allocation_mrp_allocation_id_seq;
DROP TABLE IF EXISTS manufacturing.mrp_allocation;
DROP SEQUENCE IF EXISTS manufacturing.mps_run_mps_run_id_seq;
DROP TABLE IF EXISTS manufacturing.mps_run;
DROP SEQUENCE IF EXISTS manufacturing.mps_plan_mps_plan_id_seq;
DROP TABLE IF EXISTS manufacturing.mps_plan;
DROP SEQUENCE IF EXISTS manufacturing.manufacturing_execution_execution_id_seq;
DROP SEQUENCE IF EXISTS manufacturing.manufacturing_execution_detail_execution_detail_id_seq;
DROP TABLE IF EXISTS manufacturing.manufacturing_execution_detail;
DROP TABLE IF EXISTS manufacturing.manufacturing_execution;
DROP SEQUENCE IF EXISTS manufacturing.manufacturing_cost_snapshot_manufacturing_cost_snapshot_id_seq;
DROP TABLE IF EXISTS manufacturing.manufacturing_cost_snapshot;
DROP SEQUENCE IF EXISTS manufacturing.bom_header_bom_id_seq;
DROP TABLE IF EXISTS manufacturing.bom_header;
DROP SEQUENCE IF EXISTS manufacturing.bom_detail_bom_detail_id_seq;
DROP TABLE IF EXISTS manufacturing.bom_detail;
DROP SEQUENCE IF EXISTS inventory.warehouse_warehouse_id_seq;
DROP TABLE IF EXISTS inventory.warehouse;
DROP VIEW IF EXISTS inventory.v_change_history;
DROP SEQUENCE IF EXISTS inventory.storage_location_location_id_seq;
DROP TABLE IF EXISTS inventory.storage_location;
DROP SEQUENCE IF EXISTS inventory.stocktaking_result_stocktaking_result_id_seq;
DROP TABLE IF EXISTS inventory.stocktaking_result;
DROP SEQUENCE IF EXISTS inventory.stocktaking_plan_stocktaking_plan_id_seq;
DROP TABLE IF EXISTS inventory.stocktaking_plan;
DROP SEQUENCE IF EXISTS inventory.stock_transfer_header_stock_transfer_id_seq;
DROP TABLE IF EXISTS inventory.stock_transfer_header;
DROP SEQUENCE IF EXISTS inventory.stock_transfer_detail_stock_transfer_detail_id_seq;
DROP TABLE IF EXISTS inventory.stock_transfer_detail;
DROP SEQUENCE IF EXISTS inventory.stock_transaction_stock_tx_id_seq;
DROP TABLE IF EXISTS inventory.stock_transaction;
DROP SEQUENCE IF EXISTS inventory.stock_reservation_stock_reservation_id_seq;
DROP TABLE IF EXISTS inventory.stock_reservation;
DROP SEQUENCE IF EXISTS inventory.stock_lot_stock_lot_id_seq;
DROP SEQUENCE IF EXISTS inventory.stock_lot_balance_stock_lot_balance_id_seq;
DROP TABLE IF EXISTS inventory.stock_lot_balance;
DROP TABLE IF EXISTS inventory.stock_lot;
DROP SEQUENCE IF EXISTS inventory.stock_bin_bin_id_seq;
DROP TABLE IF EXISTS inventory.stock_bin;
DROP SEQUENCE IF EXISTS inventory.stock_balance_stock_balance_id_seq;
DROP TABLE IF EXISTS inventory.stock_balance;
DROP SEQUENCE IF EXISTS inventory.inventory_valuation_inventory_valuation_id_seq;
DROP TABLE IF EXISTS inventory.inventory_valuation;
DROP VIEW IF EXISTS integration.v_siem_payload;
DROP VIEW IF EXISTS integration.v_audit_export_payload;
DROP SEQUENCE IF EXISTS integration.siem_endpoint_endpoint_id_seq;
DROP TABLE IF EXISTS integration.siem_endpoint;
DROP SEQUENCE IF EXISTS integration.siem_delivery_queue_delivery_id_seq;
DROP TABLE IF EXISTS integration.siem_delivery_queue;
DROP SEQUENCE IF EXISTS integration.integration_log_integration_log_id_seq;
DROP TABLE IF EXISTS integration.integration_log;
DROP SEQUENCE IF EXISTS integration.integration_job_integration_job_id_seq;
DROP TABLE IF EXISTS integration.integration_job;
DROP SEQUENCE IF EXISTS integration.external_system_external_system_id_seq;
DROP TABLE IF EXISTS integration.external_system;
DROP SEQUENCE IF EXISTS integration.audit_export_queue_export_id_seq;
DROP TABLE IF EXISTS integration.audit_export_queue;
DROP SEQUENCE IF EXISTS integration.api_credential_api_credential_id_seq;
DROP TABLE IF EXISTS integration.api_credential;
DROP VIEW IF EXISTS hr.v_change_history;
DROP SEQUENCE IF EXISTS hr.payroll_slip_payroll_slip_id_seq;
DROP TABLE IF EXISTS hr.payroll_slip;
DROP SEQUENCE IF EXISTS hr.payroll_run_payroll_run_id_seq;
DROP TABLE IF EXISTS hr.payroll_run;
DROP TABLE IF EXISTS hr.leave_type;
DROP SEQUENCE IF EXISTS hr.leave_request_leave_request_id_seq;
DROP TABLE IF EXISTS hr.leave_request;
DROP SEQUENCE IF EXISTS hr.hr_position_position_id_seq;
DROP TABLE IF EXISTS hr.hr_position;
DROP SEQUENCE IF EXISTS hr.hr_department_department_id_seq;
DROP TABLE IF EXISTS hr.hr_department;
DROP SEQUENCE IF EXISTS hr.employment_contract_employment_contract_id_seq;
DROP TABLE IF EXISTS hr.employment_contract;
DROP SEQUENCE IF EXISTS hr.employee_employee_id_seq;
DROP TABLE IF EXISTS hr.employee;
DROP SEQUENCE IF EXISTS hr.attendance_log_attendance_log_id_seq;
DROP TABLE IF EXISTS hr.attendance_log;
DROP VIEW IF EXISTS governance.v_policy_yaml_source;
DROP SEQUENCE IF EXISTS governance.policy_change_queue_policy_change_id_seq;
DROP SEQUENCE IF EXISTS governance.document_category_document_category_id_seq;
DROP TABLE IF EXISTS governance.document_category;
DROP SEQUENCE IF EXISTS governance.document_archive_document_archive_id_seq;
DROP TABLE IF EXISTS governance.document_archive;
DROP SEQUENCE IF EXISTS governance.contract_item_price_contract_item_price_id_seq;
DROP TABLE IF EXISTS governance.contract_item_price;
DROP SEQUENCE IF EXISTS governance.contract_header_contract_id_seq;
DROP TABLE IF EXISTS governance.contract_header;
DROP SEQUENCE IF EXISTS governance.business_rule_condition_rule_condition_id_seq;
DROP TABLE IF EXISTS governance.business_rule_condition;
DROP SEQUENCE IF EXISTS governance.business_rule_business_rule_id_seq;
DROP SEQUENCE IF EXISTS governance.business_rule_action_rule_action_id_seq;
DROP TABLE IF EXISTS governance.business_rule_action;
DROP TABLE IF EXISTS governance.business_rule;
DROP SEQUENCE IF EXISTS finance.payment_payment_id_seq;
DROP SEQUENCE IF EXISTS finance.payment_allocation_payment_allocation_id_seq;
DROP TABLE IF EXISTS finance.payment_allocation;
DROP TABLE IF EXISTS finance.payment;
DROP SEQUENCE IF EXISTS finance.bank_statement_line_bank_statement_line_id_seq;
DROP TABLE IF EXISTS finance.bank_statement_line;
DROP SEQUENCE IF EXISTS finance.bank_statement_header_bank_statement_id_seq;
DROP TABLE IF EXISTS finance.bank_statement_header;
DROP SEQUENCE IF EXISTS finance.bank_account_bank_account_id_seq;
DROP TABLE IF EXISTS finance.bank_account;
DROP TABLE IF EXISTS devops.codegen_run;
DROP TABLE IF EXISTS devops.codegen_artifact;
DROP VIEW IF EXISTS core.v_change_history_all;
DROP VIEW IF EXISTS core.v_audit_diff_only;
DROP TABLE IF EXISTS core.user_permissions;
DROP TABLE IF EXISTS core.uom_conversion;
DROP TABLE IF EXISTS core.uom;
DROP SEQUENCE IF EXISTS core.sync_queue_sync_id_seq;
DROP TABLE IF EXISTS core.sync_queue;
DROP SEQUENCE IF EXISTS core.status_master_status_id_seq;
DROP TABLE IF EXISTS core.status_master;
DROP SEQUENCE IF EXISTS core.status_history_status_history_id_seq;
DROP TABLE IF EXISTS core.status_history;
DROP TABLE IF EXISTS core.reason_code_master;
DROP SEQUENCE IF EXISTS core.posting_profile_posting_profile_id_seq;
DROP TABLE IF EXISTS core.posting_profile;
DROP SEQUENCE IF EXISTS core.permissions_permission_id_seq;
DROP TABLE IF EXISTS core.permissions;
DROP SEQUENCE IF EXISTS core.permission_groups_group_id_seq;
DROP TABLE IF EXISTS core.permission_groups;
DROP TABLE IF EXISTS core.permission_group_permissions;
DROP SEQUENCE IF EXISTS core.payment_term_payment_term_id_seq;
DROP TABLE IF EXISTS core.payment_term;
DROP TABLE IF EXISTS core.payment_method;
DROP SEQUENCE IF EXISTS core.login_history_login_id_seq;
DROP TABLE IF EXISTS core.login_history;
DROP TABLE IF EXISTS core.license_master;
DROP SEQUENCE IF EXISTS core.journal_source_link_journal_source_link_id_seq;
DROP TABLE IF EXISTS core.journal_source_link;
DROP SEQUENCE IF EXISTS core.journal_lines_journal_line_id_seq;
DROP TABLE IF EXISTS core.journal_lines;
DROP SEQUENCE IF EXISTS core.journal_entries_journal_id_seq;
DROP TABLE IF EXISTS core.journal_entries;
DROP SEQUENCE IF EXISTS core.entity_attribute_value_attribute_value_id_seq;
DROP TABLE IF EXISTS core.entity_attribute_value;
DROP SEQUENCE IF EXISTS core.entity_attribute_def_attribute_def_id_seq;
DROP TABLE IF EXISTS core.entity_attribute_def;
DROP SEQUENCE IF EXISTS core.document_sequence_sequence_id_seq;
DROP TABLE IF EXISTS core.document_sequence;
DROP SEQUENCE IF EXISTS core.company_users_company_user_id_seq;
DROP TABLE IF EXISTS core.company_users;
DROP SEQUENCE IF EXISTS core.company_permission_company_permission_id_seq;
DROP TABLE IF EXISTS core.company_permission;
DROP SEQUENCE IF EXISTS core.company_license_company_license_id_seq;
DROP TABLE IF EXISTS core.company;
DROP TABLE IF EXISTS core.audit_trail_2026_07;
DROP TABLE IF EXISTS core.audit_trail_2026_06;
DROP TABLE IF EXISTS core.audit_trail_2026_05;
DROP TABLE IF EXISTS core.audit_trail_2026_04;
DROP TABLE IF EXISTS core.audit_trail_2026_03;
DROP TABLE IF EXISTS core.audit_trail_2026_02;
DROP TABLE IF EXISTS core.audit_trail_2026_01;
DROP TABLE IF EXISTS core.audit_trail_2025_12;
DROP SEQUENCE IF EXISTS core.audit_trail_audit_trail_id_seq;
DROP SEQUENCE IF EXISTS core.audit_impact_rule_rule_id_seq;
DROP TABLE IF EXISTS core.audit_impact_rule;
DROP TABLE IF EXISTS core.audit_entity_pk_map;
DROP SEQUENCE IF EXISTS core.audit_column_weight_column_weight_id_seq;
DROP TABLE IF EXISTS core.audit_column_weight;
DROP TABLE IF EXISTS core.app_user;
DROP SEQUENCE IF EXISTS core.accounts_account_id_seq;
DROP TABLE IF EXISTS core.accounts;
DROP SEQUENCE IF EXISTS core.accounting_period_period_id_seq;
DROP TABLE IF EXISTS core.accounting_period;
DROP SEQUENCE IF EXISTS compliance.iso_standard_iso_standard_id_seq;
DROP TABLE IF EXISTS compliance.iso_standard;
DROP SEQUENCE IF EXISTS compliance.iso_clause_iso_clause_id_seq;
DROP TABLE IF EXISTS compliance.iso_clause;
DROP SEQUENCE IF EXISTS compliance.audit_issue_audit_issue_id_seq;
DROP TABLE IF EXISTS compliance.audit_issue;
DROP SEQUENCE IF EXISTS compliance.audit_event_audit_event_id_seq;
DROP TABLE IF EXISTS compliance.audit_event;
DROP SEQUENCE IF EXISTS compliance.audit_action_audit_action_id_seq;
DROP TABLE IF EXISTS compliance.audit_action;
DROP VIEW IF EXISTS ci.v_sla_overdue_requests;
DROP VIEW IF EXISTS ci.v_schema_change_sla_30d;
DROP VIEW IF EXISTS ci.v_schema_change_approvable;
DROP VIEW IF EXISTS ci.v_pending_with_ui_link;
DROP VIEW IF EXISTS ci.v_ops_dashboard;
DROP VIEW IF EXISTS ci.v_schema_change_sla;
DROP VIEW IF EXISTS ci.v_kill_switch;
DROP VIEW IF EXISTS ci.v_edge_deploy_allowed;
DROP VIEW IF EXISTS ci.v_android_pending;
DROP VIEW IF EXISTS ci.v_admin_all_requests;
DROP TABLE IF EXISTS ci.slack_interaction_log;
DROP TABLE IF EXISTS ci.slack_approval_audit;
DROP TABLE IF EXISTS ci.sla_escalation_policy;
DROP TABLE IF EXISTS ci.schema_review_summary;
DROP TABLE IF EXISTS ci.schema_review_prompt_template;
DROP TABLE IF EXISTS ci.schema_ai_review_job;
DROP TABLE IF EXISTS ci.ops_notification_queue;
DROP TABLE IF EXISTS ci.kill_switch;
DROP TABLE IF EXISTS ci.json_schema_check_log;
DROP TABLE IF EXISTS ci.escalation_outbox;
DROP VIEW IF EXISTS billing.v_invoice_render_data_ext;
DROP VIEW IF EXISTS billing.v_invoice_render_data;
DROP TABLE IF EXISTS billing.issuer_profile;
DROP TABLE IF EXISTS billing.invoice_template;
DROP TABLE IF EXISTS billing.invoice_send_retry;
DROP TABLE IF EXISTS billing.invoice_send_audit;
DROP TABLE IF EXISTS billing.invoice_line;
DROP TABLE IF EXISTS billing.invoice;
DROP TABLE IF EXISTS billing.customer_profile;
DROP TABLE IF EXISTS billing.checkout_session;
DROP TABLE IF EXISTS auth.users;
DROP TABLE IF EXISTS auth.sso_providers;
DROP TABLE IF EXISTS auth.sso_domains;
DROP TABLE IF EXISTS auth.sessions;
DROP TABLE IF EXISTS auth.schema_migrations;
DROP TABLE IF EXISTS auth.saml_relay_states;
DROP TABLE IF EXISTS auth.saml_providers;
DROP SEQUENCE IF EXISTS auth.refresh_tokens_id_seq;
DROP TABLE IF EXISTS auth.refresh_tokens;
DROP TABLE IF EXISTS auth.one_time_tokens;
DROP TABLE IF EXISTS auth.oauth_consents;
DROP TABLE IF EXISTS auth.oauth_clients;
DROP TABLE IF EXISTS auth.oauth_client_states;
DROP TABLE IF EXISTS auth.oauth_authorizations;
DROP TABLE IF EXISTS auth.mfa_factors;
DROP TABLE IF EXISTS auth.mfa_challenges;
DROP TABLE IF EXISTS auth.mfa_amr_claims;
DROP TABLE IF EXISTS auth.instances;
DROP TABLE IF EXISTS auth.identities;
DROP TABLE IF EXISTS auth.flow_state;
DROP TABLE IF EXISTS auth.audit_log_entries;
DROP VIEW IF EXISTS audit.v_external_audit_kpi_weekly_trend;
DROP VIEW IF EXISTS audit.v_external_audit_kpi_summary;
DROP VIEW IF EXISTS audit.v_external_audit_kpi_monthly_trend;
DROP VIEW IF EXISTS audit.v_external_audit_kpi_by_industry;
DROP VIEW IF EXISTS audit.v_external_audit_events;
DROP VIEW IF EXISTS audit.v_audit_target_suggestions;
DROP TABLE IF EXISTS audit.slack_interaction_log;
DROP SEQUENCE IF EXISTS audit.ops_audit_log_audit_id_seq;
DROP TABLE IF EXISTS audit.ops_audit_log;
DROP TABLE IF EXISTS audit.notification_channel;
DROP SEQUENCE IF EXISTS audit.ng_event_ng_event_id_seq;
DROP SEQUENCE IF EXISTS audit.exec_audit_event_audit_event_id_seq;
DROP TABLE IF EXISTS audit.exec_audit_event;
DROP SEQUENCE IF EXISTS audit.entity_status_history_status_history_id_seq;
DROP TABLE IF EXISTS audit.entity_status_history;
DROP SEQUENCE IF EXISTS audit.audit_trail_db_audit_trail_db_id_seq;
DROP TABLE IF EXISTS audit.audit_trail_db;
DROP TABLE IF EXISTS audit.audit_target_table;
DROP TABLE IF EXISTS audit.audit_reason_policy;
DROP SEQUENCE IF EXISTS audit.audit_event_audit_event_id_seq;
DROP TABLE IF EXISTS audit.audit_event;
DROP TABLE IF EXISTS audit.approval_reason_template;
DROP TABLE IF EXISTS audit.approval_notify_queue;
DROP VIEW IF EXISTS approval.v_sla_escalation;
DROP VIEW IF EXISTS approval.v_sla_distribution_monthly;
DROP VIEW IF EXISTS approval.v_severity_escalation_target;
DROP VIEW IF EXISTS approval.v_saas_limit_status;
DROP VIEW IF EXISTS approval.v_saas_kpi_company;
DROP VIEW IF EXISTS approval.v_roi_report_export;
DROP VIEW IF EXISTS approval.v_public_pricing_export;
DROP VIEW IF EXISTS approval.v_policy_roi_yen;
DROP VIEW IF EXISTS approval.v_policy_eval_auto_ok;
DROP VIEW IF EXISTS approval.v_policy_ab_test;
DROP VIEW IF EXISTS approval.v_pmloop_restart_target;
DROP VIEW IF EXISTS approval.v_pending_approval_ui;
DROP VIEW IF EXISTS approval.v_payment_status;
DROP VIEW IF EXISTS approval.v_monthly_roi_report;
DROP VIEW IF EXISTS approval.v_monthly_request_count;
DROP VIEW IF EXISTS approval.v_layer2_active_policies;
DROP VIEW IF EXISTS approval.v_jsox_control_matrix;
DROP VIEW IF EXISTS approval.v_invoice_for_payment;
DROP VIEW IF EXISTS approval.v_feature_enabled_company;
DROP VIEW IF EXISTS approval.v_exec_dashboard_yoy;
DROP VIEW IF EXISTS approval.v_exec_dashboard;
DROP VIEW IF EXISTS approval.v_daily_quality_report;
DROP VIEW IF EXISTS approval.v_bottleneck_policy;
DROP VIEW IF EXISTS approval.v_bad_candidate_audit_strict;
DROP VIEW IF EXISTS approval.v_bad_candidate_all;
DROP VIEW IF EXISTS approval.v_bad_candidate_extended;
DROP VIEW IF EXISTS approval.v_bad_candidate_audit;
DROP VIEW IF EXISTS approval.v_bad_candidate;
DROP VIEW IF EXISTS approval.v_autopilot_recommendation;
DROP VIEW IF EXISTS approval.v_policy_roi;
DROP VIEW IF EXISTS approval.v_policy_eval_7d;
DROP VIEW IF EXISTS approval.v_autopilot_company_enabled;
DROP VIEW IF EXISTS approval.v_auto_policy_activate;
DROP VIEW IF EXISTS approval.v_audit_report_export;
DROP VIEW IF EXISTS approval.v_approval_sla_kpi;
DROP VIEW IF EXISTS approval.v_approval_result_event;
DROP VIEW IF EXISTS approval.v_approval_result_enriched;
DROP VIEW IF EXISTS approval.v_approval_audit;
DROP TABLE IF EXISTS audit.approval_log;
DROP VIEW IF EXISTS approval.v_ai_saas_enabled;
DROP VIEW IF EXISTS public.company_license;
DROP TABLE IF EXISTS core.company_license;
DROP VIEW IF EXISTS approval.v_ai_rule_applicable_order;
DROP VIEW IF EXISTS approval.v_ai_override_audit_report;
DROP VIEW IF EXISTS approval.v_audit_action_classified;
DROP VIEW IF EXISTS public.audit_trail;
DROP VIEW IF EXISTS approval.v_ai_llm_input;
DROP VIEW IF EXISTS approval.v_ai_improvement_input;
DROP VIEW IF EXISTS sales.v_order_summary;
DROP TABLE IF EXISTS sales.order_detail;
DROP TABLE IF EXISTS approval.stripe_webhook_event;
DROP TABLE IF EXISTS approval.saas_usage_monthly;
DROP TABLE IF EXISTS approval.saas_usage_daily;
DROP TABLE IF EXISTS approval.saas_subscription;
DROP TABLE IF EXISTS approval.saas_plan_limit;
DROP TABLE IF EXISTS approval.saas_plan;
DROP TABLE IF EXISTS approval.saas_company_map;
DROP TABLE IF EXISTS approval.rework_task;
DROP TABLE IF EXISTS approval.public_pricing;
DROP TABLE IF EXISTS approval.policy_rollout_log;
DROP TABLE IF EXISTS approval.policy_rollout;
DROP TABLE IF EXISTS approval.policy_eval_event;
DROP TABLE IF EXISTS approval.policy_auto_generated;
DROP TABLE IF EXISTS approval.policy_activation_log;
DROP TABLE IF EXISTS approval.plan_master;
DROP TABLE IF EXISTS approval.payment_provider;
DROP TABLE IF EXISTS approval.lp_copy_i18n;
DROP TABLE IF EXISTS approval.jsox_evidence_log;
DROP TABLE IF EXISTS approval.jsox_control;
DROP TABLE IF EXISTS approval.invoice_delivery_log;
DROP TABLE IF EXISTS approval.feature_flag;
DROP TABLE IF EXISTS approval.company_plan;
DROP TABLE IF EXISTS approval.company_cost;
DROP TABLE IF EXISTS approval.billing_payment;
DROP TABLE IF EXISTS approval.billing_invoice;
DROP TABLE IF EXISTS approval.billing_customer;
DROP TABLE IF EXISTS approval.approver;
DROP TABLE IF EXISTS approval.ai_improvement_proposal;
DROP VIEW IF EXISTS analytics.v_sox_iso_audit_report;
DROP VIEW IF EXISTS analytics.v_sox_financial_change_report;
DROP VIEW IF EXISTS analytics.v_sox_access_change_report;
DROP VIEW IF EXISTS analytics.v_ops_kpi;
DROP VIEW IF EXISTS analytics.v_iso_process_change_report;
DROP VIEW IF EXISTS analytics.v_final_ops_dashboard;
DROP VIEW IF EXISTS analytics.v_sla_status;
DROP VIEW IF EXISTS analytics.v_ops_overview;
DROP VIEW IF EXISTS analytics.v_audit_with_impact;
DROP VIEW IF EXISTS analytics.v_audit_user_activity;
DROP VIEW IF EXISTS analytics.v_audit_top_impact;
DROP VIEW IF EXISTS analytics.v_audit_table_rank;
DROP VIEW IF EXISTS analytics.v_audit_summary_report;
DROP VIEW IF EXISTS analytics.v_audit_reason_kpi;
DROP VIEW IF EXISTS analytics.v_audit_export;
DROP VIEW IF EXISTS analytics.v_audit_dashboard_daily;
DROP VIEW IF EXISTS analytics.v_audit_dashboard;
DROP VIEW IF EXISTS analytics.v_audit_daily_summary;
DROP VIEW IF EXISTS analytics.v_audit_daily_count;
DROP TABLE IF EXISTS core.audit_trail;
DROP VIEW IF EXISTS analytics.v_approval_sla;
DROP VIEW IF EXISTS analytics.v_approval_backlog;
DROP VIEW IF EXISTS analytics.v_ai_sla_risk;
DROP VIEW IF EXISTS analytics.v_domain_sla;
DROP VIEW IF EXISTS analytics.v_ai_rule_suggest;
DROP VIEW IF EXISTS analytics.v_ai_object_inventory;
DROP VIEW IF EXISTS analytics.v_ai_module_manifest;
DROP VIEW IF EXISTS analytics.v_ai_job_type_master;
DROP VIEW IF EXISTS analytics.v_ai_job_stats;
DROP VIEW IF EXISTS analytics.v_ai_insight_outbox;
DROP TABLE IF EXISTS tenant.company;
DROP VIEW IF EXISTS analytics.v_ai_insight_applied;
DROP VIEW IF EXISTS analytics.v_ai_insight_actionable;
DROP VIEW IF EXISTS analytics.v_ai_feedback_stats_ext;
DROP VIEW IF EXISTS analytics.v_ai_feedback_stats;
DROP VIEW IF EXISTS analytics.v_ai_approval_opt_candidate;
DROP TABLE IF EXISTS ci.schema_change_request;
DROP VIEW IF EXISTS analytics.v_admin_alert_review;
DROP TABLE IF EXISTS governance.policy_change_queue;
DROP TABLE IF EXISTS analytics.sla_escalation_target;
DROP TABLE IF EXISTS analytics.sla_definition;
DROP TABLE IF EXISTS analytics.sla_breach_event;
DROP SEQUENCE IF EXISTS analytics.notification_queue_notification_id_seq;
DROP SEQUENCE IF EXISTS analytics.fact_metric_fact_id_seq;
DROP TABLE IF EXISTS analytics.fact_metric;
DROP SEQUENCE IF EXISTS analytics.audit_alert_rule_rule_id_seq;
DROP TABLE IF EXISTS analytics.audit_alert_rule;
DROP SEQUENCE IF EXISTS analytics.audit_alert_notification_notification_id_seq;
DROP TABLE IF EXISTS analytics.audit_alert_notification;
DROP SEQUENCE IF EXISTS analytics.audit_alert_event_alert_event_id_seq;
DROP TABLE IF EXISTS analytics.audit_alert_event;
DROP SEQUENCE IF EXISTS analytics.audit_alert_ai_judgement_judgement_id_seq;
DROP TABLE IF EXISTS analytics.audit_alert_ai_judgement;
DROP SEQUENCE IF EXISTS analytics.audit_ai_llm_result_llm_result_id_seq;
DROP TABLE IF EXISTS analytics.audit_ai_llm_result;
DROP SEQUENCE IF EXISTS analytics.audit_ai_job_job_id_seq;
DROP TABLE IF EXISTS analytics.audit_ai_job;
DROP SEQUENCE IF EXISTS analytics.audit_ai_feedback_feedback_id_seq;
DROP TABLE IF EXISTS analytics.audit_ai_feedback;
DROP TABLE IF EXISTS analytics.ai_rate_limit;
DROP TABLE IF EXISTS analytics.ai_module_manifest;
DROP TABLE IF EXISTS analytics.ai_kill_switch;
DROP TABLE IF EXISTS analytics.ai_job_type_master;
DROP SEQUENCE IF EXISTS analytics.ai_job_ai_job_id_seq;
DROP TABLE IF EXISTS analytics.ai_insight_job;
DROP SEQUENCE IF EXISTS analytics.ai_event_ai_event_id_seq;
DROP TABLE IF EXISTS analytics.ai_apply_audit;
DROP VIEW IF EXISTS accounting.v_paper_send_fee_posting;
DROP TABLE IF EXISTS ops.send_channel_master;
DROP TABLE IF EXISTS ops.document_send_history;
DROP SEQUENCE IF EXISTS accounting.paper_send_fee_journal_journal_id_seq;
DROP TABLE IF EXISTS accounting.paper_send_fee_journal;
DROP FUNCTION IF EXISTS system.tg_set_updated_at();
DROP FUNCTION IF EXISTS system.tg_exec_run_notify();
DROP FUNCTION IF EXISTS system.request_exec_simple(p_command_code text, p_args jsonb, p_priority integer);
DROP FUNCTION IF EXISTS system.request_exec(p_command_code text, p_args jsonb, p_priority integer);
DROP FUNCTION IF EXISTS system.render_command(p_command_text text, p_args jsonb);
DROP FUNCTION IF EXISTS system.pick_next_exec_request(p_worker_tag text, p_command_code text);
DROP FUNCTION IF EXISTS system.pick_next_exec_request(p_worker_id uuid);
DROP FUNCTION IF EXISTS system.pick_next_ai_task(p_agent_code text);
DROP FUNCTION IF EXISTS system.mark_loop_ran(p_loop_code text, p_interval_sec integer, p_jitter_sec integer);
DROP FUNCTION IF EXISTS system.loop_mark_start(p_loop_code text);
DROP FUNCTION IF EXISTS system.loop_mark_done(p_loop_code text, p_note text);
DROP FUNCTION IF EXISTS system.log_operation(p_session_id uuid, p_role_code text, p_module_code text, p_function_code text, p_screen_code text, p_operation_type text, p_target_table text, p_target_id text, p_operation_status text, p_error_message text);
DROP FUNCTION IF EXISTS system.get_due_loops(p_now timestamp with time zone);
DROP FUNCTION IF EXISTS system.get_due_loops();
DROP FUNCTION IF EXISTS system.get_active_loop_configs();
DROP FUNCTION IF EXISTS system.finalize_business(p_function_code text, p_target_table text, p_business_id bigint);
DROP FUNCTION IF EXISTS system.enqueue_ops_for_finalized_business(p_function_code text, p_document_id bigint, p_business_table text, p_actor uuid);
DROP FUNCTION IF EXISTS system.enqueue_ops_for_finalized(p_function_code text, p_business_table text, p_business_id bigint, p_payload jsonb);
DROP FUNCTION IF EXISTS system.enqueue_notification(p_event_type text, p_payload jsonb);
DROP FUNCTION IF EXISTS system.enqueue_exec_from_approval(p_approval_request_id bigint);
DROP FUNCTION IF EXISTS system.compute_loop_sla(p_start timestamp with time zone, p_end timestamp with time zone);
DROP FUNCTION IF EXISTS system.complete_exec_request(p_request_id bigint, p_exit_code integer, p_stdout text, p_stderr text);
DROP FUNCTION IF EXISTS system.complete_ai_task(p_task_id bigint, p_success boolean, p_result jsonb, p_error text);
DROP FUNCTION IF EXISTS system.calc_next_run_at(p_from timestamp with time zone, p_interval_sec integer, p_jitter_sec integer);
DROP FUNCTION IF EXISTS system.autotune_loops(p_start timestamp with time zone, p_end timestamp with time zone);
DROP FUNCTION IF EXISTS system.autotune_loop_config(p_window_min integer);
DROP FUNCTION IF EXISTS system.approve_request_and_enqueue(p_approval_request_id bigint, p_comment text);
DROP FUNCTION IF EXISTS system.ai_optimize_runtime(p_window_min integer);
DROP FUNCTION IF EXISTS storage.update_updated_at_column();
DROP FUNCTION IF EXISTS storage.search_v2(prefix text, bucket_name text, limits integer, levels integer, start_after text, sort_order text, sort_column text, sort_column_after text);
DROP FUNCTION IF EXISTS storage.search_v1_optimised(prefix text, bucketname text, limits integer, levels integer, offsets integer, search text, sortcolumn text, sortorder text);
DROP FUNCTION IF EXISTS storage.search_legacy_v1(prefix text, bucketname text, limits integer, levels integer, offsets integer, search text, sortcolumn text, sortorder text);
DROP FUNCTION IF EXISTS storage.search(prefix text, bucketname text, limits integer, levels integer, offsets integer, search text, sortcolumn text, sortorder text);
DROP FUNCTION IF EXISTS storage.prefixes_insert_trigger();
DROP FUNCTION IF EXISTS storage.prefixes_delete_cleanup();
DROP FUNCTION IF EXISTS storage.operation();
DROP FUNCTION IF EXISTS storage.objects_update_prefix_trigger();
DROP FUNCTION IF EXISTS storage.objects_update_level_trigger();
DROP FUNCTION IF EXISTS storage.objects_update_cleanup();
DROP FUNCTION IF EXISTS storage.objects_insert_prefix_trigger();
DROP FUNCTION IF EXISTS storage.objects_delete_cleanup();
DROP FUNCTION IF EXISTS storage.lock_top_prefixes(bucket_ids text[], names text[]);
DROP FUNCTION IF EXISTS storage.list_objects_with_delimiter(bucket_id text, prefix_param text, delimiter_param text, max_keys integer, start_after text, next_token text);
DROP FUNCTION IF EXISTS storage.list_multipart_uploads_with_delimiter(bucket_id text, prefix_param text, delimiter_param text, max_keys integer, next_key_token text, next_upload_token text);
DROP FUNCTION IF EXISTS storage.get_size_by_bucket();
DROP FUNCTION IF EXISTS storage.get_prefixes(name text);
DROP FUNCTION IF EXISTS storage.get_prefix(name text);
DROP FUNCTION IF EXISTS storage.get_level(name text);
DROP FUNCTION IF EXISTS storage.foldername(name text);
DROP FUNCTION IF EXISTS storage.filename(name text);
DROP FUNCTION IF EXISTS storage.extension(name text);
DROP FUNCTION IF EXISTS storage.enforce_bucket_name_length();
DROP FUNCTION IF EXISTS storage.delete_prefix_hierarchy_trigger();
DROP FUNCTION IF EXISTS storage.delete_prefix(_bucket_id text, _name text);
DROP FUNCTION IF EXISTS storage.delete_leaf_prefixes(bucket_ids text[], names text[]);
DROP FUNCTION IF EXISTS storage.can_insert_object(bucketid text, name text, owner uuid, metadata jsonb);
DROP FUNCTION IF EXISTS storage.add_prefixes(_bucket_id text, _name text);
DROP FUNCTION IF EXISTS sales.rpc_list_orders(p_from date, p_to date);
DROP TABLE IF EXISTS sales.order_header;
DROP FUNCTION IF EXISTS sales.request_order_approval_safe(p_company_id uuid, p_order_id bigint, p_order_no text, p_policy_id text, p_reason text);
DROP FUNCTION IF EXISTS sales.request_order_approval(p_company_id uuid, p_order_id bigint, p_order_no text, p_policy_id text, p_reason text);
DROP FUNCTION IF EXISTS realtime.topic();
DROP FUNCTION IF EXISTS realtime.to_regrole(role_name text);
DROP FUNCTION IF EXISTS realtime.subscription_check_filters();
DROP FUNCTION IF EXISTS realtime.send(payload jsonb, event text, topic text, private boolean);
DROP FUNCTION IF EXISTS realtime.quote_wal2json(entity regclass);
DROP FUNCTION IF EXISTS realtime.list_changes(publication name, slot_name name, max_changes integer, max_record_bytes integer);
DROP FUNCTION IF EXISTS realtime.is_visible_through_filters(columns realtime.wal_column[], filters realtime.user_defined_filter[]);
DROP FUNCTION IF EXISTS realtime.check_equality_op(op realtime.equality_op, type_ regtype, val_1 text, val_2 text);
DROP FUNCTION IF EXISTS realtime."cast"(val text, type_ regtype);
DROP FUNCTION IF EXISTS realtime.build_prepared_statement_sql(prepared_statement_name text, entity regclass, columns realtime.wal_column[]);
DROP FUNCTION IF EXISTS realtime.broadcast_changes(topic_name text, event_name text, operation text, table_name text, table_schema text, new record, old record, level text);
DROP FUNCTION IF EXISTS realtime.apply_rls(wal jsonb, max_record_bytes integer);
DROP FUNCTION IF EXISTS public.trg_v_sales_shipping_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_sales_quotation_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_sales_quotation_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_return_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_order_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_item_uom_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_item_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_item_category_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_invoice_pdf_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_customer_payment_term_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_customer_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_customer_contact_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_customer_address_iud();
DROP FUNCTION IF EXISTS public.trg_v_sales_billing_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_supplier_payment_term_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_supplier_item_price_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_supplier_contact_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_supplier_address_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_purchase_three_way_match_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_purchase_requisition_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_purchase_requisition_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_purchase_quotation_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_purchase_quotation_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_purchase_order_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_purchase_invoice_iud();
DROP FUNCTION IF EXISTS public.trg_v_purchase_purchase_invoice_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_manufacturing_yield_metric_iud();
DROP FUNCTION IF EXISTS public.trg_v_manufacturing_work_order_iud();
DROP FUNCTION IF EXISTS public.trg_v_manufacturing_routing_operation_iud();
DROP FUNCTION IF EXISTS public.trg_v_manufacturing_mrp_run_iud();
DROP FUNCTION IF EXISTS public.trg_v_manufacturing_mrp_requirement_iud();
DROP FUNCTION IF EXISTS public.trg_v_manufacturing_mrp_allocation_iud();
DROP FUNCTION IF EXISTS public.trg_v_manufacturing_mps_run_iud();
DROP FUNCTION IF EXISTS public.trg_v_manufacturing_mps_plan_iud();
DROP FUNCTION IF EXISTS public.trg_v_manufacturing_manufacturing_cost_snapshot_iud();
DROP FUNCTION IF EXISTS public.trg_v_manufacturing_bom_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_inventory_warehouse_iud();
DROP FUNCTION IF EXISTS public.trg_v_inventory_stocktaking_result_iud();
DROP FUNCTION IF EXISTS public.trg_v_inventory_stocktaking_plan_iud();
DROP FUNCTION IF EXISTS public.trg_v_inventory_stock_transfer_detail_iud();
DROP FUNCTION IF EXISTS public.trg_v_inventory_stock_reservation_iud();
DROP FUNCTION IF EXISTS public.trg_v_inventory_stock_lot_iud();
DROP FUNCTION IF EXISTS public.trg_v_inventory_stock_lot_balance_iud();
DROP FUNCTION IF EXISTS public.trg_v_inventory_stock_balance_iud();
DROP FUNCTION IF EXISTS public.trg_v_inventory_inventory_valuation_iud();
DROP FUNCTION IF EXISTS public.trg_v_hr_payroll_slip_iud();
DROP FUNCTION IF EXISTS public.trg_v_hr_payroll_run_iud();
DROP FUNCTION IF EXISTS public.trg_v_hr_leave_request_iud();
DROP FUNCTION IF EXISTS public.trg_v_hr_employment_contract_iud();
DROP FUNCTION IF EXISTS public.trg_v_hr_employee_iud();
DROP FUNCTION IF EXISTS public.trg_v_hr_attendance_log_iud();
DROP FUNCTION IF EXISTS public.trg_v_finance_payment_iud();
DROP FUNCTION IF EXISTS public.trg_v_finance_payment_allocation_iud();
DROP FUNCTION IF EXISTS public.trg_v_finance_bank_statement_line_iud();
DROP FUNCTION IF EXISTS public.trg_v_finance_bank_account_iud();
DROP FUNCTION IF EXISTS public.trg_v_core_status_history_iud();
DROP FUNCTION IF EXISTS public.trg_v_core_posting_profile_iud();
DROP FUNCTION IF EXISTS public.trg_v_core_payment_term_iud();
DROP FUNCTION IF EXISTS public.trg_v_core_journal_source_link_iud();
DROP FUNCTION IF EXISTS public.trg_v_core_company_permission_iud();
DROP FUNCTION IF EXISTS public.trg_v_core_company_license_iud();
DROP FUNCTION IF EXISTS public.trg_v_core_company_iud();
DROP FUNCTION IF EXISTS public.trg_v_core_audit_trail_iud();
DROP FUNCTION IF EXISTS public.sweep_ai_event(p_company_id uuid, p_keep_days integer);
DROP FUNCTION IF EXISTS public.my_company_id();
DROP FUNCTION IF EXISTS public.mark_notification_sent(p_id bigint);
DROP FUNCTION IF EXISTS public.mark_notification_failed(p_id bigint, p_err text);
DROP FUNCTION IF EXISTS public.mark_ai_job_running(p_ai_job_id bigint);
DROP FUNCTION IF EXISTS public.mark_ai_job_failed(p_ai_job_id bigint, p_err text);
DROP FUNCTION IF EXISTS public.mark_ai_job_done(p_ai_job_id bigint);
DROP FUNCTION IF EXISTS public.mark_ai_event_swept(p_ai_event_id bigint);
DROP FUNCTION IF EXISTS public.is_ai_enabled(p_scope text);
DROP FUNCTION IF EXISTS public.is_admin();
DROP FUNCTION IF EXISTS public.get_pending_notifications();
DROP TABLE IF EXISTS analytics.notification_queue;
DROP FUNCTION IF EXISTS public.get_pending_ai_jobs_all();
DROP FUNCTION IF EXISTS public.get_pending_ai_jobs(p_company_id uuid);
DROP TABLE IF EXISTS analytics.ai_job;
DROP FUNCTION IF EXISTS public.get_ng_events_all();
DROP FUNCTION IF EXISTS public.get_ng_events(p_company_id uuid);
DROP TABLE IF EXISTS analytics.ai_event;
DROP FUNCTION IF EXISTS public.get_ng_events(p_limit integer);
DROP TABLE IF EXISTS audit.ng_event;
DROP FUNCTION IF EXISTS public.get_approval_requests(p_limit integer);
DROP TABLE IF EXISTS audit.approval_request;
DROP FUNCTION IF EXISTS public.enqueue_notification(p_company_id uuid, p_channel text, p_destination text, p_payload jsonb);
DROP FUNCTION IF EXISTS public.create_approval_request(p_domain text, p_entity_type text, p_entity_id text, p_reason text, p_severity text, p_policy_id text);
DROP FUNCTION IF EXISTS public.create_ai_job(p_company_id uuid, p_job_type text, p_params jsonb, p_decided_by text);
DROP FUNCTION IF EXISTS public.act_approval(p_request_id uuid, p_action text, p_note text);
DROP FUNCTION IF EXISTS pgbouncer.get_auth(p_usename text);
DROP FUNCTION IF EXISTS ops.trg_after_job_result();
DROP FUNCTION IF EXISTS ops.tg_touch_updated_at();
DROP FUNCTION IF EXISTS ops.snapshot_ops_structure();
DROP FUNCTION IF EXISTS ops.retry_failed_document_send();
DROP FUNCTION IF EXISTS ops.pick_next_notification();
DROP FUNCTION IF EXISTS ops.pick_next_job(p_job_type text, p_function_code text);
DROP FUNCTION IF EXISTS ops.pick_next_job();
DROP TABLE IF EXISTS ops.ops_job_queue;
DROP FUNCTION IF EXISTS ops.ops_send_dispatch(p_send_history_id bigint);
DROP FUNCTION IF EXISTS ops.fail_job(p_job_id bigint, p_error text, p_detail jsonb);
DROP FUNCTION IF EXISTS ops.fail_job(p_job_id bigint, p_error text);
DROP FUNCTION IF EXISTS ops.enqueue_send_document(p_function_code text, p_document_type_code text, p_business_table text, p_business_id bigint, p_payload jsonb, p_priority integer);
DROP FUNCTION IF EXISTS ops.enqueue_ops_job(p_job_type text, p_function_code text, p_document_type_code text, p_business_table text, p_business_id bigint);
DROP FUNCTION IF EXISTS ops.enqueue_notify_job_for_failed_job(p_job_id bigint);
DROP FUNCTION IF EXISTS ops.enqueue_notification(p_channel_code text, p_destination text, p_message text, p_payload jsonb, p_run_after timestamp with time zone, p_created_by uuid);
DROP FUNCTION IF EXISTS ops.enqueue_job(p_job_type text, p_function_code text, p_document_type_code text, p_business_table text, p_business_id bigint, p_payload jsonb, p_priority integer);
DROP FUNCTION IF EXISTS ops.enqueue_job(p_job_type text, p_payload jsonb, p_run_after timestamp with time zone, p_priority integer, p_max_attempts integer, p_created_by uuid);
DROP FUNCTION IF EXISTS ops.enqueue_generate_pdf(p_function_code text, p_document_type_code text, p_business_table text, p_business_id bigint, p_payload jsonb, p_priority integer);
DROP FUNCTION IF EXISTS ops.enqueue_business_approval();
DROP FUNCTION IF EXISTS ops.dequeue_ops_job();
DROP FUNCTION IF EXISTS ops.dequeue_jobs(p_worker text, p_limit integer);
DROP FUNCTION IF EXISTS ops.complete_notification(p_outbox_id bigint, p_ok boolean, p_error text);
DROP FUNCTION IF EXISTS ops.complete_job(p_job_id bigint, p_result_status text, p_result_detail jsonb);
DROP FUNCTION IF EXISTS ops.complete_job(p_job_id bigint, p_result jsonb);
DROP FUNCTION IF EXISTS ops.cancel_job(p_job_id bigint, p_reason text);
DROP FUNCTION IF EXISTS ops.add_shipping_package_photo(p_shipping_id bigint, p_asset_id bigint, p_is_primary boolean, p_sort_order integer);
DROP FUNCTION IF EXISTS notify.rpc_register_line_user(p_company_id uuid, p_route_key text, p_line_user_id text);
DROP FUNCTION IF EXISTS notify.rpc_mark_ai_event_notified(p_company_id uuid, p_ai_event_id bigint);
DROP FUNCTION IF EXISTS notify.rpc_decide_approval(p_company_id uuid, p_approval_request_id bigint, p_line_user_id text, p_action text, p_note text, p_payload jsonb);
DROP FUNCTION IF EXISTS media.unset_primary(p_entity_table text, p_entity_id bigint, p_role text);
DROP FUNCTION IF EXISTS media.link_asset(p_asset_id bigint, p_entity_table text, p_entity_id bigint, p_role text, p_is_primary boolean, p_sort_order integer);
DROP FUNCTION IF EXISTS media.add_item_image(p_item_entity_table text, p_item_id bigint, p_asset_id bigint, p_is_primary boolean, p_sort_order integer);
DROP FUNCTION IF EXISTS integration.fn_siem_mark_sent(p_delivery_id bigint);
DROP FUNCTION IF EXISTS integration.fn_siem_mark_failed(p_delivery_id bigint, p_error text);
DROP FUNCTION IF EXISTS integration.fn_enqueue_siem_recent(p_endpoint_id bigint, p_minutes integer);
DROP FUNCTION IF EXISTS integration.fn_enqueue_siem_audit(p_from timestamp with time zone, p_to timestamp with time zone, p_endpoint_id bigint);
DROP FUNCTION IF EXISTS integration.fn_enqueue_audit_export(p_range interval);
DROP FUNCTION IF EXISTS extensions.set_graphql_placeholder();
DROP FUNCTION IF EXISTS extensions.pgrst_drop_watch();
DROP FUNCTION IF EXISTS extensions.pgrst_ddl_watch();
DROP FUNCTION IF EXISTS extensions.grant_pg_net_access();
DROP FUNCTION IF EXISTS extensions.grant_pg_graphql_access();
DROP FUNCTION IF EXISTS extensions.grant_pg_cron_access();
DROP FUNCTION IF EXISTS core.trg_require_reason_code();
DROP FUNCTION IF EXISTS core.trg_audit_stmt();
DROP FUNCTION IF EXISTS core.trg_audit_iud_compact_with_entity();
DROP FUNCTION IF EXISTS core.trg_audit_iud_compact();
DROP FUNCTION IF EXISTS core.trg_audit_iud();
DROP FUNCTION IF EXISTS core.fn_validate_reason_code(p_reason_code text, p_op text);
DROP FUNCTION IF EXISTS core.fn_retention_audit_trail_partitions(p_keep_months integer);
DROP FUNCTION IF EXISTS core.fn_resolve_entity_ref(p_entity_type text, p_entity_id text);
DROP FUNCTION IF EXISTS core.fn_log_read_event(p_company_id uuid, p_entity_type text, p_entity_id text, p_context jsonb);
DROP FUNCTION IF EXISTS core.fn_jsonb_diff(old_j jsonb, new_j jsonb);
DROP FUNCTION IF EXISTS core.fn_jsonb_changed_pairs(old_j jsonb, new_j jsonb);
DROP FUNCTION IF EXISTS core.fn_insert_audit_trail(p_company_id uuid, p_entity_type text, p_entity_id text, p_action text, p_action_category text, p_detail jsonb, p_performed_by uuid);
DROP FUNCTION IF EXISTS core.fn_ensure_audit_trail_monthly_partitions(p_months_back integer, p_months_ahead integer);
DROP FUNCTION IF EXISTS core.fn_drop_old_audit_partitions(p_keep_interval interval);
DROP FUNCTION IF EXISTS core.fn_calc_audit_impact(p_company_id uuid, p_entity_type text, p_action text, p_detail jsonb);
DROP FUNCTION IF EXISTS core.fn_audit_trail();
DROP FUNCTION IF EXISTS core.fn_audit_entity_id_order_header(p_order_id bigint);
DROP FUNCTION IF EXISTS core.fn_audit_entity_id_order_detail(p_order_detail_id bigint);
DROP FUNCTION IF EXISTS ci.try_write_audit_trail(p_entity_id uuid, p_action text, p_detail jsonb);
DROP FUNCTION IF EXISTS ci.reject_schema_change(p_request_id uuid, p_rejected_by text, p_reason text);
DROP FUNCTION IF EXISTS ci.enqueue_schema_ai_review();
DROP FUNCTION IF EXISTS ci.build_schema_review_prompt(p_domain text, p_schema_name text, p_diff_summary text);
DROP FUNCTION IF EXISTS ci.audit_schema_change_transitions();
DROP FUNCTION IF EXISTS ci.approve_schema_change(p_request_id uuid, p_approved_by text);
DROP FUNCTION IF EXISTS auth.uid();
DROP FUNCTION IF EXISTS auth.role();
DROP FUNCTION IF EXISTS auth.jwt();
DROP FUNCTION IF EXISTS auth.email();
DROP FUNCTION IF EXISTS audit.trg_audit_generic();
DROP FUNCTION IF EXISTS audit.tg_exec_request_upd();
DROP FUNCTION IF EXISTS audit.tg_exec_request_ins();
DROP FUNCTION IF EXISTS audit.f_get_setting_uuid(p_key text);
DROP FUNCTION IF EXISTS audit.f_get_company_id_from_row(p_row jsonb);
DROP FUNCTION IF EXISTS audit.f_extract_pk_jsonb(p_schema text, p_table text, p_row jsonb);
DROP FUNCTION IF EXISTS audit.f_changed_columns(before_row jsonb, after_row jsonb);
DROP FUNCTION IF EXISTS audit.f_apply_partial_filter(p_changed jsonb, p_audited_cols jsonb);
DROP FUNCTION IF EXISTS audit.current_company_id();
DROP FUNCTION IF EXISTS audit.apply_audit_triggers();
DROP FUNCTION IF EXISTS approval.touch_updated_at();
DROP FUNCTION IF EXISTS approval.set_policy_and_severity();
DROP FUNCTION IF EXISTS approval.safe_request_approval(p_company_id uuid, p_order_id bigint, p_policy_id text, p_reason text);
DROP FUNCTION IF EXISTS approval.reject_request(p_request_id uuid, p_actor uuid, p_note text);
DROP FUNCTION IF EXISTS approval.mark_invoice_paid(p_invoice_id uuid);
DROP FUNCTION IF EXISTS approval.is_in_rollout(p_rollout_percent integer, p_seed text);
DROP FUNCTION IF EXISTS approval.enqueue_rework_from_bad_extended();
DROP FUNCTION IF EXISTS approval.enqueue_rework_from_bad_all();
DROP FUNCTION IF EXISTS approval.enqueue_rework_from_bad();
DROP FUNCTION IF EXISTS approval.decide_request(p_request_id uuid, p_decision text, p_note text);
DROP FUNCTION IF EXISTS approval.decide_approval(p_request_id uuid, p_decision text, p_decided_by uuid, p_note text);
DROP FUNCTION IF EXISTS approval.check_plan_limit(p_company_id uuid);
DROP FUNCTION IF EXISTS approval.assert_saas_limit(p_company_id uuid);
DROP FUNCTION IF EXISTS approval.approve_request(p_request_id uuid, p_actor uuid, p_note text);
DROP FUNCTION IF EXISTS analytics.trg_enqueue_alert_notifications();
DROP FUNCTION IF EXISTS analytics.trg_audit_alert_to_ai_event();
DROP FUNCTION IF EXISTS analytics.trg_ai_job_apply_master();
DROP FUNCTION IF EXISTS analytics.sweep_ai_event_phase9();
DROP FUNCTION IF EXISTS analytics.sweep_ai_event(p_company_id uuid, p_keep_days integer);
DROP FUNCTION IF EXISTS analytics.run_ai_job_cycle();
DROP FUNCTION IF EXISTS analytics.fn_detect_audit_anomalies(p_lookback_minutes integer);
DROP FUNCTION IF EXISTS analytics.eval_audit_alert_rules(p_now timestamp with time zone);
DROP FUNCTION IF EXISTS analytics.eval_ai_judgement_db();
DROP FUNCTION IF EXISTS analytics.enqueue_ai_insights();
DROP FUNCTION IF EXISTS analytics.enqueue_ai_event(p_company_id uuid, p_source_table text, p_source_id bigint, p_event_type text, p_severity text, p_payload jsonb);
DROP TYPE IF EXISTS storage.buckettype;
DROP TYPE IF EXISTS realtime.wal_rls;
DROP TYPE IF EXISTS realtime.wal_column;
DROP TYPE IF EXISTS realtime.user_defined_filter;
DROP TYPE IF EXISTS realtime.equality_op;
DROP TYPE IF EXISTS realtime.action;
DROP TYPE IF EXISTS auth.one_time_token_type;
DROP TYPE IF EXISTS auth.oauth_response_type;
DROP TYPE IF EXISTS auth.oauth_registration_type;
DROP TYPE IF EXISTS auth.oauth_client_type;
DROP TYPE IF EXISTS auth.oauth_authorization_status;
DROP TYPE IF EXISTS auth.factor_type;
DROP TYPE IF EXISTS auth.factor_status;
DROP TYPE IF EXISTS auth.code_challenge_method;
DROP TYPE IF EXISTS auth.aal_level;
DROP EXTENSION IF EXISTS "uuid-ossp";
DROP EXTENSION IF EXISTS supabase_vault;
DROP EXTENSION IF EXISTS pgcrypto;
DROP EXTENSION IF EXISTS pg_stat_statements;
DROP EXTENSION IF EXISTS pg_graphql;
DROP SCHEMA IF EXISTS vault;
DROP SCHEMA IF EXISTS tenant;
DROP SCHEMA IF EXISTS system;
DROP SCHEMA IF EXISTS storage;
DROP SCHEMA IF EXISTS sales;
DROP SCHEMA IF EXISTS realtime;
DROP SCHEMA IF EXISTS purchase;
DROP SCHEMA IF EXISTS pgbouncer;
DROP SCHEMA IF EXISTS ops;
DROP SCHEMA IF EXISTS notify;
DROP EXTENSION IF EXISTS pg_net;
DROP SCHEMA IF EXISTS media;
DROP SCHEMA IF EXISTS manufacturing;
DROP SCHEMA IF EXISTS inventory;
DROP SCHEMA IF EXISTS integration;
DROP SCHEMA IF EXISTS hr;
DROP SCHEMA IF EXISTS graphql_public;
DROP SCHEMA IF EXISTS graphql;
DROP SCHEMA IF EXISTS governance;
DROP SCHEMA IF EXISTS finance;
DROP SCHEMA IF EXISTS extensions;
DROP SCHEMA IF EXISTS devops;
DROP EXTENSION IF EXISTS pg_cron;
DROP SCHEMA IF EXISTS core;
DROP SCHEMA IF EXISTS compliance;
DROP SCHEMA IF EXISTS ci;
DROP SCHEMA IF EXISTS billing;
DROP SCHEMA IF EXISTS auth;
DROP SCHEMA IF EXISTS audit;
DROP SCHEMA IF EXISTS approval;
DROP SCHEMA IF EXISTS analytics;
DROP SCHEMA IF EXISTS accounting;
--
-- Name: accounting; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA accounting;


--
-- Name: analytics; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA analytics;


--
-- Name: approval; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA approval;


--
-- Name: audit; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA audit;


--
-- Name: auth; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA auth;


--
-- Name: billing; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA billing;


--
-- Name: ci; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA ci;


--
-- Name: compliance; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA compliance;


--
-- Name: core; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA core;


--
-- Name: pg_cron; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS pg_cron WITH SCHEMA pg_catalog;


--
-- Name: EXTENSION pg_cron; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION pg_cron IS 'Job scheduler for PostgreSQL';


--
-- Name: devops; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA devops;


--
-- Name: extensions; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA extensions;


--
-- Name: finance; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA finance;


--
-- Name: governance; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA governance;


--
-- Name: graphql; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA graphql;


--
-- Name: graphql_public; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA graphql_public;


--
-- Name: hr; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA hr;


--
-- Name: integration; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA integration;


--
-- Name: inventory; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA inventory;


--
-- Name: manufacturing; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA manufacturing;


--
-- Name: media; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA media;


--
-- Name: pg_net; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS pg_net WITH SCHEMA public;


--
-- Name: EXTENSION pg_net; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION pg_net IS 'Async HTTP';


--
-- Name: notify; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA notify;


--
-- Name: ops; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA ops;


--
-- Name: pgbouncer; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA pgbouncer;


--
-- Name: purchase; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA purchase;


--
-- Name: realtime; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA realtime;


--
-- Name: sales; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA sales;


--
-- Name: storage; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA storage;


--
-- Name: system; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA system;


--
-- Name: tenant; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA tenant;


--
-- Name: vault; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA vault;


--
-- Name: pg_graphql; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS pg_graphql WITH SCHEMA graphql;


--
-- Name: EXTENSION pg_graphql; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION pg_graphql IS 'pg_graphql: GraphQL support';


--
-- Name: pg_stat_statements; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS pg_stat_statements WITH SCHEMA extensions;


--
-- Name: EXTENSION pg_stat_statements; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION pg_stat_statements IS 'track planning and execution statistics of all SQL statements executed';


--
-- Name: pgcrypto; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS pgcrypto WITH SCHEMA extensions;


--
-- Name: EXTENSION pgcrypto; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION pgcrypto IS 'cryptographic functions';


--
-- Name: supabase_vault; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS supabase_vault WITH SCHEMA vault;


--
-- Name: EXTENSION supabase_vault; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION supabase_vault IS 'Supabase Vault Extension';


--
-- Name: uuid-ossp; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS "uuid-ossp" WITH SCHEMA extensions;


--
-- Name: EXTENSION "uuid-ossp"; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION "uuid-ossp" IS 'generate universally unique identifiers (UUIDs)';


--
-- Name: aal_level; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.aal_level AS ENUM (
    'aal1',
    'aal2',
    'aal3'
);


--
-- Name: code_challenge_method; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.code_challenge_method AS ENUM (
    's256',
    'plain'
);


--
-- Name: factor_status; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.factor_status AS ENUM (
    'unverified',
    'verified'
);


--
-- Name: factor_type; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.factor_type AS ENUM (
    'totp',
    'webauthn',
    'phone'
);


--
-- Name: oauth_authorization_status; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.oauth_authorization_status AS ENUM (
    'pending',
    'approved',
    'denied',
    'expired'
);


--
-- Name: oauth_client_type; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.oauth_client_type AS ENUM (
    'public',
    'confidential'
);


--
-- Name: oauth_registration_type; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.oauth_registration_type AS ENUM (
    'dynamic',
    'manual'
);


--
-- Name: oauth_response_type; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.oauth_response_type AS ENUM (
    'code'
);


--
-- Name: one_time_token_type; Type: TYPE; Schema: auth; Owner: -
--

CREATE TYPE auth.one_time_token_type AS ENUM (
    'confirmation_token',
    'reauthentication_token',
    'recovery_token',
    'email_change_token_new',
    'email_change_token_current',
    'phone_change_token'
);


--
-- Name: action; Type: TYPE; Schema: realtime; Owner: -
--

CREATE TYPE realtime.action AS ENUM (
    'INSERT',
    'UPDATE',
    'DELETE',
    'TRUNCATE',
    'ERROR'
);


--
-- Name: equality_op; Type: TYPE; Schema: realtime; Owner: -
--

CREATE TYPE realtime.equality_op AS ENUM (
    'eq',
    'neq',
    'lt',
    'lte',
    'gt',
    'gte',
    'in'
);


--
-- Name: user_defined_filter; Type: TYPE; Schema: realtime; Owner: -
--

CREATE TYPE realtime.user_defined_filter AS (
	column_name text,
	op realtime.equality_op,
	value text
);


--
-- Name: wal_column; Type: TYPE; Schema: realtime; Owner: -
--

CREATE TYPE realtime.wal_column AS (
	name text,
	type_name text,
	type_oid oid,
	value jsonb,
	is_pkey boolean,
	is_selectable boolean
);


--
-- Name: wal_rls; Type: TYPE; Schema: realtime; Owner: -
--

CREATE TYPE realtime.wal_rls AS (
	wal jsonb,
	is_rls_enabled boolean,
	subscription_ids uuid[],
	errors text[]
);


--
-- Name: buckettype; Type: TYPE; Schema: storage; Owner: -
--

CREATE TYPE storage.buckettype AS ENUM (
    'STANDARD',
    'ANALYTICS',
    'VECTOR'
);


--
-- Name: enqueue_ai_event(uuid, text, bigint, text, text, jsonb); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.enqueue_ai_event(p_company_id uuid, p_source_table text, p_source_id bigint, p_event_type text, p_severity text, p_payload jsonb) RETURNS void
    LANGUAGE sql
    AS $$
  insert into analytics.ai_event
    (company_id, source_table, source_id, event_type, severity, payload)
  values
    (p_company_id, p_source_table, p_source_id, p_event_type, p_severity,
     coalesce(p_payload,'{}'::jsonb));
$$;


--
-- Name: enqueue_ai_insights(); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.enqueue_ai_insights() RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  INSERT INTO analytics.ai_insight_job
    (company_id, insight_type, target_key, context)
  SELECT
    company_id,
    'approval_opt',
    schema_name,
    jsonb_build_object('approved_count', approved_count)
  FROM analytics.v_ai_approval_opt_candidate;

  INSERT INTO analytics.ai_insight_job
    (company_id, insight_type, target_key, context)
  SELECT
    NULL,
    'sla_risk',
    domain,
    jsonb_build_object('p90_seconds', p90_seconds)
  FROM analytics.v_ai_sla_risk;

  INSERT INTO analytics.ai_insight_job
    (company_id, insight_type, target_key, context)
  SELECT
    NULL,
    'rule_suggest',
    domain,
    jsonb_build_object('reject_rate', reject_rate)
  FROM analytics.v_ai_rule_suggest;
END;
$$;


--
-- Name: eval_ai_judgement_db(); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.eval_ai_judgement_db() RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  insert into analytics.audit_alert_ai_judgement
    (alert_event_id, is_anomaly, confidence, judgement_reason, decided_by)
  select
    e.alert_event_id,
    (e.severity >= 4 or (e.severity = 3 and e.matched_count >= 5)),
    case
      when e.severity >= 4 then 0.90
      when e.severity = 3 then 0.70
      else 0.40
    end,
    format(
      'DB-AI: severity=%s, matched_count=%s',
      e.severity,
      e.matched_count
    ),
    'rule'
  from analytics.audit_alert_event e
  left join analytics.audit_alert_ai_judgement j
    on j.alert_event_id = e.alert_event_id
  where j.alert_event_id is null;
end;
$$;


--
-- Name: eval_audit_alert_rules(timestamp with time zone); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.eval_audit_alert_rules(p_now timestamp with time zone DEFAULT now()) RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
  r record;
  window_start timestamptz;
  hit_count integer;
  sev integer;
  inserted integer := 0;
BEGIN
  FOR r IN
    SELECT * FROM analytics.audit_alert_rule WHERE is_enabled
  LOOP
    window_start := p_now - make_interval(secs => r.window_seconds);

    SELECT count(*) INTO hit_count
    FROM audit.audit_trail_db t
    WHERE t.company_id = r.company_id
      AND t.occurred_at > window_start
      AND t.occurred_at <= p_now
      AND (r.table_name_like IS NULL OR t.table_name ILIKE r.table_name_like)
      AND (r.actions IS NULL OR t.action = ANY(r.actions));

    IF hit_count >= r.threshold_count THEN
      sev := LEAST(
        r.severity_cap,
        r.severity_base + (hit_count / r.threshold_count)
      );

      INSERT INTO analytics.audit_alert_event
        (rule_id, company_id, window_start, window_end, matched_count, severity)
      VALUES
        (r.rule_id, r.company_id, window_start, p_now, hit_count, sev)
      ON CONFLICT DO NOTHING;

      inserted := inserted + 1;
    END IF;
  END LOOP;

  RETURN inserted;
END;
$$;


--
-- Name: fn_detect_audit_anomalies(integer); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.fn_detect_audit_anomalies(p_lookback_minutes integer DEFAULT 30) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  r record;
  v_window_end timestamptz;
  v_from timestamptz;
  v_cnt int;
  v_samples text[];
BEGIN
  v_window_end := date_trunc('minute', now());

  FOR r IN
    SELECT *
    FROM analytics.audit_alert_rule
    WHERE is_active
  LOOP
    v_from := v_window_end - make_interval(secs => r.window_seconds);

    SELECT count(*),
           array_agg(DISTINCT at.entity_type) FILTER (WHERE at.entity_type IS NOT NULL)
      INTO v_cnt, v_samples
    FROM analytics.v_audit_with_impact at
    WHERE at.performed_at >= v_from
      AND at.performed_at <  v_window_end
      AND (r.company_id IS NULL OR at.company_id = r.company_id)
      AND at.entity_type LIKE r.entity_type_like
      AND at.action = ANY (r.actions)
      AND at.impact_score >= r.min_impact_score;

    IF v_cnt >= r.threshold THEN
      INSERT INTO analytics.audit_alert_event(
        rule_id, company_id, entity_type_like, actions,
        window_seconds, threshold, min_impact_score, severity,
        window_end, matched_count, sample_entity_types
      )
      VALUES (
        r.rule_id, r.company_id, r.entity_type_like, r.actions,
        r.window_seconds, r.threshold, r.min_impact_score, r.severity,
        v_window_end, v_cnt, COALESCE(v_samples, ARRAY[]::text[])
      )
      ON CONFLICT (rule_id, window_end) DO NOTHING;
    END IF;
  END LOOP;
END;
$$;


--
-- Name: run_ai_job_cycle(); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.run_ai_job_cycle() RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  --  AI queued severity >= 3
  insert into analytics.audit_ai_job (alert_event_id)
  select e.alert_event_id
  from analytics.audit_alert_event e
  left join analytics.audit_ai_job j
    on j.alert_event_id = e.alert_event_id
  where j.alert_event_id is null
    and e.severity >= 3;

  --  queued -> processing10
  update analytics.audit_ai_job
  set
    status = 'processing',
    started_at = now()
  where job_id in (
    select job_id
    from analytics.audit_ai_job
    where status = 'queued'
    order by created_at
    limit 10
  );

  --  processing -> donejudgement 
  update analytics.audit_ai_job j
  set
    status = 'done',
    finished_at = now()
  from analytics.audit_alert_ai_judgement g
  where g.alert_event_id = j.alert_event_id
    and j.status = 'processing';

  --  failed -> queued
  update analytics.audit_ai_job
  set
    status = 'queued',
    retry_count = retry_count + 1,
    last_error = null,
    started_at = null,
    finished_at = null
  where status = 'failed'
    and retry_count < 3
    and started_at < now() - interval '10 minutes';
end;
$$;


--
-- Name: sweep_ai_event(uuid, integer); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.sweep_ai_event(p_company_id uuid, p_keep_days integer DEFAULT 30) RETURNS integer
    LANGUAGE plpgsql
    AS $$
declare
  v_deleted int;
begin
  if p_company_id is null then
    raise exception 'company_id is required';
  end if;

  delete from analytics.ai_event
   where company_id = p_company_id
     and severity in ('info','warn')
     and created_at < now() - make_interval(days => p_keep_days);

  get diagnostics v_deleted = row_count;
  return v_deleted;
end;
$$;


--
-- Name: FUNCTION sweep_ai_event(p_company_id uuid, p_keep_days integer); Type: COMMENT; Schema: analytics; Owner: -
--

COMMENT ON FUNCTION analytics.sweep_ai_event(p_company_id uuid, p_keep_days integer) IS 'Phase9: cleanup old ai_event (info/warn) by company_id';


--
-- Name: sweep_ai_event_phase9(); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.sweep_ai_event_phase9() RETURNS integer
    LANGUAGE plpgsql
    AS $$
declare
  v_count integer;
begin
  update analytics.ai_event
     set status   = 'swept',
         swept_at = now()
   where status = 'pending'
     and is_active = true;

  get diagnostics v_count = row_count;
  return v_count;
end;
$$;


--
-- Name: trg_ai_job_apply_master(); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.trg_ai_job_apply_master() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
declare
  m analytics.ai_job_type_master%rowtype;
begin
  select * into m
    from analytics.ai_job_type_master
   where job_type = NEW.job_type;

  -- job_typeRunnerunknown
  if not found then
    return NEW;
  end if;

  -- job_type pending 
  if m.is_enabled = false then
    NEW.requires_approval := true;
    return NEW;
  end if;

  --  approval requires_approval=false  true 
  if m.default_requires_approval and NEW.requires_approval = false then
    NEW.requires_approval := true;
  end if;

  return NEW;
end;
$$;


--
-- Name: trg_audit_alert_to_ai_event(); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.trg_audit_alert_to_ai_event() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
begin
  perform analytics.enqueue_ai_event(
    NEW.company_id,
    'audit_alert_event',
    NEW.alert_event_id,
    'audit_alert',
    NEW.severity,
    to_jsonb(NEW)
  );
  return NEW;
end;
$$;


--
-- Name: trg_enqueue_alert_notifications(); Type: FUNCTION; Schema: analytics; Owner: -
--

CREATE FUNCTION analytics.trg_enqueue_alert_notifications() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  INSERT INTO analytics.audit_alert_notification(alert_event_id, channel_type, webhook_ref)
  VALUES (NEW.alert_event_id, 'SLACK', 'SLACK_WEBHOOK_URL')
  ON CONFLICT DO NOTHING;

  INSERT INTO analytics.audit_alert_notification(alert_event_id, channel_type, webhook_ref)
  VALUES (NEW.alert_event_id, 'TEAMS', 'TEAMS_WEBHOOK_URL')
  ON CONFLICT DO NOTHING;

  RETURN NEW;
END;
$$;


--
-- Name: approve_request(uuid, uuid, text); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.approve_request(p_request_id uuid, p_actor uuid, p_note text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  update approval_request
     set status='approved',
         decided_at=now(),
         decided_by=p_actor,
         decision_note=p_note
   where request_id=p_request_id
     and status='pending';

  insert into approval_log
    (approval_request_id, action, actor, note)
  values
    (p_request_id, 'approve', p_actor, p_note);
end;
$$;


--
-- Name: assert_saas_limit(uuid); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.assert_saas_limit(p_company_id uuid) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
  v record;
begin
  select *
    into v
  from approval.v_saas_limit_status ls
  join approval.saas_company_map scm
    on scm.subscription_id = ls.subscription_id
   and scm.company_id = p_company_id
  limit 1;

  if not found then
    raise exception 'No active subscription for company %', p_company_id;
  end if;

  if v.max_companies is not null and v.used_companies > v.max_companies then
    raise exception 'Company limit exceeded';
  end if;

  if v.max_approvals_mo is not null and v.used_approvals >= v.max_approvals_mo then
    raise exception 'Monthly approval limit exceeded';
  end if;
end;
$$;


--
-- Name: check_plan_limit(uuid); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.check_plan_limit(p_company_id uuid) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
declare
  v_plan text;
  v_limit integer;
  v_used integer;
begin
  select cp.plan_code
    into v_plan
  from approval.company_plan cp
  where cp.company_id = p_company_id;

  select pm.max_requests_per_month
    into v_limit
  from approval.plan_master pm
  where pm.plan_code = v_plan;

  select coalesce(m.request_count, 0)
    into v_used
  from approval.v_monthly_request_count m
  where m.company_id = p_company_id
    and m.month = date_trunc('month', now());

  return v_used < v_limit;
end;
$$;


--
-- Name: decide_approval(uuid, text, uuid, text); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.decide_approval(p_request_id uuid, p_decision text, p_decided_by uuid, p_note text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
  v_order_id bigint;
begin
  update approval_request
     set status        = p_decision,
         decided_at    = now(),
         decided_by    = p_decided_by,
         decision_note = p_note
   where request_id = p_request_id
   returning order_id into v_order_id;

  -- sales.order_header 
  if p_decision = 'approved' then
    update sales.order_header
       set status_code = 'approved'
     where order_id = v_order_id;
  else
    update sales.order_header
       set status_code = 'rejected'
     where order_id = v_order_id;
  end if;
end;
$$;


--
-- Name: decide_request(uuid, text, text); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.decide_request(p_request_id uuid, p_decision text, p_note text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'approval'
    AS $$
declare
  v_company_id uuid;
  v_order_id bigint;
begin
  if p_decision not in ('approved','rejected') then
    raise exception 'invalid decision';
  end if;

  select company_id, order_id
    into v_company_id, v_order_id
  from approval_request
  where request_id = p_request_id;

  if not exists (
    select 1 from approval.approver
     where company_id = v_company_id
       and user_id = auth.uid()
  ) then
    raise exception 'not approver';
  end if;

  update approval_request
     set status = p_decision,
         decided_at = now(),
         decided_by = auth.uid(),
         decision_note = p_note
   where request_id = p_request_id
     and status = 'pending';

  insert into approval_log(approval_request_id, action, actor, note)
  values (
    p_request_id,
    case when p_decision='approved' then 'approve' else 'reject' end,
    auth.uid(),
    p_note
  );

  if v_order_id is not null then
    update sales.order_header
       set status_code = p_decision
     where order_id = v_order_id;
  end if;
end;
$$;


--
-- Name: enqueue_rework_from_bad(); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.enqueue_rework_from_bad() RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'approval'
    AS $$
declare
  v_count integer := 0;
begin
  insert into approval.policy_eval_event
    (auto_policy_id, company_id, order_id, entity_id, outcome)
  select
    b.auto_policy_id,
    b.company_id,
    b.order_id,
    b.entity_id,
    'bad'
  from approval.v_bad_candidate_audit b
  where not exists (
    select 1
    from approval.policy_eval_event e
    where e.auto_policy_id = b.auto_policy_id
      and e.order_id = b.order_id
      and e.outcome = 'bad'
  );

  get diagnostics v_count = row_count;

  insert into approval.rework_task
    (auto_policy_id, company_id, order_id, entity_id, reason)
  select
    b.auto_policy_id,
    b.company_id,
    b.order_id,
    b.entity_id,
    b.bad_reason
  from approval.v_bad_candidate_audit b
  where not exists (
    select 1
    from approval.rework_task t
    where t.auto_policy_id = b.auto_policy_id
      and t.order_id = b.order_id
      and t.status = 'open'
  );

  return v_count;
end;
$$;


--
-- Name: enqueue_rework_from_bad_all(); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.enqueue_rework_from_bad_all() RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'approval'
    AS $$
declare
  v_count integer := 0;
begin
  insert into approval.policy_eval_event(
    auto_policy_id, company_id, order_id, entity_id, outcome
  )
  select
    b.auto_policy_id,
    b.company_id,
    b.order_id,
    b.entity_id,
    'bad'
  from approval.v_bad_candidate_all b
  where not exists (
    select 1
    from approval.policy_eval_event pe2
    where pe2.auto_policy_id = b.auto_policy_id
      and pe2.order_id = b.order_id
      and pe2.outcome = 'bad'
  );

  get diagnostics v_count = row_count;

  insert into approval.rework_task(
    auto_policy_id, company_id, order_id, entity_id, reason
  )
  select
    b.auto_policy_id,
    b.company_id,
    b.order_id,
    b.entity_id,
    b.bad_reason
  from approval.v_bad_candidate_all b
  where not exists (
    select 1
    from approval.rework_task t
    where t.auto_policy_id = b.auto_policy_id
      and t.order_id = b.order_id
      and t.status = 'open'
  );

  return v_count;
end;
$$;


--
-- Name: enqueue_rework_from_bad_extended(); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.enqueue_rework_from_bad_extended() RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'approval'
    AS $$
declare
  v_count integer := 0;
begin
  -- bad 
  insert into approval.policy_eval_event(
    auto_policy_id, company_id, order_id, entity_id, outcome
  )
  select
    b.auto_policy_id,
    b.company_id,
    b.order_id,
    b.entity_id,
    'bad'
  from approval.v_bad_candidate_extended b
  where not exists (
    select 1
    from approval.policy_eval_event pe2
    where pe2.auto_policy_id = b.auto_policy_id
      and pe2.order_id = b.order_id
      and pe2.outcome = 'bad'
  );

  get diagnostics v_count = row_count;

  -- open 
  insert into approval.rework_task(
    auto_policy_id, company_id, order_id, entity_id, reason
  )
  select
    b.auto_policy_id,
    b.company_id,
    b.order_id,
    b.entity_id,
    b.bad_reason
  from approval.v_bad_candidate_extended b
  where not exists (
    select 1
    from approval.rework_task t
    where t.auto_policy_id = b.auto_policy_id
      and t.order_id = b.order_id
      and t.status = 'open'
  );

  return v_count;
end;
$$;


--
-- Name: is_in_rollout(integer, text); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.is_in_rollout(p_rollout_percent integer, p_seed text) RETURNS boolean
    LANGUAGE sql IMMUTABLE
    AS $$
  select (abs(('x' || substr(md5(coalesce(p_seed,'')), 1, 8))::bit(32)::int) % 100) < p_rollout_percent;
$$;


--
-- Name: mark_invoice_paid(uuid); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.mark_invoice_paid(p_invoice_id uuid) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  update approval.billing_invoice
     set status='paid'
   where invoice_id=p_invoice_id
     and status <> 'paid';
end;
$$;


--
-- Name: reject_request(uuid, uuid, text); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.reject_request(p_request_id uuid, p_actor uuid, p_note text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  update approval_request
     set status='rejected',
         decided_at=now(),
         decided_by=p_actor,
         decision_note=p_note
   where request_id=p_request_id
     and status='pending';

  insert into approval_log
    (approval_request_id, action, actor, note)
  values
    (p_request_id, 'reject', p_actor, p_note);
end;
$$;


--
-- Name: safe_request_approval(uuid, bigint, text, text); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.safe_request_approval(p_company_id uuid, p_order_id bigint, p_policy_id text, p_reason text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  if not approval.check_plan_limit(p_company_id) then
    raise exception 'plan_limit_exceeded';
  end if;

  insert into approval_request (
    request_id,
    company_id,
    order_id,
    policy_id,
    reason,
    status,
    detected_at
  ) values (
    gen_random_uuid()::text,
    p_company_id,
    p_order_id,
    p_policy_id,
    p_reason,
    'pending',
    now()
  );
end;
$$;


--
-- Name: set_policy_and_severity(); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.set_policy_and_severity() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
begin
  -- policy_id 
  if new.policy_id is null then
    new.policy_id := 'p_default';
  end if;

  -- severity  policy_id 
  if new.severity is null then
    new.severity :=
      case
        when new.policy_id like '%external_impact%' then 'high'
        when new.policy_id like '%amount%'          then 'medium'
        else 'low'
      end;
  end if;

  return new;
end;
$$;


--
-- Name: touch_updated_at(); Type: FUNCTION; Schema: approval; Owner: -
--

CREATE FUNCTION approval.touch_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
begin
  new.updated_at := now();
  return new;
end; $$;


--
-- Name: apply_audit_triggers(); Type: FUNCTION; Schema: audit; Owner: -
--

CREATE FUNCTION audit.apply_audit_triggers() RETURNS void
    LANGUAGE plpgsql
    AS $_$
DECLARE
  r record;
  v_trg_name text;
  v_sql text;
BEGIN
  FOR r IN
    SELECT table_schema, table_name
    FROM audit.audit_target_table
    WHERE is_enabled = true
      AND audit_level IN ('FULL','PARTIAL')
      AND table_schema NOT IN ('pg_catalog','information_schema')
  LOOP
    v_trg_name := 'trg_audit_generic__' || r.table_schema || '__' || r.table_name;

    -- 
    IF EXISTS (
      SELECT 1
      FROM pg_trigger t
      JOIN pg_class c ON c.oid = t.tgrelid
      JOIN pg_namespace n ON n.oid = c.relnamespace
      WHERE t.tgname = v_trg_name
        AND n.nspname = r.table_schema
        AND c.relname = r.table_name
        AND NOT t.tgisinternal
    ) THEN
      CONTINUE;
    END IF;

    v_sql := format($f$
      CREATE TRIGGER %I
      AFTER INSERT OR UPDATE OR DELETE ON %I.%I
      FOR EACH ROW
      EXECUTE FUNCTION audit.trg_audit_generic();
    $f$, v_trg_name, r.table_schema, r.table_name);

    EXECUTE v_sql;
  END LOOP;
END;
$_$;


--
-- Name: current_company_id(); Type: FUNCTION; Schema: audit; Owner: -
--

CREATE FUNCTION audit.current_company_id() RETURNS uuid
    LANGUAGE sql STABLE
    AS $$
  SELECT NULLIF(current_setting('request.jwt.claim.company_id', true), '')::uuid;
$$;


--
-- Name: f_apply_partial_filter(jsonb, jsonb); Type: FUNCTION; Schema: audit; Owner: -
--

CREATE FUNCTION audit.f_apply_partial_filter(p_changed jsonb, p_audited_cols jsonb) RETURNS boolean
    LANGUAGE sql
    AS $$
  -- changed_columns  audited_columns  true
  SELECT EXISTS (
    SELECT 1
    FROM jsonb_array_elements_text(COALESCE(p_changed,'[]'::jsonb)) ch(col)
    JOIN jsonb_array_elements_text(COALESCE(p_audited_cols,'[]'::jsonb)) ac(col)
      ON ac.col = ch.col
  );
$$;


--
-- Name: f_changed_columns(jsonb, jsonb); Type: FUNCTION; Schema: audit; Owner: -
--

CREATE FUNCTION audit.f_changed_columns(before_row jsonb, after_row jsonb) RETURNS jsonb
    LANGUAGE sql
    AS $$
  SELECT COALESCE(
    (
      SELECT jsonb_agg(k)
      FROM (
        SELECT k
        FROM (
          SELECT jsonb_object_keys(COALESCE(after_row, '{}'::jsonb)) AS k
          UNION
          SELECT jsonb_object_keys(COALESCE(before_row,'{}'::jsonb)) AS k
        ) u
        WHERE COALESCE(before_row->u.k, 'null'::jsonb) IS DISTINCT FROM COALESCE(after_row->u.k, 'null'::jsonb)
      ) diff
    ),
    '[]'::jsonb
  );
$$;


--
-- Name: f_extract_pk_jsonb(text, text, jsonb); Type: FUNCTION; Schema: audit; Owner: -
--

CREATE FUNCTION audit.f_extract_pk_jsonb(p_schema text, p_table text, p_row jsonb) RETURNS jsonb
    LANGUAGE sql
    AS $$
  SELECT CASE
    WHEN EXISTS (
      SELECT 1
      FROM information_schema.table_constraints tc
      JOIN information_schema.key_column_usage kcu
        ON kcu.constraint_name = tc.constraint_name
       AND kcu.table_schema = tc.table_schema
       AND kcu.table_name = tc.table_name
      WHERE tc.constraint_type = 'PRIMARY KEY'
        AND tc.table_schema = p_schema
        AND tc.table_name = p_table
    )
    THEN (
      SELECT jsonb_object_agg(kcu.column_name, p_row -> kcu.column_name)
      FROM information_schema.table_constraints tc
      JOIN information_schema.key_column_usage kcu
        ON kcu.constraint_name = tc.constraint_name
       AND kcu.table_schema = tc.table_schema
       AND kcu.table_name = tc.table_name
      WHERE tc.constraint_type = 'PRIMARY KEY'
        AND tc.table_schema = p_schema
        AND tc.table_name = p_table
    )
    ELSE NULL
  END;
$$;


--
-- Name: f_get_company_id_from_row(jsonb); Type: FUNCTION; Schema: audit; Owner: -
--

CREATE FUNCTION audit.f_get_company_id_from_row(p_row jsonb) RETURNS uuid
    LANGUAGE plpgsql
    AS $$
DECLARE v text;
BEGIN
  IF p_row ? 'company_id' THEN
    v := p_row->>'company_id';
    IF v IS NULL OR v = '' THEN
      RETURN NULL;
    END IF;
    RETURN v::uuid;
  END IF;
  RETURN NULL;
EXCEPTION WHEN others THEN
  RETURN NULL;
END;
$$;


--
-- Name: f_get_setting_uuid(text); Type: FUNCTION; Schema: audit; Owner: -
--

CREATE FUNCTION audit.f_get_setting_uuid(p_key text) RETURNS uuid
    LANGUAGE plpgsql
    AS $$
DECLARE v text;
BEGIN
  v := current_setting(p_key, true);
  IF v IS NULL OR v = '' THEN
    RETURN NULL;
  END IF;
  RETURN v::uuid;
EXCEPTION WHEN others THEN
  RETURN NULL;
END;
$$;


--
-- Name: tg_exec_request_ins(); Type: FUNCTION; Schema: audit; Owner: -
--

CREATE FUNCTION audit.tg_exec_request_ins() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
    begin
      insert into audit.exec_audit_event(request_id, event_type, detail, created_by)
      values (new.request_id, 'ENQUEUE',
              jsonb_build_object('command_code', new.command_code, 'priority', new.priority, 'worker_tag', new.worker_tag),
              auth.uid());
      return new;
    end;
    $$;


--
-- Name: tg_exec_request_upd(); Type: FUNCTION; Schema: audit; Owner: -
--

CREATE FUNCTION audit.tg_exec_request_upd() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
    begin
      if new.status is distinct from old.status then
        insert into audit.exec_audit_event(request_id, event_type, detail, created_by)
        values (
          new.request_id,
          case
            when new.status='RUNNING' then 'PICK'
            when new.status='DONE' then 'DONE'
            when new.status='FAILED' then 'FAILED'
            else 'ENQUEUE'
          end,
          jsonb_build_object('from', old.status, 'to', new.status, 'exit_code', new.exit_code),
          auth.uid()
        );
      end if;
      return new;
    end;
    $$;


--
-- Name: trg_audit_generic(); Type: FUNCTION; Schema: audit; Owner: -
--

CREATE FUNCTION audit.trg_audit_generic() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_level text;
  v_cols  jsonb;
  v_before jsonb;
  v_after  jsonb;
  v_changed jsonb;
  v_company uuid;
  v_req uuid;
  v_pk jsonb;
BEGIN
  SELECT at.audit_level, at.audited_columns
    INTO v_level, v_cols
  FROM audit.audit_target_table at
  WHERE at.table_schema = TG_TABLE_SCHEMA
    AND at.table_name   = TG_TABLE_NAME
    AND at.is_enabled   = true
  LIMIT 1;

  IF v_level IS NULL OR v_level = 'NONE' THEN
    RETURN COALESCE(NEW, OLD);
  END IF;

  IF TG_OP = 'INSERT' THEN
    v_before := NULL;
    v_after  := to_jsonb(NEW);
  ELSIF TG_OP = 'UPDATE' THEN
    v_before := to_jsonb(OLD);
    v_after  := to_jsonb(NEW);
  ELSIF TG_OP = 'DELETE' THEN
    v_before := to_jsonb(OLD);
    v_after  := NULL;
  ELSE
    RETURN COALESCE(NEW, OLD);
  END IF;

  v_changed := audit.f_changed_columns(v_before, v_after);

  -- UPDATE 
  IF TG_OP = 'UPDATE' AND jsonb_array_length(COALESCE(v_changed,'[]'::jsonb)) = 0 THEN
    RETURN NEW;
  END IF;

  -- PARTIAL
  IF v_level = 'PARTIAL' THEN
    IF NOT audit.f_apply_partial_filter(v_changed, v_cols) THEN
      RETURN COALESCE(NEW, OLD);
    END IF;
  END IF;

  v_company := audit.f_get_company_id_from_row(COALESCE(v_after, v_before));
  v_req := audit.f_get_setting_uuid('audit.request_id');
  v_pk  := audit.f_extract_pk_jsonb(TG_TABLE_SCHEMA, TG_TABLE_NAME, COALESCE(v_after, v_before));

  INSERT INTO audit.audit_trail_db(
    company_id,
    table_schema,
    table_name,
    action,
    pk,
    row_before,
    row_after,
    changed_columns,
    actor,
    request_id
  )
  VALUES (
    v_company,
    TG_TABLE_SCHEMA,
    TG_TABLE_NAME,
    TG_OP,
    v_pk,
    v_before,
    v_after,
    v_changed,
    current_user,
    v_req
  );

  RETURN COALESCE(NEW, OLD);
END;
$$;


--
-- Name: email(); Type: FUNCTION; Schema: auth; Owner: -
--

CREATE FUNCTION auth.email() RETURNS text
    LANGUAGE sql STABLE
    AS $$
  select 
  coalesce(
    nullif(current_setting('request.jwt.claim.email', true), ''),
    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'email')
  )::text
$$;


--
-- Name: FUNCTION email(); Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON FUNCTION auth.email() IS 'Deprecated. Use auth.jwt() -> ''email'' instead.';


--
-- Name: jwt(); Type: FUNCTION; Schema: auth; Owner: -
--

CREATE FUNCTION auth.jwt() RETURNS jsonb
    LANGUAGE sql STABLE
    AS $$
  select 
    coalesce(
        nullif(current_setting('request.jwt.claim', true), ''),
        nullif(current_setting('request.jwt.claims', true), '')
    )::jsonb
$$;


--
-- Name: role(); Type: FUNCTION; Schema: auth; Owner: -
--

CREATE FUNCTION auth.role() RETURNS text
    LANGUAGE sql STABLE
    AS $$
  select 
  coalesce(
    nullif(current_setting('request.jwt.claim.role', true), ''),
    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'role')
  )::text
$$;


--
-- Name: FUNCTION role(); Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON FUNCTION auth.role() IS 'Deprecated. Use auth.jwt() -> ''role'' instead.';


--
-- Name: uid(); Type: FUNCTION; Schema: auth; Owner: -
--

CREATE FUNCTION auth.uid() RETURNS uuid
    LANGUAGE sql STABLE
    AS $$
  select 
  coalesce(
    nullif(current_setting('request.jwt.claim.sub', true), ''),
    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'sub')
  )::uuid
$$;


--
-- Name: FUNCTION uid(); Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON FUNCTION auth.uid() IS 'Deprecated. Use auth.jwt() -> ''sub'' instead.';


--
-- Name: approve_schema_change(uuid, text); Type: FUNCTION; Schema: ci; Owner: -
--

CREATE FUNCTION ci.approve_schema_change(p_request_id uuid, p_approved_by text) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE ci.schema_change_request
     SET status = 'approved',
         approved_by = p_approved_by,
         approved_at = now()
   WHERE request_id = p_request_id
     AND status = 'pending'
     AND review_status = 'ok';

  -- 
  IF to_regclass('audit.audit_trail') IS NOT NULL THEN
    INSERT INTO audit.audit_trail
      (company_id, entity_type, entity_id, action, detail, performed_by, performed_at)
    VALUES
      (NULL, 'schema', p_request_id, 'approve',
       jsonb_build_object('by', p_approved_by),
       p_approved_by, now());
  END IF;
END;
$$;


--
-- Name: audit_schema_change_transitions(); Type: FUNCTION; Schema: ci; Owner: -
--

CREATE FUNCTION ci.audit_schema_change_transitions() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  d jsonb;
BEGIN
  -- review_status 
  IF (TG_OP = 'UPDATE') AND (NEW.review_status IS DISTINCT FROM OLD.review_status) THEN
    d := jsonb_build_object(
      'schema_name', NEW.schema_name,
      'review_status', NEW.review_status,
      'review_summary', NEW.review_summary
    );
    PERFORM ci.try_write_audit_trail(NEW.request_id, 'review', d);
  END IF;

  -- status approve/reject
  IF (TG_OP = 'UPDATE') AND (NEW.status IS DISTINCT FROM OLD.status) THEN
    d := jsonb_build_object(
      'schema_name', NEW.schema_name,
      'status', NEW.status,
      'approved_by', NEW.approved_by,
      'diff_summary', NEW.diff_summary
    );
    PERFORM ci.try_write_audit_trail(NEW.request_id, NEW.status, d);
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: build_schema_review_prompt(text, text, text); Type: FUNCTION; Schema: ci; Owner: -
--

CREATE FUNCTION ci.build_schema_review_prompt(p_domain text, p_schema_name text, p_diff_summary text) RETURNS text
    LANGUAGE plpgsql
    AS $$
DECLARE
  prefix text;
BEGIN
  SELECT t.prompt_prefix
    INTO prefix
  FROM ci.schema_review_prompt_template t
  WHERE t.is_enabled = true
    AND t.domain = COALESCE(p_domain, t.domain)
    AND t.schema_name = p_schema_name
  ORDER BY (t.domain = p_domain) DESC, t.updated_at DESC
  LIMIT 1;

  IF prefix IS NULL THEN
    prefix := 'You are a strict reviewer for schema changes. Evaluate risk and compatibility.';
  END IF;

  RETURN concat(
    prefix, E'\n',
    ' JSON {judgement:"ok|ng", reasons:[...], recommended_actions:[...]}', E'\n',
    '--- domain --- ', COALESCE(p_domain, 'unknown'), E'\n',
    '--- schema_name --- ', p_schema_name, E'\n',
    '--- diff_summary --- ', p_diff_summary
  );
END;
$$;


--
-- Name: enqueue_schema_ai_review(); Type: FUNCTION; Schema: ci; Owner: -
--

CREATE FUNCTION ci.enqueue_schema_ai_review() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  p text;
BEGIN
  p := ci.build_schema_review_prompt(NEW.domain, NEW.schema_name, NEW.diff_summary);

  INSERT INTO ci.schema_ai_review_job (request_id, prompt)
  VALUES (NEW.request_id, p)
  ON CONFLICT (request_id) DO NOTHING;

  RETURN NEW;
END;
$$;


--
-- Name: reject_schema_change(uuid, text, text); Type: FUNCTION; Schema: ci; Owner: -
--

CREATE FUNCTION ci.reject_schema_change(p_request_id uuid, p_rejected_by text, p_reason text) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE ci.schema_change_request
     SET status = 'rejected',
         approved_by = p_rejected_by,
         approved_at = now()
   WHERE request_id = p_request_id
     AND status = 'pending';

  IF to_regclass('audit.audit_trail') IS NOT NULL THEN
    INSERT INTO audit.audit_trail
      (company_id, entity_type, entity_id, action, detail, performed_by, performed_at)
    VALUES
      (NULL, 'schema', p_request_id, 'reject',
       jsonb_build_object('by', p_rejected_by, 'reason', p_reason),
       p_rejected_by, now());
  END IF;
END;
$$;


--
-- Name: try_write_audit_trail(uuid, text, jsonb); Type: FUNCTION; Schema: ci; Owner: -
--

CREATE FUNCTION ci.try_write_audit_trail(p_entity_id uuid, p_action text, p_detail jsonb) RETURNS void
    LANGUAGE plpgsql
    AS $_$
BEGIN
  IF to_regclass('audit.audit_trail') IS NOT NULL THEN
    EXECUTE $SQL$
      INSERT INTO audit.audit_trail
      (company_id, entity_type, entity_id, action, detail, performed_by, performed_at)
      VALUES
      (NULL, 'schema', $1, $2, $3, 'system', now())
    $SQL$ USING p_entity_id, p_action, p_detail;
  END IF;
END;
$_$;


--
-- Name: fn_audit_entity_id_order_detail(bigint); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_audit_entity_id_order_detail(p_order_detail_id bigint) RETURNS text
    LANGUAGE sql IMMUTABLE
    AS $$
  SELECT p_order_detail_id::text
$$;


--
-- Name: fn_audit_entity_id_order_header(bigint); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_audit_entity_id_order_header(p_order_id bigint) RETURNS text
    LANGUAGE sql IMMUTABLE
    AS $$
  SELECT p_order_id::text
$$;


--
-- Name: fn_audit_trail(); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_audit_trail() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'core', 'public'
    AS $$
DECLARE
  v_action text;
  v_entity_id text;
  v_detail jsonb;
BEGIN
  IF TG_OP = 'INSERT' THEN
    v_action := 'INSERT';
    v_entity_id := NEW.*::jsonb ->> (TG_TABLE_NAME || '_id');
    v_detail := jsonb_build_object(
      'after', to_jsonb(NEW)
    );

  ELSIF TG_OP = 'UPDATE' THEN
    v_action := 'UPDATE';
    v_entity_id := NEW.*::jsonb ->> (TG_TABLE_NAME || '_id');
    v_detail := jsonb_build_object(
      'before', to_jsonb(OLD),
      'after',  to_jsonb(NEW)
    );

  ELSIF TG_OP = 'DELETE' THEN
    v_action := 'DELETE';
    v_entity_id := OLD.*::jsonb ->> (TG_TABLE_NAME || '_id');
    v_detail := jsonb_build_object(
      'before', to_jsonb(OLD)
    );
  END IF;

  INSERT INTO core.audit_trail (
    company_id,
    entity_type,
    entity_id,
    action,
    detail,
    performed_by,
    performed_at
  )
  VALUES (
    COALESCE(
      (NEW.*::jsonb ->> 'company_id')::uuid,
      (OLD.*::jsonb ->> 'company_id')::uuid
    ),
    TG_TABLE_SCHEMA || '.' || TG_TABLE_NAME,
    v_entity_id,
    v_action,
    v_detail,
    auth.uid(),
    now()
  );

  RETURN NULL;
END;
$$;


--
-- Name: fn_calc_audit_impact(uuid, text, text, jsonb); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_calc_audit_impact(p_company_id uuid, p_entity_type text, p_action text, p_detail jsonb) RETURNS numeric
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
  v_base numeric := 1.0;
  v_col_count int := 0;
  v_size_factor numeric := 1.0;
  v_before jsonb;
  v_after jsonb;
BEGIN
  SELECT r.base_weight
  INTO v_base
  FROM core.audit_impact_rule r
  WHERE r.is_active
    AND r.action = p_action
    AND p_entity_type LIKE r.entity_type_like
    AND (r.company_id IS NULL OR r.company_id = p_company_id)
  ORDER BY (r.company_id IS NULL), r.priority
  LIMIT 1;

  v_before := COALESCE(p_detail->'before','{}'::jsonb);
  v_after  := COALESCE(p_detail->'after','{}'::jsonb);

  IF p_action = 'UPDATE' THEN
    SELECT count(*) INTO v_col_count
    FROM jsonb_object_keys(v_after) k
    WHERE (v_before->k) IS DISTINCT FROM (v_after->k);
  ELSE
    v_col_count := GREATEST(
      jsonb_object_length(v_before),
      jsonb_object_length(v_after)
    );
  END IF;

  v_size_factor :=
    1.0 + LEAST(5.0, octet_length(p_detail::text)::numeric / 2000.0);

  RETURN round(
    COALESCE(v_base,1.0)
    * (1.0 + 0.15 * v_col_count)
    * v_size_factor
  ,4);
END;
$$;


--
-- Name: fn_drop_old_audit_partitions(interval); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_drop_old_audit_partitions(p_keep_interval interval DEFAULT '7 years'::interval) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  r record;
BEGIN
  FOR r IN
    SELECT inhrelid::regclass AS partition_name
    FROM pg_inherits
    JOIN pg_class parent ON pg_inherits.inhparent = parent.oid
    WHERE parent.relname = 'audit_trail'
  LOOP
    IF r.partition_name::text <
       format('core.audit_trail_%s',
              to_char(now() - p_keep_interval, 'YYYY_MM')) THEN
      EXECUTE format('DROP TABLE IF EXISTS %s', r.partition_name);
    END IF;
  END LOOP;
END;
$$;


--
-- Name: fn_ensure_audit_trail_monthly_partitions(integer, integer); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_ensure_audit_trail_monthly_partitions(p_months_back integer DEFAULT 1, p_months_ahead integer DEFAULT 6) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  d date;
  d_start date;
  d_end date;
  part_name text;
BEGIN
  d_start := date_trunc('month', now())::date
             - make_interval(months => p_months_back);
  d_end   := date_trunc('month', now())::date
             + make_interval(months => p_months_ahead);

  d := d_start;

  WHILE d <= d_end LOOP
    part_name := format('audit_trail_%s', to_char(d, 'YYYY_MM'));

    IF to_regclass(format('core.%I', part_name)) IS NULL THEN
      EXECUTE format(
        'CREATE TABLE core.%I PARTITION OF core.audit_trail
         FOR VALUES FROM (%L) TO (%L);',
        part_name,
        d,
        (d + interval '1 month')
      );
    END IF;

    d := (d + interval '1 month')::date;
  END LOOP;
END;
$$;


--
-- Name: fn_insert_audit_trail(uuid, text, text, text, text, jsonb, uuid); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_insert_audit_trail(p_company_id uuid, p_entity_type text, p_entity_id text, p_action text, p_action_category text, p_detail jsonb, p_performed_by uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  INSERT INTO core.audit_trail (
    company_id,
    entity_type,
    entity_id,
    action,
    action_category,
    detail,
    performed_by,
    performed_at
  )
  VALUES (
    p_company_id,
    p_entity_type,
    p_entity_id,
    p_action,
    p_action_category,
    COALESCE(p_detail, '{}'::jsonb),
    p_performed_by,
    now()
  );
END;
$$;


--
-- Name: fn_jsonb_changed_pairs(jsonb, jsonb); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_jsonb_changed_pairs(old_j jsonb, new_j jsonb) RETURNS jsonb
    LANGUAGE sql IMMUTABLE
    AS $$
  SELECT COALESCE(
    jsonb_object_agg(
      k,
      jsonb_build_object('before', v_old, 'after', v_new)
    ),
    '{}'::jsonb
  )
  FROM (
    SELECT
      COALESCE(n.key, o.key) AS k,
      o.value AS v_old,
      n.value AS v_new
    FROM jsonb_each(COALESCE(old_j,'{}')) o
    FULL JOIN jsonb_each(COALESCE(new_j,'{}')) n
      ON n.key = o.key
  ) s
  WHERE v_old IS DISTINCT FROM v_new
$$;


--
-- Name: fn_jsonb_diff(jsonb, jsonb); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_jsonb_diff(old_j jsonb, new_j jsonb) RETURNS jsonb
    LANGUAGE sql IMMUTABLE
    AS $$
  SELECT COALESCE(
    jsonb_object_agg(k, v_new),
    '{}'::jsonb
  )
  FROM (
    SELECT
      COALESCE(n.key, o.key) AS k,
      o.value AS v_old,
      n.value AS v_new
    FROM jsonb_each(COALESCE(old_j,'{}')) o
    FULL JOIN jsonb_each(COALESCE(new_j,'{}')) n
      ON n.key = o.key
  ) s
  WHERE v_old IS DISTINCT FROM v_new
$$;


--
-- Name: fn_log_read_event(uuid, text, text, jsonb); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_log_read_event(p_company_id uuid, p_entity_type text, p_entity_id text, p_context jsonb DEFAULT '{}'::jsonb) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  -- READ  audit_trail 
  PERFORM core.fn_insert_audit_trail(
    p_company_id,
    p_entity_type,
    p_entity_id,
    'SELECT',
    'READ',
    COALESCE(p_context, '{}'::jsonb),
    auth.uid()
  );
END;
$$;


--
-- Name: fn_resolve_entity_ref(text, text); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_resolve_entity_ref(p_entity_type text, p_entity_id text) RETURNS TABLE(schema_name text, table_name text, pk_value text)
    LANGUAGE plpgsql
    AS $$
BEGIN
  schema_name := split_part(p_entity_type, '.', 1);
  table_name  := split_part(p_entity_type, '.', 2);
  pk_value    := p_entity_id;
  RETURN NEXT;
END;
$$;


--
-- Name: fn_retention_audit_trail_partitions(integer); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_retention_audit_trail_partitions(p_keep_months integer DEFAULT 24) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $_$
DECLARE
  r record;
  part_month date;
  cutoff date;
BEGIN
  cutoff :=
    (date_trunc('month', now())::date
     - (p_keep_months || ' months')::interval)::date;

  FOR r IN
    SELECT relname
    FROM pg_class c
    JOIN pg_namespace n ON n.oid = c.relnamespace
    WHERE n.nspname = 'core'
      AND c.relkind = 'r'
      AND relname ~ '^audit_trail_[0-9]{4}_[0-9]{2}$'
  LOOP
    part_month := to_date(substr(r.relname, 12, 7), 'YYYY_MM');

    IF part_month < cutoff THEN
      EXECUTE format('DROP TABLE IF EXISTS core.%I;', r.relname);
    END IF;
  END LOOP;
END;
$_$;


--
-- Name: fn_validate_reason_code(text, text); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.fn_validate_reason_code(p_reason_code text, p_op text) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF p_reason_code IS NULL THEN
    RAISE EXCEPTION 'reason_code is required';
  END IF;

  IF NOT EXISTS (
    SELECT 1
    FROM core.reason_code_master r
    WHERE r.reason_code = p_reason_code
      AND r.is_active
      AND p_op = ANY (r.target_ops)
      AND CURRENT_DATE BETWEEN r.valid_from
                          AND COALESCE(r.valid_to, CURRENT_DATE)
  ) THEN
    RAISE EXCEPTION
      'invalid reason_code: %, operation: %',
      p_reason_code, p_op;
  END IF;
END;
$$;


--
-- Name: trg_audit_iud(); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.trg_audit_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $_$
DECLARE
  v_company_id uuid;
  v_entity_type text;
  v_entity_id text := '';
  v_detail jsonb;
  v_pk_column text;
  v_row record;
BEGIN
  v_entity_type := TG_TABLE_SCHEMA || '.' || TG_TABLE_NAME;
  v_row := COALESCE(NEW, OLD);

  -- company_id 
  v_company_id := COALESCE(
    (v_row).company_id,
    my_company_id()
  );

  -- ===============================
  -- entity_id pk_map 
  -- ===============================
  SELECT pk_column
  INTO v_pk_column
  FROM core.audit_entity_pk_map
  WHERE schema_name = TG_TABLE_SCHEMA
    AND table_name  = TG_TABLE_NAME;

  IF v_pk_column IS NOT NULL THEN
    EXECUTE format(
      'SELECT ($1).%I::text',
      v_pk_column
    )
    INTO v_entity_id
    USING v_row;
  END IF;

  -- fallback: <table>_id  id
  IF v_entity_id IS NULL OR v_entity_id = '' THEN
    BEGIN
      EXECUTE format(
        'SELECT ($1).%I::text',
        TG_TABLE_NAME || '_id'
      )
      INTO v_entity_id
      USING v_row;
    EXCEPTION WHEN undefined_column THEN
      BEGIN
        EXECUTE 'SELECT ($1).id::text'
        INTO v_entity_id
        USING v_row;
      EXCEPTION WHEN undefined_column THEN
        v_entity_id := '';
      END;
    END;
  END IF;

  -- before / after
  IF TG_OP = 'INSERT' THEN
    v_detail := jsonb_build_object('after', to_jsonb(NEW));
  ELSIF TG_OP = 'UPDATE' THEN
    v_detail := jsonb_build_object('before', to_jsonb(OLD), 'after', to_jsonb(NEW));
  ELSE
    v_detail := jsonb_build_object('before', to_jsonb(OLD));
  END IF;

  -- audit_trail 
  PERFORM core.fn_insert_audit_trail(
    v_company_id,
    v_entity_type,
    v_entity_id,
    TG_OP,
    v_detail,
    auth.uid()
  );

  RETURN COALESCE(NEW, OLD);
END;
$_$;


--
-- Name: trg_audit_iud_compact(); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.trg_audit_iud_compact() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_company_id uuid;
  v_detail jsonb;
BEGIN
  IF TG_OP = 'INSERT' THEN
    v_company_id := COALESCE(NEW.company_id, public.my_company_id());
    v_detail := jsonb_build_object('after', to_jsonb(NEW));

  ELSIF TG_OP = 'UPDATE' THEN
    v_company_id := COALESCE(NEW.company_id, OLD.company_id, public.my_company_id());
    v_detail := core.fn_jsonb_changed_pairs(to_jsonb(OLD), to_jsonb(NEW));
    IF v_detail = '{}'::jsonb THEN
      RETURN NEW;
    END IF;

  ELSE
    v_company_id := COALESCE(OLD.company_id, public.my_company_id());
    v_detail := jsonb_build_object('before', to_jsonb(OLD));
  END IF;

  PERFORM core.fn_insert_audit_trail(
    v_company_id,
    TG_TABLE_SCHEMA || '.' || TG_TABLE_NAME,
    '',
    TG_OP,
    'WRITE',
    v_detail,
    auth.uid()
  );

  RETURN COALESCE(NEW, OLD);
END;
$$;


--
-- Name: trg_audit_iud_compact_with_entity(); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.trg_audit_iud_compact_with_entity() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_company_id uuid;
  v_detail jsonb;
  v_entity_id text := '';
BEGIN
  -- entity_id 
  IF TG_TABLE_SCHEMA = 'sales' AND TG_TABLE_NAME = 'order_header' THEN
    IF TG_OP = 'DELETE' THEN
      v_entity_id := core.fn_audit_entity_id_order_header(OLD.order_id);
    ELSE
      v_entity_id := core.fn_audit_entity_id_order_header(NEW.order_id);
    END IF;

  ELSIF TG_TABLE_SCHEMA = 'sales' AND TG_TABLE_NAME = 'order_detail' THEN
    IF TG_OP = 'DELETE' THEN
      v_entity_id := core.fn_audit_entity_id_order_detail(OLD.order_detail_id);
    ELSE
      v_entity_id := core.fn_audit_entity_id_order_detail(NEW.order_detail_id);
    END IF;
  END IF;

  IF TG_OP = 'INSERT' THEN
    v_company_id := COALESCE(NEW.company_id, public.my_company_id());
    v_detail := jsonb_build_object('after', to_jsonb(NEW));

  ELSIF TG_OP = 'UPDATE' THEN
    v_company_id := COALESCE(NEW.company_id, OLD.company_id, public.my_company_id());
    v_detail := core.fn_jsonb_changed_pairs(to_jsonb(OLD), to_jsonb(NEW));
    IF v_detail = '{}'::jsonb THEN
      RETURN NEW;
    END IF;

  ELSE
    v_company_id := COALESCE(OLD.company_id, public.my_company_id());
    v_detail := jsonb_build_object('before', to_jsonb(OLD));
  END IF;

  PERFORM core.fn_insert_audit_trail(
    v_company_id,
    TG_TABLE_SCHEMA || '.' || TG_TABLE_NAME,
    v_entity_id,
    TG_OP,
    'WRITE',
    v_detail,
    auth.uid()
  );

  RETURN COALESCE(NEW, OLD);
END;
$$;


--
-- Name: trg_audit_stmt(); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.trg_audit_stmt() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_company_id uuid;
  v_detail jsonb;
BEGIN
  SELECT COALESCE(company_id, public.my_company_id())
    INTO v_company_id
    FROM new_rows LIMIT 1;

  v_detail := jsonb_build_object(
    'before', (SELECT jsonb_agg(to_jsonb(t)) FROM old_rows t),
    'after',  (SELECT jsonb_agg(to_jsonb(t)) FROM new_rows t)
  );

  PERFORM core.fn_insert_audit_trail(
    v_company_id,
    TG_TABLE_SCHEMA || '.' || TG_TABLE_NAME,
    '',
    TG_OP || '_STMT',
    'WRITE',
    v_detail,
    auth.uid()
  );

  RETURN NULL;
END;
$$;


--
-- Name: trg_require_reason_code(); Type: FUNCTION; Schema: core; Owner: -
--

CREATE FUNCTION core.trg_require_reason_code() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_reason text;
BEGIN
  IF TG_OP IN ('UPDATE','DELETE') THEN
    v_reason := current_setting('app.reason_code', true);
    PERFORM core.fn_validate_reason_code(v_reason, TG_OP);
  END IF;

  RETURN COALESCE(NEW, OLD);
END;
$$;


--
-- Name: grant_pg_cron_access(); Type: FUNCTION; Schema: extensions; Owner: -
--

CREATE FUNCTION extensions.grant_pg_cron_access() RETURNS event_trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF EXISTS (
    SELECT
    FROM pg_event_trigger_ddl_commands() AS ev
    JOIN pg_extension AS ext
    ON ev.objid = ext.oid
    WHERE ext.extname = 'pg_cron'
  )
  THEN
    grant usage on schema cron to postgres with grant option;

    alter default privileges in schema cron grant all on tables to postgres with grant option;
    alter default privileges in schema cron grant all on functions to postgres with grant option;
    alter default privileges in schema cron grant all on sequences to postgres with grant option;

    alter default privileges for user supabase_admin in schema cron grant all
        on sequences to postgres with grant option;
    alter default privileges for user supabase_admin in schema cron grant all
        on tables to postgres with grant option;
    alter default privileges for user supabase_admin in schema cron grant all
        on functions to postgres with grant option;

    grant all privileges on all tables in schema cron to postgres with grant option;
    revoke all on table cron.job from postgres;
    grant select on table cron.job to postgres with grant option;
  END IF;
END;
$$;


--
-- Name: FUNCTION grant_pg_cron_access(); Type: COMMENT; Schema: extensions; Owner: -
--

COMMENT ON FUNCTION extensions.grant_pg_cron_access() IS 'Grants access to pg_cron';


--
-- Name: grant_pg_graphql_access(); Type: FUNCTION; Schema: extensions; Owner: -
--

CREATE FUNCTION extensions.grant_pg_graphql_access() RETURNS event_trigger
    LANGUAGE plpgsql
    AS $_$
DECLARE
    func_is_graphql_resolve bool;
BEGIN
    func_is_graphql_resolve = (
        SELECT n.proname = 'resolve'
        FROM pg_event_trigger_ddl_commands() AS ev
        LEFT JOIN pg_catalog.pg_proc AS n
        ON ev.objid = n.oid
    );

    IF func_is_graphql_resolve
    THEN
        -- Update public wrapper to pass all arguments through to the pg_graphql resolve func
        DROP FUNCTION IF EXISTS graphql_public.graphql;
        create or replace function graphql_public.graphql(
            "operationName" text default null,
            query text default null,
            variables jsonb default null,
            extensions jsonb default null
        )
            returns jsonb
            language sql
        as $$
            select graphql.resolve(
                query := query,
                variables := coalesce(variables, '{}'),
                "operationName" := "operationName",
                extensions := extensions
            );
        $$;

        -- This hook executes when `graphql.resolve` is created. That is not necessarily the last
        -- function in the extension so we need to grant permissions on existing entities AND
        -- update default permissions to any others that are created after `graphql.resolve`
        grant usage on schema graphql to postgres, anon, authenticated, service_role;
        grant select on all tables in schema graphql to postgres, anon, authenticated, service_role;
        grant execute on all functions in schema graphql to postgres, anon, authenticated, service_role;
        grant all on all sequences in schema graphql to postgres, anon, authenticated, service_role;
        alter default privileges in schema graphql grant all on tables to postgres, anon, authenticated, service_role;
        alter default privileges in schema graphql grant all on functions to postgres, anon, authenticated, service_role;
        alter default privileges in schema graphql grant all on sequences to postgres, anon, authenticated, service_role;

        -- Allow postgres role to allow granting usage on graphql and graphql_public schemas to custom roles
        grant usage on schema graphql_public to postgres with grant option;
        grant usage on schema graphql to postgres with grant option;
    END IF;

END;
$_$;


--
-- Name: FUNCTION grant_pg_graphql_access(); Type: COMMENT; Schema: extensions; Owner: -
--

COMMENT ON FUNCTION extensions.grant_pg_graphql_access() IS 'Grants access to pg_graphql';


--
-- Name: grant_pg_net_access(); Type: FUNCTION; Schema: extensions; Owner: -
--

CREATE FUNCTION extensions.grant_pg_net_access() RETURNS event_trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF EXISTS (
    SELECT 1
    FROM pg_event_trigger_ddl_commands() AS ev
    JOIN pg_extension AS ext
    ON ev.objid = ext.oid
    WHERE ext.extname = 'pg_net'
  )
  THEN
    IF NOT EXISTS (
      SELECT 1
      FROM pg_roles
      WHERE rolname = 'supabase_functions_admin'
    )
    THEN
      CREATE USER supabase_functions_admin NOINHERIT CREATEROLE LOGIN NOREPLICATION;
    END IF;

    GRANT USAGE ON SCHEMA net TO supabase_functions_admin, postgres, anon, authenticated, service_role;

    IF EXISTS (
      SELECT FROM pg_extension
      WHERE extname = 'pg_net'
      -- all versions in use on existing projects as of 2025-02-20
      -- version 0.12.0 onwards don't need these applied
      AND extversion IN ('0.2', '0.6', '0.7', '0.7.1', '0.8', '0.10.0', '0.11.0')
    ) THEN
      ALTER function net.http_get(url text, params jsonb, headers jsonb, timeout_milliseconds integer) SECURITY DEFINER;
      ALTER function net.http_post(url text, body jsonb, params jsonb, headers jsonb, timeout_milliseconds integer) SECURITY DEFINER;

      ALTER function net.http_get(url text, params jsonb, headers jsonb, timeout_milliseconds integer) SET search_path = net;
      ALTER function net.http_post(url text, body jsonb, params jsonb, headers jsonb, timeout_milliseconds integer) SET search_path = net;

      REVOKE ALL ON FUNCTION net.http_get(url text, params jsonb, headers jsonb, timeout_milliseconds integer) FROM PUBLIC;
      REVOKE ALL ON FUNCTION net.http_post(url text, body jsonb, params jsonb, headers jsonb, timeout_milliseconds integer) FROM PUBLIC;

      GRANT EXECUTE ON FUNCTION net.http_get(url text, params jsonb, headers jsonb, timeout_milliseconds integer) TO supabase_functions_admin, postgres, anon, authenticated, service_role;
      GRANT EXECUTE ON FUNCTION net.http_post(url text, body jsonb, params jsonb, headers jsonb, timeout_milliseconds integer) TO supabase_functions_admin, postgres, anon, authenticated, service_role;
    END IF;
  END IF;
END;
$$;


--
-- Name: FUNCTION grant_pg_net_access(); Type: COMMENT; Schema: extensions; Owner: -
--

COMMENT ON FUNCTION extensions.grant_pg_net_access() IS 'Grants access to pg_net';


--
-- Name: pgrst_ddl_watch(); Type: FUNCTION; Schema: extensions; Owner: -
--

CREATE FUNCTION extensions.pgrst_ddl_watch() RETURNS event_trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  cmd record;
BEGIN
  FOR cmd IN SELECT * FROM pg_event_trigger_ddl_commands()
  LOOP
    IF cmd.command_tag IN (
      'CREATE SCHEMA', 'ALTER SCHEMA'
    , 'CREATE TABLE', 'CREATE TABLE AS', 'SELECT INTO', 'ALTER TABLE'
    , 'CREATE FOREIGN TABLE', 'ALTER FOREIGN TABLE'
    , 'CREATE VIEW', 'ALTER VIEW'
    , 'CREATE MATERIALIZED VIEW', 'ALTER MATERIALIZED VIEW'
    , 'CREATE FUNCTION', 'ALTER FUNCTION'
    , 'CREATE TRIGGER'
    , 'CREATE TYPE', 'ALTER TYPE'
    , 'CREATE RULE'
    , 'COMMENT'
    )
    -- don't notify in case of CREATE TEMP table or other objects created on pg_temp
    AND cmd.schema_name is distinct from 'pg_temp'
    THEN
      NOTIFY pgrst, 'reload schema';
    END IF;
  END LOOP;
END; $$;


--
-- Name: pgrst_drop_watch(); Type: FUNCTION; Schema: extensions; Owner: -
--

CREATE FUNCTION extensions.pgrst_drop_watch() RETURNS event_trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  obj record;
BEGIN
  FOR obj IN SELECT * FROM pg_event_trigger_dropped_objects()
  LOOP
    IF obj.object_type IN (
      'schema'
    , 'table'
    , 'foreign table'
    , 'view'
    , 'materialized view'
    , 'function'
    , 'trigger'
    , 'type'
    , 'rule'
    )
    AND obj.is_temporary IS false -- no pg_temp objects
    THEN
      NOTIFY pgrst, 'reload schema';
    END IF;
  END LOOP;
END; $$;


--
-- Name: set_graphql_placeholder(); Type: FUNCTION; Schema: extensions; Owner: -
--

CREATE FUNCTION extensions.set_graphql_placeholder() RETURNS event_trigger
    LANGUAGE plpgsql
    AS $_$
    DECLARE
    graphql_is_dropped bool;
    BEGIN
    graphql_is_dropped = (
        SELECT ev.schema_name = 'graphql_public'
        FROM pg_event_trigger_dropped_objects() AS ev
        WHERE ev.schema_name = 'graphql_public'
    );

    IF graphql_is_dropped
    THEN
        create or replace function graphql_public.graphql(
            "operationName" text default null,
            query text default null,
            variables jsonb default null,
            extensions jsonb default null
        )
            returns jsonb
            language plpgsql
        as $$
            DECLARE
                server_version float;
            BEGIN
                server_version = (SELECT (SPLIT_PART((select version()), ' ', 2))::float);

                IF server_version >= 14 THEN
                    RETURN jsonb_build_object(
                        'errors', jsonb_build_array(
                            jsonb_build_object(
                                'message', 'pg_graphql extension is not enabled.'
                            )
                        )
                    );
                ELSE
                    RETURN jsonb_build_object(
                        'errors', jsonb_build_array(
                            jsonb_build_object(
                                'message', 'pg_graphql is only available on projects running Postgres 14 onwards.'
                            )
                        )
                    );
                END IF;
            END;
        $$;
    END IF;

    END;
$_$;


--
-- Name: FUNCTION set_graphql_placeholder(); Type: COMMENT; Schema: extensions; Owner: -
--

COMMENT ON FUNCTION extensions.set_graphql_placeholder() IS 'Reintroduces placeholder function for graphql_public.graphql';


--
-- Name: fn_enqueue_audit_export(interval); Type: FUNCTION; Schema: integration; Owner: -
--

CREATE FUNCTION integration.fn_enqueue_audit_export(p_range interval DEFAULT '1 day'::interval) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_to   timestamptz := date_trunc('hour', now());
  v_from timestamptz := v_to - p_range;
  v_company_id uuid := public.my_company_id();
BEGIN
  INSERT INTO integration.audit_export_queue(company_id, from_time, to_time)
  VALUES (v_company_id, v_from, v_to);
END;
$$;


--
-- Name: fn_enqueue_siem_audit(timestamp with time zone, timestamp with time zone, bigint); Type: FUNCTION; Schema: integration; Owner: -
--

CREATE FUNCTION integration.fn_enqueue_siem_audit(p_from timestamp with time zone, p_to timestamp with time zone, p_endpoint_id bigint) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_company_id uuid := my_company_id();
BEGIN
  INSERT INTO integration.siem_delivery_queue(endpoint_id, company_id, audit_trail_id)
  SELECT
    p_endpoint_id,
    v_company_id,
    at.audit_trail_id
  FROM core.audit_trail at
  WHERE at.company_id = v_company_id
    AND at.performed_at >= p_from
    AND at.performed_at <  p_to
  ON CONFLICT (endpoint_id, audit_trail_id) DO NOTHING;
END;
$$;


--
-- Name: fn_enqueue_siem_recent(bigint, integer); Type: FUNCTION; Schema: integration; Owner: -
--

CREATE FUNCTION integration.fn_enqueue_siem_recent(p_endpoint_id bigint, p_minutes integer DEFAULT 15) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_to   timestamptz := date_trunc('minute', now());
  v_from timestamptz := v_to - make_interval(mins => p_minutes);
BEGIN
  PERFORM integration.fn_enqueue_siem_audit(v_from, v_to, p_endpoint_id);
END;
$$;


--
-- Name: fn_siem_mark_failed(bigint, text); Type: FUNCTION; Schema: integration; Owner: -
--

CREATE FUNCTION integration.fn_siem_mark_failed(p_delivery_id bigint, p_error text) RETURNS void
    LANGUAGE sql SECURITY DEFINER
    AS $$
  UPDATE integration.siem_delivery_queue
  SET status='FAILED',
      retry_count = retry_count + 1,
      last_error = left(p_error, 2000)
  WHERE delivery_id = p_delivery_id;
$$;


--
-- Name: fn_siem_mark_sent(bigint); Type: FUNCTION; Schema: integration; Owner: -
--

CREATE FUNCTION integration.fn_siem_mark_sent(p_delivery_id bigint) RETURNS void
    LANGUAGE sql SECURITY DEFINER
    AS $$
  UPDATE integration.siem_delivery_queue
  SET status='SENT', sent_at=now(), last_error=NULL
  WHERE delivery_id = p_delivery_id;
$$;


--
-- Name: add_item_image(text, bigint, bigint, boolean, integer); Type: FUNCTION; Schema: media; Owner: -
--

CREATE FUNCTION media.add_item_image(p_item_entity_table text, p_item_id bigint, p_asset_id bigint, p_is_primary boolean DEFAULT false, p_sort_order integer DEFAULT 1) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  if coalesce(p_is_primary,false) then
    perform media.unset_primary(p_item_entity_table, p_item_id, 'ITEM_IMAGE');
  end if;

  perform media.link_asset(
    p_asset_id,
    p_item_entity_table,
    p_item_id,
    'ITEM_IMAGE',
    coalesce(p_is_primary,false),
    coalesce(p_sort_order,1)
  );
end;
$$;


--
-- Name: link_asset(bigint, text, bigint, text, boolean, integer); Type: FUNCTION; Schema: media; Owner: -
--

CREATE FUNCTION media.link_asset(p_asset_id bigint, p_entity_table text, p_entity_id bigint, p_role text, p_is_primary boolean DEFAULT false, p_sort_order integer DEFAULT 1) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  insert into media.asset_link(asset_id, entity_table, entity_id, role, is_primary, sort_order, created_by)
  values (p_asset_id, p_entity_table, p_entity_id, p_role, coalesce(p_is_primary,false), coalesce(p_sort_order,1), auth.uid())
  on conflict (asset_id, entity_table, entity_id, role) do update
    set is_primary = excluded.is_primary,
        sort_order = excluded.sort_order;
end;
$$;


--
-- Name: unset_primary(text, bigint, text); Type: FUNCTION; Schema: media; Owner: -
--

CREATE FUNCTION media.unset_primary(p_entity_table text, p_entity_id bigint, p_role text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  update media.asset_link
     set is_primary = false
   where entity_table = p_entity_table
     and entity_id   = p_entity_id
     and role        = p_role
     and is_primary  = true;
end;
$$;


--
-- Name: rpc_decide_approval(uuid, bigint, text, text, text, jsonb); Type: FUNCTION; Schema: notify; Owner: -
--

CREATE FUNCTION notify.rpc_decide_approval(p_company_id uuid, p_approval_request_id bigint, p_line_user_id text, p_action text, p_note text DEFAULT NULL::text, p_payload jsonb DEFAULT '{}'::jsonb) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
declare
  v_new_status text;
begin
  if p_action not in ('approve','reject') then
    raise exception 'invalid action: %', p_action;
  end if;

  v_new_status := case
    when p_action='approve' then 'approved'
    else 'rejected'
  end;

  update notify.approval_request
     set status = v_new_status,
         decided_by_line_user_id = p_line_user_id,
         decided_at = now(),
         decision_note = p_note
   where approval_request_id = p_approval_request_id
     and company_id = p_company_id
     and status = 'pending';

  if not found then
    return jsonb_build_object('ok', false, 'reason', 'not_pending');
  end if;

  insert into notify.approval_action_log(
    company_id, approval_request_id, line_user_id, action, payload
  ) values (
    p_company_id, p_approval_request_id, p_line_user_id, p_action,
    coalesce(p_payload,'{}'::jsonb)
  );

  insert into notify.audit_trail(
    company_id, actor_line_user_id, actor, action,
    entity_type, entity_id, detail
  ) values (
    p_company_id, p_line_user_id, 'user', p_action,
    'approval_request', p_approval_request_id::text,
    jsonb_build_object('note', p_note)
  );

  return jsonb_build_object('ok', true, 'status', v_new_status);
end$$;


--
-- Name: rpc_mark_ai_event_notified(uuid, bigint); Type: FUNCTION; Schema: notify; Owner: -
--

CREATE FUNCTION notify.rpc_mark_ai_event_notified(p_company_id uuid, p_ai_event_id bigint) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
begin
  update notify.ai_event
     set status = 'notified'
   where ai_event_id = p_ai_event_id
     and company_id = p_company_id
     and status = 'open';

  if not found then
    return jsonb_build_object('ok', false, 'reason', 'not_open');
  end if;

  return jsonb_build_object('ok', true);
end$$;


--
-- Name: rpc_register_line_user(uuid, text, text); Type: FUNCTION; Schema: notify; Owner: -
--

CREATE FUNCTION notify.rpc_register_line_user(p_company_id uuid, p_route_key text, p_line_user_id text) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
begin
  insert into notify.notification_route(
    company_id, route_key, line_user_id, is_active
  ) values (
    p_company_id, p_route_key, p_line_user_id, true
  )
  on conflict (company_id, route_key, line_user_id)
  do update set is_active = true;

  insert into notify.audit_trail(
    company_id, actor_line_user_id, actor, action,
    entity_type, entity_id, detail
  ) values (
    p_company_id, p_line_user_id, 'user', 'route_register',
    'route', p_route_key,
    jsonb_build_object('line_user_id', p_line_user_id)
  );

  return jsonb_build_object('ok', true);
end$$;


--
-- Name: add_shipping_package_photo(bigint, bigint, boolean, integer); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.add_shipping_package_photo(p_shipping_id bigint, p_asset_id bigint, p_is_primary boolean DEFAULT false, p_sort_order integer DEFAULT 1) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  if coalesce(p_is_primary,false) then
    perform media.unset_primary('sales.shipping_header', p_shipping_id, 'PACKAGE_PHOTO');
  end if;

  perform media.link_asset(
    p_asset_id,
    'sales.shipping_header',
    p_shipping_id,
    'PACKAGE_PHOTO',
    coalesce(p_is_primary,false),
    coalesce(p_sort_order,1)
  );
end;
$$;


--
-- Name: cancel_job(bigint, text); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.cancel_job(p_job_id bigint, p_reason text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  update ops.ops_job_queue
     set status = 'CANCELLED',
         last_error = coalesce(p_reason, last_error),
         locked_at = null,
         locked_by = null
   where job_id = p_job_id;

  insert into ops.ops_job_result(job_id, result_status, result)
  values (p_job_id, 'CANCELLED', jsonb_build_object('reason', p_reason));
end;
$$;


--
-- Name: complete_job(bigint, jsonb); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.complete_job(p_job_id bigint, p_result jsonb) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  INSERT INTO ops.ops_job_result (
    job_id,
    result_payload,
    status,
    created_at
  )
  VALUES (
    p_job_id,
    p_result,
    'SUCCESS',
    now()
  );

  UPDATE ops.ops_job_queue
     SET status      = 'SUCCESS',
         finished_at = now()
   WHERE job_id = p_job_id;
END;
$$;


--
-- Name: complete_job(bigint, text, jsonb); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.complete_job(p_job_id bigint, p_result_status text, p_result_detail jsonb DEFAULT '{}'::jsonb) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
  v_job ops.ops_job_queue%rowtype;
begin
  select * into v_job
    from ops.ops_job_queue
   where job_id = p_job_id
   for update;

  if not found then
    raise exception 'job_id % not found', p_job_id;
  end if;

  insert into ops.ops_job_result(job_id, result_status, result_detail, completed_at)
  values (p_job_id, p_result_status, coalesce(p_result_detail,'{}'::jsonb), now())
  on conflict (job_id) do update
    set result_status = excluded.result_status,
        result_detail = excluded.result_detail,
        completed_at  = excluded.completed_at;

  update ops.ops_job_queue
     set status = p_result_status,
         locked_at = null,
         updated_at = now()
   where job_id = p_job_id;
end;
$$;


--
-- Name: complete_notification(bigint, boolean, text); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.complete_notification(p_outbox_id bigint, p_ok boolean, p_error text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  if coalesce(p_ok,false) then
    update ops.notification_outbox
       set status='SENT',
           sent_at=now(),
           last_error=null
     where outbox_id=p_outbox_id;
  else
    update ops.notification_outbox
       set status='PENDING',
           retry_count=retry_count+1,
           last_error=left(coalesce(p_error,'unknown'), 2000)
     where outbox_id=p_outbox_id;
    --  FAILED 
    update ops.notification_outbox
       set status='FAILED'
     where outbox_id=p_outbox_id
       and retry_count >= max_retry;
  end if;
end;
$$;


--
-- Name: dequeue_jobs(text, integer); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.dequeue_jobs(p_worker text, p_limit integer DEFAULT 1) RETURNS TABLE(job_id bigint, job_type text, payload jsonb, attempts integer, max_attempts integer)
    LANGUAGE plpgsql
    AS $$
begin
  return query
  with picked as (
    select q.job_id
    from ops.ops_job_queue q
    where q.status = 'PENDING'
      and q.run_after <= now()
      and q.locked_at is null
    order by q.priority asc, q.job_id asc
    for update skip locked
    limit greatest(p_limit, 1)
  )
  update ops.ops_job_queue q
     set status   = 'RUNNING',
         locked_at = now(),
         locked_by = p_worker
    from picked
   where q.job_id = picked.job_id
  returning q.job_id, q.job_type, q.payload, q.attempts, q.max_attempts;
end;
$$;


--
-- Name: dequeue_ops_job(); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.dequeue_ops_job() RETURNS TABLE(job_id bigint, job_type text, function_code text, payload jsonb)
    LANGUAGE sql
    AS $$
  update ops.ops_job_queue
     set locked_at = now()
   where job_id = (
     select job_id
       from ops.ops_job_queue
      where locked_at is null
      order by created_at
      limit 1
      for update skip locked
   )
   returning job_id, job_type, function_code, payload;
$$;


--
-- Name: enqueue_business_approval(); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.enqueue_business_approval() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  need_approval boolean := false;
  th numeric;
BEGIN
  SELECT threshold_amount
    INTO th
  FROM ops.approval_rule
  WHERE domain = NEW.domain
    AND event_type = NEW.event_type
    AND is_enabled = true;

  IF th IS NULL THEN
    need_approval := true;
  ELSIF NEW.amount IS NOT NULL AND NEW.amount >= th THEN
    need_approval := true;
  END IF;

  IF need_approval THEN
    INSERT INTO ci.schema_change_request
      (domain, schema_name, diff_summary, requested_by)
    VALUES
      (NEW.domain,
       NEW.entity_type,
       jsonb_build_object(
         'entity_id', NEW.entity_id,
         'event_type', NEW.event_type,
         'amount', NEW.amount
       )::text,
       NEW.created_by);
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: enqueue_generate_pdf(text, text, text, bigint, jsonb, integer); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.enqueue_generate_pdf(p_function_code text, p_document_type_code text, p_business_table text, p_business_id bigint, p_payload jsonb DEFAULT '{}'::jsonb, p_priority integer DEFAULT 100) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_job_id bigint;
BEGIN
  INSERT INTO ops.ops_job_queue(
    job_type, function_code, document_type_code,
    business_table, business_id,
    status, payload, priority, retry_count, max_retry,
    created_at
  )
  VALUES (
    'GENERATE_PDF', p_function_code, p_document_type_code,
    p_business_table, p_business_id,
    'PENDING', COALESCE(p_payload,'{}'::jsonb), COALESCE(p_priority,100), 0, 3,
    now()
  )
  RETURNING job_id INTO v_job_id;

  RETURN v_job_id;
END;
$$;


--
-- Name: enqueue_job(text, jsonb, timestamp with time zone, integer, integer, uuid); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.enqueue_job(p_job_type text, p_payload jsonb DEFAULT '{}'::jsonb, p_run_after timestamp with time zone DEFAULT now(), p_priority integer DEFAULT 100, p_max_attempts integer DEFAULT 3, p_created_by uuid DEFAULT auth.uid()) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
declare
  v_job_id bigint;
begin
  insert into ops.ops_job_queue(job_type, payload, run_after, priority, max_attempts, created_by)
  values (p_job_type, coalesce(p_payload,'{}'::jsonb), coalesce(p_run_after, now()), coalesce(p_priority,100), coalesce(p_max_attempts,3), p_created_by)
  returning job_id into v_job_id;

  return v_job_id;
end;
$$;


--
-- Name: enqueue_job(text, text, text, text, bigint, jsonb, integer); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.enqueue_job(p_job_type text, p_function_code text, p_document_type_code text, p_business_table text, p_business_id bigint, p_payload jsonb DEFAULT '{}'::jsonb, p_priority integer DEFAULT 100) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
declare
  v_job_id bigint;
begin
  insert into ops.ops_job_queue(
    job_type,
    function_code,
    document_type_code,
    business_table,
    business_id,
    status,
    payload,
    priority,
    retry_count,
    max_retry,
    locked_at,
    picked_at,
    last_error,
    updated_at
  ) values (
    p_job_type,
    p_function_code,
    p_document_type_code,
    p_business_table,
    p_business_id,
    'PENDING',
    coalesce(p_payload, '{}'::jsonb),
    coalesce(p_priority, 100),
    0,
    3,
    null,
    null,
    null,
    now()
  )
  returning job_id into v_job_id;

  return v_job_id;
end;
$$;


--
-- Name: enqueue_notification(text, text, text, jsonb, timestamp with time zone, uuid); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.enqueue_notification(p_channel_code text, p_destination text, p_message text, p_payload jsonb DEFAULT '{}'::jsonb, p_run_after timestamp with time zone DEFAULT now(), p_created_by uuid DEFAULT auth.uid()) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
declare
  v_id bigint;
begin
  insert into ops.notification_outbox(channel_code, destination, message, payload, run_after, created_by)
  values (p_channel_code, p_destination, p_message, coalesce(p_payload,'{}'::jsonb), coalesce(p_run_after, now()), p_created_by)
  returning notification_id into v_id;
  return v_id;
end;
$$;


--
-- Name: enqueue_notify_job_for_failed_job(bigint); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.enqueue_notify_job_for_failed_job(p_job_id bigint) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
declare
  v_payload jsonb;
begin
  select jsonb_build_object(
    'job_id', q.job_id,
    'job_type', q.job_type,
    'attempts', q.attempts,
    'max_attempts', q.max_attempts,
    'last_error', q.last_error
  ) into v_payload
  from ops.ops_job_queue q
  where q.job_id = p_job_id;

  return ops.enqueue_job('NOTIFY', v_payload, now(), 10, 3, auth.uid());
end;
$$;


--
-- Name: enqueue_ops_job(text, text, text, text, bigint); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.enqueue_ops_job(p_job_type text, p_function_code text, p_document_type_code text, p_business_table text, p_business_id bigint) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
declare
  jid bigint;
  ikey text;
begin
  ikey := p_job_type || ':' || p_business_table || ':' || p_business_id;

  -- 
  if exists (
    select 1 from ops.ops_idempotency where idempotency_key = ikey
  ) then
    return null;
  end if;

  insert into ops.ops_job_queue(
    job_type, function_code, document_type_code,
    business_table, business_id
  )
  values (
    p_job_type, p_function_code, p_document_type_code,
    p_business_table, p_business_id
  )
  returning job_id into jid;

  insert into ops.ops_idempotency(
    idempotency_key, job_type, business_table, business_id
  )
  values (ikey, p_job_type, p_business_table, p_business_id);

  insert into audit.ops_audit_log(
    job_id, event_type, detail
  )
  values (
    jid,
    'ENQUEUED',
    jsonb_build_object(
      'job_type', p_job_type,
      'function_code', p_function_code
    )
  );

  return jid;
end;
$$;


--
-- Name: enqueue_send_document(text, text, text, bigint, jsonb, integer); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.enqueue_send_document(p_function_code text, p_document_type_code text, p_business_table text, p_business_id bigint, p_payload jsonb DEFAULT '{}'::jsonb, p_priority integer DEFAULT 90) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_job_id bigint;
BEGIN
  INSERT INTO ops.ops_job_queue(
    job_type, function_code, document_type_code,
    business_table, business_id,
    status, payload, priority, retry_count, max_retry,
    created_at
  )
  VALUES (
    'SEND_DOCUMENT', p_function_code, p_document_type_code,
    p_business_table, p_business_id,
    'PENDING', COALESCE(p_payload,'{}'::jsonb), COALESCE(p_priority,90), 0, 3,
    now()
  )
  RETURNING job_id INTO v_job_id;

  RETURN v_job_id;
END;
$$;


--
-- Name: fail_job(bigint, text); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.fail_job(p_job_id bigint, p_error text) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_retry int;
BEGIN
  SELECT retry_count
    INTO v_retry
    FROM ops.ops_job_queue
   WHERE job_id = p_job_id;

  IF v_retry < 3 THEN
    UPDATE ops.ops_job_queue
       SET retry_count = retry_count + 1,
           status      = 'PENDING',
           locked_at   = NULL,
           picked_at   = NULL
     WHERE job_id = p_job_id;
  ELSE
    INSERT INTO ops.ops_job_result (
      job_id,
      result_payload,
      status,
      created_at
    )
    VALUES (
      p_job_id,
      jsonb_build_object('error', p_error),
      'FAILED',
      now()
    );

    UPDATE ops.ops_job_queue
       SET status      = 'FAILED',
           finished_at = now()
     WHERE job_id = p_job_id;
  END IF;
END;
$$;


--
-- Name: fail_job(bigint, text, jsonb); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.fail_job(p_job_id bigint, p_error text, p_detail jsonb DEFAULT '{}'::jsonb) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
  v_retry int;
  v_max int;
  v_next_status text;
begin
  select retry_count, max_retry into v_retry, v_max
    from ops.ops_job_queue
   where job_id = p_job_id
   for update;

  if not found then
    raise exception 'job_id % not found', p_job_id;
  end if;

  v_retry := coalesce(v_retry,0) + 1;

  if v_retry < coalesce(v_max,3) then
    v_next_status := 'PENDING';
  else
    v_next_status := 'FAILED';
  end if;

  update ops.ops_job_queue
     set retry_count = v_retry,
         status = v_next_status,
         locked_at = null,
         last_error = left(coalesce(p_error,''), 4000),
         updated_at = now()
   where job_id = p_job_id;

  -- store latest failure snapshot
  insert into ops.ops_job_result(job_id, result_status, result_detail, completed_at)
  values (p_job_id, 'FAILED', jsonb_build_object('error', p_error, 'detail', coalesce(p_detail,'{}'::jsonb)), now())
  on conflict (job_id) do update
    set result_status = excluded.result_status,
        result_detail = excluded.result_detail,
        completed_at  = excluded.completed_at;
end;
$$;


--
-- Name: ops_send_dispatch(bigint); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.ops_send_dispatch(p_send_history_id bigint) RETURNS text
    LANGUAGE plpgsql
    AS $$
declare
  v_channel text;
  v_status text;
begin
  select channel_code into v_channel
    from ops.document_send_history
   where send_history_id = p_send_history_id;

  if v_channel in ('EMAIL','FAX','PAPER') then
    v_status := 'SUCCESS';
  else
    v_status := 'FAILED';
  end if;

  update ops.document_send_history
     set send_status = v_status,
         sent_at = now()
   where send_history_id = p_send_history_id;

  return v_status;
end;
$$;


--
-- Name: FUNCTION ops_send_dispatch(p_send_history_id bigint); Type: COMMENT; Schema: ops; Owner: -
--

COMMENT ON FUNCTION ops.ops_send_dispatch(p_send_history_id bigint) IS ': ';




--
-- Name: ops_job_queue; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.ops_job_queue (
    job_id bigint NOT NULL,
    job_type text NOT NULL,
    function_code text NOT NULL,
    document_type_code text NOT NULL,
    business_table text NOT NULL,
    business_id bigint NOT NULL,
    job_status text DEFAULT 'PENDING'::text NOT NULL,
    retry_count integer DEFAULT 0 NOT NULL,
    max_retry integer DEFAULT 3 NOT NULL,
    locked_at timestamp with time zone,
    locked_by text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    executed_at timestamp with time zone,
    payload jsonb DEFAULT '{}'::jsonb NOT NULL,
    status text DEFAULT 'PENDING'::text NOT NULL,
    priority integer DEFAULT 100 NOT NULL,
    run_after timestamp with time zone DEFAULT now() NOT NULL,
    attempts integer DEFAULT 0 NOT NULL,
    max_attempts integer DEFAULT 3 NOT NULL,
    last_error text,
    created_by uuid,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    picked_at timestamp with time zone,
    finished_at timestamp with time zone,
    CONSTRAINT ops_job_queue_job_type_check CHECK ((job_type = ANY (ARRAY['GENERATE_PDF'::text, 'SEND_DOCUMENT'::text]))),
    CONSTRAINT ops_job_queue_status_check CHECK ((status = ANY (ARRAY['PENDING'::text, 'PROCESSING'::text, 'SUCCESS'::text, 'FAILED'::text, 'CANCELLED'::text])))
);


--
-- Name: pick_next_job(); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.pick_next_job() RETURNS ops.ops_job_queue
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_job ops.ops_job_queue;
BEGIN
  SELECT *
    INTO v_job
    FROM ops.ops_job_queue
   WHERE status = 'PENDING'
     AND locked_at IS NULL
   ORDER BY priority DESC, created_at
   FOR UPDATE SKIP LOCKED
   LIMIT 1;

  IF NOT FOUND THEN
    RETURN NULL;
  END IF;

  UPDATE ops.ops_job_queue
     SET locked_at = now(),
         picked_at = now(),
         status    = 'PROCESSING'
   WHERE job_id = v_job.job_id;

  RETURN v_job;
END;
$$;


--
-- Name: pick_next_job(text, text); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.pick_next_job(p_job_type text DEFAULT NULL::text, p_function_code text DEFAULT NULL::text) RETURNS TABLE(job_id bigint, job_type text, function_code text, document_type_code text, business_table text, business_id bigint, status text, priority integer, retry_count integer, max_retry integer, locked_at timestamp with time zone, picked_at timestamp with time zone, payload jsonb, last_error text, created_at timestamp with time zone, updated_at timestamp with time zone)
    LANGUAGE plpgsql
    AS $$
begin
  return query
  with picked as (
    select q.job_id
    from ops.ops_job_queue q
    where q.status = 'PENDING'
      and (p_job_type is null or q.job_type = p_job_type)
      and (p_function_code is null or q.function_code = p_function_code)
      and (q.locked_at is null)  -- free
    order by q.priority desc, q.job_id asc
    for update skip locked
    limit 1
  )
  update ops.ops_job_queue q
     set status   = 'PROCESSING',
         locked_at = now(),
         picked_at = now(),
         updated_at = now()
    from picked
   where q.job_id = picked.job_id
  returning
    q.job_id, q.job_type, q.function_code, q.document_type_code,
    q.business_table, q.business_id, q.status, q.priority,
    q.retry_count, q.max_retry, q.locked_at, q.picked_at,
    q.payload, q.last_error, q.created_at, q.updated_at;
end;
$$;


--
-- Name: pick_next_notification(); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.pick_next_notification() RETURNS TABLE(outbox_id bigint, channel_type text, destination text, payload_text text, retry_count integer, max_retry integer)
    LANGUAGE plpgsql
    AS $$
begin
  return query
  with picked as (
    select o.outbox_id
      from ops.notification_outbox o
     where o.status = 'PENDING'
       and o.retry_count < o.max_retry
     order by o.created_at asc
     for update skip locked
     limit 1
  )
  update ops.notification_outbox o
     set status = 'PENDING' -- keep
    from picked
   where o.outbox_id = picked.outbox_id
  returning
    o.outbox_id, o.channel_type, o.destination, o.payload::text, o.retry_count, o.max_retry;
end;
$$;


--
-- Name: retry_failed_document_send(); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.retry_failed_document_send() RETURNS integer
    LANGUAGE plpgsql
    AS $$
declare
  r record;
  retried int := 0;
begin
  for r in
    select send_history_id
      from ops.document_send_history
     where send_status = 'FAILED'
       and retry_count < 3
  loop
    update ops.document_send_history
       set retry_count = retry_count + 1
     where send_history_id = r.send_history_id;
    retried := retried + 1;
  end loop;
  return retried;
end;
$$;


--
-- Name: snapshot_ops_structure(); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.snapshot_ops_structure() RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  insert into ops.document_type_master
  select * from ops.document_type_master on conflict do nothing;
  insert into ops.send_channel_master
  select * from ops.send_channel_master on conflict do nothing;
  insert into ops.resend_type_master
  select * from ops.resend_type_master on conflict do nothing;
  insert into ops.send_fee_master
  select * from ops.send_fee_master on conflict do nothing;
end;
$$;


--
-- Name: FUNCTION snapshot_ops_structure(); Type: COMMENT; Schema: ops; Owner: -
--

COMMENT ON FUNCTION ops.snapshot_ops_structure() IS 'OPS';


--
-- Name: tg_touch_updated_at(); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.tg_touch_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
begin
  new.updated_at := now();
  return new;
end;
$$;


--
-- Name: trg_after_job_result(); Type: FUNCTION; Schema: ops; Owner: -
--

CREATE FUNCTION ops.trg_after_job_result() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
declare
  vq ops.ops_job_queue%rowtype;
  v_new_job_id bigint;
begin
  select * into vq
    from ops.ops_job_queue
   where job_id = new.job_id;

  if not found then
    return new;
  end if;

  -- SUCCESS chain: GENERATE_PDF -> SEND_DOCUMENT
  if new.result_status = 'SUCCESS' and vq.job_type = 'GENERATE_PDF' then
    v_new_job_id := ops.enqueue_job(
      'SEND_DOCUMENT',
      vq.function_code,
      vq.document_type_code,
      vq.business_table,
      vq.business_id,
      jsonb_build_object(
        'from_job_id', vq.job_id,
        'doc', vq.document_type_code
      ),
      greatest(coalesce(vq.priority,100), 100)
    );
    return new;
  end if;

  -- FAILED notify
  if new.result_status = 'FAILED' then
    insert into ops.notification_outbox(job_id, channel, destination, payload, status)
    values (
      new.job_id,
      'WEBHOOK',
      null,
      jsonb_build_object(
        'job_id', new.job_id,
        'job_type', vq.job_type,
        'function_code', vq.function_code,
        'document_type_code', vq.document_type_code,
        'business_table', vq.business_table,
        'business_id', vq.business_id,
        'result_detail', new.result_detail
      ),
      'PENDING'
    );
    return new;
  end if;

  return new;
end;
$$;


--
-- Name: get_auth(text); Type: FUNCTION; Schema: pgbouncer; Owner: -
--

CREATE FUNCTION pgbouncer.get_auth(p_usename text) RETURNS TABLE(username text, password text)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO ''
    AS $_$
  BEGIN
      RAISE DEBUG 'PgBouncer auth request: %', p_usename;

      RETURN QUERY
      SELECT
          rolname::text,
          CASE WHEN rolvaliduntil < now()
              THEN null
              ELSE rolpassword::text
          END
      FROM pg_authid
      WHERE rolname=$1 and rolcanlogin;
  END;
  $_$;


--
-- Name: act_approval(uuid, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.act_approval(p_request_id uuid, p_action text, p_note text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'audit', 'public'
    AS $$
BEGIN
  UPDATE audit.approval_request
  SET
    status =
      CASE
        WHEN p_action = 'approve' THEN 'approved'
        WHEN p_action = 'reject'  THEN 'rejected'
        ELSE status
      END,
    decided_by   = current_user,
    decided_at   = now(),
    decision_note = p_note
  WHERE request_id = p_request_id;

  INSERT INTO audit.approval_log (
    approval_request_id,
    action,
    actor,
    note,
    acted_at
  )
  VALUES (
    p_request_id,
    p_action,
    current_user,
    p_note,
    now()
  );
END;
$$;


--
-- Name: create_ai_job(uuid, text, jsonb, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_ai_job(p_company_id uuid, p_job_type text, p_params jsonb, p_decided_by text) RETURNS bigint
    LANGUAGE sql
    AS $$
  insert into analytics.ai_job (company_id, job_type, params, decided_by)
  values (p_company_id, p_job_type, coalesce(p_params,'{}'::jsonb), p_decided_by)
  returning ai_job_id;
$$;


--
-- Name: create_approval_request(text, text, text, text, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_approval_request(p_domain text, p_entity_type text, p_entity_id text, p_reason text, p_severity text DEFAULT NULL::text, p_policy_id text DEFAULT NULL::text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'audit', 'public'
    AS $$
DECLARE
  v_id uuid;
BEGIN
  INSERT INTO audit.approval_request (
    company_id,
    domain,
    entity_type,
    entity_id,
    reason,
    severity,
    policy_id,
    detected_at,
    status
  )
  VALUES (
    audit.current_company_id(),
    p_domain,
    p_entity_type,
    p_entity_id,
    p_reason,
    p_severity,
    p_policy_id,
    now(),
    'pending'
  )
  RETURNING request_id INTO v_id;

  RETURN v_id;
END;
$$;


--
-- Name: enqueue_notification(uuid, text, text, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.enqueue_notification(p_company_id uuid, p_channel text, p_destination text, p_payload jsonb) RETURNS void
    LANGUAGE sql
    AS $$
  insert into analytics.notification_queue
    (company_id, channel, destination, payload)
  values
    (p_company_id, p_channel, p_destination, coalesce(p_payload,'{}'::jsonb));
$$;


--
-- Name: approval_request; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.approval_request (
    request_id uuid DEFAULT gen_random_uuid() NOT NULL,
    company_id uuid NOT NULL,
    domain text NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    order_id bigint,
    reason text NOT NULL,
    detected_at timestamp with time zone DEFAULT now() NOT NULL,
    status text NOT NULL,
    decided_at timestamp with time zone,
    decided_by uuid,
    decision_note text,
    policy_id text,
    severity text,
    CONSTRAINT approval_request_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text])))
);


--
-- Name: get_approval_requests(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_approval_requests(p_limit integer DEFAULT 100) RETURNS SETOF audit.approval_request
    LANGUAGE sql STABLE SECURITY DEFINER
    SET search_path TO 'audit', 'public'
    AS $$
  SELECT *
  FROM audit.approval_request
  ORDER BY detected_at DESC
  LIMIT p_limit;
$$;


--
-- Name: ng_event; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.ng_event (
    ng_event_id bigint NOT NULL,
    company_id uuid NOT NULL,
    occurred_at timestamp with time zone DEFAULT now() NOT NULL,
    event_key text NOT NULL,
    task_name text,
    audit_scope text NOT NULL,
    severity text NOT NULL,
    reason_code text NOT NULL,
    phase text,
    retry_count integer DEFAULT 0 NOT NULL,
    auto_fixed boolean DEFAULT false NOT NULL,
    quarantined boolean DEFAULT false NOT NULL,
    approval_required boolean DEFAULT false NOT NULL,
    approved_by uuid,
    approved_at timestamp with time zone,
    business_domain text,
    context jsonb DEFAULT '{}'::jsonb NOT NULL,
    CONSTRAINT ng_event_audit_scope_check CHECK ((audit_scope = ANY (ARRAY['internal'::text, 'external'::text, 'both'::text]))),
    CONSTRAINT ng_event_severity_check CHECK ((severity = ANY (ARRAY['ok'::text, 'warn'::text, 'ng'::text, 'critical'::text])))
);


--
-- Name: TABLE ng_event; Type: COMMENT; Schema: audit; Owner: -
--

COMMENT ON TABLE audit.ng_event IS 'Internal audit & runtime control canonical table (event_key enabled).';


--
-- Name: get_ng_events(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_ng_events(p_limit integer DEFAULT 100) RETURNS SETOF audit.ng_event
    LANGUAGE sql STABLE SECURITY DEFINER
    SET search_path TO 'audit', 'public'
    AS $$
  SELECT *
  FROM audit.ng_event
  ORDER BY occurred_at DESC
  LIMIT p_limit;
$$;


--
-- Name: ai_event; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.ai_event (
    ai_event_id bigint NOT NULL,
    company_id uuid NOT NULL,
    source_table text NOT NULL,
    source_id bigint NOT NULL,
    event_type text NOT NULL,
    severity text DEFAULT 'info'::text NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    payload jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    swept_at timestamp with time zone,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: get_ng_events(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_ng_events(p_company_id uuid) RETURNS SETOF analytics.ai_event
    LANGUAGE sql STABLE
    AS $$
  select *
    from analytics.ai_event
   where company_id = p_company_id
     and status = 'pending'
   order by created_at
   limit 100;
$$;


--
-- Name: get_ng_events_all(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_ng_events_all() RETURNS SETOF analytics.ai_event
    LANGUAGE sql STABLE
    AS $$
  select *
  from analytics.ai_event
  where status = 'pending'
  order by created_at
  limit 100;
$$;


--
-- Name: ai_job; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.ai_job (
    ai_job_id bigint NOT NULL,
    company_id uuid NOT NULL,
    job_type text NOT NULL,
    params jsonb DEFAULT '{}'::jsonb NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    decided_by text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    started_at timestamp with time zone,
    finished_at timestamp with time zone,
    last_error text,
    requires_approval boolean DEFAULT false NOT NULL
);


--
-- Name: get_pending_ai_jobs(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_pending_ai_jobs(p_company_id uuid) RETURNS SETOF analytics.ai_job
    LANGUAGE sql STABLE
    AS $$
  select * from analytics.ai_job
   where company_id = p_company_id
     and status = 'pending'
   order by created_at
   limit 50;
$$;


--
-- Name: get_pending_ai_jobs_all(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_pending_ai_jobs_all() RETURNS SETOF analytics.ai_job
    LANGUAGE sql STABLE
    AS $$
  select *
  from analytics.ai_job
  where status='pending'
  order by created_at
  limit 100;
$$;


--
-- Name: notification_queue; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.notification_queue (
    notification_id bigint NOT NULL,
    company_id uuid NOT NULL,
    channel text NOT NULL,
    destination text NOT NULL,
    payload jsonb NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    sent_at timestamp with time zone,
    last_error text
);


--
-- Name: get_pending_notifications(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_pending_notifications() RETURNS SETOF analytics.notification_queue
    LANGUAGE sql STABLE
    AS $$
  select *
  from analytics.notification_queue
  where status='pending'
  order by created_at
  limit 100;
$$;


--
-- Name: is_admin(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.is_admin() RETURNS boolean
    LANGUAGE sql STABLE
    AS $$
  select coalesce(
    (auth.jwt() -> 'app_metadata' ->> 'role') = 'admin',
    false
  );
$$;


--
-- Name: is_ai_enabled(text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.is_ai_enabled(p_scope text) RETURNS boolean
    LANGUAGE sql STABLE
    AS $$
  select coalesce(
    (select is_enabled from analytics.ai_kill_switch where scope=p_scope),
    true
  );
$$;


--
-- Name: mark_ai_event_swept(bigint); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_ai_event_swept(p_ai_event_id bigint) RETURNS void
    LANGUAGE sql
    AS $$
  update analytics.ai_event
     set status='swept', swept_at=now()
   where ai_event_id=p_ai_event_id;
$$;


--
-- Name: mark_ai_job_done(bigint); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_ai_job_done(p_ai_job_id bigint) RETURNS void
    LANGUAGE sql
    AS $$
  update analytics.ai_job
     set status='done', finished_at=now()
   where ai_job_id=p_ai_job_id;
$$;


--
-- Name: mark_ai_job_failed(bigint, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_ai_job_failed(p_ai_job_id bigint, p_err text) RETURNS void
    LANGUAGE sql
    AS $$
  update analytics.ai_job
     set status='failed', finished_at=now(), last_error=p_err
   where ai_job_id=p_ai_job_id;
$$;


--
-- Name: mark_ai_job_running(bigint); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_ai_job_running(p_ai_job_id bigint) RETURNS void
    LANGUAGE sql
    AS $$
  update analytics.ai_job
     set status='running', started_at=now()
   where ai_job_id=p_ai_job_id and status='pending';
$$;


--
-- Name: mark_notification_failed(bigint, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_notification_failed(p_id bigint, p_err text) RETURNS void
    LANGUAGE sql
    AS $$
  update analytics.notification_queue
     set status='failed', last_error=p_err
   where notification_id=p_id;
$$;


--
-- Name: mark_notification_sent(bigint); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_notification_sent(p_id bigint) RETURNS void
    LANGUAGE sql
    AS $$
  update analytics.notification_queue
     set status='sent', sent_at=now()
   where notification_id=p_id;
$$;


--
-- Name: my_company_id(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.my_company_id() RETURNS uuid
    LANGUAGE sql STABLE SECURITY DEFINER
    SET search_path TO 'core', 'public'
    AS $$
  SELECT cu.company_id
  FROM core.company_users cu
  WHERE cu.user_id = auth.uid()
  LIMIT 1;
$$;


--
-- Name: sweep_ai_event(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.sweep_ai_event(p_company_id uuid, p_keep_days integer DEFAULT 30) RETURNS integer
    LANGUAGE sql SECURITY DEFINER
    AS $$
  select analytics.sweep_ai_event(p_company_id, p_keep_days);
$$;


--
-- Name: FUNCTION sweep_ai_event(p_company_id uuid, p_keep_days integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.sweep_ai_event(p_company_id uuid, p_keep_days integer) IS 'RPC bridge: public -> analytics.sweep_ai_event';


--
-- Name: trg_v_core_audit_trail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_core_audit_trail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'core', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO core.audit_trail (company_id, entity_type, entity_id, action, action_category, detail, performed_by, performed_at)
           VALUES (my_company_id(), NEW.entity_type, NEW.entity_id, NEW.action, NEW.action_category, NEW.detail, NEW.performed_by, NEW.performed_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE core.audit_trail
              SET entity_type = NEW.entity_type, entity_id = NEW.entity_id, action = NEW.action, action_category = NEW.action_category, detail = NEW.detail, performed_by = NEW.performed_by, performed_at = NEW.performed_at
            WHERE audit_trail_id = OLD.audit_trail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM core.audit_trail
            WHERE audit_trail_id = OLD.audit_trail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_core_company_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_core_company_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'core', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO core.company (company_code, company_name, currency_code, timezone, is_active, created_at, updated_at)
           VALUES (NEW.company_code, NEW.company_name, NEW.currency_code, NEW.timezone, NEW.is_active, NEW.created_at, NEW.updated_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE core.company
              SET company_code = NEW.company_code, company_name = NEW.company_name, currency_code = NEW.currency_code, timezone = NEW.timezone, is_active = NEW.is_active, created_at = NEW.created_at, updated_at = NEW.updated_at
            WHERE company_id = OLD.company_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM core.company
            WHERE company_id = OLD.company_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_core_company_license_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_core_company_license_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'core', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO core.company_license (company_id, license_code, purchased_at, expires_at, is_active)
           VALUES (my_company_id(), NEW.license_code, NEW.purchased_at, NEW.expires_at, NEW.is_active)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE core.company_license
              SET license_code = NEW.license_code, purchased_at = NEW.purchased_at, expires_at = NEW.expires_at, is_active = NEW.is_active
            WHERE company_license_id = OLD.company_license_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM core.company_license
            WHERE company_license_id = OLD.company_license_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_core_company_permission_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_core_company_permission_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'core', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO core.company_permission (company_id, permission_code, enabled, created_at)
           VALUES (my_company_id(), NEW.permission_code, NEW.enabled, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE core.company_permission
              SET permission_code = NEW.permission_code, enabled = NEW.enabled, created_at = NEW.created_at
            WHERE company_permission_id = OLD.company_permission_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM core.company_permission
            WHERE company_permission_id = OLD.company_permission_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_core_journal_source_link_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_core_journal_source_link_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'core', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO core.journal_source_link (journal_id, source_type, source_id, created_at)
           VALUES (NEW.journal_id, NEW.source_type, NEW.source_id, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE core.journal_source_link
              SET journal_id = NEW.journal_id, source_type = NEW.source_type, source_id = NEW.source_id, created_at = NEW.created_at
            WHERE journal_source_link_id = OLD.journal_source_link_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM core.journal_source_link
            WHERE journal_source_link_id = OLD.journal_source_link_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_core_payment_term_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_core_payment_term_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'core', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO core.payment_term (term_code, term_name, closing_day, payment_offset_month, payment_day, description, is_active)
           VALUES (NEW.term_code, NEW.term_name, NEW.closing_day, NEW.payment_offset_month, NEW.payment_day, NEW.description, NEW.is_active)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE core.payment_term
              SET term_code = NEW.term_code, term_name = NEW.term_name, closing_day = NEW.closing_day, payment_offset_month = NEW.payment_offset_month, payment_day = NEW.payment_day, description = NEW.description, is_active = NEW.is_active
            WHERE payment_term_id = OLD.payment_term_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM core.payment_term
            WHERE payment_term_id = OLD.payment_term_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_core_posting_profile_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_core_posting_profile_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'core', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO core.posting_profile (company_id, profile_code, source_type, debit_account_id, credit_account_id, description, is_active)
           VALUES (my_company_id(), NEW.profile_code, NEW.source_type, NEW.debit_account_id, NEW.credit_account_id, NEW.description, NEW.is_active)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE core.posting_profile
              SET profile_code = NEW.profile_code, source_type = NEW.source_type, debit_account_id = NEW.debit_account_id, credit_account_id = NEW.credit_account_id, description = NEW.description, is_active = NEW.is_active
            WHERE posting_profile_id = OLD.posting_profile_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM core.posting_profile
            WHERE posting_profile_id = OLD.posting_profile_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_core_status_history_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_core_status_history_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'core', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO core.status_history (company_id, entity_type, entity_id, from_status_code, to_status_code, changed_by, changed_at, reason)
           VALUES (my_company_id(), NEW.entity_type, NEW.entity_id, NEW.from_status_code, NEW.to_status_code, NEW.changed_by, NEW.changed_at, NEW.reason)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE core.status_history
              SET entity_type = NEW.entity_type, entity_id = NEW.entity_id, from_status_code = NEW.from_status_code, to_status_code = NEW.to_status_code, changed_by = NEW.changed_by, changed_at = NEW.changed_at, reason = NEW.reason
            WHERE status_history_id = OLD.status_history_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM core.status_history
            WHERE status_history_id = OLD.status_history_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_finance_bank_account_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_finance_bank_account_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'finance', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO finance.bank_account (company_id, bank_name, branch_name, account_type, account_number, account_name, currency_code, is_active)
           VALUES (my_company_id(), NEW.bank_name, NEW.branch_name, NEW.account_type, NEW.account_number, NEW.account_name, NEW.currency_code, NEW.is_active)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE finance.bank_account
              SET bank_name = NEW.bank_name, branch_name = NEW.branch_name, account_type = NEW.account_type, account_number = NEW.account_number, account_name = NEW.account_name, currency_code = NEW.currency_code, is_active = NEW.is_active
            WHERE bank_account_id = OLD.bank_account_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM finance.bank_account
            WHERE bank_account_id = OLD.bank_account_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_finance_bank_statement_line_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_finance_bank_statement_line_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'finance', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO finance.bank_statement_line (bank_statement_id, line_no, transaction_date, description, debit_amount, credit_amount, balance_amount)
           VALUES (NEW.bank_statement_id, NEW.line_no, NEW.transaction_date, NEW.description, NEW.debit_amount, NEW.credit_amount, NEW.balance_amount)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE finance.bank_statement_line
              SET bank_statement_id = NEW.bank_statement_id, line_no = NEW.line_no, transaction_date = NEW.transaction_date, description = NEW.description, debit_amount = NEW.debit_amount, credit_amount = NEW.credit_amount, balance_amount = NEW.balance_amount
            WHERE bank_statement_line_id = OLD.bank_statement_line_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM finance.bank_statement_line
            WHERE bank_statement_line_id = OLD.bank_statement_line_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_finance_payment_allocation_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_finance_payment_allocation_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'finance', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO finance.payment_allocation (payment_id, source_type, source_id, allocated_amount, allocated_at)
           VALUES (NEW.payment_id, NEW.source_type, NEW.source_id, NEW.allocated_amount, NEW.allocated_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE finance.payment_allocation
              SET payment_id = NEW.payment_id, source_type = NEW.source_type, source_id = NEW.source_id, allocated_amount = NEW.allocated_amount, allocated_at = NEW.allocated_at
            WHERE payment_allocation_id = OLD.payment_allocation_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM finance.payment_allocation
            WHERE payment_allocation_id = OLD.payment_allocation_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_finance_payment_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_finance_payment_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'finance', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO finance.payment (company_id, payment_type, partner_type, partner_id, payment_date, amount, bank_account_id, status_code, created_at)
           VALUES (my_company_id(), NEW.payment_type, NEW.partner_type, NEW.partner_id, NEW.payment_date, NEW.amount, NEW.bank_account_id, NEW.status_code, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE finance.payment
              SET payment_type = NEW.payment_type, partner_type = NEW.partner_type, partner_id = NEW.partner_id, payment_date = NEW.payment_date, amount = NEW.amount, bank_account_id = NEW.bank_account_id, status_code = NEW.status_code, created_at = NEW.created_at
            WHERE payment_id = OLD.payment_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM finance.payment
            WHERE payment_id = OLD.payment_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_hr_attendance_log_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_hr_attendance_log_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'hr', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO hr.attendance_log (company_id, employee_id, work_date, clock_in, clock_out, work_minutes)
           VALUES (my_company_id(), NEW.employee_id, NEW.work_date, NEW.clock_in, NEW.clock_out, NEW.work_minutes)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE hr.attendance_log
              SET employee_id = NEW.employee_id, work_date = NEW.work_date, clock_in = NEW.clock_in, clock_out = NEW.clock_out, work_minutes = NEW.work_minutes
            WHERE attendance_log_id = OLD.attendance_log_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM hr.attendance_log
            WHERE attendance_log_id = OLD.attendance_log_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_hr_employee_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_hr_employee_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'hr', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO hr.employee (company_id, employee_code, employee_name, department_id, position_id, hired_date, is_active)
           VALUES (my_company_id(), NEW.employee_code, NEW.employee_name, NEW.department_id, NEW.position_id, NEW.hired_date, NEW.is_active)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE hr.employee
              SET employee_code = NEW.employee_code, employee_name = NEW.employee_name, department_id = NEW.department_id, position_id = NEW.position_id, hired_date = NEW.hired_date, is_active = NEW.is_active
            WHERE employee_id = OLD.employee_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM hr.employee
            WHERE employee_id = OLD.employee_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_hr_employment_contract_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_hr_employment_contract_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'hr', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO hr.employment_contract (company_id, employee_id, employment_type, start_date, end_date, base_salary, created_at)
           VALUES (my_company_id(), NEW.employee_id, NEW.employment_type, NEW.start_date, NEW.end_date, NEW.base_salary, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE hr.employment_contract
              SET employee_id = NEW.employee_id, employment_type = NEW.employment_type, start_date = NEW.start_date, end_date = NEW.end_date, base_salary = NEW.base_salary, created_at = NEW.created_at
            WHERE employment_contract_id = OLD.employment_contract_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM hr.employment_contract
            WHERE employment_contract_id = OLD.employment_contract_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_hr_leave_request_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_hr_leave_request_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'hr', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO hr.leave_request (company_id, employee_id, leave_type_code, start_date, end_date, status_code, approved_by, created_at)
           VALUES (my_company_id(), NEW.employee_id, NEW.leave_type_code, NEW.start_date, NEW.end_date, NEW.status_code, NEW.approved_by, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE hr.leave_request
              SET employee_id = NEW.employee_id, leave_type_code = NEW.leave_type_code, start_date = NEW.start_date, end_date = NEW.end_date, status_code = NEW.status_code, approved_by = NEW.approved_by, created_at = NEW.created_at
            WHERE leave_request_id = OLD.leave_request_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM hr.leave_request
            WHERE leave_request_id = OLD.leave_request_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_hr_payroll_run_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_hr_payroll_run_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'hr', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO hr.payroll_run (company_id, pay_month, status_code, created_at)
           VALUES (my_company_id(), NEW.pay_month, NEW.status_code, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE hr.payroll_run
              SET pay_month = NEW.pay_month, status_code = NEW.status_code, created_at = NEW.created_at
            WHERE payroll_run_id = OLD.payroll_run_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM hr.payroll_run
            WHERE payroll_run_id = OLD.payroll_run_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_hr_payroll_slip_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_hr_payroll_slip_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'hr', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO hr.payroll_slip (payroll_run_id, employee_id, gross_pay, net_pay, created_at)
           VALUES (NEW.payroll_run_id, NEW.employee_id, NEW.gross_pay, NEW.net_pay, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE hr.payroll_slip
              SET payroll_run_id = NEW.payroll_run_id, employee_id = NEW.employee_id, gross_pay = NEW.gross_pay, net_pay = NEW.net_pay, created_at = NEW.created_at
            WHERE payroll_slip_id = OLD.payroll_slip_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM hr.payroll_slip
            WHERE payroll_slip_id = OLD.payroll_slip_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_inventory_inventory_valuation_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_inventory_inventory_valuation_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'inventory', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO inventory.inventory_valuation (company_id, item_id, valuation_date, method, unit_cost, created_at)
           VALUES (my_company_id(), NEW.item_id, NEW.valuation_date, NEW.method, NEW.unit_cost, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE inventory.inventory_valuation
              SET item_id = NEW.item_id, valuation_date = NEW.valuation_date, method = NEW.method, unit_cost = NEW.unit_cost, created_at = NEW.created_at
            WHERE inventory_valuation_id = OLD.inventory_valuation_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM inventory.inventory_valuation
            WHERE inventory_valuation_id = OLD.inventory_valuation_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_inventory_stock_balance_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_inventory_stock_balance_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'inventory', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO inventory.stock_balance (company_id, warehouse_id, location_id, bin_id, item_id, qty_on_hand, qty_reserved, updated_at)
           VALUES (my_company_id(), NEW.warehouse_id, NEW.location_id, NEW.bin_id, NEW.item_id, NEW.qty_on_hand, NEW.qty_reserved, NEW.updated_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE inventory.stock_balance
              SET warehouse_id = NEW.warehouse_id, location_id = NEW.location_id, bin_id = NEW.bin_id, item_id = NEW.item_id, qty_on_hand = NEW.qty_on_hand, qty_reserved = NEW.qty_reserved, updated_at = NEW.updated_at
            WHERE stock_balance_id = OLD.stock_balance_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM inventory.stock_balance
            WHERE stock_balance_id = OLD.stock_balance_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_inventory_stock_lot_balance_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_inventory_stock_lot_balance_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'inventory', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO inventory.stock_lot_balance (company_id, warehouse_id, location_id, bin_id, item_id, stock_lot_id, qty_on_hand, qty_reserved, updated_at)
           VALUES (my_company_id(), NEW.warehouse_id, NEW.location_id, NEW.bin_id, NEW.item_id, NEW.stock_lot_id, NEW.qty_on_hand, NEW.qty_reserved, NEW.updated_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE inventory.stock_lot_balance
              SET warehouse_id = NEW.warehouse_id, location_id = NEW.location_id, bin_id = NEW.bin_id, item_id = NEW.item_id, stock_lot_id = NEW.stock_lot_id, qty_on_hand = NEW.qty_on_hand, qty_reserved = NEW.qty_reserved, updated_at = NEW.updated_at
            WHERE stock_lot_balance_id = OLD.stock_lot_balance_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM inventory.stock_lot_balance
            WHERE stock_lot_balance_id = OLD.stock_lot_balance_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_inventory_stock_lot_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_inventory_stock_lot_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'inventory', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO inventory.stock_lot (company_id, item_id, lot_no, serial_no, expiry_date)
           VALUES (my_company_id(), NEW.item_id, NEW.lot_no, NEW.serial_no, NEW.expiry_date)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE inventory.stock_lot
              SET item_id = NEW.item_id, lot_no = NEW.lot_no, serial_no = NEW.serial_no, expiry_date = NEW.expiry_date
            WHERE stock_lot_id = OLD.stock_lot_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM inventory.stock_lot
            WHERE stock_lot_id = OLD.stock_lot_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_inventory_stock_reservation_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_inventory_stock_reservation_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'inventory', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO inventory.stock_reservation (company_id, entity_type, entity_id, item_id, stock_lot_id, qty_reserved, reserved_at)
           VALUES (my_company_id(), NEW.entity_type, NEW.entity_id, NEW.item_id, NEW.stock_lot_id, NEW.qty_reserved, NEW.reserved_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE inventory.stock_reservation
              SET entity_type = NEW.entity_type, entity_id = NEW.entity_id, item_id = NEW.item_id, stock_lot_id = NEW.stock_lot_id, qty_reserved = NEW.qty_reserved, reserved_at = NEW.reserved_at
            WHERE stock_reservation_id = OLD.stock_reservation_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM inventory.stock_reservation
            WHERE stock_reservation_id = OLD.stock_reservation_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_inventory_stock_transfer_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_inventory_stock_transfer_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'inventory', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO inventory.stock_transfer_detail (stock_transfer_id, line_no, item_id, qty, from_location_id, to_location_id, from_bin_id, to_bin_id, stock_lot_id)
           VALUES (NEW.stock_transfer_id, NEW.line_no, NEW.item_id, NEW.qty, NEW.from_location_id, NEW.to_location_id, NEW.from_bin_id, NEW.to_bin_id, NEW.stock_lot_id)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE inventory.stock_transfer_detail
              SET stock_transfer_id = NEW.stock_transfer_id, line_no = NEW.line_no, item_id = NEW.item_id, qty = NEW.qty, from_location_id = NEW.from_location_id, to_location_id = NEW.to_location_id, from_bin_id = NEW.from_bin_id, to_bin_id = NEW.to_bin_id, stock_lot_id = NEW.stock_lot_id
            WHERE stock_transfer_detail_id = OLD.stock_transfer_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM inventory.stock_transfer_detail
            WHERE stock_transfer_detail_id = OLD.stock_transfer_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_inventory_stocktaking_plan_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_inventory_stocktaking_plan_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'inventory', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO inventory.stocktaking_plan (company_id, warehouse_id, plan_date, status_code, created_at)
           VALUES (my_company_id(), NEW.warehouse_id, NEW.plan_date, NEW.status_code, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE inventory.stocktaking_plan
              SET warehouse_id = NEW.warehouse_id, plan_date = NEW.plan_date, status_code = NEW.status_code, created_at = NEW.created_at
            WHERE stocktaking_plan_id = OLD.stocktaking_plan_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM inventory.stocktaking_plan
            WHERE stocktaking_plan_id = OLD.stocktaking_plan_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_inventory_stocktaking_result_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_inventory_stocktaking_result_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'inventory', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO inventory.stocktaking_result (stocktaking_plan_id, company_id, bin_id, item_id, counted_qty, system_qty, difference_qty, created_at)
           VALUES (NEW.stocktaking_plan_id, my_company_id(), NEW.bin_id, NEW.item_id, NEW.counted_qty, NEW.system_qty, NEW.difference_qty, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE inventory.stocktaking_result
              SET stocktaking_plan_id = NEW.stocktaking_plan_id, bin_id = NEW.bin_id, item_id = NEW.item_id, counted_qty = NEW.counted_qty, system_qty = NEW.system_qty, difference_qty = NEW.difference_qty, created_at = NEW.created_at
            WHERE stocktaking_result_id = OLD.stocktaking_result_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM inventory.stocktaking_result
            WHERE stocktaking_result_id = OLD.stocktaking_result_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_inventory_warehouse_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_inventory_warehouse_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'inventory', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO inventory.warehouse (company_id, warehouse_code, warehouse_name, is_active, created_at)
           VALUES (my_company_id(), NEW.warehouse_code, NEW.warehouse_name, NEW.is_active, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE inventory.warehouse
              SET warehouse_code = NEW.warehouse_code, warehouse_name = NEW.warehouse_name, is_active = NEW.is_active, created_at = NEW.created_at
            WHERE warehouse_id = OLD.warehouse_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM inventory.warehouse
            WHERE warehouse_id = OLD.warehouse_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_manufacturing_bom_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_manufacturing_bom_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'manufacturing', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO manufacturing.bom_detail (bom_id, component_item_id, qty_per, issue_method, created_at)
           VALUES (NEW.bom_id, NEW.component_item_id, NEW.qty_per, NEW.issue_method, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE manufacturing.bom_detail
              SET bom_id = NEW.bom_id, component_item_id = NEW.component_item_id, qty_per = NEW.qty_per, issue_method = NEW.issue_method, created_at = NEW.created_at
            WHERE bom_detail_id = OLD.bom_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM manufacturing.bom_detail
            WHERE bom_detail_id = OLD.bom_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_manufacturing_manufacturing_cost_snapshot_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_manufacturing_manufacturing_cost_snapshot_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'manufacturing', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO manufacturing.manufacturing_cost_snapshot (company_id, work_order_id, total_cost, snapshot_at)
           VALUES (my_company_id(), NEW.work_order_id, NEW.total_cost, NEW.snapshot_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE manufacturing.manufacturing_cost_snapshot
              SET work_order_id = NEW.work_order_id, total_cost = NEW.total_cost, snapshot_at = NEW.snapshot_at
            WHERE manufacturing_cost_snapshot_id = OLD.manufacturing_cost_snapshot_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM manufacturing.manufacturing_cost_snapshot
            WHERE manufacturing_cost_snapshot_id = OLD.manufacturing_cost_snapshot_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_manufacturing_mps_plan_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_manufacturing_mps_plan_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'manufacturing', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO manufacturing.mps_plan (mps_run_id, item_id, plan_date, plan_qty)
           VALUES (NEW.mps_run_id, NEW.item_id, NEW.plan_date, NEW.plan_qty)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE manufacturing.mps_plan
              SET mps_run_id = NEW.mps_run_id, item_id = NEW.item_id, plan_date = NEW.plan_date, plan_qty = NEW.plan_qty
            WHERE mps_plan_id = OLD.mps_plan_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM manufacturing.mps_plan
            WHERE mps_plan_id = OLD.mps_plan_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_manufacturing_mps_run_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_manufacturing_mps_run_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'manufacturing', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO manufacturing.mps_run (company_id, run_type, run_at)
           VALUES (my_company_id(), NEW.run_type, NEW.run_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE manufacturing.mps_run
              SET run_type = NEW.run_type, run_at = NEW.run_at
            WHERE mps_run_id = OLD.mps_run_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM manufacturing.mps_run
            WHERE mps_run_id = OLD.mps_run_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_manufacturing_mrp_allocation_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_manufacturing_mrp_allocation_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'manufacturing', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO manufacturing.mrp_allocation (mrp_requirement_id, source_type, source_id, qty_allocated)
           VALUES (NEW.mrp_requirement_id, NEW.source_type, NEW.source_id, NEW.qty_allocated)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE manufacturing.mrp_allocation
              SET mrp_requirement_id = NEW.mrp_requirement_id, source_type = NEW.source_type, source_id = NEW.source_id, qty_allocated = NEW.qty_allocated
            WHERE mrp_allocation_id = OLD.mrp_allocation_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM manufacturing.mrp_allocation
            WHERE mrp_allocation_id = OLD.mrp_allocation_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_manufacturing_mrp_requirement_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_manufacturing_mrp_requirement_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'manufacturing', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO manufacturing.mrp_requirement (mrp_run_id, item_id, requirement_date, qty_required, supply_type)
           VALUES (NEW.mrp_run_id, NEW.item_id, NEW.requirement_date, NEW.qty_required, NEW.supply_type)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE manufacturing.mrp_requirement
              SET mrp_run_id = NEW.mrp_run_id, item_id = NEW.item_id, requirement_date = NEW.requirement_date, qty_required = NEW.qty_required, supply_type = NEW.supply_type
            WHERE mrp_requirement_id = OLD.mrp_requirement_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM manufacturing.mrp_requirement
            WHERE mrp_requirement_id = OLD.mrp_requirement_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_manufacturing_mrp_run_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_manufacturing_mrp_run_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'manufacturing', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO manufacturing.mrp_run (company_id, run_type, run_at)
           VALUES (my_company_id(), NEW.run_type, NEW.run_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE manufacturing.mrp_run
              SET run_type = NEW.run_type, run_at = NEW.run_at
            WHERE mrp_run_id = OLD.mrp_run_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM manufacturing.mrp_run
            WHERE mrp_run_id = OLD.mrp_run_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_manufacturing_routing_operation_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_manufacturing_routing_operation_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'manufacturing', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO manufacturing.routing_operation (routing_id, operation_no, process_id, std_time_minutes)
           VALUES (NEW.routing_id, NEW.operation_no, NEW.process_id, NEW.std_time_minutes)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE manufacturing.routing_operation
              SET routing_id = NEW.routing_id, operation_no = NEW.operation_no, process_id = NEW.process_id, std_time_minutes = NEW.std_time_minutes
            WHERE routing_operation_id = OLD.routing_operation_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM manufacturing.routing_operation
            WHERE routing_operation_id = OLD.routing_operation_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_manufacturing_work_order_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_manufacturing_work_order_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'manufacturing', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO manufacturing.work_order (company_id, wo_no, item_id, bom_id, routing_id, warehouse_id, plan_qty, plan_start_date, plan_end_date, status_code, created_at)
           VALUES (my_company_id(), NEW.wo_no, NEW.item_id, NEW.bom_id, NEW.routing_id, NEW.warehouse_id, NEW.plan_qty, NEW.plan_start_date, NEW.plan_end_date, NEW.status_code, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE manufacturing.work_order
              SET wo_no = NEW.wo_no, item_id = NEW.item_id, bom_id = NEW.bom_id, routing_id = NEW.routing_id, warehouse_id = NEW.warehouse_id, plan_qty = NEW.plan_qty, plan_start_date = NEW.plan_start_date, plan_end_date = NEW.plan_end_date, status_code = NEW.status_code, created_at = NEW.created_at
            WHERE work_order_id = OLD.work_order_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM manufacturing.work_order
            WHERE work_order_id = OLD.work_order_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_manufacturing_yield_metric_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_manufacturing_yield_metric_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'manufacturing', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO manufacturing.yield_metric (company_id, process_id, metric_date, yield_rate)
           VALUES (my_company_id(), NEW.process_id, NEW.metric_date, NEW.yield_rate)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE manufacturing.yield_metric
              SET process_id = NEW.process_id, metric_date = NEW.metric_date, yield_rate = NEW.yield_rate
            WHERE yield_metric_id = OLD.yield_metric_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM manufacturing.yield_metric
            WHERE yield_metric_id = OLD.yield_metric_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_purchase_invoice_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_purchase_invoice_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.purchase_invoice_detail (purchase_invoice_id, line_no, item_id, qty, unit_price, amount, receipt_detail_id, purchase_order_detail_id)
           VALUES (NEW.purchase_invoice_id, NEW.line_no, NEW.item_id, NEW.qty, NEW.unit_price, NEW.amount, NEW.receipt_detail_id, NEW.purchase_order_detail_id)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.purchase_invoice_detail
              SET purchase_invoice_id = NEW.purchase_invoice_id, line_no = NEW.line_no, item_id = NEW.item_id, qty = NEW.qty, unit_price = NEW.unit_price, amount = NEW.amount, receipt_detail_id = NEW.receipt_detail_id, purchase_order_detail_id = NEW.purchase_order_detail_id
            WHERE purchase_invoice_detail_id = OLD.purchase_invoice_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.purchase_invoice_detail
            WHERE purchase_invoice_detail_id = OLD.purchase_invoice_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_purchase_invoice_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_purchase_invoice_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.purchase_invoice (company_id, supplier_id, invoice_no, invoice_date, status_code, total_amount, created_at)
           VALUES (my_company_id(), NEW.supplier_id, NEW.invoice_no, NEW.invoice_date, NEW.status_code, NEW.total_amount, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.purchase_invoice
              SET supplier_id = NEW.supplier_id, invoice_no = NEW.invoice_no, invoice_date = NEW.invoice_date, status_code = NEW.status_code, total_amount = NEW.total_amount, created_at = NEW.created_at
            WHERE purchase_invoice_id = OLD.purchase_invoice_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.purchase_invoice
            WHERE purchase_invoice_id = OLD.purchase_invoice_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_purchase_order_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_purchase_order_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.purchase_order_detail (purchase_order_id, line_no, item_id, qty, unit_price, amount, promised_date)
           VALUES (NEW.purchase_order_id, NEW.line_no, NEW.item_id, NEW.qty, NEW.unit_price, NEW.amount, NEW.promised_date)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.purchase_order_detail
              SET purchase_order_id = NEW.purchase_order_id, line_no = NEW.line_no, item_id = NEW.item_id, qty = NEW.qty, unit_price = NEW.unit_price, amount = NEW.amount, promised_date = NEW.promised_date
            WHERE purchase_order_detail_id = OLD.purchase_order_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.purchase_order_detail
            WHERE purchase_order_detail_id = OLD.purchase_order_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_purchase_quotation_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_purchase_quotation_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.purchase_quotation_detail (purchase_quotation_id, line_no, item_id, qty, unit_price, amount)
           VALUES (NEW.purchase_quotation_id, NEW.line_no, NEW.item_id, NEW.qty, NEW.unit_price, NEW.amount)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.purchase_quotation_detail
              SET purchase_quotation_id = NEW.purchase_quotation_id, line_no = NEW.line_no, item_id = NEW.item_id, qty = NEW.qty, unit_price = NEW.unit_price, amount = NEW.amount
            WHERE purchase_quotation_detail_id = OLD.purchase_quotation_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.purchase_quotation_detail
            WHERE purchase_quotation_detail_id = OLD.purchase_quotation_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_purchase_quotation_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_purchase_quotation_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.purchase_quotation (company_id, supplier_id, quotation_no, quotation_date, status_code, created_at)
           VALUES (my_company_id(), NEW.supplier_id, NEW.quotation_no, NEW.quotation_date, NEW.status_code, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.purchase_quotation
              SET supplier_id = NEW.supplier_id, quotation_no = NEW.quotation_no, quotation_date = NEW.quotation_date, status_code = NEW.status_code, created_at = NEW.created_at
            WHERE purchase_quotation_id = OLD.purchase_quotation_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.purchase_quotation
            WHERE purchase_quotation_id = OLD.purchase_quotation_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_purchase_requisition_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_purchase_requisition_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.purchase_requisition_detail (purchase_requisition_id, line_no, item_id, qty, required_date)
           VALUES (NEW.purchase_requisition_id, NEW.line_no, NEW.item_id, NEW.qty, NEW.required_date)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.purchase_requisition_detail
              SET purchase_requisition_id = NEW.purchase_requisition_id, line_no = NEW.line_no, item_id = NEW.item_id, qty = NEW.qty, required_date = NEW.required_date
            WHERE purchase_requisition_detail_id = OLD.purchase_requisition_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.purchase_requisition_detail
            WHERE purchase_requisition_detail_id = OLD.purchase_requisition_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_purchase_requisition_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_purchase_requisition_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.purchase_requisition (company_id, requisition_no, requester_id, requisition_date, status_code, created_at)
           VALUES (my_company_id(), NEW.requisition_no, NEW.requester_id, NEW.requisition_date, NEW.status_code, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.purchase_requisition
              SET requisition_no = NEW.requisition_no, requester_id = NEW.requester_id, requisition_date = NEW.requisition_date, status_code = NEW.status_code, created_at = NEW.created_at
            WHERE purchase_requisition_id = OLD.purchase_requisition_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.purchase_requisition
            WHERE purchase_requisition_id = OLD.purchase_requisition_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_purchase_three_way_match_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_purchase_three_way_match_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.purchase_three_way_match (company_id, purchase_order_detail_id, receipt_detail_id, purchase_invoice_detail_id, matched_at, status_code)
           VALUES (my_company_id(), NEW.purchase_order_detail_id, NEW.receipt_detail_id, NEW.purchase_invoice_detail_id, NEW.matched_at, NEW.status_code)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.purchase_three_way_match
              SET purchase_order_detail_id = NEW.purchase_order_detail_id, receipt_detail_id = NEW.receipt_detail_id, purchase_invoice_detail_id = NEW.purchase_invoice_detail_id, matched_at = NEW.matched_at, status_code = NEW.status_code
            WHERE purchase_three_way_match_id = OLD.purchase_three_way_match_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.purchase_three_way_match
            WHERE purchase_three_way_match_id = OLD.purchase_three_way_match_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_supplier_address_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_supplier_address_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.supplier_address (supplier_id, address_type, postal_code, country_code, prefecture, city, address_line1, address_line2, is_default, created_at)
           VALUES (NEW.supplier_id, NEW.address_type, NEW.postal_code, NEW.country_code, NEW.prefecture, NEW.city, NEW.address_line1, NEW.address_line2, NEW.is_default, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.supplier_address
              SET supplier_id = NEW.supplier_id, address_type = NEW.address_type, postal_code = NEW.postal_code, country_code = NEW.country_code, prefecture = NEW.prefecture, city = NEW.city, address_line1 = NEW.address_line1, address_line2 = NEW.address_line2, is_default = NEW.is_default, created_at = NEW.created_at
            WHERE supplier_address_id = OLD.supplier_address_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.supplier_address
            WHERE supplier_address_id = OLD.supplier_address_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_supplier_contact_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_supplier_contact_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.supplier_contact (supplier_id, contact_name, department_name, email, phone, mobile, is_primary, is_active, created_at)
           VALUES (NEW.supplier_id, NEW.contact_name, NEW.department_name, NEW.email, NEW.phone, NEW.mobile, NEW.is_primary, NEW.is_active, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.supplier_contact
              SET supplier_id = NEW.supplier_id, contact_name = NEW.contact_name, department_name = NEW.department_name, email = NEW.email, phone = NEW.phone, mobile = NEW.mobile, is_primary = NEW.is_primary, is_active = NEW.is_active, created_at = NEW.created_at
            WHERE supplier_contact_id = OLD.supplier_contact_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.supplier_contact
            WHERE supplier_contact_id = OLD.supplier_contact_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_supplier_item_price_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_supplier_item_price_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.supplier_item_price (company_id, supplier_id, item_id, price, currency_code, valid_from, valid_to, is_active)
           VALUES (my_company_id(), NEW.supplier_id, NEW.item_id, NEW.price, NEW.currency_code, NEW.valid_from, NEW.valid_to, NEW.is_active)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.supplier_item_price
              SET supplier_id = NEW.supplier_id, item_id = NEW.item_id, price = NEW.price, currency_code = NEW.currency_code, valid_from = NEW.valid_from, valid_to = NEW.valid_to, is_active = NEW.is_active
            WHERE supplier_item_price_id = OLD.supplier_item_price_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.supplier_item_price
            WHERE supplier_item_price_id = OLD.supplier_item_price_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_purchase_supplier_payment_term_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_purchase_supplier_payment_term_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'purchase', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO purchase.supplier_payment_term (supplier_id, payment_term_id, payment_method_code, valid_from, valid_to, is_active)
           VALUES (NEW.supplier_id, NEW.payment_term_id, NEW.payment_method_code, NEW.valid_from, NEW.valid_to, NEW.is_active)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE purchase.supplier_payment_term
              SET supplier_id = NEW.supplier_id, payment_term_id = NEW.payment_term_id, payment_method_code = NEW.payment_method_code, valid_from = NEW.valid_from, valid_to = NEW.valid_to, is_active = NEW.is_active
            WHERE supplier_payment_term_id = OLD.supplier_payment_term_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM purchase.supplier_payment_term
            WHERE supplier_payment_term_id = OLD.supplier_payment_term_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_billing_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_billing_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.billing_detail (billing_id, line_no, item_id, qty, unit_price, amount, tax_category_code)
           VALUES (NEW.billing_id, NEW.line_no, NEW.item_id, NEW.qty, NEW.unit_price, NEW.amount, NEW.tax_category_code)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.billing_detail
              SET billing_id = NEW.billing_id, line_no = NEW.line_no, item_id = NEW.item_id, qty = NEW.qty, unit_price = NEW.unit_price, amount = NEW.amount, tax_category_code = NEW.tax_category_code
            WHERE billing_detail_id = OLD.billing_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.billing_detail
            WHERE billing_detail_id = OLD.billing_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_customer_address_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_customer_address_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.customer_address (customer_id, address_type, postal_code, country_code, prefecture, city, address_line1, address_line2, is_default, created_at)
           VALUES (NEW.customer_id, NEW.address_type, NEW.postal_code, NEW.country_code, NEW.prefecture, NEW.city, NEW.address_line1, NEW.address_line2, NEW.is_default, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.customer_address
              SET customer_id = NEW.customer_id, address_type = NEW.address_type, postal_code = NEW.postal_code, country_code = NEW.country_code, prefecture = NEW.prefecture, city = NEW.city, address_line1 = NEW.address_line1, address_line2 = NEW.address_line2, is_default = NEW.is_default, created_at = NEW.created_at
            WHERE customer_address_id = OLD.customer_address_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.customer_address
            WHERE customer_address_id = OLD.customer_address_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_customer_contact_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_customer_contact_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.customer_contact (customer_id, contact_name, department_name, email, phone, mobile, is_primary, is_active, created_at)
           VALUES (NEW.customer_id, NEW.contact_name, NEW.department_name, NEW.email, NEW.phone, NEW.mobile, NEW.is_primary, NEW.is_active, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.customer_contact
              SET customer_id = NEW.customer_id, contact_name = NEW.contact_name, department_name = NEW.department_name, email = NEW.email, phone = NEW.phone, mobile = NEW.mobile, is_primary = NEW.is_primary, is_active = NEW.is_active, created_at = NEW.created_at
            WHERE customer_contact_id = OLD.customer_contact_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.customer_contact
            WHERE customer_contact_id = OLD.customer_contact_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_customer_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_customer_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.customer (company_id, customer_code, customer_name, billing_address, shipping_address, payment_term, credit_limit, is_active, created_at)
           VALUES (my_company_id(), NEW.customer_code, NEW.customer_name, NEW.billing_address, NEW.shipping_address, NEW.payment_term, NEW.credit_limit, NEW.is_active, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.customer
              SET customer_code = NEW.customer_code, customer_name = NEW.customer_name, billing_address = NEW.billing_address, shipping_address = NEW.shipping_address, payment_term = NEW.payment_term, credit_limit = NEW.credit_limit, is_active = NEW.is_active, created_at = NEW.created_at
            WHERE customer_id = OLD.customer_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.customer
            WHERE customer_id = OLD.customer_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_customer_payment_term_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_customer_payment_term_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.customer_payment_term (customer_id, payment_term_id, payment_method_code, valid_from, valid_to, is_active)
           VALUES (NEW.customer_id, NEW.payment_term_id, NEW.payment_method_code, NEW.valid_from, NEW.valid_to, NEW.is_active)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.customer_payment_term
              SET customer_id = NEW.customer_id, payment_term_id = NEW.payment_term_id, payment_method_code = NEW.payment_method_code, valid_from = NEW.valid_from, valid_to = NEW.valid_to, is_active = NEW.is_active
            WHERE customer_payment_term_id = OLD.customer_payment_term_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.customer_payment_term
            WHERE customer_payment_term_id = OLD.customer_payment_term_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_invoice_pdf_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_invoice_pdf_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.invoice_pdf (company_id, billing_id, file_path, created_at)
           VALUES (my_company_id(), NEW.billing_id, NEW.file_path, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.invoice_pdf
              SET billing_id = NEW.billing_id, file_path = NEW.file_path, created_at = NEW.created_at
            WHERE invoice_pdf_id = OLD.invoice_pdf_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.invoice_pdf
            WHERE invoice_pdf_id = OLD.invoice_pdf_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_item_category_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_item_category_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.item_category (company_id, category_code, category_name, parent_category_id, category_level)
           VALUES (my_company_id(), NEW.category_code, NEW.category_name, NEW.parent_category_id, NEW.category_level)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.item_category
              SET category_code = NEW.category_code, category_name = NEW.category_name, parent_category_id = NEW.parent_category_id, category_level = NEW.category_level
            WHERE item_category_id = OLD.item_category_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.item_category
            WHERE item_category_id = OLD.item_category_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_item_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_item_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.item (company_id, item_code, item_name, item_category_id, uom, is_active, created_at)
           VALUES (my_company_id(), NEW.item_code, NEW.item_name, NEW.item_category_id, NEW.uom, NEW.is_active, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.item
              SET item_code = NEW.item_code, item_name = NEW.item_name, item_category_id = NEW.item_category_id, uom = NEW.uom, is_active = NEW.is_active, created_at = NEW.created_at
            WHERE item_id = OLD.item_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.item
            WHERE item_id = OLD.item_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_item_uom_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_item_uom_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.item_uom (item_id, uom_code, usage_type, is_primary)
           VALUES (NEW.item_id, NEW.uom_code, NEW.usage_type, NEW.is_primary)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.item_uom
              SET item_id = NEW.item_id, uom_code = NEW.uom_code, usage_type = NEW.usage_type, is_primary = NEW.is_primary
            WHERE item_uom_id = OLD.item_uom_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.item_uom
            WHERE item_uom_id = OLD.item_uom_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_order_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_order_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.order_detail (order_id, line_no, item_id, qty, unit_price, amount, requested_ship_date)
           VALUES (NEW.order_id, NEW.line_no, NEW.item_id, NEW.qty, NEW.unit_price, NEW.amount, NEW.requested_ship_date)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.order_detail
              SET order_id = NEW.order_id, line_no = NEW.line_no, item_id = NEW.item_id, qty = NEW.qty, unit_price = NEW.unit_price, amount = NEW.amount, requested_ship_date = NEW.requested_ship_date
            WHERE order_detail_id = OLD.order_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.order_detail
            WHERE order_detail_id = OLD.order_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_return_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_return_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.return_detail (return_id, line_no, item_id, qty, reason_code)
           VALUES (NEW.return_id, NEW.line_no, NEW.item_id, NEW.qty, NEW.reason_code)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.return_detail
              SET return_id = NEW.return_id, line_no = NEW.line_no, item_id = NEW.item_id, qty = NEW.qty, reason_code = NEW.reason_code
            WHERE return_detail_id = OLD.return_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.return_detail
            WHERE return_detail_id = OLD.return_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_sales_quotation_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_sales_quotation_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.sales_quotation_detail (sales_quotation_id, line_no, item_id, qty, unit_price, amount, tax_category_code)
           VALUES (NEW.sales_quotation_id, NEW.line_no, NEW.item_id, NEW.qty, NEW.unit_price, NEW.amount, NEW.tax_category_code)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.sales_quotation_detail
              SET sales_quotation_id = NEW.sales_quotation_id, line_no = NEW.line_no, item_id = NEW.item_id, qty = NEW.qty, unit_price = NEW.unit_price, amount = NEW.amount, tax_category_code = NEW.tax_category_code
            WHERE sales_quotation_detail_id = OLD.sales_quotation_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.sales_quotation_detail
            WHERE sales_quotation_detail_id = OLD.sales_quotation_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_sales_quotation_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_sales_quotation_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.sales_quotation (company_id, quotation_no, customer_id, quotation_date, status_code, created_by, created_at)
           VALUES (my_company_id(), NEW.quotation_no, NEW.customer_id, NEW.quotation_date, NEW.status_code, NEW.created_by, NEW.created_at)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.sales_quotation
              SET quotation_no = NEW.quotation_no, customer_id = NEW.customer_id, quotation_date = NEW.quotation_date, status_code = NEW.status_code, created_by = NEW.created_by, created_at = NEW.created_at
            WHERE sales_quotation_id = OLD.sales_quotation_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.sales_quotation
            WHERE sales_quotation_id = OLD.sales_quotation_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: trg_v_sales_shipping_detail_iud(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trg_v_sales_shipping_detail_iud() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'sales', 'public'
    AS $$
       BEGIN
         IF TG_OP = 'INSERT' THEN
           INSERT INTO sales.shipping_detail (shipping_id, order_detail_id, line_no, item_id, qty)
           VALUES (NEW.shipping_id, NEW.order_detail_id, NEW.line_no, NEW.item_id, NEW.qty)
           RETURNING * INTO NEW;
           RETURN NEW;

         ELSIF TG_OP = 'UPDATE' THEN
           UPDATE sales.shipping_detail
              SET shipping_id = NEW.shipping_id, order_detail_id = NEW.order_detail_id, line_no = NEW.line_no, item_id = NEW.item_id, qty = NEW.qty
            WHERE shipping_detail_id = OLD.shipping_detail_id;
           RETURN NEW;

         ELSIF TG_OP = 'DELETE' THEN
           DELETE FROM sales.shipping_detail
            WHERE shipping_detail_id = OLD.shipping_detail_id;
           RETURN OLD;
         END IF;

         RETURN NULL;
       END;
       $$;


--
-- Name: apply_rls(jsonb, integer); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.apply_rls(wal jsonb, max_record_bytes integer DEFAULT (1024 * 1024)) RETURNS SETOF realtime.wal_rls
    LANGUAGE plpgsql
    AS $$
declare
-- Regclass of the table e.g. public.notes
entity_ regclass = (quote_ident(wal ->> 'schema') || '.' || quote_ident(wal ->> 'table'))::regclass;

-- I, U, D, T: insert, update ...
action realtime.action = (
    case wal ->> 'action'
        when 'I' then 'INSERT'
        when 'U' then 'UPDATE'
        when 'D' then 'DELETE'
        else 'ERROR'
    end
);

-- Is row level security enabled for the table
is_rls_enabled bool = relrowsecurity from pg_class where oid = entity_;

subscriptions realtime.subscription[] = array_agg(subs)
    from
        realtime.subscription subs
    where
        subs.entity = entity_;

-- Subscription vars
roles regrole[] = array_agg(distinct us.claims_role::text)
    from
        unnest(subscriptions) us;

working_role regrole;
claimed_role regrole;
claims jsonb;

subscription_id uuid;
subscription_has_access bool;
visible_to_subscription_ids uuid[] = '{}';

-- structured info for wal's columns
columns realtime.wal_column[];
-- previous identity values for update/delete
old_columns realtime.wal_column[];

error_record_exceeds_max_size boolean = octet_length(wal::text) > max_record_bytes;

-- Primary jsonb output for record
output jsonb;

begin
perform set_config('role', null, true);

columns =
    array_agg(
        (
            x->>'name',
            x->>'type',
            x->>'typeoid',
            realtime.cast(
                (x->'value') #>> '{}',
                coalesce(
                    (x->>'typeoid')::regtype, -- null when wal2json version <= 2.4
                    (x->>'type')::regtype
                )
            ),
            (pks ->> 'name') is not null,
            true
        )::realtime.wal_column
    )
    from
        jsonb_array_elements(wal -> 'columns') x
        left join jsonb_array_elements(wal -> 'pk') pks
            on (x ->> 'name') = (pks ->> 'name');

old_columns =
    array_agg(
        (
            x->>'name',
            x->>'type',
            x->>'typeoid',
            realtime.cast(
                (x->'value') #>> '{}',
                coalesce(
                    (x->>'typeoid')::regtype, -- null when wal2json version <= 2.4
                    (x->>'type')::regtype
                )
            ),
            (pks ->> 'name') is not null,
            true
        )::realtime.wal_column
    )
    from
        jsonb_array_elements(wal -> 'identity') x
        left join jsonb_array_elements(wal -> 'pk') pks
            on (x ->> 'name') = (pks ->> 'name');

for working_role in select * from unnest(roles) loop

    -- Update `is_selectable` for columns and old_columns
    columns =
        array_agg(
            (
                c.name,
                c.type_name,
                c.type_oid,
                c.value,
                c.is_pkey,
                pg_catalog.has_column_privilege(working_role, entity_, c.name, 'SELECT')
            )::realtime.wal_column
        )
        from
            unnest(columns) c;

    old_columns =
            array_agg(
                (
                    c.name,
                    c.type_name,
                    c.type_oid,
                    c.value,
                    c.is_pkey,
                    pg_catalog.has_column_privilege(working_role, entity_, c.name, 'SELECT')
                )::realtime.wal_column
            )
            from
                unnest(old_columns) c;

    if action <> 'DELETE' and count(1) = 0 from unnest(columns) c where c.is_pkey then
        return next (
            jsonb_build_object(
                'schema', wal ->> 'schema',
                'table', wal ->> 'table',
                'type', action
            ),
            is_rls_enabled,
            -- subscriptions is already filtered by entity
            (select array_agg(s.subscription_id) from unnest(subscriptions) as s where claims_role = working_role),
            array['Error 400: Bad Request, no primary key']
        )::realtime.wal_rls;

    -- The claims role does not have SELECT permission to the primary key of entity
    elsif action <> 'DELETE' and sum(c.is_selectable::int) <> count(1) from unnest(columns) c where c.is_pkey then
        return next (
            jsonb_build_object(
                'schema', wal ->> 'schema',
                'table', wal ->> 'table',
                'type', action
            ),
            is_rls_enabled,
            (select array_agg(s.subscription_id) from unnest(subscriptions) as s where claims_role = working_role),
            array['Error 401: Unauthorized']
        )::realtime.wal_rls;

    else
        output = jsonb_build_object(
            'schema', wal ->> 'schema',
            'table', wal ->> 'table',
            'type', action,
            'commit_timestamp', to_char(
                ((wal ->> 'timestamp')::timestamptz at time zone 'utc'),
                'YYYY-MM-DD"T"HH24:MI:SS.MS"Z"'
            ),
            'columns', (
                select
                    jsonb_agg(
                        jsonb_build_object(
                            'name', pa.attname,
                            'type', pt.typname
                        )
                        order by pa.attnum asc
                    )
                from
                    pg_attribute pa
                    join pg_type pt
                        on pa.atttypid = pt.oid
                where
                    attrelid = entity_
                    and attnum > 0
                    and pg_catalog.has_column_privilege(working_role, entity_, pa.attname, 'SELECT')
            )
        )
        -- Add "record" key for insert and update
        || case
            when action in ('INSERT', 'UPDATE') then
                jsonb_build_object(
                    'record',
                    (
                        select
                            jsonb_object_agg(
                                -- if unchanged toast, get column name and value from old record
                                coalesce((c).name, (oc).name),
                                case
                                    when (c).name is null then (oc).value
                                    else (c).value
                                end
                            )
                        from
                            unnest(columns) c
                            full outer join unnest(old_columns) oc
                                on (c).name = (oc).name
                        where
                            coalesce((c).is_selectable, (oc).is_selectable)
                            and ( not error_record_exceeds_max_size or (octet_length((c).value::text) <= 64))
                    )
                )
            else '{}'::jsonb
        end
        -- Add "old_record" key for update and delete
        || case
            when action = 'UPDATE' then
                jsonb_build_object(
                        'old_record',
                        (
                            select jsonb_object_agg((c).name, (c).value)
                            from unnest(old_columns) c
                            where
                                (c).is_selectable
                                and ( not error_record_exceeds_max_size or (octet_length((c).value::text) <= 64))
                        )
                    )
            when action = 'DELETE' then
                jsonb_build_object(
                    'old_record',
                    (
                        select jsonb_object_agg((c).name, (c).value)
                        from unnest(old_columns) c
                        where
                            (c).is_selectable
                            and ( not error_record_exceeds_max_size or (octet_length((c).value::text) <= 64))
                            and ( not is_rls_enabled or (c).is_pkey ) -- if RLS enabled, we can't secure deletes so filter to pkey
                    )
                )
            else '{}'::jsonb
        end;

        -- Create the prepared statement
        if is_rls_enabled and action <> 'DELETE' then
            if (select 1 from pg_prepared_statements where name = 'walrus_rls_stmt' limit 1) > 0 then
                deallocate walrus_rls_stmt;
            end if;
            execute realtime.build_prepared_statement_sql('walrus_rls_stmt', entity_, columns);
        end if;

        visible_to_subscription_ids = '{}';

        for subscription_id, claims in (
                select
                    subs.subscription_id,
                    subs.claims
                from
                    unnest(subscriptions) subs
                where
                    subs.entity = entity_
                    and subs.claims_role = working_role
                    and (
                        realtime.is_visible_through_filters(columns, subs.filters)
                        or (
                          action = 'DELETE'
                          and realtime.is_visible_through_filters(old_columns, subs.filters)
                        )
                    )
        ) loop

            if not is_rls_enabled or action = 'DELETE' then
                visible_to_subscription_ids = visible_to_subscription_ids || subscription_id;
            else
                -- Check if RLS allows the role to see the record
                perform
                    -- Trim leading and trailing quotes from working_role because set_config
                    -- doesn't recognize the role as valid if they are included
                    set_config('role', trim(both '"' from working_role::text), true),
                    set_config('request.jwt.claims', claims::text, true);

                execute 'execute walrus_rls_stmt' into subscription_has_access;

                if subscription_has_access then
                    visible_to_subscription_ids = visible_to_subscription_ids || subscription_id;
                end if;
            end if;
        end loop;

        perform set_config('role', null, true);

        return next (
            output,
            is_rls_enabled,
            visible_to_subscription_ids,
            case
                when error_record_exceeds_max_size then array['Error 413: Payload Too Large']
                else '{}'
            end
        )::realtime.wal_rls;

    end if;
end loop;

perform set_config('role', null, true);
end;
$$;


--
-- Name: broadcast_changes(text, text, text, text, text, record, record, text); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.broadcast_changes(topic_name text, event_name text, operation text, table_name text, table_schema text, new record, old record, level text DEFAULT 'ROW'::text) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
    -- Declare a variable to hold the JSONB representation of the row
    row_data jsonb := '{}'::jsonb;
BEGIN
    IF level = 'STATEMENT' THEN
        RAISE EXCEPTION 'function can only be triggered for each row, not for each statement';
    END IF;
    -- Check the operation type and handle accordingly
    IF operation = 'INSERT' OR operation = 'UPDATE' OR operation = 'DELETE' THEN
        row_data := jsonb_build_object('old_record', OLD, 'record', NEW, 'operation', operation, 'table', table_name, 'schema', table_schema);
        PERFORM realtime.send (row_data, event_name, topic_name);
    ELSE
        RAISE EXCEPTION 'Unexpected operation type: %', operation;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Failed to process the row: %', SQLERRM;
END;

$$;


--
-- Name: build_prepared_statement_sql(text, regclass, realtime.wal_column[]); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.build_prepared_statement_sql(prepared_statement_name text, entity regclass, columns realtime.wal_column[]) RETURNS text
    LANGUAGE sql
    AS $$
      /*
      Builds a sql string that, if executed, creates a prepared statement to
      tests retrive a row from *entity* by its primary key columns.
      Example
          select realtime.build_prepared_statement_sql('public.notes', '{"id"}'::text[], '{"bigint"}'::text[])
      */
          select
      'prepare ' || prepared_statement_name || ' as
          select
              exists(
                  select
                      1
                  from
                      ' || entity || '
                  where
                      ' || string_agg(quote_ident(pkc.name) || '=' || quote_nullable(pkc.value #>> '{}') , ' and ') || '
              )'
          from
              unnest(columns) pkc
          where
              pkc.is_pkey
          group by
              entity
      $$;


--
-- Name: cast(text, regtype); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime."cast"(val text, type_ regtype) RETURNS jsonb
    LANGUAGE plpgsql IMMUTABLE
    AS $$
    declare
      res jsonb;
    begin
      execute format('select to_jsonb(%L::'|| type_::text || ')', val)  into res;
      return res;
    end
    $$;


--
-- Name: check_equality_op(realtime.equality_op, regtype, text, text); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.check_equality_op(op realtime.equality_op, type_ regtype, val_1 text, val_2 text) RETURNS boolean
    LANGUAGE plpgsql IMMUTABLE
    AS $$
      /*
      Casts *val_1* and *val_2* as type *type_* and check the *op* condition for truthiness
      */
      declare
          op_symbol text = (
              case
                  when op = 'eq' then '='
                  when op = 'neq' then '!='
                  when op = 'lt' then '<'
                  when op = 'lte' then '<='
                  when op = 'gt' then '>'
                  when op = 'gte' then '>='
                  when op = 'in' then '= any'
                  else 'UNKNOWN OP'
              end
          );
          res boolean;
      begin
          execute format(
              'select %L::'|| type_::text || ' ' || op_symbol
              || ' ( %L::'
              || (
                  case
                      when op = 'in' then type_::text || '[]'
                      else type_::text end
              )
              || ')', val_1, val_2) into res;
          return res;
      end;
      $$;


--
-- Name: is_visible_through_filters(realtime.wal_column[], realtime.user_defined_filter[]); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.is_visible_through_filters(columns realtime.wal_column[], filters realtime.user_defined_filter[]) RETURNS boolean
    LANGUAGE sql IMMUTABLE
    AS $_$
    /*
    Should the record be visible (true) or filtered out (false) after *filters* are applied
    */
        select
            -- Default to allowed when no filters present
            $2 is null -- no filters. this should not happen because subscriptions has a default
            or array_length($2, 1) is null -- array length of an empty array is null
            or bool_and(
                coalesce(
                    realtime.check_equality_op(
                        op:=f.op,
                        type_:=coalesce(
                            col.type_oid::regtype, -- null when wal2json version <= 2.4
                            col.type_name::regtype
                        ),
                        -- cast jsonb to text
                        val_1:=col.value #>> '{}',
                        val_2:=f.value
                    ),
                    false -- if null, filter does not match
                )
            )
        from
            unnest(filters) f
            join unnest(columns) col
                on f.column_name = col.name;
    $_$;


--
-- Name: list_changes(name, name, integer, integer); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.list_changes(publication name, slot_name name, max_changes integer, max_record_bytes integer) RETURNS SETOF realtime.wal_rls
    LANGUAGE sql
    SET log_min_messages TO 'fatal'
    AS $$
      with pub as (
        select
          concat_ws(
            ',',
            case when bool_or(pubinsert) then 'insert' else null end,
            case when bool_or(pubupdate) then 'update' else null end,
            case when bool_or(pubdelete) then 'delete' else null end
          ) as w2j_actions,
          coalesce(
            string_agg(
              realtime.quote_wal2json(format('%I.%I', schemaname, tablename)::regclass),
              ','
            ) filter (where ppt.tablename is not null and ppt.tablename not like '% %'),
            ''
          ) w2j_add_tables
        from
          pg_publication pp
          left join pg_publication_tables ppt
            on pp.pubname = ppt.pubname
        where
          pp.pubname = publication
        group by
          pp.pubname
        limit 1
      ),
      w2j as (
        select
          x.*, pub.w2j_add_tables
        from
          pub,
          pg_logical_slot_get_changes(
            slot_name, null, max_changes,
            'include-pk', 'true',
            'include-transaction', 'false',
            'include-timestamp', 'true',
            'include-type-oids', 'true',
            'format-version', '2',
            'actions', pub.w2j_actions,
            'add-tables', pub.w2j_add_tables
          ) x
      )
      select
        xyz.wal,
        xyz.is_rls_enabled,
        xyz.subscription_ids,
        xyz.errors
      from
        w2j,
        realtime.apply_rls(
          wal := w2j.data::jsonb,
          max_record_bytes := max_record_bytes
        ) xyz(wal, is_rls_enabled, subscription_ids, errors)
      where
        w2j.w2j_add_tables <> ''
        and xyz.subscription_ids[1] is not null
    $$;


--
-- Name: quote_wal2json(regclass); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.quote_wal2json(entity regclass) RETURNS text
    LANGUAGE sql IMMUTABLE STRICT
    AS $$
      select
        (
          select string_agg('' || ch,'')
          from unnest(string_to_array(nsp.nspname::text, null)) with ordinality x(ch, idx)
          where
            not (x.idx = 1 and x.ch = '"')
            and not (
              x.idx = array_length(string_to_array(nsp.nspname::text, null), 1)
              and x.ch = '"'
            )
        )
        || '.'
        || (
          select string_agg('' || ch,'')
          from unnest(string_to_array(pc.relname::text, null)) with ordinality x(ch, idx)
          where
            not (x.idx = 1 and x.ch = '"')
            and not (
              x.idx = array_length(string_to_array(nsp.nspname::text, null), 1)
              and x.ch = '"'
            )
          )
      from
        pg_class pc
        join pg_namespace nsp
          on pc.relnamespace = nsp.oid
      where
        pc.oid = entity
    $$;


--
-- Name: send(jsonb, text, text, boolean); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.send(payload jsonb, event text, topic text, private boolean DEFAULT true) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
  generated_id uuid;
  final_payload jsonb;
BEGIN
  BEGIN
    -- Generate a new UUID for the id
    generated_id := gen_random_uuid();

    -- Check if payload has an 'id' key, if not, add the generated UUID
    IF payload ? 'id' THEN
      final_payload := payload;
    ELSE
      final_payload := jsonb_set(payload, '{id}', to_jsonb(generated_id));
    END IF;

    -- Set the topic configuration
    EXECUTE format('SET LOCAL realtime.topic TO %L', topic);

    -- Attempt to insert the message
    INSERT INTO realtime.messages (id, payload, event, topic, private, extension)
    VALUES (generated_id, final_payload, event, topic, private, 'broadcast');
  EXCEPTION
    WHEN OTHERS THEN
      -- Capture and notify the error
      RAISE WARNING 'ErrorSendingBroadcastMessage: %', SQLERRM;
  END;
END;
$$;


--
-- Name: subscription_check_filters(); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.subscription_check_filters() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
    /*
    Validates that the user defined filters for a subscription:
    - refer to valid columns that the claimed role may access
    - values are coercable to the correct column type
    */
    declare
        col_names text[] = coalesce(
                array_agg(c.column_name order by c.ordinal_position),
                '{}'::text[]
            )
            from
                information_schema.columns c
            where
                format('%I.%I', c.table_schema, c.table_name)::regclass = new.entity
                and pg_catalog.has_column_privilege(
                    (new.claims ->> 'role'),
                    format('%I.%I', c.table_schema, c.table_name)::regclass,
                    c.column_name,
                    'SELECT'
                );
        filter realtime.user_defined_filter;
        col_type regtype;

        in_val jsonb;
    begin
        for filter in select * from unnest(new.filters) loop
            -- Filtered column is valid
            if not filter.column_name = any(col_names) then
                raise exception 'invalid column for filter %', filter.column_name;
            end if;

            -- Type is sanitized and safe for string interpolation
            col_type = (
                select atttypid::regtype
                from pg_catalog.pg_attribute
                where attrelid = new.entity
                      and attname = filter.column_name
            );
            if col_type is null then
                raise exception 'failed to lookup type for column %', filter.column_name;
            end if;

            -- Set maximum number of entries for in filter
            if filter.op = 'in'::realtime.equality_op then
                in_val = realtime.cast(filter.value, (col_type::text || '[]')::regtype);
                if coalesce(jsonb_array_length(in_val), 0) > 100 then
                    raise exception 'too many values for `in` filter. Maximum 100';
                end if;
            else
                -- raises an exception if value is not coercable to type
                perform realtime.cast(filter.value, col_type);
            end if;

        end loop;

        -- Apply consistent order to filters so the unique constraint on
        -- (subscription_id, entity, filters) can't be tricked by a different filter order
        new.filters = coalesce(
            array_agg(f order by f.column_name, f.op, f.value),
            '{}'
        ) from unnest(new.filters) f;

        return new;
    end;
    $$;


--
-- Name: to_regrole(text); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.to_regrole(role_name text) RETURNS regrole
    LANGUAGE sql IMMUTABLE
    AS $$ select role_name::regrole $$;


--
-- Name: topic(); Type: FUNCTION; Schema: realtime; Owner: -
--

CREATE FUNCTION realtime.topic() RETURNS text
    LANGUAGE sql STABLE
    AS $$
select nullif(current_setting('realtime.topic', true), '')::text;
$$;


--
-- Name: request_order_approval(uuid, bigint, text, text, text); Type: FUNCTION; Schema: sales; Owner: -
--

CREATE FUNCTION sales.request_order_approval(p_company_id uuid, p_order_id bigint, p_order_no text, p_policy_id text, p_reason text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  update sales.order_header
     set status_code = 'pending_approval'
   where order_id = p_order_id;

  insert into approval_request (
    company_id,
    domain,
    entity_type,
    entity_id,
    order_id,
    reason,
    status
  ) values (
    p_company_id,
    'sales',
    'order',
    p_order_no,
    p_order_id,
    p_reason,
    'pending'
  );
end;
$$;


--
-- Name: request_order_approval_safe(uuid, bigint, text, text, text); Type: FUNCTION; Schema: sales; Owner: -
--

CREATE FUNCTION sales.request_order_approval_safe(p_company_id uuid, p_order_id bigint, p_order_no text, p_policy_id text, p_reason text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  if exists (
    select 1 from approval_request
     where domain='sales'
       and entity_type='order'
       and order_id = p_order_id
       and status='pending'
  ) then
    return;
  end if;

  update sales.order_header
     set status_code = 'pending_approval'
   where order_id = p_order_id;

  insert into approval_request (
    company_id, domain, entity_type, entity_id,
    order_id, reason, status
  ) values (
    p_company_id, 'sales', 'order', p_order_no,
    p_order_id, p_reason, 'pending'
  );
end;
$$;


--
-- Name: order_header; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.order_header (
    order_id bigint NOT NULL,
    company_id uuid NOT NULL,
    order_no text NOT NULL,
    customer_id bigint NOT NULL,
    order_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'OPEN'::text NOT NULL,
    remarks text,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT chk_order_status CHECK ((status_code = ANY (ARRAY['draft'::text, 'confirmed'::text, 'pending_approval'::text, 'approved'::text, 'rejected'::text, 'cancelled'::text])))
);

ALTER TABLE ONLY sales.order_header FORCE ROW LEVEL SECURITY;


--
-- Name: rpc_list_orders(date, date); Type: FUNCTION; Schema: sales; Owner: -
--

CREATE FUNCTION sales.rpc_list_orders(p_from date DEFAULT NULL::date, p_to date DEFAULT NULL::date) RETURNS SETOF sales.order_header
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_company_id uuid := public.my_company_id();
BEGIN
  PERFORM core.fn_log_read_event(
    v_company_id,
    'sales.order_header',
    '',
    jsonb_build_object('from', p_from, 'to', p_to)
  );

  RETURN QUERY
  SELECT *
  FROM sales.order_header
  WHERE company_id = v_company_id
    AND (p_from IS NULL OR order_date >= p_from)
    AND (p_to   IS NULL OR order_date <= p_to)
  ORDER BY order_date DESC, order_id DESC;
END;
$$;


--
-- Name: add_prefixes(text, text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.add_prefixes(_bucket_id text, _name text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    prefixes text[];
BEGIN
    prefixes := "storage"."get_prefixes"("_name");

    IF array_length(prefixes, 1) > 0 THEN
        INSERT INTO storage.prefixes (name, bucket_id)
        SELECT UNNEST(prefixes) as name, "_bucket_id" ON CONFLICT DO NOTHING;
    END IF;
END;
$$;


--
-- Name: can_insert_object(text, text, uuid, jsonb); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.can_insert_object(bucketid text, name text, owner uuid, metadata jsonb) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  INSERT INTO "storage"."objects" ("bucket_id", "name", "owner", "metadata") VALUES (bucketid, name, owner, metadata);
  -- hack to rollback the successful insert
  RAISE sqlstate 'PT200' using
  message = 'ROLLBACK',
  detail = 'rollback successful insert';
END
$$;


--
-- Name: delete_leaf_prefixes(text[], text[]); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.delete_leaf_prefixes(bucket_ids text[], names text[]) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_rows_deleted integer;
BEGIN
    LOOP
        WITH candidates AS (
            SELECT DISTINCT
                t.bucket_id,
                unnest(storage.get_prefixes(t.name)) AS name
            FROM unnest(bucket_ids, names) AS t(bucket_id, name)
        ),
        uniq AS (
             SELECT
                 bucket_id,
                 name,
                 storage.get_level(name) AS level
             FROM candidates
             WHERE name <> ''
             GROUP BY bucket_id, name
        ),
        leaf AS (
             SELECT
                 p.bucket_id,
                 p.name,
                 p.level
             FROM storage.prefixes AS p
                  JOIN uniq AS u
                       ON u.bucket_id = p.bucket_id
                           AND u.name = p.name
                           AND u.level = p.level
             WHERE NOT EXISTS (
                 SELECT 1
                 FROM storage.objects AS o
                 WHERE o.bucket_id = p.bucket_id
                   AND o.level = p.level + 1
                   AND o.name COLLATE "C" LIKE p.name || '/%'
             )
             AND NOT EXISTS (
                 SELECT 1
                 FROM storage.prefixes AS c
                 WHERE c.bucket_id = p.bucket_id
                   AND c.level = p.level + 1
                   AND c.name COLLATE "C" LIKE p.name || '/%'
             )
        )
        DELETE
        FROM storage.prefixes AS p
            USING leaf AS l
        WHERE p.bucket_id = l.bucket_id
          AND p.name = l.name
          AND p.level = l.level;

        GET DIAGNOSTICS v_rows_deleted = ROW_COUNT;
        EXIT WHEN v_rows_deleted = 0;
    END LOOP;
END;
$$;


--
-- Name: delete_prefix(text, text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.delete_prefix(_bucket_id text, _name text) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
    -- Check if we can delete the prefix
    IF EXISTS(
        SELECT FROM "storage"."prefixes"
        WHERE "prefixes"."bucket_id" = "_bucket_id"
          AND level = "storage"."get_level"("_name") + 1
          AND "prefixes"."name" COLLATE "C" LIKE "_name" || '/%'
        LIMIT 1
    )
    OR EXISTS(
        SELECT FROM "storage"."objects"
        WHERE "objects"."bucket_id" = "_bucket_id"
          AND "storage"."get_level"("objects"."name") = "storage"."get_level"("_name") + 1
          AND "objects"."name" COLLATE "C" LIKE "_name" || '/%'
        LIMIT 1
    ) THEN
    -- There are sub-objects, skip deletion
    RETURN false;
    ELSE
        DELETE FROM "storage"."prefixes"
        WHERE "prefixes"."bucket_id" = "_bucket_id"
          AND level = "storage"."get_level"("_name")
          AND "prefixes"."name" = "_name";
        RETURN true;
    END IF;
END;
$$;


--
-- Name: delete_prefix_hierarchy_trigger(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.delete_prefix_hierarchy_trigger() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
    prefix text;
BEGIN
    prefix := "storage"."get_prefix"(OLD."name");

    IF coalesce(prefix, '') != '' THEN
        PERFORM "storage"."delete_prefix"(OLD."bucket_id", prefix);
    END IF;

    RETURN OLD;
END;
$$;


--
-- Name: enforce_bucket_name_length(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.enforce_bucket_name_length() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
begin
    if length(new.name) > 100 then
        raise exception 'bucket name "%" is too long (% characters). Max is 100.', new.name, length(new.name);
    end if;
    return new;
end;
$$;


--
-- Name: extension(text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.extension(name text) RETURNS text
    LANGUAGE plpgsql IMMUTABLE
    AS $$
DECLARE
    _parts text[];
    _filename text;
BEGIN
    SELECT string_to_array(name, '/') INTO _parts;
    SELECT _parts[array_length(_parts,1)] INTO _filename;
    RETURN reverse(split_part(reverse(_filename), '.', 1));
END
$$;


--
-- Name: filename(text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.filename(name text) RETURNS text
    LANGUAGE plpgsql
    AS $$
DECLARE
_parts text[];
BEGIN
	select string_to_array(name, '/') into _parts;
	return _parts[array_length(_parts,1)];
END
$$;


--
-- Name: foldername(text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.foldername(name text) RETURNS text[]
    LANGUAGE plpgsql IMMUTABLE
    AS $$
DECLARE
    _parts text[];
BEGIN
    -- Split on "/" to get path segments
    SELECT string_to_array(name, '/') INTO _parts;
    -- Return everything except the last segment
    RETURN _parts[1 : array_length(_parts,1) - 1];
END
$$;


--
-- Name: get_level(text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.get_level(name text) RETURNS integer
    LANGUAGE sql IMMUTABLE STRICT
    AS $$
SELECT array_length(string_to_array("name", '/'), 1);
$$;


--
-- Name: get_prefix(text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.get_prefix(name text) RETURNS text
    LANGUAGE sql IMMUTABLE STRICT
    AS $_$
SELECT
    CASE WHEN strpos("name", '/') > 0 THEN
             regexp_replace("name", '[\/]{1}[^\/]+\/?$', '')
         ELSE
             ''
        END;
$_$;


--
-- Name: get_prefixes(text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.get_prefixes(name text) RETURNS text[]
    LANGUAGE plpgsql IMMUTABLE STRICT
    AS $$
DECLARE
    parts text[];
    prefixes text[];
    prefix text;
BEGIN
    -- Split the name into parts by '/'
    parts := string_to_array("name", '/');
    prefixes := '{}';

    -- Construct the prefixes, stopping one level below the last part
    FOR i IN 1..array_length(parts, 1) - 1 LOOP
            prefix := array_to_string(parts[1:i], '/');
            prefixes := array_append(prefixes, prefix);
    END LOOP;

    RETURN prefixes;
END;
$$;


--
-- Name: get_size_by_bucket(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.get_size_by_bucket() RETURNS TABLE(size bigint, bucket_id text)
    LANGUAGE plpgsql STABLE
    AS $$
BEGIN
    return query
        select sum((metadata->>'size')::bigint) as size, obj.bucket_id
        from "storage".objects as obj
        group by obj.bucket_id;
END
$$;


--
-- Name: list_multipart_uploads_with_delimiter(text, text, text, integer, text, text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.list_multipart_uploads_with_delimiter(bucket_id text, prefix_param text, delimiter_param text, max_keys integer DEFAULT 100, next_key_token text DEFAULT ''::text, next_upload_token text DEFAULT ''::text) RETURNS TABLE(key text, id text, created_at timestamp with time zone)
    LANGUAGE plpgsql
    AS $_$
BEGIN
    RETURN QUERY EXECUTE
        'SELECT DISTINCT ON(key COLLATE "C") * from (
            SELECT
                CASE
                    WHEN position($2 IN substring(key from length($1) + 1)) > 0 THEN
                        substring(key from 1 for length($1) + position($2 IN substring(key from length($1) + 1)))
                    ELSE
                        key
                END AS key, id, created_at
            FROM
                storage.s3_multipart_uploads
            WHERE
                bucket_id = $5 AND
                key ILIKE $1 || ''%'' AND
                CASE
                    WHEN $4 != '''' AND $6 = '''' THEN
                        CASE
                            WHEN position($2 IN substring(key from length($1) + 1)) > 0 THEN
                                substring(key from 1 for length($1) + position($2 IN substring(key from length($1) + 1))) COLLATE "C" > $4
                            ELSE
                                key COLLATE "C" > $4
                            END
                    ELSE
                        true
                END AND
                CASE
                    WHEN $6 != '''' THEN
                        id COLLATE "C" > $6
                    ELSE
                        true
                    END
            ORDER BY
                key COLLATE "C" ASC, created_at ASC) as e order by key COLLATE "C" LIMIT $3'
        USING prefix_param, delimiter_param, max_keys, next_key_token, bucket_id, next_upload_token;
END;
$_$;


--
-- Name: list_objects_with_delimiter(text, text, text, integer, text, text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.list_objects_with_delimiter(bucket_id text, prefix_param text, delimiter_param text, max_keys integer DEFAULT 100, start_after text DEFAULT ''::text, next_token text DEFAULT ''::text) RETURNS TABLE(name text, id uuid, metadata jsonb, updated_at timestamp with time zone)
    LANGUAGE plpgsql
    AS $_$
BEGIN
    RETURN QUERY EXECUTE
        'SELECT DISTINCT ON(name COLLATE "C") * from (
            SELECT
                CASE
                    WHEN position($2 IN substring(name from length($1) + 1)) > 0 THEN
                        substring(name from 1 for length($1) + position($2 IN substring(name from length($1) + 1)))
                    ELSE
                        name
                END AS name, id, metadata, updated_at
            FROM
                storage.objects
            WHERE
                bucket_id = $5 AND
                name ILIKE $1 || ''%'' AND
                CASE
                    WHEN $6 != '''' THEN
                    name COLLATE "C" > $6
                ELSE true END
                AND CASE
                    WHEN $4 != '''' THEN
                        CASE
                            WHEN position($2 IN substring(name from length($1) + 1)) > 0 THEN
                                substring(name from 1 for length($1) + position($2 IN substring(name from length($1) + 1))) COLLATE "C" > $4
                            ELSE
                                name COLLATE "C" > $4
                            END
                    ELSE
                        true
                END
            ORDER BY
                name COLLATE "C" ASC) as e order by name COLLATE "C" LIMIT $3'
        USING prefix_param, delimiter_param, max_keys, next_token, bucket_id, start_after;
END;
$_$;


--
-- Name: lock_top_prefixes(text[], text[]); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.lock_top_prefixes(bucket_ids text[], names text[]) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_bucket text;
    v_top text;
BEGIN
    FOR v_bucket, v_top IN
        SELECT DISTINCT t.bucket_id,
            split_part(t.name, '/', 1) AS top
        FROM unnest(bucket_ids, names) AS t(bucket_id, name)
        WHERE t.name <> ''
        ORDER BY 1, 2
        LOOP
            PERFORM pg_advisory_xact_lock(hashtextextended(v_bucket || '/' || v_top, 0));
        END LOOP;
END;
$$;


--
-- Name: objects_delete_cleanup(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.objects_delete_cleanup() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_bucket_ids text[];
    v_names      text[];
BEGIN
    IF current_setting('storage.gc.prefixes', true) = '1' THEN
        RETURN NULL;
    END IF;

    PERFORM set_config('storage.gc.prefixes', '1', true);

    SELECT COALESCE(array_agg(d.bucket_id), '{}'),
           COALESCE(array_agg(d.name), '{}')
    INTO v_bucket_ids, v_names
    FROM deleted AS d
    WHERE d.name <> '';

    PERFORM storage.lock_top_prefixes(v_bucket_ids, v_names);
    PERFORM storage.delete_leaf_prefixes(v_bucket_ids, v_names);

    RETURN NULL;
END;
$$;


--
-- Name: objects_insert_prefix_trigger(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.objects_insert_prefix_trigger() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    PERFORM "storage"."add_prefixes"(NEW."bucket_id", NEW."name");
    NEW.level := "storage"."get_level"(NEW."name");

    RETURN NEW;
END;
$$;


--
-- Name: objects_update_cleanup(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.objects_update_cleanup() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    -- NEW - OLD (destinations to create prefixes for)
    v_add_bucket_ids text[];
    v_add_names      text[];

    -- OLD - NEW (sources to prune)
    v_src_bucket_ids text[];
    v_src_names      text[];
BEGIN
    IF TG_OP <> 'UPDATE' THEN
        RETURN NULL;
    END IF;

    -- 1) Compute NEWOLD (added paths) and OLDNEW (moved-away paths)
    WITH added AS (
        SELECT n.bucket_id, n.name
        FROM new_rows n
        WHERE n.name <> '' AND position('/' in n.name) > 0
        EXCEPT
        SELECT o.bucket_id, o.name FROM old_rows o WHERE o.name <> ''
    ),
    moved AS (
         SELECT o.bucket_id, o.name
         FROM old_rows o
         WHERE o.name <> ''
         EXCEPT
         SELECT n.bucket_id, n.name FROM new_rows n WHERE n.name <> ''
    )
    SELECT
        -- arrays for ADDED (dest) in stable order
        COALESCE( (SELECT array_agg(a.bucket_id ORDER BY a.bucket_id, a.name) FROM added a), '{}' ),
        COALESCE( (SELECT array_agg(a.name      ORDER BY a.bucket_id, a.name) FROM added a), '{}' ),
        -- arrays for MOVED (src) in stable order
        COALESCE( (SELECT array_agg(m.bucket_id ORDER BY m.bucket_id, m.name) FROM moved m), '{}' ),
        COALESCE( (SELECT array_agg(m.name      ORDER BY m.bucket_id, m.name) FROM moved m), '{}' )
    INTO v_add_bucket_ids, v_add_names, v_src_bucket_ids, v_src_names;

    -- Nothing to do?
    IF (array_length(v_add_bucket_ids, 1) IS NULL) AND (array_length(v_src_bucket_ids, 1) IS NULL) THEN
        RETURN NULL;
    END IF;

    -- 2) Take per-(bucket, top) locks: ALL prefixes in consistent global order to prevent deadlocks
    DECLARE
        v_all_bucket_ids text[];
        v_all_names text[];
    BEGIN
        -- Combine source and destination arrays for consistent lock ordering
        v_all_bucket_ids := COALESCE(v_src_bucket_ids, '{}') || COALESCE(v_add_bucket_ids, '{}');
        v_all_names := COALESCE(v_src_names, '{}') || COALESCE(v_add_names, '{}');

        -- Single lock call ensures consistent global ordering across all transactions
        IF array_length(v_all_bucket_ids, 1) IS NOT NULL THEN
            PERFORM storage.lock_top_prefixes(v_all_bucket_ids, v_all_names);
        END IF;
    END;

    -- 3) Create destination prefixes (NEWOLD) BEFORE pruning sources
    IF array_length(v_add_bucket_ids, 1) IS NOT NULL THEN
        WITH candidates AS (
            SELECT DISTINCT t.bucket_id, unnest(storage.get_prefixes(t.name)) AS name
            FROM unnest(v_add_bucket_ids, v_add_names) AS t(bucket_id, name)
            WHERE name <> ''
        )
        INSERT INTO storage.prefixes (bucket_id, name)
        SELECT c.bucket_id, c.name
        FROM candidates c
        ON CONFLICT DO NOTHING;
    END IF;

    -- 4) Prune source prefixes bottom-up for OLDNEW
    IF array_length(v_src_bucket_ids, 1) IS NOT NULL THEN
        -- re-entrancy guard so DELETE on prefixes won't recurse
        IF current_setting('storage.gc.prefixes', true) <> '1' THEN
            PERFORM set_config('storage.gc.prefixes', '1', true);
        END IF;

        PERFORM storage.delete_leaf_prefixes(v_src_bucket_ids, v_src_names);
    END IF;

    RETURN NULL;
END;
$$;


--
-- Name: objects_update_level_trigger(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.objects_update_level_trigger() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    -- Ensure this is an update operation and the name has changed
    IF TG_OP = 'UPDATE' AND (NEW."name" <> OLD."name" OR NEW."bucket_id" <> OLD."bucket_id") THEN
        -- Set the new level
        NEW."level" := "storage"."get_level"(NEW."name");
    END IF;
    RETURN NEW;
END;
$$;


--
-- Name: objects_update_prefix_trigger(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.objects_update_prefix_trigger() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
    old_prefixes TEXT[];
BEGIN
    -- Ensure this is an update operation and the name has changed
    IF TG_OP = 'UPDATE' AND (NEW."name" <> OLD."name" OR NEW."bucket_id" <> OLD."bucket_id") THEN
        -- Retrieve old prefixes
        old_prefixes := "storage"."get_prefixes"(OLD."name");

        -- Remove old prefixes that are only used by this object
        WITH all_prefixes as (
            SELECT unnest(old_prefixes) as prefix
        ),
        can_delete_prefixes as (
             SELECT prefix
             FROM all_prefixes
             WHERE NOT EXISTS (
                 SELECT 1 FROM "storage"."objects"
                 WHERE "bucket_id" = OLD."bucket_id"
                   AND "name" <> OLD."name"
                   AND "name" LIKE (prefix || '%')
             )
         )
        DELETE FROM "storage"."prefixes" WHERE name IN (SELECT prefix FROM can_delete_prefixes);

        -- Add new prefixes
        PERFORM "storage"."add_prefixes"(NEW."bucket_id", NEW."name");
    END IF;
    -- Set the new level
    NEW."level" := "storage"."get_level"(NEW."name");

    RETURN NEW;
END;
$$;


--
-- Name: operation(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.operation() RETURNS text
    LANGUAGE plpgsql STABLE
    AS $$
BEGIN
    RETURN current_setting('storage.operation', true);
END;
$$;


--
-- Name: prefixes_delete_cleanup(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.prefixes_delete_cleanup() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
    v_bucket_ids text[];
    v_names      text[];
BEGIN
    IF current_setting('storage.gc.prefixes', true) = '1' THEN
        RETURN NULL;
    END IF;

    PERFORM set_config('storage.gc.prefixes', '1', true);

    SELECT COALESCE(array_agg(d.bucket_id), '{}'),
           COALESCE(array_agg(d.name), '{}')
    INTO v_bucket_ids, v_names
    FROM deleted AS d
    WHERE d.name <> '';

    PERFORM storage.lock_top_prefixes(v_bucket_ids, v_names);
    PERFORM storage.delete_leaf_prefixes(v_bucket_ids, v_names);

    RETURN NULL;
END;
$$;


--
-- Name: prefixes_insert_trigger(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.prefixes_insert_trigger() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    PERFORM "storage"."add_prefixes"(NEW."bucket_id", NEW."name");
    RETURN NEW;
END;
$$;


--
-- Name: search(text, text, integer, integer, integer, text, text, text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.search(prefix text, bucketname text, limits integer DEFAULT 100, levels integer DEFAULT 1, offsets integer DEFAULT 0, search text DEFAULT ''::text, sortcolumn text DEFAULT 'name'::text, sortorder text DEFAULT 'asc'::text) RETURNS TABLE(name text, id uuid, updated_at timestamp with time zone, created_at timestamp with time zone, last_accessed_at timestamp with time zone, metadata jsonb)
    LANGUAGE plpgsql
    AS $$
declare
    can_bypass_rls BOOLEAN;
begin
    SELECT rolbypassrls
    INTO can_bypass_rls
    FROM pg_roles
    WHERE rolname = coalesce(nullif(current_setting('role', true), 'none'), current_user);

    IF can_bypass_rls THEN
        RETURN QUERY SELECT * FROM storage.search_v1_optimised(prefix, bucketname, limits, levels, offsets, search, sortcolumn, sortorder);
    ELSE
        RETURN QUERY SELECT * FROM storage.search_legacy_v1(prefix, bucketname, limits, levels, offsets, search, sortcolumn, sortorder);
    END IF;
end;
$$;


--
-- Name: search_legacy_v1(text, text, integer, integer, integer, text, text, text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.search_legacy_v1(prefix text, bucketname text, limits integer DEFAULT 100, levels integer DEFAULT 1, offsets integer DEFAULT 0, search text DEFAULT ''::text, sortcolumn text DEFAULT 'name'::text, sortorder text DEFAULT 'asc'::text) RETURNS TABLE(name text, id uuid, updated_at timestamp with time zone, created_at timestamp with time zone, last_accessed_at timestamp with time zone, metadata jsonb)
    LANGUAGE plpgsql STABLE
    AS $_$
declare
    v_order_by text;
    v_sort_order text;
begin
    case
        when sortcolumn = 'name' then
            v_order_by = 'name';
        when sortcolumn = 'updated_at' then
            v_order_by = 'updated_at';
        when sortcolumn = 'created_at' then
            v_order_by = 'created_at';
        when sortcolumn = 'last_accessed_at' then
            v_order_by = 'last_accessed_at';
        else
            v_order_by = 'name';
        end case;

    case
        when sortorder = 'asc' then
            v_sort_order = 'asc';
        when sortorder = 'desc' then
            v_sort_order = 'desc';
        else
            v_sort_order = 'asc';
        end case;

    v_order_by = v_order_by || ' ' || v_sort_order;

    return query execute
        'with folders as (
           select path_tokens[$1] as folder
           from storage.objects
             where objects.name ilike $2 || $3 || ''%''
               and bucket_id = $4
               and array_length(objects.path_tokens, 1) <> $1
           group by folder
           order by folder ' || v_sort_order || '
     )
     (select folder as "name",
            null as id,
            null as updated_at,
            null as created_at,
            null as last_accessed_at,
            null as metadata from folders)
     union all
     (select path_tokens[$1] as "name",
            id,
            updated_at,
            created_at,
            last_accessed_at,
            metadata
     from storage.objects
     where objects.name ilike $2 || $3 || ''%''
       and bucket_id = $4
       and array_length(objects.path_tokens, 1) = $1
     order by ' || v_order_by || ')
     limit $5
     offset $6' using levels, prefix, search, bucketname, limits, offsets;
end;
$_$;


--
-- Name: search_v1_optimised(text, text, integer, integer, integer, text, text, text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.search_v1_optimised(prefix text, bucketname text, limits integer DEFAULT 100, levels integer DEFAULT 1, offsets integer DEFAULT 0, search text DEFAULT ''::text, sortcolumn text DEFAULT 'name'::text, sortorder text DEFAULT 'asc'::text) RETURNS TABLE(name text, id uuid, updated_at timestamp with time zone, created_at timestamp with time zone, last_accessed_at timestamp with time zone, metadata jsonb)
    LANGUAGE plpgsql STABLE
    AS $_$
declare
    v_order_by text;
    v_sort_order text;
begin
    case
        when sortcolumn = 'name' then
            v_order_by = 'name';
        when sortcolumn = 'updated_at' then
            v_order_by = 'updated_at';
        when sortcolumn = 'created_at' then
            v_order_by = 'created_at';
        when sortcolumn = 'last_accessed_at' then
            v_order_by = 'last_accessed_at';
        else
            v_order_by = 'name';
        end case;

    case
        when sortorder = 'asc' then
            v_sort_order = 'asc';
        when sortorder = 'desc' then
            v_sort_order = 'desc';
        else
            v_sort_order = 'asc';
        end case;

    v_order_by = v_order_by || ' ' || v_sort_order;

    return query execute
        'with folders as (
           select (string_to_array(name, ''/''))[level] as name
           from storage.prefixes
             where lower(prefixes.name) like lower($2 || $3) || ''%''
               and bucket_id = $4
               and level = $1
           order by name ' || v_sort_order || '
     )
     (select name,
            null as id,
            null as updated_at,
            null as created_at,
            null as last_accessed_at,
            null as metadata from folders)
     union all
     (select path_tokens[level] as "name",
            id,
            updated_at,
            created_at,
            last_accessed_at,
            metadata
     from storage.objects
     where lower(objects.name) like lower($2 || $3) || ''%''
       and bucket_id = $4
       and level = $1
     order by ' || v_order_by || ')
     limit $5
     offset $6' using levels, prefix, search, bucketname, limits, offsets;
end;
$_$;


--
-- Name: search_v2(text, text, integer, integer, text, text, text, text); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.search_v2(prefix text, bucket_name text, limits integer DEFAULT 100, levels integer DEFAULT 1, start_after text DEFAULT ''::text, sort_order text DEFAULT 'asc'::text, sort_column text DEFAULT 'name'::text, sort_column_after text DEFAULT ''::text) RETURNS TABLE(key text, name text, id uuid, updated_at timestamp with time zone, created_at timestamp with time zone, last_accessed_at timestamp with time zone, metadata jsonb)
    LANGUAGE plpgsql STABLE
    AS $_$
DECLARE
    sort_col text;
    sort_ord text;
    cursor_op text;
    cursor_expr text;
    sort_expr text;
BEGIN
    -- Validate sort_order
    sort_ord := lower(sort_order);
    IF sort_ord NOT IN ('asc', 'desc') THEN
        sort_ord := 'asc';
    END IF;

    -- Determine cursor comparison operator
    IF sort_ord = 'asc' THEN
        cursor_op := '>';
    ELSE
        cursor_op := '<';
    END IF;
    
    sort_col := lower(sort_column);
    -- Validate sort column  
    IF sort_col IN ('updated_at', 'created_at') THEN
        cursor_expr := format(
            '($5 = '''' OR ROW(date_trunc(''milliseconds'', %I), name COLLATE "C") %s ROW(COALESCE(NULLIF($6, '''')::timestamptz, ''epoch''::timestamptz), $5))',
            sort_col, cursor_op
        );
        sort_expr := format(
            'COALESCE(date_trunc(''milliseconds'', %I), ''epoch''::timestamptz) %s, name COLLATE "C" %s',
            sort_col, sort_ord, sort_ord
        );
    ELSE
        cursor_expr := format('($5 = '''' OR name COLLATE "C" %s $5)', cursor_op);
        sort_expr := format('name COLLATE "C" %s', sort_ord);
    END IF;

    RETURN QUERY EXECUTE format(
        $sql$
        SELECT * FROM (
            (
                SELECT
                    split_part(name, '/', $4) AS key,
                    name,
                    NULL::uuid AS id,
                    updated_at,
                    created_at,
                    NULL::timestamptz AS last_accessed_at,
                    NULL::jsonb AS metadata
                FROM storage.prefixes
                WHERE name COLLATE "C" LIKE $1 || '%%'
                    AND bucket_id = $2
                    AND level = $4
                    AND %s
                ORDER BY %s
                LIMIT $3
            )
            UNION ALL
            (
                SELECT
                    split_part(name, '/', $4) AS key,
                    name,
                    id,
                    updated_at,
                    created_at,
                    last_accessed_at,
                    metadata
                FROM storage.objects
                WHERE name COLLATE "C" LIKE $1 || '%%'
                    AND bucket_id = $2
                    AND level = $4
                    AND %s
                ORDER BY %s
                LIMIT $3
            )
        ) obj
        ORDER BY %s
        LIMIT $3
        $sql$,
        cursor_expr,    -- prefixes WHERE
        sort_expr,      -- prefixes ORDER BY
        cursor_expr,    -- objects WHERE
        sort_expr,      -- objects ORDER BY
        sort_expr       -- final ORDER BY
    )
    USING prefix, bucket_name, limits, levels, start_after, sort_column_after;
END;
$_$;


--
-- Name: update_updated_at_column(); Type: FUNCTION; Schema: storage; Owner: -
--

CREATE FUNCTION storage.update_updated_at_column() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW; 
END;
$$;


--
-- Name: ai_optimize_runtime(integer); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.ai_optimize_runtime(p_window_min integer DEFAULT 10) RETURNS TABLE(kind text, code text, old_val integer, new_val integer, reason text)
    LANGUAGE plpgsql
    AS $$
declare
  win interval := (coalesce(p_window_min,10) || ' minutes')::interval;
  min_i int := 10;
  max_i int := 600;
begin
  return query
  with backlog as (
    select r.command_code, count(*) as pending_cnt
      from system.exec_run_request r
     where r.status='PENDING'
     group by r.command_code
  ),
  stats as (
    select
      r.command_code,
      count(*) filter (where r.completed_at >= now()-win and r.status='DONE') as ok_cnt,
      count(*) filter (where r.completed_at >= now()-win and r.status='FAILED') as ng_cnt
    from system.exec_run_request r
    group by r.command_code
  ),
  lc as (
    select loop_code, command_code, interval_sec
      from system.loop_config
     where is_enabled=true
  ),
  j as (
    select
      lc.loop_code,
      lc.command_code,
      lc.interval_sec as old_interval,
      coalesce(b.pending_cnt,0) as pending_cnt,
      coalesce(s.ok_cnt,0) as ok_cnt,
      coalesce(s.ng_cnt,0) as ng_cnt
    from lc
    left join backlog b on b.command_code = lc.command_code
    left join stats s on s.command_code = lc.command_code
  ),
  d as (
    select
      j.loop_code,
      j.command_code,
      j.old_interval,
      case
        when (j.ok_cnt + j.ng_cnt) = 0 and j.pending_cnt >= 50 then least(max_i, j.old_interval * 2)
        when (j.ok_cnt + j.ng_cnt) > 0 and (j.ng_cnt::numeric / (j.ok_cnt + j.ng_cnt)) >= 0.5 then least(max_i, j.old_interval * 2)
        when j.pending_cnt >= 200 then least(max_i, j.old_interval * 2)
        when j.pending_cnt <= 5 and (j.ok_cnt + j.ng_cnt) > 0 and (j.ok_cnt::numeric / (j.ok_cnt + j.ng_cnt)) >= 0.9 then greatest(min_i, (j.old_interval * 8 / 10))
        else j.old_interval
      end as new_interval,
      case
        when (j.ok_cnt + j.ng_cnt) = 0 and j.pending_cnt >= 50 then 'no stats + backlog high -> slow'
        when (j.ok_cnt + j.ng_cnt) > 0 and (j.ng_cnt::numeric / (j.ok_cnt + j.ng_cnt)) >= 0.5 then 'fail rate high -> slow'
        when j.pending_cnt >= 200 then 'backlog huge -> slow'
        when j.pending_cnt <= 5 and (j.ok_cnt + j.ng_cnt) > 0 and (j.ok_cnt::numeric / (j.ok_cnt + j.ng_cnt)) >= 0.9 then 'mostly ok + low backlog -> speed'
        else 'keep'
      end as reason
    from j
  )
  update system.loop_config lc
     set interval_sec = d.new_interval
    from d
   where lc.loop_code = d.loop_code
     and d.new_interval <> d.old_interval
  returning 'loop_interval'::text, lc.loop_code::text, d.old_interval::int, d.new_interval::int, d.reason::text;
end;
$$;


--
-- Name: approve_request_and_enqueue(bigint, text); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.approve_request_and_enqueue(p_approval_request_id bigint, p_comment text DEFAULT NULL::text) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
declare
  rid bigint;
begin
  update system.approval_request
     set approval_status = 'APPROVED',
         approved_at = now()
   where approval_request_id = p_approval_request_id;

  insert into system.approval_action_log(approval_request_id, step_no, action, action_by, comment)
  values (p_approval_request_id, 1, 'APPROVE', auth.uid(), p_comment);

  rid := system.enqueue_exec_from_approval(p_approval_request_id);
  return rid;
end;
$$;


--
-- Name: autotune_loop_config(integer); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.autotune_loop_config(p_window_min integer DEFAULT 10) RETURNS TABLE(loop_code text, old_interval integer, new_interval integer, reason text)
    LANGUAGE plpgsql
    AS $$
declare
  win interval := (coalesce(p_window_min,10) || ' minutes')::interval;
  min_i int := 10;
  max_i int := 600;
begin
  return query
  with base as (
    select lc.loop_code, lc.interval_sec, lc.command_code
      from system.loop_config lc
     where lc.is_enabled = true
  ),
  stats as (
    select
      r.command_code,
      count(*) filter (where r.completed_at >= now()-win and r.status='DONE') as ok_cnt,
      count(*) filter (where r.completed_at >= now()-win and r.status='FAILED') as ng_cnt
    from system.exec_run_request r
    group by r.command_code
  ),
  joined as (
    select
      b.loop_code,
      b.interval_sec as old_interval,
      coalesce(s.ok_cnt,0) as ok_cnt,
      coalesce(s.ng_cnt,0) as ng_cnt
    from base b
    left join stats s on s.command_code = b.command_code
  ),
  decision as (
    select
      j.loop_code,
      j.old_interval,
      case
        when (j.ok_cnt + j.ng_cnt) = 0 then j.old_interval
        when j.ng_cnt * 1.0 / (j.ok_cnt + j.ng_cnt) >= 0.5 then least(max_i, greatest(min_i, (j.old_interval * 2)))
        when j.ok_cnt * 1.0 / (j.ok_cnt + j.ng_cnt) >= 0.9 then greatest(min_i, (j.old_interval * 8 / 10))
        else j.old_interval
      end as new_interval,
      case
        when (j.ok_cnt + j.ng_cnt) = 0 then 'no recent jobs'
        when j.ng_cnt * 1.0 / (j.ok_cnt + j.ng_cnt) >= 0.5 then 'too many failures -> slow down'
        when j.ok_cnt * 1.0 / (j.ok_cnt + j.ng_cnt) >= 0.9 then 'mostly ok -> speed up'
        else 'keep'
      end as reason
    from joined j
  )
  update system.loop_config lc
     set interval_sec = d.new_interval
    from decision d
   where lc.loop_code = d.loop_code
     and d.new_interval <> d.old_interval
  returning d.loop_code, d.old_interval, d.new_interval, d.reason;
end;
$$;


--
-- Name: autotune_loops(timestamp with time zone, timestamp with time zone); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.autotune_loops(p_start timestamp with time zone, p_end timestamp with time zone) RETURNS integer
    LANGUAGE plpgsql
    AS $$
declare
  s record;
  r record;
  ratio numeric;
  new_interval int;
  changed int := 0;
begin
  -- compute stats first (idempotent-ish: duplicates allowed; acceptable as history)
  perform system.compute_loop_sla(p_start, p_end);

  for s in
    select distinct on (loop_code)
      loop_code, tick_count, fail_count
    from system.loop_sla_stat
    where window_start = p_start and window_end = p_end
    order by loop_code, computed_at desc
  loop
    select * into r
      from system.loop_autotune_rule
     where loop_code = s.loop_code
       and is_active = true;

    if r.rule_id is null then
      continue;
    end if;

    if s.tick_count <= 0 then
      continue;
    end if;

    ratio := (s.fail_count::numeric / s.tick_count::numeric);

    select interval_sec into new_interval
      from system.loop_config
     where loop_code = s.loop_code;

    if new_interval is null then
      continue;
    end if;

    if ratio >= r.fail_ratio_threshold then
      new_interval := least(r.interval_max_sec, new_interval + r.step_up_sec);
    else
      new_interval := greatest(r.interval_min_sec, new_interval - r.step_down_sec);
    end if;

    update system.loop_config
       set interval_sec = new_interval,
           updated_at = now()
     where loop_code = s.loop_code;

    changed := changed + 1;
  end loop;

  return changed;
end;
$$;


--
-- Name: calc_next_run_at(timestamp with time zone, integer, integer); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.calc_next_run_at(p_from timestamp with time zone, p_interval_sec integer, p_jitter_sec integer) RETURNS timestamp with time zone
    LANGUAGE sql
    AS $$
  select
    coalesce(p_from, now())
    + make_interval(secs => greatest(coalesce(p_interval_sec,60),1))
    + make_interval(secs => (case when coalesce(p_jitter_sec,0) <= 0 then 0
                                  else (floor(random() * (p_jitter_sec+1)))::int end));
$$;


--
-- Name: complete_ai_task(bigint, boolean, jsonb, text); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.complete_ai_task(p_task_id bigint, p_success boolean, p_result jsonb DEFAULT NULL::jsonb, p_error text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  update system.ai_task
     set status = case when p_success then 'DONE' else 'FAILED' end,
         completed_at = now(),
         result_json = p_result,
         error_text = p_error
   where task_id = p_task_id;

  insert into system.ai_task_run(task_id, run_status, note)
  values (p_task_id, case when p_success then 'DONE' else 'FAIL' end,
          case when p_success then null else coalesce(p_error,'') end);
end;
$$;


--
-- Name: complete_exec_request(bigint, integer, text, text); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.complete_exec_request(p_request_id bigint, p_exit_code integer, p_stdout text, p_stderr text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  update system.exec_run_request
     set status = case when coalesce(p_exit_code,1)=0 then 'DONE' else 'FAILED' end,
         completed_at = now(),
         exit_code = p_exit_code,
         stdout_text = p_stdout,
         stderr_text = p_stderr
   where request_id = p_request_id;
end;
$$;


--
-- Name: compute_loop_sla(timestamp with time zone, timestamp with time zone); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.compute_loop_sla(p_start timestamp with time zone, p_end timestamp with time zone) RETURNS integer
    LANGUAGE plpgsql
    AS $$
declare
  rec record;
  n int := 0;
begin
  for rec in
    select
      loop_code,
      count(*) filter (where tick_status in ('DONE','FAIL')) as tick_count,
      count(*) filter (where tick_status = 'FAIL') as fail_count
    from system.loop_tick_log
    where created_at >= p_start
      and created_at <  p_end
    group by loop_code
  loop
    insert into system.loop_sla_stat(loop_code, window_start, window_end, tick_count, fail_count)
    values (rec.loop_code, p_start, p_end, rec.tick_count::int, rec.fail_count::int);
    n := n + 1;
  end loop;

  return n;
end;
$$;


--
-- Name: enqueue_exec_from_approval(bigint); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.enqueue_exec_from_approval(p_approval_request_id bigint) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
declare
  ar record;
  mp record;
  rid bigint;
begin
  select * into ar
    from system.approval_request
   where approval_request_id = p_approval_request_id;

  if ar.approval_request_id is null then
    raise exception 'approval_request not found: %', p_approval_request_id;
  end if;

  if ar.approval_status <> 'APPROVED' then
    raise exception 'approval_status is not APPROVED: %', ar.approval_status;
  end if;

  select * into mp
    from system.approval_exec_map
   where approval_flow_code = ar.approval_flow_code;

  if mp.approval_flow_code is null then
    raise exception 'approval_exec_map missing for flow: %', ar.approval_flow_code;
  end if;

  insert into system.exec_run_request(command_code, args_json, priority, status, requested_by, worker_tag)
  values (
    mp.command_code,
    jsonb_build_object(
      'approval_request_id', ar.approval_request_id::text,
      'business_table', ar.business_table,
      'business_id', ar.business_id::text
    ),
    100,
    'PENDING',
    auth.uid(),
    mp.worker_tag
  )
  returning request_id into rid;

  return rid;
end;
$$;


--
-- Name: enqueue_notification(text, jsonb); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.enqueue_notification(p_event_type text, p_payload jsonb) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
declare
  rid bigint;
begin
  insert into ops.notification_outbox(channel_type, destination, payload)
  select e.channel_type, e.destination,
         jsonb_build_object(
           'event_type', p_event_type,
           'ts', now(),
           'payload', coalesce(p_payload,'{}'::jsonb)
         )
    from system.notification_subscription s
    join system.notification_endpoint e on e.endpoint_code = s.endpoint_code
   where s.event_type = p_event_type
     and s.is_active = true
     and e.is_active = true;

  -- last inserted id is not deterministic if multiple rows; return 0 for "ok"
  rid := 0;
  return rid;
end;
$$;


--
-- Name: enqueue_ops_for_finalized(text, text, bigint, jsonb); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.enqueue_ops_for_finalized(p_function_code text, p_business_table text, p_business_id bigint, p_payload jsonb DEFAULT '{}'::jsonb) RETURNS jsonb
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_doc text;
  v_gen boolean;
  v_send boolean;
  v_job_pdf bigint;
  v_job_send bigint;
BEGIN
  SELECT document_type_code, generate_pdf, auto_send
    INTO v_doc, v_gen, v_send
    FROM system.business_ops_map
   WHERE function_code = p_function_code;

  IF NOT FOUND THEN
    RETURN jsonb_build_object(
      'enqueued', false,
      'reason', 'no business_ops_map for function_code',
      'function_code', p_function_code
    );
  END IF;

  IF v_gen THEN
    v_job_pdf := ops.enqueue_generate_pdf(
      p_function_code, v_doc, p_business_table, p_business_id,
      jsonb_build_object('doc', v_doc, 'business_table', p_business_table, 'business_id', p_business_id) || COALESCE(p_payload,'{}'::jsonb),
      100
    );
  END IF;

  IF v_send THEN
    v_job_send := ops.enqueue_send_document(
      p_function_code, v_doc, p_business_table, p_business_table::text, -- placeholder? NO: must be bigint; use p_business_id
      '{}'::jsonb, 90
    );
    --   insert 
    --     enqueue 
    DELETE FROM ops.ops_job_queue
     WHERE job_id = v_job_send AND business_id IS NULL;

    v_job_send := ops.enqueue_send_document(
      p_function_code, v_doc, p_business_table, p_business_id,
      jsonb_build_object('doc', v_doc, 'business_table', p_business_table, 'business_id', p_business_id) || COALESCE(p_payload,'{}'::jsonb),
      90
    );
  END IF;

  RETURN jsonb_build_object(
    'enqueued', true,
    'function_code', p_function_code,
    'document_type_code', v_doc,
    'job_generate_pdf', v_job_pdf,
    'job_send_document', v_job_send
  );
END;
$$;


--
-- Name: enqueue_ops_for_finalized_business(text, bigint, text, uuid); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.enqueue_ops_for_finalized_business(p_function_code text, p_document_id bigint, p_business_table text, p_actor uuid DEFAULT auth.uid()) RETURNS jsonb
    LANGUAGE plpgsql
    AS $$
declare
  v_doc_type text;
  v_gen boolean;
  v_send boolean;
  v_job_pdf bigint;
  v_job_send bigint;
begin
  select document_type_code, generate_pdf, auto_send
    into v_doc_type, v_gen, v_send
    from system.business_ops_map
   where function_code = p_function_code;

  if v_doc_type is null then
    return jsonb_build_object('ok', false, 'reason', 'business_ops_map_not_found', 'function_code', p_function_code);
  end if;

  -- PDF
  if v_gen then
    v_job_pdf := ops.enqueue_job(
      'GENERATE_PDF',
      jsonb_build_object(
        'function_code', p_function_code,
        'document_type_code', v_doc_type,
        'document_id', p_document_id,
        'business_table', p_business_table
      ),
      now(), 50, 3, p_actor
    );
  end if;

  -- PDF/OK
  if v_send then
    v_job_send := ops.enqueue_job(
      'SEND_DOCUMENT',
      jsonb_build_object(
        'function_code', p_function_code,
        'document_type_code', v_doc_type,
        'document_id', p_document_id,
        'business_table', p_business_table,
        'channels', jsonb_build_array('EMAIL','LINE')  -- 
      ),
      now(), 60, 3, p_actor
    );
  end if;

  return jsonb_build_object(
    'ok', true,
    'pdf_job_id', v_job_pdf,
    'send_job_id', v_job_send
  );
end;
$$;


--
-- Name: finalize_business(text, text, bigint); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.finalize_business(p_function_code text, p_target_table text, p_business_id bigint) RETURNS void
    LANGUAGE plpgsql
    AS $_$
declare
  v_flow_code text;
begin
  -- 
  select m.approval_flow_code
    into v_flow_code
    from system.action_approval_map m
   where m.action_code = 'FINALIZE'
     and m.function_code = p_function_code;

  if v_flow_code is not null then
    insert into system.approval_request(
      approval_flow_code,
      business_table,
      business_id,
      approval_status,
      requested_by
    ) values (
      v_flow_code,
      p_target_table,
      p_business_id,
      'REQUESTED',
      auth.uid()
    );
  else
    execute format(
      'update %s set status = %L where id = $1',
      p_target_table, 'FINALIZED'
    ) using p_business_id;
  end if;

  perform system.log_operation(
    'FINALIZE_REQUEST',
    p_target_table,
    jsonb_build_object('id', p_business_id)
  );
end;
$_$;


--
-- Name: get_active_loop_configs(); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.get_active_loop_configs() RETURNS TABLE(loop_code text, command_code text, interval_sec integer, jitter_sec integer, command_text text, next_run_at timestamp with time zone)
    LANGUAGE sql
    AS $$
  select
    lc.loop_code,
    lc.command_code,
    lc.interval_sec,
    lc.jitter_sec,
    c.command_text,
    lc.next_run_at
  from system.loop_config lc
  join system.exec_command c on c.command_code = lc.command_code
  where lc.is_enabled = true
    and c.is_active = true;
$$;


--
-- Name: get_due_loops(); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.get_due_loops() RETURNS TABLE(loop_code text, command_code text, interval_sec integer, jitter_sec integer, command_text text)
    LANGUAGE sql
    AS $$
  select
    lc.loop_code,
    lc.command_code,
    lc.interval_sec,
    lc.jitter_sec,
    c.command_text
  from system.loop_config lc
  join system.exec_command c on c.command_code = lc.command_code
  where lc.is_enabled = true
    and c.is_active = true
    and coalesce((select is_enabled from system.runtime_killswitch where key='GLOBAL'), false) = false
    and (
      lc.next_run_at is null
      or lc.next_run_at <= now()
    );
$$;


--
-- Name: get_due_loops(timestamp with time zone); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.get_due_loops(p_now timestamp with time zone DEFAULT now()) RETURNS TABLE(loop_code text, command_code text, interval_sec integer, jitter_sec integer, command_text text)
    LANGUAGE sql
    AS $$
  select
    lc.loop_code,
    lc.command_code,
    lc.interval_sec,
    lc.jitter_sec,
    c.command_text
  from system.loop_config lc
  join system.exec_command c on c.command_code = lc.command_code
  where lc.is_enabled = true
    and c.is_active = true
    and (lc.next_run_at is null or lc.next_run_at <= p_now);
$$;


--
-- Name: log_operation(uuid, text, text, text, text, text, text, text, text, text); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.log_operation(p_session_id uuid, p_role_code text, p_module_code text, p_function_code text, p_screen_code text, p_operation_type text, p_target_table text DEFAULT NULL::text, p_target_id text DEFAULT NULL::text, p_operation_status text DEFAULT 'SUCCESS'::text, p_error_message text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  insert into system.operation_log (
    session_id,
    role_code,
    module_code,
    function_code,
    screen_code,
    operation_type,
    target_table,
    target_id,
    operation_status,
    operated_by,
    error_message
  )
  values (
    p_session_id,
    p_role_code,
    p_module_code,
    p_function_code,
    p_screen_code,
    p_operation_type,
    p_target_table,
    p_target_id,
    p_operation_status,
    auth.uid(),
    p_error_message
  );
end;
$$;


--
-- Name: loop_mark_done(text, text); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.loop_mark_done(p_loop_code text, p_note text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  update system.loop_config
     set last_run_at = now(),
         next_run_at = system.calc_next_run_at(now(), interval_sec, jitter_sec),
         updated_at = now()
   where loop_code = p_loop_code;

  insert into system.loop_tick_log(loop_code, tick_status, note) values (p_loop_code,'DONE',p_note);
end;
$$;


--
-- Name: loop_mark_start(text); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.loop_mark_start(p_loop_code text) RETURNS void
    LANGUAGE plpgsql
    AS $$
begin
  insert into system.loop_tick_log(loop_code, tick_status) values (p_loop_code,'START');
end;
$$;


--
-- Name: mark_loop_ran(text, integer, integer); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.mark_loop_ran(p_loop_code text, p_interval_sec integer, p_jitter_sec integer) RETURNS void
    LANGUAGE plpgsql
    AS $$
declare
  j int;
begin
  j := greatest(coalesce(p_jitter_sec,0),0);
  update system.loop_config
     set last_run_at = now(),
         next_run_at = now()
           + (coalesce(p_interval_sec,60) || ' seconds')::interval
           + ((floor(random()*(j+1))::int) || ' seconds')::interval
   where loop_code = p_loop_code;
end;
$$;


--
-- Name: pick_next_ai_task(text); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.pick_next_ai_task(p_agent_code text) RETURNS TABLE(task_id bigint, task_type text, input_json jsonb)
    LANGUAGE plpgsql
    AS $$
declare
  r record;
begin
  for r in
    select *
      from system.ai_task
     where status='PENDING'
       and agent_code=p_agent_code
     order by priority asc, requested_at asc
     for update skip locked
     limit 1
  loop
    update system.ai_task
       set status='RUNNING', started_at=now()
     where task_id=r.task_id;

    insert into system.ai_task_run(task_id, run_status, note)
    values (r.task_id, 'START', null);

    task_id := r.task_id;
    task_type := r.task_type;
    input_json := r.input_json;
    return next;
    return;
  end loop;

  return;
end;
$$;


--
-- Name: pick_next_exec_request(uuid); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.pick_next_exec_request(p_worker_id uuid) RETURNS TABLE(request_id bigint, command_code text, command_text text, args_json_text text, priority integer)
    LANGUAGE plpgsql
    AS $$
begin
  if coalesce((select is_enabled from system.runtime_killswitch where key='GLOBAL'), false) then
    return;
  end if;

  return query
  with picked as (
    select r.request_id
      from system.exec_run_request r
     where r.status = 'PENDING'
     order by r.priority asc, r.requested_at asc
     for update skip locked
     limit 1
  )
  update system.exec_run_request r
     set status='RUNNING',
         picked_by = p_worker_id,
         picked_at = now()
    from picked
   where r.request_id = picked.request_id
  returning
    r.request_id,
    r.command_code,
    (select c.command_text from system.exec_command c where c.command_code=r.command_code),
    r.args_json::text,
    r.priority;
end;
$$;


--
-- Name: pick_next_exec_request(text, text); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.pick_next_exec_request(p_worker_tag text DEFAULT NULL::text, p_command_code text DEFAULT NULL::text) RETURNS TABLE(request_id bigint, command_code text, args_json jsonb, priority integer, rendered_command text)
    LANGUAGE plpgsql
    AS $$
declare
  r record;
  cmd_text text;
begin
  for r in
    select *
      from system.exec_run_request
     where status = 'PENDING'
       and (p_worker_tag is null or worker_tag is null or worker_tag = p_worker_tag)
       and (p_command_code is null or command_code = p_command_code)
     order by priority asc, requested_at asc
     for update skip locked
     limit 1
  loop
    select c.command_text into cmd_text
      from system.exec_command c
     where c.command_code = r.command_code
       and c.is_active = true;

    cmd_text := system.render_command(cmd_text, r.args_json);

    update system.exec_run_request
       set status = 'RUNNING',
           picked_by = auth.uid(),
           picked_at = now(),
           rendered_command = cmd_text
     where request_id = r.request_id;

    request_id := r.request_id;
    command_code := r.command_code;
    args_json := r.args_json;
    priority := r.priority;
    rendered_command := cmd_text;
    return next;
    return;
  end loop;

  return;
end;
$$;


--
-- Name: render_command(text, jsonb); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.render_command(p_command_text text, p_args jsonb) RETURNS text
    LANGUAGE plpgsql
    AS $$
declare
  k text;
  v text;
  out_text text := coalesce(p_command_text,'');
begin
  if p_args is null then
    return out_text;
  end if;

  for k in
    select jsonb_object_keys(p_args)
  loop
    v := coalesce(p_args->>k,'');
    -- replace {{k}} occurrences
    out_text := replace(out_text, '{{' || k || '}}', v);
  end loop;

  return out_text;
end;
$$;


--
-- Name: request_exec(text, jsonb, integer); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.request_exec(p_command_code text, p_args jsonb DEFAULT '{}'::jsonb, p_priority integer DEFAULT 100) RETURNS bigint
    LANGUAGE plpgsql
    AS $$
declare
  rid bigint;
begin
  insert into system.exec_run_request(command_code, args_json, priority, requested_by)
  values (p_command_code, coalesce(p_args,'{}'::jsonb), coalesce(p_priority,100), auth.uid())
  returning request_id into rid;

  return rid;
end;
$$;


--
-- Name: request_exec_simple(text, jsonb, integer); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.request_exec_simple(p_command_code text, p_args jsonb DEFAULT '{}'::jsonb, p_priority integer DEFAULT 100) RETURNS bigint
    LANGUAGE sql
    AS $$
  select system.request_exec(p_command_code, coalesce(p_args,'{}'::jsonb), coalesce(p_priority,100));
$$;


--
-- Name: tg_exec_run_notify(); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.tg_exec_run_notify() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
begin
  if (tg_op = 'UPDATE') then
    if (old.status is distinct from new.status) then
      if new.status = 'DONE' then
        perform system.enqueue_notification(
          'EXEC_DONE',
          jsonb_build_object(
            'request_id', new.request_id,
            'command_code', new.command_code,
            'exit_code', new.exit_code
          )
        );
      elsif new.status = 'FAILED' then
        perform system.enqueue_notification(
          'EXEC_FAILED',
          jsonb_build_object(
            'request_id', new.request_id,
            'command_code', new.command_code,
            'exit_code', new.exit_code,
            'stderr_head', left(coalesce(new.stderr_text,''), 500)
          )
        );
      end if;
    end if;
  end if;
  return new;
end;
$$;


--
-- Name: tg_set_updated_at(); Type: FUNCTION; Schema: system; Owner: -
--

CREATE FUNCTION system.tg_set_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
    begin
      new.updated_at := now();
      return new;
    end;
    $$;


--
-- Name: paper_send_fee_journal; Type: TABLE; Schema: accounting; Owner: -
--

CREATE TABLE accounting.paper_send_fee_journal (
    journal_id bigint NOT NULL,
    send_history_id bigint NOT NULL,
    journal_date date DEFAULT CURRENT_DATE NOT NULL,
    document_type_code text NOT NULL,
    fee_amount numeric NOT NULL,
    currency_code text DEFAULT 'JPY'::text NOT NULL,
    account_code text DEFAULT '8001'::text NOT NULL,
    description text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: paper_send_fee_journal_journal_id_seq; Type: SEQUENCE; Schema: accounting; Owner: -
--

CREATE SEQUENCE accounting.paper_send_fee_journal_journal_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: paper_send_fee_journal_journal_id_seq; Type: SEQUENCE OWNED BY; Schema: accounting; Owner: -
--

ALTER SEQUENCE accounting.paper_send_fee_journal_journal_id_seq OWNED BY accounting.paper_send_fee_journal.journal_id;


--
-- Name: document_send_history; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.document_send_history (
    send_history_id bigint NOT NULL,
    document_type_code text NOT NULL,
    document_id bigint NOT NULL,
    channel_code text NOT NULL,
    resend_type_code text NOT NULL,
    send_fee_amount numeric DEFAULT 0 NOT NULL,
    currency_code text DEFAULT 'JPY'::text NOT NULL,
    send_status text NOT NULL,
    retry_count integer DEFAULT 0 NOT NULL,
    sent_at timestamp with time zone,
    notified_at timestamp with time zone,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    company_id uuid,
    CONSTRAINT document_send_history_send_status_check CHECK ((send_status = ANY (ARRAY['SUCCESS'::text, 'FAILED'::text])))
);


--
-- Name: send_channel_master; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.send_channel_master (
    channel_code text NOT NULL,
    channel_name text NOT NULL,
    is_paper boolean NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_paper_send_fee_posting; Type: VIEW; Schema: accounting; Owner: -
--

CREATE VIEW accounting.v_paper_send_fee_posting AS
 SELECT h.send_history_id,
    h.company_id,
    h.document_type_code,
    h.send_fee_amount AS fee_amount,
    h.currency_code,
    h.created_at AS source_created_at
   FROM (ops.document_send_history h
     JOIN ops.send_channel_master c ON ((c.channel_code = h.channel_code)))
  WHERE ((c.is_paper = true) AND (h.send_fee_amount > (0)::numeric) AND (h.send_status = 'SUCCESS'::text));


--
-- Name: ai_apply_audit; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.ai_apply_audit (
    audit_id uuid DEFAULT gen_random_uuid() NOT NULL,
    job_id uuid NOT NULL,
    company_id uuid,
    action_type text NOT NULL,
    before_state jsonb NOT NULL,
    after_state jsonb NOT NULL,
    applied_by text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ai_event_ai_event_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.ai_event_ai_event_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: ai_event_ai_event_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.ai_event_ai_event_id_seq OWNED BY analytics.ai_event.ai_event_id;


--
-- Name: ai_insight_job; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.ai_insight_job (
    job_id uuid DEFAULT gen_random_uuid() NOT NULL,
    company_id uuid,
    insight_type text NOT NULL,
    target_key text NOT NULL,
    context jsonb NOT NULL,
    status text DEFAULT 'queued'::text NOT NULL,
    result_ja text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    processed_at timestamp with time zone,
    proposed_action jsonb,
    is_applied boolean DEFAULT false NOT NULL,
    applied_at timestamp with time zone,
    applied_by text,
    rollback_of uuid,
    summary_type text,
    confidence numeric
);


--
-- Name: ai_job_ai_job_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.ai_job_ai_job_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: ai_job_ai_job_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.ai_job_ai_job_id_seq OWNED BY analytics.ai_job.ai_job_id;


--
-- Name: ai_job_type_master; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.ai_job_type_master (
    job_type text NOT NULL,
    description text DEFAULT ''::text NOT NULL,
    risk_level text DEFAULT 'low'::text NOT NULL,
    default_requires_approval boolean DEFAULT false NOT NULL,
    is_enabled boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ai_kill_switch; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.ai_kill_switch (
    scope text NOT NULL,
    is_enabled boolean DEFAULT true NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ai_module_manifest; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.ai_module_manifest (
    module_name text NOT NULL,
    summary text DEFAULT ''::text NOT NULL,
    scope text DEFAULT ''::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ai_rate_limit; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.ai_rate_limit (
    job_type text NOT NULL,
    max_per_min integer DEFAULT 30 NOT NULL,
    cooldown_sec integer DEFAULT 60 NOT NULL,
    last_failed_at timestamp with time zone
);


--
-- Name: audit_ai_feedback; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.audit_ai_feedback (
    feedback_id bigint NOT NULL,
    alert_event_id bigint NOT NULL,
    judgement_id bigint,
    feedback_type text NOT NULL,
    comment text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_ai_feedback_feedback_type_check CHECK ((feedback_type = ANY (ARRAY['true_positive'::text, 'false_positive'::text, 'needs_more_info'::text])))
);


--
-- Name: audit_ai_feedback_feedback_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.audit_ai_feedback_feedback_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_ai_feedback_feedback_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.audit_ai_feedback_feedback_id_seq OWNED BY analytics.audit_ai_feedback.feedback_id;


--
-- Name: audit_ai_job; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.audit_ai_job (
    job_id bigint NOT NULL,
    alert_event_id bigint NOT NULL,
    status text DEFAULT 'queued'::text NOT NULL,
    last_error text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    started_at timestamp with time zone,
    finished_at timestamp with time zone,
    retry_count integer DEFAULT 0 NOT NULL,
    CONSTRAINT audit_ai_job_status_check CHECK ((status = ANY (ARRAY['queued'::text, 'processing'::text, 'done'::text, 'failed'::text, 'skipped'::text])))
);


--
-- Name: audit_ai_job_job_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.audit_ai_job_job_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_ai_job_job_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.audit_ai_job_job_id_seq OWNED BY analytics.audit_ai_job.job_id;


--
-- Name: audit_ai_llm_result; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.audit_ai_llm_result (
    llm_result_id bigint NOT NULL,
    alert_event_id bigint NOT NULL,
    judgement_json jsonb NOT NULL,
    model_name text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: audit_ai_llm_result_llm_result_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.audit_ai_llm_result_llm_result_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_ai_llm_result_llm_result_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.audit_ai_llm_result_llm_result_id_seq OWNED BY analytics.audit_ai_llm_result.llm_result_id;


--
-- Name: audit_alert_ai_judgement; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.audit_alert_ai_judgement (
    judgement_id bigint NOT NULL,
    alert_event_id bigint NOT NULL,
    is_anomaly boolean NOT NULL,
    confidence numeric(4,3) NOT NULL,
    judgement_reason text NOT NULL,
    decided_by text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_alert_ai_judgement_confidence_check CHECK (((confidence >= (0)::numeric) AND (confidence <= (1)::numeric))),
    CONSTRAINT audit_alert_ai_judgement_decided_by_check CHECK ((decided_by = ANY (ARRAY['rule'::text, 'ai'::text, 'human'::text])))
);


--
-- Name: audit_alert_ai_judgement_judgement_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.audit_alert_ai_judgement_judgement_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_alert_ai_judgement_judgement_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.audit_alert_ai_judgement_judgement_id_seq OWNED BY analytics.audit_alert_ai_judgement.judgement_id;


--
-- Name: audit_alert_event; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.audit_alert_event (
    alert_event_id bigint NOT NULL,
    rule_id bigint NOT NULL,
    company_id uuid NOT NULL,
    window_start timestamp with time zone NOT NULL,
    window_end timestamp with time zone NOT NULL,
    matched_count integer NOT NULL,
    severity integer NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_alert_event_matched_count_check CHECK ((matched_count >= 0)),
    CONSTRAINT audit_alert_event_severity_check CHECK ((severity >= 0))
);


--
-- Name: audit_alert_event_alert_event_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.audit_alert_event_alert_event_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_alert_event_alert_event_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.audit_alert_event_alert_event_id_seq OWNED BY analytics.audit_alert_event.alert_event_id;


--
-- Name: audit_alert_notification; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.audit_alert_notification (
    notification_id bigint NOT NULL,
    alert_event_id bigint NOT NULL,
    channel_type text NOT NULL,
    destination text NOT NULL,
    status text NOT NULL,
    retry_count integer DEFAULT 0 NOT NULL,
    last_error text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    sent_at timestamp with time zone,
    CONSTRAINT audit_alert_notification_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'sent'::text, 'failed'::text, 'skipped'::text])))
);


--
-- Name: audit_alert_notification_notification_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.audit_alert_notification_notification_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_alert_notification_notification_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.audit_alert_notification_notification_id_seq OWNED BY analytics.audit_alert_notification.notification_id;


--
-- Name: audit_alert_rule; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.audit_alert_rule (
    rule_id bigint NOT NULL,
    company_id uuid NOT NULL,
    rule_name text NOT NULL,
    is_enabled boolean DEFAULT true NOT NULL,
    window_seconds integer NOT NULL,
    threshold_count integer NOT NULL,
    table_name_like text,
    actions text[],
    severity_base integer NOT NULL,
    severity_cap integer NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_alert_rule_check CHECK ((severity_cap >= severity_base)),
    CONSTRAINT audit_alert_rule_severity_base_check CHECK ((severity_base >= 0)),
    CONSTRAINT audit_alert_rule_threshold_count_check CHECK ((threshold_count > 0)),
    CONSTRAINT audit_alert_rule_window_seconds_check CHECK ((window_seconds > 0))
);


--
-- Name: audit_alert_rule_rule_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.audit_alert_rule_rule_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_alert_rule_rule_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.audit_alert_rule_rule_id_seq OWNED BY analytics.audit_alert_rule.rule_id;


--
-- Name: fact_metric; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.fact_metric (
    fact_id bigint NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text,
    metric_code text NOT NULL,
    metric_date date NOT NULL,
    metric_value numeric(18,4) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY analytics.fact_metric FORCE ROW LEVEL SECURITY;


--
-- Name: fact_metric_fact_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.fact_metric_fact_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: fact_metric_fact_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.fact_metric_fact_id_seq OWNED BY analytics.fact_metric.fact_id;


--
-- Name: notification_queue_notification_id_seq; Type: SEQUENCE; Schema: analytics; Owner: -
--

CREATE SEQUENCE analytics.notification_queue_notification_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: notification_queue_notification_id_seq; Type: SEQUENCE OWNED BY; Schema: analytics; Owner: -
--

ALTER SEQUENCE analytics.notification_queue_notification_id_seq OWNED BY analytics.notification_queue.notification_id;


--
-- Name: sla_breach_event; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.sla_breach_event (
    breach_id uuid DEFAULT gen_random_uuid() NOT NULL,
    domain text NOT NULL,
    p90_seconds integer NOT NULL,
    threshold_seconds integer NOT NULL,
    severity text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: sla_definition; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.sla_definition (
    domain text NOT NULL,
    threshold_seconds integer NOT NULL,
    severity text DEFAULT 'warn'::text NOT NULL
);


--
-- Name: sla_escalation_target; Type: TABLE; Schema: analytics; Owner: -
--

CREATE TABLE analytics.sla_escalation_target (
    domain text NOT NULL,
    channel_type text NOT NULL,
    destination text NOT NULL,
    severity text DEFAULT 'critical'::text NOT NULL
);


--
-- Name: policy_change_queue; Type: TABLE; Schema: governance; Owner: -
--

CREATE TABLE governance.policy_change_queue (
    policy_change_id bigint NOT NULL,
    source_alert_event_id bigint,
    policy_key text NOT NULL,
    proposed_action text NOT NULL,
    proposed_value jsonb NOT NULL,
    confidence numeric(4,3) NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    approved_at timestamp with time zone
);


--
-- Name: v_admin_alert_review; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_admin_alert_review AS
 SELECT e.alert_event_id,
    e.company_id,
    e.window_start,
    e.window_end,
    e.severity,
    e.matched_count,
    j.is_anomaly,
    j.confidence,
    j.judgement_reason,
    j.decided_by,
    p.policy_change_id,
    p.policy_key,
    p.proposed_action,
    p.proposed_value,
    p.status AS policy_status,
    p.created_at AS policy_created_at,
    COALESCE(job.status, 'none'::text) AS ai_job_status
   FROM (((analytics.audit_alert_event e
     LEFT JOIN analytics.audit_alert_ai_judgement j ON ((j.alert_event_id = e.alert_event_id)))
     LEFT JOIN governance.policy_change_queue p ON ((p.source_alert_event_id = e.alert_event_id)))
     LEFT JOIN analytics.audit_ai_job job ON ((job.alert_event_id = e.alert_event_id)));


--
-- Name: schema_change_request; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.schema_change_request (
    request_id uuid DEFAULT gen_random_uuid() NOT NULL,
    schema_name text NOT NULL,
    requested_by text NOT NULL,
    diff_summary text NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    requested_at timestamp with time zone DEFAULT now() NOT NULL,
    approved_by text,
    approved_at timestamp with time zone,
    review_status text DEFAULT 'pending'::text NOT NULL,
    review_summary text,
    reviewed_at timestamp with time zone,
    domain text,
    review_summary_ja text,
    company_id uuid
);


--
-- Name: v_ai_approval_opt_candidate; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_approval_opt_candidate AS
 SELECT COALESCE(company_id, '00000000-0000-0000-0000-000000000000'::uuid) AS company_id,
    domain,
    schema_name,
    count(*) AS approved_count
   FROM ci.schema_change_request
  WHERE ((status = 'approved'::text) AND (approved_at >= (now() - '30 days'::interval)))
  GROUP BY COALESCE(company_id, '00000000-0000-0000-0000-000000000000'::uuid), domain, schema_name
 HAVING (count(*) >= 30);


--
-- Name: v_ai_feedback_stats; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_feedback_stats AS
 SELECT e.rule_id,
    count(*) AS feedback_count,
    count(*) FILTER (WHERE (f.feedback_type = 'false_positive'::text)) AS false_positive_count,
    round(((count(*) FILTER (WHERE (f.feedback_type = 'false_positive'::text)))::numeric / (NULLIF(count(*), 0))::numeric), 3) AS false_positive_rate
   FROM (analytics.audit_ai_feedback f
     JOIN analytics.audit_alert_event e ON ((e.alert_event_id = f.alert_event_id)))
  GROUP BY e.rule_id;


--
-- Name: v_ai_feedback_stats_ext; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_feedback_stats_ext AS
 SELECT e.rule_id,
    e.severity,
    count(*) AS feedback_count,
    count(*) FILTER (WHERE (f.feedback_type = 'false_positive'::text)) AS false_positive_count,
    round(((count(*) FILTER (WHERE (f.feedback_type = 'false_positive'::text)))::numeric / (NULLIF(count(*), 0))::numeric), 3) AS false_positive_rate,
    count(*) FILTER (WHERE (f.feedback_type = 'true_positive'::text)) AS true_positive_count
   FROM (analytics.audit_ai_feedback f
     JOIN analytics.audit_alert_event e ON ((e.alert_event_id = f.alert_event_id)))
  GROUP BY e.rule_id, e.severity;


--
-- Name: v_ai_insight_actionable; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_insight_actionable AS
 SELECT job_id,
    company_id,
    insight_type,
    target_key,
    result_ja,
    proposed_action,
    created_at
   FROM analytics.ai_insight_job
  WHERE ((status = 'done'::text) AND (is_applied = false))
  ORDER BY created_at DESC;


--
-- Name: v_ai_insight_applied; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_insight_applied AS
 SELECT j.job_id,
    j.company_id,
    j.insight_type,
    j.target_key,
    j.applied_at,
    j.applied_by,
    a.audit_id,
    a.action_type,
    a.before_state,
    a.after_state
   FROM (analytics.ai_insight_job j
     JOIN analytics.ai_apply_audit a ON ((a.job_id = j.job_id)))
  WHERE (j.is_applied = true)
  ORDER BY j.applied_at DESC;


--
-- Name: company; Type: TABLE; Schema: tenant; Owner: -
--

CREATE TABLE tenant.company (
    company_id uuid DEFAULT gen_random_uuid() NOT NULL,
    company_code text NOT NULL,
    company_name text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_ai_insight_outbox; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_insight_outbox AS
 SELECT j.job_id,
    j.company_id,
    c.company_code,
    j.insight_type,
    j.target_key,
    j.result_ja,
    j.status,
    j.created_at,
    j.processed_at
   FROM (analytics.ai_insight_job j
     LEFT JOIN tenant.company c ON ((c.company_id = j.company_id)))
  WHERE (j.status = 'done'::text)
  ORDER BY j.processed_at DESC;


--
-- Name: v_ai_job_stats; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_job_stats AS
 SELECT job_type,
    count(*) FILTER (WHERE (status = 'pending'::text)) AS pending,
    count(*) FILTER (WHERE (status = 'done'::text)) AS done,
    count(*) FILTER (WHERE (status = 'failed'::text)) AS failed
   FROM analytics.ai_job
  GROUP BY job_type;


--
-- Name: v_ai_job_type_master; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_job_type_master AS
 SELECT job_type,
    description,
    risk_level,
    default_requires_approval,
    is_enabled,
    updated_at
   FROM analytics.ai_job_type_master
  ORDER BY job_type;


--
-- Name: v_ai_module_manifest; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_module_manifest AS
 SELECT module_name,
    summary,
    scope,
    updated_at
   FROM analytics.ai_module_manifest
  ORDER BY module_name;


--
-- Name: v_ai_object_inventory; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_object_inventory AS
 WITH tbl AS (
         SELECT 'table'::text AS object_type,
            n.nspname AS schema_name,
            c.relname AS object_name
           FROM (pg_class c
             JOIN pg_namespace n ON ((n.oid = c.relnamespace)))
          WHERE ((n.nspname = 'analytics'::name) AND (c.relkind = 'r'::"char"))
        ), vw AS (
         SELECT 'view'::text AS object_type,
            n.nspname AS schema_name,
            c.relname AS object_name
           FROM (pg_class c
             JOIN pg_namespace n ON ((n.oid = c.relnamespace)))
          WHERE ((n.nspname = 'analytics'::name) AND (c.relkind = 'v'::"char"))
        ), fn AS (
         SELECT 'function'::text AS object_type,
            n.nspname AS schema_name,
            p.proname AS object_name
           FROM (pg_proc p
             JOIN pg_namespace n ON ((n.oid = p.pronamespace)))
          WHERE (n.nspname = ANY (ARRAY['public'::name, 'analytics'::name]))
        )
 SELECT tbl.object_type,
    tbl.schema_name,
    tbl.object_name
   FROM tbl
UNION ALL
 SELECT vw.object_type,
    vw.schema_name,
    vw.object_name
   FROM vw
UNION ALL
 SELECT fn.object_type,
    fn.schema_name,
    fn.object_name
   FROM fn
  ORDER BY 1, 2, 3;


--
-- Name: v_ai_rule_suggest; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_rule_suggest AS
 SELECT domain,
    ((count(*) FILTER (WHERE (status = 'rejected'::text)))::numeric / (NULLIF(count(*), 0))::numeric) AS reject_rate
   FROM ci.schema_change_request
  GROUP BY domain
 HAVING (((count(*) FILTER (WHERE (status = 'rejected'::text)))::numeric / (NULLIF(count(*), 0))::numeric) > 0.4);


--
-- Name: v_domain_sla; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_domain_sla AS
 SELECT domain,
    count(*) AS request_count,
    percentile_cont((0.5)::double precision) WITHIN GROUP (ORDER BY ((EXTRACT(epoch FROM (approved_at - requested_at)))::double precision)) FILTER (WHERE (approved_at IS NOT NULL)) AS p50_seconds,
    percentile_cont((0.9)::double precision) WITHIN GROUP (ORDER BY ((EXTRACT(epoch FROM (approved_at - requested_at)))::double precision)) FILTER (WHERE (approved_at IS NOT NULL)) AS p90_seconds
   FROM ci.schema_change_request r
  GROUP BY domain;


--
-- Name: v_ai_sla_risk; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ai_sla_risk AS
 SELECT domain,
    p90_seconds
   FROM analytics.v_domain_sla
  WHERE (p90_seconds > (3600)::double precision);


--
-- Name: v_approval_backlog; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_approval_backlog AS
 SELECT domain,
    count(*) AS pending_count,
    min(requested_at) AS oldest_request
   FROM ci.schema_change_request
  WHERE (status = 'pending'::text)
  GROUP BY domain
  ORDER BY (count(*)) DESC;


--
-- Name: v_approval_sla; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_approval_sla AS
 SELECT domain,
    (percentile_cont((0.9)::double precision) WITHIN GROUP (ORDER BY ((EXTRACT(epoch FROM (COALESCE(decided_at, now()) - detected_at)))::double precision)))::integer AS p90_seconds
   FROM audit.approval_request r
  GROUP BY domain;


--
-- Name: audit_trail; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_trail (
    audit_trail_id bigint NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    action text NOT NULL,
    action_category text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    performed_by uuid,
    performed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_trail_action_category_check CHECK ((action_category = ANY (ARRAY['READ'::text, 'WRITE'::text, 'ADMIN'::text])))
)
PARTITION BY RANGE (performed_at);

ALTER TABLE ONLY core.audit_trail FORCE ROW LEVEL SECURITY;


--
-- Name: v_audit_daily_count; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_daily_count AS
 SELECT company_id,
    split_part(entity_type, '.'::text, 1) AS domain,
    action,
    (performed_at)::date AS audit_date,
    count(*) AS change_count
   FROM core.audit_trail
  GROUP BY company_id, (split_part(entity_type, '.'::text, 1)), action, ((performed_at)::date);


--
-- Name: v_audit_daily_summary; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_daily_summary AS
 SELECT company_id,
    (date_trunc('day'::text, performed_at))::date AS day,
    action_category,
    count(*) AS cnt
   FROM core.audit_trail
  GROUP BY company_id, ((date_trunc('day'::text, performed_at))::date), action_category;


--
-- Name: v_audit_dashboard; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_dashboard AS
 SELECT date_trunc('hour'::text, performed_at) AS time_bucket,
    company_id,
    entity_type,
    action,
    count(*) AS change_count,
    avg(core.fn_calc_audit_impact(company_id, entity_type, action, detail)) AS avg_impact_score,
    max(core.fn_calc_audit_impact(company_id, entity_type, action, detail)) AS max_impact_score
   FROM core.audit_trail at
  GROUP BY (date_trunc('hour'::text, performed_at)), company_id, entity_type, action;


--
-- Name: VIEW v_audit_dashboard; Type: COMMENT; Schema: analytics; Owner: -
--

COMMENT ON VIEW analytics.v_audit_dashboard IS ' impact_score';


--
-- Name: v_audit_dashboard_daily; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_dashboard_daily AS
 SELECT company_id,
    date_trunc('day'::text, performed_at) AS day,
    entity_type,
    action,
    count(*) AS change_count,
    avg(core.fn_calc_audit_impact(company_id, entity_type, action, detail)) AS avg_impact,
    max(core.fn_calc_audit_impact(company_id, entity_type, action, detail)) AS max_impact
   FROM core.audit_trail at
  GROUP BY company_id, (date_trunc('day'::text, performed_at)), entity_type, action;


--
-- Name: v_audit_export; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_export AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    action_category,
    detail,
    performed_by,
    performed_at
   FROM core.audit_trail;


--
-- Name: v_audit_reason_kpi; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_reason_kpi AS
 SELECT company_id,
    (detail ->> 'reason_code'::text) AS reason_code,
    action,
    count(*) AS change_count
   FROM core.audit_trail
  WHERE (detail ? 'reason_code'::text)
  GROUP BY company_id, (detail ->> 'reason_code'::text), action;


--
-- Name: v_audit_summary_report; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_summary_report AS
 SELECT company_id,
    date_trunc('day'::text, performed_at) AS day,
    count(*) AS total_changes,
    sum(
        CASE
            WHEN (action = 'DELETE'::text) THEN 1
            ELSE 0
        END) AS deletes,
    sum(
        CASE
            WHEN (core.fn_calc_audit_impact(company_id, entity_type, action, detail) >= (5)::numeric) THEN 1
            ELSE 0
        END) AS high_impact_changes,
    count(DISTINCT performed_by) AS distinct_actors
   FROM core.audit_trail at
  GROUP BY company_id, (date_trunc('day'::text, performed_at));


--
-- Name: v_audit_table_rank; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_table_rank AS
 SELECT company_id,
    entity_type,
    count(*) AS change_count
   FROM core.audit_trail
  GROUP BY company_id, entity_type;


--
-- Name: v_audit_top_impact; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_top_impact AS
 SELECT audit_trail_id,
    company_id,
    performed_at,
    entity_type,
    entity_id,
    action,
    performed_by,
    core.fn_calc_audit_impact(company_id, entity_type, action, detail) AS impact_score,
    detail
   FROM core.audit_trail at
  ORDER BY (core.fn_calc_audit_impact(company_id, entity_type, action, detail)) DESC, performed_at DESC;


--
-- Name: v_audit_user_activity; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_user_activity AS
 SELECT company_id,
    performed_by,
    count(*) AS change_count,
    max(performed_at) AS last_activity
   FROM core.audit_trail
  GROUP BY company_id, performed_by;


--
-- Name: v_audit_with_impact; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_audit_with_impact AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    performed_by,
    performed_at,
    detail,
    core.fn_calc_audit_impact(company_id, entity_type, action, detail) AS impact_score
   FROM core.audit_trail at;


--
-- Name: v_ops_overview; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ops_overview AS
 SELECT domain,
    count(*) FILTER (WHERE (status = 'pending'::text)) AS pending_count,
    count(*) FILTER (WHERE (status = 'approved'::text)) AS approved_count,
    count(*) FILTER (WHERE (status = 'rejected'::text)) AS rejected_count,
    max(detected_at) AS last_detected_at,
    max(decided_at) AS last_decided_at
   FROM audit.approval_request r
  GROUP BY domain;


--
-- Name: v_sla_status; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_sla_status AS
 SELECT d.domain,
    v.p90_seconds,
    d.threshold_seconds,
        CASE
            WHEN (v.p90_seconds > d.threshold_seconds) THEN 'breach'::text
            ELSE 'ok'::text
        END AS sla_status
   FROM (analytics.v_approval_sla v
     JOIN analytics.sla_definition d USING (domain));


--
-- Name: v_final_ops_dashboard; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_final_ops_dashboard AS
 SELECT o.domain,
    o.pending_count,
    o.approved_count,
    o.rejected_count,
    s.sla_status,
    s.p90_seconds,
    s.threshold_seconds
   FROM (analytics.v_ops_overview o
     JOIN analytics.v_sla_status s USING (domain));


--
-- Name: v_iso_process_change_report; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_iso_process_change_report AS
 SELECT company_id,
    performed_at,
    performed_by,
    entity_type,
    entity_id,
    action,
    core.fn_calc_audit_impact(company_id, entity_type, action, detail) AS impact_score,
    detail
   FROM core.audit_trail at
  WHERE ((entity_type ~~ 'manufacturing.%'::text) OR (entity_type ~~ 'compliance.%'::text) OR (entity_type ~~ 'quality.%'::text))
  ORDER BY performed_at DESC;


--
-- Name: v_ops_kpi; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_ops_kpi AS
 SELECT d.domain,
    d.request_count,
    d.p50_seconds,
    d.p90_seconds,
    b.pending_count,
    b.oldest_request
   FROM (analytics.v_domain_sla d
     LEFT JOIN analytics.v_approval_backlog b ON ((b.domain = d.domain)));


--
-- Name: v_sox_access_change_report; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_sox_access_change_report AS
 SELECT company_id,
    performed_at,
    performed_by,
    entity_type,
    entity_id,
    action,
    core.fn_calc_audit_impact(company_id, entity_type, action, detail) AS impact_score,
    detail
   FROM core.audit_trail at
  WHERE ((entity_type ~~ 'core.permission%'::text) OR (entity_type ~~ 'core.user_%'::text) OR (entity_type ~~ 'core.company_%'::text))
  ORDER BY performed_at DESC;


--
-- Name: v_sox_financial_change_report; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_sox_financial_change_report AS
 SELECT company_id,
    performed_at,
    performed_by,
    entity_type,
    entity_id,
    action,
    core.fn_calc_audit_impact(company_id, entity_type, action, detail) AS impact_score,
    detail
   FROM core.audit_trail at
  WHERE ((entity_type ~~ 'finance.%'::text) OR ((entity_type ~~ 'sales.%'::text) AND ((detail)::text ~~* '%amount%'::text)) OR ((entity_type ~~ 'purchase.%'::text) AND ((detail)::text ~~* '%amount%'::text)))
  ORDER BY performed_at DESC;


--
-- Name: v_sox_iso_audit_report; Type: VIEW; Schema: analytics; Owner: -
--

CREATE VIEW analytics.v_sox_iso_audit_report AS
 SELECT audit_trail_id,
    performed_at,
    company_id,
    entity_type,
    entity_id,
    action,
    performed_by,
    core.fn_calc_audit_impact(company_id, entity_type, action, detail) AS impact_score,
    (detail ->> 'reason_code'::text) AS reason_code,
    (detail -> 'before'::text) AS before_snapshot,
    (detail -> 'after'::text) AS after_snapshot
   FROM core.audit_trail at
  WHERE ((entity_type ~~ 'finance.%'::text) OR (entity_type ~~ 'core.permission%'::text) OR (entity_type ~~ 'hr.%'::text) OR (entity_type ~~ 'core.company%'::text) OR (entity_type ~~ 'sales.%'::text) OR (entity_type ~~ 'purchase.%'::text));


--
-- Name: VIEW v_sox_iso_audit_report; Type: COMMENT; Schema: analytics; Owner: -
--

COMMENT ON VIEW analytics.v_sox_iso_audit_report IS 'SOX / ISO  VIEW';


--
-- Name: ai_improvement_proposal; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.ai_improvement_proposal (
    proposal_id uuid DEFAULT gen_random_uuid() NOT NULL,
    request_id text NOT NULL,
    policy_id text NOT NULL,
    severity text NOT NULL,
    sla_minutes numeric NOT NULL,
    ai_summary text NOT NULL,
    ai_suggestion text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: approver; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.approver (
    company_id uuid NOT NULL,
    user_id uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: billing_customer; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.billing_customer (
    customer_code text NOT NULL,
    billing_email text NOT NULL,
    stripe_customer_id text
);


--
-- Name: billing_invoice; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.billing_invoice (
    invoice_id uuid DEFAULT gen_random_uuid() NOT NULL,
    customer_code text NOT NULL,
    ym text NOT NULL,
    amount_yen numeric NOT NULL,
    status text DEFAULT 'draft'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT billing_invoice_status_check CHECK ((status = ANY (ARRAY['draft'::text, 'issued'::text, 'paid'::text, 'failed'::text])))
);


--
-- Name: billing_payment; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.billing_payment (
    payment_id uuid DEFAULT gen_random_uuid() NOT NULL,
    invoice_id uuid NOT NULL,
    provider text NOT NULL,
    provider_ref text,
    amount_yen numeric NOT NULL,
    status text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT billing_payment_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'succeeded'::text, 'failed'::text])))
);


--
-- Name: company_cost; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.company_cost (
    company_id uuid NOT NULL,
    cost_per_hour numeric NOT NULL
);


--
-- Name: company_plan; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.company_plan (
    company_id uuid NOT NULL,
    plan_code text NOT NULL,
    started_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: feature_flag; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.feature_flag (
    company_id uuid NOT NULL,
    feature_key text NOT NULL,
    is_enabled boolean DEFAULT false NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: invoice_delivery_log; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.invoice_delivery_log (
    delivery_id uuid DEFAULT gen_random_uuid() NOT NULL,
    invoice_id uuid NOT NULL,
    to_email text NOT NULL,
    channel text DEFAULT 'email'::text NOT NULL,
    status text DEFAULT 'queued'::text NOT NULL,
    sent_at timestamp with time zone,
    last_error text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT invoice_delivery_log_channel_check CHECK ((channel = 'email'::text)),
    CONSTRAINT invoice_delivery_log_status_check CHECK ((status = ANY (ARRAY['queued'::text, 'sent'::text, 'failed'::text])))
);


--
-- Name: jsox_control; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.jsox_control (
    control_id uuid DEFAULT gen_random_uuid() NOT NULL,
    control_code text NOT NULL,
    control_name text NOT NULL,
    objective text NOT NULL,
    frequency text NOT NULL,
    owner_role text NOT NULL,
    evidence text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: jsox_evidence_log; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.jsox_evidence_log (
    evidence_id uuid DEFAULT gen_random_uuid() NOT NULL,
    control_code text NOT NULL,
    company_id uuid,
    evidence_ref text NOT NULL,
    period_from date,
    period_to date,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: lp_copy_i18n; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.lp_copy_i18n (
    lang text NOT NULL,
    copy_key text NOT NULL,
    text text NOT NULL,
    CONSTRAINT lp_copy_i18n_lang_check CHECK ((lang = ANY (ARRAY['ja'::text, 'en'::text])))
);


--
-- Name: payment_provider; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.payment_provider (
    provider_code text NOT NULL,
    provider_name text NOT NULL,
    webhook_hint text
);


--
-- Name: plan_master; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.plan_master (
    plan_code text NOT NULL,
    max_companies integer NOT NULL,
    max_requests_per_month integer NOT NULL,
    max_policies integer NOT NULL
);


--
-- Name: policy_activation_log; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.policy_activation_log (
    log_id uuid DEFAULT gen_random_uuid() NOT NULL,
    auto_policy_id uuid NOT NULL,
    activated_at timestamp with time zone DEFAULT now() NOT NULL,
    activated_by text DEFAULT 'ai-auto'::text NOT NULL
);


--
-- Name: policy_auto_generated; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.policy_auto_generated (
    auto_policy_id uuid DEFAULT gen_random_uuid() NOT NULL,
    source_policy_id text NOT NULL,
    generated_rule jsonb NOT NULL,
    confidence_score numeric NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    activated boolean DEFAULT false NOT NULL
);


--
-- Name: policy_eval_event; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.policy_eval_event (
    eval_id uuid DEFAULT gen_random_uuid() NOT NULL,
    auto_policy_id uuid NOT NULL,
    company_id uuid,
    order_id bigint,
    entity_id text,
    outcome text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT policy_eval_event_outcome_check CHECK ((outcome = ANY (ARRAY['ok'::text, 'bad'::text])))
);


--
-- Name: policy_rollout; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.policy_rollout (
    auto_policy_id uuid NOT NULL,
    company_id uuid,
    rollout_percent integer DEFAULT 0 NOT NULL,
    status text DEFAULT 'staged'::text NOT NULL,
    min_confidence numeric DEFAULT 0.85 NOT NULL,
    max_error_rate numeric DEFAULT 0.05 NOT NULL,
    min_samples integer DEFAULT 30 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT policy_rollout_rollout_percent_check CHECK ((rollout_percent = ANY (ARRAY[0, 10, 50, 100]))),
    CONSTRAINT policy_rollout_status_check CHECK ((status = ANY (ARRAY['staged'::text, 'active'::text, 'paused'::text, 'rolled_back'::text])))
);


--
-- Name: policy_rollout_log; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.policy_rollout_log (
    log_id uuid DEFAULT gen_random_uuid() NOT NULL,
    auto_policy_id uuid NOT NULL,
    action text NOT NULL,
    from_percent integer,
    to_percent integer,
    reason text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: public_pricing; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.public_pricing (
    plan_code text NOT NULL,
    plan_name text NOT NULL,
    monthly_yen numeric NOT NULL,
    description text NOT NULL,
    features text NOT NULL
);


--
-- Name: rework_task; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.rework_task (
    task_id uuid DEFAULT gen_random_uuid() NOT NULL,
    auto_policy_id uuid NOT NULL,
    company_id uuid,
    order_id bigint,
    entity_id text,
    reason text NOT NULL,
    status text DEFAULT 'open'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    closed_at timestamp with time zone,
    CONSTRAINT rework_task_status_check CHECK ((status = ANY (ARRAY['open'::text, 'closed'::text])))
);


--
-- Name: saas_company_map; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.saas_company_map (
    subscription_id uuid NOT NULL,
    company_id uuid NOT NULL
);


--
-- Name: saas_plan; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.saas_plan (
    plan_code text NOT NULL,
    plan_name text NOT NULL,
    monthly_yen numeric NOT NULL,
    features jsonb DEFAULT '{}'::jsonb NOT NULL
);


--
-- Name: saas_plan_limit; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.saas_plan_limit (
    plan_code text NOT NULL,
    max_companies integer,
    max_approvals_mo integer,
    max_users integer,
    price_yen_mo numeric NOT NULL
);


--
-- Name: saas_subscription; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.saas_subscription (
    subscription_id uuid DEFAULT gen_random_uuid() NOT NULL,
    company_id uuid NOT NULL,
    plan_code text NOT NULL,
    status text DEFAULT 'active'::text NOT NULL,
    started_at timestamp with time zone DEFAULT now() NOT NULL,
    ended_at timestamp with time zone,
    CONSTRAINT saas_subscription_status_check CHECK ((status = ANY (ARRAY['active'::text, 'paused'::text, 'canceled'::text])))
);


--
-- Name: saas_usage_daily; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.saas_usage_daily (
    company_id uuid NOT NULL,
    day date NOT NULL,
    approvals integer DEFAULT 0 NOT NULL,
    auto_approves integer DEFAULT 0 NOT NULL,
    rollbacks integer DEFAULT 0 NOT NULL
);


--
-- Name: saas_usage_monthly; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.saas_usage_monthly (
    subscription_id uuid NOT NULL,
    ym text NOT NULL,
    approvals_count integer DEFAULT 0 NOT NULL
);


--
-- Name: stripe_webhook_event; Type: TABLE; Schema: approval; Owner: -
--

CREATE TABLE approval.stripe_webhook_event (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    event_id text NOT NULL,
    event_type text NOT NULL,
    payload jsonb NOT NULL,
    received_at timestamp with time zone DEFAULT now() NOT NULL,
    processed_at timestamp with time zone,
    process_status text DEFAULT 'received'::text NOT NULL,
    last_error text,
    CONSTRAINT stripe_webhook_event_process_status_check CHECK ((process_status = ANY (ARRAY['received'::text, 'processed'::text, 'failed'::text])))
);


--
-- Name: order_detail; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.order_detail (
    order_detail_id bigint NOT NULL,
    order_id bigint NOT NULL,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL,
    unit_price numeric(18,2) NOT NULL,
    amount numeric(18,2) NOT NULL,
    requested_ship_date date
);


--
-- Name: v_order_summary; Type: VIEW; Schema: sales; Owner: -
--

CREATE VIEW sales.v_order_summary AS
 SELECT oh.order_id,
    oh.order_no,
    oh.company_id,
    COALESCE(sum(od.amount), (0)::numeric) AS total_amount,
    COALESCE(sum(od.qty), (0)::numeric) AS total_qty
   FROM (sales.order_header oh
     LEFT JOIN sales.order_detail od ON ((od.order_id = oh.order_id)))
  GROUP BY oh.order_id, oh.order_no, oh.company_id;


--
-- Name: v_ai_improvement_input; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_ai_improvement_input AS
 SELECT ar.request_id,
    ar.policy_id,
    ar.severity,
    ar.status,
    ar.reason,
    (EXTRACT(epoch FROM (ar.decided_at - ar.detected_at)) / 60.0) AS sla_minutes,
    os.order_no,
    os.total_amount,
    os.total_qty
   FROM (audit.approval_request ar
     LEFT JOIN sales.v_order_summary os ON ((os.order_id = ar.order_id)))
  WHERE ((ar.reason IS NOT NULL) AND (ar.decided_at IS NOT NULL));


--
-- Name: v_ai_llm_input; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_ai_llm_input AS
 SELECT ar.request_id,
    ar.policy_id,
    ar.severity,
    ar.reason,
    (EXTRACT(epoch FROM (ar.decided_at - ar.detected_at)) / 60.0) AS sla_minutes,
    os.total_amount,
    os.total_qty
   FROM (audit.approval_request ar
     LEFT JOIN sales.v_order_summary os ON ((os.order_id = ar.order_id)))
  WHERE ((ar.status = ANY (ARRAY['approved'::text, 'rejected'::text])) AND (ar.decided_at IS NOT NULL) AND (ar.reason IS NOT NULL));


--
-- Name: audit_trail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.audit_trail AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    action_category,
    detail,
    performed_by,
    performed_at
   FROM core.audit_trail;


--
-- Name: v_audit_action_classified; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_audit_action_classified AS
 SELECT entity_id,
    performed_at,
    performed_by,
        CASE
            WHEN (detail ? 'price'::text) THEN 'price_change'::text
            WHEN (detail ? 'qty'::text) THEN 'qty_change'::text
            WHEN (detail ? 'amount'::text) THEN 'amount_change'::text
            ELSE 'other_update'::text
        END AS action_type
   FROM public.audit_trail at
  WHERE (action = 'update'::text);


--
-- Name: v_ai_override_audit_report; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_ai_override_audit_report AS
 SELECT ar.request_id,
    ar.company_id,
    ar.order_id,
    ar.policy_id,
    pe.auto_policy_id,
    ac.action_type AS override_reason,
    ac.performed_by AS overridden_by,
    ac.performed_at AS overridden_at,
    ar.decided_at AS ai_decided_at
   FROM ((audit.approval_request ar
     JOIN approval.policy_eval_event pe ON ((pe.order_id = ar.order_id)))
     JOIN approval.v_audit_action_classified ac ON ((ac.entity_id = (ar.order_id)::text)))
  WHERE ((pe.outcome = 'ok'::text) AND (ac.performed_at > ar.decided_at));


--
-- Name: v_ai_rule_applicable_order; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_ai_rule_applicable_order AS
 SELECT ar.request_id,
    ar.company_id,
    ar.order_id,
    ar.entity_id,
    pr.auto_policy_id,
    pr.rollout_percent
   FROM (audit.approval_request ar
     JOIN approval.policy_rollout pr ON ((pr.auto_policy_id = ( SELECT ap.auto_policy_id
           FROM approval.policy_auto_generated ap
          WHERE ((ap.source_policy_id = ar.policy_id) AND (ap.activated = true))
         LIMIT 1))))
  WHERE ((pr.status = 'active'::text) AND (approval.is_in_rollout(pr.rollout_percent, ar.entity_id) = true));


--
-- Name: company_license; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.company_license (
    company_license_id bigint NOT NULL,
    company_id uuid NOT NULL,
    license_code text NOT NULL,
    purchased_at timestamp with time zone DEFAULT now() NOT NULL,
    expires_at timestamp with time zone,
    is_active boolean DEFAULT true NOT NULL
);

ALTER TABLE ONLY core.company_license FORCE ROW LEVEL SECURITY;


--
-- Name: company_license; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.company_license AS
 SELECT company_license_id,
    company_id,
    license_code,
    purchased_at,
    expires_at,
    is_active
   FROM core.company_license;


--
-- Name: v_ai_saas_enabled; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_ai_saas_enabled AS
 SELECT ff.company_id
   FROM (approval.feature_flag ff
     JOIN public.company_license cl ON ((cl.company_id = ff.company_id)))
  WHERE ((ff.feature_key = 'approval_ai'::text) AND (ff.is_enabled = true) AND (cl.license_code = ANY (ARRAY['PRO'::text, 'ENTERPRISE'::text])));


--
-- Name: approval_log; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.approval_log (
    approval_log_id uuid DEFAULT gen_random_uuid() NOT NULL,
    approval_request_id uuid NOT NULL,
    action text NOT NULL,
    actor uuid NOT NULL,
    note text,
    acted_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT approval_log_action_check CHECK ((action = ANY (ARRAY['approve'::text, 'reject'::text])))
);


--
-- Name: v_approval_audit; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_approval_audit AS
 SELECT ar.request_id,
    ar.company_id,
    ar.domain,
    ar.entity_type,
    ar.entity_id,
    ar.policy_id,
    ar.severity,
    ar.status,
    ar.detected_at,
    ar.decided_at,
    al.actor,
    al.action,
    al.note
   FROM (audit.approval_request ar
     LEFT JOIN audit.approval_log al ON ((al.approval_request_id = ar.request_id)));


--
-- Name: v_approval_result_enriched; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_approval_result_enriched AS
 SELECT ar.request_id,
    ar.company_id,
    ar.order_id,
    ar.policy_id,
    ar.severity,
    ar.status,
    ar.detected_at,
    ar.decided_at,
    os.order_no,
    os.total_amount,
    os.total_qty
   FROM (audit.approval_request ar
     LEFT JOIN sales.v_order_summary os ON ((os.order_id = ar.order_id)))
  WHERE (ar.status = ANY (ARRAY['approved'::text, 'rejected'::text]));


--
-- Name: v_approval_result_event; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_approval_result_event AS
 SELECT request_id,
    company_id,
    domain,
    entity_type,
    entity_id,
    order_id,
    policy_id,
    severity,
    status,
    decided_at
   FROM audit.approval_request ar
  WHERE (status = ANY (ARRAY['approved'::text, 'rejected'::text]));


--
-- Name: v_approval_sla_kpi; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_approval_sla_kpi AS
 SELECT request_id,
    company_id,
    policy_id,
    severity,
    status,
    (EXTRACT(epoch FROM (decided_at - detected_at)) / 60.0) AS sla_minutes
   FROM audit.approval_request ar
  WHERE ((status = ANY (ARRAY['approved'::text, 'rejected'::text])) AND (decided_at IS NOT NULL));


--
-- Name: v_audit_report_export; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_audit_report_export AS
 SELECT request_id,
    company_id,
    order_id,
    policy_id,
    auto_policy_id,
    override_reason,
    overridden_by,
    overridden_at,
    ai_decided_at
   FROM approval.v_ai_override_audit_report;


--
-- Name: v_auto_policy_activate; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_auto_policy_activate AS
 SELECT auto_policy_id,
    source_policy_id,
    generated_rule,
    confidence_score
   FROM approval.policy_auto_generated
  WHERE ((activated = false) AND (confidence_score >= 0.85));


--
-- Name: v_autopilot_company_enabled; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_autopilot_company_enabled AS
 SELECT pr.auto_policy_id,
    pr.company_id
   FROM (approval.policy_rollout pr
     JOIN approval.feature_flag ff ON ((ff.company_id = pr.company_id)))
  WHERE ((ff.feature_key = 'approval_ai'::text) AND (ff.is_enabled = true));


--
-- Name: v_policy_eval_7d; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_policy_eval_7d AS
 SELECT auto_policy_id,
    count(*) AS samples,
    avg(
        CASE
            WHEN (outcome = 'bad'::text) THEN 1.0
            ELSE 0.0
        END) AS error_rate
   FROM approval.policy_eval_event
  WHERE (created_at >= (now() - '7 days'::interval))
  GROUP BY auto_policy_id;


--
-- Name: v_policy_roi; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_policy_roi AS
 WITH base AS (
         SELECT ap.auto_policy_id,
            ap.source_policy_id AS policy_id,
            ap.created_at AS policy_created_at
           FROM approval.policy_auto_generated ap
        ), before_after AS (
         SELECT b.auto_policy_id,
            b.policy_id,
            avg((EXTRACT(epoch FROM (ar.decided_at - ar.detected_at)) / 60.0)) FILTER (WHERE (ar.detected_at < b.policy_created_at)) AS avg_sla_before,
            avg((EXTRACT(epoch FROM (ar.decided_at - ar.detected_at)) / 60.0)) FILTER (WHERE (ar.detected_at >= b.policy_created_at)) AS avg_sla_after,
            count(*) FILTER (WHERE (ar.detected_at >= b.policy_created_at)) AS after_count
           FROM (base b
             JOIN audit.approval_request ar ON (((ar.policy_id = b.policy_id) AND (ar.status = ANY (ARRAY['approved'::text, 'rejected'::text])) AND (ar.decided_at IS NOT NULL))))
          GROUP BY b.auto_policy_id, b.policy_id
        ), quality AS (
         SELECT pe.auto_policy_id,
            count(*) AS samples_7d,
            avg(
                CASE
                    WHEN (pe.outcome = 'bad'::text) THEN 1.0
                    ELSE 0.0
                END) AS error_rate_7d
           FROM approval.policy_eval_event pe
          WHERE (pe.created_at >= (now() - '7 days'::interval))
          GROUP BY pe.auto_policy_id
        )
 SELECT ba.auto_policy_id,
    ba.policy_id,
    ba.avg_sla_before,
    ba.avg_sla_after,
    ba.after_count,
    ((COALESCE(ba.avg_sla_before, (0)::numeric) - COALESCE(ba.avg_sla_after, (0)::numeric)) * (COALESCE(ba.after_count, (0)::bigint))::numeric) AS savings_minutes_total,
    q.samples_7d,
    q.error_rate_7d
   FROM (before_after ba
     LEFT JOIN quality q ON ((q.auto_policy_id = ba.auto_policy_id)));


--
-- Name: v_autopilot_recommendation; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_autopilot_recommendation AS
 SELECT pr.auto_policy_id,
    pr.company_id,
    pr.rollout_percent,
    pr.status,
    pr.min_samples,
    pr.max_error_rate,
    COALESCE(ev.samples, (0)::bigint) AS samples_7d,
    COALESCE(ev.error_rate, (0)::numeric) AS error_rate_7d,
    roi.savings_minutes_total,
        CASE
            WHEN (pr.status = 'rolled_back'::text) THEN 'hold'::text
            WHEN ((COALESCE(ev.samples, (0)::bigint) >= pr.min_samples) AND (COALESCE(ev.error_rate, (0)::numeric) > pr.max_error_rate)) THEN 'rollback'::text
            WHEN ((COALESCE(ev.samples, (0)::bigint) >= pr.min_samples) AND (COALESCE(ev.error_rate, (0)::numeric) <= pr.max_error_rate) AND (pr.rollout_percent = ANY (ARRAY[0, 10, 50]))) THEN 'promote'::text
            ELSE 'hold'::text
        END AS recommended_action
   FROM ((approval.policy_rollout pr
     LEFT JOIN approval.v_policy_eval_7d ev ON ((ev.auto_policy_id = pr.auto_policy_id)))
     LEFT JOIN approval.v_policy_roi roi ON ((roi.auto_policy_id = pr.auto_policy_id)));


--
-- Name: v_bad_candidate; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_bad_candidate AS
 SELECT pe.auto_policy_id,
    oh.company_id,
    pe.order_id,
    pe.entity_id,
    oh.status_code,
    now() AS detected_at
   FROM (approval.policy_eval_event pe
     JOIN sales.order_header oh ON ((oh.order_id = pe.order_id)))
  WHERE ((pe.outcome = 'ok'::text) AND (oh.status_code = ANY (ARRAY['rejected'::text, 'cancelled'::text])));


--
-- Name: v_bad_candidate_audit; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_bad_candidate_audit AS
 SELECT pe.auto_policy_id,
    ar.company_id,
    ar.order_id,
    ar.entity_id,
    'manual_edit_after_approval'::text AS bad_reason
   FROM ((approval.policy_eval_event pe
     JOIN audit.approval_request ar ON ((ar.order_id = pe.order_id)))
     JOIN public.audit_trail at ON ((at.entity_id = (ar.order_id)::text)))
  WHERE ((pe.outcome = 'ok'::text) AND (at.action = 'update'::text) AND (at.performed_at > ar.decided_at));


--
-- Name: v_bad_candidate_extended; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_bad_candidate_extended AS
 SELECT pe.auto_policy_id,
    oh.company_id,
    pe.order_id,
    pe.entity_id,
    'status_reverted'::text AS bad_reason
   FROM ((approval.policy_eval_event pe
     JOIN audit.approval_request ar ON ((ar.order_id = pe.order_id)))
     JOIN sales.order_header oh ON ((oh.order_id = pe.order_id)))
  WHERE ((pe.outcome = 'ok'::text) AND (oh.status_code = ANY (ARRAY['rejected'::text, 'cancelled'::text])));


--
-- Name: v_bad_candidate_all; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_bad_candidate_all AS
 SELECT v_bad_candidate_extended.auto_policy_id,
    v_bad_candidate_extended.company_id,
    v_bad_candidate_extended.order_id,
    v_bad_candidate_extended.entity_id,
    v_bad_candidate_extended.bad_reason
   FROM approval.v_bad_candidate_extended
UNION ALL
 SELECT v_bad_candidate_audit.auto_policy_id,
    v_bad_candidate_audit.company_id,
    v_bad_candidate_audit.order_id,
    v_bad_candidate_audit.entity_id,
    v_bad_candidate_audit.bad_reason
   FROM approval.v_bad_candidate_audit;


--
-- Name: v_bad_candidate_audit_strict; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_bad_candidate_audit_strict AS
 SELECT pe.auto_policy_id,
    ar.company_id,
    ar.order_id,
    ar.entity_id,
    ac.action_type AS bad_reason,
        CASE
            WHEN (ac.action_type = ANY (ARRAY['price_change'::text, 'amount_change'::text])) THEN 'high'::text
            WHEN (ac.action_type = 'qty_change'::text) THEN 'medium'::text
            ELSE 'low'::text
        END AS severity_escalated
   FROM ((approval.policy_eval_event pe
     JOIN audit.approval_request ar ON ((ar.order_id = pe.order_id)))
     JOIN approval.v_audit_action_classified ac ON ((ac.entity_id = (ar.order_id)::text)))
  WHERE ((pe.outcome = 'ok'::text) AND (ac.performed_at > ar.decided_at));


--
-- Name: v_bottleneck_policy; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_bottleneck_policy AS
 SELECT policy_id,
    severity,
    count(*) AS request_count,
    avg((EXTRACT(epoch FROM (decided_at - detected_at)) / 60.0)) AS avg_sla_minutes,
    max((EXTRACT(epoch FROM (decided_at - detected_at)) / 60.0)) AS max_sla_minutes
   FROM audit.approval_request ar
  WHERE ((status = ANY (ARRAY['approved'::text, 'rejected'::text])) AND (decided_at IS NOT NULL))
  GROUP BY policy_id, severity;


--
-- Name: v_daily_quality_report; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_daily_quality_report AS
 SELECT date_trunc('day'::text, ar.decided_at) AS day,
    ar.policy_id,
    ar.severity,
    count(*) AS total,
    avg((EXTRACT(epoch FROM (ar.decided_at - ar.detected_at)) / 60.0)) AS avg_sla_minutes,
    sum(
        CASE
            WHEN (pe.outcome = 'bad'::text) THEN 1
            ELSE 0
        END) AS bad_count
   FROM (audit.approval_request ar
     LEFT JOIN approval.policy_eval_event pe ON ((pe.order_id = ar.order_id)))
  WHERE ((ar.status = ANY (ARRAY['approved'::text, 'rejected'::text])) AND (ar.decided_at IS NOT NULL))
  GROUP BY (date_trunc('day'::text, ar.decided_at)), ar.policy_id, ar.severity;


--
-- Name: v_exec_dashboard; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_exec_dashboard AS
 SELECT (date_trunc('month'::text, ar.decided_at))::date AS month,
    pr.company_id,
    count(*) FILTER (WHERE (ar.status = 'approved'::text)) AS approved_count,
    avg((EXTRACT(epoch FROM (ar.decided_at - ar.detected_at)) / 60.0)) AS avg_sla_minutes,
    sum(roi.savings_minutes_total) AS saved_minutes,
    sum(((roi.savings_minutes_total / 60.0) * cc.cost_per_hour)) AS saved_yen
   FROM (((audit.approval_request ar
     JOIN approval.policy_rollout pr ON (((pr.auto_policy_id)::text = ar.policy_id)))
     LEFT JOIN approval.v_policy_roi roi ON ((roi.policy_id = ar.policy_id)))
     LEFT JOIN approval.company_cost cc ON ((cc.company_id = pr.company_id)))
  WHERE (ar.decided_at IS NOT NULL)
  GROUP BY (date_trunc('month'::text, ar.decided_at)), pr.company_id;


--
-- Name: v_exec_dashboard_yoy; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_exec_dashboard_yoy AS
 WITH base AS (
         SELECT (date_trunc('month'::text, ar.decided_at))::date AS month,
            pr.company_id,
            count(*) FILTER (WHERE (ar.status = 'approved'::text)) AS approved_count,
            avg((EXTRACT(epoch FROM (ar.decided_at - ar.detected_at)) / 60.0)) AS avg_sla_minutes
           FROM (audit.approval_request ar
             JOIN approval.policy_rollout pr ON (((pr.auto_policy_id)::text = ar.policy_id)))
          WHERE (ar.decided_at IS NOT NULL)
          GROUP BY ((date_trunc('month'::text, ar.decided_at))::date), pr.company_id
        ), prev AS (
         SELECT ((base.month + '1 year'::interval))::date AS month,
            base.company_id,
            base.approved_count AS approved_count_prev_year,
            base.avg_sla_minutes AS avg_sla_minutes_prev_year
           FROM base
        )
 SELECT b.month,
    b.company_id,
    b.approved_count,
    p.approved_count_prev_year,
    (b.approved_count - p.approved_count_prev_year) AS approved_count_yoy_diff,
    b.avg_sla_minutes,
    p.avg_sla_minutes_prev_year,
    (b.avg_sla_minutes - p.avg_sla_minutes_prev_year) AS avg_sla_minutes_yoy_diff
   FROM (base b
     LEFT JOIN prev p ON (((p.month = b.month) AND (p.company_id = b.company_id))));


--
-- Name: v_feature_enabled_company; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_feature_enabled_company AS
 SELECT company_id
   FROM approval.feature_flag
  WHERE ((feature_key = 'approval_ai'::text) AND (is_enabled = true));


--
-- Name: v_invoice_for_payment; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_invoice_for_payment AS
 SELECT invoice_id,
    customer_code,
    ym,
    amount_yen,
    status
   FROM approval.billing_invoice bi
  WHERE (status = ANY (ARRAY['draft'::text, 'issued'::text]));


--
-- Name: v_jsox_control_matrix; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_jsox_control_matrix AS
 SELECT c.control_code,
    c.control_name,
    c.objective,
    c.frequency,
    c.owner_role,
    c.evidence,
    max(e.created_at) AS last_evidence_at
   FROM (approval.jsox_control c
     LEFT JOIN approval.jsox_evidence_log e ON ((e.control_code = c.control_code)))
  GROUP BY c.control_code, c.control_name, c.objective, c.frequency, c.owner_role, c.evidence;


--
-- Name: v_layer2_active_policies; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_layer2_active_policies AS
 SELECT auto_policy_id,
    source_policy_id,
    generated_rule
   FROM approval.policy_auto_generated ap
  WHERE (activated = true);


--
-- Name: v_monthly_request_count; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_monthly_request_count AS
 SELECT company_id,
    date_trunc('month'::text, detected_at) AS month,
    count(*) AS request_count
   FROM audit.approval_request ar
  GROUP BY company_id, (date_trunc('month'::text, detected_at));


--
-- Name: v_monthly_roi_report; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_monthly_roi_report AS
 SELECT date_trunc('month'::text, ar.decided_at) AS month,
    pr.company_id,
    roi.policy_id,
    sum(roi.savings_minutes_total) AS savings_minutes,
    cc.cost_per_hour,
    ((sum(roi.savings_minutes_total) / 60.0) * cc.cost_per_hour) AS savings_yen
   FROM (((approval.v_policy_roi roi
     JOIN approval.policy_rollout pr ON ((pr.auto_policy_id = roi.auto_policy_id)))
     JOIN approval.company_cost cc ON ((cc.company_id = pr.company_id)))
     JOIN audit.approval_request ar ON ((ar.policy_id = roi.policy_id)))
  WHERE (ar.decided_at IS NOT NULL)
  GROUP BY (date_trunc('month'::text, ar.decided_at)), pr.company_id, roi.policy_id, cc.cost_per_hour;


--
-- Name: v_payment_status; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_payment_status AS
 SELECT bi.invoice_id,
    bi.customer_code,
    bi.ym,
    bi.amount_yen,
    max(bp.status) AS payment_status
   FROM (approval.billing_invoice bi
     LEFT JOIN approval.billing_payment bp ON ((bp.invoice_id = bi.invoice_id)))
  GROUP BY bi.invoice_id, bi.customer_code, bi.ym, bi.amount_yen;


--
-- Name: v_pending_approval_ui; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_pending_approval_ui AS
 SELECT request_id,
    company_id,
    entity_id AS order_no,
    order_id,
    reason,
    detected_at
   FROM audit.approval_request
  WHERE (status = 'pending'::text);


--
-- Name: v_pmloop_restart_target; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_pmloop_restart_target AS
 SELECT request_id,
    company_id,
    order_id,
    decided_at
   FROM audit.approval_request
  WHERE (status = 'approved'::text);


--
-- Name: v_policy_ab_test; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_policy_ab_test AS
 SELECT ar.policy_id,
    avg((EXTRACT(epoch FROM (ar.decided_at - ar.detected_at)) / 60.0)) FILTER (WHERE (ar.detected_at < ap.created_at)) AS avg_sla_before,
    avg((EXTRACT(epoch FROM (ar.decided_at - ar.detected_at)) / 60.0)) FILTER (WHERE (ar.detected_at >= ap.created_at)) AS avg_sla_after
   FROM (audit.approval_request ar
     JOIN approval.policy_auto_generated ap ON ((ap.source_policy_id = ar.policy_id)))
  WHERE ((ar.status = ANY (ARRAY['approved'::text, 'rejected'::text])) AND (ar.decided_at IS NOT NULL))
  GROUP BY ar.policy_id;


--
-- Name: v_policy_eval_auto_ok; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_policy_eval_auto_ok AS
 SELECT request_id,
    company_id,
    order_id,
    entity_id,
    auto_policy_id,
    'ok'::text AS outcome
   FROM approval.v_ai_rule_applicable_order;


--
-- Name: v_policy_roi_yen; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_policy_roi_yen AS
 SELECT roi.auto_policy_id,
    roi.policy_id,
    roi.savings_minutes_total,
    cc.cost_per_hour,
    ((roi.savings_minutes_total / 60.0) * cc.cost_per_hour) AS savings_yen
   FROM ((approval.v_policy_roi roi
     JOIN approval.policy_rollout pr ON ((pr.auto_policy_id = roi.auto_policy_id)))
     JOIN approval.company_cost cc ON ((cc.company_id = pr.company_id)));


--
-- Name: v_public_pricing_export; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_public_pricing_export AS
 SELECT plan_code,
    plan_name,
    monthly_yen,
    description,
    features
   FROM approval.public_pricing;


--
-- Name: v_roi_report_export; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_roi_report_export AS
 SELECT month,
    company_id,
    policy_id,
    savings_minutes,
    cost_per_hour,
    savings_yen
   FROM approval.v_monthly_roi_report;


--
-- Name: v_saas_kpi_company; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_saas_kpi_company AS
 SELECT company_id,
    (date_trunc('month'::text, (day)::timestamp with time zone))::date AS month,
    sum(approvals) AS approvals,
    sum(auto_approves) AS auto_approves,
    sum(rollbacks) AS rollbacks
   FROM approval.saas_usage_daily u
  GROUP BY company_id, ((date_trunc('month'::text, (day)::timestamp with time zone))::date);


--
-- Name: v_saas_limit_status; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_saas_limit_status AS
 SELECT s.subscription_id,
    s.plan_code,
    l.max_companies,
    l.max_approvals_mo,
    count(DISTINCT scm.company_id) AS used_companies,
    COALESCE(u.approvals_count, 0) AS used_approvals
   FROM (((approval.saas_subscription s
     JOIN approval.saas_plan_limit l ON ((l.plan_code = s.plan_code)))
     LEFT JOIN approval.saas_company_map scm ON ((scm.subscription_id = s.subscription_id)))
     LEFT JOIN approval.saas_usage_monthly u ON (((u.subscription_id = s.subscription_id) AND (u.ym = to_char(now(), 'YYYYMM'::text)))))
  WHERE (s.status = 'active'::text)
  GROUP BY s.subscription_id, s.plan_code, l.max_companies, l.max_approvals_mo, u.approvals_count;


--
-- Name: v_severity_escalation_target; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_severity_escalation_target AS
 SELECT auto_policy_id,
    company_id,
    order_id,
    bad_reason,
    severity_escalated
   FROM approval.v_bad_candidate_audit_strict
  WHERE (severity_escalated = 'high'::text);


--
-- Name: v_sla_distribution_monthly; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_sla_distribution_monthly AS
 WITH s AS (
         SELECT (date_trunc('month'::text, ar.decided_at))::date AS month,
            pr.company_id,
            (EXTRACT(epoch FROM (ar.decided_at - ar.detected_at)) / 60.0) AS sla_minutes
           FROM (audit.approval_request ar
             JOIN approval.policy_rollout pr ON (((pr.auto_policy_id)::text = ar.policy_id)))
          WHERE (ar.decided_at IS NOT NULL)
        ), b AS (
         SELECT s.month,
            s.company_id,
                CASE
                    WHEN (s.sla_minutes < (5)::numeric) THEN '0-5'::text
                    WHEN (s.sla_minutes < (15)::numeric) THEN '5-15'::text
                    WHEN (s.sla_minutes < (30)::numeric) THEN '15-30'::text
                    WHEN (s.sla_minutes < (60)::numeric) THEN '30-60'::text
                    ELSE '60+'::text
                END AS sla_bin
           FROM s
        )
 SELECT month,
    company_id,
    sla_bin,
    count(*) AS cnt
   FROM b
  GROUP BY month, company_id, sla_bin;


--
-- Name: v_sla_escalation; Type: VIEW; Schema: approval; Owner: -
--

CREATE VIEW approval.v_sla_escalation AS
 SELECT request_id,
    company_id,
    policy_id,
    severity,
    (EXTRACT(epoch FROM (decided_at - detected_at)) / 60.0) AS sla_minutes
   FROM audit.approval_request ar
  WHERE ((status = ANY (ARRAY['approved'::text, 'rejected'::text])) AND (decided_at IS NOT NULL) AND ((EXTRACT(epoch FROM (decided_at - detected_at)) / 60.0) > (90)::numeric));


--
-- Name: approval_notify_queue; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.approval_notify_queue (
    notify_id uuid DEFAULT gen_random_uuid() NOT NULL,
    request_id uuid NOT NULL,
    payload jsonb NOT NULL,
    status text DEFAULT 'queued'::text NOT NULL,
    retry_count integer DEFAULT 0 NOT NULL,
    last_error text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    sent_at timestamp with time zone
);


--
-- Name: approval_reason_template; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.approval_reason_template (
    template_id uuid DEFAULT gen_random_uuid() NOT NULL,
    domain text NOT NULL,
    template_ja text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: audit_event; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.audit_event (
    audit_event_id bigint NOT NULL,
    company_id uuid NOT NULL,
    occurred_at timestamp with time zone NOT NULL,
    recorded_at timestamp with time zone DEFAULT now() NOT NULL,
    business_domain text NOT NULL,
    event_key text NOT NULL,
    task_name text,
    audit_scope text NOT NULL,
    severity text NOT NULL,
    reason_code text NOT NULL,
    approval_required boolean DEFAULT false NOT NULL,
    approved_by uuid,
    approved_at timestamp with time zone,
    context jsonb DEFAULT '{}'::jsonb NOT NULL,
    CONSTRAINT audit_event_audit_scope_check CHECK ((audit_scope = ANY (ARRAY['internal'::text, 'external'::text, 'both'::text]))),
    CONSTRAINT audit_event_severity_check CHECK ((severity = ANY (ARRAY['ok'::text, 'warn'::text, 'ng'::text, 'critical'::text])))
);


--
-- Name: audit_event_audit_event_id_seq; Type: SEQUENCE; Schema: audit; Owner: -
--

CREATE SEQUENCE audit.audit_event_audit_event_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_event_audit_event_id_seq; Type: SEQUENCE OWNED BY; Schema: audit; Owner: -
--

ALTER SEQUENCE audit.audit_event_audit_event_id_seq OWNED BY audit.audit_event.audit_event_id;


--
-- Name: audit_reason_policy; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.audit_reason_policy (
    reason_code text NOT NULL,
    default_severity text NOT NULL,
    approval_required boolean NOT NULL,
    auto_fix_allowed boolean NOT NULL,
    quarantine_on_fail boolean NOT NULL,
    description text NOT NULL,
    CONSTRAINT audit_reason_policy_default_severity_check CHECK ((default_severity = ANY (ARRAY['ok'::text, 'warn'::text, 'ng'::text, 'critical'::text])))
);


--
-- Name: audit_target_table; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.audit_target_table (
    table_schema text NOT NULL,
    table_name text NOT NULL,
    audit_level text DEFAULT 'FULL'::text NOT NULL,
    audited_columns jsonb,
    reason text,
    decided_by text,
    decided_at timestamp with time zone DEFAULT now() NOT NULL,
    is_enabled boolean DEFAULT true NOT NULL,
    CONSTRAINT audit_target_level_chk CHECK ((audit_level = ANY (ARRAY['FULL'::text, 'PARTIAL'::text, 'NONE'::text])))
);


--
-- Name: audit_trail_db; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.audit_trail_db (
    audit_trail_db_id bigint NOT NULL,
    company_id uuid,
    table_schema text NOT NULL,
    table_name text NOT NULL,
    action text NOT NULL,
    pk jsonb,
    row_before jsonb,
    row_after jsonb,
    changed_columns jsonb,
    actor text,
    request_id uuid,
    txid bigint DEFAULT txid_current() NOT NULL,
    occurred_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: audit_trail_db_audit_trail_db_id_seq; Type: SEQUENCE; Schema: audit; Owner: -
--

CREATE SEQUENCE audit.audit_trail_db_audit_trail_db_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_trail_db_audit_trail_db_id_seq; Type: SEQUENCE OWNED BY; Schema: audit; Owner: -
--

ALTER SEQUENCE audit.audit_trail_db_audit_trail_db_id_seq OWNED BY audit.audit_trail_db.audit_trail_db_id;


--
-- Name: entity_status_history; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.entity_status_history (
    status_history_id bigint NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id bigint NOT NULL,
    status_code text NOT NULL,
    status_name text,
    reason text,
    changed_by uuid,
    changed_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT entity_status_history_entity_type_check CHECK ((entity_type = ANY (ARRAY['quotation'::text, 'order'::text, 'shipping'::text, 'billing'::text, 'return'::text])))
);


--
-- Name: entity_status_history_status_history_id_seq; Type: SEQUENCE; Schema: audit; Owner: -
--

CREATE SEQUENCE audit.entity_status_history_status_history_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: entity_status_history_status_history_id_seq; Type: SEQUENCE OWNED BY; Schema: audit; Owner: -
--

ALTER SEQUENCE audit.entity_status_history_status_history_id_seq OWNED BY audit.entity_status_history.status_history_id;


--
-- Name: exec_audit_event; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.exec_audit_event (
    audit_event_id bigint NOT NULL,
    request_id bigint,
    event_type text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT exec_audit_event_event_type_check CHECK ((event_type = ANY (ARRAY['ENQUEUE'::text, 'PICK'::text, 'DONE'::text, 'FAILED'::text])))
);


--
-- Name: exec_audit_event_audit_event_id_seq; Type: SEQUENCE; Schema: audit; Owner: -
--

CREATE SEQUENCE audit.exec_audit_event_audit_event_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: exec_audit_event_audit_event_id_seq; Type: SEQUENCE OWNED BY; Schema: audit; Owner: -
--

ALTER SEQUENCE audit.exec_audit_event_audit_event_id_seq OWNED BY audit.exec_audit_event.audit_event_id;


--
-- Name: ng_event_ng_event_id_seq; Type: SEQUENCE; Schema: audit; Owner: -
--

CREATE SEQUENCE audit.ng_event_ng_event_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: ng_event_ng_event_id_seq; Type: SEQUENCE OWNED BY; Schema: audit; Owner: -
--

ALTER SEQUENCE audit.ng_event_ng_event_id_seq OWNED BY audit.ng_event.ng_event_id;


--
-- Name: notification_channel; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.notification_channel (
    channel_id uuid DEFAULT gen_random_uuid() NOT NULL,
    channel_type text NOT NULL,
    destination text NOT NULL,
    is_enabled boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ops_audit_log; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.ops_audit_log (
    audit_id bigint NOT NULL,
    job_id bigint,
    event_type text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    logged_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ops_audit_log_audit_id_seq; Type: SEQUENCE; Schema: audit; Owner: -
--

CREATE SEQUENCE audit.ops_audit_log_audit_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: ops_audit_log_audit_id_seq; Type: SEQUENCE OWNED BY; Schema: audit; Owner: -
--

ALTER SEQUENCE audit.ops_audit_log_audit_id_seq OWNED BY audit.ops_audit_log.audit_id;


--
-- Name: slack_interaction_log; Type: TABLE; Schema: audit; Owner: -
--

CREATE TABLE audit.slack_interaction_log (
    interaction_id uuid DEFAULT gen_random_uuid() NOT NULL,
    request_id uuid NOT NULL,
    action text NOT NULL,
    actor text NOT NULL,
    payload jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_audit_target_suggestions; Type: VIEW; Schema: audit; Owner: -
--

CREATE VIEW audit.v_audit_target_suggestions AS
 WITH cols AS (
         SELECT c.table_schema,
            c.table_name,
            bool_or(((c.column_name)::name = 'company_id'::name)) AS has_company_id,
            bool_or(((c.column_name)::name ~* '(amount|price|cost|fee|tax|total|balance)'::text)) AS has_money,
            bool_or(((c.column_name)::name ~* '(qty|quantity|stock|inventory)'::text)) AS has_qty,
            bool_or(((c.column_name)::name ~* '(status|state|approved|approval|closed|posted|confirmed|shipped|paid)'::text)) AS has_status,
            count(*) FILTER (WHERE ((c.column_name)::name ~* '(created_at|updated_at|deleted_at)'::text)) AS ts_cols
           FROM information_schema.columns c
          WHERE ((c.table_schema)::name <> ALL (ARRAY['pg_catalog'::name, 'information_schema'::name]))
          GROUP BY c.table_schema, c.table_name
        ), fks AS (
         SELECT tc.table_schema,
            tc.table_name,
            count(*) AS fk_count
           FROM information_schema.table_constraints tc
          WHERE (((tc.constraint_type)::text = 'FOREIGN KEY'::text) AND ((tc.table_schema)::name <> ALL (ARRAY['pg_catalog'::name, 'information_schema'::name])))
          GROUP BY tc.table_schema, tc.table_name
        ), base AS (
         SELECT cols.table_schema,
            cols.table_name,
            cols.has_company_id,
            cols.has_money,
            cols.has_qty,
            cols.has_status,
            cols.ts_cols,
            COALESCE(fks.fk_count, (0)::bigint) AS fk_count
           FROM (cols
             LEFT JOIN fks ON ((((fks.table_schema)::name = (cols.table_schema)::name) AND ((fks.table_name)::name = (cols.table_name)::name))))
        )
 SELECT table_schema,
    table_name,
    has_company_id,
    has_money,
    has_qty,
    has_status,
    fk_count,
    ((((
        CASE
            WHEN has_company_id THEN 2
            ELSE 0
        END +
        CASE
            WHEN has_money THEN 3
            ELSE 0
        END) +
        CASE
            WHEN has_qty THEN 2
            ELSE 0
        END) +
        CASE
            WHEN has_status THEN 3
            ELSE 0
        END) + LEAST(fk_count, (5)::bigint)) AS score,
        CASE
            WHEN (((
            CASE
                WHEN has_company_id THEN 2
                ELSE 0
            END +
            CASE
                WHEN has_money THEN 3
                ELSE 0
            END) +
            CASE
                WHEN has_status THEN 3
                ELSE 0
            END) >= 6) THEN 'FULL'::text
            WHEN (((
            CASE
                WHEN has_company_id THEN 2
                ELSE 0
            END +
            CASE
                WHEN has_qty THEN 2
                ELSE 0
            END) +
            CASE
                WHEN has_status THEN 3
                ELSE 0
            END) >= 5) THEN 'FULL'::text
            WHEN (
            CASE
                WHEN has_company_id THEN 2
                ELSE 0
            END >= 2) THEN 'PARTIAL'::text
            ELSE 'NONE'::text
        END AS suggested_level
   FROM base
  ORDER BY ((((
        CASE
            WHEN has_company_id THEN 2
            ELSE 0
        END +
        CASE
            WHEN has_money THEN 3
            ELSE 0
        END) +
        CASE
            WHEN has_qty THEN 2
            ELSE 0
        END) +
        CASE
            WHEN has_status THEN 3
            ELSE 0
        END) + LEAST(fk_count, (5)::bigint)) DESC, table_schema, table_name;


--
-- Name: v_external_audit_events; Type: VIEW; Schema: audit; Owner: -
--

CREATE VIEW audit.v_external_audit_events AS
 SELECT occurred_at,
    business_domain,
    event_key,
    severity,
    reason_code,
    approval_required,
    (approved_at IS NOT NULL) AS approved,
    (context ->> 'auto_fixed'::text) AS auto_fixed,
    (context ->> 'quarantined'::text) AS quarantined
   FROM audit.audit_event
  WHERE (audit_scope = ANY (ARRAY['external'::text, 'both'::text]));


--
-- Name: VIEW v_external_audit_events; Type: COMMENT; Schema: audit; Owner: -
--

COMMENT ON VIEW audit.v_external_audit_events IS 'External audit view for third parties (non-technical).';


--
-- Name: v_external_audit_kpi_by_industry; Type: VIEW; Schema: audit; Owner: -
--

CREATE VIEW audit.v_external_audit_kpi_by_industry AS
 SELECT business_domain,
    severity,
    count(*) AS event_count,
    count(*) FILTER (WHERE (approved_at IS NOT NULL)) AS approved_count,
    count(*) FILTER (WHERE (((context ->> 'quarantined'::text))::boolean = true)) AS quarantined_count,
    max(occurred_at) AS last_occurred_at
   FROM audit.audit_event
  WHERE (audit_scope = ANY (ARRAY['external'::text, 'both'::text]))
  GROUP BY business_domain, severity;


--
-- Name: VIEW v_external_audit_kpi_by_industry; Type: COMMENT; Schema: audit; Owner: -
--

COMMENT ON VIEW audit.v_external_audit_kpi_by_industry IS 'External audit KPI by industry/domain.';


--
-- Name: v_external_audit_kpi_monthly_trend; Type: VIEW; Schema: audit; Owner: -
--

CREATE VIEW audit.v_external_audit_kpi_monthly_trend AS
 SELECT business_domain,
    date_trunc('month'::text, occurred_at) AS month,
    severity,
    count(*) AS event_count,
    count(*) FILTER (WHERE (approved_at IS NOT NULL)) AS approved_count,
    count(*) FILTER (WHERE (((context ->> 'quarantined'::text))::boolean = true)) AS quarantined_count
   FROM audit.audit_event
  WHERE (audit_scope = ANY (ARRAY['external'::text, 'both'::text]))
  GROUP BY business_domain, (date_trunc('month'::text, occurred_at)), severity;


--
-- Name: VIEW v_external_audit_kpi_monthly_trend; Type: COMMENT; Schema: audit; Owner: -
--

COMMENT ON VIEW audit.v_external_audit_kpi_monthly_trend IS 'External audit monthly KPI trend by business domain.';


--
-- Name: v_external_audit_kpi_summary; Type: VIEW; Schema: audit; Owner: -
--

CREATE VIEW audit.v_external_audit_kpi_summary AS
 SELECT business_domain,
    severity,
    count(*) AS event_count,
    count(*) FILTER (WHERE (approved_at IS NOT NULL)) AS approved_count,
    max(occurred_at) AS last_occurred_at
   FROM audit.audit_event
  WHERE (audit_scope = ANY (ARRAY['external'::text, 'both'::text]))
  GROUP BY business_domain, severity;


--
-- Name: v_external_audit_kpi_weekly_trend; Type: VIEW; Schema: audit; Owner: -
--

CREATE VIEW audit.v_external_audit_kpi_weekly_trend AS
 SELECT business_domain,
    date_trunc('week'::text, occurred_at) AS week,
    severity,
    count(*) AS event_count,
    count(*) FILTER (WHERE (approved_at IS NOT NULL)) AS approved_count,
    count(*) FILTER (WHERE (((context ->> 'quarantined'::text))::boolean = true)) AS quarantined_count
   FROM audit.audit_event
  WHERE (audit_scope = ANY (ARRAY['external'::text, 'both'::text]))
  GROUP BY business_domain, (date_trunc('week'::text, occurred_at)), severity;


--
-- Name: VIEW v_external_audit_kpi_weekly_trend; Type: COMMENT; Schema: audit; Owner: -
--

COMMENT ON VIEW audit.v_external_audit_kpi_weekly_trend IS 'External audit weekly KPI trend by business domain.';


--
-- Name: audit_log_entries; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.audit_log_entries (
    instance_id uuid,
    id uuid NOT NULL,
    payload json,
    created_at timestamp with time zone,
    ip_address character varying(64) DEFAULT ''::character varying NOT NULL
);


--
-- Name: TABLE audit_log_entries; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.audit_log_entries IS 'Auth: Audit trail for user actions.';


--
-- Name: flow_state; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.flow_state (
    id uuid NOT NULL,
    user_id uuid,
    auth_code text NOT NULL,
    code_challenge_method auth.code_challenge_method NOT NULL,
    code_challenge text NOT NULL,
    provider_type text NOT NULL,
    provider_access_token text,
    provider_refresh_token text,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    authentication_method text NOT NULL,
    auth_code_issued_at timestamp with time zone
);


--
-- Name: TABLE flow_state; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.flow_state IS 'stores metadata for pkce logins';


--
-- Name: identities; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.identities (
    provider_id text NOT NULL,
    user_id uuid NOT NULL,
    identity_data jsonb NOT NULL,
    provider text NOT NULL,
    last_sign_in_at timestamp with time zone,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    email text GENERATED ALWAYS AS (lower((identity_data ->> 'email'::text))) STORED,
    id uuid DEFAULT gen_random_uuid() NOT NULL
);


--
-- Name: TABLE identities; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.identities IS 'Auth: Stores identities associated to a user.';


--
-- Name: COLUMN identities.email; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.identities.email IS 'Auth: Email is a generated column that references the optional email property in the identity_data';


--
-- Name: instances; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.instances (
    id uuid NOT NULL,
    uuid uuid,
    raw_base_config text,
    created_at timestamp with time zone,
    updated_at timestamp with time zone
);


--
-- Name: TABLE instances; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.instances IS 'Auth: Manages users across multiple sites.';


--
-- Name: mfa_amr_claims; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.mfa_amr_claims (
    session_id uuid NOT NULL,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    authentication_method text NOT NULL,
    id uuid NOT NULL
);


--
-- Name: TABLE mfa_amr_claims; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.mfa_amr_claims IS 'auth: stores authenticator method reference claims for multi factor authentication';


--
-- Name: mfa_challenges; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.mfa_challenges (
    id uuid NOT NULL,
    factor_id uuid NOT NULL,
    created_at timestamp with time zone NOT NULL,
    verified_at timestamp with time zone,
    ip_address inet NOT NULL,
    otp_code text,
    web_authn_session_data jsonb
);


--
-- Name: TABLE mfa_challenges; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.mfa_challenges IS 'auth: stores metadata about challenge requests made';


--
-- Name: mfa_factors; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.mfa_factors (
    id uuid NOT NULL,
    user_id uuid NOT NULL,
    friendly_name text,
    factor_type auth.factor_type NOT NULL,
    status auth.factor_status NOT NULL,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL,
    secret text,
    phone text,
    last_challenged_at timestamp with time zone,
    web_authn_credential jsonb,
    web_authn_aaguid uuid,
    last_webauthn_challenge_data jsonb
);


--
-- Name: TABLE mfa_factors; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.mfa_factors IS 'auth: stores metadata about factors';


--
-- Name: COLUMN mfa_factors.last_webauthn_challenge_data; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.mfa_factors.last_webauthn_challenge_data IS 'Stores the latest WebAuthn challenge data including attestation/assertion for customer verification';


--
-- Name: oauth_authorizations; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.oauth_authorizations (
    id uuid NOT NULL,
    authorization_id text NOT NULL,
    client_id uuid NOT NULL,
    user_id uuid,
    redirect_uri text NOT NULL,
    scope text NOT NULL,
    state text,
    resource text,
    code_challenge text,
    code_challenge_method auth.code_challenge_method,
    response_type auth.oauth_response_type DEFAULT 'code'::auth.oauth_response_type NOT NULL,
    status auth.oauth_authorization_status DEFAULT 'pending'::auth.oauth_authorization_status NOT NULL,
    authorization_code text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    expires_at timestamp with time zone DEFAULT (now() + '00:03:00'::interval) NOT NULL,
    approved_at timestamp with time zone,
    nonce text,
    CONSTRAINT oauth_authorizations_authorization_code_length CHECK ((char_length(authorization_code) <= 255)),
    CONSTRAINT oauth_authorizations_code_challenge_length CHECK ((char_length(code_challenge) <= 128)),
    CONSTRAINT oauth_authorizations_expires_at_future CHECK ((expires_at > created_at)),
    CONSTRAINT oauth_authorizations_nonce_length CHECK ((char_length(nonce) <= 255)),
    CONSTRAINT oauth_authorizations_redirect_uri_length CHECK ((char_length(redirect_uri) <= 2048)),
    CONSTRAINT oauth_authorizations_resource_length CHECK ((char_length(resource) <= 2048)),
    CONSTRAINT oauth_authorizations_scope_length CHECK ((char_length(scope) <= 4096)),
    CONSTRAINT oauth_authorizations_state_length CHECK ((char_length(state) <= 4096))
);


--
-- Name: oauth_client_states; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.oauth_client_states (
    id uuid NOT NULL,
    provider_type text NOT NULL,
    code_verifier text,
    created_at timestamp with time zone NOT NULL
);


--
-- Name: TABLE oauth_client_states; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.oauth_client_states IS 'Stores OAuth states for third-party provider authentication flows where Supabase acts as the OAuth client.';


--
-- Name: oauth_clients; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.oauth_clients (
    id uuid NOT NULL,
    client_secret_hash text,
    registration_type auth.oauth_registration_type NOT NULL,
    redirect_uris text NOT NULL,
    grant_types text NOT NULL,
    client_name text,
    client_uri text,
    logo_uri text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    client_type auth.oauth_client_type DEFAULT 'confidential'::auth.oauth_client_type NOT NULL,
    CONSTRAINT oauth_clients_client_name_length CHECK ((char_length(client_name) <= 1024)),
    CONSTRAINT oauth_clients_client_uri_length CHECK ((char_length(client_uri) <= 2048)),
    CONSTRAINT oauth_clients_logo_uri_length CHECK ((char_length(logo_uri) <= 2048))
);


--
-- Name: oauth_consents; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.oauth_consents (
    id uuid NOT NULL,
    user_id uuid NOT NULL,
    client_id uuid NOT NULL,
    scopes text NOT NULL,
    granted_at timestamp with time zone DEFAULT now() NOT NULL,
    revoked_at timestamp with time zone,
    CONSTRAINT oauth_consents_revoked_after_granted CHECK (((revoked_at IS NULL) OR (revoked_at >= granted_at))),
    CONSTRAINT oauth_consents_scopes_length CHECK ((char_length(scopes) <= 2048)),
    CONSTRAINT oauth_consents_scopes_not_empty CHECK ((char_length(TRIM(BOTH FROM scopes)) > 0))
);


--
-- Name: one_time_tokens; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.one_time_tokens (
    id uuid NOT NULL,
    user_id uuid NOT NULL,
    token_type auth.one_time_token_type NOT NULL,
    token_hash text NOT NULL,
    relates_to text NOT NULL,
    created_at timestamp without time zone DEFAULT now() NOT NULL,
    updated_at timestamp without time zone DEFAULT now() NOT NULL,
    CONSTRAINT one_time_tokens_token_hash_check CHECK ((char_length(token_hash) > 0))
);


--
-- Name: refresh_tokens; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.refresh_tokens (
    instance_id uuid,
    id bigint NOT NULL,
    token character varying(255),
    user_id character varying(255),
    revoked boolean,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    parent character varying(255),
    session_id uuid
);


--
-- Name: TABLE refresh_tokens; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.refresh_tokens IS 'Auth: Store of tokens used to refresh JWT tokens once they expire.';


--
-- Name: refresh_tokens_id_seq; Type: SEQUENCE; Schema: auth; Owner: -
--

CREATE SEQUENCE auth.refresh_tokens_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: refresh_tokens_id_seq; Type: SEQUENCE OWNED BY; Schema: auth; Owner: -
--

ALTER SEQUENCE auth.refresh_tokens_id_seq OWNED BY auth.refresh_tokens.id;


--
-- Name: saml_providers; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.saml_providers (
    id uuid NOT NULL,
    sso_provider_id uuid NOT NULL,
    entity_id text NOT NULL,
    metadata_xml text NOT NULL,
    metadata_url text,
    attribute_mapping jsonb,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    name_id_format text,
    CONSTRAINT "entity_id not empty" CHECK ((char_length(entity_id) > 0)),
    CONSTRAINT "metadata_url not empty" CHECK (((metadata_url = NULL::text) OR (char_length(metadata_url) > 0))),
    CONSTRAINT "metadata_xml not empty" CHECK ((char_length(metadata_xml) > 0))
);


--
-- Name: TABLE saml_providers; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.saml_providers IS 'Auth: Manages SAML Identity Provider connections.';


--
-- Name: saml_relay_states; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.saml_relay_states (
    id uuid NOT NULL,
    sso_provider_id uuid NOT NULL,
    request_id text NOT NULL,
    for_email text,
    redirect_to text,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    flow_state_id uuid,
    CONSTRAINT "request_id not empty" CHECK ((char_length(request_id) > 0))
);


--
-- Name: TABLE saml_relay_states; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.saml_relay_states IS 'Auth: Contains SAML Relay State information for each Service Provider initiated login.';


--
-- Name: schema_migrations; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.schema_migrations (
    version character varying(255) NOT NULL
);


--
-- Name: TABLE schema_migrations; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.schema_migrations IS 'Auth: Manages updates to the auth system.';


--
-- Name: sessions; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.sessions (
    id uuid NOT NULL,
    user_id uuid NOT NULL,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    factor_id uuid,
    aal auth.aal_level,
    not_after timestamp with time zone,
    refreshed_at timestamp without time zone,
    user_agent text,
    ip inet,
    tag text,
    oauth_client_id uuid,
    refresh_token_hmac_key text,
    refresh_token_counter bigint,
    scopes text,
    CONSTRAINT sessions_scopes_length CHECK ((char_length(scopes) <= 4096))
);


--
-- Name: TABLE sessions; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.sessions IS 'Auth: Stores session data associated to a user.';


--
-- Name: COLUMN sessions.not_after; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.sessions.not_after IS 'Auth: Not after is a nullable column that contains a timestamp after which the session should be regarded as expired.';


--
-- Name: COLUMN sessions.refresh_token_hmac_key; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.sessions.refresh_token_hmac_key IS 'Holds a HMAC-SHA256 key used to sign refresh tokens for this session.';


--
-- Name: COLUMN sessions.refresh_token_counter; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.sessions.refresh_token_counter IS 'Holds the ID (counter) of the last issued refresh token.';


--
-- Name: sso_domains; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.sso_domains (
    id uuid NOT NULL,
    sso_provider_id uuid NOT NULL,
    domain text NOT NULL,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    CONSTRAINT "domain not empty" CHECK ((char_length(domain) > 0))
);


--
-- Name: TABLE sso_domains; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.sso_domains IS 'Auth: Manages SSO email address domain mapping to an SSO Identity Provider.';


--
-- Name: sso_providers; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.sso_providers (
    id uuid NOT NULL,
    resource_id text,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    disabled boolean,
    CONSTRAINT "resource_id not empty" CHECK (((resource_id = NULL::text) OR (char_length(resource_id) > 0)))
);


--
-- Name: TABLE sso_providers; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.sso_providers IS 'Auth: Manages SSO identity provider information; see saml_providers for SAML.';


--
-- Name: COLUMN sso_providers.resource_id; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.sso_providers.resource_id IS 'Auth: Uniquely identifies a SSO provider according to a user-chosen resource ID (case insensitive), useful in infrastructure as code.';


--
-- Name: users; Type: TABLE; Schema: auth; Owner: -
--

CREATE TABLE auth.users (
    instance_id uuid,
    id uuid NOT NULL,
    aud character varying(255),
    role character varying(255),
    email character varying(255),
    encrypted_password character varying(255),
    email_confirmed_at timestamp with time zone,
    invited_at timestamp with time zone,
    confirmation_token character varying(255),
    confirmation_sent_at timestamp with time zone,
    recovery_token character varying(255),
    recovery_sent_at timestamp with time zone,
    email_change_token_new character varying(255),
    email_change character varying(255),
    email_change_sent_at timestamp with time zone,
    last_sign_in_at timestamp with time zone,
    raw_app_meta_data jsonb,
    raw_user_meta_data jsonb,
    is_super_admin boolean,
    created_at timestamp with time zone,
    updated_at timestamp with time zone,
    phone text DEFAULT NULL::character varying,
    phone_confirmed_at timestamp with time zone,
    phone_change text DEFAULT ''::character varying,
    phone_change_token character varying(255) DEFAULT ''::character varying,
    phone_change_sent_at timestamp with time zone,
    confirmed_at timestamp with time zone GENERATED ALWAYS AS (LEAST(email_confirmed_at, phone_confirmed_at)) STORED,
    email_change_token_current character varying(255) DEFAULT ''::character varying,
    email_change_confirm_status smallint DEFAULT 0,
    banned_until timestamp with time zone,
    reauthentication_token character varying(255) DEFAULT ''::character varying,
    reauthentication_sent_at timestamp with time zone,
    is_sso_user boolean DEFAULT false NOT NULL,
    deleted_at timestamp with time zone,
    is_anonymous boolean DEFAULT false NOT NULL,
    CONSTRAINT users_email_change_confirm_status_check CHECK (((email_change_confirm_status >= 0) AND (email_change_confirm_status <= 2)))
);


--
-- Name: TABLE users; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON TABLE auth.users IS 'Auth: Stores user login data within a secure schema.';


--
-- Name: COLUMN users.is_sso_user; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON COLUMN auth.users.is_sso_user IS 'Auth: Set this column to true when the account comes from SSO. These accounts can have duplicate emails.';


--
-- Name: checkout_session; Type: TABLE; Schema: billing; Owner: -
--

CREATE TABLE billing.checkout_session (
    checkout_id uuid DEFAULT gen_random_uuid() NOT NULL,
    invoice_id uuid NOT NULL,
    company_id uuid NOT NULL,
    customer_code text,
    provider text DEFAULT 'stripe'::text NOT NULL,
    status text DEFAULT 'created'::text NOT NULL,
    stripe_session_id text,
    stripe_url text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    last_error text,
    CONSTRAINT checkout_session_provider_check CHECK ((provider = 'stripe'::text)),
    CONSTRAINT checkout_session_status_check CHECK ((status = ANY (ARRAY['created'::text, 'redirected'::text, 'completed'::text, 'failed'::text])))
);


--
-- Name: customer_profile; Type: TABLE; Schema: billing; Owner: -
--

CREATE TABLE billing.customer_profile (
    customer_code text NOT NULL,
    customer_name text NOT NULL,
    customer_postal_code text,
    customer_address1 text,
    customer_address2 text,
    customer_tel text,
    customer_email text,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: invoice; Type: TABLE; Schema: billing; Owner: -
--

CREATE TABLE billing.invoice (
    invoice_id uuid DEFAULT gen_random_uuid() NOT NULL,
    company_id uuid NOT NULL,
    billing_month date NOT NULL,
    total_amount numeric NOT NULL,
    currency text DEFAULT 'JPY'::text NOT NULL,
    pdf_url text,
    status text DEFAULT 'issued'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    customer_code text,
    due_date date,
    tax_rate numeric,
    tax_amount numeric,
    subtotal_amount numeric
);


--
-- Name: invoice_line; Type: TABLE; Schema: billing; Owner: -
--

CREATE TABLE billing.invoice_line (
    invoice_line_id uuid DEFAULT gen_random_uuid() NOT NULL,
    invoice_id uuid NOT NULL,
    description text NOT NULL,
    quantity integer NOT NULL,
    unit_price numeric NOT NULL,
    amount numeric NOT NULL,
    tax_category text DEFAULT 'standard'::text
);


--
-- Name: invoice_send_audit; Type: TABLE; Schema: billing; Owner: -
--

CREATE TABLE billing.invoice_send_audit (
    audit_id uuid DEFAULT gen_random_uuid() NOT NULL,
    invoice_id uuid NOT NULL,
    company_id uuid NOT NULL,
    channel text NOT NULL,
    status text NOT NULL,
    attempt_no integer DEFAULT 1 NOT NULL,
    error_message text,
    requested_at timestamp with time zone DEFAULT now() NOT NULL,
    processed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: invoice_send_retry; Type: TABLE; Schema: billing; Owner: -
--

CREATE TABLE billing.invoice_send_retry (
    retry_id uuid DEFAULT gen_random_uuid() NOT NULL,
    invoice_id uuid NOT NULL,
    company_id uuid NOT NULL,
    next_retry_at timestamp with time zone NOT NULL,
    retry_count integer DEFAULT 0 NOT NULL,
    last_error text,
    status text DEFAULT 'pending'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: invoice_template; Type: TABLE; Schema: billing; Owner: -
--

CREATE TABLE billing.invoice_template (
    template_code text NOT NULL,
    locale text DEFAULT 'ja-JP'::text NOT NULL,
    html_template text NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: issuer_profile; Type: TABLE; Schema: billing; Owner: -
--

CREATE TABLE billing.issuer_profile (
    company_id uuid NOT NULL,
    issuer_name text NOT NULL,
    issuer_postal_code text,
    issuer_address1 text,
    issuer_address2 text,
    issuer_tel text,
    issuer_email text,
    issuer_reg_no text,
    bank_name text,
    bank_branch text,
    bank_account_type text,
    bank_account_no text,
    bank_account_name text,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_invoice_render_data; Type: VIEW; Schema: billing; Owner: -
--

CREATE VIEW billing.v_invoice_render_data AS
 SELECT invoice_id,
    company_id,
    billing_month,
    total_amount,
    currency,
    status,
    ( SELECT string_agg(format('%s | qty=%s | unit=%s | amount=%s'::text, il.description, il.quantity, il.unit_price, il.amount), '
'::text) AS string_agg
           FROM billing.invoice_line il
          WHERE (il.invoice_id = i.invoice_id)) AS lines_text
   FROM billing.invoice i;


--
-- Name: v_invoice_render_data_ext; Type: VIEW; Schema: billing; Owner: -
--

CREATE VIEW billing.v_invoice_render_data_ext AS
 SELECT v.invoice_id,
    v.company_id,
    v.billing_month,
    v.total_amount,
    v.currency,
    v.status,
    v.lines_text,
    ip.issuer_name,
    ip.issuer_postal_code,
    ip.issuer_address1,
    ip.issuer_address2,
    ip.issuer_tel,
    ip.issuer_email,
    ip.issuer_reg_no,
    ip.bank_name,
    ip.bank_branch,
    ip.bank_account_type,
    ip.bank_account_no,
    ip.bank_account_name,
    concat_ws(' '::text, ip.issuer_postal_code, ip.issuer_address1, ip.issuer_address2) AS issuer_full_address,
    now() AS render_generated_at
   FROM (billing.v_invoice_render_data v
     LEFT JOIN billing.issuer_profile ip ON ((ip.company_id = v.company_id)));


--
-- Name: escalation_outbox; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.escalation_outbox (
    outbox_id uuid DEFAULT gen_random_uuid() NOT NULL,
    request_id uuid NOT NULL,
    payload jsonb NOT NULL,
    status text DEFAULT 'queued'::text NOT NULL,
    retry_count integer DEFAULT 0 NOT NULL,
    last_error text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    sent_at timestamp with time zone
);


--
-- Name: json_schema_check_log; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.json_schema_check_log (
    check_id uuid DEFAULT gen_random_uuid() NOT NULL,
    check_scope text NOT NULL,
    schema_name text NOT NULL,
    status text NOT NULL,
    diff_summary text,
    checked_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: kill_switch; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.kill_switch (
    switch_name text NOT NULL,
    is_enabled boolean DEFAULT true NOT NULL,
    reason text,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ops_notification_queue; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.ops_notification_queue (
    notification_id uuid DEFAULT gen_random_uuid() NOT NULL,
    channel text NOT NULL,
    destination text NOT NULL,
    payload jsonb NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    error text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    sent_at timestamp with time zone
);


--
-- Name: schema_ai_review_job; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.schema_ai_review_job (
    job_id uuid DEFAULT gen_random_uuid() NOT NULL,
    request_id uuid NOT NULL,
    status text DEFAULT 'queued'::text NOT NULL,
    prompt text NOT NULL,
    response text,
    error text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: schema_review_prompt_template; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.schema_review_prompt_template (
    template_id uuid DEFAULT gen_random_uuid() NOT NULL,
    domain text NOT NULL,
    schema_name text NOT NULL,
    is_enabled boolean DEFAULT true NOT NULL,
    prompt_prefix text NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: schema_review_summary; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.schema_review_summary (
    request_id uuid NOT NULL,
    summary_ja text NOT NULL,
    generated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: sla_escalation_policy; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.sla_escalation_policy (
    policy_id uuid DEFAULT gen_random_uuid() NOT NULL,
    domain text NOT NULL,
    threshold_min integer NOT NULL,
    severity text DEFAULT 'high'::text NOT NULL,
    is_enabled boolean DEFAULT true NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: slack_approval_audit; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.slack_approval_audit (
    audit_id uuid DEFAULT gen_random_uuid() NOT NULL,
    request_id uuid NOT NULL,
    action text NOT NULL,
    actor text NOT NULL,
    source text DEFAULT 'slack'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: slack_interaction_log; Type: TABLE; Schema: ci; Owner: -
--

CREATE TABLE ci.slack_interaction_log (
    interaction_id uuid DEFAULT gen_random_uuid() NOT NULL,
    request_id uuid,
    action text,
    actor text,
    payload jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_admin_all_requests; Type: VIEW; Schema: ci; Owner: -
--

CREATE VIEW ci.v_admin_all_requests AS
 SELECT request_id,
    domain,
    schema_name,
    status,
    review_status,
    review_summary_ja,
    requested_by,
    requested_at,
    approved_by,
    approved_at
   FROM ci.schema_change_request
  ORDER BY requested_at DESC;


--
-- Name: v_android_pending; Type: VIEW; Schema: ci; Owner: -
--

CREATE VIEW ci.v_android_pending AS
 SELECT request_id,
    domain,
    schema_name,
    review_status,
    review_summary_ja,
    requested_by,
    requested_at
   FROM ci.schema_change_request
  WHERE (status = 'pending'::text)
  ORDER BY requested_at;


--
-- Name: v_edge_deploy_allowed; Type: VIEW; Schema: ci; Owner: -
--

CREATE VIEW ci.v_edge_deploy_allowed AS
 SELECT (NOT (EXISTS ( SELECT 1
           FROM ci.schema_change_request
          WHERE (schema_change_request.status = 'pending'::text)))) AS deploy_allowed;


--
-- Name: v_kill_switch; Type: VIEW; Schema: ci; Owner: -
--

CREATE VIEW ci.v_kill_switch AS
 SELECT switch_name,
    is_enabled,
    reason,
    updated_at
   FROM ci.kill_switch;


--
-- Name: v_schema_change_sla; Type: VIEW; Schema: ci; Owner: -
--

CREATE VIEW ci.v_schema_change_sla AS
 SELECT schema_name,
    status,
    review_status,
    count(*) AS change_count,
    percentile_cont((0.5)::double precision) WITHIN GROUP (ORDER BY ((EXTRACT(epoch FROM (approved_at - requested_at)))::double precision)) FILTER (WHERE ((status = 'approved'::text) AND (approved_at IS NOT NULL))) AS p50_seconds_to_approve,
    percentile_cont((0.9)::double precision) WITHIN GROUP (ORDER BY ((EXTRACT(epoch FROM (approved_at - requested_at)))::double precision)) FILTER (WHERE ((status = 'approved'::text) AND (approved_at IS NOT NULL))) AS p90_seconds_to_approve,
    percentile_cont((0.5)::double precision) WITHIN GROUP (ORDER BY ((EXTRACT(epoch FROM (reviewed_at - requested_at)))::double precision)) FILTER (WHERE (reviewed_at IS NOT NULL)) AS p50_seconds_to_review,
    max(requested_at) AS last_requested_at
   FROM ci.schema_change_request
  GROUP BY schema_name, status, review_status;


--
-- Name: v_ops_dashboard; Type: VIEW; Schema: ci; Owner: -
--

CREATE VIEW ci.v_ops_dashboard AS
 SELECT r.request_id,
    r.schema_name,
    r.status,
    r.review_status,
    r.review_summary,
    r.requested_by,
    r.requested_at,
    r.approved_by,
    r.approved_at,
    ks.is_enabled AS edge_deploy_enabled,
    ks.reason AS kill_switch_reason,
    sla.p50_seconds_to_review,
    sla.p50_seconds_to_approve
   FROM ((ci.schema_change_request r
     LEFT JOIN ci.kill_switch ks ON ((ks.switch_name = 'edge_deploy'::text)))
     LEFT JOIN ci.v_schema_change_sla sla ON (((sla.schema_name = r.schema_name) AND (sla.status = r.status) AND (sla.review_status = r.review_status))));


--
-- Name: v_pending_with_ui_link; Type: VIEW; Schema: ci; Owner: -
--

CREATE VIEW ci.v_pending_with_ui_link AS
 SELECT request_id,
    domain,
    schema_name,
    requested_by,
    requested_at,
    review_summary_ja,
    concat('/?request_id=', request_id) AS ui_path
   FROM ci.schema_change_request r
  WHERE (status = 'pending'::text);


--
-- Name: v_schema_change_approvable; Type: VIEW; Schema: ci; Owner: -
--

CREATE VIEW ci.v_schema_change_approvable AS
 SELECT r.request_id,
    r.schema_name,
    r.requested_by,
    r.diff_summary,
    r.status,
    r.requested_at,
    r.approved_by,
    r.approved_at,
    r.review_status,
    r.review_summary,
    r.reviewed_at,
    ks.is_enabled AS edge_deploy_enabled
   FROM (ci.schema_change_request r
     LEFT JOIN ci.kill_switch ks ON ((ks.switch_name = 'edge_deploy'::text)))
  WHERE ((r.status = 'pending'::text) AND (r.review_status = 'ok'::text) AND (COALESCE(ks.is_enabled, true) = true));


--
-- Name: v_schema_change_sla_30d; Type: VIEW; Schema: ci; Owner: -
--

CREATE VIEW ci.v_schema_change_sla_30d AS
 SELECT schema_name,
    status,
    review_status,
    change_count,
    p50_seconds_to_approve,
    p90_seconds_to_approve,
    p50_seconds_to_review,
    last_requested_at
   FROM ci.v_schema_change_sla
  WHERE (last_requested_at >= (now() - '30 days'::interval));


--
-- Name: v_sla_overdue_requests; Type: VIEW; Schema: ci; Owner: -
--

CREATE VIEW ci.v_sla_overdue_requests AS
 SELECT r.request_id,
    r.domain,
    r.schema_name,
    r.requested_by,
    r.requested_at,
    r.diff_summary,
    p.threshold_min,
    p.severity,
    (now() - r.requested_at) AS overdue_by
   FROM (ci.schema_change_request r
     JOIN ci.sla_escalation_policy p ON ((p.domain = COALESCE(r.domain, p.domain))))
  WHERE ((r.status = 'pending'::text) AND (p.is_enabled = true) AND ((now() - r.requested_at) > make_interval(mins => p.threshold_min)));


--
-- Name: audit_action; Type: TABLE; Schema: compliance; Owner: -
--

CREATE TABLE compliance.audit_action (
    audit_action_id bigint NOT NULL,
    audit_issue_id bigint NOT NULL,
    action_plan text NOT NULL,
    owner_id uuid,
    due_date date,
    status_code text DEFAULT 'OPEN'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: audit_action_audit_action_id_seq; Type: SEQUENCE; Schema: compliance; Owner: -
--

CREATE SEQUENCE compliance.audit_action_audit_action_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_action_audit_action_id_seq; Type: SEQUENCE OWNED BY; Schema: compliance; Owner: -
--

ALTER SEQUENCE compliance.audit_action_audit_action_id_seq OWNED BY compliance.audit_action.audit_action_id;


--
-- Name: audit_event; Type: TABLE; Schema: compliance; Owner: -
--

CREATE TABLE compliance.audit_event (
    audit_event_id bigint NOT NULL,
    company_id uuid NOT NULL,
    iso_standard_id bigint,
    audit_date date NOT NULL,
    audit_type text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY compliance.audit_event FORCE ROW LEVEL SECURITY;


--
-- Name: audit_event_audit_event_id_seq; Type: SEQUENCE; Schema: compliance; Owner: -
--

CREATE SEQUENCE compliance.audit_event_audit_event_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_event_audit_event_id_seq; Type: SEQUENCE OWNED BY; Schema: compliance; Owner: -
--

ALTER SEQUENCE compliance.audit_event_audit_event_id_seq OWNED BY compliance.audit_event.audit_event_id;


--
-- Name: audit_issue; Type: TABLE; Schema: compliance; Owner: -
--

CREATE TABLE compliance.audit_issue (
    audit_issue_id bigint NOT NULL,
    audit_event_id bigint NOT NULL,
    iso_clause_id bigint,
    severity text DEFAULT 'MINOR'::text NOT NULL,
    description text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: audit_issue_audit_issue_id_seq; Type: SEQUENCE; Schema: compliance; Owner: -
--

CREATE SEQUENCE compliance.audit_issue_audit_issue_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_issue_audit_issue_id_seq; Type: SEQUENCE OWNED BY; Schema: compliance; Owner: -
--

ALTER SEQUENCE compliance.audit_issue_audit_issue_id_seq OWNED BY compliance.audit_issue.audit_issue_id;


--
-- Name: iso_clause; Type: TABLE; Schema: compliance; Owner: -
--

CREATE TABLE compliance.iso_clause (
    iso_clause_id bigint NOT NULL,
    iso_standard_id bigint NOT NULL,
    clause_code text NOT NULL,
    clause_name text NOT NULL
);


--
-- Name: iso_clause_iso_clause_id_seq; Type: SEQUENCE; Schema: compliance; Owner: -
--

CREATE SEQUENCE compliance.iso_clause_iso_clause_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: iso_clause_iso_clause_id_seq; Type: SEQUENCE OWNED BY; Schema: compliance; Owner: -
--

ALTER SEQUENCE compliance.iso_clause_iso_clause_id_seq OWNED BY compliance.iso_clause.iso_clause_id;


--
-- Name: iso_standard; Type: TABLE; Schema: compliance; Owner: -
--

CREATE TABLE compliance.iso_standard (
    iso_standard_id bigint NOT NULL,
    iso_code text NOT NULL,
    iso_name text NOT NULL
);


--
-- Name: iso_standard_iso_standard_id_seq; Type: SEQUENCE; Schema: compliance; Owner: -
--

CREATE SEQUENCE compliance.iso_standard_iso_standard_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: iso_standard_iso_standard_id_seq; Type: SEQUENCE OWNED BY; Schema: compliance; Owner: -
--

ALTER SEQUENCE compliance.iso_standard_iso_standard_id_seq OWNED BY compliance.iso_standard.iso_standard_id;


--
-- Name: accounting_period; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.accounting_period (
    period_id bigint NOT NULL,
    company_id uuid NOT NULL,
    period_year integer NOT NULL,
    period_month integer NOT NULL,
    is_closed boolean DEFAULT false NOT NULL,
    closed_at timestamp with time zone,
    CONSTRAINT accounting_period_period_month_check CHECK (((period_month >= 1) AND (period_month <= 12)))
);

ALTER TABLE ONLY core.accounting_period FORCE ROW LEVEL SECURITY;


--
-- Name: accounting_period_period_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.accounting_period_period_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: accounting_period_period_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.accounting_period_period_id_seq OWNED BY core.accounting_period.period_id;


--
-- Name: accounts; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.accounts (
    account_id bigint NOT NULL,
    company_id uuid NOT NULL,
    account_code text NOT NULL,
    account_name text NOT NULL,
    account_type text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.accounts FORCE ROW LEVEL SECURITY;


--
-- Name: accounts_account_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.accounts_account_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: accounts_account_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.accounts_account_id_seq OWNED BY core.accounts.account_id;


--
-- Name: app_user; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.app_user (
    user_id uuid DEFAULT gen_random_uuid() NOT NULL,
    company_id uuid NOT NULL,
    email text NOT NULL,
    display_name text,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.app_user FORCE ROW LEVEL SECURITY;


--
-- Name: audit_column_weight; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_column_weight (
    column_weight_id bigint NOT NULL,
    company_id uuid,
    entity_type_like text NOT NULL,
    column_name text NOT NULL,
    weight numeric(10,4) DEFAULT 1.0 NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);

ALTER TABLE ONLY core.audit_column_weight FORCE ROW LEVEL SECURITY;


--
-- Name: audit_column_weight_column_weight_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.audit_column_weight_column_weight_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_column_weight_column_weight_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.audit_column_weight_column_weight_id_seq OWNED BY core.audit_column_weight.column_weight_id;


--
-- Name: audit_entity_pk_map; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_entity_pk_map (
    schema_name text NOT NULL,
    table_name text NOT NULL,
    pk_column text NOT NULL
);


--
-- Name: audit_impact_rule; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_impact_rule (
    rule_id bigint NOT NULL,
    company_id uuid,
    entity_type_like text NOT NULL,
    action text NOT NULL,
    base_weight numeric(10,4) DEFAULT 1.0 NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    priority integer DEFAULT 100 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.audit_impact_rule FORCE ROW LEVEL SECURITY;


--
-- Name: audit_impact_rule_rule_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.audit_impact_rule_rule_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_impact_rule_rule_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.audit_impact_rule_rule_id_seq OWNED BY core.audit_impact_rule.rule_id;


--
-- Name: audit_trail_audit_trail_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.audit_trail_audit_trail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_trail_audit_trail_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.audit_trail_audit_trail_id_seq OWNED BY core.audit_trail.audit_trail_id;


--
-- Name: audit_trail_2025_12; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_trail_2025_12 (
    audit_trail_id bigint DEFAULT nextval('core.audit_trail_audit_trail_id_seq'::regclass) NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    action text NOT NULL,
    action_category text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    performed_by uuid,
    performed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_trail_action_category_check CHECK ((action_category = ANY (ARRAY['READ'::text, 'WRITE'::text, 'ADMIN'::text])))
);

ALTER TABLE ONLY core.audit_trail_2025_12 FORCE ROW LEVEL SECURITY;


--
-- Name: audit_trail_2026_01; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_trail_2026_01 (
    audit_trail_id bigint DEFAULT nextval('core.audit_trail_audit_trail_id_seq'::regclass) NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    action text NOT NULL,
    action_category text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    performed_by uuid,
    performed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_trail_action_category_check CHECK ((action_category = ANY (ARRAY['READ'::text, 'WRITE'::text, 'ADMIN'::text])))
);

ALTER TABLE ONLY core.audit_trail_2026_01 FORCE ROW LEVEL SECURITY;


--
-- Name: audit_trail_2026_02; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_trail_2026_02 (
    audit_trail_id bigint DEFAULT nextval('core.audit_trail_audit_trail_id_seq'::regclass) NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    action text NOT NULL,
    action_category text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    performed_by uuid,
    performed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_trail_action_category_check CHECK ((action_category = ANY (ARRAY['READ'::text, 'WRITE'::text, 'ADMIN'::text])))
);

ALTER TABLE ONLY core.audit_trail_2026_02 FORCE ROW LEVEL SECURITY;


--
-- Name: audit_trail_2026_03; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_trail_2026_03 (
    audit_trail_id bigint DEFAULT nextval('core.audit_trail_audit_trail_id_seq'::regclass) NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    action text NOT NULL,
    action_category text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    performed_by uuid,
    performed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_trail_action_category_check CHECK ((action_category = ANY (ARRAY['READ'::text, 'WRITE'::text, 'ADMIN'::text])))
);

ALTER TABLE ONLY core.audit_trail_2026_03 FORCE ROW LEVEL SECURITY;


--
-- Name: audit_trail_2026_04; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_trail_2026_04 (
    audit_trail_id bigint DEFAULT nextval('core.audit_trail_audit_trail_id_seq'::regclass) NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    action text NOT NULL,
    action_category text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    performed_by uuid,
    performed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_trail_action_category_check CHECK ((action_category = ANY (ARRAY['READ'::text, 'WRITE'::text, 'ADMIN'::text])))
);

ALTER TABLE ONLY core.audit_trail_2026_04 FORCE ROW LEVEL SECURITY;


--
-- Name: audit_trail_2026_05; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_trail_2026_05 (
    audit_trail_id bigint DEFAULT nextval('core.audit_trail_audit_trail_id_seq'::regclass) NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    action text NOT NULL,
    action_category text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    performed_by uuid,
    performed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_trail_action_category_check CHECK ((action_category = ANY (ARRAY['READ'::text, 'WRITE'::text, 'ADMIN'::text])))
);

ALTER TABLE ONLY core.audit_trail_2026_05 FORCE ROW LEVEL SECURITY;


--
-- Name: audit_trail_2026_06; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_trail_2026_06 (
    audit_trail_id bigint DEFAULT nextval('core.audit_trail_audit_trail_id_seq'::regclass) NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    action text NOT NULL,
    action_category text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    performed_by uuid,
    performed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_trail_action_category_check CHECK ((action_category = ANY (ARRAY['READ'::text, 'WRITE'::text, 'ADMIN'::text])))
);

ALTER TABLE ONLY core.audit_trail_2026_06 FORCE ROW LEVEL SECURITY;


--
-- Name: audit_trail_2026_07; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.audit_trail_2026_07 (
    audit_trail_id bigint DEFAULT nextval('core.audit_trail_audit_trail_id_seq'::regclass) NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    action text NOT NULL,
    action_category text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    performed_by uuid,
    performed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_trail_action_category_check CHECK ((action_category = ANY (ARRAY['READ'::text, 'WRITE'::text, 'ADMIN'::text])))
);

ALTER TABLE ONLY core.audit_trail_2026_07 FORCE ROW LEVEL SECURITY;


--
-- Name: company; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.company (
    company_id uuid DEFAULT gen_random_uuid() NOT NULL,
    company_code text NOT NULL,
    company_name text NOT NULL,
    currency_code text DEFAULT 'JPY'::text NOT NULL,
    timezone text DEFAULT 'Asia/Tokyo'::text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.company FORCE ROW LEVEL SECURITY;


--
-- Name: company_license_company_license_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.company_license_company_license_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: company_license_company_license_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.company_license_company_license_id_seq OWNED BY core.company_license.company_license_id;


--
-- Name: company_permission; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.company_permission (
    company_permission_id bigint NOT NULL,
    company_id uuid NOT NULL,
    permission_code text NOT NULL,
    enabled boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.company_permission FORCE ROW LEVEL SECURITY;


--
-- Name: company_permission_company_permission_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.company_permission_company_permission_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: company_permission_company_permission_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.company_permission_company_permission_id_seq OWNED BY core.company_permission.company_permission_id;


--
-- Name: company_users; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.company_users (
    company_user_id bigint NOT NULL,
    company_id uuid NOT NULL,
    user_id uuid NOT NULL,
    role_code text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.company_users FORCE ROW LEVEL SECURITY;


--
-- Name: company_users_company_user_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.company_users_company_user_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: company_users_company_user_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.company_users_company_user_id_seq OWNED BY core.company_users.company_user_id;


--
-- Name: document_sequence; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.document_sequence (
    sequence_id bigint NOT NULL,
    company_id uuid NOT NULL,
    doc_type text NOT NULL,
    prefix text DEFAULT ''::text NOT NULL,
    current_no bigint DEFAULT 0 NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.document_sequence FORCE ROW LEVEL SECURITY;


--
-- Name: document_sequence_sequence_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.document_sequence_sequence_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: document_sequence_sequence_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.document_sequence_sequence_id_seq OWNED BY core.document_sequence.sequence_id;


--
-- Name: entity_attribute_def; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.entity_attribute_def (
    attribute_def_id bigint NOT NULL,
    entity_type text NOT NULL,
    attribute_code text NOT NULL,
    attribute_name text NOT NULL,
    data_type text NOT NULL,
    is_required boolean DEFAULT false NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: entity_attribute_def_attribute_def_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.entity_attribute_def_attribute_def_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: entity_attribute_def_attribute_def_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.entity_attribute_def_attribute_def_id_seq OWNED BY core.entity_attribute_def.attribute_def_id;


--
-- Name: entity_attribute_value; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.entity_attribute_value (
    attribute_value_id bigint NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    attribute_def_id bigint NOT NULL,
    value_text text,
    value_number numeric(18,4),
    value_date date,
    value_boolean boolean,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: entity_attribute_value_attribute_value_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.entity_attribute_value_attribute_value_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: entity_attribute_value_attribute_value_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.entity_attribute_value_attribute_value_id_seq OWNED BY core.entity_attribute_value.attribute_value_id;


--
-- Name: journal_entries; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.journal_entries (
    journal_id bigint NOT NULL,
    company_id uuid NOT NULL,
    period_id bigint,
    journal_date date NOT NULL,
    description text,
    source_type text,
    source_id text,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.journal_entries FORCE ROW LEVEL SECURITY;


--
-- Name: journal_entries_journal_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.journal_entries_journal_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: journal_entries_journal_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.journal_entries_journal_id_seq OWNED BY core.journal_entries.journal_id;


--
-- Name: journal_lines; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.journal_lines (
    journal_line_id bigint NOT NULL,
    journal_id bigint NOT NULL,
    line_no integer NOT NULL,
    account_id bigint NOT NULL,
    debit_amount numeric(18,2) DEFAULT 0 NOT NULL,
    credit_amount numeric(18,2) DEFAULT 0 NOT NULL,
    memo text,
    CONSTRAINT journal_lines_check CHECK ((((debit_amount = (0)::numeric) AND (credit_amount > (0)::numeric)) OR ((credit_amount = (0)::numeric) AND (debit_amount > (0)::numeric))))
);


--
-- Name: journal_lines_journal_line_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.journal_lines_journal_line_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: journal_lines_journal_line_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.journal_lines_journal_line_id_seq OWNED BY core.journal_lines.journal_line_id;


--
-- Name: journal_source_link; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.journal_source_link (
    journal_source_link_id bigint NOT NULL,
    journal_id bigint NOT NULL,
    source_type text NOT NULL,
    source_id text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: journal_source_link_journal_source_link_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.journal_source_link_journal_source_link_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: journal_source_link_journal_source_link_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.journal_source_link_journal_source_link_id_seq OWNED BY core.journal_source_link.journal_source_link_id;


--
-- Name: license_master; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.license_master (
    code text NOT NULL,
    name text NOT NULL,
    description text,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: login_history; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.login_history (
    login_id bigint NOT NULL,
    user_id uuid NOT NULL,
    logged_in_at timestamp with time zone DEFAULT now() NOT NULL,
    ip_addr inet,
    user_agent text
);


--
-- Name: login_history_login_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.login_history_login_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: login_history_login_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.login_history_login_id_seq OWNED BY core.login_history.login_id;


--
-- Name: payment_method; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.payment_method (
    payment_method_code text NOT NULL,
    payment_method_name text NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: payment_term; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.payment_term (
    payment_term_id bigint NOT NULL,
    term_code text NOT NULL,
    term_name text NOT NULL,
    closing_day integer,
    payment_offset_month integer DEFAULT 0 NOT NULL,
    payment_day integer,
    description text,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: payment_term_payment_term_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.payment_term_payment_term_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: payment_term_payment_term_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.payment_term_payment_term_id_seq OWNED BY core.payment_term.payment_term_id;


--
-- Name: permission_group_permissions; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.permission_group_permissions (
    group_id bigint NOT NULL,
    permission_id bigint NOT NULL
);


--
-- Name: permission_groups; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.permission_groups (
    group_id bigint NOT NULL,
    company_id uuid NOT NULL,
    group_code text NOT NULL,
    group_name text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.permission_groups FORCE ROW LEVEL SECURITY;


--
-- Name: permission_groups_group_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.permission_groups_group_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: permission_groups_group_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.permission_groups_group_id_seq OWNED BY core.permission_groups.group_id;


--
-- Name: permissions; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.permissions (
    permission_id bigint NOT NULL,
    company_id uuid,
    code text NOT NULL,
    name text NOT NULL,
    description text,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.permissions FORCE ROW LEVEL SECURITY;


--
-- Name: permissions_permission_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.permissions_permission_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: permissions_permission_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.permissions_permission_id_seq OWNED BY core.permissions.permission_id;


--
-- Name: posting_profile; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.posting_profile (
    posting_profile_id bigint NOT NULL,
    company_id uuid NOT NULL,
    profile_code text NOT NULL,
    source_type text NOT NULL,
    debit_account_id bigint NOT NULL,
    credit_account_id bigint NOT NULL,
    description text,
    is_active boolean DEFAULT true NOT NULL
);

ALTER TABLE ONLY core.posting_profile FORCE ROW LEVEL SECURITY;


--
-- Name: posting_profile_posting_profile_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.posting_profile_posting_profile_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: posting_profile_posting_profile_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.posting_profile_posting_profile_id_seq OWNED BY core.posting_profile.posting_profile_id;


--
-- Name: reason_code_master; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.reason_code_master (
    reason_code text NOT NULL,
    reason_name text NOT NULL,
    target_ops text[] NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    valid_from date DEFAULT CURRENT_DATE NOT NULL,
    valid_to date,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: status_history; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.status_history (
    status_history_id bigint NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    from_status_code text,
    to_status_code text NOT NULL,
    changed_by uuid,
    changed_at timestamp with time zone DEFAULT now() NOT NULL,
    reason text
);

ALTER TABLE ONLY core.status_history FORCE ROW LEVEL SECURITY;


--
-- Name: status_history_status_history_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.status_history_status_history_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: status_history_status_history_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.status_history_status_history_id_seq OWNED BY core.status_history.status_history_id;


--
-- Name: status_master; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.status_master (
    status_id bigint NOT NULL,
    entity_type text NOT NULL,
    status_code text NOT NULL,
    status_name text NOT NULL,
    sort_order integer DEFAULT 0 NOT NULL,
    is_terminal boolean DEFAULT false NOT NULL
);


--
-- Name: status_master_status_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.status_master_status_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: status_master_status_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.status_master_status_id_seq OWNED BY core.status_master.status_id;


--
-- Name: sync_queue; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.sync_queue (
    sync_id bigint NOT NULL,
    company_id uuid,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    action text NOT NULL,
    payload jsonb DEFAULT '{}'::jsonb NOT NULL,
    status text DEFAULT 'PENDING'::text NOT NULL,
    retry_count integer DEFAULT 0 NOT NULL,
    last_error text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY core.sync_queue FORCE ROW LEVEL SECURITY;


--
-- Name: sync_queue_sync_id_seq; Type: SEQUENCE; Schema: core; Owner: -
--

CREATE SEQUENCE core.sync_queue_sync_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: sync_queue_sync_id_seq; Type: SEQUENCE OWNED BY; Schema: core; Owner: -
--

ALTER SEQUENCE core.sync_queue_sync_id_seq OWNED BY core.sync_queue.sync_id;


--
-- Name: uom; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.uom (
    uom_code text NOT NULL,
    uom_name text NOT NULL,
    uom_type text NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: uom_conversion; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.uom_conversion (
    from_uom_code text NOT NULL,
    to_uom_code text NOT NULL,
    conversion_rate numeric(18,6) NOT NULL
);


--
-- Name: user_permissions; Type: TABLE; Schema: core; Owner: -
--

CREATE TABLE core.user_permissions (
    user_id uuid NOT NULL,
    permission_id bigint NOT NULL,
    granted_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_audit_diff_only; Type: VIEW; Schema: core; Owner: -
--

CREATE VIEW core.v_audit_diff_only AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    performed_at,
    performed_by,
    jsonb_strip_nulls(jsonb_object_agg(k, jsonb_build_object('before', before_val, 'after', after_val))) AS diff
   FROM ( SELECT at.audit_trail_id,
            at.company_id,
            at.entity_type,
            at.entity_id,
            at.action,
            at.performed_at,
            at.performed_by,
            k.k,
            ((at.detail -> 'before'::text) -> k.k) AS before_val,
            ((at.detail -> 'after'::text) -> k.k) AS after_val
           FROM core.audit_trail at,
            LATERAL jsonb_object_keys(COALESCE((at.detail -> 'after'::text), '{}'::jsonb)) k(k)
          WHERE ((at.action = 'UPDATE'::text) AND (((at.detail -> 'before'::text) -> k.k) IS DISTINCT FROM ((at.detail -> 'after'::text) -> k.k)))) s
  GROUP BY audit_trail_id, company_id, entity_type, entity_id, action, performed_at, performed_by;


--
-- Name: v_change_history_all; Type: VIEW; Schema: core; Owner: -
--

CREATE VIEW core.v_change_history_all AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    action_category,
    detail,
    performed_by,
    performed_at
   FROM core.audit_trail;


--
-- Name: codegen_artifact; Type: TABLE; Schema: devops; Owner: -
--

CREATE TABLE devops.codegen_artifact (
    artifact_id uuid DEFAULT gen_random_uuid() NOT NULL,
    run_id uuid NOT NULL,
    kind text NOT NULL,
    path text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: codegen_run; Type: TABLE; Schema: devops; Owner: -
--

CREATE TABLE devops.codegen_run (
    run_id uuid DEFAULT gen_random_uuid() NOT NULL,
    phase text NOT NULL,
    input_hash text NOT NULL,
    status text NOT NULL,
    generated_at timestamp with time zone DEFAULT now() NOT NULL,
    note text,
    CONSTRAINT codegen_run_status_check CHECK ((status = ANY (ARRAY['success'::text, 'failure'::text])))
);


--
-- Name: bank_account; Type: TABLE; Schema: finance; Owner: -
--

CREATE TABLE finance.bank_account (
    bank_account_id bigint NOT NULL,
    company_id uuid NOT NULL,
    bank_name text NOT NULL,
    branch_name text,
    account_type text NOT NULL,
    account_number text NOT NULL,
    account_name text NOT NULL,
    currency_code text DEFAULT 'JPY'::text NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);

ALTER TABLE ONLY finance.bank_account FORCE ROW LEVEL SECURITY;


--
-- Name: bank_account_bank_account_id_seq; Type: SEQUENCE; Schema: finance; Owner: -
--

CREATE SEQUENCE finance.bank_account_bank_account_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: bank_account_bank_account_id_seq; Type: SEQUENCE OWNED BY; Schema: finance; Owner: -
--

ALTER SEQUENCE finance.bank_account_bank_account_id_seq OWNED BY finance.bank_account.bank_account_id;


--
-- Name: bank_statement_header; Type: TABLE; Schema: finance; Owner: -
--

CREATE TABLE finance.bank_statement_header (
    bank_statement_id bigint NOT NULL,
    bank_account_id bigint NOT NULL,
    statement_date date NOT NULL,
    imported_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: bank_statement_header_bank_statement_id_seq; Type: SEQUENCE; Schema: finance; Owner: -
--

CREATE SEQUENCE finance.bank_statement_header_bank_statement_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: bank_statement_header_bank_statement_id_seq; Type: SEQUENCE OWNED BY; Schema: finance; Owner: -
--

ALTER SEQUENCE finance.bank_statement_header_bank_statement_id_seq OWNED BY finance.bank_statement_header.bank_statement_id;


--
-- Name: bank_statement_line; Type: TABLE; Schema: finance; Owner: -
--

CREATE TABLE finance.bank_statement_line (
    bank_statement_line_id bigint NOT NULL,
    bank_statement_id bigint NOT NULL,
    line_no integer NOT NULL,
    transaction_date date NOT NULL,
    description text,
    debit_amount numeric(18,2) DEFAULT 0 NOT NULL,
    credit_amount numeric(18,2) DEFAULT 0 NOT NULL,
    balance_amount numeric(18,2)
);


--
-- Name: bank_statement_line_bank_statement_line_id_seq; Type: SEQUENCE; Schema: finance; Owner: -
--

CREATE SEQUENCE finance.bank_statement_line_bank_statement_line_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: bank_statement_line_bank_statement_line_id_seq; Type: SEQUENCE OWNED BY; Schema: finance; Owner: -
--

ALTER SEQUENCE finance.bank_statement_line_bank_statement_line_id_seq OWNED BY finance.bank_statement_line.bank_statement_line_id;


--
-- Name: payment; Type: TABLE; Schema: finance; Owner: -
--

CREATE TABLE finance.payment (
    payment_id bigint NOT NULL,
    company_id uuid NOT NULL,
    payment_type text NOT NULL,
    partner_type text NOT NULL,
    partner_id bigint NOT NULL,
    payment_date date NOT NULL,
    amount numeric(18,2) NOT NULL,
    bank_account_id bigint,
    status_code text DEFAULT 'POSTED'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY finance.payment FORCE ROW LEVEL SECURITY;


--
-- Name: payment_allocation; Type: TABLE; Schema: finance; Owner: -
--

CREATE TABLE finance.payment_allocation (
    payment_allocation_id bigint NOT NULL,
    payment_id bigint NOT NULL,
    source_type text NOT NULL,
    source_id bigint NOT NULL,
    allocated_amount numeric(18,2) NOT NULL,
    allocated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: payment_allocation_payment_allocation_id_seq; Type: SEQUENCE; Schema: finance; Owner: -
--

CREATE SEQUENCE finance.payment_allocation_payment_allocation_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: payment_allocation_payment_allocation_id_seq; Type: SEQUENCE OWNED BY; Schema: finance; Owner: -
--

ALTER SEQUENCE finance.payment_allocation_payment_allocation_id_seq OWNED BY finance.payment_allocation.payment_allocation_id;


--
-- Name: payment_payment_id_seq; Type: SEQUENCE; Schema: finance; Owner: -
--

CREATE SEQUENCE finance.payment_payment_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: payment_payment_id_seq; Type: SEQUENCE OWNED BY; Schema: finance; Owner: -
--

ALTER SEQUENCE finance.payment_payment_id_seq OWNED BY finance.payment.payment_id;


--
-- Name: business_rule; Type: TABLE; Schema: governance; Owner: -
--

CREATE TABLE governance.business_rule (
    business_rule_id bigint NOT NULL,
    company_id uuid NOT NULL,
    rule_code text NOT NULL,
    target_entity text NOT NULL,
    rule_type text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY governance.business_rule FORCE ROW LEVEL SECURITY;


--
-- Name: business_rule_action; Type: TABLE; Schema: governance; Owner: -
--

CREATE TABLE governance.business_rule_action (
    rule_action_id bigint NOT NULL,
    business_rule_id bigint NOT NULL,
    action_type text NOT NULL,
    action_value text
);


--
-- Name: business_rule_action_rule_action_id_seq; Type: SEQUENCE; Schema: governance; Owner: -
--

CREATE SEQUENCE governance.business_rule_action_rule_action_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: business_rule_action_rule_action_id_seq; Type: SEQUENCE OWNED BY; Schema: governance; Owner: -
--

ALTER SEQUENCE governance.business_rule_action_rule_action_id_seq OWNED BY governance.business_rule_action.rule_action_id;


--
-- Name: business_rule_business_rule_id_seq; Type: SEQUENCE; Schema: governance; Owner: -
--

CREATE SEQUENCE governance.business_rule_business_rule_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: business_rule_business_rule_id_seq; Type: SEQUENCE OWNED BY; Schema: governance; Owner: -
--

ALTER SEQUENCE governance.business_rule_business_rule_id_seq OWNED BY governance.business_rule.business_rule_id;


--
-- Name: business_rule_condition; Type: TABLE; Schema: governance; Owner: -
--

CREATE TABLE governance.business_rule_condition (
    rule_condition_id bigint NOT NULL,
    business_rule_id bigint NOT NULL,
    condition_expr text NOT NULL,
    priority integer DEFAULT 1 NOT NULL
);


--
-- Name: business_rule_condition_rule_condition_id_seq; Type: SEQUENCE; Schema: governance; Owner: -
--

CREATE SEQUENCE governance.business_rule_condition_rule_condition_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: business_rule_condition_rule_condition_id_seq; Type: SEQUENCE OWNED BY; Schema: governance; Owner: -
--

ALTER SEQUENCE governance.business_rule_condition_rule_condition_id_seq OWNED BY governance.business_rule_condition.rule_condition_id;


--
-- Name: contract_header; Type: TABLE; Schema: governance; Owner: -
--

CREATE TABLE governance.contract_header (
    contract_id bigint NOT NULL,
    company_id uuid NOT NULL,
    contract_type text NOT NULL,
    partner_type text NOT NULL,
    partner_id bigint NOT NULL,
    start_date date NOT NULL,
    end_date date,
    status_code text DEFAULT 'ACTIVE'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY governance.contract_header FORCE ROW LEVEL SECURITY;


--
-- Name: contract_header_contract_id_seq; Type: SEQUENCE; Schema: governance; Owner: -
--

CREATE SEQUENCE governance.contract_header_contract_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: contract_header_contract_id_seq; Type: SEQUENCE OWNED BY; Schema: governance; Owner: -
--

ALTER SEQUENCE governance.contract_header_contract_id_seq OWNED BY governance.contract_header.contract_id;


--
-- Name: contract_item_price; Type: TABLE; Schema: governance; Owner: -
--

CREATE TABLE governance.contract_item_price (
    contract_item_price_id bigint NOT NULL,
    contract_id bigint NOT NULL,
    item_id bigint NOT NULL,
    price numeric(18,2) NOT NULL,
    currency_code text DEFAULT 'JPY'::text NOT NULL,
    priority integer DEFAULT 1 NOT NULL
);


--
-- Name: contract_item_price_contract_item_price_id_seq; Type: SEQUENCE; Schema: governance; Owner: -
--

CREATE SEQUENCE governance.contract_item_price_contract_item_price_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: contract_item_price_contract_item_price_id_seq; Type: SEQUENCE OWNED BY; Schema: governance; Owner: -
--

ALTER SEQUENCE governance.contract_item_price_contract_item_price_id_seq OWNED BY governance.contract_item_price.contract_item_price_id;


--
-- Name: document_archive; Type: TABLE; Schema: governance; Owner: -
--

CREATE TABLE governance.document_archive (
    document_archive_id bigint NOT NULL,
    company_id uuid NOT NULL,
    document_category_id bigint NOT NULL,
    related_entity_type text,
    related_entity_id text,
    file_path text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY governance.document_archive FORCE ROW LEVEL SECURITY;


--
-- Name: document_archive_document_archive_id_seq; Type: SEQUENCE; Schema: governance; Owner: -
--

CREATE SEQUENCE governance.document_archive_document_archive_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: document_archive_document_archive_id_seq; Type: SEQUENCE OWNED BY; Schema: governance; Owner: -
--

ALTER SEQUENCE governance.document_archive_document_archive_id_seq OWNED BY governance.document_archive.document_archive_id;


--
-- Name: document_category; Type: TABLE; Schema: governance; Owner: -
--

CREATE TABLE governance.document_category (
    document_category_id bigint NOT NULL,
    category_code text NOT NULL,
    category_name text NOT NULL,
    retention_years integer DEFAULT 7 NOT NULL
);


--
-- Name: document_category_document_category_id_seq; Type: SEQUENCE; Schema: governance; Owner: -
--

CREATE SEQUENCE governance.document_category_document_category_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: document_category_document_category_id_seq; Type: SEQUENCE OWNED BY; Schema: governance; Owner: -
--

ALTER SEQUENCE governance.document_category_document_category_id_seq OWNED BY governance.document_category.document_category_id;


--
-- Name: policy_change_queue_policy_change_id_seq; Type: SEQUENCE; Schema: governance; Owner: -
--

CREATE SEQUENCE governance.policy_change_queue_policy_change_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: policy_change_queue_policy_change_id_seq; Type: SEQUENCE OWNED BY; Schema: governance; Owner: -
--

ALTER SEQUENCE governance.policy_change_queue_policy_change_id_seq OWNED BY governance.policy_change_queue.policy_change_id;


--
-- Name: v_policy_yaml_source; Type: VIEW; Schema: governance; Owner: -
--

CREATE VIEW governance.v_policy_yaml_source AS
 SELECT policy_key,
    proposed_value
   FROM governance.policy_change_queue
  WHERE (status = 'approved'::text)
  ORDER BY policy_key;


--
-- Name: attendance_log; Type: TABLE; Schema: hr; Owner: -
--

CREATE TABLE hr.attendance_log (
    attendance_log_id bigint NOT NULL,
    company_id uuid NOT NULL,
    employee_id bigint NOT NULL,
    work_date date NOT NULL,
    clock_in timestamp with time zone,
    clock_out timestamp with time zone,
    work_minutes integer
);

ALTER TABLE ONLY hr.attendance_log FORCE ROW LEVEL SECURITY;


--
-- Name: attendance_log_attendance_log_id_seq; Type: SEQUENCE; Schema: hr; Owner: -
--

CREATE SEQUENCE hr.attendance_log_attendance_log_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: attendance_log_attendance_log_id_seq; Type: SEQUENCE OWNED BY; Schema: hr; Owner: -
--

ALTER SEQUENCE hr.attendance_log_attendance_log_id_seq OWNED BY hr.attendance_log.attendance_log_id;


--
-- Name: employee; Type: TABLE; Schema: hr; Owner: -
--

CREATE TABLE hr.employee (
    employee_id bigint NOT NULL,
    company_id uuid NOT NULL,
    employee_code text NOT NULL,
    employee_name text NOT NULL,
    department_id bigint,
    position_id bigint,
    hired_date date,
    is_active boolean DEFAULT true NOT NULL
);

ALTER TABLE ONLY hr.employee FORCE ROW LEVEL SECURITY;


--
-- Name: employee_employee_id_seq; Type: SEQUENCE; Schema: hr; Owner: -
--

CREATE SEQUENCE hr.employee_employee_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: employee_employee_id_seq; Type: SEQUENCE OWNED BY; Schema: hr; Owner: -
--

ALTER SEQUENCE hr.employee_employee_id_seq OWNED BY hr.employee.employee_id;


--
-- Name: employment_contract; Type: TABLE; Schema: hr; Owner: -
--

CREATE TABLE hr.employment_contract (
    employment_contract_id bigint NOT NULL,
    company_id uuid NOT NULL,
    employee_id bigint NOT NULL,
    employment_type text NOT NULL,
    start_date date NOT NULL,
    end_date date,
    base_salary numeric(18,2),
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY hr.employment_contract FORCE ROW LEVEL SECURITY;


--
-- Name: employment_contract_employment_contract_id_seq; Type: SEQUENCE; Schema: hr; Owner: -
--

CREATE SEQUENCE hr.employment_contract_employment_contract_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: employment_contract_employment_contract_id_seq; Type: SEQUENCE OWNED BY; Schema: hr; Owner: -
--

ALTER SEQUENCE hr.employment_contract_employment_contract_id_seq OWNED BY hr.employment_contract.employment_contract_id;


--
-- Name: hr_department; Type: TABLE; Schema: hr; Owner: -
--

CREATE TABLE hr.hr_department (
    department_id bigint NOT NULL,
    company_id uuid NOT NULL,
    department_code text NOT NULL,
    department_name text NOT NULL
);

ALTER TABLE ONLY hr.hr_department FORCE ROW LEVEL SECURITY;


--
-- Name: hr_department_department_id_seq; Type: SEQUENCE; Schema: hr; Owner: -
--

CREATE SEQUENCE hr.hr_department_department_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: hr_department_department_id_seq; Type: SEQUENCE OWNED BY; Schema: hr; Owner: -
--

ALTER SEQUENCE hr.hr_department_department_id_seq OWNED BY hr.hr_department.department_id;


--
-- Name: hr_position; Type: TABLE; Schema: hr; Owner: -
--

CREATE TABLE hr.hr_position (
    position_id bigint NOT NULL,
    company_id uuid NOT NULL,
    position_code text NOT NULL,
    position_name text NOT NULL
);

ALTER TABLE ONLY hr.hr_position FORCE ROW LEVEL SECURITY;


--
-- Name: hr_position_position_id_seq; Type: SEQUENCE; Schema: hr; Owner: -
--

CREATE SEQUENCE hr.hr_position_position_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: hr_position_position_id_seq; Type: SEQUENCE OWNED BY; Schema: hr; Owner: -
--

ALTER SEQUENCE hr.hr_position_position_id_seq OWNED BY hr.hr_position.position_id;


--
-- Name: leave_request; Type: TABLE; Schema: hr; Owner: -
--

CREATE TABLE hr.leave_request (
    leave_request_id bigint NOT NULL,
    company_id uuid NOT NULL,
    employee_id bigint NOT NULL,
    leave_type_code text NOT NULL,
    start_date date NOT NULL,
    end_date date NOT NULL,
    status_code text DEFAULT 'REQUESTED'::text NOT NULL,
    approved_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY hr.leave_request FORCE ROW LEVEL SECURITY;


--
-- Name: leave_request_leave_request_id_seq; Type: SEQUENCE; Schema: hr; Owner: -
--

CREATE SEQUENCE hr.leave_request_leave_request_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: leave_request_leave_request_id_seq; Type: SEQUENCE OWNED BY; Schema: hr; Owner: -
--

ALTER SEQUENCE hr.leave_request_leave_request_id_seq OWNED BY hr.leave_request.leave_request_id;


--
-- Name: leave_type; Type: TABLE; Schema: hr; Owner: -
--

CREATE TABLE hr.leave_type (
    leave_type_code text NOT NULL,
    leave_type_name text NOT NULL
);


--
-- Name: payroll_run; Type: TABLE; Schema: hr; Owner: -
--

CREATE TABLE hr.payroll_run (
    payroll_run_id bigint NOT NULL,
    company_id uuid NOT NULL,
    pay_month date NOT NULL,
    status_code text DEFAULT 'CALCULATED'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY hr.payroll_run FORCE ROW LEVEL SECURITY;


--
-- Name: payroll_run_payroll_run_id_seq; Type: SEQUENCE; Schema: hr; Owner: -
--

CREATE SEQUENCE hr.payroll_run_payroll_run_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: payroll_run_payroll_run_id_seq; Type: SEQUENCE OWNED BY; Schema: hr; Owner: -
--

ALTER SEQUENCE hr.payroll_run_payroll_run_id_seq OWNED BY hr.payroll_run.payroll_run_id;


--
-- Name: payroll_slip; Type: TABLE; Schema: hr; Owner: -
--

CREATE TABLE hr.payroll_slip (
    payroll_slip_id bigint NOT NULL,
    payroll_run_id bigint NOT NULL,
    employee_id bigint NOT NULL,
    gross_pay numeric(18,2) DEFAULT 0 NOT NULL,
    net_pay numeric(18,2) DEFAULT 0 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: payroll_slip_payroll_slip_id_seq; Type: SEQUENCE; Schema: hr; Owner: -
--

CREATE SEQUENCE hr.payroll_slip_payroll_slip_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: payroll_slip_payroll_slip_id_seq; Type: SEQUENCE OWNED BY; Schema: hr; Owner: -
--

ALTER SEQUENCE hr.payroll_slip_payroll_slip_id_seq OWNED BY hr.payroll_slip.payroll_slip_id;


--
-- Name: v_change_history; Type: VIEW; Schema: hr; Owner: -
--

CREATE VIEW hr.v_change_history AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    action_category,
    detail,
    performed_by,
    performed_at
   FROM core.audit_trail
  WHERE (entity_type ~~ 'hr.%'::text);


--
-- Name: api_credential; Type: TABLE; Schema: integration; Owner: -
--

CREATE TABLE integration.api_credential (
    api_credential_id bigint NOT NULL,
    external_system_id bigint NOT NULL,
    auth_type text NOT NULL,
    credential_ref text NOT NULL,
    expires_at timestamp with time zone
);


--
-- Name: api_credential_api_credential_id_seq; Type: SEQUENCE; Schema: integration; Owner: -
--

CREATE SEQUENCE integration.api_credential_api_credential_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: api_credential_api_credential_id_seq; Type: SEQUENCE OWNED BY; Schema: integration; Owner: -
--

ALTER SEQUENCE integration.api_credential_api_credential_id_seq OWNED BY integration.api_credential.api_credential_id;


--
-- Name: audit_export_queue; Type: TABLE; Schema: integration; Owner: -
--

CREATE TABLE integration.audit_export_queue (
    export_id bigint NOT NULL,
    company_id uuid NOT NULL,
    from_time timestamp with time zone NOT NULL,
    to_time timestamp with time zone NOT NULL,
    status text DEFAULT 'PENDING'::text NOT NULL,
    last_error text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT audit_export_queue_status_check CHECK ((status = ANY (ARRAY['PENDING'::text, 'RUNNING'::text, 'DONE'::text, 'FAILED'::text])))
);

ALTER TABLE ONLY integration.audit_export_queue FORCE ROW LEVEL SECURITY;


--
-- Name: audit_export_queue_export_id_seq; Type: SEQUENCE; Schema: integration; Owner: -
--

CREATE SEQUENCE integration.audit_export_queue_export_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_export_queue_export_id_seq; Type: SEQUENCE OWNED BY; Schema: integration; Owner: -
--

ALTER SEQUENCE integration.audit_export_queue_export_id_seq OWNED BY integration.audit_export_queue.export_id;


--
-- Name: external_system; Type: TABLE; Schema: integration; Owner: -
--

CREATE TABLE integration.external_system (
    external_system_id bigint NOT NULL,
    company_id uuid NOT NULL,
    system_code text NOT NULL,
    system_name text NOT NULL,
    system_type text NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);

ALTER TABLE ONLY integration.external_system FORCE ROW LEVEL SECURITY;


--
-- Name: external_system_external_system_id_seq; Type: SEQUENCE; Schema: integration; Owner: -
--

CREATE SEQUENCE integration.external_system_external_system_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: external_system_external_system_id_seq; Type: SEQUENCE OWNED BY; Schema: integration; Owner: -
--

ALTER SEQUENCE integration.external_system_external_system_id_seq OWNED BY integration.external_system.external_system_id;


--
-- Name: integration_job; Type: TABLE; Schema: integration; Owner: -
--

CREATE TABLE integration.integration_job (
    integration_job_id bigint NOT NULL,
    external_system_id bigint NOT NULL,
    job_type text NOT NULL,
    schedule_type text DEFAULT 'MANUAL'::text NOT NULL,
    last_run_at timestamp with time zone,
    last_status text
);


--
-- Name: integration_job_integration_job_id_seq; Type: SEQUENCE; Schema: integration; Owner: -
--

CREATE SEQUENCE integration.integration_job_integration_job_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: integration_job_integration_job_id_seq; Type: SEQUENCE OWNED BY; Schema: integration; Owner: -
--

ALTER SEQUENCE integration.integration_job_integration_job_id_seq OWNED BY integration.integration_job.integration_job_id;


--
-- Name: integration_log; Type: TABLE; Schema: integration; Owner: -
--

CREATE TABLE integration.integration_log (
    integration_log_id bigint NOT NULL,
    integration_job_id bigint NOT NULL,
    status text NOT NULL,
    error_message text,
    executed_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: integration_log_integration_log_id_seq; Type: SEQUENCE; Schema: integration; Owner: -
--

CREATE SEQUENCE integration.integration_log_integration_log_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: integration_log_integration_log_id_seq; Type: SEQUENCE OWNED BY; Schema: integration; Owner: -
--

ALTER SEQUENCE integration.integration_log_integration_log_id_seq OWNED BY integration.integration_log.integration_log_id;


--
-- Name: siem_delivery_queue; Type: TABLE; Schema: integration; Owner: -
--

CREATE TABLE integration.siem_delivery_queue (
    delivery_id bigint NOT NULL,
    endpoint_id bigint NOT NULL,
    company_id uuid NOT NULL,
    audit_trail_id bigint NOT NULL,
    status text DEFAULT 'PENDING'::text NOT NULL,
    retry_count integer DEFAULT 0 NOT NULL,
    last_error text,
    enqueued_at timestamp with time zone DEFAULT now() NOT NULL,
    sent_at timestamp with time zone,
    CONSTRAINT siem_delivery_queue_status_check CHECK ((status = ANY (ARRAY['PENDING'::text, 'SENT'::text, 'FAILED'::text])))
);

ALTER TABLE ONLY integration.siem_delivery_queue FORCE ROW LEVEL SECURITY;


--
-- Name: siem_delivery_queue_delivery_id_seq; Type: SEQUENCE; Schema: integration; Owner: -
--

CREATE SEQUENCE integration.siem_delivery_queue_delivery_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: siem_delivery_queue_delivery_id_seq; Type: SEQUENCE OWNED BY; Schema: integration; Owner: -
--

ALTER SEQUENCE integration.siem_delivery_queue_delivery_id_seq OWNED BY integration.siem_delivery_queue.delivery_id;


--
-- Name: siem_endpoint; Type: TABLE; Schema: integration; Owner: -
--

CREATE TABLE integration.siem_endpoint (
    endpoint_id bigint NOT NULL,
    company_id uuid,
    endpoint_name text NOT NULL,
    endpoint_type text DEFAULT 'HTTP'::text NOT NULL,
    url text NOT NULL,
    auth_ref text,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY integration.siem_endpoint FORCE ROW LEVEL SECURITY;


--
-- Name: siem_endpoint_endpoint_id_seq; Type: SEQUENCE; Schema: integration; Owner: -
--

CREATE SEQUENCE integration.siem_endpoint_endpoint_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: siem_endpoint_endpoint_id_seq; Type: SEQUENCE OWNED BY; Schema: integration; Owner: -
--

ALTER SEQUENCE integration.siem_endpoint_endpoint_id_seq OWNED BY integration.siem_endpoint.endpoint_id;


--
-- Name: v_audit_export_payload; Type: VIEW; Schema: integration; Owner: -
--

CREATE VIEW integration.v_audit_export_payload AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    action_category,
    detail,
    performed_by,
    performed_at
   FROM core.audit_trail;


--
-- Name: v_siem_payload; Type: VIEW; Schema: integration; Owner: -
--

CREATE VIEW integration.v_siem_payload AS
 SELECT q.delivery_id,
    q.endpoint_id,
    e.endpoint_type,
    e.url,
    e.auth_ref,
    at.audit_trail_id,
    at.company_id,
    at.entity_type,
    at.entity_id,
    at.action,
    at.performed_by,
    at.performed_at,
    core.fn_calc_audit_impact(at.company_id, at.entity_type, at.action, at.detail) AS impact_score,
    at.detail
   FROM ((integration.siem_delivery_queue q
     JOIN integration.siem_endpoint e ON (((e.endpoint_id = q.endpoint_id) AND e.is_active)))
     JOIN core.audit_trail at ON ((at.audit_trail_id = q.audit_trail_id)))
  WHERE (q.status = 'PENDING'::text);


--
-- Name: inventory_valuation; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.inventory_valuation (
    inventory_valuation_id bigint NOT NULL,
    company_id uuid NOT NULL,
    item_id bigint NOT NULL,
    valuation_date date NOT NULL,
    method text DEFAULT 'AVG'::text NOT NULL,
    unit_cost numeric(18,4) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY inventory.inventory_valuation FORCE ROW LEVEL SECURITY;


--
-- Name: inventory_valuation_inventory_valuation_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.inventory_valuation_inventory_valuation_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: inventory_valuation_inventory_valuation_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.inventory_valuation_inventory_valuation_id_seq OWNED BY inventory.inventory_valuation.inventory_valuation_id;


--
-- Name: stock_balance; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.stock_balance (
    stock_balance_id bigint NOT NULL,
    company_id uuid NOT NULL,
    warehouse_id bigint NOT NULL,
    location_id bigint NOT NULL,
    bin_id bigint NOT NULL,
    item_id bigint NOT NULL,
    qty_on_hand numeric(18,3) DEFAULT 0 NOT NULL,
    qty_reserved numeric(18,3) DEFAULT 0 NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY inventory.stock_balance FORCE ROW LEVEL SECURITY;


--
-- Name: stock_balance_stock_balance_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.stock_balance_stock_balance_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: stock_balance_stock_balance_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.stock_balance_stock_balance_id_seq OWNED BY inventory.stock_balance.stock_balance_id;


--
-- Name: stock_bin; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.stock_bin (
    bin_id bigint NOT NULL,
    company_id uuid NOT NULL,
    location_id bigint NOT NULL,
    bin_code text NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);

ALTER TABLE ONLY inventory.stock_bin FORCE ROW LEVEL SECURITY;


--
-- Name: stock_bin_bin_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.stock_bin_bin_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: stock_bin_bin_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.stock_bin_bin_id_seq OWNED BY inventory.stock_bin.bin_id;


--
-- Name: stock_lot; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.stock_lot (
    stock_lot_id bigint NOT NULL,
    company_id uuid NOT NULL,
    item_id bigint NOT NULL,
    lot_no text,
    serial_no text,
    expiry_date date
);

ALTER TABLE ONLY inventory.stock_lot FORCE ROW LEVEL SECURITY;


--
-- Name: stock_lot_balance; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.stock_lot_balance (
    stock_lot_balance_id bigint NOT NULL,
    company_id uuid NOT NULL,
    warehouse_id bigint NOT NULL,
    location_id bigint NOT NULL,
    bin_id bigint NOT NULL,
    item_id bigint NOT NULL,
    stock_lot_id bigint NOT NULL,
    qty_on_hand numeric(18,3) DEFAULT 0 NOT NULL,
    qty_reserved numeric(18,3) DEFAULT 0 NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY inventory.stock_lot_balance FORCE ROW LEVEL SECURITY;


--
-- Name: stock_lot_balance_stock_lot_balance_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.stock_lot_balance_stock_lot_balance_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: stock_lot_balance_stock_lot_balance_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.stock_lot_balance_stock_lot_balance_id_seq OWNED BY inventory.stock_lot_balance.stock_lot_balance_id;


--
-- Name: stock_lot_stock_lot_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.stock_lot_stock_lot_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: stock_lot_stock_lot_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.stock_lot_stock_lot_id_seq OWNED BY inventory.stock_lot.stock_lot_id;


--
-- Name: stock_reservation; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.stock_reservation (
    stock_reservation_id bigint NOT NULL,
    company_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id text NOT NULL,
    item_id bigint NOT NULL,
    stock_lot_id bigint,
    qty_reserved numeric(18,3) NOT NULL,
    reserved_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY inventory.stock_reservation FORCE ROW LEVEL SECURITY;


--
-- Name: stock_reservation_stock_reservation_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.stock_reservation_stock_reservation_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: stock_reservation_stock_reservation_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.stock_reservation_stock_reservation_id_seq OWNED BY inventory.stock_reservation.stock_reservation_id;


--
-- Name: stock_transaction; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.stock_transaction (
    stock_tx_id bigint NOT NULL,
    company_id uuid NOT NULL,
    tx_type text NOT NULL,
    warehouse_id bigint NOT NULL,
    item_id bigint NOT NULL,
    stock_lot_id bigint,
    from_bin_id bigint,
    to_bin_id bigint,
    qty numeric(18,3) NOT NULL,
    reference_type text,
    reference_id text,
    occurred_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY inventory.stock_transaction FORCE ROW LEVEL SECURITY;


--
-- Name: stock_transaction_stock_tx_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.stock_transaction_stock_tx_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: stock_transaction_stock_tx_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.stock_transaction_stock_tx_id_seq OWNED BY inventory.stock_transaction.stock_tx_id;


--
-- Name: stock_transfer_detail; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.stock_transfer_detail (
    stock_transfer_detail_id bigint NOT NULL,
    stock_transfer_id bigint NOT NULL,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL,
    from_location_id bigint,
    to_location_id bigint,
    from_bin_id bigint,
    to_bin_id bigint,
    stock_lot_id bigint
);


--
-- Name: stock_transfer_detail_stock_transfer_detail_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.stock_transfer_detail_stock_transfer_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: stock_transfer_detail_stock_transfer_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.stock_transfer_detail_stock_transfer_detail_id_seq OWNED BY inventory.stock_transfer_detail.stock_transfer_detail_id;


--
-- Name: stock_transfer_header; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.stock_transfer_header (
    stock_transfer_id bigint NOT NULL,
    company_id uuid NOT NULL,
    transfer_no text NOT NULL,
    from_warehouse_id bigint NOT NULL,
    to_warehouse_id bigint NOT NULL,
    request_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'REQUESTED'::text NOT NULL,
    requested_by uuid,
    approved_by uuid,
    approved_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY inventory.stock_transfer_header FORCE ROW LEVEL SECURITY;


--
-- Name: stock_transfer_header_stock_transfer_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.stock_transfer_header_stock_transfer_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: stock_transfer_header_stock_transfer_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.stock_transfer_header_stock_transfer_id_seq OWNED BY inventory.stock_transfer_header.stock_transfer_id;


--
-- Name: stocktaking_plan; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.stocktaking_plan (
    stocktaking_plan_id bigint NOT NULL,
    company_id uuid NOT NULL,
    warehouse_id bigint NOT NULL,
    plan_date date NOT NULL,
    status_code text DEFAULT 'PLANNED'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY inventory.stocktaking_plan FORCE ROW LEVEL SECURITY;


--
-- Name: stocktaking_plan_stocktaking_plan_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.stocktaking_plan_stocktaking_plan_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: stocktaking_plan_stocktaking_plan_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.stocktaking_plan_stocktaking_plan_id_seq OWNED BY inventory.stocktaking_plan.stocktaking_plan_id;


--
-- Name: stocktaking_result; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.stocktaking_result (
    stocktaking_result_id bigint NOT NULL,
    stocktaking_plan_id bigint NOT NULL,
    company_id uuid NOT NULL,
    bin_id bigint NOT NULL,
    item_id bigint NOT NULL,
    counted_qty numeric(18,3) NOT NULL,
    system_qty numeric(18,3) NOT NULL,
    difference_qty numeric(18,3) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY inventory.stocktaking_result FORCE ROW LEVEL SECURITY;


--
-- Name: stocktaking_result_stocktaking_result_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.stocktaking_result_stocktaking_result_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: stocktaking_result_stocktaking_result_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.stocktaking_result_stocktaking_result_id_seq OWNED BY inventory.stocktaking_result.stocktaking_result_id;


--
-- Name: storage_location; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.storage_location (
    location_id bigint NOT NULL,
    company_id uuid NOT NULL,
    warehouse_id bigint NOT NULL,
    location_code text NOT NULL,
    location_name text,
    is_active boolean DEFAULT true NOT NULL
);

ALTER TABLE ONLY inventory.storage_location FORCE ROW LEVEL SECURITY;


--
-- Name: storage_location_location_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.storage_location_location_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: storage_location_location_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.storage_location_location_id_seq OWNED BY inventory.storage_location.location_id;


--
-- Name: v_change_history; Type: VIEW; Schema: inventory; Owner: -
--

CREATE VIEW inventory.v_change_history AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    action_category,
    detail,
    performed_by,
    performed_at
   FROM core.audit_trail
  WHERE (entity_type ~~ 'inventory.%'::text);


--
-- Name: warehouse; Type: TABLE; Schema: inventory; Owner: -
--

CREATE TABLE inventory.warehouse (
    warehouse_id bigint NOT NULL,
    company_id uuid NOT NULL,
    warehouse_code text NOT NULL,
    warehouse_name text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY inventory.warehouse FORCE ROW LEVEL SECURITY;


--
-- Name: warehouse_warehouse_id_seq; Type: SEQUENCE; Schema: inventory; Owner: -
--

CREATE SEQUENCE inventory.warehouse_warehouse_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: warehouse_warehouse_id_seq; Type: SEQUENCE OWNED BY; Schema: inventory; Owner: -
--

ALTER SEQUENCE inventory.warehouse_warehouse_id_seq OWNED BY inventory.warehouse.warehouse_id;


--
-- Name: bom_detail; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.bom_detail (
    bom_detail_id bigint NOT NULL,
    bom_id bigint NOT NULL,
    component_item_id bigint NOT NULL,
    qty_per numeric(18,6) NOT NULL,
    issue_method text DEFAULT 'BACKFLUSH'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: bom_detail_bom_detail_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.bom_detail_bom_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: bom_detail_bom_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.bom_detail_bom_detail_id_seq OWNED BY manufacturing.bom_detail.bom_detail_id;


--
-- Name: bom_header; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.bom_header (
    bom_id bigint NOT NULL,
    company_id uuid NOT NULL,
    parent_item_id bigint NOT NULL,
    version integer DEFAULT 1 NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY manufacturing.bom_header FORCE ROW LEVEL SECURITY;


--
-- Name: bom_header_bom_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.bom_header_bom_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: bom_header_bom_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.bom_header_bom_id_seq OWNED BY manufacturing.bom_header.bom_id;


--
-- Name: manufacturing_cost_snapshot; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.manufacturing_cost_snapshot (
    manufacturing_cost_snapshot_id bigint NOT NULL,
    company_id uuid NOT NULL,
    work_order_id bigint NOT NULL,
    total_cost numeric(18,2) DEFAULT 0 NOT NULL,
    snapshot_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY manufacturing.manufacturing_cost_snapshot FORCE ROW LEVEL SECURITY;


--
-- Name: manufacturing_cost_snapshot_manufacturing_cost_snapshot_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.manufacturing_cost_snapshot_manufacturing_cost_snapshot_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: manufacturing_cost_snapshot_manufacturing_cost_snapshot_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.manufacturing_cost_snapshot_manufacturing_cost_snapshot_id_seq OWNED BY manufacturing.manufacturing_cost_snapshot.manufacturing_cost_snapshot_id;


--
-- Name: manufacturing_execution; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.manufacturing_execution (
    execution_id bigint NOT NULL,
    company_id uuid NOT NULL,
    work_order_id bigint NOT NULL,
    warehouse_id bigint NOT NULL,
    executed_at timestamp with time zone DEFAULT now() NOT NULL,
    status_code text DEFAULT 'DONE'::text NOT NULL
);

ALTER TABLE ONLY manufacturing.manufacturing_execution FORCE ROW LEVEL SECURITY;


--
-- Name: manufacturing_execution_detail; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.manufacturing_execution_detail (
    execution_detail_id bigint NOT NULL,
    execution_id bigint NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL,
    movement_type text DEFAULT 'CONSUME'::text NOT NULL
);


--
-- Name: manufacturing_execution_detail_execution_detail_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.manufacturing_execution_detail_execution_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: manufacturing_execution_detail_execution_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.manufacturing_execution_detail_execution_detail_id_seq OWNED BY manufacturing.manufacturing_execution_detail.execution_detail_id;


--
-- Name: manufacturing_execution_execution_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.manufacturing_execution_execution_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: manufacturing_execution_execution_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.manufacturing_execution_execution_id_seq OWNED BY manufacturing.manufacturing_execution.execution_id;


--
-- Name: mps_plan; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.mps_plan (
    mps_plan_id bigint NOT NULL,
    mps_run_id bigint NOT NULL,
    item_id bigint NOT NULL,
    plan_date date NOT NULL,
    plan_qty numeric(18,3) NOT NULL
);


--
-- Name: mps_plan_mps_plan_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.mps_plan_mps_plan_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: mps_plan_mps_plan_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.mps_plan_mps_plan_id_seq OWNED BY manufacturing.mps_plan.mps_plan_id;


--
-- Name: mps_run; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.mps_run (
    mps_run_id bigint NOT NULL,
    company_id uuid NOT NULL,
    run_type text DEFAULT 'MONTHLY'::text NOT NULL,
    run_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY manufacturing.mps_run FORCE ROW LEVEL SECURITY;


--
-- Name: mps_run_mps_run_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.mps_run_mps_run_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: mps_run_mps_run_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.mps_run_mps_run_id_seq OWNED BY manufacturing.mps_run.mps_run_id;


--
-- Name: mrp_allocation; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.mrp_allocation (
    mrp_allocation_id bigint NOT NULL,
    mrp_requirement_id bigint NOT NULL,
    source_type text NOT NULL,
    source_id text NOT NULL,
    qty_allocated numeric(18,3) NOT NULL
);


--
-- Name: mrp_allocation_mrp_allocation_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.mrp_allocation_mrp_allocation_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: mrp_allocation_mrp_allocation_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.mrp_allocation_mrp_allocation_id_seq OWNED BY manufacturing.mrp_allocation.mrp_allocation_id;


--
-- Name: mrp_requirement; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.mrp_requirement (
    mrp_requirement_id bigint NOT NULL,
    mrp_run_id bigint NOT NULL,
    item_id bigint NOT NULL,
    requirement_date date NOT NULL,
    qty_required numeric(18,3) NOT NULL,
    supply_type text DEFAULT 'PURCHASE'::text NOT NULL
);


--
-- Name: mrp_requirement_mrp_requirement_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.mrp_requirement_mrp_requirement_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: mrp_requirement_mrp_requirement_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.mrp_requirement_mrp_requirement_id_seq OWNED BY manufacturing.mrp_requirement.mrp_requirement_id;


--
-- Name: mrp_run; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.mrp_run (
    mrp_run_id bigint NOT NULL,
    company_id uuid NOT NULL,
    run_type text DEFAULT 'DAILY'::text NOT NULL,
    run_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY manufacturing.mrp_run FORCE ROW LEVEL SECURITY;


--
-- Name: mrp_run_mrp_run_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.mrp_run_mrp_run_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: mrp_run_mrp_run_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.mrp_run_mrp_run_id_seq OWNED BY manufacturing.mrp_run.mrp_run_id;


--
-- Name: process_master; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.process_master (
    process_id bigint NOT NULL,
    company_id uuid NOT NULL,
    process_code text NOT NULL,
    process_name text NOT NULL
);

ALTER TABLE ONLY manufacturing.process_master FORCE ROW LEVEL SECURITY;


--
-- Name: process_master_process_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.process_master_process_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: process_master_process_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.process_master_process_id_seq OWNED BY manufacturing.process_master.process_id;


--
-- Name: routing_header; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.routing_header (
    routing_id bigint NOT NULL,
    company_id uuid NOT NULL,
    item_id bigint NOT NULL,
    version integer DEFAULT 1 NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY manufacturing.routing_header FORCE ROW LEVEL SECURITY;


--
-- Name: routing_header_routing_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.routing_header_routing_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: routing_header_routing_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.routing_header_routing_id_seq OWNED BY manufacturing.routing_header.routing_id;


--
-- Name: routing_operation; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.routing_operation (
    routing_operation_id bigint NOT NULL,
    routing_id bigint NOT NULL,
    operation_no integer NOT NULL,
    process_id bigint NOT NULL,
    std_time_minutes numeric(18,3) DEFAULT 0 NOT NULL
);


--
-- Name: routing_operation_routing_operation_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.routing_operation_routing_operation_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: routing_operation_routing_operation_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.routing_operation_routing_operation_id_seq OWNED BY manufacturing.routing_operation.routing_operation_id;


--
-- Name: work_order; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.work_order (
    work_order_id bigint NOT NULL,
    company_id uuid NOT NULL,
    wo_no text NOT NULL,
    item_id bigint NOT NULL,
    bom_id bigint,
    routing_id bigint,
    warehouse_id bigint NOT NULL,
    plan_qty numeric(18,3) NOT NULL,
    plan_start_date date,
    plan_end_date date,
    status_code text DEFAULT 'PLANNED'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY manufacturing.work_order FORCE ROW LEVEL SECURITY;


--
-- Name: work_order_work_order_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.work_order_work_order_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: work_order_work_order_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.work_order_work_order_id_seq OWNED BY manufacturing.work_order.work_order_id;


--
-- Name: yield_metric; Type: TABLE; Schema: manufacturing; Owner: -
--

CREATE TABLE manufacturing.yield_metric (
    yield_metric_id bigint NOT NULL,
    company_id uuid NOT NULL,
    process_id bigint NOT NULL,
    metric_date date NOT NULL,
    yield_rate numeric(9,4) NOT NULL
);

ALTER TABLE ONLY manufacturing.yield_metric FORCE ROW LEVEL SECURITY;


--
-- Name: yield_metric_yield_metric_id_seq; Type: SEQUENCE; Schema: manufacturing; Owner: -
--

CREATE SEQUENCE manufacturing.yield_metric_yield_metric_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: yield_metric_yield_metric_id_seq; Type: SEQUENCE OWNED BY; Schema: manufacturing; Owner: -
--

ALTER SEQUENCE manufacturing.yield_metric_yield_metric_id_seq OWNED BY manufacturing.yield_metric.yield_metric_id;


--
-- Name: asset; Type: TABLE; Schema: media; Owner: -
--

CREATE TABLE media.asset (
    asset_id bigint NOT NULL,
    asset_type text DEFAULT 'IMAGE'::text NOT NULL,
    storage_provider text DEFAULT 'supabase_storage'::text NOT NULL,
    bucket text,
    object_path text,
    public_url text,
    content_type text,
    byte_size bigint,
    sha256 text,
    width_px integer,
    height_px integer,
    note text,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT asset_asset_type_check CHECK ((asset_type = ANY (ARRAY['IMAGE'::text, 'FILE'::text])))
);


--
-- Name: asset_asset_id_seq; Type: SEQUENCE; Schema: media; Owner: -
--

CREATE SEQUENCE media.asset_asset_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: asset_asset_id_seq; Type: SEQUENCE OWNED BY; Schema: media; Owner: -
--

ALTER SEQUENCE media.asset_asset_id_seq OWNED BY media.asset.asset_id;


--
-- Name: asset_link; Type: TABLE; Schema: media; Owner: -
--

CREATE TABLE media.asset_link (
    asset_id bigint NOT NULL,
    entity_table text NOT NULL,
    entity_id bigint NOT NULL,
    role text NOT NULL,
    sort_order integer DEFAULT 1 NOT NULL,
    is_primary boolean DEFAULT false NOT NULL,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_item_images; Type: VIEW; Schema: media; Owner: -
--

CREATE VIEW media.v_item_images AS
 SELECT l.entity_table,
    l.entity_id AS item_id,
    l.sort_order,
    l.is_primary,
    a.asset_id,
    a.public_url,
    a.bucket,
    a.object_path,
    a.content_type,
    a.byte_size,
    a.width_px,
    a.height_px,
    a.created_at
   FROM (media.asset_link l
     JOIN media.asset a ON ((a.asset_id = l.asset_id)))
  WHERE (l.role = 'ITEM_IMAGE'::text);


--
-- Name: ai_event; Type: TABLE; Schema: notify; Owner: -
--

CREATE TABLE notify.ai_event (
    ai_event_id bigint NOT NULL,
    company_id uuid NOT NULL,
    ai_rule_id bigint,
    title text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    severity text DEFAULT 'warn'::text NOT NULL,
    status text DEFAULT 'open'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ai_event_ai_event_id_seq; Type: SEQUENCE; Schema: notify; Owner: -
--

CREATE SEQUENCE notify.ai_event_ai_event_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: ai_event_ai_event_id_seq; Type: SEQUENCE OWNED BY; Schema: notify; Owner: -
--

ALTER SEQUENCE notify.ai_event_ai_event_id_seq OWNED BY notify.ai_event.ai_event_id;


--
-- Name: ai_rule; Type: TABLE; Schema: notify; Owner: -
--

CREATE TABLE notify.ai_rule (
    ai_rule_id bigint NOT NULL,
    company_id uuid NOT NULL,
    rule_key text NOT NULL,
    rule jsonb NOT NULL,
    severity text DEFAULT 'warn'::text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ai_rule_ai_rule_id_seq; Type: SEQUENCE; Schema: notify; Owner: -
--

CREATE SEQUENCE notify.ai_rule_ai_rule_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: ai_rule_ai_rule_id_seq; Type: SEQUENCE OWNED BY; Schema: notify; Owner: -
--

ALTER SEQUENCE notify.ai_rule_ai_rule_id_seq OWNED BY notify.ai_rule.ai_rule_id;


--
-- Name: approval_action_log; Type: TABLE; Schema: notify; Owner: -
--

CREATE TABLE notify.approval_action_log (
    action_log_id bigint NOT NULL,
    company_id uuid NOT NULL,
    approval_request_id bigint NOT NULL,
    line_user_id text NOT NULL,
    action text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: approval_action_log_action_log_id_seq; Type: SEQUENCE; Schema: notify; Owner: -
--

CREATE SEQUENCE notify.approval_action_log_action_log_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: approval_action_log_action_log_id_seq; Type: SEQUENCE OWNED BY; Schema: notify; Owner: -
--

ALTER SEQUENCE notify.approval_action_log_action_log_id_seq OWNED BY notify.approval_action_log.action_log_id;


--
-- Name: approval_request; Type: TABLE; Schema: notify; Owner: -
--

CREATE TABLE notify.approval_request (
    approval_request_id bigint NOT NULL,
    company_id uuid NOT NULL,
    request_type text NOT NULL,
    entity_id text NOT NULL,
    title text NOT NULL,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    requested_at timestamp with time zone DEFAULT now() NOT NULL,
    decided_by_line_user_id text,
    decided_at timestamp with time zone
);


--
-- Name: approval_request_approval_request_id_seq; Type: SEQUENCE; Schema: notify; Owner: -
--

CREATE SEQUENCE notify.approval_request_approval_request_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: approval_request_approval_request_id_seq; Type: SEQUENCE OWNED BY; Schema: notify; Owner: -
--

ALTER SEQUENCE notify.approval_request_approval_request_id_seq OWNED BY notify.approval_request.approval_request_id;


--
-- Name: audit_trail; Type: TABLE; Schema: notify; Owner: -
--

CREATE TABLE notify.audit_trail (
    audit_id bigint NOT NULL,
    company_id uuid NOT NULL,
    actor_line_user_id text,
    actor text NOT NULL,
    action text NOT NULL,
    entity_type text,
    entity_id text,
    detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: audit_trail_audit_id_seq; Type: SEQUENCE; Schema: notify; Owner: -
--

CREATE SEQUENCE notify.audit_trail_audit_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_trail_audit_id_seq; Type: SEQUENCE OWNED BY; Schema: notify; Owner: -
--

ALTER SEQUENCE notify.audit_trail_audit_id_seq OWNED BY notify.audit_trail.audit_id;


--
-- Name: notification_log; Type: TABLE; Schema: notify; Owner: -
--

CREATE TABLE notify.notification_log (
    notification_id bigint NOT NULL,
    company_id uuid NOT NULL,
    route_key text NOT NULL,
    line_user_id text NOT NULL,
    template_key text,
    payload jsonb NOT NULL,
    status text DEFAULT 'queued'::text NOT NULL,
    retry_count integer DEFAULT 0 NOT NULL,
    last_error text,
    sent_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: notification_log_notification_id_seq; Type: SEQUENCE; Schema: notify; Owner: -
--

CREATE SEQUENCE notify.notification_log_notification_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: notification_log_notification_id_seq; Type: SEQUENCE OWNED BY; Schema: notify; Owner: -
--

ALTER SEQUENCE notify.notification_log_notification_id_seq OWNED BY notify.notification_log.notification_id;


--
-- Name: notification_route; Type: TABLE; Schema: notify; Owner: -
--

CREATE TABLE notify.notification_route (
    route_id bigint NOT NULL,
    company_id uuid NOT NULL,
    route_key text NOT NULL,
    line_user_id text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: notification_route_route_id_seq; Type: SEQUENCE; Schema: notify; Owner: -
--

CREATE SEQUENCE notify.notification_route_route_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: notification_route_route_id_seq; Type: SEQUENCE OWNED BY; Schema: notify; Owner: -
--

ALTER SEQUENCE notify.notification_route_route_id_seq OWNED BY notify.notification_route.route_id;


--
-- Name: notification_template; Type: TABLE; Schema: notify; Owner: -
--

CREATE TABLE notify.notification_template (
    template_id bigint NOT NULL,
    company_id uuid NOT NULL,
    template_key text NOT NULL,
    title text NOT NULL,
    body text NOT NULL,
    kind text DEFAULT 'text'::text NOT NULL,
    severity text DEFAULT 'info'::text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: notification_template_template_id_seq; Type: SEQUENCE; Schema: notify; Owner: -
--

CREATE SEQUENCE notify.notification_template_template_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: notification_template_template_id_seq; Type: SEQUENCE OWNED BY; Schema: notify; Owner: -
--

ALTER SEQUENCE notify.notification_template_template_id_seq OWNED BY notify.notification_template.template_id;


--
-- Name: v_audit_recent; Type: VIEW; Schema: notify; Owner: -
--

CREATE VIEW notify.v_audit_recent AS
 SELECT audit_id,
    company_id,
    actor_line_user_id,
    actor,
    action,
    entity_type,
    entity_id,
    detail,
    created_at
   FROM notify.audit_trail
  ORDER BY created_at DESC
 LIMIT 200;


--
-- Name: approval_rule; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.approval_rule (
    rule_id uuid DEFAULT gen_random_uuid() NOT NULL,
    domain text NOT NULL,
    event_type text NOT NULL,
    threshold_amount numeric,
    is_enabled boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: backup_log; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.backup_log (
    backup_id uuid DEFAULT gen_random_uuid() NOT NULL,
    backup_type text NOT NULL,
    status text NOT NULL,
    location text,
    executed_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: business_event; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.business_event (
    event_id uuid DEFAULT gen_random_uuid() NOT NULL,
    company_id uuid,
    domain text NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    event_type text NOT NULL,
    amount numeric,
    currency text,
    created_by text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: document_file; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.document_file (
    document_file_id bigint NOT NULL,
    document_type_code text NOT NULL,
    document_id bigint NOT NULL,
    file_path text NOT NULL,
    file_hash text NOT NULL,
    generated_at timestamp with time zone DEFAULT now() NOT NULL,
    generated_by uuid,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: document_file_document_file_id_seq; Type: SEQUENCE; Schema: ops; Owner: -
--

CREATE SEQUENCE ops.document_file_document_file_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: document_file_document_file_id_seq; Type: SEQUENCE OWNED BY; Schema: ops; Owner: -
--

ALTER SEQUENCE ops.document_file_document_file_id_seq OWNED BY ops.document_file.document_file_id;


--
-- Name: document_send_history_send_history_id_seq; Type: SEQUENCE; Schema: ops; Owner: -
--

CREATE SEQUENCE ops.document_send_history_send_history_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: document_send_history_send_history_id_seq; Type: SEQUENCE OWNED BY; Schema: ops; Owner: -
--

ALTER SEQUENCE ops.document_send_history_send_history_id_seq OWNED BY ops.document_send_history.send_history_id;


--
-- Name: document_send_queue; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.document_send_queue (
    send_queue_id bigint NOT NULL,
    document_type_code text NOT NULL,
    business_id bigint NOT NULL,
    channel_code text DEFAULT 'EMAIL'::text NOT NULL,
    queued_at timestamp with time zone DEFAULT now() NOT NULL,
    sent_at timestamp with time zone
);


--
-- Name: document_send_queue_send_queue_id_seq; Type: SEQUENCE; Schema: ops; Owner: -
--

CREATE SEQUENCE ops.document_send_queue_send_queue_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: document_send_queue_send_queue_id_seq; Type: SEQUENCE OWNED BY; Schema: ops; Owner: -
--

ALTER SEQUENCE ops.document_send_queue_send_queue_id_seq OWNED BY ops.document_send_queue.send_queue_id;


--
-- Name: document_type_master; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.document_type_master (
    document_type_code text NOT NULL,
    document_type_name text NOT NULL,
    is_external boolean NOT NULL,
    is_chargeable_paper boolean NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: notification_outbox; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.notification_outbox (
    notification_id bigint NOT NULL,
    channel_code text NOT NULL,
    destination text,
    message text NOT NULL,
    payload jsonb DEFAULT '{}'::jsonb NOT NULL,
    status text DEFAULT 'PENDING'::text NOT NULL,
    retry_count integer DEFAULT 0 NOT NULL,
    max_retry integer DEFAULT 3 NOT NULL,
    last_error text,
    run_after timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    sent_at timestamp with time zone,
    channel_type text,
    title text,
    body text,
    CONSTRAINT notification_outbox_status_check CHECK ((status = ANY (ARRAY['PENDING'::text, 'SENT'::text, 'FAILED'::text])))
);


--
-- Name: notification_outbox_notification_id_seq; Type: SEQUENCE; Schema: ops; Owner: -
--

CREATE SEQUENCE ops.notification_outbox_notification_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: notification_outbox_notification_id_seq; Type: SEQUENCE OWNED BY; Schema: ops; Owner: -
--

ALTER SEQUENCE ops.notification_outbox_notification_id_seq OWNED BY ops.notification_outbox.notification_id;


--
-- Name: ops_idempotency; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.ops_idempotency (
    idempotency_key text NOT NULL,
    job_type text NOT NULL,
    business_table text NOT NULL,
    business_id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ops_job_queue_job_id_seq; Type: SEQUENCE; Schema: ops; Owner: -
--

CREATE SEQUENCE ops.ops_job_queue_job_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: ops_job_queue_job_id_seq; Type: SEQUENCE OWNED BY; Schema: ops; Owner: -
--

ALTER SEQUENCE ops.ops_job_queue_job_id_seq OWNED BY ops.ops_job_queue.job_id;


--
-- Name: ops_job_result; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.ops_job_result (
    job_id bigint NOT NULL,
    result_status text NOT NULL,
    result_message text,
    finished_at timestamp with time zone DEFAULT now() NOT NULL,
    status text DEFAULT 'SUCCESS'::text,
    result_payload jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    result_detail jsonb DEFAULT '{}'::jsonb NOT NULL,
    completed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT ops_job_result_result_status_check CHECK ((result_status = ANY (ARRAY['SUCCESS'::text, 'FAILED'::text])))
);


--
-- Name: pdf_generate_queue; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.pdf_generate_queue (
    queue_id bigint NOT NULL,
    function_code text NOT NULL,
    document_type_code text NOT NULL,
    business_id bigint NOT NULL,
    queued_at timestamp with time zone DEFAULT now() NOT NULL,
    processed_at timestamp with time zone
);


--
-- Name: pdf_generate_queue_queue_id_seq; Type: SEQUENCE; Schema: ops; Owner: -
--

CREATE SEQUENCE ops.pdf_generate_queue_queue_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: pdf_generate_queue_queue_id_seq; Type: SEQUENCE OWNED BY; Schema: ops; Owner: -
--

ALTER SEQUENCE ops.pdf_generate_queue_queue_id_seq OWNED BY ops.pdf_generate_queue.queue_id;


--
-- Name: resend_type_master; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.resend_type_master (
    resend_type_code text NOT NULL,
    resend_type_name text NOT NULL,
    is_chargeable_paper boolean NOT NULL,
    description text,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: runtime_flag; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.runtime_flag (
    flag_key text NOT NULL,
    flag_value text NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: runtime_health; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.runtime_health (
    health_id uuid DEFAULT gen_random_uuid() NOT NULL,
    component text NOT NULL,
    status text NOT NULL,
    message text,
    checked_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: send_fee_master; Type: TABLE; Schema: ops; Owner: -
--

CREATE TABLE ops.send_fee_master (
    fee_id bigint NOT NULL,
    document_type_code text NOT NULL,
    resend_type_code text NOT NULL,
    fee_amount numeric NOT NULL,
    currency_code text DEFAULT 'JPY'::text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: send_fee_master_fee_id_seq; Type: SEQUENCE; Schema: ops; Owner: -
--

CREATE SEQUENCE ops.send_fee_master_fee_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: send_fee_master_fee_id_seq; Type: SEQUENCE OWNED BY; Schema: ops; Owner: -
--

ALTER SEQUENCE ops.send_fee_master_fee_id_seq OWNED BY ops.send_fee_master.fee_id;


--
-- Name: v_dashboard_send_summary; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_dashboard_send_summary AS
 SELECT to_char(date_trunc('month'::text, h.created_at), 'YYYY-MM'::text) AS month,
    d.document_type_name,
    c.channel_name,
    count(*) AS send_count,
    sum(h.send_fee_amount) AS total_fee,
    sum(
        CASE
            WHEN (h.send_status = 'FAILED'::text) THEN 1
            ELSE 0
        END) AS failed_count,
    round(((100.0 * (sum(
        CASE
            WHEN (h.send_status = 'FAILED'::text) THEN 1
            ELSE 0
        END))::numeric) / (GREATEST(count(*), (1)::bigint))::numeric), 2) AS failed_rate
   FROM ((ops.document_send_history h
     JOIN ops.document_type_master d ON ((d.document_type_code = h.document_type_code)))
     JOIN ops.send_channel_master c ON ((c.channel_code = h.channel_code)))
  GROUP BY (to_char(date_trunc('month'::text, h.created_at), 'YYYY-MM'::text)), d.document_type_name, c.channel_name
  ORDER BY (to_char(date_trunc('month'::text, h.created_at), 'YYYY-MM'::text)) DESC, d.document_type_name, c.channel_name;


--
-- Name: v_document_send_fee_calc; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_document_send_fee_calc AS
 SELECT h.send_history_id,
    h.company_id,
    h.document_type_code,
    h.channel_code,
    h.resend_type_code,
        CASE
            WHEN (c.is_paper = false) THEN (0)::numeric
            WHEN (d.is_chargeable_paper = false) THEN (0)::numeric
            WHEN (r.is_chargeable_paper = false) THEN (0)::numeric
            ELSE COALESCE(f.fee_amount, (0)::numeric)
        END AS calculated_fee,
    h.currency_code
   FROM ((((ops.document_send_history h
     JOIN ops.send_channel_master c ON ((c.channel_code = h.channel_code)))
     JOIN ops.document_type_master d ON ((d.document_type_code = h.document_type_code)))
     JOIN ops.resend_type_master r ON ((r.resend_type_code = h.resend_type_code)))
     LEFT JOIN ops.send_fee_master f ON (((f.document_type_code = h.document_type_code) AND (f.resend_type_code = h.resend_type_code) AND (f.is_active = true))));


--
-- Name: v_ops_job_metrics; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_ops_job_metrics AS
 SELECT job_type,
    status,
    count(*) AS cnt,
    min(created_at) AS oldest_created_at,
    max(created_at) AS newest_created_at
   FROM ops.ops_job_queue q
  GROUP BY job_type, status
  ORDER BY job_type, status;


--
-- Name: v_ops_job_queue_failed; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_ops_job_queue_failed AS
 SELECT job_id,
    job_type,
    function_code,
    document_type_code,
    business_table,
    business_id,
    job_status,
    retry_count,
    max_retry,
    locked_at,
    locked_by,
    created_at,
    executed_at,
    payload,
    status,
    priority,
    run_after,
    attempts,
    max_attempts,
    last_error,
    created_by,
    updated_at
   FROM ops.ops_job_queue
  WHERE (status = 'FAILED'::text)
  ORDER BY updated_at DESC, job_id DESC;


--
-- Name: v_ops_job_queue_open; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_ops_job_queue_open AS
 SELECT job_id,
    job_type,
    function_code,
    document_type_code,
    business_table,
    business_id,
    status,
    priority,
    retry_count,
    max_retry,
    locked_at,
    picked_at,
    created_at,
    payload
   FROM ops.ops_job_queue q
  WHERE (status = ANY (ARRAY['PENDING'::text, 'PROCESSING'::text]))
  ORDER BY priority DESC, created_at;


--
-- Name: v_ops_job_queue_stuck; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_ops_job_queue_stuck AS
 SELECT job_id,
    job_type,
    function_code,
    document_type_code,
    business_table,
    business_id,
    job_status,
    retry_count,
    max_retry,
    locked_at,
    locked_by,
    created_at,
    executed_at,
    payload,
    status,
    priority,
    run_after,
    attempts,
    max_attempts,
    last_error,
    created_by,
    updated_at,
    picked_at,
    finished_at,
    (now() - locked_at) AS locked_age
   FROM ops.ops_job_queue q
  WHERE ((status = 'PROCESSING'::text) AND (locked_at IS NOT NULL) AND (locked_at < (now() - '00:15:00'::interval)))
  ORDER BY locked_at;


--
-- Name: v_ops_job_queue_summary; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_ops_job_queue_summary AS
 SELECT status,
    count(*) AS job_count,
    min(created_at) AS oldest_created_at,
    min(run_after) AS oldest_run_after
   FROM ops.ops_job_queue
  GROUP BY status
  ORDER BY status;


--
-- Name: v_ops_job_recent; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_ops_job_recent AS
 SELECT q.job_id,
    q.job_type,
    q.function_code,
    q.document_type_code,
    q.business_table,
    q.business_id,
    q.status,
    r.result_status,
    r.completed_at,
    q.created_at,
    q.updated_at
   FROM (ops.ops_job_queue q
     LEFT JOIN ops.ops_job_result r ON ((r.job_id = q.job_id)))
  ORDER BY q.job_id DESC;


--
-- Name: v_ops_job_result_latest; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_ops_job_result_latest AS
 SELECT DISTINCT ON (job_id) job_id,
    status,
    created_at,
    result_payload
   FROM ops.ops_job_result r
  ORDER BY job_id, created_at DESC;


--
-- Name: v_paper_send_cost_monthly; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_paper_send_cost_monthly AS
 SELECT company_id,
    date_trunc('month'::text, created_at) AS month,
    document_type_code,
    sum(send_fee_amount) AS total_fee,
    count(*) AS send_count
   FROM ops.document_send_history
  WHERE (send_fee_amount > (0)::numeric)
  GROUP BY company_id, (date_trunc('month'::text, created_at)), document_type_code;


--
-- Name: v_send_failed_alert; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_send_failed_alert AS
 SELECT send_history_id,
    company_id,
    document_type_code,
    document_id,
    channel_code,
    resend_type_code,
    retry_count,
    created_at
   FROM ops.document_send_history
  WHERE ((send_status = 'FAILED'::text) AND (retry_count >= 3));


--
-- Name: v_shipping_package_photos; Type: VIEW; Schema: ops; Owner: -
--

CREATE VIEW ops.v_shipping_package_photos AS
 SELECT l.entity_id AS shipping_id,
    l.sort_order,
    l.is_primary,
    a.asset_id,
    a.public_url,
    a.bucket,
    a.object_path,
    a.content_type,
    a.byte_size,
    a.width_px,
    a.height_px,
    a.created_at
   FROM (media.asset_link l
     JOIN media.asset a ON ((a.asset_id = l.asset_id)))
  WHERE ((l.entity_table = 'sales.shipping_header'::text) AND (l.role = 'PACKAGE_PHOTO'::text));


--
-- Name: accounting_period; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.accounting_period AS
 SELECT period_id,
    company_id,
    period_year,
    period_month,
    is_closed,
    closed_at
   FROM core.accounting_period;


--
-- Name: accounts; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.accounts AS
 SELECT account_id,
    company_id,
    account_code,
    account_name,
    account_type,
    is_active,
    created_at
   FROM core.accounts;


--
-- Name: app_user; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.app_user AS
 SELECT user_id,
    company_id,
    email,
    display_name,
    is_active,
    created_at
   FROM core.app_user;


--
-- Name: approval_completed_event; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.approval_completed_event AS
 SELECT request_id,
    order_id,
    status,
    decided_at
   FROM audit.approval_request
  WHERE (status = ANY (ARRAY['approved'::text, 'rejected'::text]));


--
-- Name: approval_request_with_url; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.approval_request_with_url AS
 SELECT request_id,
    company_id,
    domain,
    entity_type,
    entity_id,
    order_id,
    policy_id,
    status,
    detected_at,
    decided_at,
    decided_by,
    decision_note,
    format('https://YOUR-APP-DOMAIN/approve?request_id=%s'::text, request_id) AS approval_url
   FROM audit.approval_request ar;


--
-- Name: attendance_log; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.attendance_log AS
 SELECT attendance_log_id,
    company_id,
    employee_id,
    work_date,
    clock_in,
    clock_out,
    work_minutes
   FROM hr.attendance_log;


--
-- Name: billing_detail; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.billing_detail (
    billing_detail_id bigint NOT NULL,
    billing_id bigint NOT NULL,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL,
    unit_price numeric(18,2) NOT NULL,
    amount numeric(18,2) NOT NULL,
    tax_category_code text
);


--
-- Name: billing_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.billing_detail AS
 SELECT billing_detail_id,
    billing_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount,
    tax_category_code
   FROM sales.billing_detail;


--
-- Name: billing_header; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.billing_header (
    billing_id bigint NOT NULL,
    company_id uuid NOT NULL,
    billing_no text NOT NULL,
    customer_id bigint NOT NULL,
    billing_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'ISSUED'::text NOT NULL,
    total_amount numeric(18,2) DEFAULT 0 NOT NULL,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    original_billing_id bigint
);

ALTER TABLE ONLY sales.billing_header FORCE ROW LEVEL SECURITY;


--
-- Name: billing_header; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.billing_header AS
 SELECT billing_id,
    company_id,
    billing_no,
    customer_id,
    billing_date,
    status_code,
    total_amount,
    created_by,
    created_at
   FROM sales.billing_header;


--
-- Name: bom_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.bom_detail AS
 SELECT bom_detail_id,
    bom_id,
    component_item_id,
    qty_per,
    issue_method,
    created_at
   FROM manufacturing.bom_detail;


--
-- Name: bom_header; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.bom_header AS
 SELECT bom_id,
    company_id,
    parent_item_id,
    version,
    is_active,
    created_at
   FROM manufacturing.bom_header;


--
-- Name: company; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.company AS
 SELECT company_id,
    company_code,
    company_name,
    currency_code,
    timezone,
    is_active,
    created_at,
    updated_at
   FROM core.company;


--
-- Name: company_users; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.company_users AS
 SELECT company_user_id,
    company_id,
    user_id,
    role_code,
    created_at
   FROM core.company_users;


--
-- Name: customer; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.customer (
    customer_id bigint NOT NULL,
    company_id uuid NOT NULL,
    customer_code text NOT NULL,
    customer_name text NOT NULL,
    billing_address text,
    shipping_address text,
    payment_term text,
    credit_limit numeric(18,2),
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY sales.customer FORCE ROW LEVEL SECURITY;


--
-- Name: customer; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.customer AS
 SELECT customer_id,
    company_id,
    customer_code,
    customer_name,
    billing_address,
    shipping_address,
    payment_term,
    credit_limit,
    is_active,
    created_at
   FROM sales.customer;


--
-- Name: document_sequence; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.document_sequence AS
 SELECT sequence_id,
    company_id,
    doc_type,
    prefix,
    current_no,
    updated_at
   FROM core.document_sequence;


--
-- Name: employee; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.employee AS
 SELECT employee_id,
    company_id,
    employee_code,
    employee_name,
    department_id,
    position_id,
    hired_date,
    is_active
   FROM hr.employee;


--
-- Name: employment_contract; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.employment_contract AS
 SELECT employment_contract_id,
    company_id,
    employee_id,
    employment_type,
    start_date,
    end_date,
    base_salary,
    created_at
   FROM hr.employment_contract;


--
-- Name: hr_department; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.hr_department AS
 SELECT department_id,
    company_id,
    department_code,
    department_name
   FROM hr.hr_department;


--
-- Name: hr_position; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.hr_position AS
 SELECT position_id,
    company_id,
    position_code,
    position_name
   FROM hr.hr_position;


--
-- Name: inventory_valuation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.inventory_valuation AS
 SELECT inventory_valuation_id,
    company_id,
    item_id,
    valuation_date,
    method,
    unit_cost,
    created_at
   FROM inventory.inventory_valuation;


--
-- Name: invoice_pdf; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.invoice_pdf (
    invoice_pdf_id bigint NOT NULL,
    company_id uuid NOT NULL,
    billing_id bigint NOT NULL,
    file_path text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY sales.invoice_pdf FORCE ROW LEVEL SECURITY;


--
-- Name: invoice_pdf; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.invoice_pdf AS
 SELECT invoice_pdf_id,
    company_id,
    billing_id,
    file_path,
    created_at
   FROM sales.invoice_pdf;


--
-- Name: item; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.item (
    item_id bigint NOT NULL,
    company_id uuid NOT NULL,
    item_code text NOT NULL,
    item_name text NOT NULL,
    item_category_id bigint,
    uom text DEFAULT 'EA'::text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY sales.item FORCE ROW LEVEL SECURITY;


--
-- Name: item; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.item AS
 SELECT item_id,
    company_id,
    item_code,
    item_name,
    item_category_id,
    uom,
    is_active,
    created_at
   FROM sales.item;


--
-- Name: item_category; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.item_category (
    item_category_id bigint NOT NULL,
    company_id uuid,
    category_code text NOT NULL,
    category_name text NOT NULL,
    parent_category_id bigint,
    category_level integer DEFAULT 1 NOT NULL
);

ALTER TABLE ONLY sales.item_category FORCE ROW LEVEL SECURITY;


--
-- Name: item_category; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.item_category AS
 SELECT item_category_id,
    company_id,
    category_code,
    category_name,
    parent_category_id,
    category_level
   FROM sales.item_category;


--
-- Name: item_price_master; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.item_price_master (
    item_price_id bigint NOT NULL,
    company_id uuid NOT NULL,
    item_id bigint NOT NULL,
    price_type text DEFAULT 'STD'::text NOT NULL,
    price numeric(18,2) NOT NULL,
    currency_code text DEFAULT 'JPY'::text NOT NULL,
    valid_from date DEFAULT CURRENT_DATE NOT NULL,
    valid_to date,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY sales.item_price_master FORCE ROW LEVEL SECURITY;


--
-- Name: item_price_master; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.item_price_master AS
 SELECT item_price_id,
    company_id,
    item_id,
    price_type,
    price,
    currency_code,
    valid_from,
    valid_to,
    is_active,
    created_at
   FROM sales.item_price_master;


--
-- Name: journal_entries; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.journal_entries AS
 SELECT journal_id,
    company_id,
    period_id,
    journal_date,
    description,
    source_type,
    source_id,
    created_by,
    created_at
   FROM core.journal_entries;


--
-- Name: journal_lines; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.journal_lines AS
 SELECT journal_line_id,
    journal_id,
    line_no,
    account_id,
    debit_amount,
    credit_amount,
    memo
   FROM core.journal_lines;


--
-- Name: leave_request; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.leave_request AS
 SELECT leave_request_id,
    company_id,
    employee_id,
    leave_type_code,
    start_date,
    end_date,
    status_code,
    approved_by,
    created_at
   FROM hr.leave_request;


--
-- Name: leave_type; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.leave_type AS
 SELECT leave_type_code,
    leave_type_name
   FROM hr.leave_type;


--
-- Name: license_master; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.license_master AS
 SELECT code,
    name,
    description,
    is_active
   FROM core.license_master;


--
-- Name: login_history; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.login_history AS
 SELECT login_id,
    user_id,
    logged_in_at,
    ip_addr,
    user_agent
   FROM core.login_history;


--
-- Name: manufacturing_cost_snapshot; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.manufacturing_cost_snapshot AS
 SELECT manufacturing_cost_snapshot_id,
    company_id,
    work_order_id,
    total_cost,
    snapshot_at
   FROM manufacturing.manufacturing_cost_snapshot;


--
-- Name: manufacturing_execution; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.manufacturing_execution AS
 SELECT execution_id,
    company_id,
    work_order_id,
    warehouse_id,
    executed_at,
    status_code
   FROM manufacturing.manufacturing_execution;


--
-- Name: manufacturing_execution_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.manufacturing_execution_detail AS
 SELECT execution_detail_id,
    execution_id,
    item_id,
    qty,
    movement_type
   FROM manufacturing.manufacturing_execution_detail;


--
-- Name: mps_plan; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.mps_plan AS
 SELECT mps_plan_id,
    mps_run_id,
    item_id,
    plan_date,
    plan_qty
   FROM manufacturing.mps_plan;


--
-- Name: mps_run; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.mps_run AS
 SELECT mps_run_id,
    company_id,
    run_type,
    run_at
   FROM manufacturing.mps_run;


--
-- Name: mrp_allocation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.mrp_allocation AS
 SELECT mrp_allocation_id,
    mrp_requirement_id,
    source_type,
    source_id,
    qty_allocated
   FROM manufacturing.mrp_allocation;


--
-- Name: mrp_requirement; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.mrp_requirement AS
 SELECT mrp_requirement_id,
    mrp_run_id,
    item_id,
    requirement_date,
    qty_required,
    supply_type
   FROM manufacturing.mrp_requirement;


--
-- Name: mrp_run; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.mrp_run AS
 SELECT mrp_run_id,
    company_id,
    run_type,
    run_at
   FROM manufacturing.mrp_run;


--
-- Name: order_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.order_detail AS
 SELECT order_detail_id,
    order_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount,
    requested_ship_date
   FROM sales.order_detail;


--
-- Name: order_header; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.order_header AS
 SELECT order_id,
    company_id,
    order_no,
    customer_id,
    order_date,
    status_code,
    remarks,
    created_by,
    created_at
   FROM sales.order_header;


--
-- Name: payment; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.payment AS
 SELECT payment_id,
    company_id,
    payment_type,
    partner_type,
    partner_id,
    payment_date,
    amount,
    bank_account_id,
    status_code,
    created_at
   FROM finance.payment;


--
-- Name: payroll_run; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.payroll_run AS
 SELECT payroll_run_id,
    company_id,
    pay_month,
    status_code,
    created_at
   FROM hr.payroll_run;


--
-- Name: payroll_slip; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.payroll_slip AS
 SELECT payroll_slip_id,
    payroll_run_id,
    employee_id,
    gross_pay,
    net_pay,
    created_at
   FROM hr.payroll_slip;


--
-- Name: permission_groups; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.permission_groups AS
 SELECT group_id,
    company_id,
    group_code,
    group_name,
    created_at
   FROM core.permission_groups;


--
-- Name: permissions; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.permissions AS
 SELECT permission_id,
    company_id,
    code,
    name,
    description,
    is_active,
    created_at
   FROM core.permissions;


--
-- Name: process_master; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.process_master AS
 SELECT process_id,
    company_id,
    process_code,
    process_name
   FROM manufacturing.process_master;


--
-- Name: purchase_invoice; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_invoice (
    purchase_invoice_id bigint NOT NULL,
    company_id uuid NOT NULL,
    supplier_id bigint NOT NULL,
    invoice_no text NOT NULL,
    invoice_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'POSTED'::text NOT NULL,
    total_amount numeric(18,2) DEFAULT 0 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY purchase.purchase_invoice FORCE ROW LEVEL SECURITY;


--
-- Name: purchase_invoice; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_invoice AS
 SELECT purchase_invoice_id,
    company_id,
    supplier_id,
    invoice_no,
    invoice_date,
    status_code,
    total_amount,
    created_at
   FROM purchase.purchase_invoice;


--
-- Name: purchase_invoice_detail; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_invoice_detail (
    purchase_invoice_detail_id bigint NOT NULL,
    purchase_invoice_id bigint NOT NULL,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL,
    unit_price numeric(18,2) NOT NULL,
    amount numeric(18,2) NOT NULL,
    receipt_detail_id bigint,
    purchase_order_detail_id bigint
);


--
-- Name: purchase_invoice_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_invoice_detail AS
 SELECT purchase_invoice_detail_id,
    purchase_invoice_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount,
    receipt_detail_id,
    purchase_order_detail_id
   FROM purchase.purchase_invoice_detail;


--
-- Name: purchase_order_detail; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_order_detail (
    purchase_order_detail_id bigint NOT NULL,
    purchase_order_id bigint NOT NULL,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL,
    unit_price numeric(18,2) NOT NULL,
    amount numeric(18,2) NOT NULL,
    promised_date date
);


--
-- Name: purchase_order_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_order_detail AS
 SELECT purchase_order_detail_id,
    purchase_order_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount,
    promised_date
   FROM purchase.purchase_order_detail;


--
-- Name: purchase_order_header; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_order_header (
    purchase_order_id bigint NOT NULL,
    company_id uuid NOT NULL,
    purchase_order_no text NOT NULL,
    supplier_id bigint NOT NULL,
    order_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'OPEN'::text NOT NULL,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY purchase.purchase_order_header FORCE ROW LEVEL SECURITY;


--
-- Name: purchase_order_header; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_order_header AS
 SELECT purchase_order_id,
    company_id,
    purchase_order_no,
    supplier_id,
    order_date,
    status_code,
    created_by,
    created_at
   FROM purchase.purchase_order_header;


--
-- Name: purchase_quotation; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_quotation (
    purchase_quotation_id bigint NOT NULL,
    company_id uuid NOT NULL,
    supplier_id bigint NOT NULL,
    quotation_no text NOT NULL,
    quotation_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'RECEIVED'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY purchase.purchase_quotation FORCE ROW LEVEL SECURITY;


--
-- Name: purchase_quotation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_quotation AS
 SELECT purchase_quotation_id,
    company_id,
    supplier_id,
    quotation_no,
    quotation_date,
    status_code,
    created_at
   FROM purchase.purchase_quotation;


--
-- Name: purchase_quotation_detail; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_quotation_detail (
    purchase_quotation_detail_id bigint NOT NULL,
    purchase_quotation_id bigint NOT NULL,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL,
    unit_price numeric(18,2) NOT NULL,
    amount numeric(18,2) NOT NULL
);


--
-- Name: purchase_quotation_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_quotation_detail AS
 SELECT purchase_quotation_detail_id,
    purchase_quotation_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount
   FROM purchase.purchase_quotation_detail;


--
-- Name: purchase_receipt; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_receipt (
    receipt_id bigint NOT NULL,
    company_id uuid NOT NULL,
    purchase_order_id bigint NOT NULL,
    warehouse_id bigint NOT NULL,
    receipt_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'RECEIVED'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY purchase.purchase_receipt FORCE ROW LEVEL SECURITY;


--
-- Name: purchase_receipt; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_receipt AS
 SELECT receipt_id,
    company_id,
    purchase_order_id,
    warehouse_id,
    receipt_date,
    status_code,
    created_at
   FROM purchase.purchase_receipt;


--
-- Name: purchase_receipt_detail; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_receipt_detail (
    receipt_detail_id bigint NOT NULL,
    receipt_id bigint NOT NULL,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty_received numeric(18,3) NOT NULL,
    purchase_order_detail_id bigint
);


--
-- Name: purchase_receipt_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_receipt_detail AS
 SELECT receipt_detail_id,
    receipt_id,
    line_no,
    item_id,
    qty_received,
    purchase_order_detail_id
   FROM purchase.purchase_receipt_detail;


--
-- Name: purchase_requisition; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_requisition (
    purchase_requisition_id bigint NOT NULL,
    company_id uuid NOT NULL,
    requisition_no text NOT NULL,
    requester_id uuid NOT NULL,
    requisition_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'DRAFT'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY purchase.purchase_requisition FORCE ROW LEVEL SECURITY;


--
-- Name: purchase_requisition; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_requisition AS
 SELECT purchase_requisition_id,
    company_id,
    requisition_no,
    requester_id,
    requisition_date,
    status_code,
    created_at
   FROM purchase.purchase_requisition;


--
-- Name: purchase_requisition_detail; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_requisition_detail (
    purchase_requisition_detail_id bigint NOT NULL,
    purchase_requisition_id bigint NOT NULL,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL,
    required_date date
);


--
-- Name: purchase_requisition_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_requisition_detail AS
 SELECT purchase_requisition_detail_id,
    purchase_requisition_id,
    line_no,
    item_id,
    qty,
    required_date
   FROM purchase.purchase_requisition_detail;


--
-- Name: purchase_three_way_match; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.purchase_three_way_match (
    purchase_three_way_match_id bigint NOT NULL,
    company_id uuid NOT NULL,
    purchase_order_detail_id bigint NOT NULL,
    receipt_detail_id bigint NOT NULL,
    purchase_invoice_detail_id bigint NOT NULL,
    matched_at timestamp with time zone DEFAULT now() NOT NULL,
    status_code text DEFAULT 'MATCHED'::text NOT NULL
);

ALTER TABLE ONLY purchase.purchase_three_way_match FORCE ROW LEVEL SECURITY;


--
-- Name: purchase_three_way_match; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.purchase_three_way_match AS
 SELECT purchase_three_way_match_id,
    company_id,
    purchase_order_detail_id,
    receipt_detail_id,
    purchase_invoice_detail_id,
    matched_at,
    status_code
   FROM purchase.purchase_three_way_match;


--
-- Name: return_detail; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.return_detail (
    return_detail_id bigint NOT NULL,
    return_id bigint NOT NULL,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL,
    reason_code text
);


--
-- Name: return_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.return_detail AS
 SELECT return_detail_id,
    return_id,
    line_no,
    item_id,
    qty,
    reason_code
   FROM sales.return_detail;


--
-- Name: return_header; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.return_header (
    return_id bigint NOT NULL,
    company_id uuid NOT NULL,
    return_no text NOT NULL,
    billing_id bigint,
    return_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'REQUESTED'::text NOT NULL,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY sales.return_header FORCE ROW LEVEL SECURITY;


--
-- Name: return_header; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.return_header AS
 SELECT return_id,
    company_id,
    return_no,
    billing_id,
    return_date,
    status_code,
    created_by,
    created_at
   FROM sales.return_header;


--
-- Name: routing_header; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.routing_header AS
 SELECT routing_id,
    company_id,
    item_id,
    version,
    is_active,
    created_at
   FROM manufacturing.routing_header;


--
-- Name: routing_operation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.routing_operation AS
 SELECT routing_operation_id,
    routing_id,
    operation_no,
    process_id,
    std_time_minutes
   FROM manufacturing.routing_operation;


--
-- Name: sales_quotation; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.sales_quotation (
    sales_quotation_id bigint NOT NULL,
    company_id uuid NOT NULL,
    quotation_no text NOT NULL,
    customer_id bigint NOT NULL,
    quotation_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'DRAFT'::text NOT NULL,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY sales.sales_quotation FORCE ROW LEVEL SECURITY;


--
-- Name: sales_quotation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.sales_quotation AS
 SELECT sales_quotation_id,
    company_id,
    quotation_no,
    customer_id,
    quotation_date,
    status_code,
    created_by,
    created_at
   FROM sales.sales_quotation;


--
-- Name: sales_quotation_detail; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.sales_quotation_detail (
    sales_quotation_detail_id bigint NOT NULL,
    sales_quotation_id bigint NOT NULL,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL,
    unit_price numeric(18,2) NOT NULL,
    amount numeric(18,2) NOT NULL,
    tax_category_code text
);


--
-- Name: sales_quotation_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.sales_quotation_detail AS
 SELECT sales_quotation_detail_id,
    sales_quotation_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount,
    tax_category_code
   FROM sales.sales_quotation_detail;


--
-- Name: shipping_detail; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.shipping_detail (
    shipping_detail_id bigint NOT NULL,
    shipping_id bigint NOT NULL,
    order_detail_id bigint,
    line_no integer NOT NULL,
    item_id bigint NOT NULL,
    qty numeric(18,3) NOT NULL
);


--
-- Name: shipping_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.shipping_detail AS
 SELECT shipping_detail_id,
    shipping_id,
    order_detail_id,
    line_no,
    item_id,
    qty
   FROM sales.shipping_detail;


--
-- Name: shipping_header; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.shipping_header (
    shipping_id bigint NOT NULL,
    company_id uuid NOT NULL,
    shipping_no text NOT NULL,
    order_id bigint NOT NULL,
    shipping_date date DEFAULT CURRENT_DATE NOT NULL,
    status_code text DEFAULT 'PICKING'::text NOT NULL,
    shipping_fee numeric(18,2) DEFAULT 0 NOT NULL,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY sales.shipping_header FORCE ROW LEVEL SECURITY;


--
-- Name: shipping_header; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.shipping_header AS
 SELECT shipping_id,
    company_id,
    shipping_no,
    order_id,
    shipping_date,
    status_code,
    shipping_fee,
    created_by,
    created_at
   FROM sales.shipping_header;


--
-- Name: status_history; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.status_history AS
 SELECT status_history_id,
    company_id,
    entity_type,
    entity_id,
    from_status_code,
    to_status_code,
    changed_by,
    changed_at,
    reason
   FROM core.status_history;


--
-- Name: status_master; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.status_master AS
 SELECT status_id,
    entity_type,
    status_code,
    status_name,
    sort_order,
    is_terminal
   FROM core.status_master;


--
-- Name: stock_balance; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.stock_balance AS
 SELECT stock_balance_id,
    company_id,
    warehouse_id,
    location_id,
    bin_id,
    item_id,
    qty_on_hand,
    qty_reserved,
    updated_at
   FROM inventory.stock_balance;


--
-- Name: stock_bin; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.stock_bin AS
 SELECT bin_id,
    company_id,
    location_id,
    bin_code,
    is_active
   FROM inventory.stock_bin;


--
-- Name: stock_lot; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.stock_lot AS
 SELECT stock_lot_id,
    company_id,
    item_id,
    lot_no,
    serial_no,
    expiry_date
   FROM inventory.stock_lot;


--
-- Name: stock_lot_balance; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.stock_lot_balance AS
 SELECT stock_lot_balance_id,
    company_id,
    warehouse_id,
    location_id,
    bin_id,
    item_id,
    stock_lot_id,
    qty_on_hand,
    qty_reserved,
    updated_at
   FROM inventory.stock_lot_balance;


--
-- Name: stock_reservation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.stock_reservation AS
 SELECT stock_reservation_id,
    company_id,
    entity_type,
    entity_id,
    item_id,
    stock_lot_id,
    qty_reserved,
    reserved_at
   FROM inventory.stock_reservation;


--
-- Name: stock_transaction; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.stock_transaction AS
 SELECT stock_tx_id,
    company_id,
    tx_type,
    warehouse_id,
    item_id,
    stock_lot_id,
    from_bin_id,
    to_bin_id,
    qty,
    reference_type,
    reference_id,
    occurred_at
   FROM inventory.stock_transaction;


--
-- Name: stocktaking_plan; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.stocktaking_plan AS
 SELECT stocktaking_plan_id,
    company_id,
    warehouse_id,
    plan_date,
    status_code,
    created_at
   FROM inventory.stocktaking_plan;


--
-- Name: stocktaking_result; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.stocktaking_result AS
 SELECT stocktaking_result_id,
    stocktaking_plan_id,
    company_id,
    bin_id,
    item_id,
    counted_qty,
    system_qty,
    difference_qty,
    created_at
   FROM inventory.stocktaking_result;


--
-- Name: storage_location; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.storage_location AS
 SELECT location_id,
    company_id,
    warehouse_id,
    location_code,
    location_name,
    is_active
   FROM inventory.storage_location;


--
-- Name: supplier_item_price; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.supplier_item_price (
    supplier_item_price_id bigint NOT NULL,
    company_id uuid NOT NULL,
    supplier_id bigint NOT NULL,
    item_id bigint NOT NULL,
    price numeric(18,2) NOT NULL,
    currency_code text DEFAULT 'JPY'::text NOT NULL,
    valid_from date DEFAULT CURRENT_DATE NOT NULL,
    valid_to date,
    is_active boolean DEFAULT true NOT NULL
);

ALTER TABLE ONLY purchase.supplier_item_price FORCE ROW LEVEL SECURITY;


--
-- Name: supplier_item_price; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.supplier_item_price AS
 SELECT supplier_item_price_id,
    company_id,
    supplier_id,
    item_id,
    price,
    currency_code,
    valid_from,
    valid_to,
    is_active
   FROM purchase.supplier_item_price;


--
-- Name: supplier_master; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.supplier_master (
    supplier_id bigint NOT NULL,
    company_id uuid NOT NULL,
    supplier_code text NOT NULL,
    supplier_name text NOT NULL,
    tax_handling text DEFAULT 'EXCLUSIVE'::text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

ALTER TABLE ONLY purchase.supplier_master FORCE ROW LEVEL SECURITY;


--
-- Name: supplier_master; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.supplier_master AS
 SELECT supplier_id,
    company_id,
    supplier_code,
    supplier_name,
    tax_handling,
    is_active,
    created_at
   FROM purchase.supplier_master;


--
-- Name: sync_queue; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.sync_queue AS
 SELECT sync_id,
    company_id,
    entity_type,
    entity_id,
    action,
    payload,
    status,
    retry_count,
    last_error,
    created_at,
    updated_at
   FROM core.sync_queue;


--
-- Name: user_permissions; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.user_permissions AS
 SELECT user_id,
    permission_id,
    granted_at
   FROM core.user_permissions;


--
-- Name: v_approval_log; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_approval_log AS
 SELECT approval_log_id,
    approval_request_id,
    action,
    actor,
    note,
    acted_at
   FROM audit.approval_log;


--
-- Name: v_approval_request; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_approval_request AS
 SELECT request_id,
    company_id,
    domain,
    entity_type,
    entity_id,
    order_id,
    reason,
    detected_at,
    status,
    decided_at,
    decided_by,
    decision_note,
    policy_id,
    severity
   FROM audit.approval_request;


--
-- Name: v_audit_kpi_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_audit_kpi_summary AS
 SELECT company_id,
    business_domain,
    audit_scope,
    severity,
    count(*) AS event_count,
    count(*) FILTER (WHERE (auto_fixed = true)) AS auto_fixed_count,
    count(*) FILTER (WHERE (quarantined = true)) AS quarantined_count,
    max(occurred_at) AS last_occurred_at
   FROM audit.ng_event
  GROUP BY company_id, business_domain, audit_scope, severity;


--
-- Name: v_audit_kpi_weekly; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_audit_kpi_weekly AS
 SELECT company_id,
    business_domain,
    date_trunc('week'::text, occurred_at) AS week,
    severity,
    count(*) AS event_count
   FROM audit.ng_event
  GROUP BY company_id, business_domain, (date_trunc('week'::text, occurred_at)), severity;


--
-- Name: v_core_audit_trail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_core_audit_trail AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    action_category,
    detail,
    performed_by,
    performed_at
   FROM core.audit_trail;


--
-- Name: v_core_company; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_core_company AS
 SELECT company_id,
    company_code,
    company_name,
    currency_code,
    timezone,
    is_active,
    created_at,
    updated_at
   FROM core.company;


--
-- Name: v_core_company_license; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_core_company_license AS
 SELECT company_license_id,
    company_id,
    license_code,
    purchased_at,
    expires_at,
    is_active
   FROM core.company_license;


--
-- Name: v_core_company_permission; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_core_company_permission AS
 SELECT company_permission_id,
    company_id,
    permission_code,
    enabled,
    created_at
   FROM core.company_permission;


--
-- Name: v_core_journal_source_link; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_core_journal_source_link AS
 SELECT journal_source_link_id,
    journal_id,
    source_type,
    source_id,
    created_at
   FROM core.journal_source_link;


--
-- Name: v_core_payment_term; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_core_payment_term AS
 SELECT payment_term_id,
    term_code,
    term_name,
    closing_day,
    payment_offset_month,
    payment_day,
    description,
    is_active
   FROM core.payment_term;


--
-- Name: v_core_posting_profile; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_core_posting_profile AS
 SELECT posting_profile_id,
    company_id,
    profile_code,
    source_type,
    debit_account_id,
    credit_account_id,
    description,
    is_active
   FROM core.posting_profile;


--
-- Name: v_core_status_history; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_core_status_history AS
 SELECT status_history_id,
    company_id,
    entity_type,
    entity_id,
    from_status_code,
    to_status_code,
    changed_by,
    changed_at,
    reason
   FROM core.status_history;


--
-- Name: v_finance_bank_account; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_finance_bank_account AS
 SELECT bank_account_id,
    company_id,
    bank_name,
    branch_name,
    account_type,
    account_number,
    account_name,
    currency_code,
    is_active
   FROM finance.bank_account;


--
-- Name: v_finance_bank_statement_line; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_finance_bank_statement_line AS
 SELECT bank_statement_line_id,
    bank_statement_id,
    line_no,
    transaction_date,
    description,
    debit_amount,
    credit_amount,
    balance_amount
   FROM finance.bank_statement_line;


--
-- Name: v_finance_payment; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_finance_payment AS
 SELECT payment_id,
    company_id,
    payment_type,
    partner_type,
    partner_id,
    payment_date,
    amount,
    bank_account_id,
    status_code,
    created_at
   FROM finance.payment;


--
-- Name: v_finance_payment_allocation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_finance_payment_allocation AS
 SELECT payment_allocation_id,
    payment_id,
    source_type,
    source_id,
    allocated_amount,
    allocated_at
   FROM finance.payment_allocation;


--
-- Name: v_hr_attendance_log; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_hr_attendance_log AS
 SELECT attendance_log_id,
    company_id,
    employee_id,
    work_date,
    clock_in,
    clock_out,
    work_minutes
   FROM hr.attendance_log;


--
-- Name: v_hr_employee; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_hr_employee AS
 SELECT employee_id,
    company_id,
    employee_code,
    employee_name,
    department_id,
    position_id,
    hired_date,
    is_active
   FROM hr.employee;


--
-- Name: v_hr_employment_contract; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_hr_employment_contract AS
 SELECT employment_contract_id,
    company_id,
    employee_id,
    employment_type,
    start_date,
    end_date,
    base_salary,
    created_at
   FROM hr.employment_contract;


--
-- Name: v_hr_leave_request; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_hr_leave_request AS
 SELECT leave_request_id,
    company_id,
    employee_id,
    leave_type_code,
    start_date,
    end_date,
    status_code,
    approved_by,
    created_at
   FROM hr.leave_request;


--
-- Name: v_hr_payroll_run; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_hr_payroll_run AS
 SELECT payroll_run_id,
    company_id,
    pay_month,
    status_code,
    created_at
   FROM hr.payroll_run;


--
-- Name: v_hr_payroll_slip; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_hr_payroll_slip AS
 SELECT payroll_slip_id,
    payroll_run_id,
    employee_id,
    gross_pay,
    net_pay,
    created_at
   FROM hr.payroll_slip;


--
-- Name: v_inventory_inventory_valuation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_inventory_inventory_valuation AS
 SELECT inventory_valuation_id,
    company_id,
    item_id,
    valuation_date,
    method,
    unit_cost,
    created_at
   FROM inventory.inventory_valuation;


--
-- Name: v_inventory_stock_balance; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_inventory_stock_balance AS
 SELECT stock_balance_id,
    company_id,
    warehouse_id,
    location_id,
    bin_id,
    item_id,
    qty_on_hand,
    qty_reserved,
    updated_at
   FROM inventory.stock_balance;


--
-- Name: v_inventory_stock_lot; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_inventory_stock_lot AS
 SELECT stock_lot_id,
    company_id,
    item_id,
    lot_no,
    serial_no,
    expiry_date
   FROM inventory.stock_lot;


--
-- Name: v_inventory_stock_lot_balance; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_inventory_stock_lot_balance AS
 SELECT stock_lot_balance_id,
    company_id,
    warehouse_id,
    location_id,
    bin_id,
    item_id,
    stock_lot_id,
    qty_on_hand,
    qty_reserved,
    updated_at
   FROM inventory.stock_lot_balance;


--
-- Name: v_inventory_stock_reservation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_inventory_stock_reservation AS
 SELECT stock_reservation_id,
    company_id,
    entity_type,
    entity_id,
    item_id,
    stock_lot_id,
    qty_reserved,
    reserved_at
   FROM inventory.stock_reservation;


--
-- Name: v_inventory_stock_transfer_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_inventory_stock_transfer_detail AS
 SELECT stock_transfer_detail_id,
    stock_transfer_id,
    line_no,
    item_id,
    qty,
    from_location_id,
    to_location_id,
    from_bin_id,
    to_bin_id,
    stock_lot_id
   FROM inventory.stock_transfer_detail;


--
-- Name: v_inventory_stocktaking_plan; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_inventory_stocktaking_plan AS
 SELECT stocktaking_plan_id,
    company_id,
    warehouse_id,
    plan_date,
    status_code,
    created_at
   FROM inventory.stocktaking_plan;


--
-- Name: v_inventory_stocktaking_result; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_inventory_stocktaking_result AS
 SELECT stocktaking_result_id,
    stocktaking_plan_id,
    company_id,
    bin_id,
    item_id,
    counted_qty,
    system_qty,
    difference_qty,
    created_at
   FROM inventory.stocktaking_result;


--
-- Name: v_inventory_warehouse; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_inventory_warehouse AS
 SELECT warehouse_id,
    company_id,
    warehouse_code,
    warehouse_name,
    is_active,
    created_at
   FROM inventory.warehouse;


--
-- Name: v_manufacturing_bom_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_manufacturing_bom_detail AS
 SELECT bom_detail_id,
    bom_id,
    component_item_id,
    qty_per,
    issue_method,
    created_at
   FROM manufacturing.bom_detail;


--
-- Name: v_manufacturing_manufacturing_cost_snapshot; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_manufacturing_manufacturing_cost_snapshot AS
 SELECT manufacturing_cost_snapshot_id,
    company_id,
    work_order_id,
    total_cost,
    snapshot_at
   FROM manufacturing.manufacturing_cost_snapshot;


--
-- Name: v_manufacturing_mps_plan; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_manufacturing_mps_plan AS
 SELECT mps_plan_id,
    mps_run_id,
    item_id,
    plan_date,
    plan_qty
   FROM manufacturing.mps_plan;


--
-- Name: v_manufacturing_mps_run; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_manufacturing_mps_run AS
 SELECT mps_run_id,
    company_id,
    run_type,
    run_at
   FROM manufacturing.mps_run;


--
-- Name: v_manufacturing_mrp_allocation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_manufacturing_mrp_allocation AS
 SELECT mrp_allocation_id,
    mrp_requirement_id,
    source_type,
    source_id,
    qty_allocated
   FROM manufacturing.mrp_allocation;


--
-- Name: v_manufacturing_mrp_requirement; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_manufacturing_mrp_requirement AS
 SELECT mrp_requirement_id,
    mrp_run_id,
    item_id,
    requirement_date,
    qty_required,
    supply_type
   FROM manufacturing.mrp_requirement;


--
-- Name: v_manufacturing_mrp_run; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_manufacturing_mrp_run AS
 SELECT mrp_run_id,
    company_id,
    run_type,
    run_at
   FROM manufacturing.mrp_run;


--
-- Name: v_manufacturing_routing_operation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_manufacturing_routing_operation AS
 SELECT routing_operation_id,
    routing_id,
    operation_no,
    process_id,
    std_time_minutes
   FROM manufacturing.routing_operation;


--
-- Name: v_manufacturing_work_order; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_manufacturing_work_order AS
 SELECT work_order_id,
    company_id,
    wo_no,
    item_id,
    bom_id,
    routing_id,
    warehouse_id,
    plan_qty,
    plan_start_date,
    plan_end_date,
    status_code,
    created_at
   FROM manufacturing.work_order;


--
-- Name: v_manufacturing_yield_metric; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_manufacturing_yield_metric AS
 SELECT yield_metric_id,
    company_id,
    process_id,
    metric_date,
    yield_rate
   FROM manufacturing.yield_metric;


--
-- Name: v_ng_daily_trend; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_ng_daily_trend AS
 SELECT company_id,
    date_trunc('day'::text, occurred_at) AS day,
    severity,
    count(*) AS event_count
   FROM audit.ng_event
  GROUP BY company_id, (date_trunc('day'::text, occurred_at)), severity;


--
-- Name: v_ng_event; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_ng_event AS
 SELECT ng_event_id,
    company_id,
    occurred_at,
    event_key,
    task_name,
    audit_scope,
    severity,
    reason_code,
    phase,
    retry_count,
    auto_fixed,
    quarantined,
    approval_required,
    approved_by,
    approved_at,
    business_domain,
    context
   FROM audit.ng_event;


--
-- Name: v_ng_event_list; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_ng_event_list AS
 SELECT ng_event_id,
    company_id,
    occurred_at,
    business_domain,
    event_key,
    task_name,
    audit_scope,
    severity,
    reason_code,
    phase,
    retry_count,
    auto_fixed,
    quarantined,
    approval_required,
    approved_at
   FROM audit.ng_event;


--
-- Name: v_ng_reason_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_ng_reason_stats AS
 SELECT company_id,
    reason_code,
    severity,
    count(*) AS event_count
   FROM audit.ng_event
  GROUP BY company_id, reason_code, severity;


--
-- Name: v_policy_update_candidate; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_policy_update_candidate AS
 SELECT business_domain,
    event_key,
    reason_code,
    count(*) AS ng_count,
    max(occurred_at) AS last_occurred_at
   FROM audit.ng_event
  WHERE (severity = ANY (ARRAY['ng'::text, 'critical'::text]))
  GROUP BY business_domain, event_key, reason_code;


--
-- Name: v_purchase_purchase_invoice; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_purchase_invoice AS
 SELECT purchase_invoice_id,
    company_id,
    supplier_id,
    invoice_no,
    invoice_date,
    status_code,
    total_amount,
    created_at
   FROM purchase.purchase_invoice;


--
-- Name: v_purchase_purchase_invoice_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_purchase_invoice_detail AS
 SELECT purchase_invoice_detail_id,
    purchase_invoice_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount,
    receipt_detail_id,
    purchase_order_detail_id
   FROM purchase.purchase_invoice_detail;


--
-- Name: v_purchase_purchase_order_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_purchase_order_detail AS
 SELECT purchase_order_detail_id,
    purchase_order_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount,
    promised_date
   FROM purchase.purchase_order_detail;


--
-- Name: v_purchase_purchase_quotation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_purchase_quotation AS
 SELECT purchase_quotation_id,
    company_id,
    supplier_id,
    quotation_no,
    quotation_date,
    status_code,
    created_at
   FROM purchase.purchase_quotation;


--
-- Name: v_purchase_purchase_quotation_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_purchase_quotation_detail AS
 SELECT purchase_quotation_detail_id,
    purchase_quotation_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount
   FROM purchase.purchase_quotation_detail;


--
-- Name: v_purchase_purchase_requisition; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_purchase_requisition AS
 SELECT purchase_requisition_id,
    company_id,
    requisition_no,
    requester_id,
    requisition_date,
    status_code,
    created_at
   FROM purchase.purchase_requisition;


--
-- Name: v_purchase_purchase_requisition_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_purchase_requisition_detail AS
 SELECT purchase_requisition_detail_id,
    purchase_requisition_id,
    line_no,
    item_id,
    qty,
    required_date
   FROM purchase.purchase_requisition_detail;


--
-- Name: v_purchase_purchase_three_way_match; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_purchase_three_way_match AS
 SELECT purchase_three_way_match_id,
    company_id,
    purchase_order_detail_id,
    receipt_detail_id,
    purchase_invoice_detail_id,
    matched_at,
    status_code
   FROM purchase.purchase_three_way_match;


--
-- Name: supplier_address; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.supplier_address (
    supplier_address_id bigint NOT NULL,
    supplier_id bigint NOT NULL,
    address_type text NOT NULL,
    postal_code text,
    country_code text DEFAULT 'JP'::text NOT NULL,
    prefecture text,
    city text,
    address_line1 text NOT NULL,
    address_line2 text,
    is_default boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_purchase_supplier_address; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_supplier_address AS
 SELECT supplier_address_id,
    supplier_id,
    address_type,
    postal_code,
    country_code,
    prefecture,
    city,
    address_line1,
    address_line2,
    is_default,
    created_at
   FROM purchase.supplier_address;


--
-- Name: supplier_contact; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.supplier_contact (
    supplier_contact_id bigint NOT NULL,
    supplier_id bigint NOT NULL,
    contact_name text NOT NULL,
    department_name text,
    email text,
    phone text,
    mobile text,
    is_primary boolean DEFAULT false NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_purchase_supplier_contact; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_supplier_contact AS
 SELECT supplier_contact_id,
    supplier_id,
    contact_name,
    department_name,
    email,
    phone,
    mobile,
    is_primary,
    is_active,
    created_at
   FROM purchase.supplier_contact;


--
-- Name: v_purchase_supplier_item_price; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_supplier_item_price AS
 SELECT supplier_item_price_id,
    company_id,
    supplier_id,
    item_id,
    price,
    currency_code,
    valid_from,
    valid_to,
    is_active
   FROM purchase.supplier_item_price;


--
-- Name: supplier_payment_term; Type: TABLE; Schema: purchase; Owner: -
--

CREATE TABLE purchase.supplier_payment_term (
    supplier_payment_term_id bigint NOT NULL,
    supplier_id bigint NOT NULL,
    payment_term_id bigint NOT NULL,
    payment_method_code text,
    valid_from date DEFAULT CURRENT_DATE NOT NULL,
    valid_to date,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: v_purchase_supplier_payment_term; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_purchase_supplier_payment_term AS
 SELECT supplier_payment_term_id,
    supplier_id,
    payment_term_id,
    payment_method_code,
    valid_from,
    valid_to,
    is_active
   FROM purchase.supplier_payment_term;


--
-- Name: v_rls_table_status; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_rls_table_status AS
 SELECT n.nspname AS schema_name,
    c.relname AS table_name,
    c.relrowsecurity AS rls_enabled,
    c.relforcerowsecurity AS rls_forced,
    (EXISTS ( SELECT 1
           FROM information_schema.columns col
          WHERE (((col.table_schema)::name = n.nspname) AND ((col.table_name)::name = c.relname) AND ((col.column_name)::name = 'company_id'::name)))) AS has_company_id,
    (EXISTS ( SELECT 1
           FROM pg_policies p
          WHERE ((p.schemaname = n.nspname) AND (p.tablename = c.relname) AND (p.policyname ~~ '%company_rls%'::text)))) AS has_company_policy,
    (EXISTS ( SELECT 1
           FROM pg_policies p
          WHERE ((p.schemaname = n.nspname) AND (p.tablename = c.relname) AND (p.policyname ~~ '%admin_bypass%'::text)))) AS has_admin_bypass,
        CASE
            WHEN (n.nspname = ANY (ARRAY['core'::name, 'sales'::name, 'purchase'::name, 'inventory'::name, 'manufacturing'::name, 'hr'::name, 'finance'::name])) THEN 'BUSINESS'::text
            WHEN (n.nspname = ANY (ARRAY['auth'::name, 'vault'::name, 'storage'::name, 'realtime'::name, 'pg_catalog'::name, 'information_schema'::name])) THEN 'INTERNAL'::text
            ELSE 'NON_BUSINESS'::text
        END AS category
   FROM (pg_class c
     JOIN pg_namespace n ON ((n.oid = c.relnamespace)))
  WHERE (c.relkind = 'r'::"char")
  ORDER BY
        CASE
            WHEN (n.nspname = ANY (ARRAY['core'::name, 'sales'::name, 'purchase'::name, 'inventory'::name, 'manufacturing'::name, 'hr'::name, 'finance'::name])) THEN 'BUSINESS'::text
            WHEN (n.nspname = ANY (ARRAY['auth'::name, 'vault'::name, 'storage'::name, 'realtime'::name, 'pg_catalog'::name, 'information_schema'::name])) THEN 'INTERNAL'::text
            ELSE 'NON_BUSINESS'::text
        END, n.nspname, c.relname;


--
-- Name: v_sales_billing_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_billing_detail AS
 SELECT billing_detail_id,
    billing_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount,
    tax_category_code
   FROM sales.billing_detail;


--
-- Name: v_sales_customer; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_customer AS
 SELECT customer_id,
    company_id,
    customer_code,
    customer_name,
    billing_address,
    shipping_address,
    payment_term,
    credit_limit,
    is_active,
    created_at
   FROM sales.customer;


--
-- Name: customer_address; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.customer_address (
    customer_address_id bigint NOT NULL,
    customer_id bigint NOT NULL,
    address_type text NOT NULL,
    postal_code text,
    country_code text DEFAULT 'JP'::text NOT NULL,
    prefecture text,
    city text,
    address_line1 text NOT NULL,
    address_line2 text,
    is_default boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_sales_customer_address; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_customer_address AS
 SELECT customer_address_id,
    customer_id,
    address_type,
    postal_code,
    country_code,
    prefecture,
    city,
    address_line1,
    address_line2,
    is_default,
    created_at
   FROM sales.customer_address;


--
-- Name: customer_contact; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.customer_contact (
    customer_contact_id bigint NOT NULL,
    customer_id bigint NOT NULL,
    contact_name text NOT NULL,
    department_name text,
    email text,
    phone text,
    mobile text,
    is_primary boolean DEFAULT false NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: v_sales_customer_contact; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_customer_contact AS
 SELECT customer_contact_id,
    customer_id,
    contact_name,
    department_name,
    email,
    phone,
    mobile,
    is_primary,
    is_active,
    created_at
   FROM sales.customer_contact;


--
-- Name: customer_payment_term; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.customer_payment_term (
    customer_payment_term_id bigint NOT NULL,
    customer_id bigint NOT NULL,
    payment_term_id bigint NOT NULL,
    payment_method_code text,
    valid_from date DEFAULT CURRENT_DATE NOT NULL,
    valid_to date,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: v_sales_customer_payment_term; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_customer_payment_term AS
 SELECT customer_payment_term_id,
    customer_id,
    payment_term_id,
    payment_method_code,
    valid_from,
    valid_to,
    is_active
   FROM sales.customer_payment_term;


--
-- Name: v_sales_invoice_pdf; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_invoice_pdf AS
 SELECT invoice_pdf_id,
    company_id,
    billing_id,
    file_path,
    created_at
   FROM sales.invoice_pdf;


--
-- Name: v_sales_item; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_item AS
 SELECT item_id,
    company_id,
    item_code,
    item_name,
    item_category_id,
    uom,
    is_active,
    created_at
   FROM sales.item;


--
-- Name: v_sales_item_category; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_item_category AS
 SELECT item_category_id,
    company_id,
    category_code,
    category_name,
    parent_category_id,
    category_level
   FROM sales.item_category;


--
-- Name: item_uom; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.item_uom (
    item_uom_id bigint NOT NULL,
    item_id bigint NOT NULL,
    uom_code text NOT NULL,
    usage_type text NOT NULL,
    is_primary boolean DEFAULT false NOT NULL
);


--
-- Name: v_sales_item_uom; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_item_uom AS
 SELECT item_uom_id,
    item_id,
    uom_code,
    usage_type,
    is_primary
   FROM sales.item_uom;


--
-- Name: v_sales_order_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_order_detail AS
 SELECT order_detail_id,
    order_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount,
    requested_ship_date
   FROM sales.order_detail;


--
-- Name: v_sales_return_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_return_detail AS
 SELECT return_detail_id,
    return_id,
    line_no,
    item_id,
    qty,
    reason_code
   FROM sales.return_detail;


--
-- Name: v_sales_sales_quotation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_sales_quotation AS
 SELECT sales_quotation_id,
    company_id,
    quotation_no,
    customer_id,
    quotation_date,
    status_code,
    created_by,
    created_at
   FROM sales.sales_quotation;


--
-- Name: v_sales_sales_quotation_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_sales_quotation_detail AS
 SELECT sales_quotation_detail_id,
    sales_quotation_id,
    line_no,
    item_id,
    qty,
    unit_price,
    amount,
    tax_category_code
   FROM sales.sales_quotation_detail;


--
-- Name: v_sales_shipping_detail; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sales_shipping_detail AS
 SELECT shipping_detail_id,
    shipping_id,
    order_detail_id,
    line_no,
    item_id,
    qty
   FROM sales.shipping_detail;


--
-- Name: warehouse; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.warehouse AS
 SELECT warehouse_id,
    company_id,
    warehouse_code,
    warehouse_name,
    is_active,
    created_at
   FROM inventory.warehouse;


--
-- Name: work_order; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.work_order AS
 SELECT work_order_id,
    company_id,
    wo_no,
    item_id,
    bom_id,
    routing_id,
    warehouse_id,
    plan_qty,
    plan_start_date,
    plan_end_date,
    status_code,
    created_at
   FROM manufacturing.work_order;


--
-- Name: yield_metric; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.yield_metric AS
 SELECT yield_metric_id,
    company_id,
    process_id,
    metric_date,
    yield_rate
   FROM manufacturing.yield_metric;


--
-- Name: purchase_invoice_detail_purchase_invoice_detail_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_invoice_detail_purchase_invoice_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_invoice_detail_purchase_invoice_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_invoice_detail_purchase_invoice_detail_id_seq OWNED BY purchase.purchase_invoice_detail.purchase_invoice_detail_id;


--
-- Name: purchase_invoice_purchase_invoice_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_invoice_purchase_invoice_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_invoice_purchase_invoice_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_invoice_purchase_invoice_id_seq OWNED BY purchase.purchase_invoice.purchase_invoice_id;


--
-- Name: purchase_order_detail_purchase_order_detail_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_order_detail_purchase_order_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_order_detail_purchase_order_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_order_detail_purchase_order_detail_id_seq OWNED BY purchase.purchase_order_detail.purchase_order_detail_id;


--
-- Name: purchase_order_header_purchase_order_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_order_header_purchase_order_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_order_header_purchase_order_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_order_header_purchase_order_id_seq OWNED BY purchase.purchase_order_header.purchase_order_id;


--
-- Name: purchase_quotation_detail_purchase_quotation_detail_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_quotation_detail_purchase_quotation_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_quotation_detail_purchase_quotation_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_quotation_detail_purchase_quotation_detail_id_seq OWNED BY purchase.purchase_quotation_detail.purchase_quotation_detail_id;


--
-- Name: purchase_quotation_purchase_quotation_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_quotation_purchase_quotation_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_quotation_purchase_quotation_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_quotation_purchase_quotation_id_seq OWNED BY purchase.purchase_quotation.purchase_quotation_id;


--
-- Name: purchase_receipt_detail_receipt_detail_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_receipt_detail_receipt_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_receipt_detail_receipt_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_receipt_detail_receipt_detail_id_seq OWNED BY purchase.purchase_receipt_detail.receipt_detail_id;


--
-- Name: purchase_receipt_receipt_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_receipt_receipt_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_receipt_receipt_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_receipt_receipt_id_seq OWNED BY purchase.purchase_receipt.receipt_id;


--
-- Name: purchase_requisition_detail_purchase_requisition_detail_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_requisition_detail_purchase_requisition_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_requisition_detail_purchase_requisition_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_requisition_detail_purchase_requisition_detail_id_seq OWNED BY purchase.purchase_requisition_detail.purchase_requisition_detail_id;


--
-- Name: purchase_requisition_purchase_requisition_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_requisition_purchase_requisition_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_requisition_purchase_requisition_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_requisition_purchase_requisition_id_seq OWNED BY purchase.purchase_requisition.purchase_requisition_id;


--
-- Name: purchase_three_way_match_purchase_three_way_match_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.purchase_three_way_match_purchase_three_way_match_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: purchase_three_way_match_purchase_three_way_match_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.purchase_three_way_match_purchase_three_way_match_id_seq OWNED BY purchase.purchase_three_way_match.purchase_three_way_match_id;


--
-- Name: supplier_address_supplier_address_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.supplier_address_supplier_address_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: supplier_address_supplier_address_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.supplier_address_supplier_address_id_seq OWNED BY purchase.supplier_address.supplier_address_id;


--
-- Name: supplier_contact_supplier_contact_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.supplier_contact_supplier_contact_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: supplier_contact_supplier_contact_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.supplier_contact_supplier_contact_id_seq OWNED BY purchase.supplier_contact.supplier_contact_id;


--
-- Name: supplier_item_price_supplier_item_price_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.supplier_item_price_supplier_item_price_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: supplier_item_price_supplier_item_price_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.supplier_item_price_supplier_item_price_id_seq OWNED BY purchase.supplier_item_price.supplier_item_price_id;


--
-- Name: supplier_master_supplier_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.supplier_master_supplier_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: supplier_master_supplier_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.supplier_master_supplier_id_seq OWNED BY purchase.supplier_master.supplier_id;


--
-- Name: supplier_payment_term_supplier_payment_term_id_seq; Type: SEQUENCE; Schema: purchase; Owner: -
--

CREATE SEQUENCE purchase.supplier_payment_term_supplier_payment_term_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: supplier_payment_term_supplier_payment_term_id_seq; Type: SEQUENCE OWNED BY; Schema: purchase; Owner: -
--

ALTER SEQUENCE purchase.supplier_payment_term_supplier_payment_term_id_seq OWNED BY purchase.supplier_payment_term.supplier_payment_term_id;


--
-- Name: v_change_history; Type: VIEW; Schema: purchase; Owner: -
--

CREATE VIEW purchase.v_change_history AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    action_category,
    detail,
    performed_by,
    performed_at
   FROM core.audit_trail
  WHERE (entity_type ~~ 'purchase.%'::text);


--
-- Name: messages; Type: TABLE; Schema: realtime; Owner: -
--

CREATE TABLE realtime.messages (
    topic text NOT NULL,
    extension text NOT NULL,
    payload jsonb,
    event text,
    private boolean DEFAULT false,
    updated_at timestamp without time zone DEFAULT now() NOT NULL,
    inserted_at timestamp without time zone DEFAULT now() NOT NULL,
    id uuid DEFAULT gen_random_uuid() NOT NULL
)
PARTITION BY RANGE (inserted_at);


--
-- Name: schema_migrations; Type: TABLE; Schema: realtime; Owner: -
--

CREATE TABLE realtime.schema_migrations (
    version bigint NOT NULL,
    inserted_at timestamp(0) without time zone
);


--
-- Name: subscription; Type: TABLE; Schema: realtime; Owner: -
--

CREATE TABLE realtime.subscription (
    id bigint NOT NULL,
    subscription_id uuid NOT NULL,
    entity regclass NOT NULL,
    filters realtime.user_defined_filter[] DEFAULT '{}'::realtime.user_defined_filter[] NOT NULL,
    claims jsonb NOT NULL,
    claims_role regrole GENERATED ALWAYS AS (realtime.to_regrole((claims ->> 'role'::text))) STORED NOT NULL,
    created_at timestamp without time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);


--
-- Name: subscription_id_seq; Type: SEQUENCE; Schema: realtime; Owner: -
--

ALTER TABLE realtime.subscription ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (
    SEQUENCE NAME realtime.subscription_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: billing_detail_billing_detail_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.billing_detail_billing_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: billing_detail_billing_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.billing_detail_billing_detail_id_seq OWNED BY sales.billing_detail.billing_detail_id;


--
-- Name: billing_header_billing_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.billing_header_billing_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: billing_header_billing_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.billing_header_billing_id_seq OWNED BY sales.billing_header.billing_id;


--
-- Name: customer_address_customer_address_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.customer_address_customer_address_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: customer_address_customer_address_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.customer_address_customer_address_id_seq OWNED BY sales.customer_address.customer_address_id;


--
-- Name: customer_contact_customer_contact_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.customer_contact_customer_contact_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: customer_contact_customer_contact_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.customer_contact_customer_contact_id_seq OWNED BY sales.customer_contact.customer_contact_id;


--
-- Name: customer_customer_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.customer_customer_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: customer_customer_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.customer_customer_id_seq OWNED BY sales.customer.customer_id;


--
-- Name: customer_payment_term_customer_payment_term_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.customer_payment_term_customer_payment_term_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: customer_payment_term_customer_payment_term_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.customer_payment_term_customer_payment_term_id_seq OWNED BY sales.customer_payment_term.customer_payment_term_id;


--
-- Name: invoice_pdf_invoice_pdf_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.invoice_pdf_invoice_pdf_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: invoice_pdf_invoice_pdf_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.invoice_pdf_invoice_pdf_id_seq OWNED BY sales.invoice_pdf.invoice_pdf_id;


--
-- Name: item_category_item_category_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.item_category_item_category_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: item_category_item_category_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.item_category_item_category_id_seq OWNED BY sales.item_category.item_category_id;


--
-- Name: item_item_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.item_item_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: item_item_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.item_item_id_seq OWNED BY sales.item.item_id;


--
-- Name: item_price_master_item_price_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.item_price_master_item_price_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: item_price_master_item_price_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.item_price_master_item_price_id_seq OWNED BY sales.item_price_master.item_price_id;


--
-- Name: item_uom_item_uom_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.item_uom_item_uom_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: item_uom_item_uom_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.item_uom_item_uom_id_seq OWNED BY sales.item_uom.item_uom_id;


--
-- Name: order_detail_order_detail_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.order_detail_order_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: order_detail_order_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.order_detail_order_detail_id_seq OWNED BY sales.order_detail.order_detail_id;


--
-- Name: order_header_order_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.order_header_order_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: order_header_order_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.order_header_order_id_seq OWNED BY sales.order_header.order_id;


--
-- Name: quotation_order_link; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.quotation_order_link (
    quotation_order_link_id bigint NOT NULL,
    company_id uuid NOT NULL,
    quotation_id bigint NOT NULL,
    order_id bigint NOT NULL,
    converted_by uuid,
    converted_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: quotation_order_link_quotation_order_link_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.quotation_order_link_quotation_order_link_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: quotation_order_link_quotation_order_link_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.quotation_order_link_quotation_order_link_id_seq OWNED BY sales.quotation_order_link.quotation_order_link_id;


--
-- Name: return_detail_return_detail_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.return_detail_return_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: return_detail_return_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.return_detail_return_detail_id_seq OWNED BY sales.return_detail.return_detail_id;


--
-- Name: return_header_return_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.return_header_return_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: return_header_return_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.return_header_return_id_seq OWNED BY sales.return_header.return_id;


--
-- Name: sales_quotation_detail_sales_quotation_detail_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.sales_quotation_detail_sales_quotation_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: sales_quotation_detail_sales_quotation_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.sales_quotation_detail_sales_quotation_detail_id_seq OWNED BY sales.sales_quotation_detail.sales_quotation_detail_id;


--
-- Name: sales_quotation_sales_quotation_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.sales_quotation_sales_quotation_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: sales_quotation_sales_quotation_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.sales_quotation_sales_quotation_id_seq OWNED BY sales.sales_quotation.sales_quotation_id;


--
-- Name: shipping_detail_shipping_detail_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.shipping_detail_shipping_detail_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: shipping_detail_shipping_detail_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.shipping_detail_shipping_detail_id_seq OWNED BY sales.shipping_detail.shipping_detail_id;


--
-- Name: shipping_header_shipping_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.shipping_header_shipping_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: shipping_header_shipping_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.shipping_header_shipping_id_seq OWNED BY sales.shipping_header.shipping_id;


--
-- Name: shipping_revision; Type: TABLE; Schema: sales; Owner: -
--

CREATE TABLE sales.shipping_revision (
    shipping_revision_id bigint NOT NULL,
    company_id uuid NOT NULL,
    shipping_id bigint NOT NULL,
    revision_no integer NOT NULL,
    before_qty numeric NOT NULL,
    after_qty numeric NOT NULL,
    before_unit_price numeric NOT NULL,
    after_unit_price numeric NOT NULL,
    reason text NOT NULL,
    revised_by uuid,
    revised_at timestamp with time zone DEFAULT now() NOT NULL,
    approved_by uuid,
    approved_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: shipping_revision_shipping_revision_id_seq; Type: SEQUENCE; Schema: sales; Owner: -
--

CREATE SEQUENCE sales.shipping_revision_shipping_revision_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: shipping_revision_shipping_revision_id_seq; Type: SEQUENCE OWNED BY; Schema: sales; Owner: -
--

ALTER SEQUENCE sales.shipping_revision_shipping_revision_id_seq OWNED BY sales.shipping_revision.shipping_revision_id;


--
-- Name: v_change_history; Type: VIEW; Schema: sales; Owner: -
--

CREATE VIEW sales.v_change_history AS
 SELECT audit_trail_id,
    company_id,
    entity_type,
    entity_id,
    action,
    action_category,
    detail,
    performed_by,
    performed_at
   FROM core.audit_trail
  WHERE (entity_type ~~ 'sales.%'::text);


--
-- Name: v_order_header_read; Type: VIEW; Schema: sales; Owner: -
--

CREATE VIEW sales.v_order_header_read WITH (security_barrier='true') AS
 SELECT order_id,
    company_id,
    order_no,
    customer_id,
    order_date,
    status_code,
    remarks,
    created_by,
    created_at
   FROM sales.order_header oh
  WHERE (company_id = public.my_company_id());


--
-- Name: buckets; Type: TABLE; Schema: storage; Owner: -
--

CREATE TABLE storage.buckets (
    id text NOT NULL,
    name text NOT NULL,
    owner uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    public boolean DEFAULT false,
    avif_autodetection boolean DEFAULT false,
    file_size_limit bigint,
    allowed_mime_types text[],
    owner_id text,
    type storage.buckettype DEFAULT 'STANDARD'::storage.buckettype NOT NULL
);


--
-- Name: COLUMN buckets.owner; Type: COMMENT; Schema: storage; Owner: -
--

COMMENT ON COLUMN storage.buckets.owner IS 'Field is deprecated, use owner_id instead';


--
-- Name: buckets_analytics; Type: TABLE; Schema: storage; Owner: -
--

CREATE TABLE storage.buckets_analytics (
    name text NOT NULL,
    type storage.buckettype DEFAULT 'ANALYTICS'::storage.buckettype NOT NULL,
    format text DEFAULT 'ICEBERG'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: buckets_vectors; Type: TABLE; Schema: storage; Owner: -
--

CREATE TABLE storage.buckets_vectors (
    id text NOT NULL,
    type storage.buckettype DEFAULT 'VECTOR'::storage.buckettype NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: migrations; Type: TABLE; Schema: storage; Owner: -
--

CREATE TABLE storage.migrations (
    id integer NOT NULL,
    name character varying(100) NOT NULL,
    hash character varying(40) NOT NULL,
    executed_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: objects; Type: TABLE; Schema: storage; Owner: -
--

CREATE TABLE storage.objects (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    bucket_id text,
    name text,
    owner uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    last_accessed_at timestamp with time zone DEFAULT now(),
    metadata jsonb,
    path_tokens text[] GENERATED ALWAYS AS (string_to_array(name, '/'::text)) STORED,
    version text,
    owner_id text,
    user_metadata jsonb,
    level integer
);


--
-- Name: COLUMN objects.owner; Type: COMMENT; Schema: storage; Owner: -
--

COMMENT ON COLUMN storage.objects.owner IS 'Field is deprecated, use owner_id instead';


--
-- Name: prefixes; Type: TABLE; Schema: storage; Owner: -
--

CREATE TABLE storage.prefixes (
    bucket_id text NOT NULL,
    name text NOT NULL COLLATE pg_catalog."C",
    level integer GENERATED ALWAYS AS (storage.get_level(name)) STORED NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: s3_multipart_uploads; Type: TABLE; Schema: storage; Owner: -
--

CREATE TABLE storage.s3_multipart_uploads (
    id text NOT NULL,
    in_progress_size bigint DEFAULT 0 NOT NULL,
    upload_signature text NOT NULL,
    bucket_id text NOT NULL,
    key text NOT NULL COLLATE pg_catalog."C",
    version text NOT NULL,
    owner_id text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    user_metadata jsonb
);


--
-- Name: s3_multipart_uploads_parts; Type: TABLE; Schema: storage; Owner: -
--

CREATE TABLE storage.s3_multipart_uploads_parts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    upload_id text NOT NULL,
    size bigint DEFAULT 0 NOT NULL,
    part_number integer NOT NULL,
    bucket_id text NOT NULL,
    key text NOT NULL COLLATE pg_catalog."C",
    etag text NOT NULL,
    owner_id text,
    version text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: vector_indexes; Type: TABLE; Schema: storage; Owner: -
--

CREATE TABLE storage.vector_indexes (
    id text DEFAULT gen_random_uuid() NOT NULL,
    name text NOT NULL COLLATE pg_catalog."C",
    bucket_id text NOT NULL,
    data_type text NOT NULL,
    dimension integer NOT NULL,
    distance_metric text NOT NULL,
    metadata_configuration jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: action_approval_map; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.action_approval_map (
    action_code text NOT NULL,
    function_code text NOT NULL,
    approval_flow_code text NOT NULL
);


--
-- Name: ai_agent; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.ai_agent (
    agent_code text NOT NULL,
    agent_name text NOT NULL,
    agent_role text DEFAULT 'GENERAL'::text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: ai_signal; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.ai_signal (
    signal_id bigint NOT NULL,
    signal_type text NOT NULL,
    payload jsonb DEFAULT '{}'::jsonb NOT NULL,
    status text DEFAULT 'PENDING'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT ai_signal_status_check CHECK ((status = ANY (ARRAY['PENDING'::text, 'DONE'::text, 'FAILED'::text])))
);


--
-- Name: ai_signal_signal_id_seq; Type: SEQUENCE; Schema: system; Owner: -
--

CREATE SEQUENCE system.ai_signal_signal_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: ai_signal_signal_id_seq; Type: SEQUENCE OWNED BY; Schema: system; Owner: -
--

ALTER SEQUENCE system.ai_signal_signal_id_seq OWNED BY system.ai_signal.signal_id;


--
-- Name: ai_task; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.ai_task (
    task_id bigint NOT NULL,
    agent_code text NOT NULL,
    task_type text NOT NULL,
    input_json jsonb DEFAULT '{}'::jsonb NOT NULL,
    priority integer DEFAULT 100 NOT NULL,
    status text DEFAULT 'PENDING'::text NOT NULL,
    requested_by uuid,
    requested_at timestamp with time zone DEFAULT now() NOT NULL,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    result_json jsonb,
    error_text text,
    CONSTRAINT ai_task_status_check CHECK ((status = ANY (ARRAY['PENDING'::text, 'RUNNING'::text, 'DONE'::text, 'FAILED'::text, 'CANCELLED'::text])))
);


--
-- Name: ai_task_run; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.ai_task_run (
    run_id bigint NOT NULL,
    task_id bigint NOT NULL,
    run_status text NOT NULL,
    note text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT ai_task_run_run_status_check CHECK ((run_status = ANY (ARRAY['START'::text, 'DONE'::text, 'FAIL'::text])))
);


--
-- Name: ai_task_run_run_id_seq; Type: SEQUENCE; Schema: system; Owner: -
--

CREATE SEQUENCE system.ai_task_run_run_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: ai_task_run_run_id_seq; Type: SEQUENCE OWNED BY; Schema: system; Owner: -
--

ALTER SEQUENCE system.ai_task_run_run_id_seq OWNED BY system.ai_task_run.run_id;


--
-- Name: ai_task_task_id_seq; Type: SEQUENCE; Schema: system; Owner: -
--

CREATE SEQUENCE system.ai_task_task_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: ai_task_task_id_seq; Type: SEQUENCE OWNED BY; Schema: system; Owner: -
--

ALTER SEQUENCE system.ai_task_task_id_seq OWNED BY system.ai_task.task_id;


--
-- Name: approval_action_log; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.approval_action_log (
    approval_action_id bigint NOT NULL,
    approval_request_id bigint,
    step_no integer NOT NULL,
    action text NOT NULL,
    action_by uuid,
    action_at timestamp with time zone DEFAULT now() NOT NULL,
    comment text,
    CONSTRAINT approval_action_log_action_check CHECK ((action = ANY (ARRAY['APPROVE'::text, 'REJECT'::text, 'RETURN'::text])))
);


--
-- Name: approval_action_log_approval_action_id_seq; Type: SEQUENCE; Schema: system; Owner: -
--

CREATE SEQUENCE system.approval_action_log_approval_action_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: approval_action_log_approval_action_id_seq; Type: SEQUENCE OWNED BY; Schema: system; Owner: -
--

ALTER SEQUENCE system.approval_action_log_approval_action_id_seq OWNED BY system.approval_action_log.approval_action_id;


--
-- Name: approval_exec_map; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.approval_exec_map (
    approval_flow_code text NOT NULL,
    command_code text NOT NULL,
    worker_tag text
);


--
-- Name: approval_finalize_rule; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.approval_finalize_rule (
    function_code text NOT NULL,
    finalize_status text NOT NULL
);


--
-- Name: approval_flow_def; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.approval_flow_def (
    approval_flow_code text NOT NULL,
    module_code text NOT NULL,
    function_code text NOT NULL,
    flow_name text NOT NULL,
    allow_direct boolean DEFAULT false NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: approval_request; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.approval_request (
    approval_request_id bigint NOT NULL,
    approval_flow_code text NOT NULL,
    function_code text NOT NULL,
    business_table text NOT NULL,
    business_id bigint NOT NULL,
    current_step integer DEFAULT 1 NOT NULL,
    approval_status text NOT NULL,
    requested_by uuid,
    requested_at timestamp with time zone DEFAULT now() NOT NULL,
    approved_at timestamp with time zone,
    CONSTRAINT approval_request_approval_status_check CHECK ((approval_status = ANY (ARRAY['REQUESTED'::text, 'APPROVED'::text, 'REJECTED'::text])))
);


--
-- Name: approval_request_approval_request_id_seq; Type: SEQUENCE; Schema: system; Owner: -
--

CREATE SEQUENCE system.approval_request_approval_request_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: approval_request_approval_request_id_seq; Type: SEQUENCE OWNED BY; Schema: system; Owner: -
--

ALTER SEQUENCE system.approval_request_approval_request_id_seq OWNED BY system.approval_request.approval_request_id;


--
-- Name: approval_step_def; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.approval_step_def (
    approval_flow_code text NOT NULL,
    step_no integer NOT NULL,
    step_name text NOT NULL
);


--
-- Name: business_finalize_event; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.business_finalize_event (
    function_code text NOT NULL,
    requires_approval boolean NOT NULL,
    generates_document boolean NOT NULL,
    sends_document boolean NOT NULL
);


--
-- Name: business_ops_map; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.business_ops_map (
    function_code text NOT NULL,
    document_type_code text NOT NULL,
    generate_pdf boolean DEFAULT true NOT NULL,
    auto_send boolean DEFAULT true NOT NULL
);


--
-- Name: db_session; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.db_session (
    session_id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    started_at timestamp with time zone DEFAULT now() NOT NULL,
    ended_at timestamp with time zone,
    client_info text,
    started_by uuid,
    ended_by uuid
);


--
-- Name: exec_command; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.exec_command (
    command_code text NOT NULL,
    description text DEFAULT ''::text NOT NULL,
    command_text text NOT NULL,
    run_as text DEFAULT 'termux'::text NOT NULL,
    requires_approval boolean DEFAULT true NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    command_kind text DEFAULT 'SHELL'::text NOT NULL,
    template_vars jsonb DEFAULT '{}'::jsonb NOT NULL,
    CONSTRAINT exec_command_command_kind_check CHECK ((command_kind = ANY (ARRAY['SHELL'::text, 'SQL'::text, 'PYTHON'::text, 'HTTP'::text, 'INTERNAL'::text])))
);


--
-- Name: exec_run_request; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.exec_run_request (
    request_id bigint NOT NULL,
    command_code text NOT NULL,
    args_json jsonb DEFAULT '{}'::jsonb NOT NULL,
    priority integer DEFAULT 100 NOT NULL,
    status text DEFAULT 'PENDING'::text NOT NULL,
    requested_by uuid,
    requested_at timestamp with time zone DEFAULT now() NOT NULL,
    picked_by uuid,
    picked_at timestamp with time zone,
    completed_at timestamp with time zone,
    exit_code integer,
    stdout_text text,
    stderr_text text,
    rendered_command text,
    worker_tag text,
    CONSTRAINT exec_run_request_status_check CHECK ((status = ANY (ARRAY['PENDING'::text, 'RUNNING'::text, 'DONE'::text, 'FAILED'::text, 'CANCELLED'::text])))
);


--
-- Name: exec_run_request_request_id_seq; Type: SEQUENCE; Schema: system; Owner: -
--

CREATE SEQUENCE system.exec_run_request_request_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: exec_run_request_request_id_seq; Type: SEQUENCE OWNED BY; Schema: system; Owner: -
--

ALTER SEQUENCE system.exec_run_request_request_id_seq OWNED BY system.exec_run_request.request_id;


--
-- Name: function_def; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.function_def (
    function_code text NOT NULL,
    module_code text NOT NULL,
    function_name text NOT NULL,
    requires_approval boolean DEFAULT true NOT NULL,
    allow_direct boolean DEFAULT false NOT NULL
);


--
-- Name: loop_autotune_rule; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.loop_autotune_rule (
    rule_id bigint NOT NULL,
    loop_code text NOT NULL,
    fail_ratio_threshold numeric DEFAULT 0.20 NOT NULL,
    interval_min_sec integer DEFAULT 10 NOT NULL,
    interval_max_sec integer DEFAULT 600 NOT NULL,
    step_up_sec integer DEFAULT 10 NOT NULL,
    step_down_sec integer DEFAULT 5 NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: loop_autotune_rule_rule_id_seq; Type: SEQUENCE; Schema: system; Owner: -
--

CREATE SEQUENCE system.loop_autotune_rule_rule_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: loop_autotune_rule_rule_id_seq; Type: SEQUENCE OWNED BY; Schema: system; Owner: -
--

ALTER SEQUENCE system.loop_autotune_rule_rule_id_seq OWNED BY system.loop_autotune_rule.rule_id;


--
-- Name: loop_config; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.loop_config (
    loop_code text NOT NULL,
    command_code text NOT NULL,
    interval_sec integer DEFAULT 60 NOT NULL,
    is_enabled boolean DEFAULT true NOT NULL,
    jitter_sec integer DEFAULT 0 NOT NULL,
    last_run_at timestamp with time zone,
    next_run_at timestamp with time zone,
    note text,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: loop_sla_stat; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.loop_sla_stat (
    stat_id bigint NOT NULL,
    loop_code text NOT NULL,
    window_start timestamp with time zone NOT NULL,
    window_end timestamp with time zone NOT NULL,
    tick_count integer NOT NULL,
    fail_count integer NOT NULL,
    computed_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: loop_sla_stat_stat_id_seq; Type: SEQUENCE; Schema: system; Owner: -
--

CREATE SEQUENCE system.loop_sla_stat_stat_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: loop_sla_stat_stat_id_seq; Type: SEQUENCE OWNED BY; Schema: system; Owner: -
--

ALTER SEQUENCE system.loop_sla_stat_stat_id_seq OWNED BY system.loop_sla_stat.stat_id;


--
-- Name: loop_tick_log; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.loop_tick_log (
    tick_id bigint NOT NULL,
    loop_code text NOT NULL,
    tick_status text NOT NULL,
    note text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT loop_tick_log_tick_status_check CHECK ((tick_status = ANY (ARRAY['START'::text, 'DONE'::text, 'SKIP'::text, 'FAIL'::text])))
);


--
-- Name: loop_tick_log_tick_id_seq; Type: SEQUENCE; Schema: system; Owner: -
--

CREATE SEQUENCE system.loop_tick_log_tick_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: loop_tick_log_tick_id_seq; Type: SEQUENCE OWNED BY; Schema: system; Owner: -
--

ALTER SEQUENCE system.loop_tick_log_tick_id_seq OWNED BY system.loop_tick_log.tick_id;


--
-- Name: module_def; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.module_def (
    module_code text NOT NULL,
    module_name text NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: notification_endpoint; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.notification_endpoint (
    endpoint_code text NOT NULL,
    channel_type text NOT NULL,
    destination text NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT notification_endpoint_channel_type_check CHECK ((channel_type = ANY (ARRAY['WEBHOOK'::text, 'SLACK'::text, 'LINE'::text])))
);


--
-- Name: notification_subscription; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.notification_subscription (
    event_type text NOT NULL,
    endpoint_code text NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: operation_log; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.operation_log (
    operation_log_id bigint NOT NULL,
    session_id uuid,
    role_code text,
    module_code text NOT NULL,
    function_code text NOT NULL,
    screen_code text,
    operation_type text NOT NULL,
    target_table text,
    target_id text,
    operation_status text NOT NULL,
    operated_by uuid,
    operated_at timestamp with time zone DEFAULT now() NOT NULL,
    error_message text,
    CONSTRAINT operation_log_operation_status_check CHECK ((operation_status = ANY (ARRAY['SUCCESS'::text, 'FAILED'::text])))
);


--
-- Name: operation_log_operation_log_id_seq; Type: SEQUENCE; Schema: system; Owner: -
--

CREATE SEQUENCE system.operation_log_operation_log_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: operation_log_operation_log_id_seq; Type: SEQUENCE OWNED BY; Schema: system; Owner: -
--

ALTER SEQUENCE system.operation_log_operation_log_id_seq OWNED BY system.operation_log.operation_log_id;


--
-- Name: operation_type_def; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.operation_type_def (
    operation_type text NOT NULL,
    operation_name text NOT NULL
);


--
-- Name: role_def; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.role_def (
    role_code text NOT NULL,
    role_name text NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: role_screen_permission; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.role_screen_permission (
    role_code text NOT NULL,
    screen_code text NOT NULL,
    can_view boolean DEFAULT false NOT NULL,
    can_edit boolean DEFAULT false NOT NULL,
    can_approve boolean DEFAULT false NOT NULL,
    can_final boolean DEFAULT false NOT NULL
);


--
-- Name: runtime_killswitch; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.runtime_killswitch (
    key text NOT NULL,
    is_enabled boolean DEFAULT false NOT NULL,
    reason text,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: screen_action_map; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.screen_action_map (
    screen_code text NOT NULL,
    action_code text NOT NULL,
    target_table text NOT NULL,
    requires_confirmation boolean DEFAULT true NOT NULL,
    requires_approval boolean DEFAULT true NOT NULL
);


--
-- Name: screen_master; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.screen_master (
    screen_code text NOT NULL,
    module_code text NOT NULL,
    function_code text NOT NULL,
    screen_name text NOT NULL,
    screen_type text NOT NULL,
    sort_order integer NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: screen_rule; Type: TABLE; Schema: system; Owner: -
--

CREATE TABLE system.screen_rule (
    screen_type text NOT NULL,
    sort_order integer NOT NULL
);


--
-- Name: v_business_ops_pipeline; Type: VIEW; Schema: system; Owner: -
--

CREATE VIEW system.v_business_ops_pipeline AS
 SELECT b.function_code,
    b.generates_document,
    b.sends_document,
    o.document_type_code,
    o.generate_pdf,
    o.auto_send
   FROM (system.business_finalize_event b
     LEFT JOIN system.business_ops_map o ON ((b.function_code = o.function_code)));


--
-- Name: v_business_ops_ready; Type: VIEW; Schema: system; Owner: -
--

CREATE VIEW system.v_business_ops_ready AS
 SELECT b.function_code,
    b.document_type_code,
    d.document_type_name,
    b.generate_pdf,
    b.auto_send
   FROM (system.business_ops_map b
     JOIN ops.document_type_master d ON ((d.document_type_code = b.document_type_code)));


--
-- Name: v_exec_commands; Type: VIEW; Schema: system; Owner: -
--

CREATE VIEW system.v_exec_commands AS
 SELECT command_code,
    description,
    run_as,
    requires_approval,
    is_active,
    updated_at
   FROM system.exec_command c;


--
-- Name: v_exec_run_recent; Type: VIEW; Schema: system; Owner: -
--

CREATE VIEW system.v_exec_run_recent AS
 SELECT request_id,
    command_code,
    status,
    priority,
    requested_at,
    picked_at,
    completed_at,
    exit_code,
    "left"(COALESCE(stdout_text, ''::text), 200) AS stdout_head,
    "left"(COALESCE(stderr_text, ''::text), 200) AS stderr_head
   FROM system.exec_run_request r
  ORDER BY requested_at DESC;


--
-- Name: v_loop_configs; Type: VIEW; Schema: system; Owner: -
--

CREATE VIEW system.v_loop_configs AS
 SELECT loop_code,
    command_code,
    interval_sec,
    jitter_sec,
    is_enabled,
    last_run_at,
    next_run_at,
    updated_at
   FROM system.loop_config lc;


--
-- Name: v_operation_log_audit; Type: VIEW; Schema: system; Owner: -
--

CREATE VIEW system.v_operation_log_audit AS
 SELECT o.operated_at,
    r.role_name,
    o.module_code,
    o.function_code,
    s.screen_name,
    o.operation_type,
    o.target_table,
    o.target_id,
    o.operation_status,
    o.error_message,
    o.operated_by
   FROM ((system.operation_log o
     LEFT JOIN system.role_def r ON ((r.role_code = o.role_code)))
     LEFT JOIN system.screen_master s ON ((s.screen_code = o.screen_code)))
  ORDER BY o.operated_at DESC;


--
-- Name: company_license; Type: TABLE; Schema: tenant; Owner: -
--

CREATE TABLE tenant.company_license (
    company_id uuid NOT NULL,
    license_code text NOT NULL,
    is_enabled boolean DEFAULT true NOT NULL,
    granted_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: license_master; Type: TABLE; Schema: tenant; Owner: -
--

CREATE TABLE tenant.license_master (
    license_code text NOT NULL,
    description text NOT NULL,
    is_active boolean DEFAULT true NOT NULL
);


--
-- Name: audit_trail_2025_12; Type: TABLE ATTACH; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail ATTACH PARTITION core.audit_trail_2025_12 FOR VALUES FROM ('2025-12-01 00:00:00+00') TO ('2026-01-01 00:00:00+00');


--
-- Name: audit_trail_2026_01; Type: TABLE ATTACH; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail ATTACH PARTITION core.audit_trail_2026_01 FOR VALUES FROM ('2026-01-01 00:00:00+00') TO ('2026-02-01 00:00:00+00');


--
-- Name: audit_trail_2026_02; Type: TABLE ATTACH; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail ATTACH PARTITION core.audit_trail_2026_02 FOR VALUES FROM ('2026-02-01 00:00:00+00') TO ('2026-03-01 00:00:00+00');


--
-- Name: audit_trail_2026_03; Type: TABLE ATTACH; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail ATTACH PARTITION core.audit_trail_2026_03 FOR VALUES FROM ('2026-03-01 00:00:00+00') TO ('2026-04-01 00:00:00+00');


--
-- Name: audit_trail_2026_04; Type: TABLE ATTACH; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail ATTACH PARTITION core.audit_trail_2026_04 FOR VALUES FROM ('2026-04-01 00:00:00+00') TO ('2026-05-01 00:00:00+00');


--
-- Name: audit_trail_2026_05; Type: TABLE ATTACH; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail ATTACH PARTITION core.audit_trail_2026_05 FOR VALUES FROM ('2026-05-01 00:00:00+00') TO ('2026-06-01 00:00:00+00');


--
-- Name: audit_trail_2026_06; Type: TABLE ATTACH; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail ATTACH PARTITION core.audit_trail_2026_06 FOR VALUES FROM ('2026-06-01 00:00:00+00') TO ('2026-07-01 00:00:00+00');


--
-- Name: audit_trail_2026_07; Type: TABLE ATTACH; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail ATTACH PARTITION core.audit_trail_2026_07 FOR VALUES FROM ('2026-07-01 00:00:00+00') TO ('2026-08-01 00:00:00+00');


--
-- Name: paper_send_fee_journal journal_id; Type: DEFAULT; Schema: accounting; Owner: -
--

ALTER TABLE ONLY accounting.paper_send_fee_journal ALTER COLUMN journal_id SET DEFAULT nextval('accounting.paper_send_fee_journal_journal_id_seq'::regclass);


--
-- Name: ai_event ai_event_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.ai_event ALTER COLUMN ai_event_id SET DEFAULT nextval('analytics.ai_event_ai_event_id_seq'::regclass);


--
-- Name: ai_job ai_job_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.ai_job ALTER COLUMN ai_job_id SET DEFAULT nextval('analytics.ai_job_ai_job_id_seq'::regclass);


--
-- Name: audit_ai_feedback feedback_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_feedback ALTER COLUMN feedback_id SET DEFAULT nextval('analytics.audit_ai_feedback_feedback_id_seq'::regclass);


--
-- Name: audit_ai_job job_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_job ALTER COLUMN job_id SET DEFAULT nextval('analytics.audit_ai_job_job_id_seq'::regclass);


--
-- Name: audit_ai_llm_result llm_result_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_llm_result ALTER COLUMN llm_result_id SET DEFAULT nextval('analytics.audit_ai_llm_result_llm_result_id_seq'::regclass);


--
-- Name: audit_alert_ai_judgement judgement_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_ai_judgement ALTER COLUMN judgement_id SET DEFAULT nextval('analytics.audit_alert_ai_judgement_judgement_id_seq'::regclass);


--
-- Name: audit_alert_event alert_event_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_event ALTER COLUMN alert_event_id SET DEFAULT nextval('analytics.audit_alert_event_alert_event_id_seq'::regclass);


--
-- Name: audit_alert_notification notification_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_notification ALTER COLUMN notification_id SET DEFAULT nextval('analytics.audit_alert_notification_notification_id_seq'::regclass);


--
-- Name: audit_alert_rule rule_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_rule ALTER COLUMN rule_id SET DEFAULT nextval('analytics.audit_alert_rule_rule_id_seq'::regclass);


--
-- Name: fact_metric fact_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.fact_metric ALTER COLUMN fact_id SET DEFAULT nextval('analytics.fact_metric_fact_id_seq'::regclass);


--
-- Name: notification_queue notification_id; Type: DEFAULT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.notification_queue ALTER COLUMN notification_id SET DEFAULT nextval('analytics.notification_queue_notification_id_seq'::regclass);


--
-- Name: audit_event audit_event_id; Type: DEFAULT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.audit_event ALTER COLUMN audit_event_id SET DEFAULT nextval('audit.audit_event_audit_event_id_seq'::regclass);


--
-- Name: audit_trail_db audit_trail_db_id; Type: DEFAULT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.audit_trail_db ALTER COLUMN audit_trail_db_id SET DEFAULT nextval('audit.audit_trail_db_audit_trail_db_id_seq'::regclass);


--
-- Name: entity_status_history status_history_id; Type: DEFAULT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.entity_status_history ALTER COLUMN status_history_id SET DEFAULT nextval('audit.entity_status_history_status_history_id_seq'::regclass);


--
-- Name: exec_audit_event audit_event_id; Type: DEFAULT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.exec_audit_event ALTER COLUMN audit_event_id SET DEFAULT nextval('audit.exec_audit_event_audit_event_id_seq'::regclass);


--
-- Name: ng_event ng_event_id; Type: DEFAULT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.ng_event ALTER COLUMN ng_event_id SET DEFAULT nextval('audit.ng_event_ng_event_id_seq'::regclass);


--
-- Name: ops_audit_log audit_id; Type: DEFAULT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.ops_audit_log ALTER COLUMN audit_id SET DEFAULT nextval('audit.ops_audit_log_audit_id_seq'::regclass);


--
-- Name: refresh_tokens id; Type: DEFAULT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.refresh_tokens ALTER COLUMN id SET DEFAULT nextval('auth.refresh_tokens_id_seq'::regclass);


--
-- Name: audit_action audit_action_id; Type: DEFAULT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_action ALTER COLUMN audit_action_id SET DEFAULT nextval('compliance.audit_action_audit_action_id_seq'::regclass);


--
-- Name: audit_event audit_event_id; Type: DEFAULT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_event ALTER COLUMN audit_event_id SET DEFAULT nextval('compliance.audit_event_audit_event_id_seq'::regclass);


--
-- Name: audit_issue audit_issue_id; Type: DEFAULT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_issue ALTER COLUMN audit_issue_id SET DEFAULT nextval('compliance.audit_issue_audit_issue_id_seq'::regclass);


--
-- Name: iso_clause iso_clause_id; Type: DEFAULT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.iso_clause ALTER COLUMN iso_clause_id SET DEFAULT nextval('compliance.iso_clause_iso_clause_id_seq'::regclass);


--
-- Name: iso_standard iso_standard_id; Type: DEFAULT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.iso_standard ALTER COLUMN iso_standard_id SET DEFAULT nextval('compliance.iso_standard_iso_standard_id_seq'::regclass);


--
-- Name: accounting_period period_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.accounting_period ALTER COLUMN period_id SET DEFAULT nextval('core.accounting_period_period_id_seq'::regclass);


--
-- Name: accounts account_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.accounts ALTER COLUMN account_id SET DEFAULT nextval('core.accounts_account_id_seq'::regclass);


--
-- Name: audit_column_weight column_weight_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_column_weight ALTER COLUMN column_weight_id SET DEFAULT nextval('core.audit_column_weight_column_weight_id_seq'::regclass);


--
-- Name: audit_impact_rule rule_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_impact_rule ALTER COLUMN rule_id SET DEFAULT nextval('core.audit_impact_rule_rule_id_seq'::regclass);


--
-- Name: audit_trail audit_trail_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail ALTER COLUMN audit_trail_id SET DEFAULT nextval('core.audit_trail_audit_trail_id_seq'::regclass);


--
-- Name: company_license company_license_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_license ALTER COLUMN company_license_id SET DEFAULT nextval('core.company_license_company_license_id_seq'::regclass);


--
-- Name: company_permission company_permission_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_permission ALTER COLUMN company_permission_id SET DEFAULT nextval('core.company_permission_company_permission_id_seq'::regclass);


--
-- Name: company_users company_user_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_users ALTER COLUMN company_user_id SET DEFAULT nextval('core.company_users_company_user_id_seq'::regclass);


--
-- Name: document_sequence sequence_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.document_sequence ALTER COLUMN sequence_id SET DEFAULT nextval('core.document_sequence_sequence_id_seq'::regclass);


--
-- Name: entity_attribute_def attribute_def_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.entity_attribute_def ALTER COLUMN attribute_def_id SET DEFAULT nextval('core.entity_attribute_def_attribute_def_id_seq'::regclass);


--
-- Name: entity_attribute_value attribute_value_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.entity_attribute_value ALTER COLUMN attribute_value_id SET DEFAULT nextval('core.entity_attribute_value_attribute_value_id_seq'::regclass);


--
-- Name: journal_entries journal_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_entries ALTER COLUMN journal_id SET DEFAULT nextval('core.journal_entries_journal_id_seq'::regclass);


--
-- Name: journal_lines journal_line_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_lines ALTER COLUMN journal_line_id SET DEFAULT nextval('core.journal_lines_journal_line_id_seq'::regclass);


--
-- Name: journal_source_link journal_source_link_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_source_link ALTER COLUMN journal_source_link_id SET DEFAULT nextval('core.journal_source_link_journal_source_link_id_seq'::regclass);


--
-- Name: login_history login_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.login_history ALTER COLUMN login_id SET DEFAULT nextval('core.login_history_login_id_seq'::regclass);


--
-- Name: payment_term payment_term_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.payment_term ALTER COLUMN payment_term_id SET DEFAULT nextval('core.payment_term_payment_term_id_seq'::regclass);


--
-- Name: permission_groups group_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.permission_groups ALTER COLUMN group_id SET DEFAULT nextval('core.permission_groups_group_id_seq'::regclass);


--
-- Name: permissions permission_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.permissions ALTER COLUMN permission_id SET DEFAULT nextval('core.permissions_permission_id_seq'::regclass);


--
-- Name: posting_profile posting_profile_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.posting_profile ALTER COLUMN posting_profile_id SET DEFAULT nextval('core.posting_profile_posting_profile_id_seq'::regclass);


--
-- Name: status_history status_history_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.status_history ALTER COLUMN status_history_id SET DEFAULT nextval('core.status_history_status_history_id_seq'::regclass);


--
-- Name: status_master status_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.status_master ALTER COLUMN status_id SET DEFAULT nextval('core.status_master_status_id_seq'::regclass);


--
-- Name: sync_queue sync_id; Type: DEFAULT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.sync_queue ALTER COLUMN sync_id SET DEFAULT nextval('core.sync_queue_sync_id_seq'::regclass);


--
-- Name: bank_account bank_account_id; Type: DEFAULT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_account ALTER COLUMN bank_account_id SET DEFAULT nextval('finance.bank_account_bank_account_id_seq'::regclass);


--
-- Name: bank_statement_header bank_statement_id; Type: DEFAULT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_statement_header ALTER COLUMN bank_statement_id SET DEFAULT nextval('finance.bank_statement_header_bank_statement_id_seq'::regclass);


--
-- Name: bank_statement_line bank_statement_line_id; Type: DEFAULT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_statement_line ALTER COLUMN bank_statement_line_id SET DEFAULT nextval('finance.bank_statement_line_bank_statement_line_id_seq'::regclass);


--
-- Name: payment payment_id; Type: DEFAULT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.payment ALTER COLUMN payment_id SET DEFAULT nextval('finance.payment_payment_id_seq'::regclass);


--
-- Name: payment_allocation payment_allocation_id; Type: DEFAULT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.payment_allocation ALTER COLUMN payment_allocation_id SET DEFAULT nextval('finance.payment_allocation_payment_allocation_id_seq'::regclass);


--
-- Name: business_rule business_rule_id; Type: DEFAULT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.business_rule ALTER COLUMN business_rule_id SET DEFAULT nextval('governance.business_rule_business_rule_id_seq'::regclass);


--
-- Name: business_rule_action rule_action_id; Type: DEFAULT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.business_rule_action ALTER COLUMN rule_action_id SET DEFAULT nextval('governance.business_rule_action_rule_action_id_seq'::regclass);


--
-- Name: business_rule_condition rule_condition_id; Type: DEFAULT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.business_rule_condition ALTER COLUMN rule_condition_id SET DEFAULT nextval('governance.business_rule_condition_rule_condition_id_seq'::regclass);


--
-- Name: contract_header contract_id; Type: DEFAULT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.contract_header ALTER COLUMN contract_id SET DEFAULT nextval('governance.contract_header_contract_id_seq'::regclass);


--
-- Name: contract_item_price contract_item_price_id; Type: DEFAULT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.contract_item_price ALTER COLUMN contract_item_price_id SET DEFAULT nextval('governance.contract_item_price_contract_item_price_id_seq'::regclass);


--
-- Name: document_archive document_archive_id; Type: DEFAULT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.document_archive ALTER COLUMN document_archive_id SET DEFAULT nextval('governance.document_archive_document_archive_id_seq'::regclass);


--
-- Name: document_category document_category_id; Type: DEFAULT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.document_category ALTER COLUMN document_category_id SET DEFAULT nextval('governance.document_category_document_category_id_seq'::regclass);


--
-- Name: policy_change_queue policy_change_id; Type: DEFAULT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.policy_change_queue ALTER COLUMN policy_change_id SET DEFAULT nextval('governance.policy_change_queue_policy_change_id_seq'::regclass);


--
-- Name: attendance_log attendance_log_id; Type: DEFAULT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.attendance_log ALTER COLUMN attendance_log_id SET DEFAULT nextval('hr.attendance_log_attendance_log_id_seq'::regclass);


--
-- Name: employee employee_id; Type: DEFAULT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.employee ALTER COLUMN employee_id SET DEFAULT nextval('hr.employee_employee_id_seq'::regclass);


--
-- Name: employment_contract employment_contract_id; Type: DEFAULT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.employment_contract ALTER COLUMN employment_contract_id SET DEFAULT nextval('hr.employment_contract_employment_contract_id_seq'::regclass);


--
-- Name: hr_department department_id; Type: DEFAULT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.hr_department ALTER COLUMN department_id SET DEFAULT nextval('hr.hr_department_department_id_seq'::regclass);


--
-- Name: hr_position position_id; Type: DEFAULT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.hr_position ALTER COLUMN position_id SET DEFAULT nextval('hr.hr_position_position_id_seq'::regclass);


--
-- Name: leave_request leave_request_id; Type: DEFAULT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.leave_request ALTER COLUMN leave_request_id SET DEFAULT nextval('hr.leave_request_leave_request_id_seq'::regclass);


--
-- Name: payroll_run payroll_run_id; Type: DEFAULT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.payroll_run ALTER COLUMN payroll_run_id SET DEFAULT nextval('hr.payroll_run_payroll_run_id_seq'::regclass);


--
-- Name: payroll_slip payroll_slip_id; Type: DEFAULT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.payroll_slip ALTER COLUMN payroll_slip_id SET DEFAULT nextval('hr.payroll_slip_payroll_slip_id_seq'::regclass);


--
-- Name: api_credential api_credential_id; Type: DEFAULT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.api_credential ALTER COLUMN api_credential_id SET DEFAULT nextval('integration.api_credential_api_credential_id_seq'::regclass);


--
-- Name: audit_export_queue export_id; Type: DEFAULT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.audit_export_queue ALTER COLUMN export_id SET DEFAULT nextval('integration.audit_export_queue_export_id_seq'::regclass);


--
-- Name: external_system external_system_id; Type: DEFAULT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.external_system ALTER COLUMN external_system_id SET DEFAULT nextval('integration.external_system_external_system_id_seq'::regclass);


--
-- Name: integration_job integration_job_id; Type: DEFAULT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.integration_job ALTER COLUMN integration_job_id SET DEFAULT nextval('integration.integration_job_integration_job_id_seq'::regclass);


--
-- Name: integration_log integration_log_id; Type: DEFAULT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.integration_log ALTER COLUMN integration_log_id SET DEFAULT nextval('integration.integration_log_integration_log_id_seq'::regclass);


--
-- Name: siem_delivery_queue delivery_id; Type: DEFAULT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.siem_delivery_queue ALTER COLUMN delivery_id SET DEFAULT nextval('integration.siem_delivery_queue_delivery_id_seq'::regclass);


--
-- Name: siem_endpoint endpoint_id; Type: DEFAULT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.siem_endpoint ALTER COLUMN endpoint_id SET DEFAULT nextval('integration.siem_endpoint_endpoint_id_seq'::regclass);


--
-- Name: inventory_valuation inventory_valuation_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.inventory_valuation ALTER COLUMN inventory_valuation_id SET DEFAULT nextval('inventory.inventory_valuation_inventory_valuation_id_seq'::regclass);


--
-- Name: stock_balance stock_balance_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_balance ALTER COLUMN stock_balance_id SET DEFAULT nextval('inventory.stock_balance_stock_balance_id_seq'::regclass);


--
-- Name: stock_bin bin_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_bin ALTER COLUMN bin_id SET DEFAULT nextval('inventory.stock_bin_bin_id_seq'::regclass);


--
-- Name: stock_lot stock_lot_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot ALTER COLUMN stock_lot_id SET DEFAULT nextval('inventory.stock_lot_stock_lot_id_seq'::regclass);


--
-- Name: stock_lot_balance stock_lot_balance_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot_balance ALTER COLUMN stock_lot_balance_id SET DEFAULT nextval('inventory.stock_lot_balance_stock_lot_balance_id_seq'::regclass);


--
-- Name: stock_reservation stock_reservation_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_reservation ALTER COLUMN stock_reservation_id SET DEFAULT nextval('inventory.stock_reservation_stock_reservation_id_seq'::regclass);


--
-- Name: stock_transaction stock_tx_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transaction ALTER COLUMN stock_tx_id SET DEFAULT nextval('inventory.stock_transaction_stock_tx_id_seq'::regclass);


--
-- Name: stock_transfer_detail stock_transfer_detail_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_detail ALTER COLUMN stock_transfer_detail_id SET DEFAULT nextval('inventory.stock_transfer_detail_stock_transfer_detail_id_seq'::regclass);


--
-- Name: stock_transfer_header stock_transfer_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_header ALTER COLUMN stock_transfer_id SET DEFAULT nextval('inventory.stock_transfer_header_stock_transfer_id_seq'::regclass);


--
-- Name: stocktaking_plan stocktaking_plan_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stocktaking_plan ALTER COLUMN stocktaking_plan_id SET DEFAULT nextval('inventory.stocktaking_plan_stocktaking_plan_id_seq'::regclass);


--
-- Name: stocktaking_result stocktaking_result_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stocktaking_result ALTER COLUMN stocktaking_result_id SET DEFAULT nextval('inventory.stocktaking_result_stocktaking_result_id_seq'::regclass);


--
-- Name: storage_location location_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.storage_location ALTER COLUMN location_id SET DEFAULT nextval('inventory.storage_location_location_id_seq'::regclass);


--
-- Name: warehouse warehouse_id; Type: DEFAULT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.warehouse ALTER COLUMN warehouse_id SET DEFAULT nextval('inventory.warehouse_warehouse_id_seq'::regclass);


--
-- Name: bom_detail bom_detail_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.bom_detail ALTER COLUMN bom_detail_id SET DEFAULT nextval('manufacturing.bom_detail_bom_detail_id_seq'::regclass);


--
-- Name: bom_header bom_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.bom_header ALTER COLUMN bom_id SET DEFAULT nextval('manufacturing.bom_header_bom_id_seq'::regclass);


--
-- Name: manufacturing_cost_snapshot manufacturing_cost_snapshot_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_cost_snapshot ALTER COLUMN manufacturing_cost_snapshot_id SET DEFAULT nextval('manufacturing.manufacturing_cost_snapshot_manufacturing_cost_snapshot_id_seq'::regclass);


--
-- Name: manufacturing_execution execution_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_execution ALTER COLUMN execution_id SET DEFAULT nextval('manufacturing.manufacturing_execution_execution_id_seq'::regclass);


--
-- Name: manufacturing_execution_detail execution_detail_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_execution_detail ALTER COLUMN execution_detail_id SET DEFAULT nextval('manufacturing.manufacturing_execution_detail_execution_detail_id_seq'::regclass);


--
-- Name: mps_plan mps_plan_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mps_plan ALTER COLUMN mps_plan_id SET DEFAULT nextval('manufacturing.mps_plan_mps_plan_id_seq'::regclass);


--
-- Name: mps_run mps_run_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mps_run ALTER COLUMN mps_run_id SET DEFAULT nextval('manufacturing.mps_run_mps_run_id_seq'::regclass);


--
-- Name: mrp_allocation mrp_allocation_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mrp_allocation ALTER COLUMN mrp_allocation_id SET DEFAULT nextval('manufacturing.mrp_allocation_mrp_allocation_id_seq'::regclass);


--
-- Name: mrp_requirement mrp_requirement_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mrp_requirement ALTER COLUMN mrp_requirement_id SET DEFAULT nextval('manufacturing.mrp_requirement_mrp_requirement_id_seq'::regclass);


--
-- Name: mrp_run mrp_run_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mrp_run ALTER COLUMN mrp_run_id SET DEFAULT nextval('manufacturing.mrp_run_mrp_run_id_seq'::regclass);


--
-- Name: process_master process_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.process_master ALTER COLUMN process_id SET DEFAULT nextval('manufacturing.process_master_process_id_seq'::regclass);


--
-- Name: routing_header routing_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.routing_header ALTER COLUMN routing_id SET DEFAULT nextval('manufacturing.routing_header_routing_id_seq'::regclass);


--
-- Name: routing_operation routing_operation_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.routing_operation ALTER COLUMN routing_operation_id SET DEFAULT nextval('manufacturing.routing_operation_routing_operation_id_seq'::regclass);


--
-- Name: work_order work_order_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.work_order ALTER COLUMN work_order_id SET DEFAULT nextval('manufacturing.work_order_work_order_id_seq'::regclass);


--
-- Name: yield_metric yield_metric_id; Type: DEFAULT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.yield_metric ALTER COLUMN yield_metric_id SET DEFAULT nextval('manufacturing.yield_metric_yield_metric_id_seq'::regclass);


--
-- Name: asset asset_id; Type: DEFAULT; Schema: media; Owner: -
--

ALTER TABLE ONLY media.asset ALTER COLUMN asset_id SET DEFAULT nextval('media.asset_asset_id_seq'::regclass);


--
-- Name: ai_event ai_event_id; Type: DEFAULT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.ai_event ALTER COLUMN ai_event_id SET DEFAULT nextval('notify.ai_event_ai_event_id_seq'::regclass);


--
-- Name: ai_rule ai_rule_id; Type: DEFAULT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.ai_rule ALTER COLUMN ai_rule_id SET DEFAULT nextval('notify.ai_rule_ai_rule_id_seq'::regclass);


--
-- Name: approval_action_log action_log_id; Type: DEFAULT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.approval_action_log ALTER COLUMN action_log_id SET DEFAULT nextval('notify.approval_action_log_action_log_id_seq'::regclass);


--
-- Name: approval_request approval_request_id; Type: DEFAULT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.approval_request ALTER COLUMN approval_request_id SET DEFAULT nextval('notify.approval_request_approval_request_id_seq'::regclass);


--
-- Name: audit_trail audit_id; Type: DEFAULT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.audit_trail ALTER COLUMN audit_id SET DEFAULT nextval('notify.audit_trail_audit_id_seq'::regclass);


--
-- Name: notification_log notification_id; Type: DEFAULT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.notification_log ALTER COLUMN notification_id SET DEFAULT nextval('notify.notification_log_notification_id_seq'::regclass);


--
-- Name: notification_route route_id; Type: DEFAULT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.notification_route ALTER COLUMN route_id SET DEFAULT nextval('notify.notification_route_route_id_seq'::regclass);


--
-- Name: notification_template template_id; Type: DEFAULT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.notification_template ALTER COLUMN template_id SET DEFAULT nextval('notify.notification_template_template_id_seq'::regclass);


--
-- Name: document_file document_file_id; Type: DEFAULT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_file ALTER COLUMN document_file_id SET DEFAULT nextval('ops.document_file_document_file_id_seq'::regclass);


--
-- Name: document_send_history send_history_id; Type: DEFAULT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_send_history ALTER COLUMN send_history_id SET DEFAULT nextval('ops.document_send_history_send_history_id_seq'::regclass);


--
-- Name: document_send_queue send_queue_id; Type: DEFAULT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_send_queue ALTER COLUMN send_queue_id SET DEFAULT nextval('ops.document_send_queue_send_queue_id_seq'::regclass);


--
-- Name: notification_outbox notification_id; Type: DEFAULT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.notification_outbox ALTER COLUMN notification_id SET DEFAULT nextval('ops.notification_outbox_notification_id_seq'::regclass);


--
-- Name: ops_job_queue job_id; Type: DEFAULT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.ops_job_queue ALTER COLUMN job_id SET DEFAULT nextval('ops.ops_job_queue_job_id_seq'::regclass);


--
-- Name: pdf_generate_queue queue_id; Type: DEFAULT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.pdf_generate_queue ALTER COLUMN queue_id SET DEFAULT nextval('ops.pdf_generate_queue_queue_id_seq'::regclass);


--
-- Name: send_fee_master fee_id; Type: DEFAULT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.send_fee_master ALTER COLUMN fee_id SET DEFAULT nextval('ops.send_fee_master_fee_id_seq'::regclass);


--
-- Name: purchase_invoice purchase_invoice_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice ALTER COLUMN purchase_invoice_id SET DEFAULT nextval('purchase.purchase_invoice_purchase_invoice_id_seq'::regclass);


--
-- Name: purchase_invoice_detail purchase_invoice_detail_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice_detail ALTER COLUMN purchase_invoice_detail_id SET DEFAULT nextval('purchase.purchase_invoice_detail_purchase_invoice_detail_id_seq'::regclass);


--
-- Name: purchase_order_detail purchase_order_detail_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_detail ALTER COLUMN purchase_order_detail_id SET DEFAULT nextval('purchase.purchase_order_detail_purchase_order_detail_id_seq'::regclass);


--
-- Name: purchase_order_header purchase_order_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_header ALTER COLUMN purchase_order_id SET DEFAULT nextval('purchase.purchase_order_header_purchase_order_id_seq'::regclass);


--
-- Name: purchase_quotation purchase_quotation_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_quotation ALTER COLUMN purchase_quotation_id SET DEFAULT nextval('purchase.purchase_quotation_purchase_quotation_id_seq'::regclass);


--
-- Name: purchase_quotation_detail purchase_quotation_detail_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_quotation_detail ALTER COLUMN purchase_quotation_detail_id SET DEFAULT nextval('purchase.purchase_quotation_detail_purchase_quotation_detail_id_seq'::regclass);


--
-- Name: purchase_receipt receipt_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt ALTER COLUMN receipt_id SET DEFAULT nextval('purchase.purchase_receipt_receipt_id_seq'::regclass);


--
-- Name: purchase_receipt_detail receipt_detail_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt_detail ALTER COLUMN receipt_detail_id SET DEFAULT nextval('purchase.purchase_receipt_detail_receipt_detail_id_seq'::regclass);


--
-- Name: purchase_requisition purchase_requisition_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_requisition ALTER COLUMN purchase_requisition_id SET DEFAULT nextval('purchase.purchase_requisition_purchase_requisition_id_seq'::regclass);


--
-- Name: purchase_requisition_detail purchase_requisition_detail_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_requisition_detail ALTER COLUMN purchase_requisition_detail_id SET DEFAULT nextval('purchase.purchase_requisition_detail_purchase_requisition_detail_id_seq'::regclass);


--
-- Name: purchase_three_way_match purchase_three_way_match_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_three_way_match ALTER COLUMN purchase_three_way_match_id SET DEFAULT nextval('purchase.purchase_three_way_match_purchase_three_way_match_id_seq'::regclass);


--
-- Name: supplier_address supplier_address_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_address ALTER COLUMN supplier_address_id SET DEFAULT nextval('purchase.supplier_address_supplier_address_id_seq'::regclass);


--
-- Name: supplier_contact supplier_contact_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_contact ALTER COLUMN supplier_contact_id SET DEFAULT nextval('purchase.supplier_contact_supplier_contact_id_seq'::regclass);


--
-- Name: supplier_item_price supplier_item_price_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_item_price ALTER COLUMN supplier_item_price_id SET DEFAULT nextval('purchase.supplier_item_price_supplier_item_price_id_seq'::regclass);


--
-- Name: supplier_master supplier_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_master ALTER COLUMN supplier_id SET DEFAULT nextval('purchase.supplier_master_supplier_id_seq'::regclass);


--
-- Name: supplier_payment_term supplier_payment_term_id; Type: DEFAULT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_payment_term ALTER COLUMN supplier_payment_term_id SET DEFAULT nextval('purchase.supplier_payment_term_supplier_payment_term_id_seq'::regclass);


--
-- Name: billing_detail billing_detail_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_detail ALTER COLUMN billing_detail_id SET DEFAULT nextval('sales.billing_detail_billing_detail_id_seq'::regclass);


--
-- Name: billing_header billing_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_header ALTER COLUMN billing_id SET DEFAULT nextval('sales.billing_header_billing_id_seq'::regclass);


--
-- Name: customer customer_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer ALTER COLUMN customer_id SET DEFAULT nextval('sales.customer_customer_id_seq'::regclass);


--
-- Name: customer_address customer_address_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_address ALTER COLUMN customer_address_id SET DEFAULT nextval('sales.customer_address_customer_address_id_seq'::regclass);


--
-- Name: customer_contact customer_contact_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_contact ALTER COLUMN customer_contact_id SET DEFAULT nextval('sales.customer_contact_customer_contact_id_seq'::regclass);


--
-- Name: customer_payment_term customer_payment_term_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_payment_term ALTER COLUMN customer_payment_term_id SET DEFAULT nextval('sales.customer_payment_term_customer_payment_term_id_seq'::regclass);


--
-- Name: invoice_pdf invoice_pdf_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.invoice_pdf ALTER COLUMN invoice_pdf_id SET DEFAULT nextval('sales.invoice_pdf_invoice_pdf_id_seq'::regclass);


--
-- Name: item item_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item ALTER COLUMN item_id SET DEFAULT nextval('sales.item_item_id_seq'::regclass);


--
-- Name: item_category item_category_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_category ALTER COLUMN item_category_id SET DEFAULT nextval('sales.item_category_item_category_id_seq'::regclass);


--
-- Name: item_price_master item_price_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_price_master ALTER COLUMN item_price_id SET DEFAULT nextval('sales.item_price_master_item_price_id_seq'::regclass);


--
-- Name: item_uom item_uom_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_uom ALTER COLUMN item_uom_id SET DEFAULT nextval('sales.item_uom_item_uom_id_seq'::regclass);


--
-- Name: order_detail order_detail_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_detail ALTER COLUMN order_detail_id SET DEFAULT nextval('sales.order_detail_order_detail_id_seq'::regclass);


--
-- Name: order_header order_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_header ALTER COLUMN order_id SET DEFAULT nextval('sales.order_header_order_id_seq'::regclass);


--
-- Name: quotation_order_link quotation_order_link_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.quotation_order_link ALTER COLUMN quotation_order_link_id SET DEFAULT nextval('sales.quotation_order_link_quotation_order_link_id_seq'::regclass);


--
-- Name: return_detail return_detail_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_detail ALTER COLUMN return_detail_id SET DEFAULT nextval('sales.return_detail_return_detail_id_seq'::regclass);


--
-- Name: return_header return_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_header ALTER COLUMN return_id SET DEFAULT nextval('sales.return_header_return_id_seq'::regclass);


--
-- Name: sales_quotation sales_quotation_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation ALTER COLUMN sales_quotation_id SET DEFAULT nextval('sales.sales_quotation_sales_quotation_id_seq'::regclass);


--
-- Name: sales_quotation_detail sales_quotation_detail_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation_detail ALTER COLUMN sales_quotation_detail_id SET DEFAULT nextval('sales.sales_quotation_detail_sales_quotation_detail_id_seq'::regclass);


--
-- Name: shipping_detail shipping_detail_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_detail ALTER COLUMN shipping_detail_id SET DEFAULT nextval('sales.shipping_detail_shipping_detail_id_seq'::regclass);


--
-- Name: shipping_header shipping_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_header ALTER COLUMN shipping_id SET DEFAULT nextval('sales.shipping_header_shipping_id_seq'::regclass);


--
-- Name: shipping_revision shipping_revision_id; Type: DEFAULT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_revision ALTER COLUMN shipping_revision_id SET DEFAULT nextval('sales.shipping_revision_shipping_revision_id_seq'::regclass);


--
-- Name: ai_signal signal_id; Type: DEFAULT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.ai_signal ALTER COLUMN signal_id SET DEFAULT nextval('system.ai_signal_signal_id_seq'::regclass);


--
-- Name: ai_task task_id; Type: DEFAULT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.ai_task ALTER COLUMN task_id SET DEFAULT nextval('system.ai_task_task_id_seq'::regclass);


--
-- Name: ai_task_run run_id; Type: DEFAULT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.ai_task_run ALTER COLUMN run_id SET DEFAULT nextval('system.ai_task_run_run_id_seq'::regclass);


--
-- Name: approval_action_log approval_action_id; Type: DEFAULT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_action_log ALTER COLUMN approval_action_id SET DEFAULT nextval('system.approval_action_log_approval_action_id_seq'::regclass);


--
-- Name: approval_request approval_request_id; Type: DEFAULT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_request ALTER COLUMN approval_request_id SET DEFAULT nextval('system.approval_request_approval_request_id_seq'::regclass);


--
-- Name: exec_run_request request_id; Type: DEFAULT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.exec_run_request ALTER COLUMN request_id SET DEFAULT nextval('system.exec_run_request_request_id_seq'::regclass);


--
-- Name: loop_autotune_rule rule_id; Type: DEFAULT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.loop_autotune_rule ALTER COLUMN rule_id SET DEFAULT nextval('system.loop_autotune_rule_rule_id_seq'::regclass);


--
-- Name: loop_sla_stat stat_id; Type: DEFAULT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.loop_sla_stat ALTER COLUMN stat_id SET DEFAULT nextval('system.loop_sla_stat_stat_id_seq'::regclass);


--
-- Name: loop_tick_log tick_id; Type: DEFAULT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.loop_tick_log ALTER COLUMN tick_id SET DEFAULT nextval('system.loop_tick_log_tick_id_seq'::regclass);


--
-- Name: operation_log operation_log_id; Type: DEFAULT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.operation_log ALTER COLUMN operation_log_id SET DEFAULT nextval('system.operation_log_operation_log_id_seq'::regclass);


--
-- Name: paper_send_fee_journal paper_send_fee_journal_pkey; Type: CONSTRAINT; Schema: accounting; Owner: -
--

ALTER TABLE ONLY accounting.paper_send_fee_journal
    ADD CONSTRAINT paper_send_fee_journal_pkey PRIMARY KEY (journal_id);


--
-- Name: ai_apply_audit ai_apply_audit_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.ai_apply_audit
    ADD CONSTRAINT ai_apply_audit_pkey PRIMARY KEY (audit_id);


--
-- Name: ai_event ai_event_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.ai_event
    ADD CONSTRAINT ai_event_pkey PRIMARY KEY (ai_event_id);


--
-- Name: ai_insight_job ai_insight_job_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.ai_insight_job
    ADD CONSTRAINT ai_insight_job_pkey PRIMARY KEY (job_id);


--
-- Name: ai_job ai_job_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.ai_job
    ADD CONSTRAINT ai_job_pkey PRIMARY KEY (ai_job_id);


--
-- Name: ai_job_type_master ai_job_type_master_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.ai_job_type_master
    ADD CONSTRAINT ai_job_type_master_pkey PRIMARY KEY (job_type);


--
-- Name: ai_kill_switch ai_kill_switch_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.ai_kill_switch
    ADD CONSTRAINT ai_kill_switch_pkey PRIMARY KEY (scope);


--
-- Name: ai_module_manifest ai_module_manifest_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.ai_module_manifest
    ADD CONSTRAINT ai_module_manifest_pkey PRIMARY KEY (module_name);


--
-- Name: ai_rate_limit ai_rate_limit_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.ai_rate_limit
    ADD CONSTRAINT ai_rate_limit_pkey PRIMARY KEY (job_type);


--
-- Name: audit_ai_feedback audit_ai_feedback_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_feedback
    ADD CONSTRAINT audit_ai_feedback_pkey PRIMARY KEY (feedback_id);


--
-- Name: audit_ai_job audit_ai_job_alert_event_id_key; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_job
    ADD CONSTRAINT audit_ai_job_alert_event_id_key UNIQUE (alert_event_id);


--
-- Name: audit_ai_job audit_ai_job_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_job
    ADD CONSTRAINT audit_ai_job_pkey PRIMARY KEY (job_id);


--
-- Name: audit_ai_llm_result audit_ai_llm_result_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_llm_result
    ADD CONSTRAINT audit_ai_llm_result_pkey PRIMARY KEY (llm_result_id);


--
-- Name: audit_alert_ai_judgement audit_alert_ai_judgement_alert_event_id_key; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_ai_judgement
    ADD CONSTRAINT audit_alert_ai_judgement_alert_event_id_key UNIQUE (alert_event_id);


--
-- Name: audit_alert_ai_judgement audit_alert_ai_judgement_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_ai_judgement
    ADD CONSTRAINT audit_alert_ai_judgement_pkey PRIMARY KEY (judgement_id);


--
-- Name: audit_alert_event audit_alert_event_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_event
    ADD CONSTRAINT audit_alert_event_pkey PRIMARY KEY (alert_event_id);


--
-- Name: audit_alert_notification audit_alert_notification_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_notification
    ADD CONSTRAINT audit_alert_notification_pkey PRIMARY KEY (notification_id);


--
-- Name: audit_alert_rule audit_alert_rule_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_rule
    ADD CONSTRAINT audit_alert_rule_pkey PRIMARY KEY (rule_id);


--
-- Name: fact_metric fact_metric_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.fact_metric
    ADD CONSTRAINT fact_metric_pkey PRIMARY KEY (fact_id);


--
-- Name: notification_queue notification_queue_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.notification_queue
    ADD CONSTRAINT notification_queue_pkey PRIMARY KEY (notification_id);


--
-- Name: sla_breach_event sla_breach_event_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.sla_breach_event
    ADD CONSTRAINT sla_breach_event_pkey PRIMARY KEY (breach_id);


--
-- Name: sla_definition sla_definition_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.sla_definition
    ADD CONSTRAINT sla_definition_pkey PRIMARY KEY (domain);


--
-- Name: sla_escalation_target sla_escalation_target_pkey; Type: CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.sla_escalation_target
    ADD CONSTRAINT sla_escalation_target_pkey PRIMARY KEY (domain);


--
-- Name: ai_improvement_proposal ai_improvement_proposal_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.ai_improvement_proposal
    ADD CONSTRAINT ai_improvement_proposal_pkey PRIMARY KEY (proposal_id);


--
-- Name: approver approver_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.approver
    ADD CONSTRAINT approver_pkey PRIMARY KEY (company_id, user_id);


--
-- Name: billing_customer billing_customer_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.billing_customer
    ADD CONSTRAINT billing_customer_pkey PRIMARY KEY (customer_code);


--
-- Name: billing_invoice billing_invoice_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.billing_invoice
    ADD CONSTRAINT billing_invoice_pkey PRIMARY KEY (invoice_id);


--
-- Name: billing_payment billing_payment_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.billing_payment
    ADD CONSTRAINT billing_payment_pkey PRIMARY KEY (payment_id);


--
-- Name: company_cost company_cost_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.company_cost
    ADD CONSTRAINT company_cost_pkey PRIMARY KEY (company_id);


--
-- Name: company_plan company_plan_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.company_plan
    ADD CONSTRAINT company_plan_pkey PRIMARY KEY (company_id);


--
-- Name: feature_flag feature_flag_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.feature_flag
    ADD CONSTRAINT feature_flag_pkey PRIMARY KEY (company_id, feature_key);


--
-- Name: invoice_delivery_log invoice_delivery_log_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.invoice_delivery_log
    ADD CONSTRAINT invoice_delivery_log_pkey PRIMARY KEY (delivery_id);


--
-- Name: jsox_control jsox_control_control_code_key; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.jsox_control
    ADD CONSTRAINT jsox_control_control_code_key UNIQUE (control_code);


--
-- Name: jsox_control jsox_control_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.jsox_control
    ADD CONSTRAINT jsox_control_pkey PRIMARY KEY (control_id);


--
-- Name: jsox_evidence_log jsox_evidence_log_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.jsox_evidence_log
    ADD CONSTRAINT jsox_evidence_log_pkey PRIMARY KEY (evidence_id);


--
-- Name: lp_copy_i18n lp_copy_i18n_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.lp_copy_i18n
    ADD CONSTRAINT lp_copy_i18n_pkey PRIMARY KEY (lang, copy_key);


--
-- Name: payment_provider payment_provider_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.payment_provider
    ADD CONSTRAINT payment_provider_pkey PRIMARY KEY (provider_code);


--
-- Name: plan_master plan_master_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.plan_master
    ADD CONSTRAINT plan_master_pkey PRIMARY KEY (plan_code);


--
-- Name: policy_activation_log policy_activation_log_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.policy_activation_log
    ADD CONSTRAINT policy_activation_log_pkey PRIMARY KEY (log_id);


--
-- Name: policy_auto_generated policy_auto_generated_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.policy_auto_generated
    ADD CONSTRAINT policy_auto_generated_pkey PRIMARY KEY (auto_policy_id);


--
-- Name: policy_eval_event policy_eval_event_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.policy_eval_event
    ADD CONSTRAINT policy_eval_event_pkey PRIMARY KEY (eval_id);


--
-- Name: policy_rollout_log policy_rollout_log_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.policy_rollout_log
    ADD CONSTRAINT policy_rollout_log_pkey PRIMARY KEY (log_id);


--
-- Name: policy_rollout policy_rollout_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.policy_rollout
    ADD CONSTRAINT policy_rollout_pkey PRIMARY KEY (auto_policy_id);


--
-- Name: public_pricing public_pricing_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.public_pricing
    ADD CONSTRAINT public_pricing_pkey PRIMARY KEY (plan_code);


--
-- Name: rework_task rework_task_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.rework_task
    ADD CONSTRAINT rework_task_pkey PRIMARY KEY (task_id);


--
-- Name: saas_company_map saas_company_map_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.saas_company_map
    ADD CONSTRAINT saas_company_map_pkey PRIMARY KEY (subscription_id, company_id);


--
-- Name: saas_plan_limit saas_plan_limit_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.saas_plan_limit
    ADD CONSTRAINT saas_plan_limit_pkey PRIMARY KEY (plan_code);


--
-- Name: saas_plan saas_plan_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.saas_plan
    ADD CONSTRAINT saas_plan_pkey PRIMARY KEY (plan_code);


--
-- Name: saas_subscription saas_subscription_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.saas_subscription
    ADD CONSTRAINT saas_subscription_pkey PRIMARY KEY (subscription_id);


--
-- Name: saas_usage_daily saas_usage_daily_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.saas_usage_daily
    ADD CONSTRAINT saas_usage_daily_pkey PRIMARY KEY (company_id, day);


--
-- Name: saas_usage_monthly saas_usage_monthly_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.saas_usage_monthly
    ADD CONSTRAINT saas_usage_monthly_pkey PRIMARY KEY (subscription_id, ym);


--
-- Name: stripe_webhook_event stripe_webhook_event_event_id_key; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.stripe_webhook_event
    ADD CONSTRAINT stripe_webhook_event_event_id_key UNIQUE (event_id);


--
-- Name: stripe_webhook_event stripe_webhook_event_pkey; Type: CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.stripe_webhook_event
    ADD CONSTRAINT stripe_webhook_event_pkey PRIMARY KEY (id);


--
-- Name: approval_log approval_log_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.approval_log
    ADD CONSTRAINT approval_log_pkey PRIMARY KEY (approval_log_id);


--
-- Name: approval_notify_queue approval_notify_queue_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.approval_notify_queue
    ADD CONSTRAINT approval_notify_queue_pkey PRIMARY KEY (notify_id);


--
-- Name: approval_reason_template approval_reason_template_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.approval_reason_template
    ADD CONSTRAINT approval_reason_template_pkey PRIMARY KEY (template_id);


--
-- Name: approval_request approval_request_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.approval_request
    ADD CONSTRAINT approval_request_pkey PRIMARY KEY (request_id);


--
-- Name: audit_event audit_event_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.audit_event
    ADD CONSTRAINT audit_event_pkey PRIMARY KEY (audit_event_id);


--
-- Name: audit_reason_policy audit_reason_policy_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.audit_reason_policy
    ADD CONSTRAINT audit_reason_policy_pkey PRIMARY KEY (reason_code);


--
-- Name: audit_target_table audit_target_table_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.audit_target_table
    ADD CONSTRAINT audit_target_table_pkey PRIMARY KEY (table_schema, table_name);


--
-- Name: audit_trail_db audit_trail_db_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.audit_trail_db
    ADD CONSTRAINT audit_trail_db_pkey PRIMARY KEY (audit_trail_db_id);


--
-- Name: entity_status_history entity_status_history_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.entity_status_history
    ADD CONSTRAINT entity_status_history_pkey PRIMARY KEY (status_history_id);


--
-- Name: exec_audit_event exec_audit_event_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.exec_audit_event
    ADD CONSTRAINT exec_audit_event_pkey PRIMARY KEY (audit_event_id);


--
-- Name: ng_event ng_event_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.ng_event
    ADD CONSTRAINT ng_event_pkey PRIMARY KEY (ng_event_id);


--
-- Name: notification_channel notification_channel_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.notification_channel
    ADD CONSTRAINT notification_channel_pkey PRIMARY KEY (channel_id);


--
-- Name: ops_audit_log ops_audit_log_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.ops_audit_log
    ADD CONSTRAINT ops_audit_log_pkey PRIMARY KEY (audit_id);


--
-- Name: slack_interaction_log slack_interaction_log_pkey; Type: CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.slack_interaction_log
    ADD CONSTRAINT slack_interaction_log_pkey PRIMARY KEY (interaction_id);


--
-- Name: mfa_amr_claims amr_id_pk; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_amr_claims
    ADD CONSTRAINT amr_id_pk PRIMARY KEY (id);


--
-- Name: audit_log_entries audit_log_entries_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.audit_log_entries
    ADD CONSTRAINT audit_log_entries_pkey PRIMARY KEY (id);


--
-- Name: flow_state flow_state_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.flow_state
    ADD CONSTRAINT flow_state_pkey PRIMARY KEY (id);


--
-- Name: identities identities_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.identities
    ADD CONSTRAINT identities_pkey PRIMARY KEY (id);


--
-- Name: identities identities_provider_id_provider_unique; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.identities
    ADD CONSTRAINT identities_provider_id_provider_unique UNIQUE (provider_id, provider);


--
-- Name: instances instances_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.instances
    ADD CONSTRAINT instances_pkey PRIMARY KEY (id);


--
-- Name: mfa_amr_claims mfa_amr_claims_session_id_authentication_method_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_amr_claims
    ADD CONSTRAINT mfa_amr_claims_session_id_authentication_method_pkey UNIQUE (session_id, authentication_method);


--
-- Name: mfa_challenges mfa_challenges_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_challenges
    ADD CONSTRAINT mfa_challenges_pkey PRIMARY KEY (id);


--
-- Name: mfa_factors mfa_factors_last_challenged_at_key; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_factors
    ADD CONSTRAINT mfa_factors_last_challenged_at_key UNIQUE (last_challenged_at);


--
-- Name: mfa_factors mfa_factors_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_factors
    ADD CONSTRAINT mfa_factors_pkey PRIMARY KEY (id);


--
-- Name: oauth_authorizations oauth_authorizations_authorization_code_key; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_authorizations
    ADD CONSTRAINT oauth_authorizations_authorization_code_key UNIQUE (authorization_code);


--
-- Name: oauth_authorizations oauth_authorizations_authorization_id_key; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_authorizations
    ADD CONSTRAINT oauth_authorizations_authorization_id_key UNIQUE (authorization_id);


--
-- Name: oauth_authorizations oauth_authorizations_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_authorizations
    ADD CONSTRAINT oauth_authorizations_pkey PRIMARY KEY (id);


--
-- Name: oauth_client_states oauth_client_states_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_client_states
    ADD CONSTRAINT oauth_client_states_pkey PRIMARY KEY (id);


--
-- Name: oauth_clients oauth_clients_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_clients
    ADD CONSTRAINT oauth_clients_pkey PRIMARY KEY (id);


--
-- Name: oauth_consents oauth_consents_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_consents
    ADD CONSTRAINT oauth_consents_pkey PRIMARY KEY (id);


--
-- Name: oauth_consents oauth_consents_user_client_unique; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_consents
    ADD CONSTRAINT oauth_consents_user_client_unique UNIQUE (user_id, client_id);


--
-- Name: one_time_tokens one_time_tokens_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.one_time_tokens
    ADD CONSTRAINT one_time_tokens_pkey PRIMARY KEY (id);


--
-- Name: refresh_tokens refresh_tokens_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.refresh_tokens
    ADD CONSTRAINT refresh_tokens_pkey PRIMARY KEY (id);


--
-- Name: refresh_tokens refresh_tokens_token_unique; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.refresh_tokens
    ADD CONSTRAINT refresh_tokens_token_unique UNIQUE (token);


--
-- Name: saml_providers saml_providers_entity_id_key; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_providers
    ADD CONSTRAINT saml_providers_entity_id_key UNIQUE (entity_id);


--
-- Name: saml_providers saml_providers_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_providers
    ADD CONSTRAINT saml_providers_pkey PRIMARY KEY (id);


--
-- Name: saml_relay_states saml_relay_states_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_relay_states
    ADD CONSTRAINT saml_relay_states_pkey PRIMARY KEY (id);


--
-- Name: schema_migrations schema_migrations_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.schema_migrations
    ADD CONSTRAINT schema_migrations_pkey PRIMARY KEY (version);


--
-- Name: sessions sessions_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sessions
    ADD CONSTRAINT sessions_pkey PRIMARY KEY (id);


--
-- Name: sso_domains sso_domains_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sso_domains
    ADD CONSTRAINT sso_domains_pkey PRIMARY KEY (id);


--
-- Name: sso_providers sso_providers_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sso_providers
    ADD CONSTRAINT sso_providers_pkey PRIMARY KEY (id);


--
-- Name: users users_phone_key; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.users
    ADD CONSTRAINT users_phone_key UNIQUE (phone);


--
-- Name: users users_pkey; Type: CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.users
    ADD CONSTRAINT users_pkey PRIMARY KEY (id);


--
-- Name: checkout_session checkout_session_pkey; Type: CONSTRAINT; Schema: billing; Owner: -
--

ALTER TABLE ONLY billing.checkout_session
    ADD CONSTRAINT checkout_session_pkey PRIMARY KEY (checkout_id);


--
-- Name: customer_profile customer_profile_pkey; Type: CONSTRAINT; Schema: billing; Owner: -
--

ALTER TABLE ONLY billing.customer_profile
    ADD CONSTRAINT customer_profile_pkey PRIMARY KEY (customer_code);


--
-- Name: invoice_line invoice_line_pkey; Type: CONSTRAINT; Schema: billing; Owner: -
--

ALTER TABLE ONLY billing.invoice_line
    ADD CONSTRAINT invoice_line_pkey PRIMARY KEY (invoice_line_id);


--
-- Name: invoice invoice_pkey; Type: CONSTRAINT; Schema: billing; Owner: -
--

ALTER TABLE ONLY billing.invoice
    ADD CONSTRAINT invoice_pkey PRIMARY KEY (invoice_id);


--
-- Name: invoice_send_audit invoice_send_audit_pkey; Type: CONSTRAINT; Schema: billing; Owner: -
--

ALTER TABLE ONLY billing.invoice_send_audit
    ADD CONSTRAINT invoice_send_audit_pkey PRIMARY KEY (audit_id);


--
-- Name: invoice_send_retry invoice_send_retry_pkey; Type: CONSTRAINT; Schema: billing; Owner: -
--

ALTER TABLE ONLY billing.invoice_send_retry
    ADD CONSTRAINT invoice_send_retry_pkey PRIMARY KEY (retry_id);


--
-- Name: invoice_template invoice_template_pkey; Type: CONSTRAINT; Schema: billing; Owner: -
--

ALTER TABLE ONLY billing.invoice_template
    ADD CONSTRAINT invoice_template_pkey PRIMARY KEY (template_code);


--
-- Name: issuer_profile issuer_profile_pkey; Type: CONSTRAINT; Schema: billing; Owner: -
--

ALTER TABLE ONLY billing.issuer_profile
    ADD CONSTRAINT issuer_profile_pkey PRIMARY KEY (company_id);


--
-- Name: escalation_outbox escalation_outbox_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.escalation_outbox
    ADD CONSTRAINT escalation_outbox_pkey PRIMARY KEY (outbox_id);


--
-- Name: json_schema_check_log json_schema_check_log_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.json_schema_check_log
    ADD CONSTRAINT json_schema_check_log_pkey PRIMARY KEY (check_id);


--
-- Name: kill_switch kill_switch_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.kill_switch
    ADD CONSTRAINT kill_switch_pkey PRIMARY KEY (switch_name);


--
-- Name: ops_notification_queue ops_notification_queue_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.ops_notification_queue
    ADD CONSTRAINT ops_notification_queue_pkey PRIMARY KEY (notification_id);


--
-- Name: schema_ai_review_job schema_ai_review_job_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.schema_ai_review_job
    ADD CONSTRAINT schema_ai_review_job_pkey PRIMARY KEY (job_id);


--
-- Name: schema_ai_review_job schema_ai_review_job_request_id_key; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.schema_ai_review_job
    ADD CONSTRAINT schema_ai_review_job_request_id_key UNIQUE (request_id);


--
-- Name: schema_change_request schema_change_request_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.schema_change_request
    ADD CONSTRAINT schema_change_request_pkey PRIMARY KEY (request_id);


--
-- Name: schema_review_prompt_template schema_review_prompt_template_domain_schema_name_key; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.schema_review_prompt_template
    ADD CONSTRAINT schema_review_prompt_template_domain_schema_name_key UNIQUE (domain, schema_name);


--
-- Name: schema_review_prompt_template schema_review_prompt_template_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.schema_review_prompt_template
    ADD CONSTRAINT schema_review_prompt_template_pkey PRIMARY KEY (template_id);


--
-- Name: schema_review_summary schema_review_summary_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.schema_review_summary
    ADD CONSTRAINT schema_review_summary_pkey PRIMARY KEY (request_id);


--
-- Name: sla_escalation_policy sla_escalation_policy_domain_key; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.sla_escalation_policy
    ADD CONSTRAINT sla_escalation_policy_domain_key UNIQUE (domain);


--
-- Name: sla_escalation_policy sla_escalation_policy_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.sla_escalation_policy
    ADD CONSTRAINT sla_escalation_policy_pkey PRIMARY KEY (policy_id);


--
-- Name: slack_approval_audit slack_approval_audit_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.slack_approval_audit
    ADD CONSTRAINT slack_approval_audit_pkey PRIMARY KEY (audit_id);


--
-- Name: slack_interaction_log slack_interaction_log_pkey; Type: CONSTRAINT; Schema: ci; Owner: -
--

ALTER TABLE ONLY ci.slack_interaction_log
    ADD CONSTRAINT slack_interaction_log_pkey PRIMARY KEY (interaction_id);


--
-- Name: audit_action audit_action_pkey; Type: CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_action
    ADD CONSTRAINT audit_action_pkey PRIMARY KEY (audit_action_id);


--
-- Name: audit_event audit_event_pkey; Type: CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_event
    ADD CONSTRAINT audit_event_pkey PRIMARY KEY (audit_event_id);


--
-- Name: audit_issue audit_issue_pkey; Type: CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_issue
    ADD CONSTRAINT audit_issue_pkey PRIMARY KEY (audit_issue_id);


--
-- Name: iso_clause iso_clause_iso_standard_id_clause_code_key; Type: CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.iso_clause
    ADD CONSTRAINT iso_clause_iso_standard_id_clause_code_key UNIQUE (iso_standard_id, clause_code);


--
-- Name: iso_clause iso_clause_pkey; Type: CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.iso_clause
    ADD CONSTRAINT iso_clause_pkey PRIMARY KEY (iso_clause_id);


--
-- Name: iso_standard iso_standard_iso_code_key; Type: CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.iso_standard
    ADD CONSTRAINT iso_standard_iso_code_key UNIQUE (iso_code);


--
-- Name: iso_standard iso_standard_pkey; Type: CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.iso_standard
    ADD CONSTRAINT iso_standard_pkey PRIMARY KEY (iso_standard_id);


--
-- Name: accounting_period accounting_period_company_id_period_year_period_month_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.accounting_period
    ADD CONSTRAINT accounting_period_company_id_period_year_period_month_key UNIQUE (company_id, period_year, period_month);


--
-- Name: accounting_period accounting_period_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.accounting_period
    ADD CONSTRAINT accounting_period_pkey PRIMARY KEY (period_id);


--
-- Name: accounts accounts_company_id_account_code_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.accounts
    ADD CONSTRAINT accounts_company_id_account_code_key UNIQUE (company_id, account_code);


--
-- Name: accounts accounts_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.accounts
    ADD CONSTRAINT accounts_pkey PRIMARY KEY (account_id);


--
-- Name: app_user app_user_email_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.app_user
    ADD CONSTRAINT app_user_email_key UNIQUE (email);


--
-- Name: app_user app_user_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.app_user
    ADD CONSTRAINT app_user_pkey PRIMARY KEY (user_id);


--
-- Name: audit_column_weight audit_column_weight_company_id_entity_type_like_column_name_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_column_weight
    ADD CONSTRAINT audit_column_weight_company_id_entity_type_like_column_name_key UNIQUE (company_id, entity_type_like, column_name);


--
-- Name: audit_column_weight audit_column_weight_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_column_weight
    ADD CONSTRAINT audit_column_weight_pkey PRIMARY KEY (column_weight_id);


--
-- Name: audit_entity_pk_map audit_entity_pk_map_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_entity_pk_map
    ADD CONSTRAINT audit_entity_pk_map_pkey PRIMARY KEY (schema_name, table_name);


--
-- Name: audit_impact_rule audit_impact_rule_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_impact_rule
    ADD CONSTRAINT audit_impact_rule_pkey PRIMARY KEY (rule_id);


--
-- Name: audit_trail audit_trail_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail
    ADD CONSTRAINT audit_trail_pkey PRIMARY KEY (audit_trail_id, performed_at);


--
-- Name: audit_trail_2025_12 audit_trail_2025_12_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail_2025_12
    ADD CONSTRAINT audit_trail_2025_12_pkey PRIMARY KEY (audit_trail_id, performed_at);


--
-- Name: audit_trail_2026_01 audit_trail_2026_01_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail_2026_01
    ADD CONSTRAINT audit_trail_2026_01_pkey PRIMARY KEY (audit_trail_id, performed_at);


--
-- Name: audit_trail_2026_02 audit_trail_2026_02_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail_2026_02
    ADD CONSTRAINT audit_trail_2026_02_pkey PRIMARY KEY (audit_trail_id, performed_at);


--
-- Name: audit_trail_2026_03 audit_trail_2026_03_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail_2026_03
    ADD CONSTRAINT audit_trail_2026_03_pkey PRIMARY KEY (audit_trail_id, performed_at);


--
-- Name: audit_trail_2026_04 audit_trail_2026_04_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail_2026_04
    ADD CONSTRAINT audit_trail_2026_04_pkey PRIMARY KEY (audit_trail_id, performed_at);


--
-- Name: audit_trail_2026_05 audit_trail_2026_05_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail_2026_05
    ADD CONSTRAINT audit_trail_2026_05_pkey PRIMARY KEY (audit_trail_id, performed_at);


--
-- Name: audit_trail_2026_06 audit_trail_2026_06_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail_2026_06
    ADD CONSTRAINT audit_trail_2026_06_pkey PRIMARY KEY (audit_trail_id, performed_at);


--
-- Name: audit_trail_2026_07 audit_trail_2026_07_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.audit_trail_2026_07
    ADD CONSTRAINT audit_trail_2026_07_pkey PRIMARY KEY (audit_trail_id, performed_at);


--
-- Name: company company_company_code_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company
    ADD CONSTRAINT company_company_code_key UNIQUE (company_code);


--
-- Name: company_license company_license_company_id_license_code_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_license
    ADD CONSTRAINT company_license_company_id_license_code_key UNIQUE (company_id, license_code);


--
-- Name: company_license company_license_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_license
    ADD CONSTRAINT company_license_pkey PRIMARY KEY (company_license_id);


--
-- Name: company_permission company_permission_company_id_permission_code_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_permission
    ADD CONSTRAINT company_permission_company_id_permission_code_key UNIQUE (company_id, permission_code);


--
-- Name: company_permission company_permission_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_permission
    ADD CONSTRAINT company_permission_pkey PRIMARY KEY (company_permission_id);


--
-- Name: company company_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company
    ADD CONSTRAINT company_pkey PRIMARY KEY (company_id);


--
-- Name: company_users company_users_company_id_user_id_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_users
    ADD CONSTRAINT company_users_company_id_user_id_key UNIQUE (company_id, user_id);


--
-- Name: company_users company_users_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_users
    ADD CONSTRAINT company_users_pkey PRIMARY KEY (company_user_id);


--
-- Name: document_sequence document_sequence_company_id_doc_type_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.document_sequence
    ADD CONSTRAINT document_sequence_company_id_doc_type_key UNIQUE (company_id, doc_type);


--
-- Name: document_sequence document_sequence_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.document_sequence
    ADD CONSTRAINT document_sequence_pkey PRIMARY KEY (sequence_id);


--
-- Name: entity_attribute_def entity_attribute_def_entity_type_attribute_code_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.entity_attribute_def
    ADD CONSTRAINT entity_attribute_def_entity_type_attribute_code_key UNIQUE (entity_type, attribute_code);


--
-- Name: entity_attribute_def entity_attribute_def_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.entity_attribute_def
    ADD CONSTRAINT entity_attribute_def_pkey PRIMARY KEY (attribute_def_id);


--
-- Name: entity_attribute_value entity_attribute_value_entity_type_entity_id_attribute_def__key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.entity_attribute_value
    ADD CONSTRAINT entity_attribute_value_entity_type_entity_id_attribute_def__key UNIQUE (entity_type, entity_id, attribute_def_id);


--
-- Name: entity_attribute_value entity_attribute_value_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.entity_attribute_value
    ADD CONSTRAINT entity_attribute_value_pkey PRIMARY KEY (attribute_value_id);


--
-- Name: journal_entries journal_entries_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_entries
    ADD CONSTRAINT journal_entries_pkey PRIMARY KEY (journal_id);


--
-- Name: journal_lines journal_lines_journal_id_line_no_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_lines
    ADD CONSTRAINT journal_lines_journal_id_line_no_key UNIQUE (journal_id, line_no);


--
-- Name: journal_lines journal_lines_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_lines
    ADD CONSTRAINT journal_lines_pkey PRIMARY KEY (journal_line_id);


--
-- Name: journal_source_link journal_source_link_journal_id_source_type_source_id_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_source_link
    ADD CONSTRAINT journal_source_link_journal_id_source_type_source_id_key UNIQUE (journal_id, source_type, source_id);


--
-- Name: journal_source_link journal_source_link_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_source_link
    ADD CONSTRAINT journal_source_link_pkey PRIMARY KEY (journal_source_link_id);


--
-- Name: license_master license_master_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.license_master
    ADD CONSTRAINT license_master_pkey PRIMARY KEY (code);


--
-- Name: login_history login_history_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.login_history
    ADD CONSTRAINT login_history_pkey PRIMARY KEY (login_id);


--
-- Name: payment_method payment_method_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.payment_method
    ADD CONSTRAINT payment_method_pkey PRIMARY KEY (payment_method_code);


--
-- Name: payment_term payment_term_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.payment_term
    ADD CONSTRAINT payment_term_pkey PRIMARY KEY (payment_term_id);


--
-- Name: payment_term payment_term_term_code_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.payment_term
    ADD CONSTRAINT payment_term_term_code_key UNIQUE (term_code);


--
-- Name: permission_group_permissions permission_group_permissions_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.permission_group_permissions
    ADD CONSTRAINT permission_group_permissions_pkey PRIMARY KEY (group_id, permission_id);


--
-- Name: permission_groups permission_groups_company_id_group_code_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.permission_groups
    ADD CONSTRAINT permission_groups_company_id_group_code_key UNIQUE (company_id, group_code);


--
-- Name: permission_groups permission_groups_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.permission_groups
    ADD CONSTRAINT permission_groups_pkey PRIMARY KEY (group_id);


--
-- Name: permissions permissions_company_id_code_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.permissions
    ADD CONSTRAINT permissions_company_id_code_key UNIQUE (company_id, code);


--
-- Name: permissions permissions_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.permissions
    ADD CONSTRAINT permissions_pkey PRIMARY KEY (permission_id);


--
-- Name: posting_profile posting_profile_company_id_profile_code_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.posting_profile
    ADD CONSTRAINT posting_profile_company_id_profile_code_key UNIQUE (company_id, profile_code);


--
-- Name: posting_profile posting_profile_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.posting_profile
    ADD CONSTRAINT posting_profile_pkey PRIMARY KEY (posting_profile_id);


--
-- Name: reason_code_master reason_code_master_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.reason_code_master
    ADD CONSTRAINT reason_code_master_pkey PRIMARY KEY (reason_code);


--
-- Name: status_history status_history_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.status_history
    ADD CONSTRAINT status_history_pkey PRIMARY KEY (status_history_id);


--
-- Name: status_master status_master_entity_type_status_code_key; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.status_master
    ADD CONSTRAINT status_master_entity_type_status_code_key UNIQUE (entity_type, status_code);


--
-- Name: status_master status_master_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.status_master
    ADD CONSTRAINT status_master_pkey PRIMARY KEY (status_id);


--
-- Name: sync_queue sync_queue_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.sync_queue
    ADD CONSTRAINT sync_queue_pkey PRIMARY KEY (sync_id);


--
-- Name: uom_conversion uom_conversion_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.uom_conversion
    ADD CONSTRAINT uom_conversion_pkey PRIMARY KEY (from_uom_code, to_uom_code);


--
-- Name: uom uom_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.uom
    ADD CONSTRAINT uom_pkey PRIMARY KEY (uom_code);


--
-- Name: user_permissions user_permissions_pkey; Type: CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.user_permissions
    ADD CONSTRAINT user_permissions_pkey PRIMARY KEY (user_id, permission_id);


--
-- Name: codegen_artifact codegen_artifact_pkey; Type: CONSTRAINT; Schema: devops; Owner: -
--

ALTER TABLE ONLY devops.codegen_artifact
    ADD CONSTRAINT codegen_artifact_pkey PRIMARY KEY (artifact_id);


--
-- Name: codegen_run codegen_run_pkey; Type: CONSTRAINT; Schema: devops; Owner: -
--

ALTER TABLE ONLY devops.codegen_run
    ADD CONSTRAINT codegen_run_pkey PRIMARY KEY (run_id);


--
-- Name: bank_account bank_account_pkey; Type: CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_account
    ADD CONSTRAINT bank_account_pkey PRIMARY KEY (bank_account_id);


--
-- Name: bank_statement_header bank_statement_header_bank_account_id_statement_date_key; Type: CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_statement_header
    ADD CONSTRAINT bank_statement_header_bank_account_id_statement_date_key UNIQUE (bank_account_id, statement_date);


--
-- Name: bank_statement_header bank_statement_header_pkey; Type: CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_statement_header
    ADD CONSTRAINT bank_statement_header_pkey PRIMARY KEY (bank_statement_id);


--
-- Name: bank_statement_line bank_statement_line_bank_statement_id_line_no_key; Type: CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_statement_line
    ADD CONSTRAINT bank_statement_line_bank_statement_id_line_no_key UNIQUE (bank_statement_id, line_no);


--
-- Name: bank_statement_line bank_statement_line_pkey; Type: CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_statement_line
    ADD CONSTRAINT bank_statement_line_pkey PRIMARY KEY (bank_statement_line_id);


--
-- Name: payment_allocation payment_allocation_pkey; Type: CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.payment_allocation
    ADD CONSTRAINT payment_allocation_pkey PRIMARY KEY (payment_allocation_id);


--
-- Name: payment payment_pkey; Type: CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.payment
    ADD CONSTRAINT payment_pkey PRIMARY KEY (payment_id);


--
-- Name: business_rule_action business_rule_action_pkey; Type: CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.business_rule_action
    ADD CONSTRAINT business_rule_action_pkey PRIMARY KEY (rule_action_id);


--
-- Name: business_rule business_rule_company_id_rule_code_key; Type: CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.business_rule
    ADD CONSTRAINT business_rule_company_id_rule_code_key UNIQUE (company_id, rule_code);


--
-- Name: business_rule_condition business_rule_condition_pkey; Type: CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.business_rule_condition
    ADD CONSTRAINT business_rule_condition_pkey PRIMARY KEY (rule_condition_id);


--
-- Name: business_rule business_rule_pkey; Type: CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.business_rule
    ADD CONSTRAINT business_rule_pkey PRIMARY KEY (business_rule_id);


--
-- Name: contract_header contract_header_pkey; Type: CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.contract_header
    ADD CONSTRAINT contract_header_pkey PRIMARY KEY (contract_id);


--
-- Name: contract_item_price contract_item_price_pkey; Type: CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.contract_item_price
    ADD CONSTRAINT contract_item_price_pkey PRIMARY KEY (contract_item_price_id);


--
-- Name: document_archive document_archive_pkey; Type: CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.document_archive
    ADD CONSTRAINT document_archive_pkey PRIMARY KEY (document_archive_id);


--
-- Name: document_category document_category_category_code_key; Type: CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.document_category
    ADD CONSTRAINT document_category_category_code_key UNIQUE (category_code);


--
-- Name: document_category document_category_pkey; Type: CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.document_category
    ADD CONSTRAINT document_category_pkey PRIMARY KEY (document_category_id);


--
-- Name: policy_change_queue policy_change_queue_pkey; Type: CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.policy_change_queue
    ADD CONSTRAINT policy_change_queue_pkey PRIMARY KEY (policy_change_id);


--
-- Name: attendance_log attendance_log_company_id_employee_id_work_date_key; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.attendance_log
    ADD CONSTRAINT attendance_log_company_id_employee_id_work_date_key UNIQUE (company_id, employee_id, work_date);


--
-- Name: attendance_log attendance_log_pkey; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.attendance_log
    ADD CONSTRAINT attendance_log_pkey PRIMARY KEY (attendance_log_id);


--
-- Name: employee employee_company_id_employee_code_key; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.employee
    ADD CONSTRAINT employee_company_id_employee_code_key UNIQUE (company_id, employee_code);


--
-- Name: employee employee_pkey; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.employee
    ADD CONSTRAINT employee_pkey PRIMARY KEY (employee_id);


--
-- Name: employment_contract employment_contract_pkey; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.employment_contract
    ADD CONSTRAINT employment_contract_pkey PRIMARY KEY (employment_contract_id);


--
-- Name: hr_department hr_department_company_id_department_code_key; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.hr_department
    ADD CONSTRAINT hr_department_company_id_department_code_key UNIQUE (company_id, department_code);


--
-- Name: hr_department hr_department_pkey; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.hr_department
    ADD CONSTRAINT hr_department_pkey PRIMARY KEY (department_id);


--
-- Name: hr_position hr_position_company_id_position_code_key; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.hr_position
    ADD CONSTRAINT hr_position_company_id_position_code_key UNIQUE (company_id, position_code);


--
-- Name: hr_position hr_position_pkey; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.hr_position
    ADD CONSTRAINT hr_position_pkey PRIMARY KEY (position_id);


--
-- Name: leave_request leave_request_pkey; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.leave_request
    ADD CONSTRAINT leave_request_pkey PRIMARY KEY (leave_request_id);


--
-- Name: leave_type leave_type_pkey; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.leave_type
    ADD CONSTRAINT leave_type_pkey PRIMARY KEY (leave_type_code);


--
-- Name: payroll_run payroll_run_company_id_pay_month_key; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.payroll_run
    ADD CONSTRAINT payroll_run_company_id_pay_month_key UNIQUE (company_id, pay_month);


--
-- Name: payroll_run payroll_run_pkey; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.payroll_run
    ADD CONSTRAINT payroll_run_pkey PRIMARY KEY (payroll_run_id);


--
-- Name: payroll_slip payroll_slip_payroll_run_id_employee_id_key; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.payroll_slip
    ADD CONSTRAINT payroll_slip_payroll_run_id_employee_id_key UNIQUE (payroll_run_id, employee_id);


--
-- Name: payroll_slip payroll_slip_pkey; Type: CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.payroll_slip
    ADD CONSTRAINT payroll_slip_pkey PRIMARY KEY (payroll_slip_id);


--
-- Name: api_credential api_credential_pkey; Type: CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.api_credential
    ADD CONSTRAINT api_credential_pkey PRIMARY KEY (api_credential_id);


--
-- Name: audit_export_queue audit_export_queue_pkey; Type: CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.audit_export_queue
    ADD CONSTRAINT audit_export_queue_pkey PRIMARY KEY (export_id);


--
-- Name: external_system external_system_company_id_system_code_key; Type: CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.external_system
    ADD CONSTRAINT external_system_company_id_system_code_key UNIQUE (company_id, system_code);


--
-- Name: external_system external_system_pkey; Type: CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.external_system
    ADD CONSTRAINT external_system_pkey PRIMARY KEY (external_system_id);


--
-- Name: integration_job integration_job_pkey; Type: CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.integration_job
    ADD CONSTRAINT integration_job_pkey PRIMARY KEY (integration_job_id);


--
-- Name: integration_log integration_log_pkey; Type: CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.integration_log
    ADD CONSTRAINT integration_log_pkey PRIMARY KEY (integration_log_id);


--
-- Name: siem_delivery_queue siem_delivery_queue_endpoint_id_audit_trail_id_key; Type: CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.siem_delivery_queue
    ADD CONSTRAINT siem_delivery_queue_endpoint_id_audit_trail_id_key UNIQUE (endpoint_id, audit_trail_id);


--
-- Name: siem_delivery_queue siem_delivery_queue_pkey; Type: CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.siem_delivery_queue
    ADD CONSTRAINT siem_delivery_queue_pkey PRIMARY KEY (delivery_id);


--
-- Name: siem_endpoint siem_endpoint_pkey; Type: CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.siem_endpoint
    ADD CONSTRAINT siem_endpoint_pkey PRIMARY KEY (endpoint_id);


--
-- Name: inventory_valuation inventory_valuation_company_id_item_id_valuation_date_key; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.inventory_valuation
    ADD CONSTRAINT inventory_valuation_company_id_item_id_valuation_date_key UNIQUE (company_id, item_id, valuation_date);


--
-- Name: inventory_valuation inventory_valuation_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.inventory_valuation
    ADD CONSTRAINT inventory_valuation_pkey PRIMARY KEY (inventory_valuation_id);


--
-- Name: stock_balance stock_balance_company_id_bin_id_item_id_key; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_balance
    ADD CONSTRAINT stock_balance_company_id_bin_id_item_id_key UNIQUE (company_id, bin_id, item_id);


--
-- Name: stock_balance stock_balance_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_balance
    ADD CONSTRAINT stock_balance_pkey PRIMARY KEY (stock_balance_id);


--
-- Name: stock_bin stock_bin_company_id_location_id_bin_code_key; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_bin
    ADD CONSTRAINT stock_bin_company_id_location_id_bin_code_key UNIQUE (company_id, location_id, bin_code);


--
-- Name: stock_bin stock_bin_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_bin
    ADD CONSTRAINT stock_bin_pkey PRIMARY KEY (bin_id);


--
-- Name: stock_lot_balance stock_lot_balance_company_id_bin_id_item_id_stock_lot_id_key; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot_balance
    ADD CONSTRAINT stock_lot_balance_company_id_bin_id_item_id_stock_lot_id_key UNIQUE (company_id, bin_id, item_id, stock_lot_id);


--
-- Name: stock_lot_balance stock_lot_balance_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot_balance
    ADD CONSTRAINT stock_lot_balance_pkey PRIMARY KEY (stock_lot_balance_id);


--
-- Name: stock_lot stock_lot_company_id_item_id_lot_no_serial_no_key; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot
    ADD CONSTRAINT stock_lot_company_id_item_id_lot_no_serial_no_key UNIQUE (company_id, item_id, lot_no, serial_no);


--
-- Name: stock_lot stock_lot_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot
    ADD CONSTRAINT stock_lot_pkey PRIMARY KEY (stock_lot_id);


--
-- Name: stock_reservation stock_reservation_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_reservation
    ADD CONSTRAINT stock_reservation_pkey PRIMARY KEY (stock_reservation_id);


--
-- Name: stock_transaction stock_transaction_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transaction
    ADD CONSTRAINT stock_transaction_pkey PRIMARY KEY (stock_tx_id);


--
-- Name: stock_transfer_detail stock_transfer_detail_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_detail
    ADD CONSTRAINT stock_transfer_detail_pkey PRIMARY KEY (stock_transfer_detail_id);


--
-- Name: stock_transfer_detail stock_transfer_detail_stock_transfer_id_line_no_key; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_detail
    ADD CONSTRAINT stock_transfer_detail_stock_transfer_id_line_no_key UNIQUE (stock_transfer_id, line_no);


--
-- Name: stock_transfer_header stock_transfer_header_company_id_transfer_no_key; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_header
    ADD CONSTRAINT stock_transfer_header_company_id_transfer_no_key UNIQUE (company_id, transfer_no);


--
-- Name: stock_transfer_header stock_transfer_header_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_header
    ADD CONSTRAINT stock_transfer_header_pkey PRIMARY KEY (stock_transfer_id);


--
-- Name: stocktaking_plan stocktaking_plan_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stocktaking_plan
    ADD CONSTRAINT stocktaking_plan_pkey PRIMARY KEY (stocktaking_plan_id);


--
-- Name: stocktaking_result stocktaking_result_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stocktaking_result
    ADD CONSTRAINT stocktaking_result_pkey PRIMARY KEY (stocktaking_result_id);


--
-- Name: storage_location storage_location_company_id_warehouse_id_location_code_key; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.storage_location
    ADD CONSTRAINT storage_location_company_id_warehouse_id_location_code_key UNIQUE (company_id, warehouse_id, location_code);


--
-- Name: storage_location storage_location_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.storage_location
    ADD CONSTRAINT storage_location_pkey PRIMARY KEY (location_id);


--
-- Name: warehouse warehouse_company_id_warehouse_code_key; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.warehouse
    ADD CONSTRAINT warehouse_company_id_warehouse_code_key UNIQUE (company_id, warehouse_code);


--
-- Name: warehouse warehouse_pkey; Type: CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.warehouse
    ADD CONSTRAINT warehouse_pkey PRIMARY KEY (warehouse_id);


--
-- Name: bom_detail bom_detail_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.bom_detail
    ADD CONSTRAINT bom_detail_pkey PRIMARY KEY (bom_detail_id);


--
-- Name: bom_header bom_header_company_id_parent_item_id_version_key; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.bom_header
    ADD CONSTRAINT bom_header_company_id_parent_item_id_version_key UNIQUE (company_id, parent_item_id, version);


--
-- Name: bom_header bom_header_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.bom_header
    ADD CONSTRAINT bom_header_pkey PRIMARY KEY (bom_id);


--
-- Name: manufacturing_cost_snapshot manufacturing_cost_snapshot_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_cost_snapshot
    ADD CONSTRAINT manufacturing_cost_snapshot_pkey PRIMARY KEY (manufacturing_cost_snapshot_id);


--
-- Name: manufacturing_cost_snapshot manufacturing_cost_snapshot_work_order_id_key; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_cost_snapshot
    ADD CONSTRAINT manufacturing_cost_snapshot_work_order_id_key UNIQUE (work_order_id);


--
-- Name: manufacturing_execution_detail manufacturing_execution_detail_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_execution_detail
    ADD CONSTRAINT manufacturing_execution_detail_pkey PRIMARY KEY (execution_detail_id);


--
-- Name: manufacturing_execution manufacturing_execution_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_execution
    ADD CONSTRAINT manufacturing_execution_pkey PRIMARY KEY (execution_id);


--
-- Name: mps_plan mps_plan_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mps_plan
    ADD CONSTRAINT mps_plan_pkey PRIMARY KEY (mps_plan_id);


--
-- Name: mps_run mps_run_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mps_run
    ADD CONSTRAINT mps_run_pkey PRIMARY KEY (mps_run_id);


--
-- Name: mrp_allocation mrp_allocation_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mrp_allocation
    ADD CONSTRAINT mrp_allocation_pkey PRIMARY KEY (mrp_allocation_id);


--
-- Name: mrp_requirement mrp_requirement_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mrp_requirement
    ADD CONSTRAINT mrp_requirement_pkey PRIMARY KEY (mrp_requirement_id);


--
-- Name: mrp_run mrp_run_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mrp_run
    ADD CONSTRAINT mrp_run_pkey PRIMARY KEY (mrp_run_id);


--
-- Name: process_master process_master_company_id_process_code_key; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.process_master
    ADD CONSTRAINT process_master_company_id_process_code_key UNIQUE (company_id, process_code);


--
-- Name: process_master process_master_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.process_master
    ADD CONSTRAINT process_master_pkey PRIMARY KEY (process_id);


--
-- Name: routing_header routing_header_company_id_item_id_version_key; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.routing_header
    ADD CONSTRAINT routing_header_company_id_item_id_version_key UNIQUE (company_id, item_id, version);


--
-- Name: routing_header routing_header_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.routing_header
    ADD CONSTRAINT routing_header_pkey PRIMARY KEY (routing_id);


--
-- Name: routing_operation routing_operation_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.routing_operation
    ADD CONSTRAINT routing_operation_pkey PRIMARY KEY (routing_operation_id);


--
-- Name: routing_operation routing_operation_routing_id_operation_no_key; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.routing_operation
    ADD CONSTRAINT routing_operation_routing_id_operation_no_key UNIQUE (routing_id, operation_no);


--
-- Name: work_order work_order_company_id_wo_no_key; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.work_order
    ADD CONSTRAINT work_order_company_id_wo_no_key UNIQUE (company_id, wo_no);


--
-- Name: work_order work_order_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.work_order
    ADD CONSTRAINT work_order_pkey PRIMARY KEY (work_order_id);


--
-- Name: yield_metric yield_metric_pkey; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.yield_metric
    ADD CONSTRAINT yield_metric_pkey PRIMARY KEY (yield_metric_id);


--
-- Name: yield_metric yield_metric_process_id_metric_date_key; Type: CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.yield_metric
    ADD CONSTRAINT yield_metric_process_id_metric_date_key UNIQUE (process_id, metric_date);


--
-- Name: asset_link asset_link_pkey; Type: CONSTRAINT; Schema: media; Owner: -
--

ALTER TABLE ONLY media.asset_link
    ADD CONSTRAINT asset_link_pkey PRIMARY KEY (asset_id, entity_table, entity_id, role);


--
-- Name: asset asset_pkey; Type: CONSTRAINT; Schema: media; Owner: -
--

ALTER TABLE ONLY media.asset
    ADD CONSTRAINT asset_pkey PRIMARY KEY (asset_id);


--
-- Name: ai_event ai_event_pkey; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.ai_event
    ADD CONSTRAINT ai_event_pkey PRIMARY KEY (ai_event_id);


--
-- Name: ai_rule ai_rule_company_id_rule_key_key; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.ai_rule
    ADD CONSTRAINT ai_rule_company_id_rule_key_key UNIQUE (company_id, rule_key);


--
-- Name: ai_rule ai_rule_pkey; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.ai_rule
    ADD CONSTRAINT ai_rule_pkey PRIMARY KEY (ai_rule_id);


--
-- Name: approval_action_log approval_action_log_pkey; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.approval_action_log
    ADD CONSTRAINT approval_action_log_pkey PRIMARY KEY (action_log_id);


--
-- Name: approval_request approval_request_pkey; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.approval_request
    ADD CONSTRAINT approval_request_pkey PRIMARY KEY (approval_request_id);


--
-- Name: audit_trail audit_trail_pkey; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.audit_trail
    ADD CONSTRAINT audit_trail_pkey PRIMARY KEY (audit_id);


--
-- Name: notification_log notification_log_pkey; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.notification_log
    ADD CONSTRAINT notification_log_pkey PRIMARY KEY (notification_id);


--
-- Name: notification_route notification_route_company_id_route_key_line_user_id_key; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.notification_route
    ADD CONSTRAINT notification_route_company_id_route_key_line_user_id_key UNIQUE (company_id, route_key, line_user_id);


--
-- Name: notification_route notification_route_pkey; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.notification_route
    ADD CONSTRAINT notification_route_pkey PRIMARY KEY (route_id);


--
-- Name: notification_template notification_template_company_id_template_key_key; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.notification_template
    ADD CONSTRAINT notification_template_company_id_template_key_key UNIQUE (company_id, template_key);


--
-- Name: notification_template notification_template_pkey; Type: CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.notification_template
    ADD CONSTRAINT notification_template_pkey PRIMARY KEY (template_id);


--
-- Name: approval_rule approval_rule_domain_event_type_key; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.approval_rule
    ADD CONSTRAINT approval_rule_domain_event_type_key UNIQUE (domain, event_type);


--
-- Name: approval_rule approval_rule_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.approval_rule
    ADD CONSTRAINT approval_rule_pkey PRIMARY KEY (rule_id);


--
-- Name: backup_log backup_log_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.backup_log
    ADD CONSTRAINT backup_log_pkey PRIMARY KEY (backup_id);


--
-- Name: business_event business_event_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.business_event
    ADD CONSTRAINT business_event_pkey PRIMARY KEY (event_id);


--
-- Name: document_file document_file_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_file
    ADD CONSTRAINT document_file_pkey PRIMARY KEY (document_file_id);


--
-- Name: document_send_history document_send_history_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_send_history
    ADD CONSTRAINT document_send_history_pkey PRIMARY KEY (send_history_id);


--
-- Name: document_send_queue document_send_queue_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_send_queue
    ADD CONSTRAINT document_send_queue_pkey PRIMARY KEY (send_queue_id);


--
-- Name: document_type_master document_type_master_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_type_master
    ADD CONSTRAINT document_type_master_pkey PRIMARY KEY (document_type_code);


--
-- Name: notification_outbox notification_outbox_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.notification_outbox
    ADD CONSTRAINT notification_outbox_pkey PRIMARY KEY (notification_id);


--
-- Name: ops_idempotency ops_idempotency_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.ops_idempotency
    ADD CONSTRAINT ops_idempotency_pkey PRIMARY KEY (idempotency_key);


--
-- Name: ops_job_queue ops_job_queue_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.ops_job_queue
    ADD CONSTRAINT ops_job_queue_pkey PRIMARY KEY (job_id);


--
-- Name: ops_job_result ops_job_result_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.ops_job_result
    ADD CONSTRAINT ops_job_result_pkey PRIMARY KEY (job_id);


--
-- Name: pdf_generate_queue pdf_generate_queue_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.pdf_generate_queue
    ADD CONSTRAINT pdf_generate_queue_pkey PRIMARY KEY (queue_id);


--
-- Name: resend_type_master resend_type_master_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.resend_type_master
    ADD CONSTRAINT resend_type_master_pkey PRIMARY KEY (resend_type_code);


--
-- Name: runtime_flag runtime_flag_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.runtime_flag
    ADD CONSTRAINT runtime_flag_pkey PRIMARY KEY (flag_key);


--
-- Name: runtime_health runtime_health_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.runtime_health
    ADD CONSTRAINT runtime_health_pkey PRIMARY KEY (health_id);


--
-- Name: send_channel_master send_channel_master_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.send_channel_master
    ADD CONSTRAINT send_channel_master_pkey PRIMARY KEY (channel_code);


--
-- Name: send_fee_master send_fee_master_document_type_code_resend_type_code_key; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.send_fee_master
    ADD CONSTRAINT send_fee_master_document_type_code_resend_type_code_key UNIQUE (document_type_code, resend_type_code);


--
-- Name: send_fee_master send_fee_master_pkey; Type: CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.send_fee_master
    ADD CONSTRAINT send_fee_master_pkey PRIMARY KEY (fee_id);


--
-- Name: purchase_invoice purchase_invoice_company_id_invoice_no_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice
    ADD CONSTRAINT purchase_invoice_company_id_invoice_no_key UNIQUE (company_id, invoice_no);


--
-- Name: purchase_invoice_detail purchase_invoice_detail_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice_detail
    ADD CONSTRAINT purchase_invoice_detail_pkey PRIMARY KEY (purchase_invoice_detail_id);


--
-- Name: purchase_invoice_detail purchase_invoice_detail_purchase_invoice_id_line_no_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice_detail
    ADD CONSTRAINT purchase_invoice_detail_purchase_invoice_id_line_no_key UNIQUE (purchase_invoice_id, line_no);


--
-- Name: purchase_invoice purchase_invoice_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice
    ADD CONSTRAINT purchase_invoice_pkey PRIMARY KEY (purchase_invoice_id);


--
-- Name: purchase_order_detail purchase_order_detail_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_detail
    ADD CONSTRAINT purchase_order_detail_pkey PRIMARY KEY (purchase_order_detail_id);


--
-- Name: purchase_order_detail purchase_order_detail_purchase_order_id_line_no_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_detail
    ADD CONSTRAINT purchase_order_detail_purchase_order_id_line_no_key UNIQUE (purchase_order_id, line_no);


--
-- Name: purchase_order_header purchase_order_header_company_id_purchase_order_no_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_header
    ADD CONSTRAINT purchase_order_header_company_id_purchase_order_no_key UNIQUE (company_id, purchase_order_no);


--
-- Name: purchase_order_header purchase_order_header_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_header
    ADD CONSTRAINT purchase_order_header_pkey PRIMARY KEY (purchase_order_id);


--
-- Name: purchase_quotation_detail purchase_quotation_detail_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_quotation_detail
    ADD CONSTRAINT purchase_quotation_detail_pkey PRIMARY KEY (purchase_quotation_detail_id);


--
-- Name: purchase_quotation_detail purchase_quotation_detail_purchase_quotation_id_line_no_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_quotation_detail
    ADD CONSTRAINT purchase_quotation_detail_purchase_quotation_id_line_no_key UNIQUE (purchase_quotation_id, line_no);


--
-- Name: purchase_quotation purchase_quotation_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_quotation
    ADD CONSTRAINT purchase_quotation_pkey PRIMARY KEY (purchase_quotation_id);


--
-- Name: purchase_receipt_detail purchase_receipt_detail_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt_detail
    ADD CONSTRAINT purchase_receipt_detail_pkey PRIMARY KEY (receipt_detail_id);


--
-- Name: purchase_receipt_detail purchase_receipt_detail_receipt_id_line_no_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt_detail
    ADD CONSTRAINT purchase_receipt_detail_receipt_id_line_no_key UNIQUE (receipt_id, line_no);


--
-- Name: purchase_receipt purchase_receipt_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt
    ADD CONSTRAINT purchase_receipt_pkey PRIMARY KEY (receipt_id);


--
-- Name: purchase_requisition purchase_requisition_company_id_requisition_no_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_requisition
    ADD CONSTRAINT purchase_requisition_company_id_requisition_no_key UNIQUE (company_id, requisition_no);


--
-- Name: purchase_requisition_detail purchase_requisition_detail_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_requisition_detail
    ADD CONSTRAINT purchase_requisition_detail_pkey PRIMARY KEY (purchase_requisition_detail_id);


--
-- Name: purchase_requisition_detail purchase_requisition_detail_purchase_requisition_id_line_no_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_requisition_detail
    ADD CONSTRAINT purchase_requisition_detail_purchase_requisition_id_line_no_key UNIQUE (purchase_requisition_id, line_no);


--
-- Name: purchase_requisition purchase_requisition_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_requisition
    ADD CONSTRAINT purchase_requisition_pkey PRIMARY KEY (purchase_requisition_id);


--
-- Name: purchase_three_way_match purchase_three_way_match_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_three_way_match
    ADD CONSTRAINT purchase_three_way_match_pkey PRIMARY KEY (purchase_three_way_match_id);


--
-- Name: supplier_address supplier_address_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_address
    ADD CONSTRAINT supplier_address_pkey PRIMARY KEY (supplier_address_id);


--
-- Name: supplier_contact supplier_contact_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_contact
    ADD CONSTRAINT supplier_contact_pkey PRIMARY KEY (supplier_contact_id);


--
-- Name: supplier_item_price supplier_item_price_company_id_supplier_id_item_id_valid_fr_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_item_price
    ADD CONSTRAINT supplier_item_price_company_id_supplier_id_item_id_valid_fr_key UNIQUE (company_id, supplier_id, item_id, valid_from);


--
-- Name: supplier_item_price supplier_item_price_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_item_price
    ADD CONSTRAINT supplier_item_price_pkey PRIMARY KEY (supplier_item_price_id);


--
-- Name: supplier_master supplier_master_company_id_supplier_code_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_master
    ADD CONSTRAINT supplier_master_company_id_supplier_code_key UNIQUE (company_id, supplier_code);


--
-- Name: supplier_master supplier_master_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_master
    ADD CONSTRAINT supplier_master_pkey PRIMARY KEY (supplier_id);


--
-- Name: supplier_payment_term supplier_payment_term_pkey; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_payment_term
    ADD CONSTRAINT supplier_payment_term_pkey PRIMARY KEY (supplier_payment_term_id);


--
-- Name: supplier_payment_term supplier_payment_term_supplier_id_valid_from_key; Type: CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_payment_term
    ADD CONSTRAINT supplier_payment_term_supplier_id_valid_from_key UNIQUE (supplier_id, valid_from);


--
-- Name: messages messages_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -
--

ALTER TABLE ONLY realtime.messages
    ADD CONSTRAINT messages_pkey PRIMARY KEY (id, inserted_at);


--
-- Name: subscription pk_subscription; Type: CONSTRAINT; Schema: realtime; Owner: -
--

ALTER TABLE ONLY realtime.subscription
    ADD CONSTRAINT pk_subscription PRIMARY KEY (id);


--
-- Name: schema_migrations schema_migrations_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -
--

ALTER TABLE ONLY realtime.schema_migrations
    ADD CONSTRAINT schema_migrations_pkey PRIMARY KEY (version);


--
-- Name: billing_detail billing_detail_billing_id_line_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_detail
    ADD CONSTRAINT billing_detail_billing_id_line_no_key UNIQUE (billing_id, line_no);


--
-- Name: billing_detail billing_detail_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_detail
    ADD CONSTRAINT billing_detail_pkey PRIMARY KEY (billing_detail_id);


--
-- Name: billing_header billing_header_company_id_billing_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_header
    ADD CONSTRAINT billing_header_company_id_billing_no_key UNIQUE (company_id, billing_no);


--
-- Name: billing_header billing_header_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_header
    ADD CONSTRAINT billing_header_pkey PRIMARY KEY (billing_id);


--
-- Name: customer_address customer_address_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_address
    ADD CONSTRAINT customer_address_pkey PRIMARY KEY (customer_address_id);


--
-- Name: customer customer_company_id_customer_code_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer
    ADD CONSTRAINT customer_company_id_customer_code_key UNIQUE (company_id, customer_code);


--
-- Name: customer_contact customer_contact_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_contact
    ADD CONSTRAINT customer_contact_pkey PRIMARY KEY (customer_contact_id);


--
-- Name: customer_payment_term customer_payment_term_customer_id_valid_from_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_payment_term
    ADD CONSTRAINT customer_payment_term_customer_id_valid_from_key UNIQUE (customer_id, valid_from);


--
-- Name: customer_payment_term customer_payment_term_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_payment_term
    ADD CONSTRAINT customer_payment_term_pkey PRIMARY KEY (customer_payment_term_id);


--
-- Name: customer customer_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer
    ADD CONSTRAINT customer_pkey PRIMARY KEY (customer_id);


--
-- Name: invoice_pdf invoice_pdf_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.invoice_pdf
    ADD CONSTRAINT invoice_pdf_pkey PRIMARY KEY (invoice_pdf_id);


--
-- Name: item_category item_category_company_id_category_code_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_category
    ADD CONSTRAINT item_category_company_id_category_code_key UNIQUE (company_id, category_code);


--
-- Name: item_category item_category_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_category
    ADD CONSTRAINT item_category_pkey PRIMARY KEY (item_category_id);


--
-- Name: item item_company_id_item_code_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item
    ADD CONSTRAINT item_company_id_item_code_key UNIQUE (company_id, item_code);


--
-- Name: item item_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item
    ADD CONSTRAINT item_pkey PRIMARY KEY (item_id);


--
-- Name: item_price_master item_price_master_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_price_master
    ADD CONSTRAINT item_price_master_pkey PRIMARY KEY (item_price_id);


--
-- Name: item_uom item_uom_item_id_uom_code_usage_type_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_uom
    ADD CONSTRAINT item_uom_item_id_uom_code_usage_type_key UNIQUE (item_id, uom_code, usage_type);


--
-- Name: item_uom item_uom_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_uom
    ADD CONSTRAINT item_uom_pkey PRIMARY KEY (item_uom_id);


--
-- Name: order_detail order_detail_order_id_line_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_detail
    ADD CONSTRAINT order_detail_order_id_line_no_key UNIQUE (order_id, line_no);


--
-- Name: order_detail order_detail_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_detail
    ADD CONSTRAINT order_detail_pkey PRIMARY KEY (order_detail_id);


--
-- Name: order_header order_header_company_id_order_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_header
    ADD CONSTRAINT order_header_company_id_order_no_key UNIQUE (company_id, order_no);


--
-- Name: order_header order_header_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_header
    ADD CONSTRAINT order_header_pkey PRIMARY KEY (order_id);


--
-- Name: quotation_order_link quotation_order_link_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.quotation_order_link
    ADD CONSTRAINT quotation_order_link_pkey PRIMARY KEY (quotation_order_link_id);


--
-- Name: quotation_order_link quotation_order_link_quotation_id_order_id_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.quotation_order_link
    ADD CONSTRAINT quotation_order_link_quotation_id_order_id_key UNIQUE (quotation_id, order_id);


--
-- Name: return_detail return_detail_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_detail
    ADD CONSTRAINT return_detail_pkey PRIMARY KEY (return_detail_id);


--
-- Name: return_detail return_detail_return_id_line_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_detail
    ADD CONSTRAINT return_detail_return_id_line_no_key UNIQUE (return_id, line_no);


--
-- Name: return_header return_header_company_id_return_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_header
    ADD CONSTRAINT return_header_company_id_return_no_key UNIQUE (company_id, return_no);


--
-- Name: return_header return_header_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_header
    ADD CONSTRAINT return_header_pkey PRIMARY KEY (return_id);


--
-- Name: sales_quotation sales_quotation_company_id_quotation_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation
    ADD CONSTRAINT sales_quotation_company_id_quotation_no_key UNIQUE (company_id, quotation_no);


--
-- Name: sales_quotation_detail sales_quotation_detail_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation_detail
    ADD CONSTRAINT sales_quotation_detail_pkey PRIMARY KEY (sales_quotation_detail_id);


--
-- Name: sales_quotation_detail sales_quotation_detail_sales_quotation_id_line_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation_detail
    ADD CONSTRAINT sales_quotation_detail_sales_quotation_id_line_no_key UNIQUE (sales_quotation_id, line_no);


--
-- Name: sales_quotation sales_quotation_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation
    ADD CONSTRAINT sales_quotation_pkey PRIMARY KEY (sales_quotation_id);


--
-- Name: shipping_detail shipping_detail_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_detail
    ADD CONSTRAINT shipping_detail_pkey PRIMARY KEY (shipping_detail_id);


--
-- Name: shipping_detail shipping_detail_shipping_id_line_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_detail
    ADD CONSTRAINT shipping_detail_shipping_id_line_no_key UNIQUE (shipping_id, line_no);


--
-- Name: shipping_header shipping_header_company_id_shipping_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_header
    ADD CONSTRAINT shipping_header_company_id_shipping_no_key UNIQUE (company_id, shipping_no);


--
-- Name: shipping_header shipping_header_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_header
    ADD CONSTRAINT shipping_header_pkey PRIMARY KEY (shipping_id);


--
-- Name: shipping_revision shipping_revision_pkey; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_revision
    ADD CONSTRAINT shipping_revision_pkey PRIMARY KEY (shipping_revision_id);


--
-- Name: shipping_revision shipping_revision_shipping_id_revision_no_key; Type: CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_revision
    ADD CONSTRAINT shipping_revision_shipping_id_revision_no_key UNIQUE (shipping_id, revision_no);


--
-- Name: buckets_analytics buckets_analytics_pkey; Type: CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.buckets_analytics
    ADD CONSTRAINT buckets_analytics_pkey PRIMARY KEY (id);


--
-- Name: buckets buckets_pkey; Type: CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.buckets
    ADD CONSTRAINT buckets_pkey PRIMARY KEY (id);


--
-- Name: buckets_vectors buckets_vectors_pkey; Type: CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.buckets_vectors
    ADD CONSTRAINT buckets_vectors_pkey PRIMARY KEY (id);


--
-- Name: migrations migrations_name_key; Type: CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.migrations
    ADD CONSTRAINT migrations_name_key UNIQUE (name);


--
-- Name: migrations migrations_pkey; Type: CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.migrations
    ADD CONSTRAINT migrations_pkey PRIMARY KEY (id);


--
-- Name: objects objects_pkey; Type: CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.objects
    ADD CONSTRAINT objects_pkey PRIMARY KEY (id);


--
-- Name: prefixes prefixes_pkey; Type: CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.prefixes
    ADD CONSTRAINT prefixes_pkey PRIMARY KEY (bucket_id, level, name);


--
-- Name: s3_multipart_uploads_parts s3_multipart_uploads_parts_pkey; Type: CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.s3_multipart_uploads_parts
    ADD CONSTRAINT s3_multipart_uploads_parts_pkey PRIMARY KEY (id);


--
-- Name: s3_multipart_uploads s3_multipart_uploads_pkey; Type: CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.s3_multipart_uploads
    ADD CONSTRAINT s3_multipart_uploads_pkey PRIMARY KEY (id);


--
-- Name: vector_indexes vector_indexes_pkey; Type: CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.vector_indexes
    ADD CONSTRAINT vector_indexes_pkey PRIMARY KEY (id);


--
-- Name: action_approval_map action_approval_map_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.action_approval_map
    ADD CONSTRAINT action_approval_map_pkey PRIMARY KEY (action_code, function_code);


--
-- Name: ai_agent ai_agent_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.ai_agent
    ADD CONSTRAINT ai_agent_pkey PRIMARY KEY (agent_code);


--
-- Name: ai_signal ai_signal_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.ai_signal
    ADD CONSTRAINT ai_signal_pkey PRIMARY KEY (signal_id);


--
-- Name: ai_task ai_task_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.ai_task
    ADD CONSTRAINT ai_task_pkey PRIMARY KEY (task_id);


--
-- Name: ai_task_run ai_task_run_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.ai_task_run
    ADD CONSTRAINT ai_task_run_pkey PRIMARY KEY (run_id);


--
-- Name: approval_action_log approval_action_log_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_action_log
    ADD CONSTRAINT approval_action_log_pkey PRIMARY KEY (approval_action_id);


--
-- Name: approval_exec_map approval_exec_map_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_exec_map
    ADD CONSTRAINT approval_exec_map_pkey PRIMARY KEY (approval_flow_code);


--
-- Name: approval_finalize_rule approval_finalize_rule_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_finalize_rule
    ADD CONSTRAINT approval_finalize_rule_pkey PRIMARY KEY (function_code);


--
-- Name: approval_flow_def approval_flow_def_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_flow_def
    ADD CONSTRAINT approval_flow_def_pkey PRIMARY KEY (approval_flow_code);


--
-- Name: approval_request approval_request_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_request
    ADD CONSTRAINT approval_request_pkey PRIMARY KEY (approval_request_id);


--
-- Name: approval_step_def approval_step_def_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_step_def
    ADD CONSTRAINT approval_step_def_pkey PRIMARY KEY (approval_flow_code, step_no);


--
-- Name: business_finalize_event business_finalize_event_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.business_finalize_event
    ADD CONSTRAINT business_finalize_event_pkey PRIMARY KEY (function_code);


--
-- Name: business_ops_map business_ops_map_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.business_ops_map
    ADD CONSTRAINT business_ops_map_pkey PRIMARY KEY (function_code);


--
-- Name: db_session db_session_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.db_session
    ADD CONSTRAINT db_session_pkey PRIMARY KEY (session_id);


--
-- Name: exec_command exec_command_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.exec_command
    ADD CONSTRAINT exec_command_pkey PRIMARY KEY (command_code);


--
-- Name: exec_run_request exec_run_request_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.exec_run_request
    ADD CONSTRAINT exec_run_request_pkey PRIMARY KEY (request_id);


--
-- Name: function_def function_def_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.function_def
    ADD CONSTRAINT function_def_pkey PRIMARY KEY (function_code);


--
-- Name: loop_autotune_rule loop_autotune_rule_loop_code_key; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.loop_autotune_rule
    ADD CONSTRAINT loop_autotune_rule_loop_code_key UNIQUE (loop_code);


--
-- Name: loop_autotune_rule loop_autotune_rule_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.loop_autotune_rule
    ADD CONSTRAINT loop_autotune_rule_pkey PRIMARY KEY (rule_id);


--
-- Name: loop_config loop_config_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.loop_config
    ADD CONSTRAINT loop_config_pkey PRIMARY KEY (loop_code);


--
-- Name: loop_sla_stat loop_sla_stat_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.loop_sla_stat
    ADD CONSTRAINT loop_sla_stat_pkey PRIMARY KEY (stat_id);


--
-- Name: loop_tick_log loop_tick_log_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.loop_tick_log
    ADD CONSTRAINT loop_tick_log_pkey PRIMARY KEY (tick_id);


--
-- Name: module_def module_def_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.module_def
    ADD CONSTRAINT module_def_pkey PRIMARY KEY (module_code);


--
-- Name: notification_endpoint notification_endpoint_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.notification_endpoint
    ADD CONSTRAINT notification_endpoint_pkey PRIMARY KEY (endpoint_code);


--
-- Name: notification_subscription notification_subscription_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.notification_subscription
    ADD CONSTRAINT notification_subscription_pkey PRIMARY KEY (event_type, endpoint_code);


--
-- Name: operation_log operation_log_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.operation_log
    ADD CONSTRAINT operation_log_pkey PRIMARY KEY (operation_log_id);


--
-- Name: operation_type_def operation_type_def_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.operation_type_def
    ADD CONSTRAINT operation_type_def_pkey PRIMARY KEY (operation_type);


--
-- Name: role_def role_def_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.role_def
    ADD CONSTRAINT role_def_pkey PRIMARY KEY (role_code);


--
-- Name: role_screen_permission role_screen_permission_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.role_screen_permission
    ADD CONSTRAINT role_screen_permission_pkey PRIMARY KEY (role_code, screen_code);


--
-- Name: runtime_killswitch runtime_killswitch_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.runtime_killswitch
    ADD CONSTRAINT runtime_killswitch_pkey PRIMARY KEY (key);


--
-- Name: screen_action_map screen_action_map_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.screen_action_map
    ADD CONSTRAINT screen_action_map_pkey PRIMARY KEY (screen_code, action_code);


--
-- Name: screen_master screen_master_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.screen_master
    ADD CONSTRAINT screen_master_pkey PRIMARY KEY (screen_code);


--
-- Name: screen_rule screen_rule_pkey; Type: CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.screen_rule
    ADD CONSTRAINT screen_rule_pkey PRIMARY KEY (screen_type);


--
-- Name: company company_company_code_key; Type: CONSTRAINT; Schema: tenant; Owner: -
--

ALTER TABLE ONLY tenant.company
    ADD CONSTRAINT company_company_code_key UNIQUE (company_code);


--
-- Name: company_license company_license_pkey; Type: CONSTRAINT; Schema: tenant; Owner: -
--

ALTER TABLE ONLY tenant.company_license
    ADD CONSTRAINT company_license_pkey PRIMARY KEY (company_id, license_code);


--
-- Name: company company_pkey; Type: CONSTRAINT; Schema: tenant; Owner: -
--

ALTER TABLE ONLY tenant.company
    ADD CONSTRAINT company_pkey PRIMARY KEY (company_id);


--
-- Name: license_master license_master_pkey; Type: CONSTRAINT; Schema: tenant; Owner: -
--

ALTER TABLE ONLY tenant.license_master
    ADD CONSTRAINT license_master_pkey PRIMARY KEY (license_code);


--
-- Name: idx_ai_event_pending; Type: INDEX; Schema: analytics; Owner: -
--

CREATE INDEX idx_ai_event_pending ON analytics.ai_event USING btree (company_id, status) WHERE (status = 'pending'::text);


--
-- Name: idx_ai_job_pending; Type: INDEX; Schema: analytics; Owner: -
--

CREATE INDEX idx_ai_job_pending ON analytics.ai_job USING btree (company_id, status) WHERE (status = 'pending'::text);


--
-- Name: idx_fact_metric_lookup; Type: INDEX; Schema: analytics; Owner: -
--

CREATE INDEX idx_fact_metric_lookup ON analytics.fact_metric USING btree (company_id, metric_code, metric_date DESC);


--
-- Name: idx_notification_pending; Type: INDEX; Schema: analytics; Owner: -
--

CREATE INDEX idx_notification_pending ON analytics.notification_queue USING btree (status) WHERE (status = 'pending'::text);


--
-- Name: ix_alert_notification_status; Type: INDEX; Schema: analytics; Owner: -
--

CREATE INDEX ix_alert_notification_status ON analytics.audit_alert_notification USING btree (status, created_at);


--
-- Name: ix_audit_alert_rule_company; Type: INDEX; Schema: analytics; Owner: -
--

CREATE INDEX ix_audit_alert_rule_company ON analytics.audit_alert_rule USING btree (company_id, is_enabled);


--
-- Name: ux_alert_event_dedupe; Type: INDEX; Schema: analytics; Owner: -
--

CREATE UNIQUE INDEX ux_alert_event_dedupe ON analytics.audit_alert_event USING btree (rule_id, company_id, window_end);


--
-- Name: idx_ai_prop_request; Type: INDEX; Schema: approval; Owner: -
--

CREATE INDEX idx_ai_prop_request ON approval.ai_improvement_proposal USING btree (request_id);


--
-- Name: idx_invoice_delivery_invoice; Type: INDEX; Schema: approval; Owner: -
--

CREATE INDEX idx_invoice_delivery_invoice ON approval.invoice_delivery_log USING btree (invoice_id, created_at DESC);


--
-- Name: idx_jsox_evidence_company_time; Type: INDEX; Schema: approval; Owner: -
--

CREATE INDEX idx_jsox_evidence_company_time ON approval.jsox_evidence_log USING btree (company_id, created_at DESC);


--
-- Name: idx_policy_eval_policy_time; Type: INDEX; Schema: approval; Owner: -
--

CREATE INDEX idx_policy_eval_policy_time ON approval.policy_eval_event USING btree (auto_policy_id, created_at DESC);


--
-- Name: idx_rework_open; Type: INDEX; Schema: approval; Owner: -
--

CREATE INDEX idx_rework_open ON approval.rework_task USING btree (status, created_at DESC);


--
-- Name: idx_saas_sub_company; Type: INDEX; Schema: approval; Owner: -
--

CREATE INDEX idx_saas_sub_company ON approval.saas_subscription USING btree (company_id, status);


--
-- Name: idx_approval_log_request; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_approval_log_request ON audit.approval_log USING btree (approval_request_id);


--
-- Name: idx_approval_request_company; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_approval_request_company ON audit.approval_request USING btree (company_id);


--
-- Name: idx_approval_request_domain_entity; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_approval_request_domain_entity ON audit.approval_request USING btree (domain, entity_type, entity_id);


--
-- Name: idx_approval_request_order; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_approval_request_order ON audit.approval_request USING btree (order_id);


--
-- Name: idx_approval_request_status; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_approval_request_status ON audit.approval_request USING btree (status);


--
-- Name: idx_entity_status_history_company; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_entity_status_history_company ON audit.entity_status_history USING btree (company_id);


--
-- Name: idx_entity_status_history_entity; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_entity_status_history_entity ON audit.entity_status_history USING btree (entity_type, entity_id);


--
-- Name: idx_ng_event_company_time; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_ng_event_company_time ON audit.ng_event USING btree (company_id, occurred_at DESC);


--
-- Name: idx_ng_event_event_key; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_ng_event_event_key ON audit.ng_event USING btree (event_key);


--
-- Name: idx_ng_event_quarantined; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_ng_event_quarantined ON audit.ng_event USING btree (quarantined) WHERE (quarantined = true);


--
-- Name: idx_ng_event_scope_severity; Type: INDEX; Schema: audit; Owner: -
--

CREATE INDEX idx_ng_event_scope_severity ON audit.ng_event USING btree (audit_scope, severity);


--
-- Name: ux_audit_event_unique; Type: INDEX; Schema: audit; Owner: -
--

CREATE UNIQUE INDEX ux_audit_event_unique ON audit.audit_event USING btree (company_id, occurred_at, business_domain, event_key, reason_code);


--
-- Name: audit_logs_instance_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX audit_logs_instance_id_idx ON auth.audit_log_entries USING btree (instance_id);


--
-- Name: confirmation_token_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX confirmation_token_idx ON auth.users USING btree (confirmation_token) WHERE ((confirmation_token)::text !~ '^[0-9 ]*$'::text);


--
-- Name: email_change_token_current_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX email_change_token_current_idx ON auth.users USING btree (email_change_token_current) WHERE ((email_change_token_current)::text !~ '^[0-9 ]*$'::text);


--
-- Name: email_change_token_new_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX email_change_token_new_idx ON auth.users USING btree (email_change_token_new) WHERE ((email_change_token_new)::text !~ '^[0-9 ]*$'::text);


--
-- Name: factor_id_created_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX factor_id_created_at_idx ON auth.mfa_factors USING btree (user_id, created_at);


--
-- Name: flow_state_created_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX flow_state_created_at_idx ON auth.flow_state USING btree (created_at DESC);


--
-- Name: identities_email_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX identities_email_idx ON auth.identities USING btree (email text_pattern_ops);


--
-- Name: INDEX identities_email_idx; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON INDEX auth.identities_email_idx IS 'Auth: Ensures indexed queries on the email column';


--
-- Name: identities_user_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX identities_user_id_idx ON auth.identities USING btree (user_id);


--
-- Name: idx_auth_code; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX idx_auth_code ON auth.flow_state USING btree (auth_code);


--
-- Name: idx_oauth_client_states_created_at; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX idx_oauth_client_states_created_at ON auth.oauth_client_states USING btree (created_at);


--
-- Name: idx_user_id_auth_method; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX idx_user_id_auth_method ON auth.flow_state USING btree (user_id, authentication_method);


--
-- Name: mfa_challenge_created_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX mfa_challenge_created_at_idx ON auth.mfa_challenges USING btree (created_at DESC);


--
-- Name: mfa_factors_user_friendly_name_unique; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX mfa_factors_user_friendly_name_unique ON auth.mfa_factors USING btree (friendly_name, user_id) WHERE (TRIM(BOTH FROM friendly_name) <> ''::text);


--
-- Name: mfa_factors_user_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX mfa_factors_user_id_idx ON auth.mfa_factors USING btree (user_id);


--
-- Name: oauth_auth_pending_exp_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX oauth_auth_pending_exp_idx ON auth.oauth_authorizations USING btree (expires_at) WHERE (status = 'pending'::auth.oauth_authorization_status);


--
-- Name: oauth_clients_deleted_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX oauth_clients_deleted_at_idx ON auth.oauth_clients USING btree (deleted_at);


--
-- Name: oauth_consents_active_client_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX oauth_consents_active_client_idx ON auth.oauth_consents USING btree (client_id) WHERE (revoked_at IS NULL);


--
-- Name: oauth_consents_active_user_client_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX oauth_consents_active_user_client_idx ON auth.oauth_consents USING btree (user_id, client_id) WHERE (revoked_at IS NULL);


--
-- Name: oauth_consents_user_order_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX oauth_consents_user_order_idx ON auth.oauth_consents USING btree (user_id, granted_at DESC);


--
-- Name: one_time_tokens_relates_to_hash_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX one_time_tokens_relates_to_hash_idx ON auth.one_time_tokens USING hash (relates_to);


--
-- Name: one_time_tokens_token_hash_hash_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX one_time_tokens_token_hash_hash_idx ON auth.one_time_tokens USING hash (token_hash);


--
-- Name: one_time_tokens_user_id_token_type_key; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX one_time_tokens_user_id_token_type_key ON auth.one_time_tokens USING btree (user_id, token_type);


--
-- Name: reauthentication_token_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX reauthentication_token_idx ON auth.users USING btree (reauthentication_token) WHERE ((reauthentication_token)::text !~ '^[0-9 ]*$'::text);


--
-- Name: recovery_token_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX recovery_token_idx ON auth.users USING btree (recovery_token) WHERE ((recovery_token)::text !~ '^[0-9 ]*$'::text);


--
-- Name: refresh_tokens_instance_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX refresh_tokens_instance_id_idx ON auth.refresh_tokens USING btree (instance_id);


--
-- Name: refresh_tokens_instance_id_user_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX refresh_tokens_instance_id_user_id_idx ON auth.refresh_tokens USING btree (instance_id, user_id);


--
-- Name: refresh_tokens_parent_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX refresh_tokens_parent_idx ON auth.refresh_tokens USING btree (parent);


--
-- Name: refresh_tokens_session_id_revoked_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX refresh_tokens_session_id_revoked_idx ON auth.refresh_tokens USING btree (session_id, revoked);


--
-- Name: refresh_tokens_updated_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX refresh_tokens_updated_at_idx ON auth.refresh_tokens USING btree (updated_at DESC);


--
-- Name: saml_providers_sso_provider_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX saml_providers_sso_provider_id_idx ON auth.saml_providers USING btree (sso_provider_id);


--
-- Name: saml_relay_states_created_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX saml_relay_states_created_at_idx ON auth.saml_relay_states USING btree (created_at DESC);


--
-- Name: saml_relay_states_for_email_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX saml_relay_states_for_email_idx ON auth.saml_relay_states USING btree (for_email);


--
-- Name: saml_relay_states_sso_provider_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX saml_relay_states_sso_provider_id_idx ON auth.saml_relay_states USING btree (sso_provider_id);


--
-- Name: sessions_not_after_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX sessions_not_after_idx ON auth.sessions USING btree (not_after DESC);


--
-- Name: sessions_oauth_client_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX sessions_oauth_client_id_idx ON auth.sessions USING btree (oauth_client_id);


--
-- Name: sessions_user_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX sessions_user_id_idx ON auth.sessions USING btree (user_id);


--
-- Name: sso_domains_domain_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX sso_domains_domain_idx ON auth.sso_domains USING btree (lower(domain));


--
-- Name: sso_domains_sso_provider_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX sso_domains_sso_provider_id_idx ON auth.sso_domains USING btree (sso_provider_id);


--
-- Name: sso_providers_resource_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX sso_providers_resource_id_idx ON auth.sso_providers USING btree (lower(resource_id));


--
-- Name: sso_providers_resource_id_pattern_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX sso_providers_resource_id_pattern_idx ON auth.sso_providers USING btree (resource_id text_pattern_ops);


--
-- Name: unique_phone_factor_per_user; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX unique_phone_factor_per_user ON auth.mfa_factors USING btree (user_id, phone);


--
-- Name: user_id_created_at_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX user_id_created_at_idx ON auth.sessions USING btree (user_id, created_at);


--
-- Name: users_email_partial_key; Type: INDEX; Schema: auth; Owner: -
--

CREATE UNIQUE INDEX users_email_partial_key ON auth.users USING btree (email) WHERE (is_sso_user = false);


--
-- Name: INDEX users_email_partial_key; Type: COMMENT; Schema: auth; Owner: -
--

COMMENT ON INDEX auth.users_email_partial_key IS 'Auth: A partial unique index that applies only when is_sso_user is false';


--
-- Name: users_instance_id_email_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX users_instance_id_email_idx ON auth.users USING btree (instance_id, lower((email)::text));


--
-- Name: users_instance_id_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX users_instance_id_idx ON auth.users USING btree (instance_id);


--
-- Name: users_is_anonymous_idx; Type: INDEX; Schema: auth; Owner: -
--

CREATE INDEX users_is_anonymous_idx ON auth.users USING btree (is_anonymous);


--
-- Name: idx_checkout_invoice; Type: INDEX; Schema: billing; Owner: -
--

CREATE INDEX idx_checkout_invoice ON billing.checkout_session USING btree (invoice_id, created_at DESC);


--
-- Name: idx_invoice_send_audit_invoice; Type: INDEX; Schema: billing; Owner: -
--

CREATE INDEX idx_invoice_send_audit_invoice ON billing.invoice_send_audit USING btree (invoice_id, created_at DESC);


--
-- Name: uq_invoice_retry_once; Type: INDEX; Schema: billing; Owner: -
--

CREATE UNIQUE INDEX uq_invoice_retry_once ON billing.invoice_send_retry USING btree (invoice_id) WHERE (status = 'pending'::text);


--
-- Name: idx_ops_notification_pending; Type: INDEX; Schema: ci; Owner: -
--

CREATE INDEX idx_ops_notification_pending ON ci.ops_notification_queue USING btree (status, created_at);


--
-- Name: idx_schema_ai_review_job_status; Type: INDEX; Schema: ci; Owner: -
--

CREATE INDEX idx_schema_ai_review_job_status ON ci.schema_ai_review_job USING btree (status, created_at);


--
-- Name: uq_escalation_outbox_queued; Type: INDEX; Schema: ci; Owner: -
--

CREATE UNIQUE INDEX uq_escalation_outbox_queued ON ci.escalation_outbox USING btree (request_id) WHERE (status = 'queued'::text);


--
-- Name: idx_audit_trail_company_entity; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX idx_audit_trail_company_entity ON ONLY core.audit_trail USING btree (company_id, entity_type, entity_id);


--
-- Name: audit_trail_2025_12_company_id_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2025_12_company_id_entity_type_entity_id_idx ON core.audit_trail_2025_12 USING btree (company_id, entity_type, entity_id);


--
-- Name: idx_audit_trail_company_time; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX idx_audit_trail_company_time ON ONLY core.audit_trail USING btree (company_id, performed_at DESC);


--
-- Name: audit_trail_2025_12_company_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2025_12_company_id_performed_at_idx ON core.audit_trail_2025_12 USING btree (company_id, performed_at DESC);


--
-- Name: idx_audit_trail_entity; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX idx_audit_trail_entity ON ONLY core.audit_trail USING btree (entity_type, entity_id);


--
-- Name: audit_trail_2025_12_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2025_12_entity_type_entity_id_idx ON core.audit_trail_2025_12 USING btree (entity_type, entity_id);


--
-- Name: idx_audit_trail_entity_time; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX idx_audit_trail_entity_time ON ONLY core.audit_trail USING btree (entity_type, entity_id, performed_at DESC);


--
-- Name: audit_trail_2025_12_entity_type_entity_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2025_12_entity_type_entity_id_performed_at_idx ON core.audit_trail_2025_12 USING btree (entity_type, entity_id, performed_at DESC);


--
-- Name: audit_trail_2026_01_company_id_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_01_company_id_entity_type_entity_id_idx ON core.audit_trail_2026_01 USING btree (company_id, entity_type, entity_id);


--
-- Name: audit_trail_2026_01_company_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_01_company_id_performed_at_idx ON core.audit_trail_2026_01 USING btree (company_id, performed_at DESC);


--
-- Name: audit_trail_2026_01_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_01_entity_type_entity_id_idx ON core.audit_trail_2026_01 USING btree (entity_type, entity_id);


--
-- Name: audit_trail_2026_01_entity_type_entity_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_01_entity_type_entity_id_performed_at_idx ON core.audit_trail_2026_01 USING btree (entity_type, entity_id, performed_at DESC);


--
-- Name: audit_trail_2026_02_company_id_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_02_company_id_entity_type_entity_id_idx ON core.audit_trail_2026_02 USING btree (company_id, entity_type, entity_id);


--
-- Name: audit_trail_2026_02_company_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_02_company_id_performed_at_idx ON core.audit_trail_2026_02 USING btree (company_id, performed_at DESC);


--
-- Name: audit_trail_2026_02_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_02_entity_type_entity_id_idx ON core.audit_trail_2026_02 USING btree (entity_type, entity_id);


--
-- Name: audit_trail_2026_02_entity_type_entity_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_02_entity_type_entity_id_performed_at_idx ON core.audit_trail_2026_02 USING btree (entity_type, entity_id, performed_at DESC);


--
-- Name: audit_trail_2026_03_company_id_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_03_company_id_entity_type_entity_id_idx ON core.audit_trail_2026_03 USING btree (company_id, entity_type, entity_id);


--
-- Name: audit_trail_2026_03_company_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_03_company_id_performed_at_idx ON core.audit_trail_2026_03 USING btree (company_id, performed_at DESC);


--
-- Name: audit_trail_2026_03_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_03_entity_type_entity_id_idx ON core.audit_trail_2026_03 USING btree (entity_type, entity_id);


--
-- Name: audit_trail_2026_03_entity_type_entity_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_03_entity_type_entity_id_performed_at_idx ON core.audit_trail_2026_03 USING btree (entity_type, entity_id, performed_at DESC);


--
-- Name: audit_trail_2026_04_company_id_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_04_company_id_entity_type_entity_id_idx ON core.audit_trail_2026_04 USING btree (company_id, entity_type, entity_id);


--
-- Name: audit_trail_2026_04_company_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_04_company_id_performed_at_idx ON core.audit_trail_2026_04 USING btree (company_id, performed_at DESC);


--
-- Name: audit_trail_2026_04_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_04_entity_type_entity_id_idx ON core.audit_trail_2026_04 USING btree (entity_type, entity_id);


--
-- Name: audit_trail_2026_04_entity_type_entity_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_04_entity_type_entity_id_performed_at_idx ON core.audit_trail_2026_04 USING btree (entity_type, entity_id, performed_at DESC);


--
-- Name: audit_trail_2026_05_company_id_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_05_company_id_entity_type_entity_id_idx ON core.audit_trail_2026_05 USING btree (company_id, entity_type, entity_id);


--
-- Name: audit_trail_2026_05_company_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_05_company_id_performed_at_idx ON core.audit_trail_2026_05 USING btree (company_id, performed_at DESC);


--
-- Name: audit_trail_2026_05_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_05_entity_type_entity_id_idx ON core.audit_trail_2026_05 USING btree (entity_type, entity_id);


--
-- Name: audit_trail_2026_05_entity_type_entity_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_05_entity_type_entity_id_performed_at_idx ON core.audit_trail_2026_05 USING btree (entity_type, entity_id, performed_at DESC);


--
-- Name: audit_trail_2026_06_company_id_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_06_company_id_entity_type_entity_id_idx ON core.audit_trail_2026_06 USING btree (company_id, entity_type, entity_id);


--
-- Name: audit_trail_2026_06_company_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_06_company_id_performed_at_idx ON core.audit_trail_2026_06 USING btree (company_id, performed_at DESC);


--
-- Name: audit_trail_2026_06_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_06_entity_type_entity_id_idx ON core.audit_trail_2026_06 USING btree (entity_type, entity_id);


--
-- Name: audit_trail_2026_06_entity_type_entity_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_06_entity_type_entity_id_performed_at_idx ON core.audit_trail_2026_06 USING btree (entity_type, entity_id, performed_at DESC);


--
-- Name: audit_trail_2026_07_company_id_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_07_company_id_entity_type_entity_id_idx ON core.audit_trail_2026_07 USING btree (company_id, entity_type, entity_id);


--
-- Name: audit_trail_2026_07_company_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_07_company_id_performed_at_idx ON core.audit_trail_2026_07 USING btree (company_id, performed_at DESC);


--
-- Name: audit_trail_2026_07_entity_type_entity_id_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_07_entity_type_entity_id_idx ON core.audit_trail_2026_07 USING btree (entity_type, entity_id);


--
-- Name: audit_trail_2026_07_entity_type_entity_id_performed_at_idx; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX audit_trail_2026_07_entity_type_entity_id_performed_at_idx ON core.audit_trail_2026_07 USING btree (entity_type, entity_id, performed_at DESC);


--
-- Name: idx_audit_impact_rule_lookup; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX idx_audit_impact_rule_lookup ON core.audit_impact_rule USING btree (company_id, action, priority);


--
-- Name: idx_status_history_entity; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX idx_status_history_entity ON core.status_history USING btree (company_id, entity_type, entity_id, changed_at DESC);


--
-- Name: idx_sync_queue_status; Type: INDEX; Schema: core; Owner: -
--

CREATE INDEX idx_sync_queue_status ON core.sync_queue USING btree (status, created_at);


--
-- Name: idx_audit_export_queue_status; Type: INDEX; Schema: integration; Owner: -
--

CREATE INDEX idx_audit_export_queue_status ON integration.audit_export_queue USING btree (status, created_at);


--
-- Name: idx_siem_queue_status; Type: INDEX; Schema: integration; Owner: -
--

CREATE INDEX idx_siem_queue_status ON integration.siem_delivery_queue USING btree (status, enqueued_at);


--
-- Name: idx_stock_tx_item_time; Type: INDEX; Schema: inventory; Owner: -
--

CREATE INDEX idx_stock_tx_item_time ON inventory.stock_transaction USING btree (company_id, item_id, occurred_at DESC);


--
-- Name: ix_asset_link_entity_role; Type: INDEX; Schema: media; Owner: -
--

CREATE INDEX ix_asset_link_entity_role ON media.asset_link USING btree (entity_table, entity_id, role, sort_order);


--
-- Name: ix_asset_link_primary; Type: INDEX; Schema: media; Owner: -
--

CREATE INDEX ix_asset_link_primary ON media.asset_link USING btree (entity_table, entity_id, role, is_primary);


--
-- Name: idx_ai_event_company_status; Type: INDEX; Schema: notify; Owner: -
--

CREATE INDEX idx_ai_event_company_status ON notify.ai_event USING btree (company_id, status);


--
-- Name: idx_approval_company_status; Type: INDEX; Schema: notify; Owner: -
--

CREATE INDEX idx_approval_company_status ON notify.approval_request USING btree (company_id, status);


--
-- Name: idx_approval_request_company_status; Type: INDEX; Schema: notify; Owner: -
--

CREATE INDEX idx_approval_request_company_status ON notify.approval_request USING btree (company_id, status);


--
-- Name: idx_audit_company_created; Type: INDEX; Schema: notify; Owner: -
--

CREATE INDEX idx_audit_company_created ON notify.audit_trail USING btree (company_id, created_at);


--
-- Name: idx_audit_trail_company_created; Type: INDEX; Schema: notify; Owner: -
--

CREATE INDEX idx_audit_trail_company_created ON notify.audit_trail USING btree (company_id, created_at);


--
-- Name: idx_notify_log_company_status; Type: INDEX; Schema: notify; Owner: -
--

CREATE INDEX idx_notify_log_company_status ON notify.notification_log USING btree (company_id, status);


--
-- Name: idx_notify_log_created_at; Type: INDEX; Schema: notify; Owner: -
--

CREATE INDEX idx_notify_log_created_at ON notify.notification_log USING btree (created_at);


--
-- Name: idx_notify_log_retry; Type: INDEX; Schema: notify; Owner: -
--

CREATE INDEX idx_notify_log_retry ON notify.notification_log USING btree (status, retry_count);


--
-- Name: idx_ops_job_pending; Type: INDEX; Schema: ops; Owner: -
--

CREATE INDEX idx_ops_job_pending ON ops.ops_job_queue USING btree (job_status, created_at);


--
-- Name: ix_notification_outbox_pick; Type: INDEX; Schema: ops; Owner: -
--

CREATE INDEX ix_notification_outbox_pick ON ops.notification_outbox USING btree (status, retry_count, created_at);


--
-- Name: ix_notification_pick; Type: INDEX; Schema: ops; Owner: -
--

CREATE INDEX ix_notification_pick ON ops.notification_outbox USING btree (status, run_after, notification_id);


--
-- Name: ix_ops_job_queue_business; Type: INDEX; Schema: ops; Owner: -
--

CREATE INDEX ix_ops_job_queue_business ON ops.ops_job_queue USING btree (business_table, business_id);


--
-- Name: ix_ops_job_queue_locked; Type: INDEX; Schema: ops; Owner: -
--

CREATE INDEX ix_ops_job_queue_locked ON ops.ops_job_queue USING btree (locked_at);


--
-- Name: ix_ops_job_queue_pick; Type: INDEX; Schema: ops; Owner: -
--

CREATE INDEX ix_ops_job_queue_pick ON ops.ops_job_queue USING btree (status, run_after, priority, job_id);


--
-- Name: ix_ops_job_result_job; Type: INDEX; Schema: ops; Owner: -
--

CREATE INDEX ix_ops_job_result_job ON ops.ops_job_result USING btree (job_id);


--
-- Name: ix_ops_job_result_job_id; Type: INDEX; Schema: ops; Owner: -
--

CREATE INDEX ix_ops_job_result_job_id ON ops.ops_job_result USING btree (job_id);


--
-- Name: ux_ops_send_idempotent; Type: INDEX; Schema: ops; Owner: -
--

CREATE UNIQUE INDEX ux_ops_send_idempotent ON ops.document_send_history USING btree (document_type_code, document_id, channel_code, resend_type_code, created_at);


--
-- Name: idx_supplier_address_supplier; Type: INDEX; Schema: purchase; Owner: -
--

CREATE INDEX idx_supplier_address_supplier ON purchase.supplier_address USING btree (supplier_id);


--
-- Name: idx_supplier_contact_supplier; Type: INDEX; Schema: purchase; Owner: -
--

CREATE INDEX idx_supplier_contact_supplier ON purchase.supplier_contact USING btree (supplier_id);


--
-- Name: ix_realtime_subscription_entity; Type: INDEX; Schema: realtime; Owner: -
--

CREATE INDEX ix_realtime_subscription_entity ON realtime.subscription USING btree (entity);


--
-- Name: messages_inserted_at_topic_index; Type: INDEX; Schema: realtime; Owner: -
--

CREATE INDEX messages_inserted_at_topic_index ON ONLY realtime.messages USING btree (inserted_at DESC, topic) WHERE ((extension = 'broadcast'::text) AND (private IS TRUE));


--
-- Name: subscription_subscription_id_entity_filters_key; Type: INDEX; Schema: realtime; Owner: -
--

CREATE UNIQUE INDEX subscription_subscription_id_entity_filters_key ON realtime.subscription USING btree (subscription_id, entity, filters);


--
-- Name: idx_customer_address_customer; Type: INDEX; Schema: sales; Owner: -
--

CREATE INDEX idx_customer_address_customer ON sales.customer_address USING btree (customer_id);


--
-- Name: idx_customer_contact_customer; Type: INDEX; Schema: sales; Owner: -
--

CREATE INDEX idx_customer_contact_customer ON sales.customer_contact USING btree (customer_id);


--
-- Name: idx_item_price_item; Type: INDEX; Schema: sales; Owner: -
--

CREATE INDEX idx_item_price_item ON sales.item_price_master USING btree (company_id, item_id, valid_from DESC);


--
-- Name: idx_qol_company; Type: INDEX; Schema: sales; Owner: -
--

CREATE INDEX idx_qol_company ON sales.quotation_order_link USING btree (company_id);


--
-- Name: idx_shipping_revision_company; Type: INDEX; Schema: sales; Owner: -
--

CREATE INDEX idx_shipping_revision_company ON sales.shipping_revision USING btree (company_id);


--
-- Name: idx_shipping_revision_shipping; Type: INDEX; Schema: sales; Owner: -
--

CREATE INDEX idx_shipping_revision_shipping ON sales.shipping_revision USING btree (shipping_id);


--
-- Name: bname; Type: INDEX; Schema: storage; Owner: -
--

CREATE UNIQUE INDEX bname ON storage.buckets USING btree (name);


--
-- Name: bucketid_objname; Type: INDEX; Schema: storage; Owner: -
--

CREATE UNIQUE INDEX bucketid_objname ON storage.objects USING btree (bucket_id, name);


--
-- Name: buckets_analytics_unique_name_idx; Type: INDEX; Schema: storage; Owner: -
--

CREATE UNIQUE INDEX buckets_analytics_unique_name_idx ON storage.buckets_analytics USING btree (name) WHERE (deleted_at IS NULL);


--
-- Name: idx_multipart_uploads_list; Type: INDEX; Schema: storage; Owner: -
--

CREATE INDEX idx_multipart_uploads_list ON storage.s3_multipart_uploads USING btree (bucket_id, key, created_at);


--
-- Name: idx_name_bucket_level_unique; Type: INDEX; Schema: storage; Owner: -
--

CREATE UNIQUE INDEX idx_name_bucket_level_unique ON storage.objects USING btree (name COLLATE "C", bucket_id, level);


--
-- Name: idx_objects_bucket_id_name; Type: INDEX; Schema: storage; Owner: -
--

CREATE INDEX idx_objects_bucket_id_name ON storage.objects USING btree (bucket_id, name COLLATE "C");


--
-- Name: idx_objects_lower_name; Type: INDEX; Schema: storage; Owner: -
--

CREATE INDEX idx_objects_lower_name ON storage.objects USING btree ((path_tokens[level]), lower(name) text_pattern_ops, bucket_id, level);


--
-- Name: idx_prefixes_lower_name; Type: INDEX; Schema: storage; Owner: -
--

CREATE INDEX idx_prefixes_lower_name ON storage.prefixes USING btree (bucket_id, level, ((string_to_array(name, '/'::text))[level]), lower(name) text_pattern_ops);


--
-- Name: name_prefix_search; Type: INDEX; Schema: storage; Owner: -
--

CREATE INDEX name_prefix_search ON storage.objects USING btree (name text_pattern_ops);


--
-- Name: objects_bucket_id_level_idx; Type: INDEX; Schema: storage; Owner: -
--

CREATE UNIQUE INDEX objects_bucket_id_level_idx ON storage.objects USING btree (bucket_id, level, name COLLATE "C");


--
-- Name: vector_indexes_name_bucket_id_idx; Type: INDEX; Schema: storage; Owner: -
--

CREATE UNIQUE INDEX vector_indexes_name_bucket_id_idx ON storage.vector_indexes USING btree (name, bucket_id);


--
-- Name: ix_ai_signal_pick; Type: INDEX; Schema: system; Owner: -
--

CREATE INDEX ix_ai_signal_pick ON system.ai_signal USING btree (status, created_at);


--
-- Name: ix_ai_task_pick; Type: INDEX; Schema: system; Owner: -
--

CREATE INDEX ix_ai_task_pick ON system.ai_task USING btree (status, priority, requested_at);


--
-- Name: ix_exec_run_request_pick; Type: INDEX; Schema: system; Owner: -
--

CREATE INDEX ix_exec_run_request_pick ON system.exec_run_request USING btree (status, priority, requested_at);


--
-- Name: audit_trail_2025_12_company_id_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_entity ATTACH PARTITION core.audit_trail_2025_12_company_id_entity_type_entity_id_idx;


--
-- Name: audit_trail_2025_12_company_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_time ATTACH PARTITION core.audit_trail_2025_12_company_id_performed_at_idx;


--
-- Name: audit_trail_2025_12_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity ATTACH PARTITION core.audit_trail_2025_12_entity_type_entity_id_idx;


--
-- Name: audit_trail_2025_12_entity_type_entity_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity_time ATTACH PARTITION core.audit_trail_2025_12_entity_type_entity_id_performed_at_idx;


--
-- Name: audit_trail_2025_12_pkey; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.audit_trail_pkey ATTACH PARTITION core.audit_trail_2025_12_pkey;


--
-- Name: audit_trail_2026_01_company_id_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_entity ATTACH PARTITION core.audit_trail_2026_01_company_id_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_01_company_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_time ATTACH PARTITION core.audit_trail_2026_01_company_id_performed_at_idx;


--
-- Name: audit_trail_2026_01_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity ATTACH PARTITION core.audit_trail_2026_01_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_01_entity_type_entity_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity_time ATTACH PARTITION core.audit_trail_2026_01_entity_type_entity_id_performed_at_idx;


--
-- Name: audit_trail_2026_01_pkey; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.audit_trail_pkey ATTACH PARTITION core.audit_trail_2026_01_pkey;


--
-- Name: audit_trail_2026_02_company_id_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_entity ATTACH PARTITION core.audit_trail_2026_02_company_id_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_02_company_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_time ATTACH PARTITION core.audit_trail_2026_02_company_id_performed_at_idx;


--
-- Name: audit_trail_2026_02_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity ATTACH PARTITION core.audit_trail_2026_02_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_02_entity_type_entity_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity_time ATTACH PARTITION core.audit_trail_2026_02_entity_type_entity_id_performed_at_idx;


--
-- Name: audit_trail_2026_02_pkey; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.audit_trail_pkey ATTACH PARTITION core.audit_trail_2026_02_pkey;


--
-- Name: audit_trail_2026_03_company_id_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_entity ATTACH PARTITION core.audit_trail_2026_03_company_id_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_03_company_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_time ATTACH PARTITION core.audit_trail_2026_03_company_id_performed_at_idx;


--
-- Name: audit_trail_2026_03_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity ATTACH PARTITION core.audit_trail_2026_03_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_03_entity_type_entity_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity_time ATTACH PARTITION core.audit_trail_2026_03_entity_type_entity_id_performed_at_idx;


--
-- Name: audit_trail_2026_03_pkey; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.audit_trail_pkey ATTACH PARTITION core.audit_trail_2026_03_pkey;


--
-- Name: audit_trail_2026_04_company_id_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_entity ATTACH PARTITION core.audit_trail_2026_04_company_id_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_04_company_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_time ATTACH PARTITION core.audit_trail_2026_04_company_id_performed_at_idx;


--
-- Name: audit_trail_2026_04_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity ATTACH PARTITION core.audit_trail_2026_04_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_04_entity_type_entity_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity_time ATTACH PARTITION core.audit_trail_2026_04_entity_type_entity_id_performed_at_idx;


--
-- Name: audit_trail_2026_04_pkey; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.audit_trail_pkey ATTACH PARTITION core.audit_trail_2026_04_pkey;


--
-- Name: audit_trail_2026_05_company_id_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_entity ATTACH PARTITION core.audit_trail_2026_05_company_id_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_05_company_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_time ATTACH PARTITION core.audit_trail_2026_05_company_id_performed_at_idx;


--
-- Name: audit_trail_2026_05_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity ATTACH PARTITION core.audit_trail_2026_05_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_05_entity_type_entity_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity_time ATTACH PARTITION core.audit_trail_2026_05_entity_type_entity_id_performed_at_idx;


--
-- Name: audit_trail_2026_05_pkey; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.audit_trail_pkey ATTACH PARTITION core.audit_trail_2026_05_pkey;


--
-- Name: audit_trail_2026_06_company_id_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_entity ATTACH PARTITION core.audit_trail_2026_06_company_id_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_06_company_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_time ATTACH PARTITION core.audit_trail_2026_06_company_id_performed_at_idx;


--
-- Name: audit_trail_2026_06_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity ATTACH PARTITION core.audit_trail_2026_06_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_06_entity_type_entity_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity_time ATTACH PARTITION core.audit_trail_2026_06_entity_type_entity_id_performed_at_idx;


--
-- Name: audit_trail_2026_06_pkey; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.audit_trail_pkey ATTACH PARTITION core.audit_trail_2026_06_pkey;


--
-- Name: audit_trail_2026_07_company_id_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_entity ATTACH PARTITION core.audit_trail_2026_07_company_id_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_07_company_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_company_time ATTACH PARTITION core.audit_trail_2026_07_company_id_performed_at_idx;


--
-- Name: audit_trail_2026_07_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity ATTACH PARTITION core.audit_trail_2026_07_entity_type_entity_id_idx;


--
-- Name: audit_trail_2026_07_entity_type_entity_id_performed_at_idx; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.idx_audit_trail_entity_time ATTACH PARTITION core.audit_trail_2026_07_entity_type_entity_id_performed_at_idx;


--
-- Name: audit_trail_2026_07_pkey; Type: INDEX ATTACH; Schema: core; Owner: -
--

ALTER INDEX core.audit_trail_pkey ATTACH PARTITION core.audit_trail_2026_07_pkey;


--
-- Name: ai_job trg_ai_job_apply_master; Type: TRIGGER; Schema: analytics; Owner: -
--

CREATE TRIGGER trg_ai_job_apply_master BEFORE INSERT OR UPDATE OF job_type, requires_approval ON analytics.ai_job FOR EACH ROW EXECUTE FUNCTION analytics.trg_ai_job_apply_master();


--
-- Name: audit_alert_event trg_audit_alert_to_ai_event; Type: TRIGGER; Schema: analytics; Owner: -
--

CREATE TRIGGER trg_audit_alert_to_ai_event AFTER INSERT ON analytics.audit_alert_event FOR EACH ROW EXECUTE FUNCTION analytics.trg_audit_alert_to_ai_event();


--
-- Name: policy_rollout trg_policy_rollout_touch; Type: TRIGGER; Schema: approval; Owner: -
--

CREATE TRIGGER trg_policy_rollout_touch BEFORE UPDATE ON approval.policy_rollout FOR EACH ROW EXECUTE FUNCTION approval.touch_updated_at();


--
-- Name: approval_request trg_set_policy_and_severity; Type: TRIGGER; Schema: audit; Owner: -
--

CREATE TRIGGER trg_set_policy_and_severity BEFORE INSERT ON audit.approval_request FOR EACH ROW EXECUTE FUNCTION approval.set_policy_and_severity();


--
-- Name: schema_change_request trg_audit_schema_change_transitions; Type: TRIGGER; Schema: ci; Owner: -
--

CREATE TRIGGER trg_audit_schema_change_transitions AFTER UPDATE ON ci.schema_change_request FOR EACH ROW EXECUTE FUNCTION ci.audit_schema_change_transitions();


--
-- Name: schema_change_request trg_enqueue_schema_ai_review; Type: TRIGGER; Schema: ci; Owner: -
--

CREATE TRIGGER trg_enqueue_schema_ai_review AFTER INSERT ON ci.schema_change_request FOR EACH ROW EXECUTE FUNCTION ci.enqueue_schema_ai_review();


--
-- Name: accounting_period trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.accounting_period FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: accounts trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.accounts FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: app_user trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.app_user FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: audit_entity_pk_map trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.audit_entity_pk_map FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: audit_trail_2025_12 trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.audit_trail_2025_12 FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: audit_trail_2026_01 trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.audit_trail_2026_01 FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: audit_trail_2026_02 trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.audit_trail_2026_02 FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: audit_trail_2026_03 trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.audit_trail_2026_03 FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: audit_trail_2026_04 trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.audit_trail_2026_04 FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: audit_trail_2026_05 trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.audit_trail_2026_05 FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: audit_trail_2026_06 trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.audit_trail_2026_06 FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: audit_trail_2026_07 trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.audit_trail_2026_07 FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: company trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.company FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: company_license trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.company_license FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: company_permission trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.company_permission FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: company_users trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.company_users FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: document_sequence trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.document_sequence FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: entity_attribute_def trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.entity_attribute_def FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: entity_attribute_value trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.entity_attribute_value FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: journal_entries trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.journal_entries FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: journal_lines trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.journal_lines FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: journal_source_link trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.journal_source_link FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: license_master trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.license_master FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: login_history trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.login_history FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: payment_method trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.payment_method FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: payment_term trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.payment_term FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: permission_group_permissions trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.permission_group_permissions FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: permission_groups trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.permission_groups FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: permissions trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.permissions FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: posting_profile trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.posting_profile FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: status_history trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.status_history FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: status_master trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.status_master FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: sync_queue trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.sync_queue FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: uom trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.uom FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: uom_conversion trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.uom_conversion FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: user_permissions trg_audit_iud; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON core.user_permissions FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: company trg_core_company_audit; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_core_company_audit AFTER INSERT OR DELETE OR UPDATE ON core.company FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: company_license trg_core_company_license_audit; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_core_company_license_audit AFTER INSERT OR DELETE OR UPDATE ON core.company_license FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: company_permission trg_core_company_permission_audit; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_core_company_permission_audit AFTER INSERT OR DELETE OR UPDATE ON core.company_permission FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: posting_profile trg_core_posting_profile_audit; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_core_posting_profile_audit AFTER INSERT OR DELETE OR UPDATE ON core.posting_profile FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: status_history trg_core_status_history_audit; Type: TRIGGER; Schema: core; Owner: -
--

CREATE TRIGGER trg_core_status_history_audit AFTER INSERT OR DELETE OR UPDATE ON core.status_history FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: bank_account trg_audit_iud; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON finance.bank_account FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: bank_statement_header trg_audit_iud; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON finance.bank_statement_header FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: bank_statement_line trg_audit_iud; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON finance.bank_statement_line FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: payment trg_audit_iud; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON finance.payment FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: payment_allocation trg_audit_iud; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON finance.payment_allocation FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: bank_account trg_finance_bank_account_audit; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_finance_bank_account_audit AFTER INSERT OR DELETE OR UPDATE ON finance.bank_account FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: payment trg_finance_payment_audit; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_finance_payment_audit AFTER INSERT OR DELETE OR UPDATE ON finance.payment FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: bank_account trg_require_reason_code; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON finance.bank_account FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: bank_statement_header trg_require_reason_code; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON finance.bank_statement_header FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: bank_statement_line trg_require_reason_code; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON finance.bank_statement_line FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: payment trg_require_reason_code; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON finance.payment FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: payment_allocation trg_require_reason_code; Type: TRIGGER; Schema: finance; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON finance.payment_allocation FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: attendance_log trg_audit_iud; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON hr.attendance_log FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: employee trg_audit_iud; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON hr.employee FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: employment_contract trg_audit_iud; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON hr.employment_contract FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: hr_department trg_audit_iud; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON hr.hr_department FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: hr_position trg_audit_iud; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON hr.hr_position FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: leave_request trg_audit_iud; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON hr.leave_request FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: leave_type trg_audit_iud; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON hr.leave_type FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: payroll_run trg_audit_iud; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON hr.payroll_run FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: payroll_slip trg_audit_iud; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON hr.payroll_slip FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: attendance_log trg_hr_attendance_log_audit; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_hr_attendance_log_audit AFTER INSERT OR DELETE OR UPDATE ON hr.attendance_log FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: employee trg_hr_employee_audit; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_hr_employee_audit AFTER INSERT OR DELETE OR UPDATE ON hr.employee FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: employment_contract trg_hr_employment_contract_audit; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_hr_employment_contract_audit AFTER INSERT OR DELETE OR UPDATE ON hr.employment_contract FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: leave_request trg_hr_leave_request_audit; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_hr_leave_request_audit AFTER INSERT OR DELETE OR UPDATE ON hr.leave_request FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: payroll_run trg_hr_payroll_run_audit; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_hr_payroll_run_audit AFTER INSERT OR DELETE OR UPDATE ON hr.payroll_run FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: attendance_log trg_require_reason_code; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON hr.attendance_log FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: employee trg_require_reason_code; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON hr.employee FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: employment_contract trg_require_reason_code; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON hr.employment_contract FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: hr_department trg_require_reason_code; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON hr.hr_department FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: hr_position trg_require_reason_code; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON hr.hr_position FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: leave_request trg_require_reason_code; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON hr.leave_request FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: leave_type trg_require_reason_code; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON hr.leave_type FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: payroll_run trg_require_reason_code; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON hr.payroll_run FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: payroll_slip trg_require_reason_code; Type: TRIGGER; Schema: hr; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON hr.payroll_slip FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: inventory_valuation trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.inventory_valuation FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: stock_balance trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_balance FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: stock_bin trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_bin FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: stock_lot trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_lot FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: stock_lot_balance trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_lot_balance FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: stock_reservation trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_reservation FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: stock_transaction trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_transaction FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: stock_transfer_detail trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_transfer_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: stock_transfer_header trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_transfer_header FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: stocktaking_plan trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.stocktaking_plan FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: stocktaking_result trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.stocktaking_result FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: storage_location trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.storage_location FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: warehouse trg_audit_iud; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON inventory.warehouse FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: inventory_valuation trg_inventory_inventory_valuation_audit; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_inventory_inventory_valuation_audit AFTER INSERT OR DELETE OR UPDATE ON inventory.inventory_valuation FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: stock_balance trg_inventory_stock_balance_audit; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_inventory_stock_balance_audit AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_balance FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: stock_lot trg_inventory_stock_lot_audit; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_inventory_stock_lot_audit AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_lot FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: stock_lot_balance trg_inventory_stock_lot_balance_audit; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_inventory_stock_lot_balance_audit AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_lot_balance FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: stock_reservation trg_inventory_stock_reservation_audit; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_inventory_stock_reservation_audit AFTER INSERT OR DELETE OR UPDATE ON inventory.stock_reservation FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: stocktaking_plan trg_inventory_stocktaking_plan_audit; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_inventory_stocktaking_plan_audit AFTER INSERT OR DELETE OR UPDATE ON inventory.stocktaking_plan FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: stocktaking_result trg_inventory_stocktaking_result_audit; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_inventory_stocktaking_result_audit AFTER INSERT OR DELETE OR UPDATE ON inventory.stocktaking_result FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: warehouse trg_inventory_warehouse_audit; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_inventory_warehouse_audit AFTER INSERT OR DELETE OR UPDATE ON inventory.warehouse FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: inventory_valuation trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.inventory_valuation FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: stock_balance trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.stock_balance FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: stock_bin trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.stock_bin FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: stock_lot trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.stock_lot FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: stock_lot_balance trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.stock_lot_balance FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: stock_reservation trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.stock_reservation FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: stock_transaction trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.stock_transaction FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: stock_transfer_detail trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.stock_transfer_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: stock_transfer_header trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.stock_transfer_header FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: stocktaking_plan trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.stocktaking_plan FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: stocktaking_result trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.stocktaking_result FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: storage_location trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.storage_location FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: warehouse trg_require_reason_code; Type: TRIGGER; Schema: inventory; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON inventory.warehouse FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: bom_detail trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.bom_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: bom_header trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.bom_header FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: manufacturing_cost_snapshot trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.manufacturing_cost_snapshot FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: manufacturing_execution trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.manufacturing_execution FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: manufacturing_execution_detail trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.manufacturing_execution_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: mps_plan trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.mps_plan FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: mps_run trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.mps_run FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: mrp_allocation trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.mrp_allocation FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: mrp_requirement trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.mrp_requirement FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: mrp_run trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.mrp_run FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: process_master trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.process_master FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: routing_header trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.routing_header FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: routing_operation trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.routing_operation FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: work_order trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.work_order FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: yield_metric trg_audit_iud; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON manufacturing.yield_metric FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: manufacturing_cost_snapshot trg_manufacturing_manufacturing_cost_snapshot_audit; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_manufacturing_manufacturing_cost_snapshot_audit AFTER INSERT OR DELETE OR UPDATE ON manufacturing.manufacturing_cost_snapshot FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: mps_run trg_manufacturing_mps_run_audit; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_manufacturing_mps_run_audit AFTER INSERT OR DELETE OR UPDATE ON manufacturing.mps_run FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: mrp_run trg_manufacturing_mrp_run_audit; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_manufacturing_mrp_run_audit AFTER INSERT OR DELETE OR UPDATE ON manufacturing.mrp_run FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: work_order trg_manufacturing_work_order_audit; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_manufacturing_work_order_audit AFTER INSERT OR DELETE OR UPDATE ON manufacturing.work_order FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: yield_metric trg_manufacturing_yield_metric_audit; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_manufacturing_yield_metric_audit AFTER INSERT OR DELETE OR UPDATE ON manufacturing.yield_metric FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: bom_detail trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.bom_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: bom_header trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.bom_header FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: manufacturing_cost_snapshot trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.manufacturing_cost_snapshot FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: manufacturing_execution trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.manufacturing_execution FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: manufacturing_execution_detail trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.manufacturing_execution_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: mps_plan trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.mps_plan FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: mps_run trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.mps_run FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: mrp_allocation trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.mrp_allocation FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: mrp_requirement trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.mrp_requirement FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: mrp_run trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.mrp_run FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: process_master trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.process_master FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: routing_header trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.routing_header FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: routing_operation trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.routing_operation FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: work_order trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.work_order FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: yield_metric trg_require_reason_code; Type: TRIGGER; Schema: manufacturing; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON manufacturing.yield_metric FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: ops_job_result t_after_job_result; Type: TRIGGER; Schema: ops; Owner: -
--

CREATE TRIGGER t_after_job_result AFTER INSERT OR UPDATE OF result_status ON ops.ops_job_result FOR EACH ROW EXECUTE FUNCTION ops.trg_after_job_result();


--
-- Name: business_event trg_enqueue_business_approval; Type: TRIGGER; Schema: ops; Owner: -
--

CREATE TRIGGER trg_enqueue_business_approval AFTER INSERT ON ops.business_event FOR EACH ROW EXECUTE FUNCTION ops.enqueue_business_approval();


--
-- Name: ops_job_queue trg_ops_job_queue_touch; Type: TRIGGER; Schema: ops; Owner: -
--

CREATE TRIGGER trg_ops_job_queue_touch BEFORE UPDATE ON ops.ops_job_queue FOR EACH ROW EXECUTE FUNCTION ops.tg_touch_updated_at();


--
-- Name: v_core_audit_trail trg_core_audit_trail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_core_audit_trail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_core_audit_trail FOR EACH ROW EXECUTE FUNCTION public.trg_v_core_audit_trail_iud();


--
-- Name: v_core_company trg_core_company_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_core_company_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_core_company FOR EACH ROW EXECUTE FUNCTION public.trg_v_core_company_iud();


--
-- Name: v_core_company_license trg_core_company_license_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_core_company_license_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_core_company_license FOR EACH ROW EXECUTE FUNCTION public.trg_v_core_company_license_iud();


--
-- Name: v_core_company_permission trg_core_company_permission_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_core_company_permission_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_core_company_permission FOR EACH ROW EXECUTE FUNCTION public.trg_v_core_company_permission_iud();


--
-- Name: v_core_journal_source_link trg_core_journal_source_link_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_core_journal_source_link_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_core_journal_source_link FOR EACH ROW EXECUTE FUNCTION public.trg_v_core_journal_source_link_iud();


--
-- Name: v_core_payment_term trg_core_payment_term_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_core_payment_term_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_core_payment_term FOR EACH ROW EXECUTE FUNCTION public.trg_v_core_payment_term_iud();


--
-- Name: v_core_posting_profile trg_core_posting_profile_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_core_posting_profile_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_core_posting_profile FOR EACH ROW EXECUTE FUNCTION public.trg_v_core_posting_profile_iud();


--
-- Name: v_core_status_history trg_core_status_history_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_core_status_history_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_core_status_history FOR EACH ROW EXECUTE FUNCTION public.trg_v_core_status_history_iud();


--
-- Name: v_finance_bank_account trg_finance_bank_account_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_finance_bank_account_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_finance_bank_account FOR EACH ROW EXECUTE FUNCTION public.trg_v_finance_bank_account_iud();


--
-- Name: v_finance_bank_statement_line trg_finance_bank_statement_line_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_finance_bank_statement_line_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_finance_bank_statement_line FOR EACH ROW EXECUTE FUNCTION public.trg_v_finance_bank_statement_line_iud();


--
-- Name: v_finance_payment_allocation trg_finance_payment_allocation_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_finance_payment_allocation_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_finance_payment_allocation FOR EACH ROW EXECUTE FUNCTION public.trg_v_finance_payment_allocation_iud();


--
-- Name: v_finance_payment trg_finance_payment_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_finance_payment_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_finance_payment FOR EACH ROW EXECUTE FUNCTION public.trg_v_finance_payment_iud();


--
-- Name: v_hr_attendance_log trg_hr_attendance_log_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_hr_attendance_log_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_hr_attendance_log FOR EACH ROW EXECUTE FUNCTION public.trg_v_hr_attendance_log_iud();


--
-- Name: v_hr_employee trg_hr_employee_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_hr_employee_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_hr_employee FOR EACH ROW EXECUTE FUNCTION public.trg_v_hr_employee_iud();


--
-- Name: v_hr_employment_contract trg_hr_employment_contract_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_hr_employment_contract_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_hr_employment_contract FOR EACH ROW EXECUTE FUNCTION public.trg_v_hr_employment_contract_iud();


--
-- Name: v_hr_leave_request trg_hr_leave_request_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_hr_leave_request_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_hr_leave_request FOR EACH ROW EXECUTE FUNCTION public.trg_v_hr_leave_request_iud();


--
-- Name: v_hr_payroll_run trg_hr_payroll_run_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_hr_payroll_run_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_hr_payroll_run FOR EACH ROW EXECUTE FUNCTION public.trg_v_hr_payroll_run_iud();


--
-- Name: v_hr_payroll_slip trg_hr_payroll_slip_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_hr_payroll_slip_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_hr_payroll_slip FOR EACH ROW EXECUTE FUNCTION public.trg_v_hr_payroll_slip_iud();


--
-- Name: v_inventory_inventory_valuation trg_inventory_inventory_valuation_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_inventory_inventory_valuation_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_inventory_inventory_valuation FOR EACH ROW EXECUTE FUNCTION public.trg_v_inventory_inventory_valuation_iud();


--
-- Name: v_inventory_stock_balance trg_inventory_stock_balance_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_inventory_stock_balance_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_inventory_stock_balance FOR EACH ROW EXECUTE FUNCTION public.trg_v_inventory_stock_balance_iud();


--
-- Name: v_inventory_stock_lot_balance trg_inventory_stock_lot_balance_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_inventory_stock_lot_balance_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_inventory_stock_lot_balance FOR EACH ROW EXECUTE FUNCTION public.trg_v_inventory_stock_lot_balance_iud();


--
-- Name: v_inventory_stock_lot trg_inventory_stock_lot_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_inventory_stock_lot_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_inventory_stock_lot FOR EACH ROW EXECUTE FUNCTION public.trg_v_inventory_stock_lot_iud();


--
-- Name: v_inventory_stock_reservation trg_inventory_stock_reservation_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_inventory_stock_reservation_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_inventory_stock_reservation FOR EACH ROW EXECUTE FUNCTION public.trg_v_inventory_stock_reservation_iud();


--
-- Name: v_inventory_stock_transfer_detail trg_inventory_stock_transfer_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_inventory_stock_transfer_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_inventory_stock_transfer_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_inventory_stock_transfer_detail_iud();


--
-- Name: v_inventory_stocktaking_plan trg_inventory_stocktaking_plan_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_inventory_stocktaking_plan_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_inventory_stocktaking_plan FOR EACH ROW EXECUTE FUNCTION public.trg_v_inventory_stocktaking_plan_iud();


--
-- Name: v_inventory_stocktaking_result trg_inventory_stocktaking_result_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_inventory_stocktaking_result_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_inventory_stocktaking_result FOR EACH ROW EXECUTE FUNCTION public.trg_v_inventory_stocktaking_result_iud();


--
-- Name: v_inventory_warehouse trg_inventory_warehouse_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_inventory_warehouse_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_inventory_warehouse FOR EACH ROW EXECUTE FUNCTION public.trg_v_inventory_warehouse_iud();


--
-- Name: v_manufacturing_bom_detail trg_manufacturing_bom_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_manufacturing_bom_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_manufacturing_bom_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_manufacturing_bom_detail_iud();


--
-- Name: v_manufacturing_manufacturing_cost_snapshot trg_manufacturing_manufacturing_cost_snapshot_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_manufacturing_manufacturing_cost_snapshot_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_manufacturing_manufacturing_cost_snapshot FOR EACH ROW EXECUTE FUNCTION public.trg_v_manufacturing_manufacturing_cost_snapshot_iud();


--
-- Name: v_manufacturing_mps_plan trg_manufacturing_mps_plan_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_manufacturing_mps_plan_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_manufacturing_mps_plan FOR EACH ROW EXECUTE FUNCTION public.trg_v_manufacturing_mps_plan_iud();


--
-- Name: v_manufacturing_mps_run trg_manufacturing_mps_run_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_manufacturing_mps_run_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_manufacturing_mps_run FOR EACH ROW EXECUTE FUNCTION public.trg_v_manufacturing_mps_run_iud();


--
-- Name: v_manufacturing_mrp_allocation trg_manufacturing_mrp_allocation_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_manufacturing_mrp_allocation_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_manufacturing_mrp_allocation FOR EACH ROW EXECUTE FUNCTION public.trg_v_manufacturing_mrp_allocation_iud();


--
-- Name: v_manufacturing_mrp_requirement trg_manufacturing_mrp_requirement_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_manufacturing_mrp_requirement_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_manufacturing_mrp_requirement FOR EACH ROW EXECUTE FUNCTION public.trg_v_manufacturing_mrp_requirement_iud();


--
-- Name: v_manufacturing_mrp_run trg_manufacturing_mrp_run_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_manufacturing_mrp_run_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_manufacturing_mrp_run FOR EACH ROW EXECUTE FUNCTION public.trg_v_manufacturing_mrp_run_iud();


--
-- Name: v_manufacturing_routing_operation trg_manufacturing_routing_operation_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_manufacturing_routing_operation_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_manufacturing_routing_operation FOR EACH ROW EXECUTE FUNCTION public.trg_v_manufacturing_routing_operation_iud();


--
-- Name: v_manufacturing_work_order trg_manufacturing_work_order_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_manufacturing_work_order_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_manufacturing_work_order FOR EACH ROW EXECUTE FUNCTION public.trg_v_manufacturing_work_order_iud();


--
-- Name: v_manufacturing_yield_metric trg_manufacturing_yield_metric_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_manufacturing_yield_metric_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_manufacturing_yield_metric FOR EACH ROW EXECUTE FUNCTION public.trg_v_manufacturing_yield_metric_iud();


--
-- Name: v_purchase_purchase_invoice_detail trg_purchase_purchase_invoice_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_invoice_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_purchase_invoice_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_purchase_invoice_detail_iud();


--
-- Name: v_purchase_purchase_invoice trg_purchase_purchase_invoice_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_invoice_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_purchase_invoice FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_purchase_invoice_iud();


--
-- Name: v_purchase_purchase_order_detail trg_purchase_purchase_order_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_order_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_purchase_order_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_purchase_order_detail_iud();


--
-- Name: v_purchase_purchase_quotation_detail trg_purchase_purchase_quotation_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_quotation_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_purchase_quotation_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_purchase_quotation_detail_iud();


--
-- Name: v_purchase_purchase_quotation trg_purchase_purchase_quotation_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_quotation_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_purchase_quotation FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_purchase_quotation_iud();


--
-- Name: v_purchase_purchase_requisition_detail trg_purchase_purchase_requisition_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_requisition_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_purchase_requisition_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_purchase_requisition_detail_iud();


--
-- Name: v_purchase_purchase_requisition trg_purchase_purchase_requisition_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_requisition_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_purchase_requisition FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_purchase_requisition_iud();


--
-- Name: v_purchase_purchase_three_way_match trg_purchase_purchase_three_way_match_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_three_way_match_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_purchase_three_way_match FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_purchase_three_way_match_iud();


--
-- Name: v_purchase_supplier_address trg_purchase_supplier_address_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_supplier_address_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_supplier_address FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_supplier_address_iud();


--
-- Name: v_purchase_supplier_contact trg_purchase_supplier_contact_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_supplier_contact_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_supplier_contact FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_supplier_contact_iud();


--
-- Name: v_purchase_supplier_item_price trg_purchase_supplier_item_price_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_supplier_item_price_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_supplier_item_price FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_supplier_item_price_iud();


--
-- Name: v_purchase_supplier_payment_term trg_purchase_supplier_payment_term_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_purchase_supplier_payment_term_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_purchase_supplier_payment_term FOR EACH ROW EXECUTE FUNCTION public.trg_v_purchase_supplier_payment_term_iud();


--
-- Name: v_sales_billing_detail trg_sales_billing_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_billing_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_billing_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_billing_detail_iud();


--
-- Name: v_sales_customer_address trg_sales_customer_address_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_customer_address_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_customer_address FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_customer_address_iud();


--
-- Name: v_sales_customer_contact trg_sales_customer_contact_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_customer_contact_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_customer_contact FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_customer_contact_iud();


--
-- Name: v_sales_customer trg_sales_customer_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_customer_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_customer FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_customer_iud();


--
-- Name: v_sales_customer_payment_term trg_sales_customer_payment_term_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_customer_payment_term_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_customer_payment_term FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_customer_payment_term_iud();


--
-- Name: v_sales_invoice_pdf trg_sales_invoice_pdf_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_invoice_pdf_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_invoice_pdf FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_invoice_pdf_iud();


--
-- Name: v_sales_item_category trg_sales_item_category_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_item_category_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_item_category FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_item_category_iud();


--
-- Name: v_sales_item trg_sales_item_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_item_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_item FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_item_iud();


--
-- Name: v_sales_item_uom trg_sales_item_uom_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_item_uom_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_item_uom FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_item_uom_iud();


--
-- Name: v_sales_order_detail trg_sales_order_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_order_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_order_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_order_detail_iud();


--
-- Name: v_sales_return_detail trg_sales_return_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_return_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_return_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_return_detail_iud();


--
-- Name: v_sales_sales_quotation_detail trg_sales_sales_quotation_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_sales_quotation_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_sales_quotation_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_sales_quotation_detail_iud();


--
-- Name: v_sales_sales_quotation trg_sales_sales_quotation_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_sales_quotation_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_sales_quotation FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_sales_quotation_iud();


--
-- Name: v_sales_shipping_detail trg_sales_shipping_detail_iud; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_sales_shipping_detail_iud INSTEAD OF INSERT OR DELETE OR UPDATE ON public.v_sales_shipping_detail FOR EACH ROW EXECUTE FUNCTION public.trg_v_sales_shipping_detail_iud();


--
-- Name: purchase_invoice trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_invoice FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_invoice_detail trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_invoice_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_order_detail trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_order_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_order_header trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_order_header FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_quotation trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_quotation FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_quotation_detail trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_quotation_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_receipt trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_receipt FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_receipt_detail trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_receipt_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_requisition trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_requisition FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_requisition_detail trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_requisition_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_three_way_match trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_three_way_match FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: supplier_address trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.supplier_address FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: supplier_contact trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.supplier_contact FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: supplier_item_price trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.supplier_item_price FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: supplier_master trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.supplier_master FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: supplier_payment_term trg_audit_iud; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON purchase.supplier_payment_term FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: purchase_invoice trg_purchase_purchase_invoice_audit; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_invoice_audit AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_invoice FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: purchase_quotation trg_purchase_purchase_quotation_audit; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_quotation_audit AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_quotation FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: purchase_requisition trg_purchase_purchase_requisition_audit; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_requisition_audit AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_requisition FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: purchase_three_way_match trg_purchase_purchase_three_way_match_audit; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_purchase_purchase_three_way_match_audit AFTER INSERT OR DELETE OR UPDATE ON purchase.purchase_three_way_match FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: supplier_item_price trg_purchase_supplier_item_price_audit; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_purchase_supplier_item_price_audit AFTER INSERT OR DELETE OR UPDATE ON purchase.supplier_item_price FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: purchase_invoice trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_invoice FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: purchase_invoice_detail trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_invoice_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: purchase_order_detail trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_order_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: purchase_order_header trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_order_header FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: purchase_quotation trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_quotation FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: purchase_quotation_detail trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_quotation_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: purchase_receipt trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_receipt FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: purchase_receipt_detail trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_receipt_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: purchase_requisition trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_requisition FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: purchase_requisition_detail trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_requisition_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: purchase_three_way_match trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.purchase_three_way_match FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: supplier_address trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.supplier_address FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: supplier_contact trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.supplier_contact FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: supplier_item_price trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.supplier_item_price FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: supplier_master trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.supplier_master FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: supplier_payment_term trg_require_reason_code; Type: TRIGGER; Schema: purchase; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON purchase.supplier_payment_term FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: subscription tr_check_filters; Type: TRIGGER; Schema: realtime; Owner: -
--

CREATE TRIGGER tr_check_filters BEFORE INSERT OR UPDATE ON realtime.subscription FOR EACH ROW EXECUTE FUNCTION realtime.subscription_check_filters();


--
-- Name: billing_detail trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.billing_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: billing_header trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.billing_header FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: customer trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.customer FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: customer_address trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.customer_address FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: customer_contact trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.customer_contact FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: customer_payment_term trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.customer_payment_term FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: invoice_pdf trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.invoice_pdf FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: item trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.item FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: item_category trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.item_category FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: item_price_master trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.item_price_master FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: item_uom trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.item_uom FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: order_detail trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.order_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: order_header trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.order_header FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: return_detail trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.return_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: return_header trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.return_header FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: sales_quotation trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.sales_quotation FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: sales_quotation_detail trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.sales_quotation_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: shipping_detail trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.shipping_detail FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: shipping_header trg_audit_iud; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_audit_iud AFTER INSERT OR DELETE OR UPDATE ON sales.shipping_header FOR EACH ROW EXECUTE FUNCTION core.trg_audit_iud();


--
-- Name: billing_detail trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.billing_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: billing_header trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.billing_header FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: customer trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.customer FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: customer_address trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.customer_address FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: customer_contact trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.customer_contact FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: customer_payment_term trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.customer_payment_term FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: invoice_pdf trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.invoice_pdf FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: item trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.item FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: item_category trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.item_category FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: item_price_master trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.item_price_master FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: item_uom trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.item_uom FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: order_detail trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.order_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: order_header trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.order_header FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: return_detail trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.return_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: return_header trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.return_header FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: sales_quotation trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.sales_quotation FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: sales_quotation_detail trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.sales_quotation_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: shipping_detail trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.shipping_detail FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: shipping_header trg_require_reason_code; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_require_reason_code BEFORE DELETE OR UPDATE ON sales.shipping_header FOR EACH ROW EXECUTE FUNCTION core.trg_require_reason_code();


--
-- Name: customer trg_sales_customer_audit; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_sales_customer_audit AFTER INSERT OR DELETE OR UPDATE ON sales.customer FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: invoice_pdf trg_sales_invoice_pdf_audit; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_sales_invoice_pdf_audit AFTER INSERT OR DELETE OR UPDATE ON sales.invoice_pdf FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: item trg_sales_item_audit; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_sales_item_audit AFTER INSERT OR DELETE OR UPDATE ON sales.item FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: item_category trg_sales_item_category_audit; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_sales_item_category_audit AFTER INSERT OR DELETE OR UPDATE ON sales.item_category FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: sales_quotation trg_sales_sales_quotation_audit; Type: TRIGGER; Schema: sales; Owner: -
--

CREATE TRIGGER trg_sales_sales_quotation_audit AFTER INSERT OR DELETE OR UPDATE ON sales.sales_quotation FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trail();


--
-- Name: buckets enforce_bucket_name_length_trigger; Type: TRIGGER; Schema: storage; Owner: -
--

CREATE TRIGGER enforce_bucket_name_length_trigger BEFORE INSERT OR UPDATE OF name ON storage.buckets FOR EACH ROW EXECUTE FUNCTION storage.enforce_bucket_name_length();


--
-- Name: objects objects_delete_delete_prefix; Type: TRIGGER; Schema: storage; Owner: -
--

CREATE TRIGGER objects_delete_delete_prefix AFTER DELETE ON storage.objects FOR EACH ROW EXECUTE FUNCTION storage.delete_prefix_hierarchy_trigger();


--
-- Name: objects objects_insert_create_prefix; Type: TRIGGER; Schema: storage; Owner: -
--

CREATE TRIGGER objects_insert_create_prefix BEFORE INSERT ON storage.objects FOR EACH ROW EXECUTE FUNCTION storage.objects_insert_prefix_trigger();


--
-- Name: objects objects_update_create_prefix; Type: TRIGGER; Schema: storage; Owner: -
--

CREATE TRIGGER objects_update_create_prefix BEFORE UPDATE ON storage.objects FOR EACH ROW WHEN (((new.name <> old.name) OR (new.bucket_id <> old.bucket_id))) EXECUTE FUNCTION storage.objects_update_prefix_trigger();


--
-- Name: prefixes prefixes_create_hierarchy; Type: TRIGGER; Schema: storage; Owner: -
--

CREATE TRIGGER prefixes_create_hierarchy BEFORE INSERT ON storage.prefixes FOR EACH ROW WHEN ((pg_trigger_depth() < 1)) EXECUTE FUNCTION storage.prefixes_insert_trigger();


--
-- Name: prefixes prefixes_delete_hierarchy; Type: TRIGGER; Schema: storage; Owner: -
--

CREATE TRIGGER prefixes_delete_hierarchy AFTER DELETE ON storage.prefixes FOR EACH ROW EXECUTE FUNCTION storage.delete_prefix_hierarchy_trigger();


--
-- Name: objects update_objects_updated_at; Type: TRIGGER; Schema: storage; Owner: -
--

CREATE TRIGGER update_objects_updated_at BEFORE UPDATE ON storage.objects FOR EACH ROW EXECUTE FUNCTION storage.update_updated_at_column();


--
-- Name: exec_command trg_exec_command_updated_at; Type: TRIGGER; Schema: system; Owner: -
--

CREATE TRIGGER trg_exec_command_updated_at BEFORE UPDATE ON system.exec_command FOR EACH ROW EXECUTE FUNCTION system.tg_set_updated_at();


--
-- Name: exec_run_request trg_exec_request_audit_ins; Type: TRIGGER; Schema: system; Owner: -
--

CREATE TRIGGER trg_exec_request_audit_ins AFTER INSERT ON system.exec_run_request FOR EACH ROW EXECUTE FUNCTION audit.tg_exec_request_ins();


--
-- Name: exec_run_request trg_exec_request_audit_upd; Type: TRIGGER; Schema: system; Owner: -
--

CREATE TRIGGER trg_exec_request_audit_upd AFTER UPDATE ON system.exec_run_request FOR EACH ROW EXECUTE FUNCTION audit.tg_exec_request_upd();


--
-- Name: exec_run_request trg_exec_run_notify; Type: TRIGGER; Schema: system; Owner: -
--

CREATE TRIGGER trg_exec_run_notify AFTER UPDATE ON system.exec_run_request FOR EACH ROW EXECUTE FUNCTION system.tg_exec_run_notify();


--
-- Name: loop_config trg_loop_config_updated_at; Type: TRIGGER; Schema: system; Owner: -
--

CREATE TRIGGER trg_loop_config_updated_at BEFORE UPDATE ON system.loop_config FOR EACH ROW EXECUTE FUNCTION system.tg_set_updated_at();


--
-- Name: paper_send_fee_journal paper_send_fee_journal_send_history_id_fkey; Type: FK CONSTRAINT; Schema: accounting; Owner: -
--

ALTER TABLE ONLY accounting.paper_send_fee_journal
    ADD CONSTRAINT paper_send_fee_journal_send_history_id_fkey FOREIGN KEY (send_history_id) REFERENCES ops.document_send_history(send_history_id);


--
-- Name: audit_ai_feedback audit_ai_feedback_alert_event_id_fkey; Type: FK CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_feedback
    ADD CONSTRAINT audit_ai_feedback_alert_event_id_fkey FOREIGN KEY (alert_event_id) REFERENCES analytics.audit_alert_event(alert_event_id) ON DELETE CASCADE;


--
-- Name: audit_ai_feedback audit_ai_feedback_judgement_id_fkey; Type: FK CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_feedback
    ADD CONSTRAINT audit_ai_feedback_judgement_id_fkey FOREIGN KEY (judgement_id) REFERENCES analytics.audit_alert_ai_judgement(judgement_id) ON DELETE SET NULL;


--
-- Name: audit_ai_job audit_ai_job_alert_event_id_fkey; Type: FK CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_job
    ADD CONSTRAINT audit_ai_job_alert_event_id_fkey FOREIGN KEY (alert_event_id) REFERENCES analytics.audit_alert_event(alert_event_id) ON DELETE CASCADE;


--
-- Name: audit_ai_llm_result audit_ai_llm_result_alert_event_id_fkey; Type: FK CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_ai_llm_result
    ADD CONSTRAINT audit_ai_llm_result_alert_event_id_fkey FOREIGN KEY (alert_event_id) REFERENCES analytics.audit_alert_event(alert_event_id) ON DELETE CASCADE;


--
-- Name: audit_alert_ai_judgement audit_alert_ai_judgement_alert_event_id_fkey; Type: FK CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_ai_judgement
    ADD CONSTRAINT audit_alert_ai_judgement_alert_event_id_fkey FOREIGN KEY (alert_event_id) REFERENCES analytics.audit_alert_event(alert_event_id) ON DELETE CASCADE;


--
-- Name: audit_alert_event audit_alert_event_rule_id_fkey; Type: FK CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_event
    ADD CONSTRAINT audit_alert_event_rule_id_fkey FOREIGN KEY (rule_id) REFERENCES analytics.audit_alert_rule(rule_id) ON DELETE CASCADE;


--
-- Name: audit_alert_notification audit_alert_notification_alert_event_id_fkey; Type: FK CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.audit_alert_notification
    ADD CONSTRAINT audit_alert_notification_alert_event_id_fkey FOREIGN KEY (alert_event_id) REFERENCES analytics.audit_alert_event(alert_event_id) ON DELETE CASCADE;


--
-- Name: fact_metric fact_metric_company_id_fkey; Type: FK CONSTRAINT; Schema: analytics; Owner: -
--

ALTER TABLE ONLY analytics.fact_metric
    ADD CONSTRAINT fact_metric_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: billing_payment billing_payment_invoice_id_fkey; Type: FK CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.billing_payment
    ADD CONSTRAINT billing_payment_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES approval.billing_invoice(invoice_id);


--
-- Name: company_plan company_plan_plan_code_fkey; Type: FK CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.company_plan
    ADD CONSTRAINT company_plan_plan_code_fkey FOREIGN KEY (plan_code) REFERENCES approval.plan_master(plan_code);


--
-- Name: invoice_delivery_log invoice_delivery_log_invoice_id_fkey; Type: FK CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.invoice_delivery_log
    ADD CONSTRAINT invoice_delivery_log_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES approval.billing_invoice(invoice_id);


--
-- Name: saas_company_map saas_company_map_subscription_id_fkey; Type: FK CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.saas_company_map
    ADD CONSTRAINT saas_company_map_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES approval.saas_subscription(subscription_id);


--
-- Name: saas_subscription saas_subscription_plan_code_fkey; Type: FK CONSTRAINT; Schema: approval; Owner: -
--

ALTER TABLE ONLY approval.saas_subscription
    ADD CONSTRAINT saas_subscription_plan_code_fkey FOREIGN KEY (plan_code) REFERENCES approval.saas_plan(plan_code);


--
-- Name: approval_log approval_log_approval_request_id_fkey; Type: FK CONSTRAINT; Schema: audit; Owner: -
--

ALTER TABLE ONLY audit.approval_log
    ADD CONSTRAINT approval_log_approval_request_id_fkey FOREIGN KEY (approval_request_id) REFERENCES audit.approval_request(request_id) ON DELETE CASCADE;


--
-- Name: identities identities_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.identities
    ADD CONSTRAINT identities_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: mfa_amr_claims mfa_amr_claims_session_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_amr_claims
    ADD CONSTRAINT mfa_amr_claims_session_id_fkey FOREIGN KEY (session_id) REFERENCES auth.sessions(id) ON DELETE CASCADE;


--
-- Name: mfa_challenges mfa_challenges_auth_factor_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_challenges
    ADD CONSTRAINT mfa_challenges_auth_factor_id_fkey FOREIGN KEY (factor_id) REFERENCES auth.mfa_factors(id) ON DELETE CASCADE;


--
-- Name: mfa_factors mfa_factors_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.mfa_factors
    ADD CONSTRAINT mfa_factors_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: oauth_authorizations oauth_authorizations_client_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_authorizations
    ADD CONSTRAINT oauth_authorizations_client_id_fkey FOREIGN KEY (client_id) REFERENCES auth.oauth_clients(id) ON DELETE CASCADE;


--
-- Name: oauth_authorizations oauth_authorizations_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_authorizations
    ADD CONSTRAINT oauth_authorizations_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: oauth_consents oauth_consents_client_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_consents
    ADD CONSTRAINT oauth_consents_client_id_fkey FOREIGN KEY (client_id) REFERENCES auth.oauth_clients(id) ON DELETE CASCADE;


--
-- Name: oauth_consents oauth_consents_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.oauth_consents
    ADD CONSTRAINT oauth_consents_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: one_time_tokens one_time_tokens_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.one_time_tokens
    ADD CONSTRAINT one_time_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: refresh_tokens refresh_tokens_session_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.refresh_tokens
    ADD CONSTRAINT refresh_tokens_session_id_fkey FOREIGN KEY (session_id) REFERENCES auth.sessions(id) ON DELETE CASCADE;


--
-- Name: saml_providers saml_providers_sso_provider_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_providers
    ADD CONSTRAINT saml_providers_sso_provider_id_fkey FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE;


--
-- Name: saml_relay_states saml_relay_states_flow_state_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_relay_states
    ADD CONSTRAINT saml_relay_states_flow_state_id_fkey FOREIGN KEY (flow_state_id) REFERENCES auth.flow_state(id) ON DELETE CASCADE;


--
-- Name: saml_relay_states saml_relay_states_sso_provider_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.saml_relay_states
    ADD CONSTRAINT saml_relay_states_sso_provider_id_fkey FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE;


--
-- Name: sessions sessions_oauth_client_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sessions
    ADD CONSTRAINT sessions_oauth_client_id_fkey FOREIGN KEY (oauth_client_id) REFERENCES auth.oauth_clients(id) ON DELETE CASCADE;


--
-- Name: sessions sessions_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sessions
    ADD CONSTRAINT sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: sso_domains sso_domains_sso_provider_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -
--

ALTER TABLE ONLY auth.sso_domains
    ADD CONSTRAINT sso_domains_sso_provider_id_fkey FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE;


--
-- Name: checkout_session checkout_session_invoice_id_fkey; Type: FK CONSTRAINT; Schema: billing; Owner: -
--

ALTER TABLE ONLY billing.checkout_session
    ADD CONSTRAINT checkout_session_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES billing.invoice(invoice_id);


--
-- Name: invoice_line invoice_line_invoice_id_fkey; Type: FK CONSTRAINT; Schema: billing; Owner: -
--

ALTER TABLE ONLY billing.invoice_line
    ADD CONSTRAINT invoice_line_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES billing.invoice(invoice_id);


--
-- Name: audit_action audit_action_audit_issue_id_fkey; Type: FK CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_action
    ADD CONSTRAINT audit_action_audit_issue_id_fkey FOREIGN KEY (audit_issue_id) REFERENCES compliance.audit_issue(audit_issue_id) ON DELETE CASCADE;


--
-- Name: audit_action audit_action_owner_id_fkey; Type: FK CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_action
    ADD CONSTRAINT audit_action_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES core.app_user(user_id);


--
-- Name: audit_event audit_event_company_id_fkey; Type: FK CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_event
    ADD CONSTRAINT audit_event_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: audit_event audit_event_iso_standard_id_fkey; Type: FK CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_event
    ADD CONSTRAINT audit_event_iso_standard_id_fkey FOREIGN KEY (iso_standard_id) REFERENCES compliance.iso_standard(iso_standard_id);


--
-- Name: audit_issue audit_issue_audit_event_id_fkey; Type: FK CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_issue
    ADD CONSTRAINT audit_issue_audit_event_id_fkey FOREIGN KEY (audit_event_id) REFERENCES compliance.audit_event(audit_event_id) ON DELETE CASCADE;


--
-- Name: audit_issue audit_issue_iso_clause_id_fkey; Type: FK CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.audit_issue
    ADD CONSTRAINT audit_issue_iso_clause_id_fkey FOREIGN KEY (iso_clause_id) REFERENCES compliance.iso_clause(iso_clause_id);


--
-- Name: iso_clause iso_clause_iso_standard_id_fkey; Type: FK CONSTRAINT; Schema: compliance; Owner: -
--

ALTER TABLE ONLY compliance.iso_clause
    ADD CONSTRAINT iso_clause_iso_standard_id_fkey FOREIGN KEY (iso_standard_id) REFERENCES compliance.iso_standard(iso_standard_id) ON DELETE CASCADE;


--
-- Name: accounting_period accounting_period_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.accounting_period
    ADD CONSTRAINT accounting_period_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: accounts accounts_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.accounts
    ADD CONSTRAINT accounts_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: app_user app_user_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.app_user
    ADD CONSTRAINT app_user_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: company_license company_license_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_license
    ADD CONSTRAINT company_license_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: company_license company_license_license_code_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_license
    ADD CONSTRAINT company_license_license_code_fkey FOREIGN KEY (license_code) REFERENCES core.license_master(code);


--
-- Name: company_permission company_permission_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_permission
    ADD CONSTRAINT company_permission_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: company_users company_users_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_users
    ADD CONSTRAINT company_users_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: company_users company_users_user_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.company_users
    ADD CONSTRAINT company_users_user_id_fkey FOREIGN KEY (user_id) REFERENCES core.app_user(user_id) ON DELETE CASCADE;


--
-- Name: document_sequence document_sequence_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.document_sequence
    ADD CONSTRAINT document_sequence_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: entity_attribute_value entity_attribute_value_attribute_def_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.entity_attribute_value
    ADD CONSTRAINT entity_attribute_value_attribute_def_id_fkey FOREIGN KEY (attribute_def_id) REFERENCES core.entity_attribute_def(attribute_def_id) ON DELETE CASCADE;


--
-- Name: journal_entries journal_entries_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_entries
    ADD CONSTRAINT journal_entries_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: journal_entries journal_entries_created_by_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_entries
    ADD CONSTRAINT journal_entries_created_by_fkey FOREIGN KEY (created_by) REFERENCES core.app_user(user_id);


--
-- Name: journal_entries journal_entries_period_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_entries
    ADD CONSTRAINT journal_entries_period_id_fkey FOREIGN KEY (period_id) REFERENCES core.accounting_period(period_id);


--
-- Name: journal_lines journal_lines_account_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_lines
    ADD CONSTRAINT journal_lines_account_id_fkey FOREIGN KEY (account_id) REFERENCES core.accounts(account_id);


--
-- Name: journal_lines journal_lines_journal_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_lines
    ADD CONSTRAINT journal_lines_journal_id_fkey FOREIGN KEY (journal_id) REFERENCES core.journal_entries(journal_id) ON DELETE CASCADE;


--
-- Name: journal_source_link journal_source_link_journal_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.journal_source_link
    ADD CONSTRAINT journal_source_link_journal_id_fkey FOREIGN KEY (journal_id) REFERENCES core.journal_entries(journal_id) ON DELETE CASCADE;


--
-- Name: login_history login_history_user_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.login_history
    ADD CONSTRAINT login_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES core.app_user(user_id) ON DELETE CASCADE;


--
-- Name: permission_group_permissions permission_group_permissions_group_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.permission_group_permissions
    ADD CONSTRAINT permission_group_permissions_group_id_fkey FOREIGN KEY (group_id) REFERENCES core.permission_groups(group_id) ON DELETE CASCADE;


--
-- Name: permission_group_permissions permission_group_permissions_permission_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.permission_group_permissions
    ADD CONSTRAINT permission_group_permissions_permission_id_fkey FOREIGN KEY (permission_id) REFERENCES core.permissions(permission_id) ON DELETE CASCADE;


--
-- Name: permission_groups permission_groups_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.permission_groups
    ADD CONSTRAINT permission_groups_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: posting_profile posting_profile_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.posting_profile
    ADD CONSTRAINT posting_profile_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: posting_profile posting_profile_credit_account_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.posting_profile
    ADD CONSTRAINT posting_profile_credit_account_id_fkey FOREIGN KEY (credit_account_id) REFERENCES core.accounts(account_id);


--
-- Name: posting_profile posting_profile_debit_account_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.posting_profile
    ADD CONSTRAINT posting_profile_debit_account_id_fkey FOREIGN KEY (debit_account_id) REFERENCES core.accounts(account_id);


--
-- Name: status_history status_history_changed_by_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.status_history
    ADD CONSTRAINT status_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES core.app_user(user_id);


--
-- Name: status_history status_history_company_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.status_history
    ADD CONSTRAINT status_history_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: uom_conversion uom_conversion_from_uom_code_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.uom_conversion
    ADD CONSTRAINT uom_conversion_from_uom_code_fkey FOREIGN KEY (from_uom_code) REFERENCES core.uom(uom_code);


--
-- Name: uom_conversion uom_conversion_to_uom_code_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.uom_conversion
    ADD CONSTRAINT uom_conversion_to_uom_code_fkey FOREIGN KEY (to_uom_code) REFERENCES core.uom(uom_code);


--
-- Name: user_permissions user_permissions_permission_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.user_permissions
    ADD CONSTRAINT user_permissions_permission_id_fkey FOREIGN KEY (permission_id) REFERENCES core.permissions(permission_id) ON DELETE CASCADE;


--
-- Name: user_permissions user_permissions_user_id_fkey; Type: FK CONSTRAINT; Schema: core; Owner: -
--

ALTER TABLE ONLY core.user_permissions
    ADD CONSTRAINT user_permissions_user_id_fkey FOREIGN KEY (user_id) REFERENCES core.app_user(user_id) ON DELETE CASCADE;


--
-- Name: codegen_artifact codegen_artifact_run_id_fkey; Type: FK CONSTRAINT; Schema: devops; Owner: -
--

ALTER TABLE ONLY devops.codegen_artifact
    ADD CONSTRAINT codegen_artifact_run_id_fkey FOREIGN KEY (run_id) REFERENCES devops.codegen_run(run_id);


--
-- Name: bank_account bank_account_company_id_fkey; Type: FK CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_account
    ADD CONSTRAINT bank_account_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: bank_statement_header bank_statement_header_bank_account_id_fkey; Type: FK CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_statement_header
    ADD CONSTRAINT bank_statement_header_bank_account_id_fkey FOREIGN KEY (bank_account_id) REFERENCES finance.bank_account(bank_account_id) ON DELETE CASCADE;


--
-- Name: bank_statement_line bank_statement_line_bank_statement_id_fkey; Type: FK CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.bank_statement_line
    ADD CONSTRAINT bank_statement_line_bank_statement_id_fkey FOREIGN KEY (bank_statement_id) REFERENCES finance.bank_statement_header(bank_statement_id) ON DELETE CASCADE;


--
-- Name: payment_allocation payment_allocation_payment_id_fkey; Type: FK CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.payment_allocation
    ADD CONSTRAINT payment_allocation_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES finance.payment(payment_id) ON DELETE CASCADE;


--
-- Name: payment payment_bank_account_id_fkey; Type: FK CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.payment
    ADD CONSTRAINT payment_bank_account_id_fkey FOREIGN KEY (bank_account_id) REFERENCES finance.bank_account(bank_account_id);


--
-- Name: payment payment_company_id_fkey; Type: FK CONSTRAINT; Schema: finance; Owner: -
--

ALTER TABLE ONLY finance.payment
    ADD CONSTRAINT payment_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: business_rule_action business_rule_action_business_rule_id_fkey; Type: FK CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.business_rule_action
    ADD CONSTRAINT business_rule_action_business_rule_id_fkey FOREIGN KEY (business_rule_id) REFERENCES governance.business_rule(business_rule_id) ON DELETE CASCADE;


--
-- Name: business_rule business_rule_company_id_fkey; Type: FK CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.business_rule
    ADD CONSTRAINT business_rule_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: business_rule_condition business_rule_condition_business_rule_id_fkey; Type: FK CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.business_rule_condition
    ADD CONSTRAINT business_rule_condition_business_rule_id_fkey FOREIGN KEY (business_rule_id) REFERENCES governance.business_rule(business_rule_id) ON DELETE CASCADE;


--
-- Name: contract_header contract_header_company_id_fkey; Type: FK CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.contract_header
    ADD CONSTRAINT contract_header_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: contract_item_price contract_item_price_contract_id_fkey; Type: FK CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.contract_item_price
    ADD CONSTRAINT contract_item_price_contract_id_fkey FOREIGN KEY (contract_id) REFERENCES governance.contract_header(contract_id) ON DELETE CASCADE;


--
-- Name: contract_item_price contract_item_price_item_id_fkey; Type: FK CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.contract_item_price
    ADD CONSTRAINT contract_item_price_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: document_archive document_archive_company_id_fkey; Type: FK CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.document_archive
    ADD CONSTRAINT document_archive_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: document_archive document_archive_document_category_id_fkey; Type: FK CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.document_archive
    ADD CONSTRAINT document_archive_document_category_id_fkey FOREIGN KEY (document_category_id) REFERENCES governance.document_category(document_category_id);


--
-- Name: policy_change_queue policy_change_queue_source_alert_event_id_fkey; Type: FK CONSTRAINT; Schema: governance; Owner: -
--

ALTER TABLE ONLY governance.policy_change_queue
    ADD CONSTRAINT policy_change_queue_source_alert_event_id_fkey FOREIGN KEY (source_alert_event_id) REFERENCES analytics.audit_alert_event(alert_event_id);


--
-- Name: attendance_log attendance_log_company_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.attendance_log
    ADD CONSTRAINT attendance_log_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: attendance_log attendance_log_employee_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.attendance_log
    ADD CONSTRAINT attendance_log_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES hr.employee(employee_id) ON DELETE CASCADE;


--
-- Name: employee employee_company_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.employee
    ADD CONSTRAINT employee_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: employee employee_department_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.employee
    ADD CONSTRAINT employee_department_id_fkey FOREIGN KEY (department_id) REFERENCES hr.hr_department(department_id);


--
-- Name: employee employee_position_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.employee
    ADD CONSTRAINT employee_position_id_fkey FOREIGN KEY (position_id) REFERENCES hr.hr_position(position_id);


--
-- Name: employment_contract employment_contract_company_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.employment_contract
    ADD CONSTRAINT employment_contract_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: employment_contract employment_contract_employee_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.employment_contract
    ADD CONSTRAINT employment_contract_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES hr.employee(employee_id) ON DELETE CASCADE;


--
-- Name: hr_department hr_department_company_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.hr_department
    ADD CONSTRAINT hr_department_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: hr_position hr_position_company_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.hr_position
    ADD CONSTRAINT hr_position_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: leave_request leave_request_approved_by_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.leave_request
    ADD CONSTRAINT leave_request_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES core.app_user(user_id);


--
-- Name: leave_request leave_request_company_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.leave_request
    ADD CONSTRAINT leave_request_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: leave_request leave_request_employee_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.leave_request
    ADD CONSTRAINT leave_request_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES hr.employee(employee_id) ON DELETE CASCADE;


--
-- Name: leave_request leave_request_leave_type_code_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.leave_request
    ADD CONSTRAINT leave_request_leave_type_code_fkey FOREIGN KEY (leave_type_code) REFERENCES hr.leave_type(leave_type_code);


--
-- Name: payroll_run payroll_run_company_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.payroll_run
    ADD CONSTRAINT payroll_run_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: payroll_slip payroll_slip_employee_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.payroll_slip
    ADD CONSTRAINT payroll_slip_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES hr.employee(employee_id);


--
-- Name: payroll_slip payroll_slip_payroll_run_id_fkey; Type: FK CONSTRAINT; Schema: hr; Owner: -
--

ALTER TABLE ONLY hr.payroll_slip
    ADD CONSTRAINT payroll_slip_payroll_run_id_fkey FOREIGN KEY (payroll_run_id) REFERENCES hr.payroll_run(payroll_run_id) ON DELETE CASCADE;


--
-- Name: api_credential api_credential_external_system_id_fkey; Type: FK CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.api_credential
    ADD CONSTRAINT api_credential_external_system_id_fkey FOREIGN KEY (external_system_id) REFERENCES integration.external_system(external_system_id) ON DELETE CASCADE;


--
-- Name: external_system external_system_company_id_fkey; Type: FK CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.external_system
    ADD CONSTRAINT external_system_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: integration_job integration_job_external_system_id_fkey; Type: FK CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.integration_job
    ADD CONSTRAINT integration_job_external_system_id_fkey FOREIGN KEY (external_system_id) REFERENCES integration.external_system(external_system_id) ON DELETE CASCADE;


--
-- Name: integration_log integration_log_integration_job_id_fkey; Type: FK CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.integration_log
    ADD CONSTRAINT integration_log_integration_job_id_fkey FOREIGN KEY (integration_job_id) REFERENCES integration.integration_job(integration_job_id) ON DELETE CASCADE;


--
-- Name: siem_delivery_queue siem_delivery_queue_endpoint_id_fkey; Type: FK CONSTRAINT; Schema: integration; Owner: -
--

ALTER TABLE ONLY integration.siem_delivery_queue
    ADD CONSTRAINT siem_delivery_queue_endpoint_id_fkey FOREIGN KEY (endpoint_id) REFERENCES integration.siem_endpoint(endpoint_id) ON DELETE CASCADE;


--
-- Name: inventory_valuation inventory_valuation_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.inventory_valuation
    ADD CONSTRAINT inventory_valuation_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: inventory_valuation inventory_valuation_item_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.inventory_valuation
    ADD CONSTRAINT inventory_valuation_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: stock_balance stock_balance_bin_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_balance
    ADD CONSTRAINT stock_balance_bin_id_fkey FOREIGN KEY (bin_id) REFERENCES inventory.stock_bin(bin_id);


--
-- Name: stock_balance stock_balance_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_balance
    ADD CONSTRAINT stock_balance_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: stock_balance stock_balance_item_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_balance
    ADD CONSTRAINT stock_balance_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: stock_balance stock_balance_location_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_balance
    ADD CONSTRAINT stock_balance_location_id_fkey FOREIGN KEY (location_id) REFERENCES inventory.storage_location(location_id);


--
-- Name: stock_balance stock_balance_warehouse_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_balance
    ADD CONSTRAINT stock_balance_warehouse_id_fkey FOREIGN KEY (warehouse_id) REFERENCES inventory.warehouse(warehouse_id);


--
-- Name: stock_bin stock_bin_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_bin
    ADD CONSTRAINT stock_bin_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: stock_bin stock_bin_location_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_bin
    ADD CONSTRAINT stock_bin_location_id_fkey FOREIGN KEY (location_id) REFERENCES inventory.storage_location(location_id) ON DELETE CASCADE;


--
-- Name: stock_lot_balance stock_lot_balance_bin_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot_balance
    ADD CONSTRAINT stock_lot_balance_bin_id_fkey FOREIGN KEY (bin_id) REFERENCES inventory.stock_bin(bin_id);


--
-- Name: stock_lot_balance stock_lot_balance_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot_balance
    ADD CONSTRAINT stock_lot_balance_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: stock_lot_balance stock_lot_balance_item_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot_balance
    ADD CONSTRAINT stock_lot_balance_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: stock_lot_balance stock_lot_balance_location_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot_balance
    ADD CONSTRAINT stock_lot_balance_location_id_fkey FOREIGN KEY (location_id) REFERENCES inventory.storage_location(location_id);


--
-- Name: stock_lot_balance stock_lot_balance_stock_lot_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot_balance
    ADD CONSTRAINT stock_lot_balance_stock_lot_id_fkey FOREIGN KEY (stock_lot_id) REFERENCES inventory.stock_lot(stock_lot_id);


--
-- Name: stock_lot_balance stock_lot_balance_warehouse_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot_balance
    ADD CONSTRAINT stock_lot_balance_warehouse_id_fkey FOREIGN KEY (warehouse_id) REFERENCES inventory.warehouse(warehouse_id);


--
-- Name: stock_lot stock_lot_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot
    ADD CONSTRAINT stock_lot_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: stock_lot stock_lot_item_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_lot
    ADD CONSTRAINT stock_lot_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: stock_reservation stock_reservation_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_reservation
    ADD CONSTRAINT stock_reservation_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: stock_reservation stock_reservation_item_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_reservation
    ADD CONSTRAINT stock_reservation_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: stock_reservation stock_reservation_stock_lot_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_reservation
    ADD CONSTRAINT stock_reservation_stock_lot_id_fkey FOREIGN KEY (stock_lot_id) REFERENCES inventory.stock_lot(stock_lot_id);


--
-- Name: stock_transaction stock_transaction_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transaction
    ADD CONSTRAINT stock_transaction_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: stock_transaction stock_transaction_from_bin_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transaction
    ADD CONSTRAINT stock_transaction_from_bin_id_fkey FOREIGN KEY (from_bin_id) REFERENCES inventory.stock_bin(bin_id);


--
-- Name: stock_transaction stock_transaction_item_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transaction
    ADD CONSTRAINT stock_transaction_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: stock_transaction stock_transaction_stock_lot_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transaction
    ADD CONSTRAINT stock_transaction_stock_lot_id_fkey FOREIGN KEY (stock_lot_id) REFERENCES inventory.stock_lot(stock_lot_id);


--
-- Name: stock_transaction stock_transaction_to_bin_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transaction
    ADD CONSTRAINT stock_transaction_to_bin_id_fkey FOREIGN KEY (to_bin_id) REFERENCES inventory.stock_bin(bin_id);


--
-- Name: stock_transaction stock_transaction_warehouse_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transaction
    ADD CONSTRAINT stock_transaction_warehouse_id_fkey FOREIGN KEY (warehouse_id) REFERENCES inventory.warehouse(warehouse_id);


--
-- Name: stock_transfer_detail stock_transfer_detail_from_bin_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_detail
    ADD CONSTRAINT stock_transfer_detail_from_bin_id_fkey FOREIGN KEY (from_bin_id) REFERENCES inventory.stock_bin(bin_id);


--
-- Name: stock_transfer_detail stock_transfer_detail_from_location_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_detail
    ADD CONSTRAINT stock_transfer_detail_from_location_id_fkey FOREIGN KEY (from_location_id) REFERENCES inventory.storage_location(location_id);


--
-- Name: stock_transfer_detail stock_transfer_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_detail
    ADD CONSTRAINT stock_transfer_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: stock_transfer_detail stock_transfer_detail_stock_lot_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_detail
    ADD CONSTRAINT stock_transfer_detail_stock_lot_id_fkey FOREIGN KEY (stock_lot_id) REFERENCES inventory.stock_lot(stock_lot_id);


--
-- Name: stock_transfer_detail stock_transfer_detail_stock_transfer_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_detail
    ADD CONSTRAINT stock_transfer_detail_stock_transfer_id_fkey FOREIGN KEY (stock_transfer_id) REFERENCES inventory.stock_transfer_header(stock_transfer_id) ON DELETE CASCADE;


--
-- Name: stock_transfer_detail stock_transfer_detail_to_bin_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_detail
    ADD CONSTRAINT stock_transfer_detail_to_bin_id_fkey FOREIGN KEY (to_bin_id) REFERENCES inventory.stock_bin(bin_id);


--
-- Name: stock_transfer_detail stock_transfer_detail_to_location_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_detail
    ADD CONSTRAINT stock_transfer_detail_to_location_id_fkey FOREIGN KEY (to_location_id) REFERENCES inventory.storage_location(location_id);


--
-- Name: stock_transfer_header stock_transfer_header_approved_by_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_header
    ADD CONSTRAINT stock_transfer_header_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES core.app_user(user_id);


--
-- Name: stock_transfer_header stock_transfer_header_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_header
    ADD CONSTRAINT stock_transfer_header_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: stock_transfer_header stock_transfer_header_from_warehouse_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_header
    ADD CONSTRAINT stock_transfer_header_from_warehouse_id_fkey FOREIGN KEY (from_warehouse_id) REFERENCES inventory.warehouse(warehouse_id);


--
-- Name: stock_transfer_header stock_transfer_header_requested_by_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_header
    ADD CONSTRAINT stock_transfer_header_requested_by_fkey FOREIGN KEY (requested_by) REFERENCES core.app_user(user_id);


--
-- Name: stock_transfer_header stock_transfer_header_to_warehouse_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stock_transfer_header
    ADD CONSTRAINT stock_transfer_header_to_warehouse_id_fkey FOREIGN KEY (to_warehouse_id) REFERENCES inventory.warehouse(warehouse_id);


--
-- Name: stocktaking_plan stocktaking_plan_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stocktaking_plan
    ADD CONSTRAINT stocktaking_plan_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: stocktaking_plan stocktaking_plan_warehouse_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stocktaking_plan
    ADD CONSTRAINT stocktaking_plan_warehouse_id_fkey FOREIGN KEY (warehouse_id) REFERENCES inventory.warehouse(warehouse_id);


--
-- Name: stocktaking_result stocktaking_result_bin_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stocktaking_result
    ADD CONSTRAINT stocktaking_result_bin_id_fkey FOREIGN KEY (bin_id) REFERENCES inventory.stock_bin(bin_id);


--
-- Name: stocktaking_result stocktaking_result_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stocktaking_result
    ADD CONSTRAINT stocktaking_result_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: stocktaking_result stocktaking_result_item_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stocktaking_result
    ADD CONSTRAINT stocktaking_result_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: stocktaking_result stocktaking_result_stocktaking_plan_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.stocktaking_result
    ADD CONSTRAINT stocktaking_result_stocktaking_plan_id_fkey FOREIGN KEY (stocktaking_plan_id) REFERENCES inventory.stocktaking_plan(stocktaking_plan_id) ON DELETE CASCADE;


--
-- Name: storage_location storage_location_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.storage_location
    ADD CONSTRAINT storage_location_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: storage_location storage_location_warehouse_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.storage_location
    ADD CONSTRAINT storage_location_warehouse_id_fkey FOREIGN KEY (warehouse_id) REFERENCES inventory.warehouse(warehouse_id) ON DELETE CASCADE;


--
-- Name: warehouse warehouse_company_id_fkey; Type: FK CONSTRAINT; Schema: inventory; Owner: -
--

ALTER TABLE ONLY inventory.warehouse
    ADD CONSTRAINT warehouse_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: bom_detail bom_detail_bom_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.bom_detail
    ADD CONSTRAINT bom_detail_bom_id_fkey FOREIGN KEY (bom_id) REFERENCES manufacturing.bom_header(bom_id) ON DELETE CASCADE;


--
-- Name: bom_detail bom_detail_component_item_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.bom_detail
    ADD CONSTRAINT bom_detail_component_item_id_fkey FOREIGN KEY (component_item_id) REFERENCES sales.item(item_id);


--
-- Name: bom_header bom_header_company_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.bom_header
    ADD CONSTRAINT bom_header_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: bom_header bom_header_parent_item_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.bom_header
    ADD CONSTRAINT bom_header_parent_item_id_fkey FOREIGN KEY (parent_item_id) REFERENCES sales.item(item_id);


--
-- Name: manufacturing_cost_snapshot manufacturing_cost_snapshot_company_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_cost_snapshot
    ADD CONSTRAINT manufacturing_cost_snapshot_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: manufacturing_cost_snapshot manufacturing_cost_snapshot_work_order_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_cost_snapshot
    ADD CONSTRAINT manufacturing_cost_snapshot_work_order_id_fkey FOREIGN KEY (work_order_id) REFERENCES manufacturing.work_order(work_order_id) ON DELETE CASCADE;


--
-- Name: manufacturing_execution manufacturing_execution_company_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_execution
    ADD CONSTRAINT manufacturing_execution_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: manufacturing_execution_detail manufacturing_execution_detail_execution_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_execution_detail
    ADD CONSTRAINT manufacturing_execution_detail_execution_id_fkey FOREIGN KEY (execution_id) REFERENCES manufacturing.manufacturing_execution(execution_id) ON DELETE CASCADE;


--
-- Name: manufacturing_execution_detail manufacturing_execution_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_execution_detail
    ADD CONSTRAINT manufacturing_execution_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: manufacturing_execution manufacturing_execution_warehouse_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_execution
    ADD CONSTRAINT manufacturing_execution_warehouse_id_fkey FOREIGN KEY (warehouse_id) REFERENCES inventory.warehouse(warehouse_id);


--
-- Name: manufacturing_execution manufacturing_execution_work_order_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.manufacturing_execution
    ADD CONSTRAINT manufacturing_execution_work_order_id_fkey FOREIGN KEY (work_order_id) REFERENCES manufacturing.work_order(work_order_id) ON DELETE CASCADE;


--
-- Name: mps_plan mps_plan_item_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mps_plan
    ADD CONSTRAINT mps_plan_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: mps_plan mps_plan_mps_run_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mps_plan
    ADD CONSTRAINT mps_plan_mps_run_id_fkey FOREIGN KEY (mps_run_id) REFERENCES manufacturing.mps_run(mps_run_id) ON DELETE CASCADE;


--
-- Name: mps_run mps_run_company_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mps_run
    ADD CONSTRAINT mps_run_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: mrp_allocation mrp_allocation_mrp_requirement_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mrp_allocation
    ADD CONSTRAINT mrp_allocation_mrp_requirement_id_fkey FOREIGN KEY (mrp_requirement_id) REFERENCES manufacturing.mrp_requirement(mrp_requirement_id) ON DELETE CASCADE;


--
-- Name: mrp_requirement mrp_requirement_item_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mrp_requirement
    ADD CONSTRAINT mrp_requirement_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: mrp_requirement mrp_requirement_mrp_run_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mrp_requirement
    ADD CONSTRAINT mrp_requirement_mrp_run_id_fkey FOREIGN KEY (mrp_run_id) REFERENCES manufacturing.mrp_run(mrp_run_id) ON DELETE CASCADE;


--
-- Name: mrp_run mrp_run_company_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.mrp_run
    ADD CONSTRAINT mrp_run_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: process_master process_master_company_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.process_master
    ADD CONSTRAINT process_master_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: routing_header routing_header_company_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.routing_header
    ADD CONSTRAINT routing_header_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: routing_header routing_header_item_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.routing_header
    ADD CONSTRAINT routing_header_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: routing_operation routing_operation_process_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.routing_operation
    ADD CONSTRAINT routing_operation_process_id_fkey FOREIGN KEY (process_id) REFERENCES manufacturing.process_master(process_id);


--
-- Name: routing_operation routing_operation_routing_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.routing_operation
    ADD CONSTRAINT routing_operation_routing_id_fkey FOREIGN KEY (routing_id) REFERENCES manufacturing.routing_header(routing_id) ON DELETE CASCADE;


--
-- Name: work_order work_order_bom_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.work_order
    ADD CONSTRAINT work_order_bom_id_fkey FOREIGN KEY (bom_id) REFERENCES manufacturing.bom_header(bom_id);


--
-- Name: work_order work_order_company_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.work_order
    ADD CONSTRAINT work_order_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: work_order work_order_item_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.work_order
    ADD CONSTRAINT work_order_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: work_order work_order_routing_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.work_order
    ADD CONSTRAINT work_order_routing_id_fkey FOREIGN KEY (routing_id) REFERENCES manufacturing.routing_header(routing_id);


--
-- Name: work_order work_order_warehouse_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.work_order
    ADD CONSTRAINT work_order_warehouse_id_fkey FOREIGN KEY (warehouse_id) REFERENCES inventory.warehouse(warehouse_id);


--
-- Name: yield_metric yield_metric_company_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.yield_metric
    ADD CONSTRAINT yield_metric_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: yield_metric yield_metric_process_id_fkey; Type: FK CONSTRAINT; Schema: manufacturing; Owner: -
--

ALTER TABLE ONLY manufacturing.yield_metric
    ADD CONSTRAINT yield_metric_process_id_fkey FOREIGN KEY (process_id) REFERENCES manufacturing.process_master(process_id);


--
-- Name: asset_link asset_link_asset_id_fkey; Type: FK CONSTRAINT; Schema: media; Owner: -
--

ALTER TABLE ONLY media.asset_link
    ADD CONSTRAINT asset_link_asset_id_fkey FOREIGN KEY (asset_id) REFERENCES media.asset(asset_id) ON DELETE CASCADE;


--
-- Name: ai_event ai_event_ai_rule_id_fkey; Type: FK CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.ai_event
    ADD CONSTRAINT ai_event_ai_rule_id_fkey FOREIGN KEY (ai_rule_id) REFERENCES notify.ai_rule(ai_rule_id) ON DELETE SET NULL;


--
-- Name: approval_action_log approval_action_log_approval_request_id_fkey; Type: FK CONSTRAINT; Schema: notify; Owner: -
--

ALTER TABLE ONLY notify.approval_action_log
    ADD CONSTRAINT approval_action_log_approval_request_id_fkey FOREIGN KEY (approval_request_id) REFERENCES notify.approval_request(approval_request_id) ON DELETE CASCADE;


--
-- Name: document_file document_file_document_type_code_fkey; Type: FK CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_file
    ADD CONSTRAINT document_file_document_type_code_fkey FOREIGN KEY (document_type_code) REFERENCES ops.document_type_master(document_type_code);


--
-- Name: document_send_history document_send_history_channel_code_fkey; Type: FK CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_send_history
    ADD CONSTRAINT document_send_history_channel_code_fkey FOREIGN KEY (channel_code) REFERENCES ops.send_channel_master(channel_code);


--
-- Name: document_send_history document_send_history_document_type_code_fkey; Type: FK CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_send_history
    ADD CONSTRAINT document_send_history_document_type_code_fkey FOREIGN KEY (document_type_code) REFERENCES ops.document_type_master(document_type_code);


--
-- Name: document_send_history document_send_history_resend_type_code_fkey; Type: FK CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.document_send_history
    ADD CONSTRAINT document_send_history_resend_type_code_fkey FOREIGN KEY (resend_type_code) REFERENCES ops.resend_type_master(resend_type_code);


--
-- Name: ops_job_result fk_ops_job_result_job; Type: FK CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.ops_job_result
    ADD CONSTRAINT fk_ops_job_result_job FOREIGN KEY (job_id) REFERENCES ops.ops_job_queue(job_id) NOT VALID;


--
-- Name: ops_job_result ops_job_result_job_id_fkey; Type: FK CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.ops_job_result
    ADD CONSTRAINT ops_job_result_job_id_fkey FOREIGN KEY (job_id) REFERENCES ops.ops_job_queue(job_id) ON DELETE CASCADE;


--
-- Name: send_fee_master send_fee_master_document_type_code_fkey; Type: FK CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.send_fee_master
    ADD CONSTRAINT send_fee_master_document_type_code_fkey FOREIGN KEY (document_type_code) REFERENCES ops.document_type_master(document_type_code);


--
-- Name: send_fee_master send_fee_master_resend_type_code_fkey; Type: FK CONSTRAINT; Schema: ops; Owner: -
--

ALTER TABLE ONLY ops.send_fee_master
    ADD CONSTRAINT send_fee_master_resend_type_code_fkey FOREIGN KEY (resend_type_code) REFERENCES ops.resend_type_master(resend_type_code);


--
-- Name: purchase_invoice purchase_invoice_company_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice
    ADD CONSTRAINT purchase_invoice_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: purchase_invoice_detail purchase_invoice_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice_detail
    ADD CONSTRAINT purchase_invoice_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: purchase_invoice_detail purchase_invoice_detail_purchase_invoice_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice_detail
    ADD CONSTRAINT purchase_invoice_detail_purchase_invoice_id_fkey FOREIGN KEY (purchase_invoice_id) REFERENCES purchase.purchase_invoice(purchase_invoice_id) ON DELETE CASCADE;


--
-- Name: purchase_invoice_detail purchase_invoice_detail_purchase_order_detail_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice_detail
    ADD CONSTRAINT purchase_invoice_detail_purchase_order_detail_id_fkey FOREIGN KEY (purchase_order_detail_id) REFERENCES purchase.purchase_order_detail(purchase_order_detail_id);


--
-- Name: purchase_invoice_detail purchase_invoice_detail_receipt_detail_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice_detail
    ADD CONSTRAINT purchase_invoice_detail_receipt_detail_id_fkey FOREIGN KEY (receipt_detail_id) REFERENCES purchase.purchase_receipt_detail(receipt_detail_id);


--
-- Name: purchase_invoice purchase_invoice_supplier_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_invoice
    ADD CONSTRAINT purchase_invoice_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES purchase.supplier_master(supplier_id);


--
-- Name: purchase_order_detail purchase_order_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_detail
    ADD CONSTRAINT purchase_order_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: purchase_order_detail purchase_order_detail_purchase_order_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_detail
    ADD CONSTRAINT purchase_order_detail_purchase_order_id_fkey FOREIGN KEY (purchase_order_id) REFERENCES purchase.purchase_order_header(purchase_order_id) ON DELETE CASCADE;


--
-- Name: purchase_order_header purchase_order_header_company_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_header
    ADD CONSTRAINT purchase_order_header_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: purchase_order_header purchase_order_header_created_by_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_header
    ADD CONSTRAINT purchase_order_header_created_by_fkey FOREIGN KEY (created_by) REFERENCES core.app_user(user_id);


--
-- Name: purchase_order_header purchase_order_header_supplier_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_order_header
    ADD CONSTRAINT purchase_order_header_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES purchase.supplier_master(supplier_id);


--
-- Name: purchase_quotation purchase_quotation_company_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_quotation
    ADD CONSTRAINT purchase_quotation_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: purchase_quotation_detail purchase_quotation_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_quotation_detail
    ADD CONSTRAINT purchase_quotation_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: purchase_quotation_detail purchase_quotation_detail_purchase_quotation_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_quotation_detail
    ADD CONSTRAINT purchase_quotation_detail_purchase_quotation_id_fkey FOREIGN KEY (purchase_quotation_id) REFERENCES purchase.purchase_quotation(purchase_quotation_id) ON DELETE CASCADE;


--
-- Name: purchase_quotation purchase_quotation_supplier_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_quotation
    ADD CONSTRAINT purchase_quotation_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES purchase.supplier_master(supplier_id);


--
-- Name: purchase_receipt purchase_receipt_company_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt
    ADD CONSTRAINT purchase_receipt_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: purchase_receipt_detail purchase_receipt_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt_detail
    ADD CONSTRAINT purchase_receipt_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: purchase_receipt_detail purchase_receipt_detail_purchase_order_detail_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt_detail
    ADD CONSTRAINT purchase_receipt_detail_purchase_order_detail_id_fkey FOREIGN KEY (purchase_order_detail_id) REFERENCES purchase.purchase_order_detail(purchase_order_detail_id);


--
-- Name: purchase_receipt_detail purchase_receipt_detail_receipt_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt_detail
    ADD CONSTRAINT purchase_receipt_detail_receipt_id_fkey FOREIGN KEY (receipt_id) REFERENCES purchase.purchase_receipt(receipt_id) ON DELETE CASCADE;


--
-- Name: purchase_receipt purchase_receipt_purchase_order_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt
    ADD CONSTRAINT purchase_receipt_purchase_order_id_fkey FOREIGN KEY (purchase_order_id) REFERENCES purchase.purchase_order_header(purchase_order_id);


--
-- Name: purchase_receipt purchase_receipt_warehouse_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_receipt
    ADD CONSTRAINT purchase_receipt_warehouse_id_fkey FOREIGN KEY (warehouse_id) REFERENCES inventory.warehouse(warehouse_id);


--
-- Name: purchase_requisition purchase_requisition_company_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_requisition
    ADD CONSTRAINT purchase_requisition_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: purchase_requisition_detail purchase_requisition_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_requisition_detail
    ADD CONSTRAINT purchase_requisition_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: purchase_requisition_detail purchase_requisition_detail_purchase_requisition_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_requisition_detail
    ADD CONSTRAINT purchase_requisition_detail_purchase_requisition_id_fkey FOREIGN KEY (purchase_requisition_id) REFERENCES purchase.purchase_requisition(purchase_requisition_id) ON DELETE CASCADE;


--
-- Name: purchase_requisition purchase_requisition_requester_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_requisition
    ADD CONSTRAINT purchase_requisition_requester_id_fkey FOREIGN KEY (requester_id) REFERENCES core.app_user(user_id);


--
-- Name: purchase_three_way_match purchase_three_way_match_company_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_three_way_match
    ADD CONSTRAINT purchase_three_way_match_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: purchase_three_way_match purchase_three_way_match_purchase_invoice_detail_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_three_way_match
    ADD CONSTRAINT purchase_three_way_match_purchase_invoice_detail_id_fkey FOREIGN KEY (purchase_invoice_detail_id) REFERENCES purchase.purchase_invoice_detail(purchase_invoice_detail_id);


--
-- Name: purchase_three_way_match purchase_three_way_match_purchase_order_detail_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_three_way_match
    ADD CONSTRAINT purchase_three_way_match_purchase_order_detail_id_fkey FOREIGN KEY (purchase_order_detail_id) REFERENCES purchase.purchase_order_detail(purchase_order_detail_id);


--
-- Name: purchase_three_way_match purchase_three_way_match_receipt_detail_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.purchase_three_way_match
    ADD CONSTRAINT purchase_three_way_match_receipt_detail_id_fkey FOREIGN KEY (receipt_detail_id) REFERENCES purchase.purchase_receipt_detail(receipt_detail_id);


--
-- Name: supplier_address supplier_address_supplier_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_address
    ADD CONSTRAINT supplier_address_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES purchase.supplier_master(supplier_id) ON DELETE CASCADE;


--
-- Name: supplier_contact supplier_contact_supplier_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_contact
    ADD CONSTRAINT supplier_contact_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES purchase.supplier_master(supplier_id) ON DELETE CASCADE;


--
-- Name: supplier_item_price supplier_item_price_company_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_item_price
    ADD CONSTRAINT supplier_item_price_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: supplier_item_price supplier_item_price_item_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_item_price
    ADD CONSTRAINT supplier_item_price_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: supplier_item_price supplier_item_price_supplier_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_item_price
    ADD CONSTRAINT supplier_item_price_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES purchase.supplier_master(supplier_id);


--
-- Name: supplier_master supplier_master_company_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_master
    ADD CONSTRAINT supplier_master_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: supplier_payment_term supplier_payment_term_payment_method_code_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_payment_term
    ADD CONSTRAINT supplier_payment_term_payment_method_code_fkey FOREIGN KEY (payment_method_code) REFERENCES core.payment_method(payment_method_code);


--
-- Name: supplier_payment_term supplier_payment_term_payment_term_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_payment_term
    ADD CONSTRAINT supplier_payment_term_payment_term_id_fkey FOREIGN KEY (payment_term_id) REFERENCES core.payment_term(payment_term_id);


--
-- Name: supplier_payment_term supplier_payment_term_supplier_id_fkey; Type: FK CONSTRAINT; Schema: purchase; Owner: -
--

ALTER TABLE ONLY purchase.supplier_payment_term
    ADD CONSTRAINT supplier_payment_term_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES purchase.supplier_master(supplier_id) ON DELETE CASCADE;


--
-- Name: billing_detail billing_detail_billing_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_detail
    ADD CONSTRAINT billing_detail_billing_id_fkey FOREIGN KEY (billing_id) REFERENCES sales.billing_header(billing_id) ON DELETE CASCADE;


--
-- Name: billing_detail billing_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_detail
    ADD CONSTRAINT billing_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: billing_header billing_header_company_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_header
    ADD CONSTRAINT billing_header_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: billing_header billing_header_created_by_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_header
    ADD CONSTRAINT billing_header_created_by_fkey FOREIGN KEY (created_by) REFERENCES core.app_user(user_id);


--
-- Name: billing_header billing_header_customer_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.billing_header
    ADD CONSTRAINT billing_header_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES sales.customer(customer_id);


--
-- Name: customer_address customer_address_customer_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_address
    ADD CONSTRAINT customer_address_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES sales.customer(customer_id) ON DELETE CASCADE;


--
-- Name: customer customer_company_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer
    ADD CONSTRAINT customer_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: customer_contact customer_contact_customer_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_contact
    ADD CONSTRAINT customer_contact_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES sales.customer(customer_id) ON DELETE CASCADE;


--
-- Name: customer_payment_term customer_payment_term_customer_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_payment_term
    ADD CONSTRAINT customer_payment_term_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES sales.customer(customer_id) ON DELETE CASCADE;


--
-- Name: customer_payment_term customer_payment_term_payment_method_code_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_payment_term
    ADD CONSTRAINT customer_payment_term_payment_method_code_fkey FOREIGN KEY (payment_method_code) REFERENCES core.payment_method(payment_method_code);


--
-- Name: customer_payment_term customer_payment_term_payment_term_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.customer_payment_term
    ADD CONSTRAINT customer_payment_term_payment_term_id_fkey FOREIGN KEY (payment_term_id) REFERENCES core.payment_term(payment_term_id);


--
-- Name: invoice_pdf invoice_pdf_billing_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.invoice_pdf
    ADD CONSTRAINT invoice_pdf_billing_id_fkey FOREIGN KEY (billing_id) REFERENCES sales.billing_header(billing_id) ON DELETE CASCADE;


--
-- Name: invoice_pdf invoice_pdf_company_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.invoice_pdf
    ADD CONSTRAINT invoice_pdf_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: item_category item_category_company_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_category
    ADD CONSTRAINT item_category_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: item_category item_category_parent_category_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_category
    ADD CONSTRAINT item_category_parent_category_id_fkey FOREIGN KEY (parent_category_id) REFERENCES sales.item_category(item_category_id);


--
-- Name: item item_company_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item
    ADD CONSTRAINT item_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: item item_item_category_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item
    ADD CONSTRAINT item_item_category_id_fkey FOREIGN KEY (item_category_id) REFERENCES sales.item_category(item_category_id);


--
-- Name: item_price_master item_price_master_company_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_price_master
    ADD CONSTRAINT item_price_master_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: item_price_master item_price_master_item_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_price_master
    ADD CONSTRAINT item_price_master_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id) ON DELETE CASCADE;


--
-- Name: item_uom item_uom_item_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_uom
    ADD CONSTRAINT item_uom_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id) ON DELETE CASCADE;


--
-- Name: item_uom item_uom_uom_code_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.item_uom
    ADD CONSTRAINT item_uom_uom_code_fkey FOREIGN KEY (uom_code) REFERENCES core.uom(uom_code);


--
-- Name: order_detail order_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_detail
    ADD CONSTRAINT order_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: order_detail order_detail_order_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_detail
    ADD CONSTRAINT order_detail_order_id_fkey FOREIGN KEY (order_id) REFERENCES sales.order_header(order_id) ON DELETE CASCADE;


--
-- Name: order_header order_header_company_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_header
    ADD CONSTRAINT order_header_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: order_header order_header_created_by_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_header
    ADD CONSTRAINT order_header_created_by_fkey FOREIGN KEY (created_by) REFERENCES core.app_user(user_id);


--
-- Name: order_header order_header_customer_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.order_header
    ADD CONSTRAINT order_header_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES sales.customer(customer_id);


--
-- Name: return_detail return_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_detail
    ADD CONSTRAINT return_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: return_detail return_detail_return_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_detail
    ADD CONSTRAINT return_detail_return_id_fkey FOREIGN KEY (return_id) REFERENCES sales.return_header(return_id) ON DELETE CASCADE;


--
-- Name: return_header return_header_billing_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_header
    ADD CONSTRAINT return_header_billing_id_fkey FOREIGN KEY (billing_id) REFERENCES sales.billing_header(billing_id);


--
-- Name: return_header return_header_company_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_header
    ADD CONSTRAINT return_header_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: return_header return_header_created_by_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.return_header
    ADD CONSTRAINT return_header_created_by_fkey FOREIGN KEY (created_by) REFERENCES core.app_user(user_id);


--
-- Name: sales_quotation sales_quotation_company_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation
    ADD CONSTRAINT sales_quotation_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: sales_quotation sales_quotation_created_by_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation
    ADD CONSTRAINT sales_quotation_created_by_fkey FOREIGN KEY (created_by) REFERENCES core.app_user(user_id);


--
-- Name: sales_quotation sales_quotation_customer_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation
    ADD CONSTRAINT sales_quotation_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES sales.customer(customer_id);


--
-- Name: sales_quotation_detail sales_quotation_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation_detail
    ADD CONSTRAINT sales_quotation_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: sales_quotation_detail sales_quotation_detail_sales_quotation_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.sales_quotation_detail
    ADD CONSTRAINT sales_quotation_detail_sales_quotation_id_fkey FOREIGN KEY (sales_quotation_id) REFERENCES sales.sales_quotation(sales_quotation_id) ON DELETE CASCADE;


--
-- Name: shipping_detail shipping_detail_item_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_detail
    ADD CONSTRAINT shipping_detail_item_id_fkey FOREIGN KEY (item_id) REFERENCES sales.item(item_id);


--
-- Name: shipping_detail shipping_detail_order_detail_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_detail
    ADD CONSTRAINT shipping_detail_order_detail_id_fkey FOREIGN KEY (order_detail_id) REFERENCES sales.order_detail(order_detail_id);


--
-- Name: shipping_detail shipping_detail_shipping_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_detail
    ADD CONSTRAINT shipping_detail_shipping_id_fkey FOREIGN KEY (shipping_id) REFERENCES sales.shipping_header(shipping_id) ON DELETE CASCADE;


--
-- Name: shipping_header shipping_header_company_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_header
    ADD CONSTRAINT shipping_header_company_id_fkey FOREIGN KEY (company_id) REFERENCES core.company(company_id) ON DELETE CASCADE;


--
-- Name: shipping_header shipping_header_created_by_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_header
    ADD CONSTRAINT shipping_header_created_by_fkey FOREIGN KEY (created_by) REFERENCES core.app_user(user_id);


--
-- Name: shipping_header shipping_header_order_id_fkey; Type: FK CONSTRAINT; Schema: sales; Owner: -
--

ALTER TABLE ONLY sales.shipping_header
    ADD CONSTRAINT shipping_header_order_id_fkey FOREIGN KEY (order_id) REFERENCES sales.order_header(order_id);


--
-- Name: objects objects_bucketId_fkey; Type: FK CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.objects
    ADD CONSTRAINT "objects_bucketId_fkey" FOREIGN KEY (bucket_id) REFERENCES storage.buckets(id);


--
-- Name: prefixes prefixes_bucketId_fkey; Type: FK CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.prefixes
    ADD CONSTRAINT "prefixes_bucketId_fkey" FOREIGN KEY (bucket_id) REFERENCES storage.buckets(id);


--
-- Name: s3_multipart_uploads s3_multipart_uploads_bucket_id_fkey; Type: FK CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.s3_multipart_uploads
    ADD CONSTRAINT s3_multipart_uploads_bucket_id_fkey FOREIGN KEY (bucket_id) REFERENCES storage.buckets(id);


--
-- Name: s3_multipart_uploads_parts s3_multipart_uploads_parts_bucket_id_fkey; Type: FK CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.s3_multipart_uploads_parts
    ADD CONSTRAINT s3_multipart_uploads_parts_bucket_id_fkey FOREIGN KEY (bucket_id) REFERENCES storage.buckets(id);


--
-- Name: s3_multipart_uploads_parts s3_multipart_uploads_parts_upload_id_fkey; Type: FK CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.s3_multipart_uploads_parts
    ADD CONSTRAINT s3_multipart_uploads_parts_upload_id_fkey FOREIGN KEY (upload_id) REFERENCES storage.s3_multipart_uploads(id) ON DELETE CASCADE;


--
-- Name: vector_indexes vector_indexes_bucket_id_fkey; Type: FK CONSTRAINT; Schema: storage; Owner: -
--

ALTER TABLE ONLY storage.vector_indexes
    ADD CONSTRAINT vector_indexes_bucket_id_fkey FOREIGN KEY (bucket_id) REFERENCES storage.buckets_vectors(id);


--
-- Name: action_approval_map action_approval_map_approval_flow_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.action_approval_map
    ADD CONSTRAINT action_approval_map_approval_flow_code_fkey FOREIGN KEY (approval_flow_code) REFERENCES system.approval_flow_def(approval_flow_code);


--
-- Name: ai_task ai_task_agent_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.ai_task
    ADD CONSTRAINT ai_task_agent_code_fkey FOREIGN KEY (agent_code) REFERENCES system.ai_agent(agent_code);


--
-- Name: ai_task_run ai_task_run_task_id_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.ai_task_run
    ADD CONSTRAINT ai_task_run_task_id_fkey FOREIGN KEY (task_id) REFERENCES system.ai_task(task_id) ON DELETE CASCADE;


--
-- Name: approval_action_log approval_action_log_approval_request_id_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_action_log
    ADD CONSTRAINT approval_action_log_approval_request_id_fkey FOREIGN KEY (approval_request_id) REFERENCES system.approval_request(approval_request_id);


--
-- Name: approval_exec_map approval_exec_map_command_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_exec_map
    ADD CONSTRAINT approval_exec_map_command_code_fkey FOREIGN KEY (command_code) REFERENCES system.exec_command(command_code);


--
-- Name: approval_step_def approval_step_def_approval_flow_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.approval_step_def
    ADD CONSTRAINT approval_step_def_approval_flow_code_fkey FOREIGN KEY (approval_flow_code) REFERENCES system.approval_flow_def(approval_flow_code);


--
-- Name: exec_run_request exec_run_request_command_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.exec_run_request
    ADD CONSTRAINT exec_run_request_command_code_fkey FOREIGN KEY (command_code) REFERENCES system.exec_command(command_code);


--
-- Name: business_ops_map fk_business_ops_document; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.business_ops_map
    ADD CONSTRAINT fk_business_ops_document FOREIGN KEY (document_type_code) REFERENCES ops.document_type_master(document_type_code);


--
-- Name: function_def function_def_module_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.function_def
    ADD CONSTRAINT function_def_module_code_fkey FOREIGN KEY (module_code) REFERENCES system.module_def(module_code);


--
-- Name: loop_config loop_config_command_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.loop_config
    ADD CONSTRAINT loop_config_command_code_fkey FOREIGN KEY (command_code) REFERENCES system.exec_command(command_code);


--
-- Name: notification_subscription notification_subscription_endpoint_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.notification_subscription
    ADD CONSTRAINT notification_subscription_endpoint_code_fkey FOREIGN KEY (endpoint_code) REFERENCES system.notification_endpoint(endpoint_code) ON DELETE CASCADE;


--
-- Name: operation_log operation_log_operation_type_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.operation_log
    ADD CONSTRAINT operation_log_operation_type_fkey FOREIGN KEY (operation_type) REFERENCES system.operation_type_def(operation_type);


--
-- Name: operation_log operation_log_role_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.operation_log
    ADD CONSTRAINT operation_log_role_code_fkey FOREIGN KEY (role_code) REFERENCES system.role_def(role_code);


--
-- Name: operation_log operation_log_screen_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.operation_log
    ADD CONSTRAINT operation_log_screen_code_fkey FOREIGN KEY (screen_code) REFERENCES system.screen_master(screen_code);


--
-- Name: operation_log operation_log_session_id_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.operation_log
    ADD CONSTRAINT operation_log_session_id_fkey FOREIGN KEY (session_id) REFERENCES system.db_session(session_id);


--
-- Name: role_screen_permission role_screen_permission_role_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.role_screen_permission
    ADD CONSTRAINT role_screen_permission_role_code_fkey FOREIGN KEY (role_code) REFERENCES system.role_def(role_code);


--
-- Name: role_screen_permission role_screen_permission_screen_code_fkey; Type: FK CONSTRAINT; Schema: system; Owner: -
--

ALTER TABLE ONLY system.role_screen_permission
    ADD CONSTRAINT role_screen_permission_screen_code_fkey FOREIGN KEY (screen_code) REFERENCES system.screen_master(screen_code);


--
-- Name: company_license company_license_company_id_fkey; Type: FK CONSTRAINT; Schema: tenant; Owner: -
--

ALTER TABLE ONLY tenant.company_license
    ADD CONSTRAINT company_license_company_id_fkey FOREIGN KEY (company_id) REFERENCES tenant.company(company_id);


--
-- Name: company_license company_license_license_code_fkey; Type: FK CONSTRAINT; Schema: tenant; Owner: -
--

ALTER TABLE ONLY tenant.company_license
    ADD CONSTRAINT company_license_license_code_fkey FOREIGN KEY (license_code) REFERENCES tenant.license_master(license_code);


--
-- Name: audit_alert_ai_judgement; Type: ROW SECURITY; Schema: analytics; Owner: -
--

ALTER TABLE analytics.audit_alert_ai_judgement ENABLE ROW LEVEL SECURITY;

--
-- Name: fact_metric; Type: ROW SECURITY; Schema: analytics; Owner: -
--

ALTER TABLE analytics.fact_metric ENABLE ROW LEVEL SECURITY;

--
-- Name: fact_metric p_analytics_fact_metric_admin_bypass; Type: POLICY; Schema: analytics; Owner: -
--

CREATE POLICY p_analytics_fact_metric_admin_bypass ON analytics.fact_metric USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: fact_metric p_analytics_fact_metric_company; Type: POLICY; Schema: analytics; Owner: -
--

CREATE POLICY p_analytics_fact_metric_company ON analytics.fact_metric USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_alert_ai_judgement p_judge_select; Type: POLICY; Schema: analytics; Owner: -
--

CREATE POLICY p_judge_select ON analytics.audit_alert_ai_judgement FOR SELECT TO authenticated USING (true);


--
-- Name: audit_alert_ai_judgement p_judge_update_admin; Type: POLICY; Schema: analytics; Owner: -
--

CREATE POLICY p_judge_update_admin ON analytics.audit_alert_ai_judgement FOR UPDATE TO authenticated USING (public.is_admin()) WITH CHECK (public.is_admin());


--
-- Name: approval_log; Type: ROW SECURITY; Schema: audit; Owner: -
--

ALTER TABLE audit.approval_log ENABLE ROW LEVEL SECURITY;

--
-- Name: approval_request; Type: ROW SECURITY; Schema: audit; Owner: -
--

ALTER TABLE audit.approval_request ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_event; Type: ROW SECURITY; Schema: audit; Owner: -
--

ALTER TABLE audit.audit_event ENABLE ROW LEVEL SECURITY;

--
-- Name: entity_status_history; Type: ROW SECURITY; Schema: audit; Owner: -
--

ALTER TABLE audit.entity_status_history ENABLE ROW LEVEL SECURITY;

--
-- Name: exec_audit_event; Type: ROW SECURITY; Schema: audit; Owner: -
--

ALTER TABLE audit.exec_audit_event ENABLE ROW LEVEL SECURITY;

--
-- Name: ng_event; Type: ROW SECURITY; Schema: audit; Owner: -
--

ALTER TABLE audit.ng_event ENABLE ROW LEVEL SECURITY;

--
-- Name: approval_log p_al_insert_approver; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_al_insert_approver ON audit.approval_log FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM (audit.approval_request ar
     JOIN approval.approver ap ON (((ap.company_id = ar.company_id) AND (ap.user_id = auth.uid()))))
  WHERE ((ar.request_id = approval_log.approval_request_id) AND (ar.company_id = public.my_company_id())))));


--
-- Name: approval_log p_al_select_company; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_al_select_company ON audit.approval_log FOR SELECT USING ((EXISTS ( SELECT 1
   FROM audit.approval_request ar
  WHERE ((ar.request_id = approval_log.approval_request_id) AND (ar.company_id = public.my_company_id())))));


--
-- Name: approval_log p_approval_log_company; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_approval_log_company ON audit.approval_log USING ((EXISTS ( SELECT 1
   FROM audit.approval_request r
  WHERE ((r.request_id = approval_log.approval_request_id) AND (r.company_id = audit.current_company_id()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM audit.approval_request r
  WHERE ((r.request_id = approval_log.approval_request_id) AND (r.company_id = audit.current_company_id())))));


--
-- Name: approval_request p_approval_request_approver_update; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_approval_request_approver_update ON audit.approval_request FOR UPDATE USING (((company_id = public.my_company_id()) AND ((auth.jwt() ->> 'role'::text) = 'approver'::text))) WITH CHECK ((status = ANY (ARRAY['approved'::text, 'rejected'::text])));


--
-- Name: approval_request p_approval_request_company; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_approval_request_company ON audit.approval_request USING ((company_id = audit.current_company_id())) WITH CHECK ((company_id = audit.current_company_id()));


--
-- Name: approval_request p_approval_request_insert; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_approval_request_insert ON audit.approval_request FOR INSERT WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: approval_request p_ar_insert_company; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_ar_insert_company ON audit.approval_request FOR INSERT WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: approval_request p_ar_select_company; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_ar_select_company ON audit.approval_request FOR SELECT USING ((company_id = public.my_company_id()));


--
-- Name: approval_request p_ar_update_approver; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_ar_update_approver ON audit.approval_request FOR UPDATE USING (((company_id = public.my_company_id()) AND (EXISTS ( SELECT 1
   FROM approval.approver ap
  WHERE ((ap.company_id = approval_request.company_id) AND (ap.user_id = auth.uid())))))) WITH CHECK ((status = ANY (ARRAY['approved'::text, 'rejected'::text])));


--
-- Name: exec_audit_event p_audit_exec_audit_event_owner; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_audit_exec_audit_event_owner ON audit.exec_audit_event USING ((created_by = auth.uid())) WITH CHECK ((created_by = auth.uid()));


--
-- Name: entity_status_history p_entity_status_history_company; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_entity_status_history_company ON audit.entity_status_history USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: ng_event p_ng_event_company; Type: POLICY; Schema: audit; Owner: -
--

CREATE POLICY p_ng_event_company ON audit.ng_event USING ((company_id = audit.current_company_id())) WITH CHECK ((company_id = audit.current_company_id()));


--
-- Name: audit_log_entries; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.audit_log_entries ENABLE ROW LEVEL SECURITY;

--
-- Name: flow_state; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.flow_state ENABLE ROW LEVEL SECURITY;

--
-- Name: identities; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.identities ENABLE ROW LEVEL SECURITY;

--
-- Name: instances; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.instances ENABLE ROW LEVEL SECURITY;

--
-- Name: mfa_amr_claims; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.mfa_amr_claims ENABLE ROW LEVEL SECURITY;

--
-- Name: mfa_challenges; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.mfa_challenges ENABLE ROW LEVEL SECURITY;

--
-- Name: mfa_factors; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.mfa_factors ENABLE ROW LEVEL SECURITY;

--
-- Name: one_time_tokens; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.one_time_tokens ENABLE ROW LEVEL SECURITY;

--
-- Name: refresh_tokens; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.refresh_tokens ENABLE ROW LEVEL SECURITY;

--
-- Name: saml_providers; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.saml_providers ENABLE ROW LEVEL SECURITY;

--
-- Name: saml_relay_states; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.saml_relay_states ENABLE ROW LEVEL SECURITY;

--
-- Name: schema_migrations; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.schema_migrations ENABLE ROW LEVEL SECURITY;

--
-- Name: sessions; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.sessions ENABLE ROW LEVEL SECURITY;

--
-- Name: sso_domains; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.sso_domains ENABLE ROW LEVEL SECURITY;

--
-- Name: sso_providers; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.sso_providers ENABLE ROW LEVEL SECURITY;

--
-- Name: users; Type: ROW SECURITY; Schema: auth; Owner: -
--

ALTER TABLE auth.users ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_event; Type: ROW SECURITY; Schema: compliance; Owner: -
--

ALTER TABLE compliance.audit_event ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_event p_admin_bypass; Type: POLICY; Schema: compliance; Owner: -
--

CREATE POLICY p_admin_bypass ON compliance.audit_event USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_action p_compliance_audit_action_admin_bypass; Type: POLICY; Schema: compliance; Owner: -
--

CREATE POLICY p_compliance_audit_action_admin_bypass ON compliance.audit_action USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_event p_compliance_audit_event_admin_bypass; Type: POLICY; Schema: compliance; Owner: -
--

CREATE POLICY p_compliance_audit_event_admin_bypass ON compliance.audit_event USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_event p_compliance_audit_event_company; Type: POLICY; Schema: compliance; Owner: -
--

CREATE POLICY p_compliance_audit_event_company ON compliance.audit_event USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_issue p_compliance_audit_issue_admin_bypass; Type: POLICY; Schema: compliance; Owner: -
--

CREATE POLICY p_compliance_audit_issue_admin_bypass ON compliance.audit_issue USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: iso_clause p_compliance_iso_clause_admin_bypass; Type: POLICY; Schema: compliance; Owner: -
--

CREATE POLICY p_compliance_iso_clause_admin_bypass ON compliance.iso_clause USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: iso_standard p_compliance_iso_standard_admin_bypass; Type: POLICY; Schema: compliance; Owner: -
--

CREATE POLICY p_compliance_iso_standard_admin_bypass ON compliance.iso_standard USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: accounting_period; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.accounting_period ENABLE ROW LEVEL SECURITY;

--
-- Name: accounts; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.accounts ENABLE ROW LEVEL SECURITY;

--
-- Name: app_user; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.app_user ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_column_weight; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_column_weight ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_impact_rule; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_impact_rule ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_trail; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_trail ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_trail_2025_12; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_trail_2025_12 ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_trail_2026_01; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_trail_2026_01 ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_trail_2026_02; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_trail_2026_02 ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_trail_2026_03; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_trail_2026_03 ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_trail_2026_04; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_trail_2026_04 ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_trail_2026_05; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_trail_2026_05 ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_trail_2026_06; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_trail_2026_06 ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_trail_2026_07; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.audit_trail_2026_07 ENABLE ROW LEVEL SECURITY;

--
-- Name: company; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.company ENABLE ROW LEVEL SECURITY;

--
-- Name: company_license; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.company_license ENABLE ROW LEVEL SECURITY;

--
-- Name: company_permission; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.company_permission ENABLE ROW LEVEL SECURITY;

--
-- Name: company_users; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.company_users ENABLE ROW LEVEL SECURITY;

--
-- Name: document_sequence; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.document_sequence ENABLE ROW LEVEL SECURITY;

--
-- Name: journal_entries; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.journal_entries ENABLE ROW LEVEL SECURITY;

--
-- Name: accounting_period p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.accounting_period USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: accounts p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.accounts USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: app_user p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.app_user USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_column_weight p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_column_weight USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_impact_rule p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_impact_rule USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_trail p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_trail USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_trail_2025_12 p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_trail_2025_12 USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_trail_2026_01 p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_trail_2026_01 USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_trail_2026_02 p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_trail_2026_02 USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_trail_2026_03 p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_trail_2026_03 USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_trail_2026_04 p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_trail_2026_04 USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_trail_2026_05 p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_trail_2026_05 USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_trail_2026_06 p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_trail_2026_06 USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_trail_2026_07 p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.audit_trail_2026_07 USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: company p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.company USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: company_license p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.company_license USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: company_permission p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.company_permission USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: company_users p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.company_users USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: document_sequence p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.document_sequence USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: journal_entries p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.journal_entries USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: permission_groups p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.permission_groups USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: permissions p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.permissions USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: posting_profile p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.posting_profile USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: status_history p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.status_history USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: sync_queue p_admin_bypass; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_admin_bypass ON core.sync_queue USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_trail p_audit_trail_read; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_audit_trail_read ON core.audit_trail FOR SELECT USING (((company_id = public.my_company_id()) OR (auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text]))));


--
-- Name: accounting_period p_core_accounting_period_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_accounting_period_company ON core.accounting_period USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: accounting_period p_core_accounting_period_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_accounting_period_company_rls ON core.accounting_period USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: accounts p_core_accounts_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_accounts_company ON core.accounts USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: accounts p_core_accounts_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_accounts_company_rls ON core.accounts USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: app_user p_core_app_user_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_app_user_company ON core.app_user USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: app_user p_core_app_user_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_app_user_company_rls ON core.app_user USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_column_weight p_core_audit_column_weight_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_column_weight_company ON core.audit_column_weight USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_column_weight p_core_audit_column_weight_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_column_weight_company_rls ON core.audit_column_weight USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_impact_rule p_core_audit_impact_rule_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_impact_rule_company ON core.audit_impact_rule USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_impact_rule p_core_audit_impact_rule_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_impact_rule_company_rls ON core.audit_impact_rule USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2025_12 p_core_audit_trail_2025_12_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2025_12_company ON core.audit_trail_2025_12 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2025_12 p_core_audit_trail_2025_12_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2025_12_company_rls ON core.audit_trail_2025_12 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_01 p_core_audit_trail_2026_01_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_01_company ON core.audit_trail_2026_01 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_01 p_core_audit_trail_2026_01_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_01_company_rls ON core.audit_trail_2026_01 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_02 p_core_audit_trail_2026_02_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_02_company ON core.audit_trail_2026_02 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_02 p_core_audit_trail_2026_02_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_02_company_rls ON core.audit_trail_2026_02 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_03 p_core_audit_trail_2026_03_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_03_company ON core.audit_trail_2026_03 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_03 p_core_audit_trail_2026_03_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_03_company_rls ON core.audit_trail_2026_03 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_04 p_core_audit_trail_2026_04_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_04_company ON core.audit_trail_2026_04 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_04 p_core_audit_trail_2026_04_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_04_company_rls ON core.audit_trail_2026_04 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_05 p_core_audit_trail_2026_05_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_05_company ON core.audit_trail_2026_05 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_05 p_core_audit_trail_2026_05_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_05_company_rls ON core.audit_trail_2026_05 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_06 p_core_audit_trail_2026_06_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_06_company ON core.audit_trail_2026_06 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_06 p_core_audit_trail_2026_06_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_06_company_rls ON core.audit_trail_2026_06 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_07 p_core_audit_trail_2026_07_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_07_company ON core.audit_trail_2026_07 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail_2026_07 p_core_audit_trail_2026_07_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_2026_07_company_rls ON core.audit_trail_2026_07 USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail p_core_audit_trail_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_company ON core.audit_trail USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: audit_trail p_core_audit_trail_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_audit_trail_company_rls ON core.audit_trail USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: company p_core_company_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_company_company ON core.company USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: company p_core_company_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_company_company_rls ON core.company USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: company_license p_core_company_license_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_company_license_company ON core.company_license USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: company_license p_core_company_license_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_company_license_company_rls ON core.company_license USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: company_permission p_core_company_permission_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_company_permission_company ON core.company_permission USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: company_permission p_core_company_permission_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_company_permission_company_rls ON core.company_permission USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: company_users p_core_company_users_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_company_users_company ON core.company_users USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: company_users p_core_company_users_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_company_users_company_rls ON core.company_users USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: document_sequence p_core_document_sequence_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_document_sequence_company ON core.document_sequence USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: document_sequence p_core_document_sequence_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_document_sequence_company_rls ON core.document_sequence USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: journal_entries p_core_journal_entries_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_journal_entries_company ON core.journal_entries USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: journal_entries p_core_journal_entries_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_journal_entries_company_rls ON core.journal_entries USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: permission_groups p_core_permission_groups_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_permission_groups_company ON core.permission_groups USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: permission_groups p_core_permission_groups_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_permission_groups_company_rls ON core.permission_groups USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: permissions p_core_permissions_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_permissions_company ON core.permissions USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: permissions p_core_permissions_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_permissions_company_rls ON core.permissions USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: posting_profile p_core_posting_profile_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_posting_profile_company ON core.posting_profile USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: posting_profile p_core_posting_profile_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_posting_profile_company_rls ON core.posting_profile USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: status_history p_core_status_history_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_status_history_company ON core.status_history USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: status_history p_core_status_history_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_status_history_company_rls ON core.status_history USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: sync_queue p_core_sync_queue_company; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_sync_queue_company ON core.sync_queue USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: sync_queue p_core_sync_queue_company_rls; Type: POLICY; Schema: core; Owner: -
--

CREATE POLICY p_core_sync_queue_company_rls ON core.sync_queue USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: permission_groups; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.permission_groups ENABLE ROW LEVEL SECURITY;

--
-- Name: permissions; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.permissions ENABLE ROW LEVEL SECURITY;

--
-- Name: posting_profile; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.posting_profile ENABLE ROW LEVEL SECURITY;

--
-- Name: status_history; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.status_history ENABLE ROW LEVEL SECURITY;

--
-- Name: sync_queue; Type: ROW SECURITY; Schema: core; Owner: -
--

ALTER TABLE core.sync_queue ENABLE ROW LEVEL SECURITY;

--
-- Name: bank_account; Type: ROW SECURITY; Schema: finance; Owner: -
--

ALTER TABLE finance.bank_account ENABLE ROW LEVEL SECURITY;

--
-- Name: bank_account p_admin_bypass; Type: POLICY; Schema: finance; Owner: -
--

CREATE POLICY p_admin_bypass ON finance.bank_account USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: payment p_admin_bypass; Type: POLICY; Schema: finance; Owner: -
--

CREATE POLICY p_admin_bypass ON finance.payment USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: bank_account p_finance_bank_account_company; Type: POLICY; Schema: finance; Owner: -
--

CREATE POLICY p_finance_bank_account_company ON finance.bank_account USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: bank_account p_finance_bank_account_company_rls; Type: POLICY; Schema: finance; Owner: -
--

CREATE POLICY p_finance_bank_account_company_rls ON finance.bank_account USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: payment p_finance_payment_company; Type: POLICY; Schema: finance; Owner: -
--

CREATE POLICY p_finance_payment_company ON finance.payment USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: payment p_finance_payment_company_rls; Type: POLICY; Schema: finance; Owner: -
--

CREATE POLICY p_finance_payment_company_rls ON finance.payment USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: payment; Type: ROW SECURITY; Schema: finance; Owner: -
--

ALTER TABLE finance.payment ENABLE ROW LEVEL SECURITY;

--
-- Name: business_rule; Type: ROW SECURITY; Schema: governance; Owner: -
--

ALTER TABLE governance.business_rule ENABLE ROW LEVEL SECURITY;

--
-- Name: contract_header; Type: ROW SECURITY; Schema: governance; Owner: -
--

ALTER TABLE governance.contract_header ENABLE ROW LEVEL SECURITY;

--
-- Name: document_archive; Type: ROW SECURITY; Schema: governance; Owner: -
--

ALTER TABLE governance.document_archive ENABLE ROW LEVEL SECURITY;

--
-- Name: business_rule p_admin_bypass; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_admin_bypass ON governance.business_rule USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: contract_header p_admin_bypass; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_admin_bypass ON governance.contract_header USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: document_archive p_admin_bypass; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_admin_bypass ON governance.document_archive USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: business_rule_action p_governance_business_rule_action_admin_bypass; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_governance_business_rule_action_admin_bypass ON governance.business_rule_action USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: business_rule p_governance_business_rule_admin_bypass; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_governance_business_rule_admin_bypass ON governance.business_rule USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: business_rule p_governance_business_rule_company; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_governance_business_rule_company ON governance.business_rule USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: business_rule_condition p_governance_business_rule_condition_admin_bypass; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_governance_business_rule_condition_admin_bypass ON governance.business_rule_condition USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: contract_header p_governance_contract_header_admin_bypass; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_governance_contract_header_admin_bypass ON governance.contract_header USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: contract_header p_governance_contract_header_company; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_governance_contract_header_company ON governance.contract_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: contract_item_price p_governance_contract_item_price_admin_bypass; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_governance_contract_item_price_admin_bypass ON governance.contract_item_price USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: document_archive p_governance_document_archive_admin_bypass; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_governance_document_archive_admin_bypass ON governance.document_archive USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: document_archive p_governance_document_archive_company; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_governance_document_archive_company ON governance.document_archive USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: document_category p_governance_document_category_admin_bypass; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_governance_document_category_admin_bypass ON governance.document_category USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: policy_change_queue p_pcq_select; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_pcq_select ON governance.policy_change_queue FOR SELECT TO authenticated USING (true);


--
-- Name: policy_change_queue p_pcq_update_admin; Type: POLICY; Schema: governance; Owner: -
--

CREATE POLICY p_pcq_update_admin ON governance.policy_change_queue FOR UPDATE TO authenticated USING (public.is_admin()) WITH CHECK (public.is_admin());


--
-- Name: policy_change_queue; Type: ROW SECURITY; Schema: governance; Owner: -
--

ALTER TABLE governance.policy_change_queue ENABLE ROW LEVEL SECURITY;

--
-- Name: attendance_log; Type: ROW SECURITY; Schema: hr; Owner: -
--

ALTER TABLE hr.attendance_log ENABLE ROW LEVEL SECURITY;

--
-- Name: employee; Type: ROW SECURITY; Schema: hr; Owner: -
--

ALTER TABLE hr.employee ENABLE ROW LEVEL SECURITY;

--
-- Name: employment_contract; Type: ROW SECURITY; Schema: hr; Owner: -
--

ALTER TABLE hr.employment_contract ENABLE ROW LEVEL SECURITY;

--
-- Name: hr_department; Type: ROW SECURITY; Schema: hr; Owner: -
--

ALTER TABLE hr.hr_department ENABLE ROW LEVEL SECURITY;

--
-- Name: hr_position; Type: ROW SECURITY; Schema: hr; Owner: -
--

ALTER TABLE hr.hr_position ENABLE ROW LEVEL SECURITY;

--
-- Name: leave_request; Type: ROW SECURITY; Schema: hr; Owner: -
--

ALTER TABLE hr.leave_request ENABLE ROW LEVEL SECURITY;

--
-- Name: attendance_log p_admin_bypass; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_admin_bypass ON hr.attendance_log USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: employee p_admin_bypass; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_admin_bypass ON hr.employee USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: employment_contract p_admin_bypass; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_admin_bypass ON hr.employment_contract USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: hr_department p_admin_bypass; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_admin_bypass ON hr.hr_department USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: hr_position p_admin_bypass; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_admin_bypass ON hr.hr_position USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: leave_request p_admin_bypass; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_admin_bypass ON hr.leave_request USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: payroll_run p_admin_bypass; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_admin_bypass ON hr.payroll_run USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: attendance_log p_hr_attendance_log_company; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_attendance_log_company ON hr.attendance_log USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: attendance_log p_hr_attendance_log_company_rls; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_attendance_log_company_rls ON hr.attendance_log USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: employee p_hr_employee_company; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_employee_company ON hr.employee USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: employee p_hr_employee_company_rls; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_employee_company_rls ON hr.employee USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: employment_contract p_hr_employment_contract_company; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_employment_contract_company ON hr.employment_contract USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: employment_contract p_hr_employment_contract_company_rls; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_employment_contract_company_rls ON hr.employment_contract USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: hr_department p_hr_hr_department_company; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_hr_department_company ON hr.hr_department USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: hr_department p_hr_hr_department_company_rls; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_hr_department_company_rls ON hr.hr_department USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: hr_position p_hr_hr_position_company; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_hr_position_company ON hr.hr_position USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: hr_position p_hr_hr_position_company_rls; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_hr_position_company_rls ON hr.hr_position USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: leave_request p_hr_leave_request_company; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_leave_request_company ON hr.leave_request USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: leave_request p_hr_leave_request_company_rls; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_leave_request_company_rls ON hr.leave_request USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: payroll_run p_hr_payroll_run_company; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_payroll_run_company ON hr.payroll_run USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: payroll_run p_hr_payroll_run_company_rls; Type: POLICY; Schema: hr; Owner: -
--

CREATE POLICY p_hr_payroll_run_company_rls ON hr.payroll_run USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: payroll_run; Type: ROW SECURITY; Schema: hr; Owner: -
--

ALTER TABLE hr.payroll_run ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_export_queue; Type: ROW SECURITY; Schema: integration; Owner: -
--

ALTER TABLE integration.audit_export_queue ENABLE ROW LEVEL SECURITY;

--
-- Name: external_system; Type: ROW SECURITY; Schema: integration; Owner: -
--

ALTER TABLE integration.external_system ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_export_queue p_admin_bypass; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_admin_bypass ON integration.audit_export_queue USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: external_system p_admin_bypass; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_admin_bypass ON integration.external_system USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: siem_delivery_queue p_admin_bypass; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_admin_bypass ON integration.siem_delivery_queue USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: siem_endpoint p_admin_bypass; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_admin_bypass ON integration.siem_endpoint USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: api_credential p_integration_api_credential_admin_bypass; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_integration_api_credential_admin_bypass ON integration.api_credential USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: audit_export_queue p_integration_audit_export_queue_company; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_integration_audit_export_queue_company ON integration.audit_export_queue USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: external_system p_integration_external_system_admin_bypass; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_integration_external_system_admin_bypass ON integration.external_system USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: external_system p_integration_external_system_company; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_integration_external_system_company ON integration.external_system USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: integration_job p_integration_integration_job_admin_bypass; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_integration_integration_job_admin_bypass ON integration.integration_job USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: integration_log p_integration_integration_log_admin_bypass; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_integration_integration_log_admin_bypass ON integration.integration_log USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: siem_delivery_queue p_integration_siem_delivery_queue_company; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_integration_siem_delivery_queue_company ON integration.siem_delivery_queue USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: siem_endpoint p_integration_siem_endpoint_company; Type: POLICY; Schema: integration; Owner: -
--

CREATE POLICY p_integration_siem_endpoint_company ON integration.siem_endpoint USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: siem_delivery_queue; Type: ROW SECURITY; Schema: integration; Owner: -
--

ALTER TABLE integration.siem_delivery_queue ENABLE ROW LEVEL SECURITY;

--
-- Name: siem_endpoint; Type: ROW SECURITY; Schema: integration; Owner: -
--

ALTER TABLE integration.siem_endpoint ENABLE ROW LEVEL SECURITY;

--
-- Name: inventory_valuation; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.inventory_valuation ENABLE ROW LEVEL SECURITY;

--
-- Name: inventory_valuation p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.inventory_valuation USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: stock_balance p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.stock_balance USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: stock_bin p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.stock_bin USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: stock_lot p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.stock_lot USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: stock_lot_balance p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.stock_lot_balance USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: stock_reservation p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.stock_reservation USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: stock_transaction p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.stock_transaction USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: stock_transfer_header p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.stock_transfer_header USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: stocktaking_plan p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.stocktaking_plan USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: stocktaking_result p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.stocktaking_result USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: storage_location p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.storage_location USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: warehouse p_admin_bypass; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_admin_bypass ON inventory.warehouse USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: inventory_valuation p_inventory_inventory_valuation_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_inventory_valuation_company ON inventory.inventory_valuation USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: inventory_valuation p_inventory_inventory_valuation_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_inventory_valuation_company_rls ON inventory.inventory_valuation USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_balance p_inventory_stock_balance_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_balance_company ON inventory.stock_balance USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_balance p_inventory_stock_balance_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_balance_company_rls ON inventory.stock_balance USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_bin p_inventory_stock_bin_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_bin_company ON inventory.stock_bin USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_bin p_inventory_stock_bin_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_bin_company_rls ON inventory.stock_bin USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_lot_balance p_inventory_stock_lot_balance_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_lot_balance_company ON inventory.stock_lot_balance USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_lot_balance p_inventory_stock_lot_balance_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_lot_balance_company_rls ON inventory.stock_lot_balance USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_lot p_inventory_stock_lot_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_lot_company ON inventory.stock_lot USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_lot p_inventory_stock_lot_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_lot_company_rls ON inventory.stock_lot USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_reservation p_inventory_stock_reservation_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_reservation_company ON inventory.stock_reservation USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_reservation p_inventory_stock_reservation_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_reservation_company_rls ON inventory.stock_reservation USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_transaction p_inventory_stock_transaction_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_transaction_company ON inventory.stock_transaction USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_transaction p_inventory_stock_transaction_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_transaction_company_rls ON inventory.stock_transaction USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_transfer_header p_inventory_stock_transfer_header_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_transfer_header_company ON inventory.stock_transfer_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_transfer_header p_inventory_stock_transfer_header_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stock_transfer_header_company_rls ON inventory.stock_transfer_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stocktaking_plan p_inventory_stocktaking_plan_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stocktaking_plan_company ON inventory.stocktaking_plan USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stocktaking_plan p_inventory_stocktaking_plan_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stocktaking_plan_company_rls ON inventory.stocktaking_plan USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stocktaking_result p_inventory_stocktaking_result_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stocktaking_result_company ON inventory.stocktaking_result USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stocktaking_result p_inventory_stocktaking_result_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_stocktaking_result_company_rls ON inventory.stocktaking_result USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: storage_location p_inventory_storage_location_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_storage_location_company ON inventory.storage_location USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: storage_location p_inventory_storage_location_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_storage_location_company_rls ON inventory.storage_location USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: warehouse p_inventory_warehouse_company; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_warehouse_company ON inventory.warehouse USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: warehouse p_inventory_warehouse_company_rls; Type: POLICY; Schema: inventory; Owner: -
--

CREATE POLICY p_inventory_warehouse_company_rls ON inventory.warehouse USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: stock_balance; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.stock_balance ENABLE ROW LEVEL SECURITY;

--
-- Name: stock_bin; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.stock_bin ENABLE ROW LEVEL SECURITY;

--
-- Name: stock_lot; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.stock_lot ENABLE ROW LEVEL SECURITY;

--
-- Name: stock_lot_balance; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.stock_lot_balance ENABLE ROW LEVEL SECURITY;

--
-- Name: stock_reservation; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.stock_reservation ENABLE ROW LEVEL SECURITY;

--
-- Name: stock_transaction; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.stock_transaction ENABLE ROW LEVEL SECURITY;

--
-- Name: stock_transfer_header; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.stock_transfer_header ENABLE ROW LEVEL SECURITY;

--
-- Name: stocktaking_plan; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.stocktaking_plan ENABLE ROW LEVEL SECURITY;

--
-- Name: stocktaking_result; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.stocktaking_result ENABLE ROW LEVEL SECURITY;

--
-- Name: storage_location; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.storage_location ENABLE ROW LEVEL SECURITY;

--
-- Name: warehouse; Type: ROW SECURITY; Schema: inventory; Owner: -
--

ALTER TABLE inventory.warehouse ENABLE ROW LEVEL SECURITY;

--
-- Name: bom_header; Type: ROW SECURITY; Schema: manufacturing; Owner: -
--

ALTER TABLE manufacturing.bom_header ENABLE ROW LEVEL SECURITY;

--
-- Name: manufacturing_cost_snapshot; Type: ROW SECURITY; Schema: manufacturing; Owner: -
--

ALTER TABLE manufacturing.manufacturing_cost_snapshot ENABLE ROW LEVEL SECURITY;

--
-- Name: manufacturing_execution; Type: ROW SECURITY; Schema: manufacturing; Owner: -
--

ALTER TABLE manufacturing.manufacturing_execution ENABLE ROW LEVEL SECURITY;

--
-- Name: mps_run; Type: ROW SECURITY; Schema: manufacturing; Owner: -
--

ALTER TABLE manufacturing.mps_run ENABLE ROW LEVEL SECURITY;

--
-- Name: mrp_run; Type: ROW SECURITY; Schema: manufacturing; Owner: -
--

ALTER TABLE manufacturing.mrp_run ENABLE ROW LEVEL SECURITY;

--
-- Name: bom_header p_admin_bypass; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_admin_bypass ON manufacturing.bom_header USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: manufacturing_cost_snapshot p_admin_bypass; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_admin_bypass ON manufacturing.manufacturing_cost_snapshot USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: manufacturing_execution p_admin_bypass; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_admin_bypass ON manufacturing.manufacturing_execution USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: mps_run p_admin_bypass; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_admin_bypass ON manufacturing.mps_run USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: mrp_run p_admin_bypass; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_admin_bypass ON manufacturing.mrp_run USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: process_master p_admin_bypass; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_admin_bypass ON manufacturing.process_master USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: routing_header p_admin_bypass; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_admin_bypass ON manufacturing.routing_header USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: work_order p_admin_bypass; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_admin_bypass ON manufacturing.work_order USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: yield_metric p_admin_bypass; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_admin_bypass ON manufacturing.yield_metric USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: bom_header p_manufacturing_bom_header_company; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_bom_header_company ON manufacturing.bom_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: bom_header p_manufacturing_bom_header_company_rls; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_bom_header_company_rls ON manufacturing.bom_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: manufacturing_cost_snapshot p_manufacturing_manufacturing_cost_snapshot_company; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_manufacturing_cost_snapshot_company ON manufacturing.manufacturing_cost_snapshot USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: manufacturing_cost_snapshot p_manufacturing_manufacturing_cost_snapshot_company_rls; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_manufacturing_cost_snapshot_company_rls ON manufacturing.manufacturing_cost_snapshot USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: manufacturing_execution p_manufacturing_manufacturing_execution_company; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_manufacturing_execution_company ON manufacturing.manufacturing_execution USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: manufacturing_execution p_manufacturing_manufacturing_execution_company_rls; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_manufacturing_execution_company_rls ON manufacturing.manufacturing_execution USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: mps_run p_manufacturing_mps_run_company; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_mps_run_company ON manufacturing.mps_run USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: mps_run p_manufacturing_mps_run_company_rls; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_mps_run_company_rls ON manufacturing.mps_run USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: mrp_run p_manufacturing_mrp_run_company; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_mrp_run_company ON manufacturing.mrp_run USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: mrp_run p_manufacturing_mrp_run_company_rls; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_mrp_run_company_rls ON manufacturing.mrp_run USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: process_master p_manufacturing_process_master_company; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_process_master_company ON manufacturing.process_master USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: process_master p_manufacturing_process_master_company_rls; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_process_master_company_rls ON manufacturing.process_master USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: routing_header p_manufacturing_routing_header_company; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_routing_header_company ON manufacturing.routing_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: routing_header p_manufacturing_routing_header_company_rls; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_routing_header_company_rls ON manufacturing.routing_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: work_order p_manufacturing_work_order_company; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_work_order_company ON manufacturing.work_order USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: work_order p_manufacturing_work_order_company_rls; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_work_order_company_rls ON manufacturing.work_order USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: yield_metric p_manufacturing_yield_metric_company; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_yield_metric_company ON manufacturing.yield_metric USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: yield_metric p_manufacturing_yield_metric_company_rls; Type: POLICY; Schema: manufacturing; Owner: -
--

CREATE POLICY p_manufacturing_yield_metric_company_rls ON manufacturing.yield_metric USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: process_master; Type: ROW SECURITY; Schema: manufacturing; Owner: -
--

ALTER TABLE manufacturing.process_master ENABLE ROW LEVEL SECURITY;

--
-- Name: routing_header; Type: ROW SECURITY; Schema: manufacturing; Owner: -
--

ALTER TABLE manufacturing.routing_header ENABLE ROW LEVEL SECURITY;

--
-- Name: work_order; Type: ROW SECURITY; Schema: manufacturing; Owner: -
--

ALTER TABLE manufacturing.work_order ENABLE ROW LEVEL SECURITY;

--
-- Name: yield_metric; Type: ROW SECURITY; Schema: manufacturing; Owner: -
--

ALTER TABLE manufacturing.yield_metric ENABLE ROW LEVEL SECURITY;

--
-- Name: asset; Type: ROW SECURITY; Schema: media; Owner: -
--

ALTER TABLE media.asset ENABLE ROW LEVEL SECURITY;

--
-- Name: asset_link; Type: ROW SECURITY; Schema: media; Owner: -
--

ALTER TABLE media.asset_link ENABLE ROW LEVEL SECURITY;

--
-- Name: asset_link p_media_asset_link_owner; Type: POLICY; Schema: media; Owner: -
--

CREATE POLICY p_media_asset_link_owner ON media.asset_link USING ((created_by = auth.uid())) WITH CHECK ((created_by = auth.uid()));


--
-- Name: asset p_media_asset_owner; Type: POLICY; Schema: media; Owner: -
--

CREATE POLICY p_media_asset_owner ON media.asset USING ((created_by = auth.uid())) WITH CHECK ((created_by = auth.uid()));


--
-- Name: document_file; Type: ROW SECURITY; Schema: ops; Owner: -
--

ALTER TABLE ops.document_file ENABLE ROW LEVEL SECURITY;

--
-- Name: document_send_history; Type: ROW SECURITY; Schema: ops; Owner: -
--

ALTER TABLE ops.document_send_history ENABLE ROW LEVEL SECURITY;

--
-- Name: notification_outbox; Type: ROW SECURITY; Schema: ops; Owner: -
--

ALTER TABLE ops.notification_outbox ENABLE ROW LEVEL SECURITY;

--
-- Name: ops_job_queue; Type: ROW SECURITY; Schema: ops; Owner: -
--

ALTER TABLE ops.ops_job_queue ENABLE ROW LEVEL SECURITY;

--
-- Name: ops_job_result; Type: ROW SECURITY; Schema: ops; Owner: -
--

ALTER TABLE ops.ops_job_result ENABLE ROW LEVEL SECURITY;

--
-- Name: document_file p_ops_document_file_user; Type: POLICY; Schema: ops; Owner: -
--

CREATE POLICY p_ops_document_file_user ON ops.document_file USING ((generated_by = auth.uid()));


--
-- Name: ops_job_queue p_ops_job_queue_owner; Type: POLICY; Schema: ops; Owner: -
--

CREATE POLICY p_ops_job_queue_owner ON ops.ops_job_queue USING (true);


--
-- Name: ops_job_result p_ops_job_result_owner; Type: POLICY; Schema: ops; Owner: -
--

CREATE POLICY p_ops_job_result_owner ON ops.ops_job_result USING (true);


--
-- Name: notification_outbox p_ops_notification_owner; Type: POLICY; Schema: ops; Owner: -
--

CREATE POLICY p_ops_notification_owner ON ops.notification_outbox USING (true);


--
-- Name: document_send_history p_ops_send_history_user; Type: POLICY; Schema: ops; Owner: -
--

CREATE POLICY p_ops_send_history_user ON ops.document_send_history USING ((created_by = auth.uid()));


--
-- Name: purchase_invoice p_admin_bypass; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_admin_bypass ON purchase.purchase_invoice USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: purchase_order_header p_admin_bypass; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_admin_bypass ON purchase.purchase_order_header USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: purchase_quotation p_admin_bypass; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_admin_bypass ON purchase.purchase_quotation USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: purchase_receipt p_admin_bypass; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_admin_bypass ON purchase.purchase_receipt USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: purchase_requisition p_admin_bypass; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_admin_bypass ON purchase.purchase_requisition USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: purchase_three_way_match p_admin_bypass; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_admin_bypass ON purchase.purchase_three_way_match USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: supplier_item_price p_admin_bypass; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_admin_bypass ON purchase.supplier_item_price USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: supplier_master p_admin_bypass; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_admin_bypass ON purchase.supplier_master USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: purchase_invoice p_purchase_purchase_invoice_company; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_invoice_company ON purchase.purchase_invoice USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_invoice p_purchase_purchase_invoice_company_rls; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_invoice_company_rls ON purchase.purchase_invoice USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_order_header p_purchase_purchase_order_header_company; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_order_header_company ON purchase.purchase_order_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_order_header p_purchase_purchase_order_header_company_rls; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_order_header_company_rls ON purchase.purchase_order_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_quotation p_purchase_purchase_quotation_company; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_quotation_company ON purchase.purchase_quotation USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_quotation p_purchase_purchase_quotation_company_rls; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_quotation_company_rls ON purchase.purchase_quotation USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_receipt p_purchase_purchase_receipt_company; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_receipt_company ON purchase.purchase_receipt USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_receipt p_purchase_purchase_receipt_company_rls; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_receipt_company_rls ON purchase.purchase_receipt USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_requisition p_purchase_purchase_requisition_company; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_requisition_company ON purchase.purchase_requisition USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_requisition p_purchase_purchase_requisition_company_rls; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_requisition_company_rls ON purchase.purchase_requisition USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_three_way_match p_purchase_purchase_three_way_match_company; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_three_way_match_company ON purchase.purchase_three_way_match USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_three_way_match p_purchase_purchase_three_way_match_company_rls; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_purchase_three_way_match_company_rls ON purchase.purchase_three_way_match USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: supplier_item_price p_purchase_supplier_item_price_company; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_supplier_item_price_company ON purchase.supplier_item_price USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: supplier_item_price p_purchase_supplier_item_price_company_rls; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_supplier_item_price_company_rls ON purchase.supplier_item_price USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: supplier_master p_purchase_supplier_master_company; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_supplier_master_company ON purchase.supplier_master USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: supplier_master p_purchase_supplier_master_company_rls; Type: POLICY; Schema: purchase; Owner: -
--

CREATE POLICY p_purchase_supplier_master_company_rls ON purchase.supplier_master USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: purchase_invoice; Type: ROW SECURITY; Schema: purchase; Owner: -
--

ALTER TABLE purchase.purchase_invoice ENABLE ROW LEVEL SECURITY;

--
-- Name: purchase_order_header; Type: ROW SECURITY; Schema: purchase; Owner: -
--

ALTER TABLE purchase.purchase_order_header ENABLE ROW LEVEL SECURITY;

--
-- Name: purchase_quotation; Type: ROW SECURITY; Schema: purchase; Owner: -
--

ALTER TABLE purchase.purchase_quotation ENABLE ROW LEVEL SECURITY;

--
-- Name: purchase_receipt; Type: ROW SECURITY; Schema: purchase; Owner: -
--

ALTER TABLE purchase.purchase_receipt ENABLE ROW LEVEL SECURITY;

--
-- Name: purchase_requisition; Type: ROW SECURITY; Schema: purchase; Owner: -
--

ALTER TABLE purchase.purchase_requisition ENABLE ROW LEVEL SECURITY;

--
-- Name: purchase_three_way_match; Type: ROW SECURITY; Schema: purchase; Owner: -
--

ALTER TABLE purchase.purchase_three_way_match ENABLE ROW LEVEL SECURITY;

--
-- Name: supplier_item_price; Type: ROW SECURITY; Schema: purchase; Owner: -
--

ALTER TABLE purchase.supplier_item_price ENABLE ROW LEVEL SECURITY;

--
-- Name: supplier_master; Type: ROW SECURITY; Schema: purchase; Owner: -
--

ALTER TABLE purchase.supplier_master ENABLE ROW LEVEL SECURITY;

--
-- Name: messages; Type: ROW SECURITY; Schema: realtime; Owner: -
--

ALTER TABLE realtime.messages ENABLE ROW LEVEL SECURITY;

--
-- Name: billing_header; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.billing_header ENABLE ROW LEVEL SECURITY;

--
-- Name: customer; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.customer ENABLE ROW LEVEL SECURITY;

--
-- Name: invoice_pdf; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.invoice_pdf ENABLE ROW LEVEL SECURITY;

--
-- Name: item; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.item ENABLE ROW LEVEL SECURITY;

--
-- Name: item_category; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.item_category ENABLE ROW LEVEL SECURITY;

--
-- Name: item_price_master; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.item_price_master ENABLE ROW LEVEL SECURITY;

--
-- Name: order_header; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.order_header ENABLE ROW LEVEL SECURITY;

--
-- Name: billing_header p_admin_bypass; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_admin_bypass ON sales.billing_header USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: customer p_admin_bypass; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_admin_bypass ON sales.customer USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: invoice_pdf p_admin_bypass; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_admin_bypass ON sales.invoice_pdf USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: item p_admin_bypass; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_admin_bypass ON sales.item USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: item_category p_admin_bypass; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_admin_bypass ON sales.item_category USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: item_price_master p_admin_bypass; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_admin_bypass ON sales.item_price_master USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: order_header p_admin_bypass; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_admin_bypass ON sales.order_header USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: return_header p_admin_bypass; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_admin_bypass ON sales.return_header USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: sales_quotation p_admin_bypass; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_admin_bypass ON sales.sales_quotation USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: shipping_header p_admin_bypass; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_admin_bypass ON sales.shipping_header USING ((auth.role() = ANY (ARRAY['service_role'::text, 'postgres'::text])));


--
-- Name: quotation_order_link p_quotation_order_link_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_quotation_order_link_company ON sales.quotation_order_link USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: billing_header p_sales_billing_header_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_billing_header_company ON sales.billing_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: billing_header p_sales_billing_header_company_rls; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_billing_header_company_rls ON sales.billing_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: customer p_sales_customer_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_customer_company ON sales.customer USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: customer p_sales_customer_company_rls; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_customer_company_rls ON sales.customer USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: invoice_pdf p_sales_invoice_pdf_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_invoice_pdf_company ON sales.invoice_pdf USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: invoice_pdf p_sales_invoice_pdf_company_rls; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_invoice_pdf_company_rls ON sales.invoice_pdf USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: item_category p_sales_item_category_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_item_category_company ON sales.item_category USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: item_category p_sales_item_category_company_rls; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_item_category_company_rls ON sales.item_category USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: item p_sales_item_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_item_company ON sales.item USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: item p_sales_item_company_rls; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_item_company_rls ON sales.item USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: item_price_master p_sales_item_price_master_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_item_price_master_company ON sales.item_price_master USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: item_price_master p_sales_item_price_master_company_rls; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_item_price_master_company_rls ON sales.item_price_master USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: order_header p_sales_order_header_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_order_header_company ON sales.order_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: order_header p_sales_order_header_company_rls; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_order_header_company_rls ON sales.order_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: return_header p_sales_return_header_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_return_header_company ON sales.return_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: return_header p_sales_return_header_company_rls; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_return_header_company_rls ON sales.return_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: sales_quotation p_sales_sales_quotation_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_sales_quotation_company ON sales.sales_quotation USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: sales_quotation p_sales_sales_quotation_company_rls; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_sales_quotation_company_rls ON sales.sales_quotation USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: shipping_header p_sales_shipping_header_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_shipping_header_company ON sales.shipping_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: shipping_header p_sales_shipping_header_company_rls; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_sales_shipping_header_company_rls ON sales.shipping_header USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: shipping_revision p_shipping_revision_company; Type: POLICY; Schema: sales; Owner: -
--

CREATE POLICY p_shipping_revision_company ON sales.shipping_revision USING ((company_id = public.my_company_id())) WITH CHECK ((company_id = public.my_company_id()));


--
-- Name: quotation_order_link; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.quotation_order_link ENABLE ROW LEVEL SECURITY;

--
-- Name: return_header; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.return_header ENABLE ROW LEVEL SECURITY;

--
-- Name: sales_quotation; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.sales_quotation ENABLE ROW LEVEL SECURITY;

--
-- Name: shipping_header; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.shipping_header ENABLE ROW LEVEL SECURITY;

--
-- Name: shipping_revision; Type: ROW SECURITY; Schema: sales; Owner: -
--

ALTER TABLE sales.shipping_revision ENABLE ROW LEVEL SECURITY;

--
-- Name: buckets; Type: ROW SECURITY; Schema: storage; Owner: -
--

ALTER TABLE storage.buckets ENABLE ROW LEVEL SECURITY;

--
-- Name: buckets_analytics; Type: ROW SECURITY; Schema: storage; Owner: -
--

ALTER TABLE storage.buckets_analytics ENABLE ROW LEVEL SECURITY;

--
-- Name: buckets_vectors; Type: ROW SECURITY; Schema: storage; Owner: -
--

ALTER TABLE storage.buckets_vectors ENABLE ROW LEVEL SECURITY;

--
-- Name: migrations; Type: ROW SECURITY; Schema: storage; Owner: -
--

ALTER TABLE storage.migrations ENABLE ROW LEVEL SECURITY;

--
-- Name: objects; Type: ROW SECURITY; Schema: storage; Owner: -
--

ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

--
-- Name: prefixes; Type: ROW SECURITY; Schema: storage; Owner: -
--

ALTER TABLE storage.prefixes ENABLE ROW LEVEL SECURITY;

--
-- Name: s3_multipart_uploads; Type: ROW SECURITY; Schema: storage; Owner: -
--

ALTER TABLE storage.s3_multipart_uploads ENABLE ROW LEVEL SECURITY;

--
-- Name: s3_multipart_uploads_parts; Type: ROW SECURITY; Schema: storage; Owner: -
--

ALTER TABLE storage.s3_multipart_uploads_parts ENABLE ROW LEVEL SECURITY;

--
-- Name: vector_indexes; Type: ROW SECURITY; Schema: storage; Owner: -
--

ALTER TABLE storage.vector_indexes ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_signal; Type: ROW SECURITY; Schema: system; Owner: -
--

ALTER TABLE system.ai_signal ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_task; Type: ROW SECURITY; Schema: system; Owner: -
--

ALTER TABLE system.ai_task ENABLE ROW LEVEL SECURITY;

--
-- Name: db_session; Type: ROW SECURITY; Schema: system; Owner: -
--

ALTER TABLE system.db_session ENABLE ROW LEVEL SECURITY;

--
-- Name: exec_command; Type: ROW SECURITY; Schema: system; Owner: -
--

ALTER TABLE system.exec_command ENABLE ROW LEVEL SECURITY;

--
-- Name: exec_run_request; Type: ROW SECURITY; Schema: system; Owner: -
--

ALTER TABLE system.exec_run_request ENABLE ROW LEVEL SECURITY;

--
-- Name: loop_config; Type: ROW SECURITY; Schema: system; Owner: -
--

ALTER TABLE system.loop_config ENABLE ROW LEVEL SECURITY;

--
-- Name: operation_log; Type: ROW SECURITY; Schema: system; Owner: -
--

ALTER TABLE system.operation_log ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_signal p_ai_signal_all; Type: POLICY; Schema: system; Owner: -
--

CREATE POLICY p_ai_signal_all ON system.ai_signal USING (true) WITH CHECK (true);


--
-- Name: ai_task p_ai_task_owner; Type: POLICY; Schema: system; Owner: -
--

CREATE POLICY p_ai_task_owner ON system.ai_task USING ((requested_by = auth.uid())) WITH CHECK ((requested_by = auth.uid()));


--
-- Name: db_session p_db_session_owner; Type: POLICY; Schema: system; Owner: -
--

CREATE POLICY p_db_session_owner ON system.db_session USING (((started_by = auth.uid()) OR (ended_by = auth.uid())));


--
-- Name: exec_command p_exec_command_owner; Type: POLICY; Schema: system; Owner: -
--

CREATE POLICY p_exec_command_owner ON system.exec_command USING ((created_by = auth.uid())) WITH CHECK ((created_by = auth.uid()));


--
-- Name: exec_run_request p_exec_run_request_owner; Type: POLICY; Schema: system; Owner: -
--

CREATE POLICY p_exec_run_request_owner ON system.exec_run_request USING (((requested_by = auth.uid()) OR (picked_by = auth.uid()))) WITH CHECK ((requested_by = auth.uid()));


--
-- Name: runtime_killswitch p_killswitch_read; Type: POLICY; Schema: system; Owner: -
--

CREATE POLICY p_killswitch_read ON system.runtime_killswitch FOR SELECT USING (true);


--
-- Name: loop_config p_loop_config_open; Type: POLICY; Schema: system; Owner: -
--

CREATE POLICY p_loop_config_open ON system.loop_config FOR SELECT USING (true);


--
-- Name: loop_config p_loop_config_owner; Type: POLICY; Schema: system; Owner: -
--

CREATE POLICY p_loop_config_owner ON system.loop_config USING (true) WITH CHECK (true);


--
-- Name: operation_log p_operation_log_owner; Type: POLICY; Schema: system; Owner: -
--

CREATE POLICY p_operation_log_owner ON system.operation_log USING ((operated_by = auth.uid()));


--
-- Name: runtime_killswitch; Type: ROW SECURITY; Schema: system; Owner: -
--

ALTER TABLE system.runtime_killswitch ENABLE ROW LEVEL SECURITY;

--
-- Name: supabase_realtime; Type: PUBLICATION; Schema: -; Owner: -
--

CREATE PUBLICATION supabase_realtime WITH (publish = 'insert, update, delete, truncate');


--
-- Name: issue_graphql_placeholder; Type: EVENT TRIGGER; Schema: -; Owner: -
--

CREATE EVENT TRIGGER issue_graphql_placeholder ON sql_drop
         WHEN TAG IN ('DROP EXTENSION')
   EXECUTE FUNCTION extensions.set_graphql_placeholder();


--
-- Name: issue_pg_cron_access; Type: EVENT TRIGGER; Schema: -; Owner: -
--

CREATE EVENT TRIGGER issue_pg_cron_access ON ddl_command_end
         WHEN TAG IN ('CREATE EXTENSION')
   EXECUTE FUNCTION extensions.grant_pg_cron_access();


--
-- Name: issue_pg_graphql_access; Type: EVENT TRIGGER; Schema: -; Owner: -
--

CREATE EVENT TRIGGER issue_pg_graphql_access ON ddl_command_end
         WHEN TAG IN ('CREATE FUNCTION')
   EXECUTE FUNCTION extensions.grant_pg_graphql_access();


--
-- Name: issue_pg_net_access; Type: EVENT TRIGGER; Schema: -; Owner: -
--

CREATE EVENT TRIGGER issue_pg_net_access ON ddl_command_end
         WHEN TAG IN ('CREATE EXTENSION')
   EXECUTE FUNCTION extensions.grant_pg_net_access();


--
-- Name: pgrst_ddl_watch; Type: EVENT TRIGGER; Schema: -; Owner: -
--

CREATE EVENT TRIGGER pgrst_ddl_watch ON ddl_command_end
   EXECUTE FUNCTION extensions.pgrst_ddl_watch();


--
-- Name: pgrst_drop_watch; Type: EVENT TRIGGER; Schema: -; Owner: -
--

CREATE EVENT TRIGGER pgrst_drop_watch ON sql_drop
   EXECUTE FUNCTION extensions.pgrst_drop_watch();


--
-- PostgreSQL database dump complete
--

\unrestrict kg7gFL8fqjD6iWc31bE432m8smepZCsHb6HRL8ZVmdyvFcDaMlZcNoXF6yM7wxI

